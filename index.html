<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror â€” v5.0.3 (Investment breakdown with subcategories)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;

      /* Extended palette for charts */
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.3s; justify-content: space-between; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px); }

    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    #authGate {
      /* Login Page Fix: Ensure it is on top of everything and covers the whole screen */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999; /* Highest Z-index to guarantee clickability */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      color: white;
      text-align: center;
      padding: 0 24px;
    }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); }

    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; }
    .input-group-med { width: 25%; }
    .input-group-large { width: 45%; }

    .kpi-card { padding: 20px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    .cc-alert-high { background: #fee2e2 !important; border-color: var(--danger) !important; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted); }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600; color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1200px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
    .modal-pad { padding: 24px; }
    .modal-small { width: 400px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Calculator */
    #calculator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      height: 480px;
      min-height: 480px;
      max-height: 480px;
      z-index: 3000;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #f8fafc;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close-btn { background: transparent; border: none; color: #ef4444; font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    #calc-display { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    #calc-preview { background: #0b1323; color: #9fb3c8; text-align: right; font-size: 14px; padding: 6px 15px; font-family: monospace; height: 28px; border-top: 1px solid rgba(255,255,255,0.06); }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #calc-buttons button:hover { background: #f1f5f9; }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .calc-operator:hover { background: #c2e0e5 !important; }
    .calc-clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .calc-clear:hover { background: #fde8e8 !important; }
    .calc-zero { grid-column: span 2; }
    .calc-equals { grid-row: span 2; background: var(--primary) !important; color: white !important; }
    .calc-equals:hover { background: var(--primary-dark) !important; }
    #calc-toggle { margin-left: 10px; padding: 8px 12px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; }

    /* Investment KPI breakdown grid and quick subcategories */
    .kpi-breakdown-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: white; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center; }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: 34px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 10px; width: 280px; box-shadow: 0 12px 24px rgba(0,0,0,0.15); z-index: 10; }
    .dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; border-radius: 8px; font-size: 12px; }
    .dropdown-item:hover { background: #f8fafc; }

    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-1 { grid-column: span 1; }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }

    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; }
      aside .brand { margin-bottom: 0; }
      aside nav, .sidebar-footer { display: none; }
      #mobileMenuBtn { display: block; }
      aside.mobile-open nav {
        display: block;
        position: absolute;
        top: 60px; left: 0; right: 0;
        background: var(--sidebar-bg);
        padding: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 501;
      }
      aside.mobile-open .sidebar-footer {
        display: block;
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 501;
      }

      .dashboard-grid { grid-template-columns: 1fr; gap: 16px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }

      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer {
        width: 100% !important;
      }
      .action-body { gap: 12px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr; }
      #calculator { top: 70px; left: 50%; transform: translateX(-50%); width: 90%; height: 480px; bottom: auto; right: auto; }
    }
  </style>
  </head>
<body>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
    };

    let db = null;
    let auth = null;
    let USE_FIRESTORE = false;
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';
    let currentProfile = null;

    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
      console.log("Firebase initialized.");
    } catch (e) {
      console.warn("Firebase init failed, falling back to LocalStorage:", e);
    }

    // --- DATA & CONSTANTS ---
    let data = [];
    let editId = null;
    const DEFAULT_CC_LIMIT = 200000;
    let settings = { ccLimit: DEFAULT_CC_LIMIT };
    
    const CANONICAL_METHODS = {
      salary_acct: 'Salary Account',
      savings_acct: 'Savings Account',
      cash: 'Cash',
      credit_card: 'Credit Card',
      credit_card_payment: 'Credit Card Payment (Transfer)'
    };
    let methodNames = { ...CANONICAL_METHODS };
    let incomeSources = ['Salary', 'Freelance', 'Interest'];
    
    // Investment structure for category/sub-category breakdown
    const INVESTMENT_STRUCTURE = {
        'Mutual Funds': { 'Equity': 'Equity', 'Debt': 'Debt', 'Hybrid': 'Hybrid' },
        'Direct Equity': { 'Large Cap': 'Large Cap', 'Mid Cap': 'Mid Cap', 'Small Cap': 'Small Cap' },
        'Fixed Deposits': { 'Bank FD': 'Bank FD', 'Corporate FD': 'Corporate FD' },
        'Real Estate': { 'REIT': 'REIT', 'Physical': 'Physical' },
        'Commodities': { 'Gold': 'Gold', 'Silver': 'Silver' },
    };
    const BASE_CATS = ['Food', 'Utilities', 'Rent', 'Travel', 'Shopping', 'Investments', 'Insurance', 'EMI', 'Medical', 'Credit Card Payment', 'Other'];

    const formEls = {
      type: document.getElementById('type'),
      amount: document.getElementById('amount'),
      date: document.getElementById('date'),
      desc: document.getElementById('desc'),
      category: document.getElementById('category'),
      method: document.getElementById('method'),
      incomeSource: document.getElementById('incomeSource'),
      invRow: document.getElementById('investmentRow'),
      insRow: document.getElementById('insuranceRow'),
      invGroup: document.getElementById('invGroup'),
      invSub: document.getElementById('invSub'),
      insType: document.getElementById('insType'),
      insFor: document.getElementById('insFor'),
      openRow: document.getElementById('openingBalanceRow'),
      openingType: document.getElementById('openingType'),
      openingGroupContainer: document.getElementById('openingGroupContainer'),
      openingGroupLabel: document.getElementById('openingGroupLabel'),
      openingGroup: document.getElementById('openingGroup'),
      openingSubContainer: document.getElementById('openingSubContainer'),
      openingSubLabel: document.getElementById('openingSubLabel'),
      openingSub: document.getElementById('openingSub'),
      addBtn: document.getElementById('addBtn'),
      saveBtn: document.getElementById('saveBtn'),
      cancelBtn: document.getElementById('cancelBtn')
    };

    // --- FIREBASE / AUTH ---

    async function signInWithGoogle() {
      if (!auth) return alert('Auth not initialized. Please refresh.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        onUserSignedIn(user);
      } catch (err) {
        console.error("Login failed:", err);
        alert('Sign-in popup blocked. Allow popups and try again.');
      }
    }

    function onUserSignedIn(user) {
      currentProfile = user.displayName || user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      document.getElementById('profileNameDisplay').textContent = currentProfile;
      document.getElementById('authGate').style.display = 'none';
      document.querySelector('main').style.filter = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      loadProfileData();
    }

    function signOutUser() {
      if (!auth) return;
      auth.signOut().then(() => {
        currentProfile = null;
        document.getElementById('profileNameDisplay').textContent = '--';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('authGate').style.display = 'flex';
        document.querySelector('main').style.filter = 'blur(5px)';
      });
    }

    // --- STORAGE ---
    function toKey(s) {
      return s.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 50);
    }

    function saveToLocalStorage() {
      localStorage.setItem('mm_data_' + toKey(currentProfile), JSON.stringify({
        data: data,
        methodNames: methodNames,
        incomeSources: incomeSources,
        settings: settings
      }));
    }

    async function saveToFirestore() {
      if (!db || !currentProfile) return;
      try {
        await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).set({
          data: data,
          methodNames: methodNames,
          incomeSources: incomeSources,
          settings: settings,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log("Data saved to Firestore.");
      } catch (e) {
        console.error("Firestore save error:", e);
      }
    }

    function saveAll() {
      saveToLocalStorage();
      if (USE_FIRESTORE) saveToFirestore();
    }

    function loadFromLocalStorage() {
      const localData = localStorage.getItem('mm_data_' + toKey(currentProfile));
      if (localData) {
        const parsed = JSON.parse(localData);
        data = parsed.data || data;
        methodNames = parsed.methodNames || methodNames;
        incomeSources = parsed.incomeSources || incomeSources;
        settings = parsed.settings || settings;
      }
      // Ensure all objects have all required fields (for older data structures)
      data = data.map(d => ({
        id: d.id, type: d.type, amount: Number(d.amount), date: d.date, desc: d.desc,
        category: d.category || '', method: d.method || '', incomeSource: d.incomeSource || '',
        investmentGroup: d.investmentGroup || '', investmentSub: d.investmentSub || '',
        insuranceType: d.insuranceType || '', insuranceFor: d.insuranceFor || '',
      }));
    }

    async function loadProfileData() {
      loadFromLocalStorage();
      if (USE_FIRESTORE && db && currentProfile) {
        try {
          const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).get();
          if (doc.exists) {
            const serverData = doc.data();
            data = serverData.data || data;
            methodNames = serverData.methodNames || methodNames;
            incomeSources = serverData.incomeSources || incomeSources;
            settings = serverData.settings || settings;
          }
        } catch (e) {
          console.error("Firestore read error, using local data:", e);
        }
      }
      renderAll();
    }

    // --- UTILS & FORMATTING ---

    function fmt(n) {
      return `â‚¹${Math.abs(n).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    }

    // --- INVESTMENT DROPDOWN HELPERS (FIX FOR RECENT TRANSACTION ERROR) ---
    
    function updateInvestmentSubDropdown(groupEl, subEl, selectedSub = '') {
        const group = groupEl.value;
        let options = '<option value="">Select Sub-type</option>';
        if (group && INVESTMENT_STRUCTURE[group]) {
            options += Object.keys(INVESTMENT_STRUCTURE[group]).map(sub =>
                `<option value="${sub}"${sub === selectedSub ? ' selected' : ''}>${sub}</option>`
            ).join('');
        }
        subEl.innerHTML = options;
    }

    function updateInvGroupDropdown(groupEl, subEl, selectedGroup = '', selectedSub = '') {
        const groups = Object.keys(INVESTMENT_STRUCTURE);
        let options = '<option value="">Select Category</option>';
        options += groups.map(g =>
            `<option value="${g}"${g === selectedGroup ? ' selected' : ''}>${g}</option>`
        ).join('');
        groupEl.innerHTML = options;

        // Also update the sub-dropdown based on the selected group
        updateInvestmentSubDropdown(groupEl, subEl, selectedSub);
    }
    
    // --- RENDER & SETUP ---

    function renderAll() {
      data.sort((a,b) => new Date(b.date) - new Date(a.date));
      setupDropdowns();
      renderKPIs();
      renderCharts();
      renderRecentEntries(); // This is now guaranteed to run
      renderSettings();
    }

    function setupDropdowns() {
      // Methods
      formEls.method.innerHTML = Object.keys(methodNames)
        .filter(key => key !== 'credit_card')
        .map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');

      // Income sources
      formEls.incomeSource.innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');

      // Categories
      formEls.category.innerHTML = BASE_CATS.map(c => `<option value="${c}">${c}</option>`).join('');
      
      // Investment Groups - FIX APPLIED HERE
      updateInvGroupDropdown(formEls.invGroup, formEls.invSub); // For the main Add form
      updateInvGroupDropdown(formEls.openingGroup, formEls.openingSub); // For the Opening Balance form

      // Listeners
      formEls.type.onchange = updateTransactionFormFields;
      formEls.category.onchange = updateTransactionFormFields;
      formEls.openingType.onchange = updateTransactionFormFields;
      
      // Listeners for Investment Group change - FIX APPLIED HERE
      formEls.invGroup.onchange = () => updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
      formEls.openingGroup.onchange = () => updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub);
    }

    function updateTransactionFormFields(editEntry = null) {
      // Reset visibility
      formEls.invRow.classList.add('hidden');
      formEls.insRow.classList.add('hidden');
      formEls.incomeSource.closest('.input-group-med').classList.add('hidden');
      formEls.openRow.classList.add('hidden');
      formEls.openingGroupContainer.classList.add('hidden');
      formEls.openingSubContainer.classList.add('hidden');

      const type = editEntry ? editEntry.type : formEls.type.value;
      const category = editEntry ? editEntry.category : formEls.category.value;
      const openingType = editEntry ? editEntry.openingType : formEls.openingType.value;

      if (type === 'income') {
        formEls.incomeSource.closest('.input-group-med').classList.remove('hidden');
        if (editEntry) formEls.incomeSource.value = editEntry.incomeSource || '';
      } else if (type === 'opening_balance') {
        formEls.openRow.classList.remove('hidden');
        if (editEntry) formEls.openingType.value = editEntry.openingType || 'Cash';
        
        if ((editEntry && editEntry.openingType === 'Investment') || formEls.openingType.value === 'Investment') {
            formEls.openingGroupContainer.classList.remove('hidden');
            formEls.openingSubContainer.classList.remove('hidden');
            formEls.openingGroupLabel.textContent = 'Asset Category';
            formEls.openingSubLabel.textContent = 'Asset Sub-type';

            // Populate the dropdowns for editing/initial load
            if (editEntry) {
                updateInvGroupDropdown(formEls.openingGroup, formEls.openingSub, editEntry.investmentGroup, editEntry.investmentSub);
            } else {
                updateInvGroupDropdown(formEls.openingGroup, formEls.openingSub);
            }
        }
      } else if (type === 'expense') {
        if (category === 'Investments') {
          formEls.invRow.classList.remove('hidden');
          if (editEntry) {
            formEls.invGroup.value = editEntry.investmentGroup || '';
            updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, editEntry.investmentSub);
          } else {
            updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
          }
        } else if(category === 'Insurance') {
          formEls.insRow.classList.remove('hidden');
        }
      }
    }

    // --- CRUD ---

    function uid() {
      return 'id' + Date.now() + Math.random().toString(16).slice(2);
    }

    function requireSignedIn() {
      if (!currentProfile) {
        alert('Please sign in to proceed.');
        return false;
      }
      return true;
    }

    function submitForm(e, isImportOrEdit=false){
      if(!requireSignedIn()) return;
      const type = formEls.type.value;
      const amount = Number(formEls.amount.value);
      const date = formEls.date.value;
      const desc = formEls.desc.value;
      const method = formEls.method.value;

      if(amount <= 0 || isNaN(amount)) return alert('Please enter a valid amount.');
      if(!date) return alert('Please select a date.');
      if(!desc) return alert('Please enter a description.');

      let entry = {
        id: e ? e.id : uid(),
        type, amount, date, desc,
        category: '', method: method,
        incomeSource: '',
        investmentGroup: '', investmentSub: '',
        insuranceType: '', insuranceFor: ''
      };

      if(type === 'income') {
        entry.incomeSource = formEls.incomeSource.value || (e ? e.incomeSource : '');
        if(!entry.incomeSource && !isImportOrEdit) return alert('Please select an income source.');
        entry.category = 'N/A';
        entry.investmentGroup = entry.investmentSub = entry.insuranceType = entry.insuranceFor = '';
      } else if (type === 'opening_balance') {
        entry.category = 'N/A';
        entry.openingType = formEls.openingType.value || (e ? e.openingType : 'Cash');
        entry.method = 'N/A'; // Opening balances are not tracked by method in the same way

        if (entry.openingType === 'Investment') {
            entry.investmentGroup = formEls.openingGroup.value || (e ? e.investmentGroup : '');
            entry.investmentSub = formEls.openingSub.value || (e ? e.investmentSub : '');
            if(!entry.investmentGroup && !isImportOrEdit) return alert('Please select an Investment category for the asset.');
            if(!entry.investmentSub && !isImportOrEdit) return alert('Please select an Investment sub-type for the asset.');
            entry.method = 'investment_asset';
        } else {
            // Cash / Liquid assets
            entry.investmentGroup = 'Cash';
            entry.investmentSub = formEls.openingGroup.value || (e ? e.investmentSub : ''); // Reusing openingGroup/Sub fields for liquid breakdown
            entry.method = formEls.method.value; // Link method for liquid cash
        }
        entry.incomeSource = entry.insuranceType = entry.insuranceFor = '';

      } else if (type === 'expense') {
        entry.category = formEls.category.value || (e ? e.category : '');
        if(!entry.category && !isImportOrEdit) return alert('Please select a category.');

        if (entry.category === 'Investments') {
          entry.investmentGroup = formEls.invGroup.value || (e ? e.investmentGroup : '');
          entry.investmentSub = formEls.invSub.value || (e ? e.investmentSub : '');
          if(!entry.investmentGroup && !isImportOrEdit) return alert('Please select an Investment category.');
          if(!entry.investmentSub && !isImportOrEdit) return alert('Please select an Investment sub-type.');
          entry.insuranceType = entry.insuranceFor = '';
        } else if (entry.category === 'Insurance') {
          entry.insuranceType = formEls.insType.value || (e ? e.insuranceType : 'General');
          entry.insuranceFor = formEls.insFor.value || (e ? e.insuranceFor : 'Self');
          entry.investmentGroup = entry.investmentSub = '';
        } else {
          entry.insuranceType = entry.insuranceFor = '';
        }

        if (entry.category === 'Credit Card Payment') {
          entry.method = 'credit_card_payment';
        }
      }

      if(editId) {
        data = data.map(t => t.id === editId ? entry : t);
        editId = null;
        formEls.addBtn.classList.remove('hidden');
        formEls.saveBtn.classList.add('hidden');
        formEls.cancelBtn.classList.add('hidden');
      } else {
        data.push(entry);
      }

      if(!isImportOrEdit) {
        saveAll();
        renderAll();
        clearForm();
      }
    }

    formEls.addBtn.addEventListener('click', () => submitForm());
    formEls.saveBtn.addEventListener('click', () => {
      const entryToEdit = data.find(t => t.id === editId);
      if (entryToEdit) submitForm(entryToEdit);
    });
    formEls.cancelBtn.addEventListener('click', () => {
      editId = null;
      formEls.addBtn.classList.remove('hidden');
      formEls.saveBtn.classList.add('hidden');
      formEls.cancelBtn.classList.add('hidden');
      clearForm();
    });

    function loadEdit(id) {
      if(!requireSignedIn()) return;
      const e = data.find(t => t.id === id);
      if (!e) return;

      editId = id;
      formEls.type.value = e.type;
      formEls.amount.value = e.amount;
      formEls.date.value = e.date;
      formEls.desc.value = e.desc;
      formEls.category.value = e.category || '';
      formEls.method.value = e.method || '';

      updateTransactionFormFields(e); // This fills in conditional fields
      
      // Update the specific conditional fields that might have been reset
      if (e.type === 'income') {
        formEls.incomeSource.value = e.incomeSource || '';
      } else if (e.type === 'expense') {
        if (e.category === 'Investments') {
          updateInvGroupDropdown(formEls.invGroup, formEls.invSub, e.investmentGroup, e.investmentSub);
        } else if (e.category === 'Insurance') {
          formEls.insType.value = e.insuranceType || 'General';
          formEls.insFor.value = e.insuranceFor || 'Self';
        }
      } else if (e.type === 'opening_balance') {
        formEls.openingType.value = e.openingType || 'Cash';
        if (e.openingType === 'Investment') {
            updateInvGroupDropdown(formEls.openingGroup, formEls.openingSub, e.investmentGroup, e.investmentSub);
        } else {
            // Liquid Asset (Cash) - using investmentSub for the account name
            formEls.openingGroup.value = e.investmentSub || '';
        }
        formEls.method.value = e.method || '';
      }

      formEls.addBtn.classList.add('hidden');
      formEls.saveBtn.classList.remove('hidden');
      formEls.cancelBtn.classList.remove('hidden');

      document.getElementById('addEntryCard').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteEntry(id) {
      if(!requireSignedIn()) return;
      if (confirm('Are you sure you want to delete this entry?')) {
        data = data.filter(t => t.id !== id);
        saveAll();
        renderAll();
      }
    }

    function clearForm() {
      formEls.type.value = 'expense';
      formEls.amount.value = '';
      formEls.desc.value = '';
      formEls.category.value = BASE_CATS[0];
      formEls.method.value = 'salary_acct';
      formEls.incomeSource.value = '';
      updateTransactionFormFields();
      const today = new Date().toISOString().slice(0,10);
      formEls.date.value = today;
    }

    // --- KPI & RENDER FUNCTIONS ---

    function getNextPaymentDate() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const paymentDay = 10;
      let paymentDate = new Date(currentYear, currentMonth, paymentDay);
      if (today.getDate() > paymentDay) paymentDate.setMonth(currentMonth + 1);
      return paymentDate.toLocaleDateString('en-IN', {month:'long'});
    }

    function renderKPIs(){
      const curMonth = new Date().getMonth();
      const curYear = new Date().getFullYear();
      const prevMonth = curMonth === 0 ? 11 : curMonth - 1;
      const prevYear = curMonth === 0 ? curYear - 1 : curYear;

      const operationalData = data.filter(d => d.type !== 'opening_balance');

      const filterMonth = (d, m, y) => {
        const dt = new Date(d);
        return dt.getMonth()===m && dt.getFullYear()===y;
      };
      const sum = (arr) => arr.reduce((acc,curr) => acc + Number(curr.amount), 0);

      const curData = operationalData.filter(d => filterMonth(d.date, curMonth, curYear));
      const prevData = operationalData.filter(d => filterMonth(d.date, prevMonth, prevYear));

      const inc = sum(curData.filter(d=>d.type==='income'));
      const exp = sum(curData.filter(d=>d.type==='expense'));
      const prevInc = sum(prevData.filter(d=>d.type==='income'));
      const prevExp = sum(prevData.filter(d=>d.type==='expense'));

      const allInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
      const totalInvested = sum(allInvestments);

      // Credit Card Logic
      const ccData = data.filter(d => d.type === 'expense' && d.method === 'credit_card');
      const ccPaymentData = data.filter(d => d.category === 'Credit Card Payment');

      const totalSpentCC = sum(ccData);
      const totalPaidCC = sum(ccPaymentData);
      const creditCardDue = totalSpentCC - totalPaidCC;
      const ccLimit = settings.ccLimit || DEFAULT_CC_LIMIT;
      const ccUsage = ccLimit > 0 ? (creditCardDue / ccLimit) : 0;

      // Net Liquidity
      const liquidAssets = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup === 'Cash') || (d.type === 'income') || (d.type === 'expense' && d.category !== 'Investments'));
      const netLiquidity = sum(liquidAssets.filter(d => d.type !== 'expense')) - sum(liquidAssets.filter(d => d.type === 'expense'));

      // Update UI
      document.getElementById('kpiIncome').innerText = fmt(inc);
      document.getElementById('momIncome').innerHTML = getMoMTrend(inc, prevInc, 'Income');

      document.getElementById('kpiExpense').innerText = fmt(exp);
      document.getElementById('momExpense').innerHTML = getMoMTrend(exp, prevExp, 'Expense');

      document.getElementById('kpiNet').innerText = fmt(netLiquidity);
      
      document.getElementById('kpiInvValue').innerText = fmt(totalInvested);

      document.getElementById('kpiCCDue').innerText = fmt(creditCardDue);
      document.getElementById('ccLimitDisplay').innerText = fmt(ccLimit);
      document.getElementById('ccPaymentDate').innerText = `Next Payment: 10th of ${getNextPaymentDate()}`;

      if(creditCardDue > (ccLimit * 0.8)) {
        document.getElementById('ccCard').classList.add('cc-alert-high');
        document.getElementById('ccTitle').style.color = 'var(--danger)';
        document.getElementById('ccAlert').classList.remove('hidden');
      } else {
        document.getElementById('ccCard').classList.remove('cc-alert-high');
        document.getElementById('ccTitle').style.color = 'var(--warning)';
        document.getElementById('ccAlert').classList.add('hidden');
      }
      

      // Net Liquidity Breakdown (accounts)
      const breakdownContainer = document.getElementById('netLiquidityBreakdown');
      let breakdownHtml = '';
      const liquidMethods = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup === 'Cash') || (d.type === 'income') || (d.type === 'expense' && d.category !== 'Investments'));

      const methodBalances = liquidMethods.reduce((acc, curr) => {
        const key = curr.method || 'cash';
        const isExpense = curr.type === 'expense' && curr.category !== 'Credit Card Payment';
        const amount = isExpense ? -Number(curr.amount) : Number(curr.amount);
        acc[key] = (acc[key] || 0) + amount;
        return acc;
      }, {});

      for (const key in methodBalances) {
        if (key !== 'investment_asset') {
            breakdownHtml += `
                <div>
                    <span>${methodNames[key] || key}</span>
                    <span>${fmt(methodBalances[key])}</span>
                </div>
            `;
        }
      }
      breakdownContainer.innerHTML = breakdownHtml;

      renderInvestmentAnalytics('dashboard');
    }

    function getMoMTrend(current, previous, label) {
      if (previous === 0) return `<span class="trend-up">New ${label} tracking.</span>`;
      
      const diff = current - previous;
      const perc = (diff / previous) * 100;
      const isUp = label === 'Income' ? diff >= 0 : diff <= 0;
      const trendClass = isUp ? 'trend-up' : 'trend-down';
      const arrow = isUp ? 'â–²' : 'â–¼';

      return `<span class="${trendClass}">${arrow} ${Math.abs(perc).toFixed(1)}%</span> vs. last month`;
    }


    function getBadge(e) {
      let badgeClass = '';
      let badgeText = '';

      if (e.type === 'income') {
        badgeClass = 'badge-income';
        badgeText = 'Income';
      } else if (e.type === 'expense') {
        if (e.category === 'Investments') {
          badgeClass = 'badge-inv';
          badgeText = 'Investment';
        } else if (e.category === 'Insurance') {
          badgeClass = 'badge-ins';
          badgeText = 'Insurance';
        } else if (e.category === 'Credit Card Payment') {
          badgeClass = 'badge-cc';
          badgeText = 'CC Payment';
        } else {
          badgeClass = 'badge-expense';
          badgeText = 'Expense';
        }
      } else if (e.type === 'opening_balance') {
        badgeClass = 'badge-opening';
        badgeText = 'Opening Balance';
      }
      return `<span class="badge ${badgeClass}">${badgeText}</span>`;
    }

    function renderRecentEntries() {
      const limit = document.getElementById('entryLimit').value === 'all' 
                    ? data.length 
                    : Number(document.getElementById('entryLimit').value || 10);
      
      const recentData = data.slice(0, limit);
      const container = document.getElementById('recentEntriesBody');
      let tableRows = '';

      if (recentData.length === 0) {
        tableRows = '<tr><td colspan="6" style="text-align:center; color:var(--text-muted);">No entries found. Add your first transaction!</td></tr>';
      } else {
        tableRows = recentData.map(e => {
          const isPositive = e.type === 'income' || e.type === 'opening_balance';
          const amountDisplay = isPositive
            ? `<span style="color:var(--success)">+${fmt(e.amount)}</span>`
            : `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;

          let methodDisplay = '';
          if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
            methodDisplay = e.investmentSub || e.investmentGroup;
          } else if (e.type === 'expense' && e.category === 'Investments') {
            methodDisplay = e.investmentSub || e.investmentGroup;
          } else if (e.method === 'credit_card_payment') {
            methodDisplay = 'N/A (Transfer)';
          } else {
            methodDisplay = methodNames[e.method] || e.method || '--';
          }

          let categoryDisplay = e.category === 'Investments'
            ? e.investmentSub
            : e.category === 'Insurance'
              ? `${e.insuranceType} (${e.insuranceFor})`
              : e.type === 'expense' ? e.category : '--';

          return `
            <tr>
              <td>${getBadge(e)}</td>
              <td>${e.date}</td>
              <td style="font-weight:600; text-align:right">${amountDisplay}</td>
              <td>${e.desc}</td>
              <td>${categoryDisplay}</td>
              <td>${methodDisplay}</td>
              <td class="flex-row">
                <button onclick="loadEdit('${e.id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:4px" title="Edit">âœŽ</button>
                <button onclick="deleteEntry('${e.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:4px" title="Delete">ðŸ—‘</button>
              </td>
            </tr>
          `;
        }).join('');
      }
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th style="width:100px;">Date</th>
              <th style="width:120px; text-align:right">Amount</th>
              <th>Description</th>
              <th>Category/Sub-Type</th>
              <th>Account/Method</th>
              <th style="width:80px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      `;
    }

    // --- CHARTING FUNCTIONS (Stubs) ---
    let invBreakdownBarChart, invBreakdownPieChart;
    let chartNetWorth, chartAdvanced, chartInvTypesModal, chartInvGrowthModal;

    function renderInvestmentAnalytics(target) {
        const invData = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
        const invBreakdown = invData.reduce((acc, curr) => {
            const group = curr.investmentGroup;
            const sub = curr.investmentSub;
            acc[group] = acc[group] || { total: 0, subs: {} };
            acc[group].total += Number(curr.amount);
            acc[group].subs[sub] = (acc[group].subs[sub] || 0) + Number(curr.amount);
            return acc;
        }, {});

        // Sort data for charts
        const sortedGroups = Object.keys(invBreakdown).sort((a, b) => invBreakdown[b].total - invBreakdown[a].total);
        const labels = sortedGroups;
        const values = sortedGroups.map(g => invBreakdown[g].total);
        const colors = ['var(--c1)', 'var(--c2)', 'var(--c3)', 'var(--c4)', 'var(--c5)', 'var(--c6)', 'var(--c7)', 'var(--c8)', 'var(--c9)', 'var(--c10)', 'var(--c11)', 'var(--c12)'].slice(0, labels.length);

        // Render Quick Breakdown
        const quickBreakdownEl = document.getElementById('invQuickBreakdown');
        const firstGroup = sortedGroups[0];
        let quickHtml = '';

        if (firstGroup && invBreakdown[firstGroup]) {
            const subs = invBreakdown[firstGroup].subs;
            const sortedSubs = Object.keys(subs).sort((a, b) => subs[b] - subs[a]);

            quickHtml += `
                <div class="quick-sub-header">
                    <div class="quick-sub-title">${firstGroup} Subcategories</div>
                    <span class="total-badge">${fmt(invBreakdown[firstGroup].total)}</span>
                </div>
                <div class="dropdown-menu" style="position:static; border:none; box-shadow:none; padding:10px 0; margin-top:5px; width:100%">
            `;

            quickHtml += sortedSubs.map(sub => `
                <div class="dropdown-item">
                    <span>${sub}</span>
                    <span style="font-weight:600; color:var(--text-main);">${fmt(subs[sub])}</span>
                </div>
            `).join('');

            quickHtml += '</div>';
        } else {
            quickHtml = '<p style="text-align:center; color:var(--text-muted); padding:20px;">No investment data available.</p>';
        }

        quickBreakdownEl.innerHTML = quickHtml;

        // Render Bar Chart
        if (invBreakdownBarChart) invBreakdownBarChart.destroy();
        const barCtx = document.getElementById('invBreakdownBar');
        if (barCtx) {
            invBreakdownBarChart = new Chart(barCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Historical cost',
                        data: values,
                        backgroundColor: colors.map(c => c+'cc'),
                        borderColor: colors,
                        borderWidth: 1.5,
                        borderRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (c)=>`${c.label}: ${fmt(c.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (v)=>fmt(v).replace('â‚¹','â‚¹ ') },
                            grid:{color:'#eef2ff'}
                        },
                        x:{grid:{display:false}}
                    }
                }
            });
        }

        // Render Pie chart
        if (invBreakdownPieChart) invBreakdownPieChart.destroy();
        const pieCtx = document.getElementById('invBreakdownPie');
        if (pieCtx) {
            invBreakdownPieChart = new Chart(pieCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        hoverOffset: 6,
                        borderColor:'#ffffff',
                        borderWidth:2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (c)=> {
                                    const total = values.reduce((a,b)=>a+b,0);
                                    const share = total ? ((c.parsed/total)*100).toFixed(1)+'%' : '0%';
                                    return `${c.label}: ${fmt(c.parsed)} (${share})`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }


    function renderCharts() {
      // Net Worth Chart (Cumulative Net Flow)
      if (chartNetWorth) chartNetWorth.destroy();
      const netWorthCtx = document.getElementById('chartNetWorth');
      if (netWorthCtx) {
        const sortedData = data.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
        const dates = [];
        const cumulativeNetWorth = [];
        let runningTotal = 0;

        sortedData.forEach(d => {
            const amount = Number(d.amount);
            let flow = 0;
            if (d.type === 'income' || d.type === 'opening_balance') {
                flow = amount;
            } else if (d.type === 'expense' && d.category !== 'Investments') {
                flow = -amount;
            } else if (d.type === 'expense' && d.category === 'Credit Card Payment') {
                flow = -amount;
            }
            
            runningTotal += flow;
            dates.push(d.date);
            cumulativeNetWorth.push(runningTotal);
        });
        
        // Remove duplicates and keep the last cumulative value
        const uniqueDates = [];
        const uniqueNetWorth = [];
        if (dates.length > 0) {
            let lastDate = dates[0];
            let lastValue = cumulativeNetWorth[0];
            for (let i = 1; i < dates.length; i++) {
                if (dates[i] !== lastDate) {
                    uniqueDates.push(lastDate);
                    uniqueNetWorth.push(lastValue);
                    lastDate = dates[i];
                }
                lastValue = cumulativeNetWorth[i];
            }
            uniqueDates.push(lastDate);
            uniqueNetWorth.push(lastValue);
        }

        chartNetWorth = new Chart(netWorthCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: uniqueDates,
            datasets: [{
              label: 'Cumulative Net Worth',
              data: uniqueNetWorth,
              borderColor: 'var(--primary)',
              tension: 0.3,
              fill: true,
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              pointRadius: 0,
              borderWidth: 2
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (c)=>`${c.dataset.label}: ${fmt(c.parsed.y)}`
                    }
                }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: false,
                ticks: { callback: (v)=>fmt(v).replace('â‚¹','â‚¹ ') },
                grid:{color:'#eef2ff'}
              }
            }
          }
        });
      }
      
      // Render Advanced Charts only if the modal is open, otherwise call the main KPI render
      if (document.getElementById('analyticsModal').classList.contains('open')) {
          renderAdvancedCharts();
          renderInvestmentAnalytics('modal');
      }
      renderWalletUnified();
    }

    // --- Advanced Analytics Charts ---

    function renderAdvancedCharts() {
      // 1. Monthly Flow Chart (Bar/Line Mix)
      if (chartAdvanced) chartAdvanced.destroy();
      const advancedCtx = document.getElementById('chartAdvanced');
      if (!advancedCtx) return;

      const chartType = document.getElementById('chartType').value;
      const monthMap = {};
      const twelveMonthsAgo = new Date();
      twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 11);
      twelveMonthsAgo.setDate(1); 

      // Initialize map for the last 12 months
      for (let i = 0; i < 12; i++) {
        const d = new Date(twelveMonthsAgo);
        d.setMonth(d.getMonth() + i);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        monthMap[key] = { income: 0, expense: 0, investment: 0 };
      }

      data.filter(d => d.type !== 'opening_balance' && new Date(d.date) >= twelveMonthsAgo).forEach(d => {
        const date = new Date(d.date);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (monthMap[key]) {
          const amount = Number(d.amount);
          if (d.type === 'income') {
            monthMap[key].income += amount;
          } else if (d.type === 'expense' && d.category === 'Investments') {
            monthMap[key].investment += amount;
          } else if (d.type === 'expense' && d.category !== 'Credit Card Payment') {
            monthMap[key].expense += amount;
          }
        }
      });

      const labels = Object.keys(monthMap).map(key => new Date(key).toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }));
      const income = Object.values(monthMap).map(m => m.income);
      const expense = Object.values(monthMap).map(m => m.expense);
      const investment = Object.values(monthMap).map(m => m.investment);
      const netIncomeSeries = income.map((inc, i) => inc - (expense[i] + investment[i]));

      chartAdvanced = new Chart(advancedCtx.getContext('2d'), {
        type: chartType === 'line' ? 'bar' : 'bar',
        data: {
          labels: labels,
          datasets: [
            { type: 'bar', label: 'Income', data: income, backgroundColor: 'rgba(16, 185, 129, 0.8)', stack: 'flow' },
            { type: 'bar', label: 'Expense', data: expense.map(e => -e), backgroundColor: 'rgba(239, 68, 68, 0.8)', stack: 'flow' },
            { type: 'bar', label: 'Investment', data: investment.map(i => -i), backgroundColor: 'rgba(14, 165, 233, 0.8)', stack: 'flow' },
            { type: 'line', label: 'Net Income', data: netIncomeSeries, borderColor: '#000000', tension: 0.3, pointRadius: 3, fill: false }
          ]
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              ticks: {
                callback: function(value) {
                  return fmt(Math.abs(value)).replace('â‚¹', 'â‚¹ ');
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  if (context.parsed.y !== null) label += fmt(Math.abs(context.parsed.y));
                  return label;
                }
              }
            },
            legend: { position: 'top' }
          }
        }
      });
      renderWalletUnified();
    }


    // --- Wallet unified (wallet + expenses) ---

    function setupWalletFilters() {
      const catSelect = document.getElementById('walletCategoryFilter');
      catSelect.innerHTML = '<option value="">All categories</option>' + BASE_CATS
        .filter(c => c !== 'Investments' && c !== 'Insurance' && c !== 'Credit Card Payment')
        .map(c => `<option value="${c}">${c}</option>`).join('');
      
      document.getElementById('walletTypeFilter').onchange = renderWalletUnified;
      catSelect.onchange = renderWalletUnified;
      document.getElementById('walletMonthFilter').onchange = renderWalletUnified;
    }
    
    function renderWalletUnified() {
      if (chartInvTypesModal) chartInvTypesModal.destroy();
      const ctx = document.getElementById('chartInvTypesModal');
      if (!ctx) return;

      const filterType = document.getElementById('walletTypeFilter')?.value || 'expense';
      const filterCategory = document.getElementById('walletCategoryFilter')?.value || '';
      const filterMonth = document.getElementById('walletMonthFilter')?.value || 'current';

      let filteredData = data.filter(d => d.type === filterType);

      if (filterCategory) {
        filteredData = filteredData.filter(d => d.category === filterCategory);
      }
      
      const now = new Date();
      let startMonth = now.getMonth();
      let startYear = now.getFullYear();

      if (filterMonth === 'last') {
          startMonth = startMonth === 0 ? 11 : startMonth - 1;
          startYear = startMonth === 11 ? startYear - 1 : startYear;
      } else if (filterMonth === 'all') {
          // No date filter for 'all'
      }

      if (filterMonth === 'current' || filterMonth === 'last') {
          filteredData = filteredData.filter(d => {
              const date = new Date(d.date);
              return date.getMonth() === startMonth && date.getFullYear() === startYear;
          });
      }


      // Aggregate data by category/source
      const aggregated = filteredData.reduce((acc, curr) => {
          let key;
          let label;
          if (filterType === 'expense') {
              key = curr.category;
              label = curr.category;
          } else { // income
              key = curr.incomeSource;
              label = curr.incomeSource;
          }
          acc[key] = { label: label, amount: (acc[key]?.amount || 0) + Number(curr.amount) };
          return acc;
      }, {});

      const sortedData = Object.values(aggregated).sort((a, b) => b.amount - a.amount);
      const labels = sortedData.map(d => d.label);
      const amounts = sortedData.map(d => d.amount);
      const colors = ['var(--c1)', 'var(--c2)', 'var(--c3)', 'var(--c4)', 'var(--c5)', 'var(--c6)', 'var(--c7)', 'var(--c8)', 'var(--c9)', 'var(--c10)', 'var(--c11)', 'var(--c12)'].slice(0, labels.length);

      chartInvTypesModal = new Chart(ctx.getContext('2d'), {
          type: 'doughnut',
          data: {
              labels,
              datasets: [{
                  data: amounts,
                  backgroundColor: colors,
                  hoverOffset: 6,
                  borderColor: '#ffffff',
                  borderWidth: 2
              }]
          },
          options: {
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'right',
                      labels: { boxWidth: 10 }
                  },
                  tooltip: {
                      callbacks: {
                          label: (c)=> {
                              const total = amounts.reduce((a,b)=>a+b,0);
                              const share = total ? ((c.parsed/total)*100).toFixed(1)+'%' : '0%';
                              return `${c.label}: ${fmt(c.parsed)} (${share})`;
                          }
                      }
                  }
              }
          }
      });
      
      // Investment Growth Chart (Stub for the second chart in the modal)
      if (chartInvGrowthModal) chartInvGrowthModal.destroy();
      const ctxGrowth = document.getElementById('chartInvGrowthModal')?.getContext('2d');
      if (ctxGrowth) {
          const invData = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
          const sortedInvData = invData.sort((a, b) => new Date(a.date) - new Date(b.date));
          const growthLabels = [];
          const growthValues = [];
          let cumulativeInv = 0;

          sortedInvData.forEach(d => {
              cumulativeInv += Number(d.amount);
              growthLabels.push(d.date);
              growthValues.push(cumulativeInv);
          });
          
          // Deduplicate dates for chart
          const uniqueGrowthLabels = [];
          const uniqueGrowthValues = [];
          if (growthLabels.length > 0) {
              let lastDate = growthLabels[0];
              let lastValue = growthValues[0];
              for (let i = 1; i < growthLabels.length; i++) {
                  if (growthLabels[i] !== lastDate) {
                      uniqueGrowthLabels.push(lastDate);
                      uniqueGrowthValues.push(lastValue);
                      lastDate = growthLabels[i];
                  }
                  lastValue = growthValues[i];
              }
              uniqueGrowthLabels.push(lastDate);
              uniqueGrowthValues.push(lastValue);
          }


          chartInvGrowthModal = new Chart(ctxGrowth, {
              type: 'line',
              data: {
                  labels: uniqueGrowthLabels,
                  datasets: [{
                      label: 'Cumulative invested (historical cost)',
                      data: uniqueGrowthValues,
                      borderColor: '#2980b9',
                      tension: 0.3,
                      borderWidth:2,
                      pointRadius:0
                  }]
              },
              options: {
                  maintainAspectRatio: false,
                  responsive: true,
                  plugins: {
                      legend: { position: 'top' },
                      tooltip: { callbacks: { label: (c)=>`${c.dataset.label}: ${fmt(c.parsed.y)}` } }
                  },
                  scales: {
                      y: {
                          beginAtZero: false,
                          ticks: { callback: (v)=>fmt(v).replace('â‚¹','â‚¹ ') },
                          grid:{color:'#eef2ff'}
                      },
                      x:{grid:{display:false}}
                  }
              }
          });
      }
    }

    // --- SETTINGS ---

    function updateMethodName(inputElement) {
      const key = inputElement.getAttribute('data-key');
      methodNames[key] = inputElement.value;
      saveAll();
      renderAll();
    }

    function removeMethod(key) {
      if (key === 'salary_acct' || key === 'savings_acct' || key === 'cash' || key === 'credit_card') {
        return alert('Cannot remove default methods.');
      }
      if (confirm(`Are you sure you want to remove the method "${methodNames[key]}"?`)) {
        delete methodNames[key];
        saveAll();
        renderAll();
      }
    }

    function addMethod() {
      const name = prompt("Enter a new account/method name:");
      if (name && name.trim()) {
        const key = name.trim().toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20);
        if (methodNames[key]) {
          alert("A similar method already exists or name is too long. Please try a different name.");
          return;
        }
        methodNames[key] = name.trim();
        saveAll();
        renderAll();
      }
    }

    function updateIncomeSource(inputElement, index) {
      incomeSources[index] = inputElement.value;
      saveAll();
      renderAll();
    }

    function removeIncomeSource(index) {
      if (confirm(`Are you sure you want to remove the income source "${incomeSources[index]}"?`)) {
        incomeSources.splice(index, 1);
        saveAll();
        renderAll();
      }
    }

    function addIncomeSource() {
      const name = prompt("Enter a new income source name:");
      if (name && name.trim()) {
        incomeSources.push(name.trim());
        saveAll();
        renderAll();
      }
    }
    
    function saveSettings() {
      settings.ccLimit = Number(document.getElementById('ccLimitInput').value) || DEFAULT_CC_LIMIT;
      saveAll();
      renderAll();
      document.getElementById('closeSettings').click();
      alert('Settings saved!');
    }

    function renderSettings() {
      const methodContainer = document.getElementById('methodEditor');
      methodContainer.innerHTML = Object.entries(methodNames).map(([key, name]) => `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
          <input type="text" value="${name}" data-key="${key}" onchange="updateMethodName(this)" style="flex:1; margin-right:10px;" ${CANONICAL_METHODS[key] ? 'disabled title="Cannot edit default method"' : ''} />
          <button class="btn-danger" style="padding: 6px 10px;" onclick="removeMethod('${key}')" ${CANONICAL_METHODS[key] ? 'disabled' : ''}>Remove</button>
        </div>
      `).join('');

      const incomeContainer = document.getElementById('incomeEditor');
      incomeContainer.innerHTML = incomeSources.map((source, index) => `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
          <input type="text" value="${source}" onchange="updateIncomeSource(this, ${index})" style="flex:1; margin-right:10px;" />
          <button class="btn-danger" style="padding: 6px 10px;" onclick="removeIncomeSource(${index})">Remove</button>
        </div>
      `).join('');
      
      document.getElementById('ccLimitInput').value = settings.ccLimit || DEFAULT_CC_LIMIT;
    }

    // --- IMPORT/EXPORT ---

    function convertToCSV(data) {
      const headers = ['id', 'type', 'amount', 'date', 'desc', 'category', 'method', 'incomeSource', 'investmentGroup', 'investmentSub', 'insuranceType', 'insuranceFor'];
      
      const rows = data.map(obj => headers.map(header => {
        let value = obj[header] ?? '';
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }).join(','));

      const csvContent = [ headers.join(','), ...rows ].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'MoneyMirror_Export.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function processImportedData() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) return alert('Please select a file.');

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        let importedData = [];

        if (file.name.endsWith('.json')) {
          try {
            importedData = JSON.parse(content);
          } catch (err) {
            return alert('Error parsing JSON file: ' + err.message);
          }
        } else if (file.name.endsWith('.csv')) {
          importedData = parseCSV(content);
        } else {
          return alert('Unsupported file type. Please use CSV or JSON.');
        }

        if (!importedData || importedData.length === 0) return alert('No valid data found in the file.');
        
        if (confirm(`Found ${importedData.length} records. Do you want to append this data to your existing data? This action cannot be undone.`)) {
            // Apply uid and ensure data types
            const newRecords = importedData.map(d => ({
                id: uid(), 
                type: d.type, 
                amount: Number(d.amount), 
                date: d.date, 
                desc: d.desc,
                category: d.category || '',
                method: d.method || '', 
                incomeSource: d.incomeSource || '',
                investmentGroup: d.investmentGroup || '', 
                investmentSub: d.investmentSub || '',
                insuranceType: d.insuranceType || '', 
                insuranceFor: d.insuranceFor || '',
            }));

            data = data.concat(newRecords);
            saveAll();
            renderAll();
            document.getElementById('closeImport').click();
            alert(`${newRecords.length} records imported successfully.`);
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const dataRows = [];

      for (let i = 1; i < lines.length; i++) {
        const currentLine = lines[i];
        if (!currentLine) continue;

        // Simple split that handles quoted commas (not foolproof, but better than just split(','))
        const values = [];
        let inQuotes = false;
        let currentField = '';
        for (let j = 0; j < currentLine.length; j++) {
            const char = currentLine[j];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                values.push(currentField.trim().replace(/"/g, ''));
                currentField = '';
            } else {
                currentField += char;
            }
        }
        values.push(currentField.trim().replace(/"/g, ''));


        if (values.length !== headers.length) {
            console.warn(`Skipping line ${i + 1}: header/value mismatch.`);
            continue;
        }

        const entry = {};
        for (let k = 0; k < headers.length; k++) {
            const header = headers[k];
            let value = values[k];
            // Basic type coercion for key fields
            if (header === 'amount') {
              value = Number(value);
            }
            entry[header] = value;
        }
        dataRows.push(entry);
      }
      return dataRows;
    }
    
    // --- SAMPLE DATA ---

    function loadSampleData() {
      if (!confirm("This will overwrite all existing data for your current profile. Continue?")) return;

      function randBetween(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
      function pick(arr) { return arr[randBetween(0, arr.length - 1)]; }
      function dateInLastMonths(months) {
        const today = new Date();
        const startMonth = months[0];
        const endMonth = months.length > 1 ? months[1] : startMonth;
        const monthDiff = randBetween(startMonth, endMonth);
        const targetDate = new Date(today);
        targetDate.setMonth(today.getMonth() - monthDiff);
        const maxDays = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
        targetDate.setDate(randBetween(1, maxDays));
        return targetDate.toISOString().slice(0,10);
      }
      
      data = [];
      methodNames = { ...CANONICAL_METHODS };
      incomeSources = ['Salary (Primary)', 'Freelance Income', 'Investment Income'];
      settings.ccLimit = 200000;

      // Opening balances (Cash)
      data.push({id:uid(), type:'opening_balance', amount: 50000, date: dateInLastMonths([6,6]), desc:'Initial Salary Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 20000, date: dateInLastMonths([5,6]), desc:'Initial Savings Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Savings)', method:'savings_acct', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 1500, date: dateInLastMonths([4,6]), desc:'Cash in hand', investmentGroup:'Cash', investmentSub:'Wallet Cash', method:'cash', category:'N/A'});

      // Opening balances (Investments)
      data.push({id:uid(), type:'opening_balance', amount: 150000, date: dateInLastMonths([10,12]), desc:'Stock Portfolio Opening Value', investmentGroup:'Direct Equity', investmentSub:'Large Cap', method:'investment_asset', category:'N/A', openingType:'Investment'});
      data.push({id:uid(), type:'opening_balance', amount: 80000, date: dateInLastMonths([8,12]), desc:'SIP Start Value', investmentGroup:'Mutual Funds', investmentSub:'Equity', method:'investment_asset', category:'N/A', openingType:'Investment'});
      data.push({id:uid(), type:'opening_balance', amount: 50000, date: dateInLastMonths([15,18]), desc:'FD Corpus', investmentGroup:'Fixed Deposits', investmentSub:'Bank FD', method:'investment_asset', category:'N/A', openingType:'Investment'});


      // Generate 100 random entries for the last 4 months
      const expenseCategories = BASE_CATS.filter(c => c !== 'Investments' && c !== 'Insurance' && c !== 'Credit Card Payment');
      const methodsPool = Object.keys(CANONICAL_METHODS).filter(k => k !== 'credit_card_payment');
      
      for (let i = 0; i < 100; i++) {
        const dt = dateInLastMonths([0, 4]);

        // Income
        if (Math.random() > 0.65) {
          const source = pick(incomeSources);
          data.push({
            id: uid(), type: 'income', amount: randBetween(10000, 75000), date: dt, desc: `${source} payment`,
            category: 'N/A', method: 'salary_acct', incomeSource: source
          });
        }

        const cat = pick(expenseCategories);
        const amt = randBetween(300, 9000);
        const method = pick(methodsPool);

        // Regular expenses
        data.push({ id: uid(), type: 'expense', amount: amt, date: dt, desc: `${cat} expense`, category: cat, method });

        // Investment (SIP/Buy)
        if (Math.random() > 0.75) {
          const invGroup = pick(Object.keys(INVESTMENT_STRUCTURE));
          const invSub = pick(Object.keys(INVESTMENT_STRUCTURE[invGroup]));
          data.push({
            id: uid(), type: 'expense', amount: randBetween(2000, 15000), date: dt, desc: `Investment â€” ${invSub}`,
            category: 'Investments', method: pick(['salary_acct','savings_acct']),
            investmentGroup: invGroup, investmentSub: invSub
          });
        }
        
        // Insurance
        if (Math.random() > 0.85) {
          data.push({
            id: uid(), type: 'expense', amount: randBetween(1500, 6000), date: dt, desc: 'Insurance premium payment',
            category: 'Insurance', method: pick(['salary_acct']),
            insuranceType: pick(['Health', 'Life']), insuranceFor: pick(['Self', 'Family'])
          });
        }
      }

      saveAll();
      renderAll();
      alert('Sample data loaded! Check the Recent transactions table.');
    }


    // --- CALCULATOR ---

    const CALC_STATE = {
      display: '0',
      preview: '',
      isNewNumber: true,
      lastOperator: null,
      lastValue: null,
      waitingForEquals: false
    };

    function updateCalcDisplay() {
      document.getElementById('calc-display').textContent = CALC_STATE.display;
      document.getElementById('calc-preview').textContent = CALC_STATE.preview;
    }

    function handleNumber(key) {
      if (CALC_STATE.isNewNumber) {
        CALC_STATE.display = key;
        CALC_STATE.isNewNumber = false;
      } else {
        CALC_STATE.display += key;
      }
      updateCalcDisplay();
    }

    function handleDecimal() {
      if (CALC_STATE.isNewNumber) {
        CALC_STATE.display = '0.';
        CALC_STATE.isNewNumber = false;
      } else if (!CALC_STATE.display.includes('.')) {
        CALC_STATE.display += '.';
      }
      updateCalcDisplay();
    }

    function handleClear(key) {
      if (key === 'AC') {
        CALC_STATE.display = '0';
        CALC_STATE.preview = '';
        CALC_STATE.isNewNumber = true;
        CALC_STATE.lastOperator = null;
        CALC_STATE.lastValue = null;
        CALC_STATE.waitingForEquals = false;
      } else if (key === 'C') {
        CALC_STATE.display = '0';
        CALC_STATE.isNewNumber = true;
      }
      updateCalcDisplay();
    }

    function handleOperator(key) {
      const current = parseFloat(CALC_STATE.display);
      CALC_STATE.isNewNumber = true;

      if (CALC_STATE.lastValue === null) {
        CALC_STATE.lastValue = current;
        CALC_STATE.preview = `${fmt(current).replace('â‚¹', '')} ${key}`;
      } else if (CALC_STATE.lastOperator) {
        const result = calculate(CALC_STATE.lastValue, current, CALC_STATE.lastOperator);
        CALC_STATE.lastValue = result;
        CALC_STATE.display = fmt(result).replace('â‚¹', '');
        CALC_STATE.preview = `${CALC_STATE.display} ${key}`;
      }

      CALC_STATE.lastOperator = key;
      CALC_STATE.waitingForEquals = true;
      updateCalcDisplay();
    }

    function handleEquals() {
      if (!CALC_STATE.lastOperator) return;

      let result;
      let current;

      if (CALC_STATE.waitingForEquals) {
        current = parseFloat(CALC_STATE.display);
        result = calculate(CALC_STATE.lastValue, current, CALC_STATE.lastOperator);
        CALC_STATE.waitingForEquals = false;
      } else {
        // Repeated equals, use the same operator and current value (as last value)
        current = parseFloat(CALC_STATE.lastValue);
        result = calculate(parseFloat(CALC_STATE.display), current, CALC_STATE.lastOperator);
      }

      CALC_STATE.lastValue = current;
      CALC_STATE.display = fmt(result).replace('â‚¹', '');
      CALC_STATE.preview = '';
      CALC_STATE.isNewNumber = true;
      updateCalcDisplay();
    }

    function calculate(n1, n2, operator) {
      switch (operator) {
        case '+': return n1 + n2;
        case 'âˆ’': return n1 - n2;
        case 'Ã—': return n1 * n2;
        case 'Ã·': return n1 / n2;
        default: return n2;
      }
    }

    document.getElementById('calc-buttons').addEventListener('click', (e) => {
      const key = e.target.closest('button')?.textContent.trim();
      if (!key) return;

      if (key >= '0' && key <= '9') {
        handleNumber(key);
      } else if (key === '.') {
        handleDecimal();
      } else if (key === 'AC' || key === 'C') {
        handleClear(key);
      } else if (key === '+' || key === 'âˆ’' || key === 'Ã—' || key === 'Ã·') {
        handleOperator(key);
      } else if (key === '=') {
        handleEquals();
      }
    });
    
    // Drag calc
    function dragElement(elmnt) {
      if (!elmnt) return;
      const header = document.getElementById(elmnt.id + "header") || document.getElementById('calc-header');
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      header.onmousedown = dragMouseDown;
      function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }
      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
      }
      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    // --- MISC ---
    document.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      document.getElementById('currentDate').innerText = d.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const today = new Date().toISOString().slice(0,10);
      const dateEl = document.getElementById('date');
      if (dateEl) dateEl.value = today;

      dragElement(document.getElementById("calculator"));

      const mobileBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('mainSidebar');
      mobileBtn.addEventListener('click', () => { sidebar.classList.toggle('mobile-open'); });
      document.querySelectorAll('.nav-item').forEach(item => { item.addEventListener('click', () => sidebar.classList.remove('mobile-open')); });
      
      document.getElementById('navSettings').addEventListener('click', () => { document.getElementById('settingsModal').classList.add('open'); });
      document.getElementById('closeSettings').addEventListener('click', () => { document.getElementById('settingsModal').classList.remove('open'); });
      
      document.getElementById('navAnalytics').addEventListener('click', () => { 
        document.getElementById('analyticsModal').classList.add('open'); 
        setupWalletFilters(); // Setup the filters on modal open
        renderAdvancedCharts(); 
        renderInvestmentAnalytics('modal'); 
      });
      document.getElementById('closeAnalytics').addEventListener('click', () => { document.getElementById('analyticsModal').classList.remove('open'); });

      document.getElementById('importDataBtn').addEventListener('click', () => { document.getElementById('importModal').classList.add('open'); });
      document.getElementById('closeImport').addEventListener('click', () => { document.getElementById('importModal').classList.remove('open'); });

      document.getElementById('calc-toggle').addEventListener('click', () => { 
        const calc = document.getElementById('calculator'); 
        calc.style.display = calc.style.display === 'none' ? 'flex' : 'none'; 
      });
      document.getElementById('calc-close-btn').addEventListener('click', (e) => { 
        document.getElementById('calculator').style.display = 'none'; 
        e.stopPropagation(); 
      });

      document.getElementById('sampleBtn').addEventListener('click', loadSampleData);
      document.getElementById('exportBtn').addEventListener('click', () => convertToCSV(data));
      document.getElementById('processImportBtn').addEventListener('click', processImportedData);
      
      document.getElementById('resetBtn').addEventListener('click', () => {
        if (confirm('WARNING: This will erase ALL your data (local and Firestore). Are you absolutely sure?')) {
          localStorage.clear();
          data = [];
          methodNames = {...CANONICAL_METHODS};
          incomeSources = ['Salary', 'Freelance', 'Interest'];
          settings = { ccLimit: DEFAULT_CC_LIMIT };
          saveAll();
          window.location.reload();
        }
      });

      clearForm(); // Set up the form fields initially
    });
  </script>
<body>
