<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MoneyMirror — v5.0.9 (Fixed Stable)</title>

  <!-- Fonts & Charts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@4.2.3/dist/chartjs-chart-treemap.min.js"></script>

  <!-- Firebase Compat (optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root{
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --kpi-elev-shadow: 0 18px 40px rgba(2,6,23,0.12), 0 8px 18px rgba(2,6,23,0.06);
      --kpi-inner-shadow: inset 0 1px 0 rgba(255,255,255,0.9);
      --kpi-border: rgba(148,163,184,0.45);
      --btn-elev: 0 8px 18px rgba(2,6,23,0.12);
      --btn-press: 0 4px 8px rgba(2,6,23,0.08);
      --glass: rgba(255,255,255,0.6);
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      font-family:'Inter',sans-serif;
      margin:0;
      background:linear-gradient(180deg,#f8fafc 0%, var(--bg-color) 100%);
      color:var(--text-main);
      display:flex;
      min-height:100vh;
      overflow:hidden;
    }

    /* Scrollbars */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    ::-webkit-scrollbar-thumb:hover{background:#94a3b8}

    /* Layout */
    aside{
      width:280px;
      background:linear-gradient(180deg,var(--sidebar-bg), #071020);
      color:white;
      padding:28px 18px;
      display:flex;
      flex-direction:column;
      gap:18px;
      flex-shrink:0;
      box-shadow: 8px 0 30px rgba(2,6,23,0.08);
      z-index:120;
    }
    main{
      flex:1;
      overflow:auto;
      padding:28px;
      display:flex;
      flex-direction:column;
      gap:22px;
      position:relative;
      transition:filter .25s ease, transform .2s ease;
    }

    /* Brand & nav */
    .brand{font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px}
    .brand svg{opacity:.95}
    .brand span{color:var(--sidebar-active);font-weight:800}
    .nav-group{margin-bottom:6px}
    .nav-label{font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
    .nav-item{
      display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;color:var(--sidebar-text);cursor:pointer;font-weight:600;
      transition:all .18s ease;
    }
    .nav-item:hover{background:rgba(255,255,255,0.03);color:white;transform:translateX(4px)}
    .nav-item.active{background:linear-gradient(90deg, rgba(56,189,248,0.08), rgba(59,130,246,0.04)); color:var(--sidebar-active); box-shadow: inset 0 0 0 1px rgba(56,189,248,0.03)}

    .nav-helper{background:rgba(255,255,255,0.03);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .nav-helper label{font-size:10px;color:#9aa7b8;margin-bottom:6px;display:block}
    .nav-helper select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6f0ff}

    .sidebar-footer{margin-top:auto;background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .sys-stat{display:flex;justify-content:space-between;font-size:12px;color:var(--sidebar-text)}
    .sys-val{font-weight:700;color:white}

    /* Auth gate - full screen overlay (fixed) */
    #authGate{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      background:linear-gradient(135deg,#0b1220 0%, rgba(11,18,35,0.92) 60%);
      padding:24px;
      transition:opacity .25s ease, visibility .25s ease;
    }
    #authGate.hidden{opacity:0;visibility:hidden;pointer-events:none}
    #authGate .auth-card{
      width:100%;
      max-width:720px;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:14px;
      padding:28px;
      box-shadow: 0 30px 80px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.04);
      text-align:center;
      color:white;
    }
    #authGate .auth-card h2{margin:0 0 6px;font-size:20px}
    #authGate .auth-card p{margin:0 0 18px;color:rgba(255,255,255,0.85)}
    #authGate .auth-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .auth-btn{
      padding:12px 22px;border-radius:10px;border:none;font-weight:700;cursor:pointer;
      box-shadow: var(--btn-elev);
      transition:transform .12s ease, box-shadow .12s ease;
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:white;
    }
    .auth-btn:active{transform:translateY(2px);box-shadow:var(--btn-press)}
    .auth-ghost{
      padding:12px 22px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:transparent;color:white;font-weight:700;cursor:pointer;
      box-shadow: 0 8px 18px rgba(2,6,23,0.08);
    }
    .auth-ghost:active{transform:translateY(2px);box-shadow:0 4px 8px rgba(2,6,23,0.06)}

    /* Top header area */
    .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .top-left h1{margin:0;font-size:22px;font-weight:800}
    .top-left .meta{color:var(--text-muted);font-size:13px;margin-top:6px;display:flex;gap:10px;align-items:center}
    .top-actions{display:flex;gap:10px;align-items:center}

    /* Buttons - 3D style */
    .btn{
      padding:10px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer;
      background:linear-gradient(180deg,#ffffff,#f1f5f9);
      box-shadow: 0 10px 24px rgba(2,6,23,0.08), inset 0 1px 0 rgba(255,255,255,0.6);
      transition:transform .12s ease, box-shadow .12s ease;
      color:var(--text-main);
    }
    .btn:active{transform:translateY(2px);box-shadow:0 6px 12px rgba(2,6,23,0.06)}
    .btn-primary{
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:white; box-shadow: 0 14px 36px rgba(37,99,235,0.18);
    }
    .btn-outline{
      background:linear-gradient(180deg,#ffffff,#f8fafc);
      border:1px solid var(--border);
      color:var(--text-main);
      box-shadow: 0 10px 24px rgba(2,6,23,0.06);
    }
    .btn-danger{
      background:linear-gradient(180deg,#fee2e2,#fee2e2);
      color:var(--danger);
      box-shadow: 0 10px 24px rgba(239,68,68,0.06);
    }

    /* Dashboard grid & cards with depth */
    .dashboard-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:20px;
      align-items:start;
    }
    .card{
      background:linear-gradient(180deg, var(--card-bg), #fbfdff);
      border-radius:14px;
      border:1px solid var(--border);
      padding:18px;
      box-shadow: 0 18px 40px rgba(2,6,23,0.06), inset 0 1px 0 rgba(255,255,255,0.6);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{transform:translateY(-6px);box-shadow: 0 30px 80px rgba(2,6,23,0.12)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px}
    .card-title{font-weight:700;color:var(--text-main);font-size:15px}

    /* KPI card specifics */
    .kpi-card{padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:8px}
    .kpi-value{font-size:26px;font-weight:800}
    .kpi-sub{font-size:12px;color:var(--text-muted)}

    /* Investment breakdown grid */
    .kpi-breakdown-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:stretch}

    /* Table */
    .table-container{overflow:auto;border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
    th{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.6px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.open{display:flex}
    .modal-content{width:95%;max-width:1100px;background:white;border-radius:12px;overflow:hidden;box-shadow:0 30px 80px rgba(2,6,23,0.3)}

    /* Responsive */
    @media(max-width:1200px){
      .dashboard-grid{grid-template-columns:repeat(2,1fr)}
    }
    @media(max-width:768px){
      aside{position:sticky;top:0;width:100%;height:64px;padding:12px;display:flex;align-items:center}
      main{padding:16px}
      .dashboard-grid{grid-template-columns:1fr;gap:14px}
      .card{padding:14px}
    }
  </style>
</head>
<body>

  <!-- AUTH GATE (full-screen overlay) -->
  <div id="authGate" role="dialog" aria-modal="true">
    <div class="auth-card" aria-label="Authentication gate">
      <h2>Welcome to MoneyMirror</h2>
      <p style="opacity:.9;margin-bottom:18px">Personal finance dashboard — by Rehan Hamdulay</p>
      <div style="display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap" class="auth-actions">
        <button id="loginBtn" class="auth-btn">Sign in with Google</button>
        <button id="guestBtn" class="auth-ghost">Continue as Guest (Offline)</button>
      </div>
      <div style="margin-top:18px;color:rgba(255,255,255,0.7);font-size:13px">You can use Guest mode without internet or sign in to sync with cloud.</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <aside id="mainSidebar" aria-label="Main navigation">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="5" width="20" height="14" rx="2" />
          <line x1="2" y1="10" x2="22" y2="10" />
        </svg>
        <div>
          MoneyMirror <span>v5.0.9</span>
        </div>
      </div>
      <button id="mobileMenuBtn" aria-label="Toggle menu" style="background:transparent;border:none;color:white;display:none">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active" id="navDashboard">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>
        <a href="#marketSettingsModal" class="nav-item openModal" data-modal-id="marketSettingsModal" style="text-decoration:none;color:inherit">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 3v18h18"></path><path d="M19 9l-5 5-4-4-3 3"></path></svg>
          <span>Market ticker</span>
        </a>

        <div class="nav-helper" style="margin-top:12px">
          <label>Quick add index</label>
          <select id="sidebarIndexSelect" aria-label="Quick add index">
            <option value="">Choose...</option>
            <option value="NIFTY_50|Nifty 50">NIFTY 50 (India)</option>
            <option value="SENSEX|Sensex">SENSEX (India)</option>
            <option value="NASDAQ|Nasdaq">NASDAQ (US)</option>
            <option value="DJI|Dow Jones">Dow Jones (US)</option>
            <option value="SPX|S&P 500">S&P 500 (US)</option>
            <option value="FTSE_100|FTSE 100">FTSE 100 (UK)</option>
            <option value="DAX|DAX">DAX (Germany)</option>
            <option value="CAC_40|CAC 40">CAC 40 (France)</option>
            <option value="NIKKEI_225|Nikkei 225">Nikkei 225 (Japan)</option>
            <option value="HSI|Hang Seng">Hang Seng (Hong Kong)</option>
          </select>
          <button id="sidebarAddIndexBtn" class="btn" style="margin-top:8px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:white">Add to ticker</button>
        </div>
      </div>

      <div class="nav-group" style="margin-top:14px">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%;display:none">Logout</button></div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="sys-stat">
        <span>Current profile</span>
        <span class="sys-val" id="profileNameDisplay">--</span>
      </div>
      <div style="font-size:11px;color:var(--sidebar-text);margin-top:8px">v5.0.9 • Restored visuals & analytics</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main id="mainContent" aria-live="polite">
    <div class="top-row">
      <div class="top-left">
        <h1>Financial overview</h1>
        <div class="meta">
          <span id="currentDate">--</span>
          <span id="currentClock">--:--:--</span>
        </div>
      </div>

      <div class="top-actions">
        <button id="sampleBtn" class="btn-outline">Load sample</button>
        <button id="importDataBtn" class="btn-primary">Import data</button>
        <button id="exportBtn" class="btn">Export CSV</button>
        <div id="calc-toggle" class="btn-outline" title="Toggle calculator" style="display:flex;align-items:center;gap:8px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="14" x2="12.01" y2="14"></line><line x1="8" y1="10" x2="8.01" y2="10"></line><line x1="16" y1="10" x2="16.01" y2="10"></line></svg>
        </div>
      </div>
    </div>

    <!-- KPI GRID -->
    <div class="dashboard-grid" role="region" aria-label="Key performance indicators">
      <div class="card kpi-card kpi-income col-span-1" style="border-left:6px solid var(--success)">
        <div class="card-header">
          <div class="card-title" style="color:var(--success)">Monthly income</div>
        </div>
        <div class="kpi-value" id="kpiIncome">₹0</div>
        <div class="kpi-sub" id="momIncome">--</div>
      </div>

      <div class="card kpi-card kpi-expense col-span-1" style="border-left:6px solid var(--danger)">
        <div class="card-header">
          <div class="card-title" style="color:var(--danger)">Monthly expenses</div>
        </div>
        <div class="kpi-value" id="kpiExpense">₹0</div>
        <div class="kpi-sub" id="momExpense">--</div>
      </div>

      <div class="card kpi-card kpi-cc col-span-1" id="ccCard" style="border-left:6px solid var(--warning); background:linear-gradient(180deg,#fff7ed,#fffbeb)">
        <div class="card-header">
          <div class="card-title" id="ccTitle" style="color:var(--warning)">Credit card due</div>
        </div>
        <div class="kpi-value" id="kpiCCDue">₹0</div>
        <div class="cc-slider-wrap" style="margin-top:10px">
          <div class="cc-slider-bar" style="background:#f1f5f9;border-radius:8px;height:10px;overflow:hidden">
            <div id="ccSliderFill" class="cc-slider-fill" style="height:100%;width:0%;background:linear-gradient(90deg,#f97316,#f59e0b)"></div>
          </div>
          <div class="cc-slider-labels" style="margin-top:6px;display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted)">
            <span>Used</span><span id="ccSliderPercent">0%</span>
          </div>
        </div>
        <div class="kpi-sub" style="margin-top:8px;color:#000;font-weight:700">
          <span id="ccPaymentDate">Next: --</span>
          <span style="margin-left:10px">Limit: <span id="ccLimitDisplay">₹0</span></span>
          <div id="ccAlert" class="hidden" style="position:absolute;right:28px;top:18px;color:var(--danger)"></div>
        </div>
      </div>

      <div class="card kpi-card kpi-net col-span-1" style="border-left:6px solid var(--primary)">
        <div class="card-header">
          <div class="card-title" style="color:var(--primary)">Net liquidity</div>
        </div>
        <div class="kpi-value" id="kpiNet">₹0</div>
        <div class="kpi-sub">Total available cash</div>
        <div class="account-list" id="netLiquidityBreakdown" style="margin-top:10px"></div>
      </div>

      <div class="card kpi-card kpi-invest col-span-4" style="grid-column:1 / -1; border-left:6px solid #075985; background:linear-gradient(180deg,#e0f2fe,#f0fbff)">
        <div class="card-header" style="padding-bottom:6px">
          <div class="card-title" style="color:#075985">Total investment value</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="toggleInvBreakdown" class="btn-outline" style="padding:8px 10px;font-size:13px">View breakdown</button>
            <button id="viewCategoriesBtn" class="btn-outline" style="padding:8px 10px;font-size:13px">View subcategories</button>
          </div>
        </div>

        <div class="card-body" style="padding-top:6px">
          <div class="kpi-value" id="kpiInvest">₹0</div>
          <div class="kpi-sub" id="momInvest" style="color:#075985">Historical cost total</div>

          <div id="invBreakdownPanel" class="hidden" style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
            <div class="card" style="border-color:#93c5fd;margin-bottom:12px">
              <div class="card-header">
                <div class="card-title">Filters</div>
                <div class="flex-row" style="gap:10px;width:100%">
                  <div class="input-group-med">
                    <label>Major bucket</label>
                    <select id="invBucketFilter"></select>
                  </div>
                  <div class="input-group-med">
                    <label>View mode</label>
                    <select id="invViewMode">
                      <option value="top4">Top 4 buckets</option>
                      <option value="subcats">Subcategories</option>
                    </select>
                  </div>
                  <div class="input-group-med">
                    <label>Date range</label>
                    <select id="invDateRange">
                      <option value="6">Last 6 months</option>
                      <option value="12">Last 12 months</option>
                      <option value="all">All time</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="kpi-breakdown-grid">
              <div class="card" style="border-color:#93c5fd">
                <div class="card-header"><div class="card-title" id="invBarTitle">Major buckets</div></div>
                <div class="card-body" style="height:300px">
                  <canvas id="invBreakdownBar"></canvas>
                </div>
              </div>

              <div class="card" style="border-color:#93c5fd">
                <div class="card-header"><div class="card-title" id="invPieTitle">Share</div></div>
                <div class="card-body" style="height:300px">
                  <canvas id="invBreakdownPie"></canvas>
                </div>
              </div>
            </div>

            <div style="margin-top:14px">
              <div class="card-title" style="font-size:13px;color:#075985;margin-bottom:10px">Bucket subcategories quick view</div>
              <div id="invQuickSubs" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts row -->
    <div class="dashboard-grid" style="grid-template-columns:repeat(4,1fr);gap:20px">
      <div class="card col-span-2" style="grid-column: span 2">
        <div class="card-header">
          <div class="card-title">Cash flow & investments</div>
          <select id="mainChartFilter" onchange="renderCharts()" style="max-width:140px;padding:8px;border-radius:8px;border:1px solid var(--border)">
            <option value="6">Last 6m</option>
            <option value="12">Last 12m</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="card-body" style="height:320px">
          <canvas id="mainChart" style="width:100%;height:100%"></canvas>
        </div>
      </div>

      <div class="card col-span-2" style="grid-column: span 2">
        <div class="card-header">
          <div class="card-title">Wallet & Expenses</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="walletMode" onchange="renderWalletUnified()" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
              <option value="wallet">Wallet breakdown</option>
              <option value="expenses">Expense distribution</option>
            </select>
          </div>
        </div>
        <div class="card-body" style="display:flex;flex-direction:column;gap:18px">
          <div style="height:280px">
            <canvas id="donutChart" style="width:100%;height:100%"></canvas>
          </div>
          <div id="walletLegend" style="font-size:13px;color:var(--text-muted)"></div>
        </div>
      </div>
    </div>

    <!-- Add entry & recent transactions -->
    <div class="dashboard-grid" style="grid-template-columns:repeat(4,1fr);gap:20px">
      <div class="card action-card col-span-4" style="grid-column:1 / -1">
        <div class="action-header" style="background:linear-gradient(90deg,var(--primary),var(--primary-dark));padding:14px;border-radius:10px;color:white">
          <div class="card-title">Add new entry</div>
        </div>
        <div class="action-body" style="padding:18px">
          <div style="display:flex;gap:12px;flex-wrap:wrap;width:100%">
            <div style="min-width:160px;flex:1">
              <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Type</label>
              <select id="type" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
                <option value="opening_balance">Opening Balance</option>
              </select>
            </div>

            <div style="min-width:160px;flex:1">
              <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Amount (₹)</label>
              <input id="amount" type="number" step="any" placeholder="0.00" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%;font-weight:700;font-size:16px" />
            </div>

            <div style="min-width:160px;flex:1">
              <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Date</label>
              <input id="date" type="date" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%" />
            </div>

            <div style="min-width:220px;flex:2">
              <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Description</label>
              <input id="desc" placeholder="Optional notes..." style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%" />
            </div>
          </div>

          <div id="dynamicFieldsContainer" style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px">
            <div id="regularFields" style="display:flex;gap:12px;flex-wrap:wrap">
              <div id="categoryContainer" style="min-width:160px;flex:1">
                <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Category</label>
                <select id="category" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
              </div>

              <div id="subcategoryContainer" style="min-width:160px;flex:1;display:none">
                <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Subcategory</label>
                <select id="subcategory" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
              </div>

              <div style="min-width:160px;flex:1">
                <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Method</label>
                <select id="method" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
              </div>

              <div id="incomeSourceRow" style="min-width:160px;flex:1;display:none">
                <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Source</label>
                <select id="incomeSource" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
              </div>

              <div id="investmentRow" style="display:none;gap:12px;flex-wrap:wrap;width:100%">
                <div style="min-width:160px;flex:1">
                  <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Investment category</label>
                  <select id="invGroup" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
                </div>
                <div style="min-width:160px;flex:1">
                  <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Investment sub-type</label>
                  <select id="invSub" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
                </div>
              </div>

            </div>

            <div id="openingBalanceRow" style="display:none;margin-top:12px">
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="min-width:160px;flex:1">
                  <label style="font-size:11px;font-weight:700;color:var(--text-muted)">Asset type</label>
                  <select id="openingType" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%">
                    <option value="Cash">Cash (Liquid)</option>
                    <option value="Investment">Investment Asset</option>
                  </select>
                </div>

                <div id="openingGroupContainer" style="min-width:160px;flex:1;display:none">
                  <label id="openingGroupLabel" style="font-size:11px;font-weight:700;color:var(--text-muted)">Asset category</label>
                  <select id="openingGroup" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
                </div>

                <div id="openingSubContainer" style="min-width:160px;flex:1;display:none">
                  <label id="openingSubLabel" style="font-size:11px;font-weight:700;color:var(--text-muted)">Account / Asset sub-type</label>
                  <select id="openingSub" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
                </div>
              </div>
            </div>

          </div>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button id="addBtn" class="btn-primary" style="flex:1">Add entry</button>
            <button id="saveBtn" class="btn-primary" style="flex:1;display:none">Save changes</button>
            <button id="cancelBtn" class="btn-outline" style="flex:1;display:none">Cancel</button>
          </div>
        </div>
      </div>

      <div class="card col-span-4" style="grid-column:1 / -1">
        <div class="card-header" style="flex-direction:column;align-items:flex-start;gap:12px">
          <div class="card-title">Recent transactions</div>
          <div style="display:flex;gap:10px;width:100%;align-items:center">
            <input id="recentSearch" placeholder="Search..." style="padding:10px;border-radius:8px;border:1px solid var(--border);flex:1" />
            <select id="recentSort" style="padding:10px;border-radius:8px;border:1px solid var(--border)">
              <option value="dateDesc">Newest</option>
              <option value="dateAsc">Oldest</option>
              <option value="amtDesc">Amt High</option>
              <option value="amtAsc">Amt Low</option>
            </select>
            <select id="recentCategory" style="padding:10px;border-radius:8px;border:1px solid var(--border)">
              <option value="">All Cats</option>
            </select>
            <select id="entryLimit" style="padding:10px;border-radius:8px;border:1px solid var(--border);width:80px">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>

        <div class="card-body table-container" style="padding:0;margin-top:12px">
          <table id="recentTable" style="min-width:900px">
            <thead>
              <tr>
                <th>Type</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Category</th>
                <th>Method</th>
                <th style="width:120px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div> <!-- end add/recent grid -->

    <!-- Modals and other UI elements will be appended after this part -->
  </main>

  <!-- Minimal calculator (hidden by default) -->
  <div id="calculator" style="display:none;position:fixed;right:20px;bottom:20px;width:300px;height:480px;background:#fff;border-radius:12px;box-shadow:0 30px 80px rgba(2,6,23,0.2);z-index:3000;overflow:hidden">
    <div id="calc-header" style="background:var(--sidebar-bg);color:white;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;cursor:move">
      <div style="font-weight:700">Calculator</div>
      <button id="calc-close-btn" style="background:transparent;border:none;color:#ffb4b4;font-size:18px;cursor:pointer">×</button>
    </div>
    <div id="calc-display" style="background:var(--sidebar-bg);color:white;padding:12px 14px;font-size:22px;text-align:right;height:64px;display:flex;align-items:center;justify-content:flex-end">0</div>
    <div id="calc-preview" style="background:#0b1323;color:#9fb3c8;padding:6px 14px;font-size:13px;text-align:right">Enter an expression…</div>
    <div id="calc-buttons" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px;background:#fff;height:calc(100% - 160px)">
      <button class="calc-clear btn-outline">AC</button>
      <button class="calc-clear btn-outline">±</button>
      <button class="calc-clear btn-outline">%</button>
      <button class="calc-operator btn-outline">/</button>

      <button class="btn">7</button>
      <button class="btn">8</button>
      <button class="btn">9</button>
      <button class="calc-operator btn-outline">*</button>

      <button class="btn">4</button>
      <button class="btn">5</button>
      <button class="btn">6</button>
      <button class="calc-operator btn-outline">-</button>

      <button class="btn">1</button>
      <button class="btn">2</button>
      <button class="btn">3</button>
      <button class="calc-operator btn-outline">+</button>

      <button class="btn calc-zero" style="grid-column:span 2">0</button>
      <button class="btn">.</button>
      <button class="calc-equals btn-primary" style="grid-row:span 2">=</button>
    </div>
  </div>

  <!-- Placeholder for modals (analytics, settings, import, market) -->
  <div id="modalsRoot"></div>

  <!-- BEGIN SCRIPTS: Part 1 (core helpers, auth, bootstrap) -->
  <script>
    /* ---------- CONFIG ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
    };

    let db = null;
    let auth = null;
    let USE_FIRESTORE = false;
    let currentProfile = null;

    try {
      if (typeof firebase !== 'undefined') {
        const app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        auth = app.auth();
        USE_FIRESTORE = true;
      }
    } catch (e) {
      console.warn('Firebase not available, running in local-only mode.');
    }

    /* ---------- HELPERS ---------- */
    function fmt(n){ return (n||0).toLocaleString('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:0 }); }
    function formatCurrency(amt){ return `₹${(amt||0).toLocaleString('en-IN')}`; }
    function pct(n){ return (n||0).toFixed(1) + '%'; }
    function uid(){ return 'id' + Date.now() + Math.random().toString(16).slice(2); }
    function toKey(s){ return String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_'); }
    function nowDateISO(){ return new Date().toISOString().slice(0,10); }

    /* ---------- STATE ---------- */
    let data = [];
    let methodNames = { cash:'Cash', salary_acct:'Bank Account (Salary)', savings_acct:'Bank Account (Savings)', credit_card:'Credit Card', digital_wallet:'Digital Wallet' };
    let incomeSources = ['Salary','Freelance','Interest'];
    let settings = {
      ccLimit: 200000,
      expenseCategories: ['Food','Rent','Utilities','Shopping','Entertainment','Travel','Health','Investments','Insurance','Credit Card Payment','Misc'],
      trackedMarkets: [
        { symbol:'SENSEX', name:'Sensex', price:72000, change:0.85 },
        { symbol:'NASDAQ', name:'Nasdaq', price:16000, change:-1.23 },
        { symbol:'XAUUSD', name:'Gold/USD', price:2350, change:0.15 }
      ],
      commodityCountry: ''
    };
    let editId = null;
    let selectedExpenseCategories = [];

    /* ---------- AUTH GATE HANDLERS ---------- */
    const authGateEl = document.getElementById('authGate');
    function showAuthGate(){ authGateEl.classList.remove('hidden'); document.getElementById('mainContent').style.filter='blur(6px)'; }
    function hideAuthGate(){ authGateEl.classList.add('hidden'); document.getElementById('mainContent').style.filter='none'; }

    async function signInWithGoogle(){
      if(!auth) return alert('Sign-in not available in this environment. Use Guest mode.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        const res = await auth.signInWithPopup(provider);
        onUserSignedIn(res.user);
      }catch(err){
        console.error('Google sign-in failed', err);
        alert('Sign-in failed. Try Guest mode.');
      }
    }
    function startGuestMode(){
      currentProfile = 'Guest';
      localStorage.setItem('mm_last_profile', currentProfile);
      document.getElementById('profileNameDisplay').textContent = 'Guest (Offline)';
      hideAuthGate();
      document.getElementById('logoutBtn').style.display = 'block';
      loadProfileData();
    }
    function onUserSignedIn(user){
      currentProfile = user.displayName || user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      document.getElementById('profileNameDisplay').textContent = currentProfile;
      hideAuthGate();
      document.getElementById('logoutBtn').style.display = 'block';
      loadProfileData();
    }
    function signOutUser(){
      if(auth){
        auth.signOut().then(()=>{ resetToAuthGate(); });
      } else {
        resetToAuthGate();
      }
    }
    function resetToAuthGate(){
      currentProfile = null;
      document.getElementById('profileNameDisplay').textContent = '--';
      document.getElementById('logoutBtn').style.display = 'none';
      showAuthGate();
    }

    /* ---------- PERSISTENCE ---------- */
    function getTxKey(){ return currentProfile ? `mm_data_${toKey(currentProfile)}` : 'mm_data_default'; }
    function getMethodKey(){ return currentProfile ? `mm_methods_${toKey(currentProfile)}` : 'mm_methods_default'; }
    function getIncomeKey(){ return currentProfile ? `mm_income_${toKey(currentProfile)}` : 'mm_income_default'; }
    function getSettingsKey(){ return currentProfile ? `mm_settings_${toKey(currentProfile)}` : 'mm_settings_default'; }

    function saveLocal(){
      localStorage.setItem(getTxKey(), JSON.stringify(data));
      localStorage.setItem(getMethodKey(), JSON.stringify(methodNames));
      localStorage.setItem(getIncomeKey(), JSON.stringify(incomeSources));
      localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
    }
    async function saveAll(){
      saveLocal();
      if(USE_FIRESTORE && db && currentProfile){
        try{
          await db.collection('moneymirror_v5_profile').doc(toKey(currentProfile)).set({ data, methodNames, incomeSources, settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        }catch(e){
          console.warn('Firestore save failed, local saved instead', e);
        }
      }
    }

    function loadLocal(){
      try{
        methodNames = JSON.parse(localStorage.getItem(getMethodKey())) || methodNames;
        incomeSources = JSON.parse(localStorage.getItem(getIncomeKey())) || incomeSources;
        data = JSON.parse(localStorage.getItem(getTxKey())) || data;
        const s = JSON.parse(localStorage.getItem(getSettingsKey()));
        if(s) settings = Object.assign({}, settings, s);
      }catch(e){ console.warn('Local load failed', e); }
    }

    async function loadProfileData(){
      loadLocal();
      if(USE_FIRESTORE && db && currentProfile && currentProfile !== 'Guest'){
        try{
          const doc = await db.collection('moneymirror_v5_profile').doc(toKey(currentProfile)).get();
          if(doc.exists){
            const server = doc.data();
            data = server.data || data;
            methodNames = server.methodNames || methodNames;
            incomeSources = server.incomeSources || incomeSources;
            settings = Object.assign({}, settings, server.settings || {});
          }
        }catch(e){ console.warn('Firestore read failed', e); }
      }
      renderAll();
    }

    /* ---------- BOOTSTRAP BINDINGS ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      // Auth buttons
      document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
      document.getElementById('guestBtn').addEventListener('click', startGuestMode);
      document.getElementById('logoutBtn').addEventListener('click', signOutUser);

      // Top actions
      document.getElementById('sampleBtn').addEventListener('click', () => {
        if(confirm('Overwrite existing data with sample?')) loadSampleData();
      });
      document.getElementById('exportBtn').addEventListener('click', () => convertToCSV(data));
      document.getElementById('importDataBtn').addEventListener('click', () => openImportModal());

      // Sidebar quick add
      document.getElementById('sidebarAddIndexBtn').addEventListener('click', () => {
        const val = document.getElementById('sidebarIndexSelect').value;
        if(!val) return alert('Choose an index first');
        const [symbol,name] = val.split('|');
        addIndexToSettings(symbol,name);
        document.getElementById('sidebarIndexSelect').value = '';
        renderMarketList();
        renderMarketTicker();
      });

      // Calculator toggle
      document.getElementById('calc-toggle').addEventListener('click', () => {
        const calc = document.getElementById('calculator');
        calc.style.display = calc.style.display === 'none' ? 'block' : 'none';
      });
      document.getElementById('calc-close-btn').addEventListener('click', () => {
        document.getElementById('calculator').style.display = 'none';
      });

      // Date & clock
      const dateEl = document.getElementById('date');
      if(dateEl) dateEl.value = nowDateISO();
      const currentDateEl = document.getElementById('currentDate');
      if(currentDateEl) currentDateEl.textContent = new Date().toLocaleDateString('en-IN', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      const clockEl = document.getElementById('currentClock');
      function tick(){ clockEl.textContent = new Date().toLocaleTimeString('en-IN', { hour12:false }); }
      tick(); setInterval(tick,1000);

      // Auth state (if firebase available)
      const lastProfile = localStorage.getItem('mm_last_profile');
      if(auth){
        auth.onAuthStateChanged(user => {
          if(user) onUserSignedIn(user);
          else if(lastProfile === 'Guest') startGuestMode();
          else showAuthGate();
        });
      } else {
        if(lastProfile === 'Guest') startGuestMode();
        else showAuthGate();
      }

      // Wire up some UI interactions that must exist early
      document.getElementById('type').addEventListener('change', updateTransactionFormFields);
      document.getElementById('category').addEventListener('change', updateTransactionFormFields);
      document.getElementById('invGroup').addEventListener('change', () => updateInvestmentSubDropdown(document.getElementById('invGroup'), document.getElementById('invSub')));

      // Bind add/save/cancel
      document.getElementById('addBtn').addEventListener('click', () => submitForm());
      document.getElementById('saveBtn').addEventListener('click', () => {
        const entry = data.find(d => d.id === editId);
        if(entry) submitForm(entry);
      });
      document.getElementById('cancelBtn').addEventListener('click', () => {
        editId = null;
        document.getElementById('addBtn').style.display = 'inline-block';
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('cancelBtn').style.display = 'none';
        clearForm();
      });

      // Wire recent table filters
      document.getElementById('recentSearch').addEventListener('keyup', renderRecentEntries);
      document.getElementById('recentSort').addEventListener('change', renderRecentEntries);
      document.getElementById('recentCategory').addEventListener('change', renderRecentEntries);
      document.getElementById('entryLimit').addEventListener('change', renderRecentEntries);

      // Setup expense multiselect UI
      setupExpenseMultiSelect();

      // Setup investment dropdowns
      populateInvestmentGroupDropdowns();

      // Render initial UI
      renderAll();
      renderMarketList();
      renderMarketTicker();
    });

    /* ---------- STUBS / PLACEHOLDERS for functions referenced in UI (will be implemented in subsequent parts) ---------- */
    function renderAll(){ /* full render implemented in part 2/3 */ }
    function renderCharts(){ /* implemented in part 2/3 */ }
    function renderWalletUnified(){ /* implemented in part 2/3 */ }
    function renderRecentEntries(){ /* implemented in part 2/3 */ }
    function setupExpenseMultiSelect(){ /* implemented in part 2/3 */ }
    function populateInvestmentGroupDropdowns(){ /* implemented in part 2/3 */ }
    function updateTransactionFormFields(){ /* implemented in part 2/3 */ }
    function updateInvestmentSubDropdown(){ /* implemented in part 2/3 */ }
    function submitForm(){ /* implemented in part 2/3 */ }
    function clearForm(){ /* implemented in part 2/3 */ }
    function convertToCSV(){ /* implemented in part 2/3 */ }
    function openImportModal(){ alert('Import modal will open (part 2)'); }
    function addIndexToSettings(symbol,name){ settings.trackedMarkets = settings.trackedMarkets || []; if(!settings.trackedMarkets.some(m=>m.symbol===symbol)) settings.trackedMarkets.push({symbol,name,price:0,change:0}); saveLocal(); }

    /* ---------- SAMPLE DATA helper (used by sample button) ---------- */
    function loadSampleData(){
      // Minimal sample loader to populate UI quickly; full sample generator in part 2
      data = [
        { id: uid(), type:'opening_balance', amount:50000, date: nowDateISO(), desc:'Opening cash', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct', category:'N/A' },
        { id: uid(), type:'income', amount:120000, date: nowDateISO(), desc:'Salary credit', category:'N/A', method:'salary_acct', incomeSource:'Salary' },
        { id: uid(), type:'expense', amount:24674, date: nowDateISO(), desc:'Monthly groceries', category:'Food', method:'cash' },
        { id: uid(), type:'expense', amount:132606, date: nowDateISO(), desc:'Credit card outstanding', category:'Credit Card Payment', method:'credit_card_payment' },
        { id: uid(), type:'expense', amount:80000, date: nowDateISO(), desc:'Mutual fund SIP', category:'Investments', investmentGroup:'Mutual Funds', investmentSub:'Equity MF - Large Cap/Mid Cap/Small Cap', method:'savings_acct' }
      ];
      saveAll();
      renderAll();
      alert('Sample data loaded (quick). For a larger sample use the full generator in the next update.');
    }

    /* Expose a few functions for console debugging */
    window.saveAll = saveAll;
    window.loadSampleData = loadSampleData;
    window.startGuestMode = startGuestMode;
    window.signInWithGoogle = signInWithGoogle;
  </script>
 
<!-- BEGIN Part 2: Charts, UI logic, modals, and full feature implementations (no truncation) -->
<!-- Place this immediately after Part 1 script block or replace the stubbed functions in Part 1 -->
<script>
/* ---------- CONSTANTS & STRUCTURES ---------- */
const DEFAULT_CC_LIMIT = 200000;
const DEFAULT_SETTINGS = settings; // from part1
const CANONICAL_METHODS = { ...methodNames };
const DEFAULT_EXPENSE_CATEGORIES = settings.expenseCategories.slice();
const PROTECTED_CATS = ['Investments','Insurance','Credit Card Payment','N/A'];
const MAJOR_BUCKETS = {
  'Mutual Funds':'Mutual Funds',
  'ETFs':'ETFs',
  'Retirement Funds':'Retirement',
  'Real Estate':'Real Estate',
  'Bonds & Debt Instruments':'Debt',
  'Crypto & Digital Assets':'Crypto',
  'Commodities':'Commodities',
  'Fixed Income / Savings Schemes':'Debt',
  'Cash':'Cash',
  'Other':'Other'
};
const INVESTMENT_STRUCTURE = {
  'Mutual Funds': {
    'Equity MF - Large Cap/Mid Cap/Small Cap': {},
    'Equity MF - ELSS (Tax Saving)': {},
    'Hybrid MF': {}
  },
  'ETFs': { 'Gold ETF': {}, 'Equity ETF': {} },
  'Retirement Funds': { 'NPS Tier 1/Tier 2': {}, 'EPF': {} },
  'Real Estate': { 'REITs (Real Estate Investment Trusts)': {} },
  'Bonds & Debt Instruments': { 'Corporate Bonds': {}, 'Government Bonds': {}, 'FD (Fixed Deposit)': {} },
  'Crypto & Digital Assets': { 'Bitcoin (BTC)': {}, 'Ethereum (ETH)': {} },
  'Commodities': { 'Gold': {}, 'Silver': {} },
  'Cash': { 'Bank Account (Salary)': {}, 'Bank Account (Savings)': {}, 'Cash': {} },
  'Other': {}
};
const SUBCATEGORY_MAP = {
  'Food': ['Veg','Non-Veg','Dining Out'],
  'Travel': ['Taxi','Flight','Hotel'],
  'Shopping': ['Clothes','Electronics'],
  'Health': ['Pharmacy','Doctor'],
  'Utilities': ['Electricity','Internet']
};
const methodNamesDefault = { ...methodNames };

/* ---------- UTILITY: COLORS & FORMATTERS ---------- */
function getColorPalette(n) {
  const base = ['#2563eb','#10b981','#f59e0b','#ef4444','#7c3aed','#0ea5e9','#14b8a6','#22c55e','#eab308','#f97316','#374151','#8b5cf6'];
  const out = [];
  for (let i=0;i<n;i++) out.push(base[i % base.length]);
  return out;
}
function fmtNumber(n) { return (n||0).toLocaleString('en-IN'); }
function fmt(n) { return formatCurrency(Number(n)); }

/* ---------- MODALS: analytics, settings, import, market ---------- */
(function injectModals(){
  const root = document.getElementById('modalsRoot');
  if(!root) return;
  root.innerHTML = `
    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal" role="dialog" aria-modal="true" aria-label="Advanced analytics">
      <div class="modal-content">
        <div class="card-header" style="padding:18px 22px; background:linear-gradient(90deg,var(--primary),var(--primary-dark)); color:white; display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:800">Advanced financial analytics</div>
          <button class="closeModal btn-outline" data-modal-id="analyticsModal" style="background:white;color:var(--text-main);">Close</button>
        </div>
        <div class="modal-pad">
          <div class="analytics-filter-grid" style="margin-bottom:18px">
            <div>
              <label style="font-size:11px;color:var(--text-muted)">DATE RANGE</label>
              <select id="anlDateRange" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:100%">
                <option value="6">Last 6 months</option>
                <option value="12">Last 12 months</option>
                <option value="all">All time</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;color:var(--text-muted)">INVESTMENT GROUP</label>
              <select id="anlInvGroup" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
            </div>
            <div>
              <label style="font-size:11px;color:var(--text-muted)">INVESTMENT SUB-TYPE</label>
              <select id="anlInvSub" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:100%"></select>
            </div>
            <div>
              <label style="font-size:11px;color:var(--text-muted)">CHART TYPE</label>
              <select id="anlChartType" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:100%">
                <option value="line">Line chart</option>
                <option value="bar">Bar chart</option>
                <option value="area">Area chart</option>
              </select>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="card" style="height:320px">
              <div class="card-header"><div class="card-title">Investment Cumulative Growth</div><button id="drilldownBtn" class="btn-outline" style="padding:6px 8px">Drilldown</button></div>
              <div class="card-body" style="height:240px"><canvas id="cumulativeGrowthChart"></canvas></div>
            </div>

            <div class="card" style="height:320px">
              <div class="card-header"><div class="card-title">Investment Heatmap (Value by Subcategory)</div></div>
              <div class="card-body" style="height:240px"><canvas id="investmentTreeMap"></canvas></div>
            </div>

            <div class="card" style="height:260px">
              <div class="card-header"><div class="card-title">Asset Distribution</div></div>
              <div class="card-body" style="height:200px"><canvas id="assetDistributionChart"></canvas></div>
            </div>

            <div class="card" style="height:260px">
              <div class="card-header"><div class="card-title">Annual Return Percentage</div></div>
              <div class="card-body" style="height:200px"><canvas id="annualReturnChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div class="card-header" style="padding:18px 22px; display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:800">Settings & Backup</div>
          <button id="closeSettings" class="closeModal btn-outline" data-modal-id="settingsModal">Close</button>
        </div>
        <div class="modal-pad">
          <div style="display:flex;gap:18px;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
              <div class="card" style="padding:12px">
                <div class="card-title">Payment methods</div>
                <div id="methodEditor" style="margin-top:10px"></div>
                <div style="display:flex;gap:8px;margin-top:10px">
                  <input id="newMethod" placeholder="New method" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)" />
                  <button id="addMethod" class="btn">Add</button>
                </div>
              </div>
            </div>

            <div style="flex:1;min-width:260px">
              <div class="card" style="padding:12px">
                <div class="card-title">Income sources</div>
                <div id="incomeList" style="margin-top:10px"></div>
                <div style="display:flex;gap:8px;margin-top:10px">
                  <input id="newIncome" placeholder="New income source" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)" />
                  <button id="addIncomeBtn" class="btn">Add</button>
                </div>
              </div>
            </div>

            <div style="flex:1;min-width:260px">
              <div class="card" style="padding:12px">
                <div class="card-title">Expense categories</div>
                <div id="categoryEditor" style="margin-top:10px"></div>
                <div style="display:flex;gap:8px;margin-top:10px">
                  <input id="newCategory" placeholder="New category" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)" />
                  <button id="addCategoryBtn" class="btn">Add</button>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:18px;display:flex;gap:12px;align-items:center">
            <label style="font-weight:700">Credit card limit</label>
            <input id="ccLimitInput" type="number" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:160px" />
            <button id="saveCCLimit" class="btn-primary">Save</button>
            <button id="resetBtn" class="btn-danger">Reset all data</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div class="card-title">Import data</div>
          <button id="closeImport" class="closeModal btn-outline" data-modal-id="importModal">Close</button>
        </div>
        <div class="modal-pad">
          <div style="display:flex;gap:12px;align-items:center">
            <input id="importFile" type="file" accept=".csv,.json" />
            <button id="processImportBtn" class="btn-primary">Import</button>
          </div>
          <div style="margin-top:12px;color:var(--text-muted)">Supported formats: CSV (headers: id,type,amount,date,desc,category,method,investmentGroup,investmentSub,insuranceType,insuranceFor,subcategory) or JSON array of objects.</div>
        </div>
      </div>
    </div>

    <!-- Market settings modal -->
    <div id="marketSettingsModal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div class="card-title">Market ticker settings</div>
          <button class="closeModal btn-outline" data-modal-id="marketSettingsModal">Close</button>
        </div>
        <div class="modal-pad">
          <form id="addMarketForm" style="display:flex;gap:8px;align-items:center">
            <select id="majorIndexSelect" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
              <option value="">Choose index</option>
              <option value="NIFTY_50|Nifty 50">NIFTY 50</option>
              <option value="NASDAQ|Nasdaq">NASDAQ</option>
              <option value="SPX|S&P 500">S&P 500</option>
            </select>
            <button class="btn-primary" type="submit">Add</button>
          </form>

          <div style="margin-top:12px">
            <ul id="marketList" style="list-style:none;padding:0;margin:0;display:grid;gap:8px"></ul>
          </div>
        </div>
      </div>
    </div>
  `;
  // Wire close modal buttons
  document.querySelectorAll('.closeModal').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.dataset.modalId;
      const modal = document.getElementById(id);
      if (modal) modal.classList.remove('open');
    });
  });
})();

/* ---------- CHARTS: main chart, donut, investment charts ---------- */
let mainChart = null;
let donutChart = null;
let cumulativeGrowthChart = null;
let assetDistributionChart = null;
let annualReturnChart = null;
let investmentTreeMap = null;

function renderCharts() {
  try {
    // Main chart: Cash flow & investments
    const filter = document.getElementById('mainChartFilter')?.value || '6';
    const months = filter === 'all' ? 12 : Number(filter);
    const now = new Date();
    const labels = [];
    for (let i = months - 1; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      labels.push(d.toLocaleString('en-IN', { month: 'short', year: '2-digit' }));
    }

    // Aggregate monthly sums
    const incomeSeries = labels.map(() => 0);
    const expenseSeries = labels.map(() => 0);
    const investSeries = labels.map(() => 0);
    const netSeries = labels.map(() => 0);

    data.forEach(tx => {
      if (!tx.date) return;
      const d = new Date(tx.date);
      const label = d.toLocaleString('en-IN', { month: 'short', year: '2-digit' });
      const idx = labels.indexOf(label);
      if (idx === -1) return;
      const amt = Number(tx.amount) || 0;
      if (tx.type === 'income') { incomeSeries[idx] += amt; }
      else if (tx.type === 'opening_balance') { /* treat as income for flow */ incomeSeries[idx] += amt; }
      else if (tx.category === 'Investments' || (tx.investmentGroup && tx.investmentGroup !== 'Cash')) { investSeries[idx] += amt; expenseSeries[idx] += 0; }
      else { expenseSeries[idx] += amt; }
    });

    for (let i=0;i<labels.length;i++){
      netSeries[i] = incomeSeries[i] - expenseSeries[i] - investSeries[i];
    }

    const ctx = document.getElementById('mainChart');
    if (mainChart) mainChart.destroy();
    mainChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Income', data: incomeSeries, backgroundColor: '#10b981' },
          { label: 'Expense', data: expenseSeries, backgroundColor: '#ef4444' },
          { label: 'Investment', data: investSeries, backgroundColor: '#2563eb' },
          { label: 'Net', data: netSeries, type: 'line', borderColor: '#075985', backgroundColor: '#07598533', fill: false, tension: 0.3, yAxisID: 'y' }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
          x: { grid: { display: false } }
        },
        plugins: { legend: { position: 'top' } }
      }
    });

    // Donut chart: wallet or expense distribution
    renderWalletUnified(); // will update donutChart

  } catch (err) {
    console.error('renderCharts error', err);
  }
}

function renderWalletUnified() {
  try {
    const mode = document.getElementById('walletMode')?.value || 'wallet';
    const labels = [];
    const values = [];
    if (mode === 'wallet') {
      // Sum by method (cash, bank, wallet)
      const byMethod = {};
      data.forEach(tx => {
        const method = tx.method || (tx.type === 'opening_balance' && tx.investmentGroup === 'Cash' ? tx.investmentSub : 'Unknown');
        byMethod[method] = (byMethod[method] || 0) + (tx.type === 'income' || tx.type === 'opening_balance' ? Number(tx.amount) : 0);
        // subtract expenses from same method
        if (tx.type === 'expense') byMethod[method] = (byMethod[method] || 0) - Number(tx.amount);
      });
      Object.entries(byMethod).forEach(([k,v]) => { labels.push(methodNames[k] || k || 'Other'); values.push(Math.max(0, v)); });
    } else {
      // Expense distribution by category
      const byCat = {};
      data.forEach(tx => {
        if (tx.type !== 'expense') return;
        const cat = tx.category || 'Misc';
        byCat[cat] = (byCat[cat] || 0) + Number(tx.amount);
      });
      Object.entries(byCat).forEach(([k,v]) => { labels.push(k); values.push(v); });
    }

    const colors = getColorPalette(labels.length);
    const ctx = document.getElementById('donutChart');
    if (donutChart) donutChart.destroy();
    donutChart = new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }] },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: { callbacks: { label: (c) => `${c.label}: ${fmt(c.parsed)}` } }
        },
        cutout: '60%'
      }
    });

    // Legend
    const legend = document.getElementById('walletLegend');
    if (legend) {
      legend.innerHTML = labels.map((l,i) => `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="width:12px;height:12px;background:${colors[i]};display:inline-block;border-radius:3px"></span><strong style="min-width:140px">${l}</strong><span style="color:var(--text-muted)">${fmt(values[i])}</span></div>`).join('');
    }
  } catch (err) {
    console.error('renderWalletUnified error', err);
  }
}

/* ---------- INVESTMENT CHARTS (used in analytics modal and breakdown) ---------- */
function drawCumulativeGrowthChart(canvasId, labels, dataSeries) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;
  if (cumulativeGrowthChart) cumulativeGrowthChart.destroy();
  cumulativeGrowthChart = new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Portfolio Value', data: dataSeries, borderColor: '#2563eb', backgroundColor: '#2563eb33', fill: true, tension: 0.25 }] },
    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => fmtNumber(v) } } } }
  });
  return cumulativeGrowthChart;
}
function drawAssetDistributionChart(canvasId, labels, dataSeries) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;
  if (assetDistributionChart) assetDistributionChart.destroy();
  const colors = getColorPalette(labels.length);
  assetDistributionChart = new Chart(ctx.getContext('2d'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data: dataSeries, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }] },
    options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '60%' }
  });
  return assetDistributionChart;
}
function drawAnnualReturnChart(canvasId, labels, dataSeries) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;
  if (annualReturnChart) annualReturnChart.destroy();
  annualReturnChart = new Chart(ctx.getContext('2d'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Annual Return %', data: dataSeries, backgroundColor: '#f59e0b' }] },
    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => v + '%' } } } }
  });
  return annualReturnChart;
}
function drawInvestmentTreeMap(canvasId, items) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;
  if (investmentTreeMap) investmentTreeMap.destroy();
  const max = items.reduce((m,i)=>Math.max(m,i.amount),0) || 1;
  investmentTreeMap = new Chart(ctx.getContext('2d'), {
    type: 'treemap',
    data: {
      datasets: [{
        tree: items.map(i => ({ sub: i.sub, amount: i.amount })),
        key: 'amount',
        groups: ['sub'],
        spacing: 1,
        borderColor: '#fff',
        borderWidth: 1,
        backgroundColor: (ctx) => {
          const v = ctx.dataset.data[ctx.dataIndex].v;
          const intensity = v / max;
          const hue = 210 - Math.round(intensity * 60);
          return `hsl(${hue},70%,${60 - intensity * 20}%)`;
        },
        labels: { display: true, formatter: ctx => ctx.raw._data.sub + '\\n' + fmtNumber(ctx.raw.v), align: 'center', font: { size: 10, weight: '700' } }
      }]
    },
    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });
  return investmentTreeMap;
}

/* ---------- INVESTMENT RENDER HELPERS ---------- */
function applyDateRangeToInvestments(entries, range) {
  if(!range || range === 'all') return entries;
  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - Number(range));
  return entries.filter(e => new Date(e.date) >= cutoff);
}
function rollupMajorBuckets(entries) {
  const byBucket = entries.reduce((acc, curr) => {
    const group = curr.investmentGroup || 'Uncategorized';
    const bucket = MAJOR_BUCKETS[group] || 'Other';
    acc[bucket] = (acc[bucket] || 0) + Number(curr.amount || 0);
    return acc;
  }, {});
  const items = Object.entries(byBucket).map(([bucket, amount]) => ({ bucket, amount }));
  items.sort((a,b) => b.amount - a.amount);
  return items;
}
function rollupSubcategories(entries, selectedBucket) {
  const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g] === selectedBucket);
  const filtered = entries.filter(e => groupsInBucket.includes(e.investmentGroup));
  const bySub = filtered.reduce((acc, curr) => {
    const sub = curr.investmentSub || 'General';
    acc[sub] = (acc[sub] || 0) + Number(curr.amount || 0);
    return acc;
  }, {});
  const items = Object.entries(bySub).map(([sub, amount]) => ({ sub, amount })).sort((a,b) => b.amount - a.amount);
  return items;
}

/* ---------- RENDER INVESTMENT KPI CHARTS (analytics modal & breakdown) ---------- */
function renderInvestmentKPICharts() {
  try {
    const rawInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
    const range = document.getElementById('invDateRange')?.value || 'all';
    const viewMode = document.getElementById('invViewMode')?.value || 'top4';
    const selectedBucket = document.getElementById('invBucketFilter')?.value || '';
    const entries = applyDateRangeToInvestments(rawInvestments, range);

    let labels = [], values = [];
    if(viewMode === 'subcats' && selectedBucket) {
      const items = rollupSubcategories(entries, selectedBucket);
      labels = items.map(i => i.sub);
      values = items.map(i => i.amount);
      document.getElementById('invBarTitle').innerText = `Subcategory amounts (${selectedBucket})`;
      document.getElementById('invPieTitle').innerText = `Share by subcategory (${selectedBucket})`;
    } else {
      const items = rollupMajorBuckets(entries);
      const top4 = items.slice(0, 4);
      labels = top4.map(i => i.bucket);
      values = top4.map(i => i.amount);
      document.getElementById('invBarTitle').innerText = 'Investment by major bucket (Top 4)';
      document.getElementById('invPieTitle').innerText = 'Share by bucket (Top 4)';
    }

    // Bar
    if (invBreakdownBarChart) invBreakdownBarChart.destroy();
    const barCtx = document.getElementById('invBreakdownBar');
    if (barCtx) {
      invBreakdownBarChart = new Chart(barCtx.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Historical cost', data: values, backgroundColor: getColorPalette(values.length).map(c=>c+'cc'), borderColor: getColorPalette(values.length), borderWidth: 1.5, borderRadius: 6 }] },
        options: { maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{callbacks:{label:c=>fmtNumber(c.parsed.y)}}}, scales:{y:{beginAtZero:true}, x:{grid:{display:false}}} }
      });
    }

    // Pie
    if (invBreakdownPieChart) invBreakdownPieChart.destroy();
    const pieCtx = document.getElementById('invBreakdownPie');
    if (pieCtx) {
      invBreakdownPieChart = new Chart(pieCtx.getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: getColorPalette(values.length), borderColor:'#fff', borderWidth:2 }] },
        options: { maintainAspectRatio:false, plugins:{legend:{position:'right'}, tooltip:{callbacks:{label:c=>`${c.label}: ${fmtNumber(c.parsed)} (${((c.parsed/values.reduce((a,b)=>a+b,0))*100||0).toFixed(1)}%)`}}}, cutout:'60%' }
      });
    }

    // Quick subs
    renderQuickSubDropdowns(entries);

    // Analytics charts
    const cg = calculateCumulativeGrowth(entries);
    drawCumulativeGrowthChart('cumulativeGrowthChart', cg.labels, cg.data);
    const assetData = rollupMajorBuckets(entries);
    drawAssetDistributionChart('assetDistributionChart', assetData.map(a=>a.bucket), assetData.map(a=>a.amount));
    drawAnnualReturnChart('annualReturnChart', ['2023','2024','2025'], [8,10,12]);
    const treemapBucket = selectedBucket || (Object.keys(MAJOR_BUCKETS).map(k => MAJOR_BUCKETS[k])[0] || 'Mutual Funds');
    const treemapData = rollupSubcategories(entries, treemapBucket);
    drawInvestmentTreeMap('investmentTreeMap', treemapData);
  } catch (err) {
    console.error('renderInvestmentKPICharts error', err);
  }
}

/* ---------- QUICK SUB DROPDOWNS ---------- */
function renderQuickSubDropdowns(entries){
  const container = document.getElementById('invQuickSubs');
  if(!container) return;
  const order = ['Equity','Debt','ETFs','Mutual Funds','Retirement','Real Estate','Commodities','Crypto','Other'];
  const items = rollupMajorBuckets(entries);
  const totals = Object.fromEntries(items.map(i => [i.bucket, i.amount]));
  const blocks = items.map(item => {
    const bucket = item.bucket;
    const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g] === bucket);
    const subsSet = new Set();
    groupsInBucket.forEach(g => Object.keys(INVESTMENT_STRUCTURE[g] || {}).forEach(s => subsSet.add(s)));
    const subs = Array.from(subsSet);
    const subValues = subs.map(sub => {
      const sumAmt = entries.filter(d =>
        (((d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'))) &&
        groupsInBucket.includes(d.investmentGroup) && d.investmentSub === sub
      ).reduce((acc,c) => acc + Number(c.amount || 0), 0);
      return {sub, amount: sumAmt};
    }).filter(x => x.amount > 0).sort((a,b) => b.amount - a.amount);
    const dropdownHtml = subValues.length ? subValues.map(x => `
      <div class="sub-dropdown-item">
        <span>${x.sub}</span>
        <strong style="color:var(--primary-dark)">${fmtNumber(x.amount)}</strong>
      </div>
    `).join('') : `<div class="sub-dropdown-item" style="color:#aaa;">No data</div>`;
    return `
      <div class="quick-sub-card">
        <div class="quick-sub-header">
          <div class="quick-sub-title">${bucket}</div>
          <span class="total-badge">${fmtNumber(totals[bucket] || 0)}</span>
        </div>
        <div class="sub-dropdown-container">
          <button class="btn-outline" style="padding:8px 10px;font-size:13px;width:100%;text-align:left" onclick="toggleSubMenu(this)">View subcategories ▾</button>
          <div class="sub-dropdown-menu">${dropdownHtml}</div>
        </div>
      </div>
    `;
  }).join('');
  container.innerHTML = blocks;
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.sub-dropdown-container')) {
      document.querySelectorAll('.sub-dropdown-menu').forEach(m => m.classList.remove('show'));
    }
  });
}
function toggleSubMenu(btn) {
  const currentMenu = btn.parentElement.querySelector('.sub-dropdown-menu');
  document.querySelectorAll('.sub-dropdown-menu').forEach(m => { if (m !== currentMenu) m.classList.remove('show'); });
  currentMenu.classList.toggle('show');
}

/* ---------- CALCULATE CUMULATIVE GROWTH ---------- */
function calculateCumulativeGrowth(entries) {
  const entriesByDate = entries.filter(e => e.date).sort((a, b) => new Date(a.date) - new Date(b.date));
  let cumulativeCost = 0;
  const balances = {};
  entriesByDate.forEach(entry => {
    const dateKey = entry.date.split('T')[0];
    cumulativeCost += Number(entry.amount || 0);
    balances[dateKey] = cumulativeCost;
  });
  const labels = Object.keys(balances).sort();
  const dataPoints = labels.map(key => balances[key]);
  return { labels, data: dataPoints, totalInvestment: cumulativeCost, currentValue: cumulativeCost, cagr:0, xirr:0 };
}

/* ---------- RECENT ENTRIES TABLE ---------- */
function getBadge(entry) {
  if (!entry) return '';
  if (entry.type === 'income') return '<span class="badge badge-income">Income</span>';
  if (entry.type === 'opening_balance') return '<span class="badge badge-opening">Opening</span>';
  if (entry.category === 'Investments') return '<span class="badge badge-inv">Invest</span>';
  if (entry.category === 'Insurance') return '<span class="badge badge-ins">Insure</span>';
  if (entry.category === 'Credit Card Payment') return '<span class="badge badge-cc">CC Pay</span>';
  return '<span class="badge badge-expense">Expense</span>';
}
function renderRecentEntries() {
  try {
    const tbody = document.querySelector('#recentTable tbody');
    if (!tbody) return;
    const searchEl = document.getElementById('recentSearch');
    const sortEl = document.getElementById('recentSort');
    const catEl = document.getElementById('recentCategory');
    const limitEl = document.getElementById('entryLimit');
    const searchText = (searchEl ? searchEl.value.toLowerCase() : '').trim();
    const sortMode = sortEl ? sortEl.value : 'dateDesc';
    const categoryFilter = catEl ? catEl.value : '';
    const limit = limitEl && limitEl.value !== 'all' ? Number(limitEl.value) : data.length;

    let filtered = data.filter(e => {
      const desc = (e.desc || '').toLowerCase();
      const cat = (e.category || '').toLowerCase();
      const subcat = (e.subcategory || '').toLowerCase();
      const amt = String(e.amount || 0);
      const matchesSearch = !searchText || desc.includes(searchText) || cat.includes(searchText) || subcat.includes(searchText) || amt.includes(searchText);
      const matchesCat = categoryFilter ? e.category === categoryFilter : true;
      return matchesSearch && matchesCat;
    });

    filtered.sort((a, b) => {
      const dateA = new Date(a.date || 0);
      const dateB = new Date(b.date || 0);
      if (sortMode === 'dateDesc') return dateB - dateA;
      if (sortMode === 'dateAsc') return dateA - dateB;
      if (sortMode === 'amtDesc') return b.amount - a.amount;
      if (sortMode === 'amtAsc') return a.amount - b.amount;
      return 0;
    });

    const slice = filtered.slice(0, limit);
    if (slice.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text-muted)">No transactions found.</td></tr>';
      return;
    }
    tbody.innerHTML = slice.map(e => {
      const amountDisplay = e.type === 'income' || e.type === 'opening_balance'
        ? `<span style="color:var(--success)">+${fmt(e.amount)}</span>`
        : `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;
      let methodDisplay = '';
      if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
        methodDisplay = e.investmentSub || e.investmentGroup;
      } else if (e.type === 'expense' && e.category === 'Investments') {
        methodDisplay = e.investmentSub || e.investmentGroup;
      } else if (e.method === 'credit_card_payment') {
        methodDisplay = 'N/A (Transfer)';
      } else {
        methodDisplay = methodNames[e.method] || e.method || '--';
      }
      const catBase = e.category === 'Investments' ? e.investmentSub :
                      e.category === 'Insurance' ? `${e.insuranceType || ''} ${e.insuranceFor ? '('+e.insuranceFor+')' : ''}` :
                      e.type === 'expense' ? e.category : '--';
      const catWithSub = e.subcategory ? `${catBase} → ${e.subcategory}` : catBase;
      return `
        <tr>
          <td>${getBadge(e)}</td>
          <td>${e.date || '--'}</td>
          <td style="font-weight:600;text-align:right">${amountDisplay}</td>
          <td>${e.desc || ''}</td>
          <td>${catWithSub}</td>
          <td>${methodDisplay}</td>
          <td class="flex-row" style="justify-content:flex-end">
            <button onclick="loadEdit('${e.id}')" style="background:none;border:none;color:var(--primary);cursor:pointer;padding:6px" title="Edit">✎</button>
            <button onclick="deleteEntry('${e.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:6px" title="Delete">×</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (err) {
    console.error("Error rendering table:", err);
  }
}

/* ---------- SETTINGS RENDER ---------- */
function renderSettings() {
  const methodContainer = document.getElementById('methodEditor');
  if (methodContainer) {
    methodContainer.innerHTML = Object.entries(methodNames).map(([key, name]) => `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:8px;background:#fff;border:1px solid var(--border);border-radius:8px">
        <input type="text" value="${name}" data-key="${key}" onchange="updateMethodName(this)" style="flex:1;margin-right:10px;border:none;background:transparent;font-weight:600" />
        <button class="btn-danger" style="padding:6px 8px;font-size:12px" onclick="deleteMethod('${key}')">Remove</button>
      </div>
    `).join('');
  }

  const incomeContainer = document.getElementById('incomeList');
  if (incomeContainer) {
    incomeContainer.innerHTML = incomeSources.map(source => `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="background:#fbfdff;border:1px solid var(--border);padding:6px 10px;border-radius:8px">${source}</span>
        <button style="background:none;border:none;color:var(--danger);cursor:pointer;font-weight:700" onclick="deleteIncome('${source}')">×</button>
      </div>
    `).join('');
  }

  renderCategoryEditor();
  const ccInput = document.getElementById('ccLimitInput');
  if (ccInput) ccInput.value = settings.ccLimit || DEFAULT_CC_LIMIT;
}
function renderCategoryEditor() {
  const container = document.getElementById('categoryEditor');
  if (!container) return;
  const cats = settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES;
  container.innerHTML = cats.map(cat => `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:8px;background:#fbfdff;border:1px solid var(--border);border-radius:8px">
      <span>${cat}</span>
      <button class="btn-danger" style="padding:6px 8px;font-size:12px" onclick="deleteCategory('${cat}')">Remove</button>
    </div>
  `).join('');
}

/* ---------- SETTINGS ACTIONS ---------- */
function updateMethodName(el) {
  const key = el.dataset.key;
  const newName = el.value.trim();
  if (newName && key) { methodNames[key] = newName; saveAll(); renderAll(); }
}
function deleteMethod(key) {
  if (confirm(`Remove "${methodNames[key]}"?`)) { delete methodNames[key]; saveAll(); renderAll(); }
}
function addMethod() {
  const input = document.getElementById('newMethod');
  const name = input.value.trim();
  if (name) {
    const key = toKey(name);
    if (!methodNames[key]) {
      methodNames[key] = name;
      input.value = '';
      saveAll();
      renderAll();
    } else { alert('Method already exists.'); }
  }
}
function deleteIncome(source) {
  if (confirm(`Remove income source "${source}"?`)) {
    incomeSources = incomeSources.filter(s => s !== source);
    saveAll();
    renderAll();
  }
}
function addIncome() {
  const input = document.getElementById('newIncome');
  const source = input.value.trim();
  if (source && !incomeSources.includes(source)) {
    incomeSources.push(source);
    input.value = '';
    saveAll();
    renderAll();
  } else if (source) { alert('Income source already exists.'); }
}
function deleteCategory(cat) {
  if (PROTECTED_CATS.includes(cat)) {
    alert(`"${cat}" is a protected category and cannot be removed.`);
    return;
  }
  if (confirm(`Remove category "${cat}"?`)) {
    settings.expenseCategories = (settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES).filter(c => c !== cat);
    saveAll();
    renderAll();
  }
}
function addCategory() {
  const input = document.getElementById('newCategory');
  const cat = (input.value || '').trim();
  if (!cat) return;
  const exists = (settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES).includes(cat);
  if (exists) { alert('Category already exists.'); return; }
  settings.expenseCategories = [...(settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES), cat];
  input.value = '';
  saveAll();
  renderAll();
}

/* ---------- IMPORT / EXPORT ---------- */
function convertToCSV(dataArr) {
  const headers = ['id','type','amount','date','desc','category','method','incomeSource','investmentGroup','investmentSub','insuranceType','insuranceFor','subcategory'];
  const rows = dataArr.map(obj => headers.map(header => {
    let value = obj[header] ?? '';
    if (typeof value === 'string' && value.includes(',')) { return `"${value.replace(/"/g, '""')}"`; }
    return value;
  }).join(','));
  const csvContent = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'MoneyMirror_Export.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    alert('Export not supported in this browser.');
  }
}
function parseCSV(csvText) {
  const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
  if (lines.length < 2) return [];
  const headerLine = lines[0];
  const headers = headerLine.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h => h.replace(/"/g, '').trim());
  const lowerHeaders = headers.map(h => h.toLowerCase());
  const dataRows = [];
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
    if (!values) continue;
    const entry = {};
    for (let j = 0; j < lowerHeaders.length; j++) {
      const raw = values[j] || '';
      const value = raw.replace(/^"|"$/g, '').replace(/""/g, '"');
      entry[lowerHeaders[j]] = value;
    }
    dataRows.push({
      id: entry.id,
      type: entry.type,
      amount: entry.amount,
      date: entry.date,
      desc: entry.desc || entry.description || '',
      category: entry.category,
      method: entry.method,
      incomeSource: entry.incomesource || entry.income_source,
      investmentGroup: entry.investmentgroup || entry.investment_group,
      investmentSub: entry.investmentsub || entry.investment_sub,
      insuranceType: entry.insurancetype || entry.insurance_type,
      insuranceFor: entry.insurancefor || entry.insurance_for,
      subcategory: entry.subcategory || ''
    });
  }
  return dataRows;
}
function processImportedData() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file) return alert('Please select a file.');
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    let importedData = [];
    try {
      if (file.name.toLowerCase().endsWith('.json')) {
        importedData = JSON.parse(content);
      } else if (file.name.toLowerCase().endsWith('.csv')) {
        importedData = parseCSV(content);
      } else {
        return alert('Unsupported file type. Use CSV or JSON.');
      }
    } catch (err) {
      return alert('Failed to parse file: ' + err.message);
    }
    if (!Array.isArray(importedData) || importedData.length === 0) return alert('No valid data found.');
    let newEntries = 0;
    importedData.forEach(item => {
      const typeRaw = String(item.type || '').toLowerCase();
      const validType = ['income','expense','opening_balance'].includes(typeRaw) ? typeRaw : 'expense';
      const amt = Number(item.amount);
      const desc = item.desc || item.description || '';
      if (!amt || amt <= 0) return;
      const entry = {
        id: item.id || uid(),
        type: validType,
        amount: amt,
        date: item.date || new Date().toISOString().slice(0, 10),
        desc,
        category: item.category || (validType === 'income' ? 'N/A' : 'Misc'),
        method: item.method ? toKey(item.method) : (validType === 'income' ? 'salary_acct' : 'cash'),
        incomeSource: item.incomeSource || item.income_source || '',
        investmentGroup: item.investmentGroup || item.investment_group || '',
        investmentSub: item.investmentSub || item.investment_sub || '',
        insuranceType: item.insuranceType || item.insurance_type || '',
        insuranceFor: item.insuranceFor || item.insurance_for || '',
        subcategory: item.subcategory || ''
      };
      data.push(entry);
      newEntries++;
    });
    saveAll();
    renderAll();
    document.getElementById('importModal').classList.remove('open');
    alert(`Imported ${newEntries} entries.`);
  };
  reader.readAsText(file);
}

/* ---------- FORM: add/edit entries ---------- */
function updateTransactionFormFields() {
  const type = document.getElementById('type').value;
  const invRow = document.getElementById('investmentRow');
  const incomeRow = document.getElementById('incomeSourceRow');
  const openingRow = document.getElementById('openingBalanceRow');
  const subcatRow = document.getElementById('subcategoryContainer');

  if (type === 'income') {
    incomeRow.style.display = 'block';
    invRow.style.display = 'none';
    openingRow.style.display = 'none';
    subcatRow.style.display = 'none';
  } else if (type === 'opening_balance') {
    openingRow.style.display = 'block';
    invRow.style.display = 'none';
    incomeRow.style.display = 'none';
    subcatRow.style.display = 'none';
  } else if (type === 'expense') {
    incomeRow.style.display = 'none';
    invRow.style.display = 'none';
    openingRow.style.display = 'none';
    subcatRow.style.display = 'block';
  } else {
    incomeRow.style.display = 'none';
    invRow.style.display = 'none';
    openingRow.style.display = 'none';
    subcatRow.style.display = 'none';
  }
}

function populateInvestmentGroupDropdowns() {
  const invGroup = document.getElementById('invGroup');
  const openingGroup = document.getElementById('openingGroup');
  if (!invGroup || !openingGroup) return;
  invGroup.innerHTML = '<option value="">Select...</option>' + Object.keys(INVESTMENT_STRUCTURE).map(g => `<option value="${g}">${g}</option>`).join('');
  openingGroup.innerHTML = '<option value="">Select...</option>' + Object.keys(INVESTMENT_STRUCTURE).map(g => `<option value="${g}">${g}</option>`).join('');
  updateInvestmentSubDropdown(invGroup, document.getElementById('invSub'));
  updateInvestmentSubDropdown(openingGroup, document.getElementById('openingSub'));
}

function updateInvestmentSubDropdown(groupEl, subEl) {
  if (!groupEl || !subEl) return;
  const group = groupEl.value;
  let options = '<option value="">Select...</option>';
  if (group && INVESTMENT_STRUCTURE[group]) {
    options += Object.keys(INVESTMENT_STRUCTURE[group]).map(s => `<option value="${s}">${s}</option>`).join('');
  }
  subEl.innerHTML = options;
}

/* ---------- FORM SUBMIT / EDIT / DELETE ---------- */
function submitForm(existingEntry) {
  try {
    const type = document.getElementById('type').value;
    const amount = Number(document.getElementById('amount').value) || 0;
    const date = document.getElementById('date').value || nowDateISO();
    const desc = document.getElementById('desc').value || '';
    const category = document.getElementById('category').value || (type === 'income' ? 'N/A' : 'Misc');
    const subcategory = document.getElementById('subcategory').value || '';
    const method = document.getElementById('method').value || '';
    const incomeSource = document.getElementById('incomeSource') ? document.getElementById('incomeSource').value : '';
    const invGroup = document.getElementById('invGroup') ? document.getElementById('invGroup').value : '';
    const invSub = document.getElementById('invSub') ? document.getElementById('invSub').value : '';
    const openingType = document.getElementById('openingType') ? document.getElementById('openingType').value : '';
    const openingGroup = document.getElementById('openingGroup') ? document.getElementById('openingGroup').value : '';
    const openingSub = document.getElementById('openingSub') ? document.getElementById('openingSub').value : '';

    if (!amount || amount <= 0) { alert('Enter a valid amount'); return; }

    if (existingEntry) {
      existingEntry.type = type;
      existingEntry.amount = amount;
      existingEntry.date = date;
      existingEntry.desc = desc;
      existingEntry.category = category;
      existingEntry.subcategory = subcategory;
      existingEntry.method = method;
      existingEntry.incomeSource = incomeSource;
      existingEntry.investmentGroup = invGroup;
      existingEntry.investmentSub = invSub;
      existingEntry.openingType = openingType;
      existingEntry.openingGroup = openingGroup;
      existingEntry.openingSub = openingSub;
    } else {
      const entry = {
        id: uid(),
        type,
        amount,
        date,
        desc,
        category,
        subcategory,
        method,
        incomeSource,
        investmentGroup: invGroup,
        investmentSub: invSub,
        openingType,
        openingGroup,
        openingSub
      };
      data.push(entry);
    }
    saveAll();
    renderAll();
    clearForm();
    editId = null;
    document.getElementById('addBtn').style.display = 'inline-block';
    document.getElementById('saveBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
  } catch (err) {
    console.error('submitForm error', err);
  }
}

function loadEdit(id) {
  const entry = data.find(d => d.id === id);
  if (!entry) return;
  editId = id;
  document.getElementById('addBtn').style.display = 'none';
  document.getElementById('saveBtn').style.display = 'inline-block';
  document.getElementById('cancelBtn').style.display = 'inline-block';

  document.getElementById('type').value = entry.type || 'expense';
  document.getElementById('amount').value = entry.amount || '';
  document.getElementById('date').value = entry.date || nowDateISO();
  document.getElementById('desc').value = entry.desc || '';
  document.getElementById('category').value = entry.category || '';
  document.getElementById('subcategory').value = entry.subcategory || '';
  document.getElementById('method').value = entry.method || '';
  if (entry.incomeSource && document.getElementById('incomeSource')) document.getElementById('incomeSource').value = entry.incomeSource;
  if (entry.investmentGroup && document.getElementById('invGroup')) {
    document.getElementById('invGroup').value = entry.investmentGroup;
    updateInvestmentSubDropdown(document.getElementById('invGroup'), document.getElementById('invSub'));
    document.getElementById('invSub').value = entry.investmentSub || '';
  }
  updateTransactionFormFields();
}

function deleteEntry(id) {
  if (!confirm('Delete this entry?')) return;
  data = data.filter(d => d.id !== id);
  saveAll();
  renderAll();
}

/* ---------- FORM CLEAR ---------- */
function clearForm() {
  document.getElementById('type').value = 'expense';
  document.getElementById('amount').value = '';
  document.getElementById('date').value = nowDateISO();
  document.getElementById('desc').value = '';
  document.getElementById('category').value = settings.expenseCategories[0] || '';
  document.getElementById('subcategory').value = '';
  document.getElementById('method').value = Object.keys(methodNames)[0] || '';
  if (document.getElementById('incomeSource')) document.getElementById('incomeSource').value = incomeSources[0] || '';
  if (document.getElementById('invGroup')) document.getElementById('invGroup').value = '';
  if (document.getElementById('invSub')) document.getElementById('invSub').innerHTML = '<option value="">Select...</option>';
  updateTransactionFormFields();
}

/* ---------- EXPENSE MULTISELECT (for wallet filters) ---------- */
function setupExpenseMultiSelect() {
  // Create a simple multiselect dropdown for categories (used in some UI flows)
  const recentCategory = document.getElementById('recentCategory');
  if (!recentCategory) return;
  recentCategory.innerHTML = '<option value="">All Cats</option>' + (settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES).map(c => `<option value="${c}">${c}</option>`).join('');
}

/* ---------- MARKET TICKER FETCH LOOP (already in part1) ---------- */
/* fetchRealMarketData, startTickerRealtimeLoop implemented in part1 */

/* ---------- RENDER KPIs & CHARTS (full renderAll) ---------- */
function renderKPIs() {
  try {
    // Income / Expense / Net / Invest totals (monthly)
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthlyIncome = data.filter(d => (d.type === 'income' || d.type === 'opening_balance') && new Date(d.date) >= monthStart).reduce((a,b)=>a+Number(b.amount||0),0);
    const monthlyExpense = data.filter(d => d.type === 'expense' && new Date(d.date) >= monthStart && d.category !== 'Investments').reduce((a,b)=>a+Number(b.amount||0),0);
    const monthlyInvest = data.filter(d => (d.category === 'Investments' || (d.type === 'expense' && d.investmentGroup))).reduce((a,b)=>a+Number(b.amount||0),0);
    const netLiquidity = data.filter(d => d.type === 'opening_balance' || d.type === 'income').reduce((a,b)=>a+Number(b.amount||0),0) - data.filter(d => d.type === 'expense').reduce((a,b)=>a+Number(b.amount||0),0);

    document.getElementById('kpiIncome').innerText = fmt(monthlyIncome);
    document.getElementById('kpiExpense').innerText = fmt(monthlyExpense);
    document.getElementById('kpiInvest').innerText = fmt(data.filter(d => d.category === 'Investments' || (d.investmentGroup && d.investmentGroup !== 'Cash')).reduce((a,b)=>a+Number(b.amount||0),0));
    document.getElementById('kpiNet').innerText = fmt(netLiquidity);

    // CC due
    const ccDue = data.filter(d => d.method === 'credit_card' || d.category === 'Credit Card Payment').reduce((a,b)=>a+Number(b.amount||0),0);
    document.getElementById('kpiCCDue').innerText = fmt(ccDue);
    const ccLimit = settings.ccLimit || DEFAULT_CC_LIMIT;
    const usedPct = ccLimit ? Math.round((ccDue / ccLimit) * 100) : 0;
    document.getElementById('ccSliderFill').style.width = Math.min(100, usedPct) + '%';
    document.getElementById('ccSliderPercent').innerText = usedPct + '%';
    document.getElementById('ccLimitDisplay').innerText = fmt(ccLimit);
    if (usedPct > 80) {
      document.getElementById('ccAlert').classList.remove('hidden');
      document.getElementById('ccAlert').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
    } else {
      document.getElementById('ccAlert').classList.add('hidden');
    }

    // Net liquidity breakdown
    const breakdown = {};
    data.forEach(d => {
      const key = (d.method && methodNames[d.method]) || (d.investmentSub) || (d.investmentGroup) || 'Other';
      breakdown[key] = (breakdown[key] || 0) + (d.type === 'income' || d.type === 'opening_balance' ? Number(d.amount||0) : -Number(d.amount||0));
    });
    const list = document.getElementById('netLiquidityBreakdown');
    if (list) {
      list.innerHTML = Object.entries(breakdown).map(([k,v]) => `<div><span>${k}</span><span>${fmtNumber(Math.max(0, Math.round(v)))}</span></div>`).join('');
    }
  } catch (err) {
    console.error('renderKPIs error', err);
  }
}

function renderAll() {
  try {
    // Ensure defaults
    if (!Array.isArray(data)) data = [];
    if (!methodNames || Object.keys(methodNames).length === 0) methodNames = { ...methodNamesDefault };
    if (!incomeSources) incomeSources = ['Salary','Freelance','Interest'];
    if (!settings) settings = { ...DEFAULT_SETTINGS };

    // Sort data
    data.sort((a,b) => new Date(b.date) - new Date(a.date));

    // Populate dropdowns
    const categoryEl = document.getElementById('category');
    if (categoryEl) categoryEl.innerHTML = (settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES).map(c => `<option value="${c}">${c}</option>`).join('');
    const methodEl = document.getElementById('method');
    if (methodEl) methodEl.innerHTML = Object.entries(methodNames).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
    const incomeEl = document.getElementById('incomeSource');
    if (incomeEl) incomeEl.innerHTML = (incomeSources || []).map(s => `<option value="${s}">${s}</option>`).join('');
    const recentCat = document.getElementById('recentCategory');
    if (recentCat) recentCat.innerHTML = '<option value="">All Cats</option>' + (settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES).map(c => `<option value="${c}">${c}</option>`).join('');

    // Render KPIs, charts, tables
    renderKPIs();
    renderCharts();
    renderRecentEntries();
    renderSettings();
    renderInvestmentKPICharts();
    renderMarketList();
    renderMarketTicker();
  } catch (err) {
    console.error('renderAll error', err);
  }
}

/* ---------- BOOTSTRAP: wire modal open/close and analytics modal events ---------- */
(function wireModalsAndEvents(){
  document.querySelectorAll('.openModal').forEach(el => {
    el.addEventListener('click', (e) => {
      e.preventDefault();
      const id = el.dataset.modalId;
      const modal = document.getElementById(id);
      if (modal) {
        modal.classList.add('open');
        // special actions
        if (id === 'analyticsModal') {
          populateAnalyticsDropdowns();
          updateAnlSubDropdown();
          renderInvestmentKPICharts();
        }
        if (id === 'marketSettingsModal') renderMarketList();
      }
    });
  });
  document.querySelectorAll('.closeModal').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.dataset.modalId;
      const modal = document.getElementById(id);
      if (modal) modal.classList.remove('open');
    });
  });

  // Analytics modal close wired in injectModals
  document.getElementById('drilldownBtn')?.addEventListener('click', () => {
    // Example drilldown: switch invBreakdownPanel visible and set view to subcats
    document.getElementById('invBreakdownPanel').classList.remove('hidden');
    document.getElementById('invViewMode').value = 'subcats';
    const bucketSelect = document.getElementById('invBucketFilter');
    if (bucketSelect && !bucketSelect.value) bucketSelect.value = bucketSelect.options[1]?.value || '';
    renderInvestmentKPICharts();
  });

  // Import modal process
  document.getElementById('processImportBtn')?.addEventListener('click', processImportedData);

  // Settings modal actions
  document.getElementById('addMethod')?.addEventListener('click', () => { addMethod(); renderSettings(); });
  document.getElementById('addIncomeBtn')?.addEventListener('click', () => { addIncome(); renderSettings(); });
  document.getElementById('addCategoryBtn')?.addEventListener('click', () => { addCategory(); renderSettings(); });
  document.getElementById('saveCCLimit')?.addEventListener('click', () => {
    const val = Number(document.getElementById('ccLimitInput').value) || DEFAULT_CC_LIMIT;
    settings.ccLimit = val;
    saveAll();
    renderAll();
    alert('Credit card limit saved.');
  });

  // Analytics dropdowns
  document.getElementById('anlInvGroup')?.addEventListener('change', updateAnlSubDropdown);
  document.getElementById('anlDateRange')?.addEventListener('change', renderInvestmentKPICharts);
  document.getElementById('anlChartType')?.addEventListener('change', renderInvestmentKPICharts);

  // Investment breakdown toggles
  document.getElementById('toggleInvBreakdown')?.addEventListener('click', () => {
    document.getElementById('invBreakdownPanel').classList.toggle('hidden');
  });
  document.getElementById('viewCategoriesBtn')?.addEventListener('click', () => {
    document.getElementById('invBreakdownPanel').classList.remove('hidden');
    document.getElementById('invViewMode').value = 'subcats';
    const bucketSelect = document.getElementById('invBucketFilter');
    if (bucketSelect && !bucketSelect.value) bucketSelect.value = bucketSelect.options[1]?.value || '';
    renderInvestmentKPICharts();
  });

  // inv filters
  document.getElementById('invViewMode')?.addEventListener('change', renderInvestmentKPICharts);
  document.getElementById('invBucketFilter')?.addEventListener('change', renderInvestmentKPICharts);
  document.getElementById('invDateRange')?.addEventListener('change', renderInvestmentKPICharts);

  // Wallet mode
  document.getElementById('walletMode')?.addEventListener('change', renderWalletUnified);

  // Ensure calculator buttons wired
  document.querySelectorAll('#calc-buttons button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      handleCalculatorInput(e);
    });
  });
})();

/* ---------- ANALYTICS DROPDOWNS ---------- */
function populateAnalyticsDropdowns() {
  const groupSelect = document.getElementById('anlInvGroup');
  if (!groupSelect) return;
  const options = Object.keys(INVESTMENT_STRUCTURE).map(group => `<option value="${group}">${group}</option>`).join('');
  groupSelect.innerHTML = '<option value="">All Groups</option>' + options;
}
function updateAnlSubDropdown() {
  const group = document.getElementById('anlInvGroup').value;
  const subSelect = document.getElementById('anlInvSub');
  if (!subSelect) return;
  let options = '<option value="">All Types</option>';
  if(group && INVESTMENT_STRUCTURE[group]) {
    options += Object.keys(INVESTMENT_STRUCTURE[group]).map(sub => `<option value="${sub}">${sub}</option>`).join('');
  }
  subSelect.innerHTML = options;
}

/* ---------- FINAL EXPOSURES ---------- */
window.loadEdit = loadEdit;
window.deleteEntry = deleteEntry;
window.toggleSubMenu = toggleSubMenu;
window.resetExpenseDrilldown = function(){ document.getElementById('invViewMode').value = 'top4'; renderInvestmentKPICharts(); };
window.removeMarket = function(index){ settings.trackedMarkets.splice(index,1); saveAll(); renderMarketList(); renderMarketTicker(); };
window.deleteCategory = deleteCategory;
window.addMethod = addMethod;
window.addIncome = addIncome;

/* ---------- INITIAL RENDER (ensure UI is consistent) ---------- */
setTimeout(() => {
  try {
    populateInvestmentGroupDropdowns();
    setupExpenseMultiSelect();
    renderAll();
    // Hide auth gate if last profile is guest
    const lastProfile = localStorage.getItem('mm_last_profile');
    if (lastProfile === 'Guest') hideAuthGate();
  } catch (e) { console.error('initial render error', e); }
}, 120);
</script>

<!-- BEGIN Part 3: Remaining utilities, market ticker, calculator, final bindings (complete) -->
<script>
/* ---------- PART 3: Remaining implementations ---------- */

/* Chart placeholders used earlier */
let invBreakdownBarChart = null;
let invBreakdownPieChart = null;

/* ---------- MARKET TICKER / MARKET LIST ---------- */
/*
  fetchRealMarketData: Simulates or fetches market data for trackedMarkets.
  In environments with network access and a real API, replace the simulation with real fetch calls.
*/
async function fetchRealMarketData() {
  // If trackedMarkets is empty, ensure default
  settings.trackedMarkets = settings.trackedMarkets || [];
  // Simulate small random price movements for demo/offline mode
  settings.trackedMarkets = settings.trackedMarkets.map(m => {
    const drift = (Math.random() - 0.5) * 2; // -1..1
    const changePct = (m.change || 0) + parseFloat((drift * 0.3).toFixed(2));
    const price = Math.max(0.01, (Number(m.price || 1000) * (1 + changePct / 100)));
    return Object.assign({}, m, { price: Math.round(price * 100) / 100, change: Math.round(changePct * 100) / 100 });
  });
  // Save simulated values locally
  saveLocal();
  return settings.trackedMarkets;
}

function renderMarketList() {
  const listEl = document.getElementById('marketList');
  if (!listEl) return;
  listEl.innerHTML = '';
  (settings.trackedMarkets || []).forEach((m, idx) => {
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    li.style.padding = '8px';
    li.style.border = '1px solid var(--border)';
    li.style.borderRadius = '8px';
    li.style.background = '#fff';
    li.style.marginBottom = '8px';
    li.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:700">${m.symbol}</div>
        <div style="color:var(--text-muted);font-size:13px">${m.name || ''}</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="text-align:right">
          <div style="font-weight:700">${m.price != null ? m.price : '--'}</div>
          <div style="font-size:12px;color:${(m.change||0) >= 0 ? 'var(--success)' : 'var(--danger)'}">${(m.change||0) >= 0 ? '▲' : '▼'} ${Math.abs(m.change||0)}%</div>
        </div>
        <div>
          <button class="btn-outline" style="padding:6px 8px;margin-right:6px" onclick="removeMarket(${idx})">Remove</button>
        </div>
      </div>
    `;
    listEl.appendChild(li);
  });
}

/* Render the ticker strip at top of dashboard */
function renderMarketTicker() {
  const wrap = document.getElementById('tickerWrap');
  if (!wrap) return;
  wrap.innerHTML = '';
  (settings.trackedMarkets || []).forEach(m => {
    const item = document.createElement('div');
    item.className = 'ticker-item';
    const changeClass = (m.change || 0) >= 0 ? 'change-up' : 'change-down';
    item.innerHTML = `<span class="symbol">${m.symbol}</span> <span style="opacity:.9">${m.price != null ? m.price : '--'}</span> <span class="${changeClass}" style="margin-left:8px">${(m.change||0) >= 0 ? '+' : ''}${m.change}%</span>`;
    wrap.appendChild(item);
  });
  // Restart marquee animation by forcing reflow
  wrap.style.animation = 'none';
  // small timeout to re-enable
  setTimeout(() => { wrap.style.animation = ''; }, 20);
}

/* Add market helper (already used in part1) */
function addIndexToSettings(symbol, name) {
  settings.trackedMarkets = settings.trackedMarkets || [];
  if (!settings.trackedMarkets.some(m => m.symbol === symbol)) {
    settings.trackedMarkets.push({ symbol, name, price: 0, change: 0 });
    saveAll();
    renderMarketList();
    renderMarketTicker();
  }
}

/* Remove market by index (exposed earlier) */
function removeMarket(index) {
  if (!settings.trackedMarkets || !settings.trackedMarkets[index]) return;
  if (!confirm(`Remove ${settings.trackedMarkets[index].symbol} from ticker?`)) return;
  settings.trackedMarkets.splice(index, 1);
  saveAll();
  renderMarketList();
  renderMarketTicker();
}

/* Start a periodic update loop for market data (simulated) */
let marketInterval = null;
function startMarketLoop() {
  // Immediately fetch and render
  fetchRealMarketData().then(() => {
    renderMarketList();
    renderMarketTicker();
  }).catch(e => console.warn('Market fetch failed', e));
  // Clear existing
  if (marketInterval) clearInterval(marketInterval);
  marketInterval = setInterval(async () => {
    try {
      await fetchRealMarketData();
      renderMarketTicker();
      renderMarketList();
    } catch (e) { console.warn('Market loop error', e); }
  }, 15000); // every 15s simulated
}

/* ---------- CALCULATOR HANDLER ---------- */
let calcState = { expr: '', preview: '' };
function handleCalculatorInput(e) {
  const btn = e.currentTarget;
  const val = (btn.textContent || '').trim();
  const display = document.getElementById('calc-display');
  const preview = document.getElementById('calc-preview');
  if (!display || !preview) return;
  if (val === 'AC') {
    calcState.expr = '';
    calcState.preview = 'Enter an expression…';
    display.textContent = '0';
    preview.textContent = calcState.preview;
    return;
  }
  if (val === '±') {
    // toggle sign of last number
    calcState.expr = toggleSign(calcState.expr);
    display.textContent = calcState.expr || '0';
    preview.textContent = calcState.expr || 'Enter an expression…';
    return;
  }
  if (val === '=') {
    try {
      const safe = sanitizeExpression(calcState.expr);
      const result = evaluateExpression(safe);
      display.textContent = String(result);
      preview.textContent = calcState.expr + ' =';
      calcState.expr = String(result);
    } catch (err) {
      display.textContent = 'Error';
      preview.textContent = 'Invalid expression';
      calcState.expr = '';
    }
    return;
  }
  // operators and numbers
  if (['/','*','-','+','%','.'].includes(val) || /^[0-9]$/.test(val)) {
    calcState.expr += val;
    display.textContent = calcState.expr;
    preview.textContent = calcState.expr;
  }
}
function toggleSign(expr) {
  if (!expr) return expr;
  // find last number
  const m = expr.match(/(-?\d+(\.\d+)?)$/);
  if (!m) return expr;
  const num = m[1];
  const start = expr.slice(0, m.index);
  const toggled = num.startsWith('-') ? num.slice(1) : '-' + num;
  return start + toggled;
}
function sanitizeExpression(expr) {
  // Allow only digits, operators, parentheses, decimal point, percent
  if (!expr) return '';
  const allowed = expr.replace(/[^0-9+\-*/().% ]+/g, '');
  return allowed;
}
function evaluateExpression(expr) {
  // Replace % with /100
  const normalized = expr.replace(/%/g, '/100');
  // Very small sandboxed evaluator using Function (still risky in untrusted env)
  // We limit characters to digits and operators above; sanitizeExpression already applied.
  // Use Function to evaluate arithmetic only.
  // eslint-disable-next-line no-new-func
  const fn = new Function(`return (${normalized});`);
  const res = fn();
  if (typeof res !== 'number' || !isFinite(res)) throw new Error('Invalid result');
  return Math.round(res * 100) / 100;
}

/* ---------- SMALL UTILITIES ---------- */
function safeGet(id) { return document.getElementById(id); }

/* ---------- INITIALIZATION & FINAL BINDINGS ---------- */
(function finalInit() {
  try {
    // Start market loop
    startMarketLoop();

    // Wire market add form
    const addMarketForm = document.getElementById('addMarketForm');
    if (addMarketForm) {
      addMarketForm.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const sel = document.getElementById('majorIndexSelect');
        if (!sel) return;
        const val = sel.value;
        if (!val) return alert('Choose an index to add');
        const [symbol, name] = val.split('|');
        addIndexToSettings(symbol, name || symbol);
        sel.value = '';
        renderMarketList();
        renderMarketTicker();
      });
    }

    // Wire import modal close
    document.getElementById('closeImport')?.addEventListener('click', () => {
      document.getElementById('importModal')?.classList.remove('open');
    });

    // Wire settings reset
    document.getElementById('resetBtn')?.addEventListener('click', () => {
      if (!confirm('This will clear all local data for this profile. Continue?')) return;
      data = [];
      methodNames = { cash:'Cash', salary_acct:'Bank Account (Salary)', savings_acct:'Bank Account (Savings)', credit_card:'Credit Card', digital_wallet:'Digital Wallet' };
      incomeSources = ['Salary','Freelance','Interest'];
      settings = Object.assign({}, DEFAULT_SETTINGS);
      saveAll();
      renderAll();
      alert('Data reset complete.');
    });

    // Wire import file process
    document.getElementById('processImportBtn')?.addEventListener('click', processImportedData);

    // Ensure modal close buttons (generic)
    document.querySelectorAll('.modal .closeModal').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.modalId;
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('open');
      });
    });

    // Ensure analytics modal close
    document.querySelectorAll('#analyticsModal .closeModal').forEach(btn => {
      btn.addEventListener('click', () => document.getElementById('analyticsModal')?.classList.remove('open'));
    });

    // Ensure import file input wired
    const importFileEl = document.getElementById('importFile');
    if (importFileEl) {
      importFileEl.addEventListener('change', () => {
        // no-op; file read happens on processImportBtn click
      });
    }

    // Ensure calculator initial state
    calcState.expr = '';
    calcState.preview = 'Enter an expression…';
    const previewEl = document.getElementById('calc-preview');
    if (previewEl) previewEl.textContent = calcState.preview;
    const displayEl = document.getElementById('calc-display');
    if (displayEl) displayEl.textContent = '0';

    // Expose functions for debugging
    window.renderAll = renderAll;
    window.renderCharts = renderCharts;
    window.renderWalletUnified = renderWalletUnified;
    window.renderInvestmentKPICharts = renderInvestmentKPICharts;
    window.renderMarketTicker = renderMarketTicker;
    window.renderMarketList = renderMarketList;
    window.fetchRealMarketData = fetchRealMarketData;
    window.processImportedData = processImportedData;
    window.handleCalculatorInput = handleCalculatorInput;

    // Final render to ensure everything is in sync
    setTimeout(() => {
      try {
        populateInvestmentGroupDropdowns();
        setupExpenseMultiSelect();
        renderAll();
        startMarketLoop();
      } catch (e) {
        console.error('final render error', e);
      }
    }, 120);
  } catch (err) {
    console.error('finalInit error', err);
  }
})();
</script>

<!-- BEGIN Part 4: Final polish, fixes, accessibility, mobile menu, calculator drag, resize handlers, and save-on-exit -->
<script>
/* ---------- PART 4: Final polish & fixes ---------- */

/* Fix: Ensure auth gate visibility logic is consistent across versions.
   Some earlier HTML used class "show" while scripts toggled "hidden".
   Normalize by using 'hidden' class: when hidden -> not visible; when absent -> visible.
*/
(function normalizeAuthGateInitialState() {
  const authGate = document.getElementById('authGate');
  if (!authGate) return;
  // If authGate has class "show" (older markup), remove it and ensure hidden state is consistent.
  if (authGate.classList.contains('show')) {
    authGate.classList.remove('show');
    authGate.classList.remove('hidden');
  }
  // If neither hidden nor open, keep visible by default only if no lastProfile
  const lastProfile = localStorage.getItem('mm_last_profile');
  if (!lastProfile) {
    authGate.classList.remove('hidden');
    document.getElementById('mainContent').style.filter = 'blur(6px)';
  } else if (lastProfile === 'Guest') {
    // If last was guest, hide gate and restore UI
    authGate.classList.add('hidden');
    document.getElementById('mainContent').style.filter = 'none';
    document.getElementById('profileNameDisplay').textContent = 'Guest (Offline)';
    document.getElementById('logoutBtn').style.display = 'block';
    // ensure data loaded
    loadProfileData();
  } else {
    // If a named profile exists, keep gate hidden until auth state resolves (handled earlier)
    authGate.classList.add('hidden');
    document.getElementById('mainContent').style.filter = 'none';
  }
})();

/* ---------- Ensure Guest button reliably starts guest mode ---------- */
(function wireGuestButtonSafely() {
  const guestBtn = document.getElementById('guestBtn');
  if (!guestBtn) return;
  // Remove existing listeners to avoid duplicates
  guestBtn.replaceWith(guestBtn.cloneNode(true));
  const newGuestBtn = document.getElementById('guestBtn');
  newGuestBtn.addEventListener('click', () => {
    try {
      startGuestMode();
      // After starting guest mode, ensure UI is fully rendered and auth gate hidden
      document.getElementById('authGate')?.classList.add('hidden');
      document.getElementById('mainContent').style.filter = 'none';
      // Provide immediate feedback
      setTimeout(() => {
        renderAll();
        startMarketLoop();
      }, 60);
    } catch (err) {
      console.error('Guest start error', err);
      alert('Unable to start Guest mode. Check console for details.');
    }
  });
})();

/* ---------- Mobile sidebar toggle (keeps layout consistent on small screens) ---------- */
(function setupMobileMenuToggle() {
  const mobileBtn = document.getElementById('mobileMenuBtn');
  const aside = document.getElementById('mainSidebar');
  if (!mobileBtn || !aside) return;
  mobileBtn.addEventListener('click', () => {
    aside.classList.toggle('mobile-open');
    // toggle aria-expanded for accessibility
    const expanded = aside.classList.contains('mobile-open');
    mobileBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
  });
  // Close mobile menu when clicking outside on small screens
  document.addEventListener('click', (e) => {
    if (window.innerWidth > 768) return;
    if (!aside.classList.contains('mobile-open')) return;
    if (!e.target.closest('#mainSidebar') && !e.target.closest('#mobileMenuBtn')) {
      aside.classList.remove('mobile-open');
    }
  });
})();

/* ---------- Calculator drag support (desktop) ---------- */
(function makeCalculatorDraggable() {
  const calc = document.getElementById('calculator');
  const header = document.getElementById('calc-header');
  if (!calc || !header) return;
  let dragging = false;
  let offsetX = 0, offsetY = 0;

  header.addEventListener('pointerdown', (e) => {
    dragging = true;
    calc.style.transition = 'none';
    offsetX = e.clientX - calc.getBoundingClientRect().left;
    offsetY = e.clientY - calc.getBoundingClientRect().top;
    header.setPointerCapture(e.pointerId);
  });
  document.addEventListener('pointermove', (e) => {
    if (!dragging) return;
    const left = e.clientX - offsetX;
    const top = e.clientY - offsetY;
    calc.style.left = Math.max(8, Math.min(window.innerWidth - calc.offsetWidth - 8, left)) + 'px';
    calc.style.top = Math.max(8, Math.min(window.innerHeight - calc.offsetHeight - 8, top)) + 'px';
    calc.style.right = 'auto';
    calc.style.bottom = 'auto';
  });
  document.addEventListener('pointerup', () => {
    if (!dragging) return;
    dragging = false;
    calc.style.transition = '';
  });
})();

/* ---------- Window resize: ensure charts resize and layout remains consistent ---------- */
(function wireResizeHandler() {
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      try {
        // Resize charts if they exist
        [mainChart, donutChart, invBreakdownBarChart, invBreakdownPieChart, cumulativeGrowthChart, assetDistributionChart, annualReturnChart, investmentTreeMap].forEach(ch => {
          if (ch && typeof ch.resize === 'function') ch.resize();
        });
      } catch (err) {
        console.warn('Resize error', err);
      }
    }, 150);
  });
})();

/* ---------- Accessibility improvements ---------- */
(function accessibilityImprovements() {
  // Ensure buttons have keyboard focus styles and aria labels where missing
  document.querySelectorAll('button').forEach(btn => {
    if (!btn.hasAttribute('aria-label') && btn.textContent.trim().length === 0) {
      btn.setAttribute('aria-label', 'button');
    }
    btn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        btn.click();
      }
    });
  });

  // Ensure modal openers set focus to first focusable element inside modal
  document.querySelectorAll('.openModal').forEach(op => {
    op.addEventListener('click', () => {
      const id = op.dataset.modalId;
      const modal = document.getElementById(id);
      if (!modal) return;
      setTimeout(() => {
        const focusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (focusable) focusable.focus();
      }, 120);
    });
  });
})();

/* ---------- Save on unload to avoid accidental data loss ---------- */
window.addEventListener('beforeunload', (e) => {
  try {
    saveAll();
  } catch (err) {
    console.warn('Save on unload failed', err);
  }
  // No custom message required; modern browsers ignore it.
});

/* ---------- Small fixes for missing references and defensive guards ---------- */
(function defensiveGuards() {
  // Ensure required DOM elements exist before binding
  const requiredIds = ['addBtn','saveBtn','cancelBtn','type','amount','date','desc','category','method','invGroup','invSub'];
  requiredIds.forEach(id => {
    if (!document.getElementById(id)) {
      // create minimal placeholders to avoid runtime errors in some environments
      const el = document.createElement('input');
      el.type = 'hidden';
      el.id = id;
      document.body.appendChild(el);
    }
  });

  // Ensure methodNames has at least one entry
  if (!methodNames || Object.keys(methodNames).length === 0) {
    methodNames = { ...methodNamesDefault };
  }

  // Ensure settings structure
  settings = settings || {};
  settings.trackedMarkets = settings.trackedMarkets || [];
  settings.expenseCategories = settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES;
  settings.ccLimit = settings.ccLimit || DEFAULT_CC_LIMIT;
})();

/* ---------- Small UX: keyboard shortcuts ---------- */
(function keyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Ctrl+Shift+S -> Save
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 's') {
      e.preventDefault();
      saveAll();
      alert('Saved.');
    }
    // Ctrl+G -> Toggle auth gate (for quick testing)
    if (e.ctrlKey && e.key.toLowerCase() === 'g') {
      const gate = document.getElementById('authGate');
      if (!gate) return;
      gate.classList.toggle('hidden');
      document.getElementById('mainContent').style.filter = gate.classList.contains('hidden') ? 'none' : 'blur(6px)';
    }
  });
})();

/* ---------- Final sanity check & re-render to ensure everything is in sync ---------- */
(function finalSanityCheck() {
  try {
    // Ensure guest button works and auth gate state is correct
    const lastProfile = localStorage.getItem('mm_last_profile');
    if (lastProfile === 'Guest') {
      document.getElementById('authGate')?.classList.add('hidden');
      document.getElementById('profileNameDisplay').textContent = 'Guest (Offline)';
      document.getElementById('logoutBtn').style.display = 'block';
    } else {
      // If no profile and firebase not available, keep auth gate visible
      if (!lastProfile && !auth) {
        document.getElementById('authGate')?.classList.remove('hidden');
        document.getElementById('mainContent').style.filter = 'blur(6px)';
      }
    }

    // Run initial market fetch and UI render
    fetchRealMarketData().then(() => {
      renderMarketList();
      renderMarketTicker();
      renderAll();
    }).catch(() => {
      renderAll();
    });
  } catch (err) {
    console.error('finalSanityCheck error', err);
  }
})();

/* ---------- Expose a small diagnostics helper for you (optional) ---------- */
window.mmDiagnostics = function() {
  return {
    dataCount: Array.isArray(data) ? data.length : 0,
    methods: Object.keys(methodNames || {}).length,
    incomeSources: (incomeSources || []).slice(),
    settingsSummary: { trackedMarkets: (settings.trackedMarkets || []).length, ccLimit: settings.ccLimit }
  };
};
</script>
<!-- END Part 4 -->

<!-- BEGIN Part 5: Final feature completions, robust sample generator, diagnostics, and full integration -->
<script>
/* ---------- PART 5: Final completions & utilities ---------- */

/* This part finalizes the application by:
   - Adding a richer sample data generator (for testing)
   - Ensuring all previously stubbed functions are implemented or safely proxied
   - Adding diagnostics UI helper and console-friendly functions
   - Finalizing event bindings that may have been missed
   - Small performance and safety guards
*/

/* ---------- RICH SAMPLE DATA GENERATOR ---------- */
function generateLargeSampleData(count = 120) {
  // Create a variety of realistic transactions across months
  const groups = Object.keys(INVESTMENT_STRUCTURE);
  const cats = settings.expenseCategories || DEFAULT_EXPENSE_CATEGORIES;
  const methods = Object.keys(methodNames).length ? Object.keys(methodNames) : Object.keys(methodNamesDefault);
  const incomes = incomeSources.length ? incomeSources : ['Salary','Freelance','Interest'];
  const now = new Date();
  const sample = [];
  for (let i = 0; i < count; i++) {
    const daysAgo = Math.floor(Math.random() * 365);
    const d = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
    const iso = d.toISOString().slice(0,10);
    const typeRoll = Math.random();
    if (typeRoll < 0.15) {
      // opening balance occasionally
      sample.push({
        id: uid(),
        type: 'opening_balance',
        amount: Math.round((Math.random() * 50000) + 1000),
        date: iso,
        desc: 'Opening balance',
        investmentGroup: 'Cash',
        investmentSub: methods[Math.floor(Math.random() * methods.length)],
        method: methods[Math.floor(Math.random() * methods.length)],
        category: 'N/A'
      });
    } else if (typeRoll < 0.45) {
      // income
      sample.push({
        id: uid(),
        type: 'income',
        amount: Math.round((Math.random() * 150000) + 5000),
        date: iso,
        desc: incomes[Math.floor(Math.random() * incomes.length)] + ' payment',
        category: 'N/A',
        method: methods[Math.floor(Math.random() * methods.length)],
        incomeSource: incomes[Math.floor(Math.random() * incomes.length)]
      });
    } else {
      // expense or investment
      const isInvest = Math.random() < 0.12;
      const category = isInvest ? 'Investments' : cats[Math.floor(Math.random() * cats.length)];
      const amount = Math.round((Math.random() * (isInvest ? 150000 : 20000)) + 100);
      const invGroup = isInvest ? groups[Math.floor(Math.random() * groups.length)] : '';
      const invSubList = invGroup && INVESTMENT_STRUCTURE[invGroup] ? Object.keys(INVESTMENT_STRUCTURE[invGroup]) : [];
      const invSub = invSubList.length ? invSubList[Math.floor(Math.random() * invSubList.length)] : '';
      sample.push({
        id: uid(),
        type: 'expense',
        amount,
        date: iso,
        desc: (isInvest ? 'Investment' : category) + ' - sample',
        category,
        subcategory: SUBCATEGORY_MAP[category] ? SUBCATEGORY_MAP[category][Math.floor(Math.random() * SUBCATEGORY_MAP[category].length)] : '',
        method: methods[Math.floor(Math.random() * methods.length)],
        investmentGroup: invGroup,
        investmentSub: invSub
      });
    }
  }
  return sample;
}
function loadLargeSample() {
  if (!confirm('This will overwrite current data with a large sample. Continue?')) return;
  data = generateLargeSampleData(180);
  saveAll();
  renderAll();
  alert('Large sample loaded: ' + data.length + ' entries.');
}

/* ---------- SAFE PROXIES FOR STUBBED FUNCTIONS (if any left) ---------- */
/* Some earlier parts left placeholders; ensure they exist and are safe no-ops if not implemented */
if (typeof renderCharts !== 'function') window.renderCharts = function(){ try { console.warn('renderCharts placeholder called'); } catch(e){}; };
if (typeof renderWalletUnified !== 'function') window.renderWalletUnified = function(){ try { console.warn('renderWalletUnified placeholder called'); } catch(e){}; };
if (typeof renderRecentEntries !== 'function') window.renderRecentEntries = function(){ try { console.warn('renderRecentEntries placeholder called'); } catch(e){}; };
if (typeof setupExpenseMultiSelect !== 'function') window.setupExpenseMultiSelect = function(){ try { console.warn('setupExpenseMultiSelect placeholder called'); } catch(e){}; };
if (typeof populateInvestmentGroupDropdowns !== 'function') window.populateInvestmentGroupDropdowns = populateInvestmentGroupDropdowns;

/* ---------- DIAGNOSTICS & DEBUG HELPERS ---------- */
function openDiagnosticsModal() {
  // Simple modal to show diagnostics (create if missing)
  let diag = document.getElementById('mmDiagModal');
  if (!diag) {
    const root = document.getElementById('modalsRoot') || document.body;
    const div = document.createElement('div');
    div.id = 'mmDiagModal';
    div.className = 'modal open';
    div.style.zIndex = 99999;
    div.innerHTML = `
      <div class="modal-content" style="max-width:800px">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Diagnostics</div>
          <button id="closeDiag" class="btn-outline">Close</button>
        </div>
        <div class="modal-pad" style="max-height:60vh;overflow:auto">
          <pre id="diagContent" style="white-space:pre-wrap;font-size:13px"></pre>
        </div>
      </div>
    `;
    root.appendChild(div);
    document.getElementById('closeDiag').addEventListener('click', () => div.classList.remove('open'));
    diag = div;
  } else {
    diag.classList.add('open');
  }
  const content = document.getElementById('diagContent');
  if (content) {
    const diagObj = {
      timestamp: new Date().toISOString(),
      dataCount: Array.isArray(data) ? data.length : 0,
      methods: methodNames,
      incomeSources,
      settingsSummary: { trackedMarkets: (settings.trackedMarkets || []).length, ccLimit: settings.ccLimit },
      charts: {
        mainChart: !!mainChart,
        donutChart: !!donutChart,
        invBar: !!invBreakdownBarChart,
        invPie: !!invBreakdownPieChart
      },
      lastProfile: localStorage.getItem('mm_last_profile')
    };
    content.textContent = JSON.stringify(diagObj, null, 2);
  }
}

/* Expose diagnostics to window */
window.openDiagnostics = openDiagnosticsModal;
window.loadLargeSample = loadLargeSample;

/* ---------- FINAL EVENT BINDINGS (ensure no missed elements) ---------- */
(function finalBindingsPart5() {
  try {
    // Bind large sample loader to a keyboard shortcut for power users: Ctrl+Shift+L
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l') {
        e.preventDefault();
        loadLargeSample();
      }
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'd') {
        e.preventDefault();
        openDiagnosticsModal();
      }
    });

    // Ensure import modal open/close buttons exist
    const importOpeners = document.querySelectorAll('[data-open-import]');
    importOpeners.forEach(btn => btn.addEventListener('click', () => {
      document.getElementById('importModal')?.classList.add('open');
    }));

    // Ensure analytics modal can be opened via nav
    const navAnalytics = document.getElementById('navAnalytics');
    if (navAnalytics) {
      navAnalytics.addEventListener('click', () => {
        document.querySelector('.openModal[data-modal-id="analyticsModal"]')?.click();
      });
    }

    // Ensure settings modal open
    const navSettings = document.getElementById('navSettings');
    if (navSettings) {
      navSettings.addEventListener('click', () => {
        document.querySelector('.openModal[data-modal-id="settingsModal"]')?.click();
        // If not present, open directly
        const modal = document.getElementById('settingsModal');
        if (modal) modal.classList.add('open');
      });
    }

    // Ensure export button fallback
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        try {
          convertToCSV(data);
        } catch (err) {
          console.error('Export failed', err);
          alert('Export failed. Check console for details.');
        }
      });
    }

    // Ensure add index quick add fallback
    const sidebarAdd = document.getElementById('sidebarAddIndexBtn');
    if (sidebarAdd) {
      sidebarAdd.addEventListener('click', () => {
        const sel = document.getElementById('sidebarIndexSelect');
        if (!sel) return;
        const val = sel.value;
        if (!val) return alert('Choose an index first');
        const [symbol, name] = val.split('|');
        addIndexToSettings(symbol, name || symbol);
        sel.value = '';
        renderMarketList();
        renderMarketTicker();
      });
    }

    // Ensure modal close for diagnostics if created
    document.addEventListener('click', (e) => {
      // close any open modal when clicking outside content (mobile friendly)
      const modals = document.querySelectorAll('.modal.open');
      modals.forEach(modal => {
        if (!e.target.closest('.modal-content') && !e.target.closest('.openModal')) {
          // keep authGate modal untouched
          if (modal.id === 'authGate') return;
          modal.classList.remove('open');
        }
      });
    });

    // Final save hook for manual "Save" button if present
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        try {
          saveAll();
          alert('Saved.');
        } catch (err) {
          console.error('Save failed', err);
          alert('Save failed. Check console.');
        }
      });
    }
  } catch (err) {
    console.error('finalBindingsPart5 error', err);
  }
})();

/* ---------- Completion log ---------- */
console.info('MoneyMirror: Part 5 loaded — final features and diagnostics are active.');
</script>
<!-- END Part 5 -->

<!-- BEGIN Part 6: Finalize, close any remaining gaps, and end the document -->
<script>
/* ---------- PART 6: Final wrap-up and graceful shutdown ---------- */

(function finalizeApp() {
  try {
    // Ensure all core functions exist and are safe to call
    window.renderAll = window.renderAll || function(){ console.warn('renderAll missing'); };
    window.saveAll = window.saveAll || function(){ console.warn('saveAll missing'); };
    window.loadProfileData = window.loadProfileData || function(){ console.warn('loadProfileData missing'); };

    // Final save to localStorage to persist any last-minute changes
    try { saveAll(); } catch (e) { console.warn('Final saveAll failed', e); }

    // Final UI consistency checks
    try {
      // Hide auth gate if profile present
      const lastProfile = localStorage.getItem('mm_last_profile');
      const authGate = document.getElementById('authGate');
      if (lastProfile && authGate) {
        authGate.classList.add('hidden');
        document.getElementById('mainContent').style.filter = 'none';
      }

      // Ensure required panels are visible/hidden correctly
      const invPanel = document.getElementById('invBreakdownPanel');
      if (invPanel && !invPanel.classList.contains('hidden')) {
        // keep as-is
      } else if (invPanel) {
        invPanel.classList.add('hidden');
      }

      // Ensure calculator is hidden by default on small screens
      const calc = document.getElementById('calculator');
      if (calc && window.innerWidth < 768) calc.style.display = 'none';

      // Ensure charts render once more to avoid blank canvases
      setTimeout(() => {
        try {
          renderAll();
          renderCharts();
          renderWalletUnified();
        } catch (err) {
          console.warn('Final render pass failed', err);
        }
      }, 120);
    } catch (err) {
      console.warn('UI finalization error', err);
    }

    // Friendly console message for debugging
    console.info('MoneyMirror finalization complete. UI should be fully interactive.');

  } catch (err) {
    console.error('finalizeApp error', err);
  }
})();

/* ---------- Expose a final "shutdown" helper for safe teardown (optional) ---------- */
window.mmShutdown = function() {
  try {
    // stop market loop if running
    if (typeof marketInterval !== 'undefined' && marketInterval) clearInterval(marketInterval);
    // save state
    if (typeof saveAll === 'function') saveAll();
    console.info('MoneyMirror shutdown complete.');
  } catch (e) {
    console.warn('Shutdown error', e);
  }
};
</script>

</body>
</html>
