<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — Merged v5.0.x (Base: v5.0.2 + Upgrades)</title>

  <!-- Fonts and Charts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase (Compat for optional cloud sync) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    /* =========================================================================
       MoneyMirror merged stylesheet
       - Base: v5.0.2
       - Upgrades: inv filters, checklist, quick subs, settings editor, analytics modal
       - Restored: calculator, mobile menu, export/import, responsive fixes
       ========================================================================= */

    :root{
      --sidebar-bg:#0f172a; --sidebar-text:#94a3b8; --sidebar-active:#38bdf8;
      --bg-color:#f1f5f9; --card-bg:#ffffff; --text-main:#1e293b; --text-muted:#64748b;
      --primary:#2563eb; --primary-dark:#1d4ed8; --success:#10b981; --danger:#ef4444; --border:#cbd5e1;
      --kpi-glow: 0 10px 25px rgba(29,78,216,0.15);
      --radius-lg:16px; --radius-md:10px; --radius-sm:6px;
      --shadow-soft: 0 12px 30px rgba(2,25,66,0.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Inter',sans-serif;margin:0;background:var(--bg-color);color:var(--text-main);display:flex;min-height:100vh;overflow:hidden}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}

    /* Sidebar */
    aside{width:260px;background:var(--sidebar-bg);display:flex;flex-direction:column;padding:24px 16px;color:white;flex-shrink:0}
    .brand{font-size:20px;font-weight:700;color:white;margin-bottom:20px;display:flex;align-items:center;gap:10px}
    .brand span{color:var(--sidebar-active)}
    .nav-group{margin-bottom:18px}
    .nav-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#475569;font-weight:700;margin-bottom:8px;padding-left:10px}
    .nav-item{padding:10px 12px;border-radius:6px;color:var(--sidebar-text);cursor:pointer;transition:0.18s;display:flex;align-items:center;gap:12px;font-size:14px;font-weight:600;margin-bottom:6px}
    .nav-item:hover{background:rgba(255,255,255,0.05);color:white}
    .nav-item.active{background:rgba(56,189,248,0.1);color:var(--sidebar-active)}
    .sidebar-footer{background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);font-size:12px;margin-top:auto}

    /* Main */
    main{flex:1;overflow-y:auto;padding:22px;display:flex;flex-direction:column;gap:20px;position:relative;filter:blur(5px)}
    header.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    header .actions{display:flex;gap:10px;align-items:center}

    /* Buttons */
    button{padding:10px 14px;border-radius:8px;border:none;font-weight:600;font-size:13px;cursor:pointer;transition:0.18s}
    .btn-primary{background:var(--primary);color:white;box-shadow:0 8px 20px rgba(37,99,235,0.12)}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-outline{background:white;border:1px solid var(--border);color:var(--text-main)}
    .btn-outline:hover{background:#f8fafc;border-color:#94a3b8}
    .btn-danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}

    /* Grid */
    .dashboard-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
    .col-span-1{grid-column:span 1} .col-span-2{grid-column:span 2} .col-span-3{grid-column:span 3} .col-span-4{grid-column:span 4}

    /* Cards */
    .card{background:var(--card-bg);border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow-soft);display:flex;flex-direction:column;overflow:hidden}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px 10px 18px}
    .card-body{padding:0 18px 18px 18px;flex:1}
    .card-title{font-size:15px;font-weight:600;color:var(--text-main)}

    /* KPI */
    .kpi-card{padding:18px;border-radius:12px}
    .kpi-value{font-size:28px;font-weight:700;margin-top:4px;letter-spacing:-0.5px}
    .kpi-sub{font-size:12px;color:var(--text-muted);margin-top:6px;display:flex;align-items:center;gap:6px}

    /* Forms */
    label{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;display:block;letter-spacing:0.5px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:#f8fafc;outline:none;transition:border 0.18s}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);background:white;box-shadow:0 0 0 4px rgba(37,99,235,0.06)}

    /* Table */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:700}

    /* Wallet & charts */
    .wallet-layout{display:flex;flex-direction:row;align-items:center;gap:18px}
    .wallet-chart{height:300px;width:50%;max-width:420px;position:relative}
    .wallet-legend{font-size:13px;color:var(--text-muted)}

    /* Quick subs */
    .quick-sub-card{border:1px solid var(--border);border-radius:10px;padding:12px;background:white}
    .quick-sub-header{display:flex;justify-content:space-between;align-items:center}
    .quick-sub-title{font-weight:800}
    .total-badge{background:#f1f5f9;border:1px solid #e2e8f0;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:800;color:#0f172a}

    /* Dropdown */
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;top:40px;left:0;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;width:320px;box-shadow:0 12px 24px rgba(0,0,0,0.12);z-index:40}
    .dropdown-item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px;font-size:13px}
    .dropdown-item:hover{background:#f8fafc}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;display:none;justify-content:center;align-items:center;backdrop-filter:blur(2px)}
    .modal.open{display:flex}
    .modal-content{background:white;width:95%;max-width:1200px;border-radius:12px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-height:90vh;overflow-y:auto}
    .modal-small{max-width:480px}
    .modal-pad{padding:18px}

    /* Calculator */
    #calculator { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 520px; z-index: 3000; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #fff; border:1px solid var(--border); display:none; flex-direction:column; overflow:hidden; }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 12px 14px; display:flex;justify-content:space-between;align-items:center; }
    #calc-display { background:#0b1220;color:#fff;padding:12px 14px;font-family:var(--mono);font-size:22px;text-align:right;min-height:56px; }
    #calc-preview { background:#071022;color:#9fb3c8;padding:6px 14px;font-family:var(--mono);font-size:13px;text-align:right; }
    #calc-buttons { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; padding:12px; background:#f8fafc; flex:1; }
    #calc-buttons button{padding:12px;border-radius:8px;border:1px solid #e6edf6;background:white;font-size:16px}
    .calc-operator{background:#e6f7ff;color:var(--primary)}
    .calc-clear{background:#fff2f2;color:var(--danger)}
    .calc-equals{background:var(--primary);color:white;font-weight:800}

    /* Mobile */
    @media(max-width:1200px){ .dashboard-grid{grid-template-columns:repeat(2,1fr)} .col-span-2,.col-span-3,.col-span-4{grid-column:span 2} }
    @media(max-width:768px){
      body{flex-direction:column}
      aside{width:100%;padding:12px;flex-direction:row;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:500}
      .brand{margin-bottom:0}
      aside nav, .sidebar-footer{display:none}
      aside.mobile-open nav{display:block;position:absolute;top:60px;left:0;right:0;background:var(--sidebar-bg);padding:20px;border-top:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 20px rgba(0,0,0,0.5);z-index:501}
      aside.mobile-open .sidebar-footer{display:block;position:fixed;bottom:20px;left:20px;right:20px;z-index:501}
      .dashboard-grid{grid-template-columns:1fr;gap:12px}
      .wallet-layout{flex-direction:column}
      #calculator{left:50%;transform:translateX(-50%);right:auto;bottom:auto;top:80px;width:92%}
      .dropdown-menu{width:90vw;left:5vw}
    }

    /* Accessibility helpers */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>

  <!-- Auth gate -->
  <div id="authGate" class="modal open" style="display:flex;position:fixed;inset:0;background:linear-gradient(135deg,#0f172a,#2563eb);z-index:9999;">
    <div style="text-align:center;color:white;padding:24px;max-width:520px">
      <h2 style="margin:0;font-size:22px;font-weight:700">Welcome to</h2>
      <h1 style="margin:6px 0 12px;font-size:28px;font-weight:900">MoneyMirror — Personal Finance</h1>
      <p style="font-style:italic;margin:0 0 18px">by Rehan Hamdulay</p>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button id="loginBtn" class="btn-primary" style="padding:12px 20px;font-size:16px">Sign in with Google</button>
        <button id="continueLocal" class="btn-outline" style="padding:12px 20px;font-size:16px">Continue locally</button>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside id="mainSidebar" aria-label="Main navigation">
    <div style="width:100%">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
        <div class="brand" aria-hidden="true">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
          MoneyMirror <span>v5.0</span>
        </div>
        <button id="mobileMenuBtn" aria-label="Toggle menu" style="background:transparent;border:none;color:white;display:none">
          <svg class="icon-menu" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
      </div>

      <nav style="margin-top:12px">
        <div class="nav-group">
          <div class="nav-label">Main menu</div>
          <div class="nav-item active" id="navDashboard" role="button" tabindex="0">Dashboard</div>
          <div class="nav-item" id="navAnalytics" role="button" tabindex="0">Advanced analytics</div>
        </div>

        <div class="nav-group">
          <div class="nav-label">Configuration</div>
          <div class="nav-item" id="navSettings" role="button" tabindex="0">Settings & Backup</div>
          <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%;display:none">Logout</button></div>
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:12px;color:var(--sidebar-text)">Current profile</div>
        <div id="profileNameDisplay" style="font-weight:800">--</div>
      </div>
      <div style="font-size:11px;color:var(--sidebar-text);margin-top:8px">Merged build • Base v5.0.2 + upgrades</div>
    </div>
  </aside>

  <!-- Main -->
  <main role="main" aria-live="polite">
    <header class="topbar">
      <div>
        <h1 style="margin:0;font-size:22px;font-weight:800">Financial overview</h1>
        <div id="currentDate" style="font-size:13px;color:var(--text-muted);margin-top:6px"></div>
      </div>

      <div class="actions">
        <button class="btn-outline" id="sampleBtn">Load sample</button>
        <button class="btn-primary" id="importDataBtn">Import data (CSV/JSON)</button>
        <button class="btn-outline" id="exportBtn">Export CSV</button>
        <button class="btn-outline" id="calc-toggle" aria-controls="calculator">Calculator</button>
      </div>
    </header>

    <!-- KPI row -->
    <section class="dashboard-grid" aria-label="Key performance indicators">
      <div class="card kpi-card col-span-1">
        <div class="kpi-title">Monthly income</div>
        <div class="kpi-value" id="kpiIncome">₹0</div>
        <div class="kpi-sub" id="momIncome"></div>
      </div>

      <div class="card kpi-card col-span-1">
        <div class="kpi-title">Monthly expenses</div>
        <div class="kpi-value" id="kpiExpense">₹0</div>
        <div class="kpi-sub" id="momExpense"></div>
      </div>

      <div class="card kpi-card col-span-1" id="ccCard" style="border:1px solid #fde68a;background:linear-gradient(180deg,#fff7ed,#fffbeb)">
        <div class="kpi-title">Credit card due</div>
        <div class="kpi-value" id="kpiCCDue">₹0</div>
        <div class="kpi-sub" style="margin-top:6px;position:relative;">
          <span id="ccPaymentDate">Next Payment: 10th of December</span>
          <span style="margin-left:10px;">Limit: <span id="ccLimitDisplay">₹2,00,000</span></span>
          <div id="ccAlert" class="hidden" style="position:absolute; right:0; top:0; color:var(--danger)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          </div>
        </div>
      </div>

      <div class="card kpi-card col-span-1">
        <div class="kpi-title">Net liquidity</div>
        <div class="kpi-value" id="kpiNet">₹0</div>
        <div class="kpi-sub">Total available cash</div>
        <div class="account-list" id="netLiquidityBreakdown"></div>
      </div>

      <!-- Investment KPI with breakdown -->
      <div class="card col-span-4" style="background:linear-gradient(180deg,#eef2ff,#f8fafc);border:1px solid #c7d2fe;">
        <div class="card-header" style="padding-top:10px;">
          <div class="card-title">Total investment value (historical cost)</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px;font-size:12px;">View breakdown</button>
          </div>
        </div>

        <div class="card-body">
          <div class="kpi-value" id="kpiInvest">₹0</div>
          <div class="kpi-sub" id="momInvest" style="color:#075985"></div>

          <div id="invBreakdownPanel" class="hidden" style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
            <!-- Filters -->
            <div class="card" style="border:1px solid #c7d2fe;margin-bottom:12px;border-radius:10px;">
              <div class="card-header">
                <div class="card-title">Filters</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                  <div style="min-width:220px;">
                    <label>Major bucket</label>
                    <select id="invBucketFilter" aria-label="Investment bucket filter">
                      <option value="">All buckets</option>
                    </select>
                  </div>
                  <div style="min-width:220px;">
                    <label>View mode</label>
                    <select id="invViewMode" aria-label="Investment view mode">
                      <option value="top4">Top 4 buckets</option>
                      <option value="subcats">Subcategories of selected bucket</option>
                    </select>
                  </div>
                  <div style="min-width:220px;">
                    <label>Date range</label>
                    <select id="invDateRange" aria-label="Investment date range">
                      <option value="6">Last 6 months</option>
                      <option value="12">Last 12 months</option>
                      <option value="all">All time</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="kpi-breakdown-grid" style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:stretch">
              <div class="card" style="border:1px solid #c7d2fe;">
                <div class="card-header"><div class="card-title" id="invBarTitle">Investment by major bucket</div></div>
                <div class="card-body" style="height:340px">
                  <canvas id="invBreakdownBar"></canvas>
                </div>
              </div>

              <div class="card" style="border:1px solid #c7d2fe;">
                <div class="card-header"><div class="card-title" id="invPieTitle">Share by bucket</div></div>
                <div class="card-body" style="height:340px">
                  <canvas id="invBreakdownPie"></canvas>
                </div>
              </div>
            </div>

            <!-- Quick subs -->
            <div style="margin-top:14px;">
              <div class="card-title" style="font-size:13px;color:#075985;">Bucket subcategories quick view</div>
              <div id="invQuickSubs" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Charts row -->
    <section class="dashboard-grid" aria-label="Charts and wallet">
      <div class="card col-span-2">
        <div class="card-header">
          <div class="card-title">Cash flow & investments</div>
          <select id="mainChartFilter" onchange="renderCharts()" aria-label="Main chart date range">
            <option value="6">Last 6 months</option>
            <option value="12">Last 12 months</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="card-body" style="height:340px">
          <canvas id="mainChart"></canvas>
        </div>
      </div>

      <div class="card col-span-2">
        <div class="card-header" style="gap:12px;">
          <div class="card-title">Wallet breakdown and expense analysis</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="walletMode" onchange="renderWalletUnified()" aria-label="Wallet mode">
              <option value="wallet">Wallet breakdown (Liquid & Savings)</option>
              <option value="expenses">Expense distribution (Top 10)</option>
            </select>

            <div id="walletChecklistContainer" class="dropdown" style="position:relative">
              <button class="btn-outline" id="toggleChecklist" style="padding:6px 10px;font-size:12px;">Filter categories</button>
              <div id="walletCategoryChecklist" class="dropdown-menu hidden" onclick="event.stopPropagation()">
                <div id="walletChecklistItems" style="max-height:220px;overflow:auto"></div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                  <button class="btn-outline" id="applyChecklist" style="padding:6px 10px;font-size:12px;">Apply</button>
                  <button class="btn-outline" id="clearChecklist" style="padding:6px 10px;font-size:12px;">Clear</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-body wallet-layout">
          <div class="wallet-chart">
            <canvas id="donutChart"></canvas>
          </div>
          <div style="flex:1;display:flex;flex-direction:column;gap:10px;">
            <div id="walletLegend" class="wallet-legend"></div>
            <div id="walletInfo" style="font-size:13px;color:var(--text-muted)"></div>
            <button id="resetExpenseDrilldown" class="btn-outline hidden" style="padding:6px;font-size:12px" onclick="resetExpenseDrilldown()">Clear filters</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Add entry + recent -->
    <section class="dashboard-grid" aria-label="Add entry and recent transactions">
      <div class="card col-span-4" style="border:1px solid #dbeafe">
        <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);color:white">
          <div class="card-title" style="color:white">Add new entry</div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </div>

        <div class="card-body" style="display:flex;flex-wrap:wrap;gap:12px">
          <div style="width:15%">
            <label for="type">Type</label>
            <select id="type" aria-label="Entry type">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
              <option value="opening_balance">Opening Balance</option>
            </select>
          </div>

          <div style="width:15%">
            <label for="amount">Amount (₹)</label>
            <input id="amount" type="number" placeholder="0.00" step="any" aria-label="Amount" />
          </div>

          <div style="width:15%">
            <label for="date">Date</label>
            <input id="date" type="date" aria-label="Date" />
          </div>

          <div style="width:45%">
            <label for="desc">Description</label>
            <input id="desc" placeholder="What is this for?" aria-label="Description" />
          </div>

          <div id="dynamicFieldsContainer" style="width:100%;border-top:1px solid var(--border);padding-top:12px;margin-top:6px">
            <div id="regularFields" style="display:flex;gap:12px;flex-wrap:wrap">
              <div id="categoryContainer" style="width:15%">
                <label for="category">Category</label>
                <select id="category" aria-label="Category"></select>
              </div>

              <div style="width:15%">
                <label for="method">Method</label>
                <select id="method" aria-label="Method"></select>
              </div>

              <div id="incomeSourceRow" class="hidden" style="width:15%">
                <label for="incomeSource">Source</label>
                <select id="incomeSource" aria-label="Income source"></select>
              </div>

              <div id="investmentRow" class="hidden" style="display:flex;gap:12px;flex-wrap:wrap;width:100%">
                <div style="width:20%">
                  <label for="invGroup">Investment category</label>
                  <select id="invGroup" aria-label="Investment group"></select>
                </div>
                <div style="width:20%">
                  <label for="invSub">Investment sub-type</label>
                  <select id="invSub" aria-label="Investment sub-type"></select>
                </div>
              </div>

              <div id="insuranceRow" class="hidden" style="width:25%">
                <label>Insurance details</label>
                <div style="display:flex;gap:8px">
                  <select id="insType" aria-label="Insurance type"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                  <select id="insFor" aria-label="Insured for"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
                </div>
              </div>
            </div>

            <div id="openingBalanceRow" class="hidden" style="display:flex;gap:12px;flex-wrap:wrap;width:100%;margin-top:12px">
              <div style="width:20%">
                <label for="openingType">Asset type</label>
                <select id="openingType" aria-label="Opening asset type">
                  <option value="Cash">Cash (Liquid)</option>
                  <option value="Investment">Investment Asset</option>
                </select>
              </div>

              <div id="openingGroupContainer" class="hidden" style="width:20%">
                <label id="openingGroupLabel">Asset category</label>
                <select id="openingGroup" aria-label="Opening asset category"></select>
              </div>

              <div id="openingSubContainer" class="hidden" style="width:20%">
                <label id="openingSubLabel">Account / Asset sub-type</label>
                <select id="openingSub" aria-label="Opening asset sub-type"></select>
              </div>
            </div>
          </div>

          <div style="width:100%;display:flex;gap:10px;margin-top:10px">
            <button class="btn-primary" id="addBtn">Add entry</button>
            <button class="btn-primary hidden" id="saveBtn">Save changes</button>
            <button class="btn-outline hidden" id="cancelBtn">Cancel edit</button>
          </div>
        </div>
      </div>

      <div class="card col-span-4">
        <div class="card-header">
          <div class="card-title">Recent transactions</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="entryLimit" onchange="renderRecentEntries()" aria-label="Recent entries limit">
              <option value="10">Last 10</option>
              <option value="25">Last 25</option>
              <option value="50">Last 50</option>
              <option value="all">All</option>
            </select>
            <button id="clearAllBtn" class="btn-outline" title="Clear all transactions">Clear all</button>
          </div>
        </div>

        <div class="card-body" style="overflow-x:auto">
          <table id="recentTable" aria-label="Recent transactions table">
            <thead>
              <tr><th>Type</th><th>Date</th><th>Amount</th><th>Description</th><th>Category</th><th>Method</th><th style="width:120px">Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer style="display:flex;justify-content:space-between;align-items:center;padding-top:6px">
      <div style="font-size:12px;color:var(--text-muted)">Local mode: data stored in browser. Sign in to sync with cloud.</div>
      <div style="font-size:12px;color:var(--text-muted)">v5.0.x • Merged build</div>
    </footer>
  </main>

  <!-- Calculator -->
  <div id="calculator" role="dialog" aria-label="Calculator">
    <div id="calc-header">
      <div style="font-weight:700;color:white">Calculator</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="calc-copy" class="btn-outline" title="Copy result">Copy</button>
        <button id="calc-close-btn" class="btn-outline" title="Close calculator">Close</button>
      </div>
    </div>

    <div id="calc-display" aria-live="polite">0</div>
    <div id="calc-preview" aria-hidden="true"></div>

    <div id="calc-buttons" role="group" aria-label="Calculator buttons">
      <button class="calc-clear" data-key="C">C</button>
      <button data-key="(">(</button>
      <button data-key=")">)</button>
      <button class="calc-operator" data-key="/">÷</button>

      <button data-key="7">7</button>
      <button data-key="8">8</button>
      <button data-key="9">9</button>
      <button class="calc-operator" data-key="*">×</button>

      <button data-key="4">4</button>
      <button data-key="5">5</button>
      <button data-key="6">6</button>
      <button class="calc-operator" data-key="-">−</button>

      <button data-key="1">1</button>
      <button data-key="2">2</button>
      <button data-key="3">3</button>
      <button class="calc-operator" data-key="+">+</button>

      <button class="calc-zero" data-key="0">0</button>
      <button data-key=".">.</button>
      <button class="calc-equals" data-key="=">=</button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content modal-small">
      <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);color:white">
        <div class="card-title" style="color:white">Settings & Configuration</div>
        <button class="btn-outline" id="closeSettings" style="background:transparent;color:white;border-color:white;padding:6px">Close</button>
      </div>

      <div class="modal-pad">
        <div style="margin-bottom:16px">
          <label>Payment methods</label>
          <div id="methodEditor" style="border:1px solid var(--border);border-radius:8px;padding:10px;min-height:48px"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newMethod" placeholder="New method (e.g. SBI UPI)" />
            <button class="btn-primary" id="addMethod">Add</button>
          </div>
        </div>

        <div style="margin-bottom:16px">
          <label>Income sources</label>
          <div style="display:flex;gap:8px">
            <input id="newIncome" placeholder="New source name" />
            <button class="btn-primary" id="addIncomeBtn">Add</button>
          </div>
          <div id="incomeList" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>

        <div style="margin-bottom:16px">
          <label>Credit card limit</label>
          <div style="display:flex;gap:8px">
            <input id="ccLimitInput" type="number" placeholder="Set limit (e.g. 200000)" />
            <button class="btn-primary" id="saveCCLimit">Save limit</button>
          </div>
        </div>

        <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
          <label style="color:var(--danger)">Danger zone</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-danger" id="resetBtn">Factory reset profile</button>
            <button class="btn-outline" id="exportBackup">Export backup</button>
            <button class="btn-outline" id="importBackup">Import backup</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics modal -->
  <div id="analyticsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);color:white">
        <div class="card-title" style="color:white">Advanced financial analytics</div>
        <button class="btn-outline" id="closeAnalytics" style="background:transparent;color:white;border-color:white;padding:6px">Close</button>
      </div>

      <div class="modal-pad" id="analyticsContent">
        <div class="card" style="margin-bottom:16px;border:1px solid #dbeafe;border-radius:8px">
          <div class="card-header">
            <div class="card-title">Filters</div>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <div style="min-width:160px">
                <label>Date range</label>
                <select id="dateFilter" onchange="renderAdvancedCharts()">
                  <option value="6">Last 6 months</option>
                  <option value="12">Last 12 months</option>
                  <option value="all">All time</option>
                </select>
              </div>

              <div style="min-width:160px">
                <label>Chart type</label>
                <select id="chartType" onchange="renderAdvancedCharts()">
                  <option value="line">Line chart</option>
                  <option value="bar">Bar chart</option>
                </select>
              </div>

              <div style="min-width:220px">
                <label>Major bucket</label>
                <select id="analyticsBucket" onchange="renderAdvancedCharts()">
                  <option value="">All</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <h3 style="margin:10px 0 0;font-size:18px;">Cumulative net worth</h3>
        <div class="card" style="margin-bottom:16px">
          <div class="card-body">
            <canvas id="analyticsNetWorth" style="height:320px"></canvas>
          </div>
        </div>

        <h3 style="margin:10px 0 0;font-size:18px;">Bucket performance</h3>
        <div class="card" style="margin-bottom:16px">
          <div class="card-body">
            <canvas id="analyticsBucketChart" style="height:320px"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input id="fileInput" type="file" accept=".csv,application/json" style="display:none" />

  <script>
    /* =========================================================================
       MoneyMirror merged script
       - Base: v5.0.2
       - Upgrades: inv filters, checklist, quick subs, settings editor, analytics modal
       - Restored: calculator, mobile menu, CSV import/export, local persistence
       ========================================================================= */

    // Firebase config (optional)
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
    };

    // App state
    let db = null, auth = null, USE_FIRESTORE = false;
    let currentProfile = null;
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';

    // Core data
    let transactions = [];
    let methods = ['Cash','UPI','Card'];
    let incomeSources = ['Salary'];
    let categories = ['Salary','Groceries','Rent','Utilities','Investment','Entertainment','Travel','Health','Other'];
    let invBuckets = {
      'Equity': [{name:'Bluechip', value:50000},{name:'Smallcap', value:15000}],
      'Debt': [{name:'Bonds', value:20000}],
      'Mutual Funds': [{name:'MF - Large', value:30000}],
      'ETFs': [{name:'ETF - India', value:10000}],
      'Crypto': [{name:'BTC', value:5000}],
      'Real Estate': [],
      'Commodities': [],
      'Other': []
    };

    // Chart refs
    let mainChart=null, donutChart=null, invBar=null, invPie=null, analyticsNet=null, analyticsBucket=null;

    // Helpers
    const $ = id => document.getElementById(id);

    // Init Firebase if available
    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
      console.log('Firebase initialized');
    } catch(e) {
      console.warn('Firebase init failed or not available; running local-only', e);
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      // Auth
      $('loginBtn').addEventListener('click', signInWithGoogle);
      $('continueLocal').addEventListener('click', ()=> { $('authGate').style.display='none'; document.querySelector('main').style.filter='none'; restoreFromLocal(); });
      if(auth) {
        auth.onAuthStateChanged(user => { if(user) onUserSignedIn(user); });
      }

      // Sidebar nav
      $('navSettings').addEventListener('click', ()=> openModal('settingsModal'));
      $('closeSettings').addEventListener('click', ()=> closeModal('settingsModal'));
      $('navAnalytics').addEventListener('click', ()=> openModal('analyticsModal'));
      $('closeAnalytics').addEventListener('click', ()=> closeModal('analyticsModal'));

      // Mobile menu
      $('mobileMenuBtn').addEventListener('click', ()=> document.getElementById('mainSidebar').classList.toggle('mobile-open'));

      // Calculator
      $('calc-toggle').addEventListener('click', ()=> toggleCalculator());
      $('calc-close-btn').addEventListener('click', ()=> toggleCalculator(false));
      $('calc-copy').addEventListener('click', copyCalcResult);

      // Sample, import/export
      $('sampleBtn').addEventListener('click', loadSampleData);
      $('importDataBtn').addEventListener('click', ()=> $('fileInput').click());
      $('fileInput').addEventListener('change', handleFileImport);
      $('exportBtn').addEventListener('click', exportCSV);

      // Settings actions
      $('addMethod').addEventListener('click', addMethod);
      $('addIncomeBtn').addEventListener('click', addIncome);
      $('saveCCLimit').addEventListener('click', saveCCLimit);
      $('resetBtn').addEventListener('click', factoryReset);
      $('exportBackup').addEventListener('click', exportBackup);
      $('importBackup').addEventListener('click', ()=> $('fileInput').click());

      // Inv breakdown toggle
      $('toggleInvBreakdown').addEventListener('click', ()=> $('invBreakdownPanel').classList.toggle('hidden'));

      // Wallet checklist
      $('toggleChecklist').addEventListener('click', (e)=> { e.stopPropagation(); $('walletCategoryChecklist').classList.toggle('hidden'); });
      document.addEventListener('click', ()=> { if($('walletCategoryChecklist')) $('walletCategoryChecklist').classList.add('hidden'); });
      $('applyChecklist').addEventListener('click', applyWalletChecklist);
      $('clearChecklist').addEventListener('click', clearWalletChecklist);

      // Entry form
      $('addBtn').addEventListener('click', addEntry);
      $('type').addEventListener('change', onTypeChange);
      $('openingType').addEventListener('change', onOpeningTypeChange);
      $('entryLimit').addEventListener('change', renderRecentEntries);
      $('clearAllBtn').addEventListener('click', clearAllTransactions);

      // Populate UI lists
      renderStaticLists();
      renderMethodEditor();
      renderIncomeList();
      populateWalletChecklist();
      populateInvBucketFilters();

      // Charts
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
      renderAnalyticsCharts();

      // Calculator
      initCalculator();

      // Date display
      updateDateDisplay();
      setInterval(updateDateDisplay, 60*1000);

      // Restore local
      restoreFromLocal();
    });

    /* ---------------------------
       Authentication helpers
       --------------------------- */
    async function signInWithGoogle(){
      if(!auth) return alert('Auth not initialized. Please refresh or continue locally.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const res = await auth.signInWithPopup(provider);
        onUserSignedIn(res.user);
      } catch(err) {
        console.error('Sign-in failed', err);
        alert('Sign-in popup blocked or failed. Try again or continue locally.');
      }
    }

    function onUserSignedIn(user){
      currentProfile = user.displayName || user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      $('profileNameDisplay').textContent = currentProfile;
      $('authGate').style.display='none';
      document.querySelector('main').style.filter='none';
      $('logoutBtn').style.display='block';
      loadProfileData();
    }

    function signOutUser(){
      if(!auth) return;
      auth.signOut().then(()=> {
        currentProfile = null;
        $('profileNameDisplay').textContent='--';
        $('logoutBtn').style.display='none';
        $('authGate').style.display='flex';
        document.querySelector('main').style.filter='blur(5px)';
      });
    }

    /* ---------------------------
       UI population helpers
       --------------------------- */
    function renderStaticLists(){
      const cat = $('category'); if(cat){ cat.innerHTML=''; categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cat.appendChild(o); }); }
      const m = $('method'); if(m){ m.innerHTML=''; methods.forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; m.appendChild(o); }); }
      const inc = $('incomeSource'); if(inc){ inc.innerHTML=''; incomeSources.forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; inc.appendChild(o); }); }
      const ig = $('invGroup'); if(ig){ ig.innerHTML=''; Object.keys(invBuckets).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; ig.appendChild(o); }); ig.addEventListener('change', ()=> populateInvSub(ig.value)); populateInvSub(ig.value || Object.keys(invBuckets)[0]); }
    }

    function populateInvSub(bucket){
      const isub = $('invSub'); if(!isub) return;
      isub.innerHTML='';
      const items = invBuckets[bucket] || [];
      if(items.length===0){ const o=document.createElement('option'); o.value='Other'; o.textContent='Other'; isub.appendChild(o); return; }
      items.forEach(it=>{ const o=document.createElement('option'); o.value=it.name; o.textContent=it.name; isub.appendChild(o); });
    }

    function populateWalletChecklist(){
      const container = $('walletChecklistItems'); if(!container) return;
      container.innerHTML='';
      categories.forEach(cat=>{
        const id = 'chk_' + cat.replace(/\s+/g,'_');
        const div = document.createElement('div'); div.className='dropdown-item';
        div.innerHTML = `<label style="flex:1"><input type="checkbox" id="${id}" value="${cat}" /> ${cat}</label>`;
        container.appendChild(div);
      });
    }

    function populateInvBucketFilters(){
      const sel = $('invBucketFilter'); if(!sel) return;
      sel.innerHTML = '<option value="">All buckets</option>';
      Object.keys(invBuckets).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
      const analyticsSel = $('analyticsBucket'); if(analyticsSel){ analyticsSel.innerHTML = '<option value="">All</option>'; Object.keys(invBuckets).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; analyticsSel.appendChild(o); }); }
    }

    /* ---------------------------
       Persistence
       --------------------------- */
    function saveToLocal(){
      const state = { transactions, methods, incomeSources, categories, invBuckets, ccLimit: $('ccLimitDisplay').textContent || '' };
      localStorage.setItem('mm_state', JSON.stringify(state));
    }

    function restoreFromLocal(){
      const raw = localStorage.getItem('mm_state');
      if(!raw) return;
      try {
        const s = JSON.parse(raw);
        transactions = s.transactions || transactions;
        methods = s.methods || methods;
        incomeSources = s.incomeSources || incomeSources;
        categories = s.categories || categories;
        invBuckets = s.invBuckets || invBuckets;
        if(s.ccLimit) $('ccLimitDisplay').textContent = s.ccLimit;
        renderStaticLists();
        renderMethodEditor();
        renderIncomeList();
        populateWalletChecklist();
        populateInvBucketFilters();
        renderRecentEntries();
        renderCharts();
        renderWalletUnified();
        renderInvBreakdownCharts();
      } catch(e){ console.warn('restore failed', e); }
    }

    async function loadProfileData(){
      if(!USE_FIRESTORE || !auth || !auth.currentUser) return;
      try {
        const uid = auth.currentUser.uid;
        const doc = await db.collection('profiles').doc(uid).get();
        if(doc.exists){
          const data = doc.data();
          if(data.state){
            const s = data.state;
            transactions = s.transactions || transactions;
            methods = s.methods || methods;
            incomeSources = s.incomeSources || incomeSources;
            categories = s.categories || categories;
            invBuckets = s.invBuckets || invBuckets;
            renderStaticLists();
            renderMethodEditor();
            renderIncomeList();
            populateWalletChecklist();
            populateInvBucketFilters();
            renderRecentEntries();
            renderCharts();
            renderWalletUnified();
            renderInvBreakdownCharts();
          }
        }
      } catch(e){ console.warn('Failed to load profile data from Firestore', e); }
    }

    async function syncToCloud(){
      if(!USE_FIRESTORE || !auth || !auth.currentUser) return;
      try {
        const uid = auth.currentUser.uid;
        await db.collection('profiles').doc(uid).set({ state: { transactions, methods, incomeSources, categories, invBuckets } }, { merge:true });
        console.log('Synced to cloud');
      } catch(e){ console.warn('Cloud sync failed', e); }
    }

    /* ---------------------------
       Sample data
       --------------------------- */
    function loadSampleData(){
      transactions = [
        {id:generateId(),type:'income',date:isoDaysAgo(2),amount:120000,desc:'Salary credited',category:'Salary',method:'UPI',source:'Salary'},
        {id:generateId(),type:'expense',date:isoDaysAgo(1),amount:4500,desc:'Groceries at supermarket',category:'Groceries',method:'Card'},
        {id:generateId(),type:'expense',date:isoDaysAgo(3),amount:15000,desc:'Monthly rent',category:'Rent',method:'UPI'},
        {id:generateId(),type:'expense',date:isoDaysAgo(10),amount:2500,desc:'Electricity bill',category:'Utilities',method:'UPI'},
        {id:generateId(),type:'opening_balance',date:isoDaysAgo(30),amount:50000,desc:'Opening cash',category:'Opening',method:'Cash'},
        {id:generateId(),type:'expense',date:isoDaysAgo(5),amount:8000,desc:'Mutual fund SIP',category:'Investment',method:'UPI'}
      ];
      saveToLocal();
      renderRecentEntries();
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
      alert('Sample data loaded');
    }

    function isoDaysAgo(n){
      const d = new Date(); d.setDate(d.getDate()-n);
      return d.toISOString().slice(0,10);
    }

    function generateId(){ return Date.now() + Math.floor(Math.random()*1000); }

    /* ---------------------------
       Entry form logic
       --------------------------- */
    function onTypeChange(){
      const t = $('type').value;
      $('incomeSourceRow').classList.add('hidden');
      $('investmentRow').classList.add('hidden');
      $('insuranceRow').classList.add('hidden');
      $('openingBalanceRow').classList.add('hidden');
      if(t==='income') $('incomeSourceRow').classList.remove('hidden');
      if(t==='expense' && $('category').value==='Investment') $('investmentRow').classList.remove('hidden');
      if(t==='opening_balance') $('openingBalanceRow').classList.remove('hidden');
    }

    function onOpeningTypeChange(){
      const v = $('openingType').value;
      if(v==='Investment'){
        $('openingGroupContainer').classList.remove('hidden');
        $('openingSubContainer').classList.remove('hidden');
        const og = $('openingGroup'); og.innerHTML='';
        Object.keys(invBuckets).forEach(k=> { const o=document.createElement('option'); o.value=k; o.textContent=k; og.appendChild(o); });
      } else {
        $('openingGroupContainer').classList.add('hidden');
        $('openingSubContainer').classList.add('hidden');
      }
    }

    function addEntry(){
      const type = $('type').value;
      const amount = parseFloat($('amount').value) || 0;
      const date = $('date').value || new Date().toISOString().slice(0,10);
      const desc = $('desc').value || '';
      const category = $('category').value || 'Other';
      const method = $('method').value || 'Cash';
      const id = generateId();
      const entry = { id, type, amount, date, desc, category, method };
      if(type==='income') entry.source = $('incomeSource').value || '';
      if(type==='opening_balance') entry.openingType = $('openingType').value || '';
      transactions.unshift(entry);
      saveToLocal();
      if(USE_FIRESTORE && auth && auth.currentUser) syncToCloud();
      renderRecentEntries();
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
      $('amount').value=''; $('desc').value='';
      alert('Entry added');
    }

    function editEntry(id){
      const tx = transactions.find(t=>t.id===id);
      if(!tx) return alert('Not found');
      $('type').value = tx.type;
      $('amount').value = tx.amount;
      $('date').value = tx.date;
      $('desc').value = tx.desc;
      $('category').value = tx.category;
      $('method').value = tx.method;
      onTypeChange();
      $('addBtn').classList.add('hidden');
      $('saveBtn').classList.remove('hidden');
      $('cancelBtn').classList.remove('hidden');
      $('saveBtn').onclick = ()=> saveEdit(id);
      $('cancelBtn').onclick = ()=> cancelEdit();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function saveEdit(id){
      const tx = transactions.find(t=>t.id===id);
      if(!tx) return;
      tx.type = $('type').value;
      tx.amount = parseFloat($('amount').value) || 0;
      tx.date = $('date').value;
      tx.desc = $('desc').value;
      tx.category = $('category').value;
      tx.method = $('method').value;
      saveToLocal();
      if(USE_FIRESTORE && auth && auth.currentUser) syncToCloud();
      renderRecentEntries();
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
      cancelEdit();
    }

    function cancelEdit(){
      $('addBtn').classList.remove('hidden');
      $('saveBtn').classList.add('hidden');
      $('cancelBtn').classList.add('hidden');
      $('amount').value=''; $('desc').value='';
    }

    function clearAllTransactions(){
      if(!confirm('Clear all transactions? This cannot be undone.')) return;
      transactions = [];
      saveToLocal();
      renderRecentEntries();
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
    }

    /* ---------------------------
       Recent entries rendering
       --------------------------- */
    function renderRecentEntries(){
      const tbody = document.querySelector('#recentTable tbody');
      tbody.innerHTML = '';
      const limit = $('entryLimit').value;
      let list = transactions.slice();
      if(limit!=='all') list = list.slice(0, parseInt(limit));
      list.forEach(tx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><span style="padding:6px 8px;border-radius:8px;font-weight:700;background:${tx.type==='income'?'#dcfce7':tx.type==='opening_balance'?'#efe6ff':'#fee2e2'};color:${tx.type==='income'?'#166534':tx.type==='opening_balance'?'#6b21a8':'#991b1b'}">${tx.type}</span></td>
                        <td>${tx.date}</td>
                        <td>₹${formatNumber(tx.amount)}</td>
                        <td>${escapeHtml(tx.desc)}</td>
                        <td>${escapeHtml(tx.category)}</td>
                        <td>${escapeHtml(tx.method)}</td>
                        <td><div style="display:flex;gap:6px"><button class="btn-outline" onclick="editEntry(${tx.id})">Edit</button><button class="btn-outline" onclick="deleteEntry(${tx.id})">Delete</button></div></td>`;
        tbody.appendChild(tr);
      });
    }

    function deleteEntry(id){
      if(!confirm('Delete this entry?')) return;
      transactions = transactions.filter(t=>t.id!==id);
      saveToLocal();
      if(USE_FIRESTORE && auth && auth.currentUser) syncToCloud();
      renderRecentEntries();
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
    }

    /* ---------------------------
       Charts
       --------------------------- */
    function renderCharts(){
      const ctx = document.getElementById('mainChart').getContext('2d');
      const range = $('mainChartFilter').value;
      const labels = generateMonthLabels(range);
      const incomeSeries = labels.map(l => sumByMonth(l, 'income'));
      const expenseSeries = labels.map(l => sumByMonth(l, 'expense'));
      if(mainChart) mainChart.destroy();
      mainChart = new Chart(ctx, {
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:'Income', data: incomeSeries, backgroundColor: 'rgba(37,99,235,0.85)' },
            { label:'Expenses', data: expenseSeries, backgroundColor: 'rgba(239,68,68,0.85)' }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          plugins:{legend:{position:'top'}}
        }
      });

      const totalIncome = incomeSeries.reduce((a,b)=>a+b,0);
      const totalExpense = expenseSeries.reduce((a,b)=>a+b,0);
      $('kpiIncome').textContent = '₹' + formatNumber(totalIncome);
      $('kpiExpense').textContent = '₹' + formatNumber(totalExpense);
      $('kpiNet').textContent = '₹' + formatNumber(totalIncome - totalExpense);
    }

    function renderWalletUnified(){
      const mode = $('walletMode').value;
      const ctx = document.getElementById('donutChart').getContext('2d');
      const catTotals = {};
      transactions.forEach(t => {
        const key = t.category || 'Other';
        catTotals[key] = (catTotals[key]||0) + (t.type==='expense' ? t.amount : t.amount);
      });
      const labels = Object.keys(catTotals).slice(0,10);
      const data = labels.map(l=>catTotals[l]);
      if(donutChart) donutChart.destroy();
      donutChart = new Chart(ctx, {
        type:'doughnut',
        data:{ labels, datasets:[{ data, backgroundColor: generateColors(labels.length) }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
      const legend = $('walletLegend'); legend.innerHTML = labels.map((l,i)=>`<div style="display:flex;justify-content:space-between"><span>${l}</span><span>₹${formatNumber(data[i])}</span></div>`).join('');
    }

    function renderInvBreakdownCharts(){
      const barCtx = document.getElementById('invBreakdownBar').getContext('2d');
      const pieCtx = document.getElementById('invBreakdownPie').getContext('2d');
      const buckets = Object.keys(invBuckets);
      const values = buckets.map(b => (invBuckets[b]||[]).reduce((s,it)=>s+(it.value||0),0));
      if(invBar) invBar.destroy();
      if(invPie) invPie.destroy();
      invBar = new Chart(barCtx, { type:'bar', data:{ labels:buckets, datasets:[{ label:'Value', data:values, backgroundColor: generateColors(buckets.length) }] }, options:{responsive:true,maintainAspectRatio:false} });
      invPie = new Chart(pieCtx, { type:'pie', data:{ labels:buckets, datasets:[{ data:values, backgroundColor: generateColors(buckets.length) }] }, options:{responsive:true,maintainAspectRatio:false} });

      const quick = $('invQuickSubs'); quick.innerHTML = '';
      buckets.forEach(b => {
        const items = invBuckets[b] || [];
        const total = items.reduce((s,it)=>s+(it.value||0),0);
        const card = document.createElement('div'); card.className='quick-sub-card';
        card.innerHTML = `<div class="quick-sub-header"><div class="quick-sub-title">${b}</div><div class="total-badge">₹${formatNumber(total)}</div></div>
                          <div style="margin-top:8px;font-size:12px;color:var(--text-muted)">${items.map(it=>`${it.name}: ₹${formatNumber(it.value)}`).join('<br>') || '—'}</div>`;
        quick.appendChild(card);
      });

      const totalInv = values.reduce((a,b)=>a+b,0);
      $('kpiInvest').textContent = '₹' + formatNumber(totalInv);
    }

    function renderAnalyticsCharts(){
      const netCtx = document.getElementById('analyticsNetWorth').getContext('2d');
      const bucketCtx = document.getElementById('analyticsBucketChart').getContext('2d');
      const labels = generateMonthLabels(12);
      const netData = labels.map((l,i)=>100000 + i*2000 - Math.random()*5000);
      if(analyticsNet) analyticsNet.destroy();
      analyticsNet = new Chart(netCtx, { type:'line', data:{ labels, datasets:[{ label:'Net worth', data:netData, borderColor: 'rgba(37,99,235,0.9)', fill:false }] }, options:{responsive:true,maintainAspectRatio:false} });
      if(analyticsBucket) analyticsBucket.destroy();
      analyticsBucket = new Chart(bucketCtx, { type:'bar', data:{ labels:Object.keys(invBuckets), datasets:[{ label:'Bucket value', data:Object.keys(invBuckets).map(k=> (invBuckets[k]||[]).reduce((s,it)=>s+(it.value||0),0)), backgroundColor: generateColors(Object.keys(invBuckets).length) }] }, options:{responsive:true,maintainAspectRatio:false} });
    }

    /* ---------------------------
       Wallet checklist handlers
       --------------------------- */
    function applyWalletChecklist(){
      const checked = Array.from(document.querySelectorAll('#walletChecklistItems input[type=checkbox]:checked')).map(i=>i.value);
      if(checked.length===0) {
        alert('No categories selected. Showing all.');
        renderWalletUnified();
        $('walletCategoryChecklist').classList.add('hidden');
        return;
      }
      const totals = {};
      transactions.forEach(t => {
        if(checked.includes(t.category)) totals[t.category] = (totals[t.category]||0) + (t.type==='expense' ? t.amount : t.amount);
      });
      const labels = Object.keys(totals);
      const data = labels.map(l=>totals[l]);
      if(donutChart) donutChart.destroy();
      const ctx = document.getElementById('donutChart').getContext('2d');
      donutChart = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor: generateColors(labels.length) }] }, options:{responsive:true,maintainAspectRatio:false} });
      $('walletCategoryChecklist').classList.add('hidden');
      $('resetExpenseDrilldown').classList.remove('hidden');
    }

    function clearWalletChecklist(){
      document.querySelectorAll('#walletChecklistItems input[type=checkbox]').forEach(i=>i.checked=false);
      renderWalletUnified();
    }

    function resetExpenseDrilldown(){
      renderWalletUnified();
      $('resetExpenseDrilldown').classList.add('hidden');
    }

    /* ---------------------------
       Settings handlers
       --------------------------- */
    function addMethod(){
      const v = $('newMethod').value.trim();
      if(!v) return alert('Enter method name');
      methods.push(v);
      $('newMethod').value='';
      renderStaticLists();
      renderMethodEditor();
      saveToLocal();
    }

    function renderMethodEditor(){
      const el = $('methodEditor'); if(!el) return;
      el.innerHTML='';
      methods.forEach(m => {
        const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center'; d.style.marginBottom='6px';
        d.innerHTML = `<div>${m}</div><div><button class="btn-outline" onclick="removeMethod('${escapeJs(m)}')">Remove</button></div>`;
        el.appendChild(d);
      });
    }

    function removeMethod(name){
      methods = methods.filter(m=>m!==name);
      renderStaticLists();
      renderMethodEditor();
      saveToLocal();
    }

    function addIncome(){
      const v = $('newIncome').value.trim();
      if(!v) return alert('Enter income source');
      incomeSources.push(v);
      $('newIncome').value='';
      renderStaticLists();
      renderIncomeList();
      saveToLocal();
    }

    function renderIncomeList(){
      const el = $('incomeList'); if(!el) return;
      el.innerHTML='';
      incomeSources.forEach(i => {
        const b = document.createElement('div'); b.style.display='flex'; b.style.alignItems='center'; b.style.gap='6px';
        b.innerHTML = `<div style="padding:6px 8px;border:1px solid var(--border);border-radius:8px">${i}</div><button class="btn-outline" onclick="removeIncome('${escapeJs(i)}')">Remove</button>`;
        el.appendChild(b);
      });
    }

    function removeIncome(name){
      incomeSources = incomeSources.filter(i=>i!==name);
      renderStaticLists();
      renderIncomeList();
      saveToLocal();
    }

    function saveCCLimit(){
      const v = $('ccLimitInput').value;
      if(!v) return alert('Enter limit');
      $('ccLimitDisplay').textContent = '₹' + formatNumber(parseFloat(v));
      $('ccLimitInput').value='';
      saveToLocal();
      alert('Saved');
    }

    function factoryReset(){
      if(!confirm('Factory reset will clear all local data. Continue?')) return;
      localStorage.removeItem('mm_state');
      transactions = [];
      methods = ['Cash','UPI','Card'];
      incomeSources = ['Salary'];
      categories = ['Salary','Groceries','Rent','Utilities','Investment','Entertainment','Travel','Health','Other'];
      invBuckets = { 'Equity':[], 'Debt':[], 'Mutual Funds':[], 'ETFs':[], 'Crypto':[], 'Real Estate':[], 'Commodities':[], 'Other':[] };
      renderStaticLists();
      renderMethodEditor();
      renderIncomeList();
      populateWalletChecklist();
      populateInvBucketFilters();
      renderRecentEntries();
      renderCharts();
      renderWalletUnified();
      renderInvBreakdownCharts();
      alert('Factory reset complete.');
    }

    function exportBackup(){
      const state = { transactions, methods, incomeSources, categories, invBuckets };
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'moneymirror-backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ---------------------------
       Import / Export CSV & JSON
       --------------------------- */
    function handleFileImport(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const text = ev.target.result;
        if(file.name.endsWith('.csv')){
          const parsed = parseCSV(text);
          parsed.forEach(row => {
            const entry = { id: generateId(), type: row.type || 'expense', date: row.date || new Date().toISOString().slice(0,10), amount: parseFloat(row.amount)||0, desc: row.desc||'', category: row.category||'Other', method: row.method||'Cash' };
            transactions.unshift(entry);
          });
          saveToLocal();
          renderRecentEntries();
          renderCharts();
          renderWalletUnified();
          renderInvBreakdownCharts();
          alert('CSV imported');
        } else {
          try {
            const obj = JSON.parse(text);
            if(Array.isArray(obj)) {
              obj.forEach(row => { row.id = row.id || generateId(); transactions.unshift(row); });
            } else if(obj.transactions) {
              transactions = obj.transactions.concat(transactions);
            } else {
              alert('JSON format not recognized');
            }
            saveToLocal();
            renderRecentEntries();
            renderCharts();
            renderWalletUnified();
            renderInvBreakdownCharts();
            alert('JSON imported');
          } catch(err){ alert('Failed to parse file'); }
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function exportCSV(){
      if(transactions.length===0) return alert('No transactions to export');
      const header = ['type','date','amount','desc','category','method'];
      const rows = transactions.map(t => [t.type,t.date,t.amount,escapeCsv(t.desc),t.category,t.method].map(v=>String(v||'')).join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'moneymirror-transactions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
      if(lines.length===0) return [];
      const headers = lines[0].split(',').map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCsvLine(lines[i]);
        const obj = {};
        headers.forEach((h,idx)=> obj[h] = cols[idx] || '');
        out.push(obj);
      }
      return out;
    }

    function splitCsvLine(line){
      const res = []; let cur=''; let inQuotes=false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch==='\"'){ inQuotes = !inQuotes; continue; }
        if(ch===',' && !inQuotes){ res.push(cur); cur=''; continue; }
        cur += ch;
      }
      res.push(cur);
      return res;
    }

    function escapeCsv(s){ if(s==null) return ''; return `"${String(s).replace(/"/g,'""')}"`; }

    /* ---------------------------
       Utilities
       --------------------------- */
    function formatNumber(n){ return (Math.round(n*100)/100).toLocaleString('en-IN'); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeJs(s){ return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }

    function generateMonthLabels(range){
      const months = [];
      const r = range==='all' ? 12 : parseInt(range);
      const now = new Date();
      for(let i=r-1;i>=0;i--){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        months.push(d.toLocaleString('default',{month:'short',year:'numeric'}));
      }
      return months;
    }

    function sumByMonth(label, type){
      const [mon,yr] = label.split(' ');
      const idx = new Date(Date.parse(mon +" 1, " + yr)).getMonth();
      let sum=0;
      transactions.forEach(t=>{
        const d = new Date(t.date);
        if(d.getMonth()===idx && d.getFullYear()===parseInt(yr)){
          if(type==='income' && t.type==='income') sum+=t.amount;
          if(type==='expense' && t.type==='expense') sum+=t.amount;
        }
      });
      return sum;
    }

    function generateColors(n){
      const palette = ['#2563eb','#10b981','#f59e0b','#ef4444','#7c3aed','#0ea5e9','#14b8a6','#22c55e','#eab308','#f97316','#374151','#8b5cf6'];
      const out=[];
      for(let i=0;i<n;i++) out.push(palette[i%palette.length]);
      return out;
    }

    /* ---------------------------
       Calculator (robust)
       --------------------------- */
    let calcVisible=false;
    let calcExpr='';
    function toggleCalculator(force){
      if(typeof force === 'boolean') calcVisible = force;
      else calcVisible = !calcVisible;
      document.getElementById('calculator').style.display = calcVisible ? 'flex' : 'none';
    }

    function initCalculator(){
      const display = document.getElementById('calc-display');
      const preview = document.getElementById('calc-preview');
      calcExpr = '';
      function update(){
        display.textContent = calcExpr || '0';
        try { preview.textContent = calcExpr ? formatNumber(evalSafe(calcExpr)) : ''; } catch(e){ preview.textContent = ''; }
      }
      document.querySelectorAll('#calc-buttons button').forEach(btn=>{
        btn.addEventListener('click', ()=> {
          const key = btn.getAttribute('data-key');
          if(!key) return;
          if(key==='C'){ calcExpr=''; update(); return; }
          if(key==='='){ try { const res = evalSafe(calcExpr); calcExpr = String(res); update(); } catch(e){ alert('Invalid expression'); } return; }
          calcExpr += key;
          update();
        });
      });
      document.addEventListener('keydown', (e)=>{
        if(!calcVisible) return;
        const allowed = '0123456789+-*/().';
        if(allowed.includes(e.key)) { calcExpr += e.key; update(); e.preventDefault(); }
        if(e.key==='Enter'){ try { calcExpr = String(evalSafe(calcExpr)); update(); } catch(e){ alert('Invalid expression'); } e.preventDefault(); }
        if(e.key==='Backspace'){ calcExpr = calcExpr.slice(0,-1); update(); e.preventDefault(); }
        if(e.key==='Escape'){ toggleCalculator(false); e.preventDefault(); }
      });
      $('calc-copy').addEventListener('click', copyCalcResult);
    }

    function copyCalcResult(){
      const display = document.getElementById('calc-display').textContent || '';
      navigator.clipboard && navigator.clipboard.writeText(display).then(()=> alert('Copied'), ()=> alert('Copy failed'));
    }

    function evalSafe(s){
      if(!s) return 0;
      if(!/^[0-9+\-*/().\s]+$/.test(s)) throw new Error('Invalid chars');
      return Function('"use strict";return ('+s+')')();
    }

    /* ---------------------------
       Misc
       --------------------------- */
    function updateDateDisplay(){
      const d = new Date();
      $('currentDate').textContent = d.toLocaleString();
    }

    // Expose functions for inline onclicks
    window.editEntry = editEntry;
    window.deleteEntry = deleteEntry;
    window.removeMethod = removeMethod;
    window.removeIncome = removeIncome;
    window.resetExpenseDrilldown = resetExpenseDrilldown;

    // Initial render
    renderMethodEditor();
    renderIncomeList();
    populateWalletChecklist();
    populateInvBucketFilters();
    renderCharts();
    renderWalletUnified();
    renderInvBreakdownCharts();
    renderAnalyticsCharts();

  </script>
</body>
</html>
