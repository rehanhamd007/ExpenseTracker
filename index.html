<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MoneyMirror — v5.0.9 (Fixed Stable)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@4.2.3/dist/chartjs-chart-treemap.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;

      /* 3D KPI theme accents */
      --kpi-elev-shadow: 0 12px 24px rgba(2, 6, 23, 0.16), 0 6px 12px rgba(2, 6, 23, 0.08);
      --kpi-inner-shadow: inset 0 1px 0 rgba(255,255,255,0.85);
      --kpi-border: rgba(148, 163, 184, 0.45);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* LAYOUT */
    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.3s; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(0px); transition: filter 0.3s; }

    /* BRAND & NAV */
    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }

    /* NEW: Quick index add in sidebar */
    .nav-helper { padding: 8px 10px; border-radius: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); margin-top: 8px; }
    .nav-helper label { display:block; font-size:10px; color:#93a4b8; margin-bottom:6px; text-transform: uppercase; letter-spacing:0.5px; }
    .nav-helper select { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.18); background:#0b1323; color:#e5edf6; font-size:12px; }
    .nav-helper button { width:100%; margin-top:8px; padding:8px 10px; border-radius:6px; border:none; font-size:12px; font-weight:600; background:var(--primary); color:white; cursor:pointer; }

    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    .cc-slider-wrap { margin-top: 12px; }
    .cc-slider-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; position: relative; }
    .cc-slider-fill { height: 100%; background: linear-gradient(to right, #f97316, #f59e0b); width: 0%; transition: width 0.4s ease; }
    .cc-slider-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    /* --- ENHANCED CARD BASE STYLES --- */
    .kpi-card {
        transition: all 0.2s ease-in-out;
        border-left: 4px solid var(--sidebar-active);
        position: relative;
        overflow: hidden; 
    }
    .kpi-card:hover {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        transform: translateY(-2px);
    }

    /* --- HIERARCHY & STRUCTURE --- */
    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .kpi-icon {
        font-size: 1.25rem;
        color: var(--sidebar-active);
    }
    .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 0.5rem;
        color: var(--text-main);
    }
    .kpi-change-section {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        margin-top: 0.75rem;
    }

    /* --- COLOR CODING (Status Indicators) --- */
    .kpi-change-text {
        font-weight: 600;
        margin-left: 0.5rem;
        padding: 0.1rem 0.5rem;
        border-radius: 0.25rem;
        white-space: nowrap;
    }

    .kpi-positive {
        color: #10b981;
        background-color: #d1fae5;
    }
    .kpi-negative {
        color: #ef4444;
        background-color: #fee2e2;
    }
    .kpi-neutral {
        color: #4b5563;
        background-color: #e5e7eb;
    }

    /* --- TOTAL INVESTMENT CARD SPECIFIC STYLES --- */
    #total-investment-card {
        border-left: 4px solid #f97316;
    }
    .breakdown-link {
        text-align: right;
        margin-top: 1rem;
    }
    .breakdown-link button {
        background: none;
        border: none;
        color: var(--sidebar-active);
        font-weight: 500;
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.9rem;
    }

    /* AUTH GATE (FIXED) */
    #authGate {
      position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999;
      display: none;
      flex-direction: column; justify-content: center; align-items: center;
      gap: 10px; color: white; text-align: center; padding: 0 24px;
    }
    #authGate.show { display: flex; }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    /* UI ELEMENTS */
    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    /* Base card */
    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; flex-wrap: wrap; gap: 10px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); white-space: nowrap; }

    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; min-width: 120px; flex-grow: 1; }
    .input-group-med { width: 25%; min-width: 180px; flex-grow: 1; }
    .input-group-large { width: 45%; min-width: 250px; flex-grow: 1; }

    /* KPI cards — 3D styling */
    .kpi-card {
      padding: 20px;
      border: 1px solid var(--kpi-border);
      box-shadow: var(--kpi-elev-shadow);
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      position: relative;
      isolation: isolate;
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      box-shadow: var(--kpi-inner-shadow);
      pointer-events: none;
    }
    .kpi-income { border-left: 6px solid var(--success); }
    .kpi-expense { border-left: 6px solid var(--danger); }
    .kpi-cc { border-left: 6px solid var(--warning); }
    .kpi-net { border-left: 6px solid var(--primary); }
    .kpi-invest { border-left: 6px solid #075985; }

    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    .cc-alert-high { border-color: var(--danger) !important; box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.2) !important; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; white-space: nowrap; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted); }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600; color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1400px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 95vh; display:flex; flex-direction:column; overflow: hidden; }
    .modal-pad { padding: 24px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-small { width: 90%; max-width: 400px; height: auto; max-height: 90vh; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Calculator */
    #calculator { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 480px; max-height: 80vh; z-index: 3000; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #f8fafc; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    .calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close { background: transparent; border: none; color: #ef4444; font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    .calc-screen { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    .calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; touch-action: manipulation; }
    .calc-buttons button:hover { background: #f1f5f9; }
    .operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .equal { grid-row: span 2; background: var(--primary) !important; color: white !important; }
    #calc-toggle { position: fixed; bottom: 20px; right: 300px; margin-left: 10px; padding: 8px 12px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; z-index: 3001; }

    /* Breakdown Grid */
    .kpi-breakdown-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: white; display:flex; flex-direction:column; justify-content:space-between; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }

    /* Dropdowns */
    .sub-dropdown-container { position: relative; }
    .sub-dropdown-menu { position: absolute; top: 36px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px 0; width: 100%; min-width: 240px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50; display: none; max-height: 300px; overflow-y: auto; }
    .sub-dropdown-menu.show { display: block; }
    .sub-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; font-size: 12px; color: var(--text-main); border-bottom: 1px solid #f1f5f9; }
    .sub-dropdown-item:last-child { border-bottom: none; }

    .multiselect-container { position: relative; }
    .multiselect-dropdown { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 220px; padding: 10px; z-index: 60; display: none; }
    .multiselect-dropdown.show { display: block; }
    .ms-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; cursor: pointer; }
    .ms-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0; }

    /* Mobile adjustments */
    @media (max-width: 1024px) {
        aside { position: fixed; left: -260px; height: 100vh; top: 0; }
        aside.mobile-open { left: 0; }
        main { padding: 15px; gap: 15px; }
        .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
        .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
        .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer { width: 100% !important; min-width: 100%; }
        .action-body { gap: 12px; }
        .kpi-breakdown-grid { grid-template-columns: 1fr; }
        #invQuickSubs { grid-template-columns: 1fr !important; }
        .card-header { align-items: flex-start; }
        #mobileMenuBtn { display: block; position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--sidebar-bg); border-radius: 6px; padding: 8px 12px; }
        .brand { margin-left: 50px; }
        .sidebar-footer { margin-top: auto; }
        #calculator { width: 90%; right: 5%; bottom: 80px; }
        #calc-toggle { right: 5%; bottom: 20px; }
    }
  </style>
</head>
<body>

  <div id="authGate" class="show">
    <div class="line line-1">Welcome to MoneyMirror v5.0.9</div>
    <div class="line line-3">The single-file, comprehensive finance tracker.</div>
    <div class="line line-2">Please Sign In or use Guest Mode.</div>
    <button class="btn-primary" onclick="signInWithGoogle()">Sign in with Google</button>
    <button class="btn-outline" style="margin-top:10px" onclick="startGuestMode()">Continue as Guest (Local Mode)</button>
  </div>

  <aside id="sidebar">
    <div id="mobileMenuBtn">
      <span class="icon-menu">☰</span>
      <span class="icon-close hidden">X</span>
    </div>

    <div class="brand">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
      Money<span>Mirror</span>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main</div>
        <a href="#" data-section="dashboard" class="nav-item active">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M18.7 8L12 14.7l-4.7-4.7L3 16"></path></svg>
          <span>Dashboard</span>
        </a>
        <a href="#" data-section="dataEntry" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
          <span>Data Entry & List</span>
        </a>
        <a href="#" data-section="investmentTracker" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15.6l-2.4-1.3"></path><path d="M15.4 14.2l-2.4-1.3"></path><path d="M9.6 12.8l-2.4-1.3"></path><path d="M12 21l9.2-5.1"></path><path d="M12 3l9.2 5.1"></path><path d="M12 21L2.8 15.9"></path><path d="M12 3L2.8 8.1"></path><path d="M2.8 8.1l9.2 5.1 9.2-5.1"></path><path d="M2.8 15.9l9.2 5.1 9.2-5.1"></path><path d="M12 3v18"></path></svg>
          <span>Investment Tracker</span>
        </a>
        <a href="#" data-section="advancedAnalytics" class="nav-item" id="navAnalytics">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 12c0-3.3-2.7-6-6-6H12v6h3.5c1.9 0 3.5 1.6 3.5 3.5v.5"></path><path d="M12 12V3"></path><path d="M12 12V21"></path><path d="M12 12H3"></path><path d="M12 12H21"></path></svg>
          <span>Advanced Analytics</span>
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-label">Tools</div>
        <a href="#" data-section="settings" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.49 1.49 0 0 0-1.03-.49L16 14.5a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1l2.37-.01c.52 0 1-.36 1.03-.88l.68-2.92a1 1 0 0 0-1.35-1.35l-2.92.68c-.52.03-.88.51-.88 1.03l-.01 2.37a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V5.5a1 1 0 0 0-1-1L5.5 3.63a1 1 0 0 0-1.35 1.35l.68 2.92c.03.52.39 1.01 1.03 1.03l2.37.01a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1l-2.37.01c-.52 0-1 .36-1.03.88l-.68 2.92a1 1 0 0 0 1.35 1.35l2.92-.68c.52-.03.88-.51.88-1.03l.01-2.37a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 0 1 1l2.92.68a1 1 0 0 0 1.35-1.35l-.68-2.92c-.03-.52-.39-1.01-1.03-1.03z"></path></svg>
          <span>Settings & Import</span>
        </a>
        <a href="#marketSettingsModal" class="nav-item openModal" data-modal-id="marketSettingsModal" style="text-decoration:none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"></path><path d="M19 9l-5 5-4-4-3 3"></path></svg>
          <span>Market Ticker</span>
        </a>
      </div>
      
      <div class="nav-helper">
        <label>Quick add index</label>
        <select id="sidebarIndexSelect">
          <option value="">Choose...</option>
          <option value="NIFTY_50|Nifty 50">Nifty 50 (India)</option>
          <option value="^GSPC|S&P 500">S&P 500 (US)</option>
          <option value="^IXIC|NASDAQ">NASDAQ (US)</option>
          <option value="^DJI|Dow Jones">Dow Jones (US)</option>
          <option value="^FTSE|FTSE 100">FTSE 100 (UK)</option>
        </select>
        <button id="addSidebarIndexBtn">Add & Track</button>
      </div>

    </nav>

    <div class="sidebar-footer mt-auto">
      <div class="sys-stat">
        <span>Current Profile:</span>
        <span class="sys-val" id="profileNameDisplay">Guest (Offline)</span>
      </div>
      <div class="sys-stat">
        <span>Last Sync:</span>
        <span class="sys-val" id="lastSyncDisplay">Never</span>
      </div>
      <div class="sys-stat" style="margin-top: 8px;">
        <button id="logoutBtn" class="btn-outline" style="width: 100%; display:none;">Sign Out</button>
      </div>
    </div>
  </aside>

  <main>
    
    <div id="marketTickerContainer" style="position: sticky; top: -24px; left: -24px; right: -24px; height: 32px; background: var(--sidebar-bg); border-bottom: 1px solid rgba(255,255,255,0.1); overflow: hidden; white-space: nowrap; z-index: 50; padding: 0 24px;">
      <div id="marketTicker" style="display: inline-block; animation: ticker 40s linear infinite; height: 100%; display: flex; align-items: center; gap: 40px; color: white; font-size: 13px;">
        </div>
    </div>
    <style>
      @keyframes ticker {
          0% { transform: translate3d(0, 0, 0); }
          100% { transform: translate3d(-50%, 0, 0); } /* Scrolls two copies of the list */
      }
      .ticker-item { display: inline-block; margin-right: 40px; }
      .positive { color: var(--success); }
      .negative { color: var(--danger); }
    </style>

    <section id="dashboard" class="content-section">
      <h2 style="margin-top:0">Dashboard Overview</h2>
      
      <div class="dashboard-grid">
        
        <div id="netWorthCard" class="kpi-card kpi-net">
          <div class="kpi-header">
            <span class="card-title">Net Worth</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          </div>
          <div class="kpi-value" id="netWorthValue">₹0.00</div>
          <div class="kpi-sub">
            <span id="netWorthTrendIcon"></span>
            <span id="netWorthTrendText"></span>
          </div>
        </div>

        <div class="kpi-card kpi-income">
          <div class="kpi-header">
            <span class="card-title">Month's Income</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
          </div>
          <div class="kpi-value" id="incomeValue">₹0.00</div>
          <div class="kpi-sub">
            <span id="incomeTrendIcon"></span>
            <span id="incomeTrendText"></span>
          </div>
        </div>

        <div class="kpi-card kpi-expense">
          <div class="kpi-header">
            <span class="card-title">Month's Expense</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          </div>
          <div class="kpi-value" id="expenseValue">₹0.00</div>
          <div class="kpi-sub">
            <span id="expenseTrendIcon"></span>
            <span id="expenseTrendText"></span>
          </div>
        </div>

        <div id="ccCard" class="kpi-card kpi-cc">
          <div class="kpi-header">
            <span class="card-title">Credit Card Due</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
          </div>
          <div class="kpi-value" id="ccDueValue">₹0.00</div>
          <div class="cc-slider-wrap">
            <div class="cc-slider-bar"><div id="ccSliderFill" class="cc-slider-fill"></div></div>
            <div id="ccLimitLabels" class="cc-slider-labels"><span>0%</span><span>₹0.00 / ₹0.00</span></div>
          </div>
        </div>
        
        <div id="total-investment-card" class="kpi-card kpi-invest">
            <div class="kpi-header">
                <span class="card-title">Total Investment Return (YTD)</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/><path d="M15.5 8.5L12 12l3.5 3.5"></path></svg>
            </div>
            <div class="kpi-value" id="invTotalReturn">₹0.00</div>
            <div class="kpi-change-section">
                <span id="invReturnPct" class="kpi-change-text kpi-neutral">0.00%</span>
                <span class="text-xs text-gray-500 ml-2" id="invTotalInvested">(Invested: ₹0.00)</span>
            </div>
            <div class="breakdown-link">
                <button onclick="window.location.hash='#investmentTracker'; document.getElementById('investmentTracker').classList.remove('hidden'); document.getElementById('dashboard').classList.add('hidden'); renderInvestmentKPICharts();">View Breakdown &rarr;</button>
            </div>
        </div>

        <div class="card col-span-2">
          <div class="card-header">
            <span class="card-title">Account Balances (Cash)</span>
            <small class="text-muted text-xs">Total Cash: <span id="totalCashValue" class="font-semibold text-main">₹0.00</span></small>
          </div>
          <div class="card-body" style="padding-top:0;">
            <div id="accountList" class="account-list">
              </div>
          </div>
        </div>
        
        <div class="card col-span-1" style="min-height: 250px;">
          <div class="card-header">
            <span class="card-title">Income vs Expense (This Month)</span>
          </div>
          <div class="card-body" style="flex:1;">
            <canvas id="incomeExpenseChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card col-span-4" style="min-height: 400px;">
        <div class="card-header">
          <span class="card-title">Net Worth Trend (All Time)</span>
        </div>
        <div class="card-body" style="flex:1;">
          <canvas id="netWorthChart"></canvas>
        </div>
      </div>
      
    </section>

    <section id="dataEntry" class="content-section hidden">
      <h2 style="margin-top:0">Data Entry & Full Transaction List</h2>
      
      <div class="action-card">
        <div class="action-header">
          <div class="card-title" id="formTitle">Add New Transaction</div>
          <button id="resetFormBtn" class="btn-outline" style="background:transparent; color:white; border-color:white; padding:4px 10px">Clear Form</button>
        </div>
        <form id="transactionForm" class="action-body">
          
          <div class="input-group-small">
            <label for="type">Type</label>
            <select id="type" required>
              <option value="expense">Expense</option>
              <option value="income">Income</option>
              <option value="opening_balance">Opening Balance</option>
              <option value="credit_card_payment">Credit Card Payment</option>
            </select>
          </div>

          <div class="input-group-small">
            <label for="amount">Amount (₹)</label>
            <input type="number" id="amount" step="0.01" required placeholder="1234.50" />
          </div>
          
          <div class="input-group-small">
            <label for="date">Date</label>
            <input type="date" id="date" required />
          </div>

          <div class="input-group-large full-width">
            <label for="description">Description / Payee</label>
            <input type="text" id="description" required placeholder="Rent, Salary, Groceries..." />
          </div>
          
          <div class="input-group-med" id="categoryContainer">
            <label for="category">Category / Source</label>
            <select id="category" required></select>
          </div>
          
          <div class="input-group-med" id="methodContainer">
            <label for="method">Method / Account</label>
            <select id="method" required></select>
          </div>
          
          <div class="input-group-med hidden" id="investmentGroupContainer">
            <label for="investmentGroup">Investment Group</label>
            <select id="investmentGroup">
              <option value="">Select Group</option>
            </select>
          </div>

          <div class="input-group-med hidden" id="investmentSubContainer">
            <label for="investmentSub">Investment Subcategory</label>
            <input type="text" id="investmentSub" placeholder="E.g., Stocks, Mutual Funds, Gold" />
          </div>
          
          <div class="input-group-med hidden" id="incomeSourceContainer">
            <label for="incomeSource">Income Source</label>
            <select id="incomeSource">
              <option value="">Select Source</option>
            </select>
          </div>

          <div class="input-group-small full-width" style="display:flex; justify-content:flex-end;">
            <button type="submit" class="btn-primary" id="saveEntryBtn">Save Entry</button>
          </div>
          
        </form>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Transaction History</span>
          <div class="flex-row">
            <input type="text" id="filterText" placeholder="Search description..." style="width: 200px;" />
            <select id="filterType" style="width: 150px;">
                <option value="">All Types</option>
                <option value="expense">Expense</option>
                <option value="income">Income</option>
                <option value="opening_balance">Opening Balance</option>
                <option value="credit_card_payment">CC Payment</option>
            </select>
          </div>
        </div>
        <div class="card-body" style="padding:0;">
          <div class="table-container">
            <table id="dataList">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>Method</th>
                  <th style="text-align:right;">Amount (₹)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>
          <div id="dataListFooter" class="card-header" style="justify-content:center;">
             <span class="text-muted text-sm">No transactions found.</span>
          </div>
        </div>
      </div>
    </section>

    <section id="investmentTracker" class="content-section hidden">
      <h2 style="margin-top:0">Investment Performance & Breakdown</h2>
      
      <div class="dashboard-grid">
        <div class="card col-span-4 card-header" style="padding-bottom:10px;">
            <span class="card-title">Investment Overview</span>
            <div class="flex-row">
              <select id="invDateRange" style="width:150px;">
                <option value="YTD">Year-to-Date</option>
                <option value="all">All Time</option>
                <option value="12">Last 12 Months</option>
              </select>
            </div>
        </div>
        
        <div class="kpi-card kpi-invest">
          <div class="kpi-header">
            <span class="card-title">Total Invested</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          </div>
          <div class="kpi-value" id="invTotalInvestedKPI">₹0.00</div>
          <div class="kpi-sub">
            <span id="invLumpsumCount">0 Lumpsums</span> | <span id="invSIPCount">0 SIPs/Regular</span>
          </div>
        </div>

        <div class="kpi-card kpi-net">
          <div class="kpi-header">
            <span class="card-title">Total Current Value</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
          </div>
          <div class="kpi-value" id="invCurrentValue">₹0.00</div>
          <div class="kpi-sub">
            <span id="invValTrendIcon"></span>
            <span id="invValTrendText"></span>
          </div>
        </div>
        
        <div class="kpi-card kpi-net">
          <div class="kpi-header">
            <span class="card-title">Absolute Gain / Loss</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 17.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5zM12 11.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5zM12 5.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5zM16 11.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5zM16 17.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5zM16 5.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 1 .5.5z"></path><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </div>
          <div class="kpi-value" id="invAbsoluteGain">₹0.00</div>
          <div class="kpi-sub">
            <span id="invCAGR">0.00% CAGR</span> | <span id="invXIRR">0.00% XIRR</span>
          </div>
        </div>

        <div class="card col-span-1" style="min-height: 250px;">
          <div class="card-header">
            <span class="card-title">Annualized Return %</span>
          </div>
          <div class="card-body" style="flex:1;">
            <canvas id="annualReturnChart"></canvas>
          </div>
        </div>
      </div>
      
      <div id="invBreakdownPanel" class="card col-span-4 hidden" style="margin-top:0;">
        <div class="card-header" style="background:#f8fafc; border-radius:12px 12px 0 0;">
            <div class="card-title">Investment Breakdown</div>
            <div class="flex-row">
                <select id="invBucketFilter" style="width:150px;">
                    <option value="">All Buckets</option>
                </select>
                <select id="invViewMode" style="width:150px;">
                    <option value="groups">By Investment Group</option>
                    <option value="subcats">By Subcategory</option>
                </select>
                <button id="toggleInvBreakdown" class="btn-outline">Close</button>
            </div>
        </div>
        <div class="card-body" style="padding-top:20px; flex:1;">
          <div id="invBreakdownContent" class="kpi-breakdown-grid" style="min-height: 350px;">
              </div>
        </div>
      </div>
      
      <div class="card col-span-4" style="min-height: 300px;">
        <div class="card-header">
          <span class="card-title">Investment Value Growth (Cumulative)</span>
        </div>
        <div class="card-body" style="flex:1;">
          <canvas id="invGrowthChart"></canvas>
        </div>
      </div>
    </section>

    <section id="advancedAnalytics" class="content-section hidden">
      <h2 style="margin-top:0">Advanced Analytics Dashboard</h2>
      
      <div class="card col-span-4">
        <div class="action-header" style="background:var(--bg-color); border:none; padding:10px 20px;">
          <div class="card-title" style="color:var(--text-main)">Apply Filters</div>
          <div class="flex-row">
            <select id="anlDateRange" style="width:150px;">
                <option value="all">All Time</option>
                <option value="YTD">Year-to-Date</option>
                <option value="12">Last 12 Months</option>
            </select>
            <select id="anlCategory" style="width:180px;">
                <option value="">All Categories</option>
            </select>
            <select id="anlInvGroup" style="width:180px;">
                <option value="">All Inv. Groups</option>
            </select>
            <select id="anlInvSub" style="width:180px;">
                <option value="">All Inv. Subs</option>
            </select>
          </div>
        </div>
      </div>

      <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">

        <div class="card" style="min-height: 400px;">
          <div class="card-header"><span class="card-title">Net Worth Trend (Filtered)</span></div>
          <div class="card-body" style="flex:1;"><canvas id="chartNetWorthModal"></canvas></div>
        </div>
        
        <div class="card" style="min-height: 400px;">
          <div class="card-header"><span class="card-title">Expense Flow Over Time (Monthly)</span></div>
          <div class="card-body" style="flex:1;"><canvas id="chartExpenseFlowModal"></canvas></div>
        </div>

        <div class="card" style="min-height: 400px;">
          <div class="card-header"><span class="card-title">Investment Types Distribution</span></div>
          <div class="card-body" style="flex:1;"><canvas id="chartInvTypesModal"></canvas></div>
        </div>
        
        <div class="card" style="min-height: 400px;">
          <div class="card-header"><span class="card-title">Investment Cumulative Growth</span></div>
          <div class="card-body" style="flex:1;"><canvas id="chartInvGrowthModal"></canvas></div>
        </div>

      </div>
      
    </section>

    <section id="settings" class="content-section hidden">
      <h2 style="margin-top:0">Settings & Configuration</h2>

      <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="card">
          <div class="card-header">
            <span class="card-title">General Settings</span>
          </div>
          <div class="card-body">
            <div style="margin-bottom:20px">
              <label style="margin-bottom:8px">Current User Name</label>
              <div class="flex-row">
                <input id="userNameInput" placeholder="Your Name" />
                <button class="btn-primary" id="saveUserNameBtn">Save Name</button>
              </div>
              <small style="display:block; color:var(--text-muted); margin-top:6px;">Displayed as: <span id="currentUser" class="font-semibold text-main">Guest</span></small>
            </div>
            
            <div style="margin-bottom:20px">
              <label style="margin-bottom:8px">Credit Card Limit (For KPI safety check)</label>
              <div class="flex-row">
                <input id="ccLimitInput" type="number" placeholder="Set limit (e.g. 200000)" />
                <button class="btn-primary" id="saveCCLimitBtn">Save Limit</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">Transaction Customization</span>
          </div>
          <div class="card-body">
            <div style="margin-bottom:20px">
              <label style="margin-bottom:8px">Payment Methods / Accounts</label>
              <div id="methodList" style="border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
              <div class="flex-row">
                <input id="newMethodName" placeholder="New method (e.g. Bank B/C, UPI)" />
                <button class="btn-primary" id="addMethodBtn">Add</button>
              </div>
            </div>

            <div style="margin-bottom:20px">
              <label style="margin-bottom:8px">Expense Categories</label>
              <div id="categoryList" style="border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
              <div class="flex-row">
                <input id="newCategoryName" placeholder="New category (e.g. Food)" />
                <button class="btn-primary" id="addCategoryBtn">Add</button>
              </div>
              <small style="display:block; color:var(--text-muted); margin-top:6px;">Tip: Click remove to delete a category. Built-ins like "Investments" and "Credit Card Payment" are protected.</small>
            </div>

            <div style="margin-bottom:20px">
              <label style="margin-bottom:8px">Income sources</label>
              <div id="incomeList" style="border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
              <div class="flex-row">
                <input id="newIncomeName" placeholder="New source name" />
                <button class="btn-primary" id="addIncomeBtn">Add</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Data Import/Export</span>
          </div>
          <div class="card-body">
            <p style="font-size:13px; color:var(--text-muted);">Backup or restore all your data and settings.</p>
            <div class="flex-row" style="margin-bottom:15px;">
                <button class="btn-outline full-width" id="exportDataBtn">Export JSON Backup</button>
            </div>
            <div class="flex-row" style="margin-bottom:15px;">
                <button class="btn-primary full-width" id="importDataBtn">Import JSON File</button>
                <input type="file" id="importFileInput" accept=".json" class="hidden" />
            </div>
            <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px">
              <label style="color:var(--danger)">Danger zone</label>
              <div class="flex-row">
                <button class="btn-danger full-width" id="loadSampleBtn" style="margin-right: 10px;">Load Sample Data</button>
                <button class="btn-danger full-width" id="factoryResetBtn">Factory Reset</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">Market Ticker Configuration</span>
            </div>
            <div class="card-body">
                <p style="font-size:13px; color:var(--text-muted); margin-bottom:15px;">Customize the stocks/indices shown in the live ticker.</p>
                <div style="margin-bottom:16px">
                    <label>Currently Tracked Markets</label>
                    <div id="marketList" style="border:1px solid var(--border); border-radius:8px; padding:10px; max-height:150px; overflow-y:auto;">
                        </div>
                </div>
                <h3 style="margin:8px 0; font-size:14px; font-weight:600;">Add New Market</h3>
                <div class="flex-row" style="gap:10px;">
                    <input id="newMarketSymbol" placeholder="Ticker Symbol (e.g., AAPL, GC=F)" />
                    <button class="btn-primary" id="addMarketBtn">Add</button>
                </div>
            </div>
        </div>
        
      </div>
    </section>

  </main>

  <script>
    // Configuration for Firebase
    const firebaseConfig = { apiKey: "AIzaSyB3_placeholder", authDomain: "moneymirror-v5.firebaseapp.com", projectId: "moneymirror-v5", storageBucket: "moneymirror-v5.appspot.com", messagingSenderId: "61775081584", appId: "1:61775081584:web:3ec184985e324cf6f1c4b5", measurementId: "G-8RPXH1VEFG" };
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v5_profile';
    
    let db = null;
    let auth = null;
    let USE_FIRESTORE = false;
    let currentProfile = null;

    // Chart instances (to prevent duplicates)
    let incomeExpenseChartInstance = null;
    let netWorthChartInstance = null;
    let annualReturnChartInstance = null;
    let invGrowthChartInstance = null;
    
    // Default and State Variables
    const DEFAULT_CC_LIMIT = 100000;
    const BUILTIN_CATEGORIES = ['Investments', 'Credit Card Payment'];
    const DEFAULT_EXPENSE_CATEGORIES = ['Food', 'Rent', 'Utilities', 'Shopping', 'Entertainment', 'Travel', 'Health', 'Investments', 'Insurance', 'Credit Card Payment', 'Misc'];
    const DEFAULT_METHODS = {
        'bank_ac': 'Bank A/C (Default)',
        'credit_card': 'Credit Card (Default)',
        'wallet': 'Digital Wallet',
        'upi': 'UPI/Pay'
    };
    
    // Investment Group Bucketing (Used in Investment Tracker)
    const MAJOR_BUCKETS = {
        'Equity': 'Stocks/Equity',
        'Debt': 'Bonds/Debt',
        'Commodity': 'Gold/Commodities',
        'Real Estate': 'Real Estate',
        'Other': 'Other Assets'
    };
    
    const DEFAULT_SETTINGS = {
        userName: 'Guest',
        ccLimit: DEFAULT_CC_LIMIT,
        methods: DEFAULT_METHODS,
        categories: DEFAULT_EXPENSE_CATEGORIES.slice(), // Array of category names
        incomeSources: ['Salary', 'Freelance', 'Interest'],
        // Ticker defaults (using random/stub data for initial load)
        trackedMarkets: [
            { symbol: 'SENSEX', yahooTicker: '^BSESN', name: 'Sensex', price: 72000.00, change: 0.85 },
            { symbol: 'NASDAQ', yahooTicker: '^IXIC', name: 'Nasdaq', price: 16000.00, change: -1.23 },
            { symbol: 'XAUUSD', yahooTicker: 'GC=F', name: 'Gold/USD', price: 2350.00, change: 0.15 },
            { symbol: 'BTCUSD', yahooTicker: 'BTC-USD', name: 'Bitcoin', price: 68000.00, change: 2.10 }
        ]
    };

    let data = []; // Main array of transaction objects
    let settings = { ...DEFAULT_SETTINGS };
    let editId = null;
    
    // ---------- UTILITY FUNCTIONS ----------

    function uid() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function sum(arr) {
        return arr.reduce((acc, curr) => acc + Number(curr.amount || 0), 0);
    }
    
    function fmt(value) {
        if (value === null || value === undefined) return '₹0.00';
        return '₹' + Math.abs(value).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatCurrency(value) {
      return fmt(value);
    }
    
    function pct(value) {
        if (value === null || value === undefined || isNaN(value)) return '0.00%';
        return value.toFixed(2) + '%';
    }
    
    function toKey(s) {
        return s.toLowerCase().replace(/[^a-z0-9]/g, '_');
    }
    
    // Calculates the start date based on the range ('YTD', '12', 'all')
    function getDateRangeStart(range) {
        const now = new Date();
        if (range === 'YTD') {
            return new Date(now.getFullYear(), 0, 1);
        } else if (range === '12') {
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            start.setFullYear(start.getFullYear() - 1);
            return start;
        }
        return new Date(0); // Epoch for 'all'
    }

    // Chart Color Palette Generator
    function getColorPalette(count) {
        const colors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#7c3aed', '#0ea5e9', '#14b8a6', 
            '#22c55e', '#eab308', '#f97316', '#374151', '#8b5cf6', '#dc2626', '#1e40af'
        ];
        // Repeat or cycle the colors if count exceeds the palette size
        return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
    }
    
    // ---------- AUTH & BOOT ----------

    function showAuthGate() {
        const gate = document.getElementById('authGate');
        gate.classList.add('show');
        document.querySelector('main').style.filter = 'blur(5px)';
    }

    function hideAuthGate() {
        const gate = document.getElementById('authGate');
        gate.classList.remove('show');
        document.querySelector('main').style.filter = 'none';
    }

    try {
        if (typeof firebase !== 'undefined' && firebase.initializeApp) {
            const app = firebase.initializeApp(firebaseConfig);
            db = app.firestore();
            auth = app.auth();
            USE_FIRESTORE = true;
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    onUserSignedIn(user);
                } else {
                    const lastProfile = localStorage.getItem('mm_last_profile');
                    if (lastProfile && lastProfile !== 'Guest') {
                        // User was logged in but session expired. Force re-auth.
                        showAuthGate();
                    } else {
                        // Default to guest if no previous session or if previous was guest
                        startGuestMode();
                    }
                }
            });
        }
    } catch (e) {
        console.warn("Firebase init failed. Using local-only mode.");
    }

    async function signInWithGoogle() {
        if (!auth) return alert('Auth not available. Use Guest Mode.');
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            onUserSignedIn(result.user);
        } catch (err) {
            console.error("Login failed:", err);
            alert('Sign-in failed. Try Guest Mode.');
        }
    }

    async function signOut() {
        if (!auth) return alert('Cannot sign out in Guest Mode.');
        try {
            await auth.signOut();
            currentProfile = null;
            localStorage.removeItem('mm_last_profile');
            // Reload to clear state and go back to auth gate
            window.location.reload(); 
        } catch (err) {
            console.error("Sign-out failed:", err);
            alert('Sign-out failed.');
        }
    }

    function onUserSignedIn(user) {
        currentProfile = user.uid;
        localStorage.setItem('mm_last_profile', currentProfile);
        document.getElementById('profileNameDisplay').textContent = user.displayName || 'Synced Profile';
        document.getElementById('logoutBtn').style.display = 'block';
        hideAuthGate();
        loadProfileData();
    }
    
    function startGuestMode() {
        currentProfile = 'Guest';
        localStorage.setItem('mm_last_profile', currentProfile);
        document.getElementById('profileNameDisplay').textContent = 'Guest (Offline)';
        document.getElementById('logoutBtn').style.display = 'none';
        hideAuthGate();
        loadProfileData();
    }
    
    document.getElementById('logoutBtn').addEventListener('click', signOut);

    // ---------- PERSISTENCE ----------

    function getTxKey() {
        return currentProfile ? `mm_data_${currentProfile}` : 'mm_data_default';
    }
    
    function getSettingsKey() {
        return currentProfile ? `mm_settings_${currentProfile}` : 'mm_settings_default';
    }
    
    function loadLocal() {
        const localData = localStorage.getItem(getTxKey());
        const localSettings = localStorage.getItem(getSettingsKey());

        if (localData) {
            try {
                data = JSON.parse(localData);
            } catch (e) {
                console.error("Error loading local data:", e);
                data = [];
            }
        } else {
            data = [];
        }

        if (localSettings) {
            try {
                const incoming = JSON.parse(localSettings);
                settings = { ...DEFAULT_SETTINGS, ...incoming };
            } catch (e) {
                console.error("Error loading local settings:", e);
                settings = { ...DEFAULT_SETTINGS };
            }
        } else {
            settings = { ...DEFAULT_SETTINGS };
        }
        
        // Ensure categories are merged if necessary (e.g. on first load or reset)
        if (!settings.categories || !Array.isArray(settings.categories) || settings.categories.length === 0) {
             settings.categories = DEFAULT_EXPENSE_CATEGORIES.slice();
        }
        
        // Ensure methods are correctly structured
        if (!settings.methods || typeof settings.methods !== 'object') {
            settings.methods = DEFAULT_METHODS;
        }

        // Ensure trackedMarkets is an array
        if (!settings.trackedMarkets || !Array.isArray(settings.trackedMarkets)) {
            settings.trackedMarkets = DEFAULT_SETTINGS.trackedMarkets;
        }
    }
    
    async function saveLocal() {
        localStorage.setItem(getTxKey(), JSON.stringify(data));
        localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
        
        document.getElementById('lastSyncDisplay').textContent = `Local: ${new Date().toLocaleTimeString()}`;
    }

    async function saveToFirestore() {
        if (!USE_FIRESTORE || !db || !currentProfile || currentProfile === 'Guest') return;
        
        try {
            const profileData = {
                data: data.map(d => ({ // Only save fields that are present
                    id: d.id,
                    date: d.date,
                    type: d.type,
                    amount: d.amount,
                    description: d.description,
                    category: d.category,
                    method: d.method,
                    incomeSource: d.incomeSource || '',
                    investmentGroup: d.investmentGroup || '',
                    investmentSub: d.investmentSub || ''
                })),
                settings: settings,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection(FIRESTORE_COLLECTION_NAME).doc(currentProfile).set(profileData, { merge: true });
            document.getElementById('lastSyncDisplay').textContent = `Cloud: ${new Date().toLocaleTimeString()}`;
        } catch (e) {
            console.error("Firestore write error:", e);
            alert('Cloud sync failed. Data saved locally.');
        }
    }
    
    function saveAll() {
        saveLocal();
        saveToFirestore();
    }
    
    async function loadProfileData() {
        loadLocal(); // Always load local first as a fallback

        if (USE_FIRESTORE && db && currentProfile && currentProfile !== 'Guest') {
            try {
                const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(currentProfile).get();
                if (doc.exists) {
                    const server = doc.data();
                    
                    if (server.data && server.data.length > 0) {
                        data = server.data;
                    }

                    if (server.settings) {
                        settings = { 
                            ...DEFAULT_SETTINGS, 
                            ...server.settings,
                            // Ensure categories and methods are not accidentally replaced by empty arrays/objects
                            categories: Array.isArray(server.settings.categories) && server.settings.categories.length > 0 ? server.settings.categories : settings.categories,
                            methods: typeof server.settings.methods === 'object' && Object.keys(server.settings.methods).length > 0 ? server.settings.methods : settings.methods,
                            trackedMarkets: Array.isArray(server.settings.trackedMarkets) && server.settings.trackedMarkets.length > 0 ? server.settings.trackedMarkets : settings.trackedMarkets
                        };
                    }
                    
                    document.getElementById('lastSyncDisplay').textContent = `Cloud: ${new Date().toLocaleTimeString()}`;
                }
            } catch (e) {
                console.error("Firestore read error:", e);
            }
        }
        renderAll();
        startTickerRealtimeLoop();
    }
    
    function loadData() {
        const lastProfile = localStorage.getItem('mm_last_profile');
        if (lastProfile && lastProfile !== 'Guest' && USE_FIRESTORE) {
            // Wait for auth to resolve in init
        } else {
            startGuestMode();
        }
    }

    // ---------- RENDERING HELPERS & DATA MANAGEMENT (CRUD) ----------

    function renderAll() {
      // 1. Sort Data
      data.sort((a, b) => new Date(b.date) - new Date(a.date));

      // 2. Render all dynamic elements
      renderKPIs();
      renderNetWorthChart(data.filter(d => d.type !== 'credit_card_payment'), 'netWorthChart');
      renderIncomeExpenseChart();
      renderInvestmentKPICharts();
      renderSettingLists();
      renderMarketTicker();
      
      // 3. Conditional List Rendering (Only if in dataEntry view)
      if (!document.getElementById('dataEntry').classList.contains('hidden')) {
        renderFullDataList();
      }
    }

    function setupEntryDropdowns() {
        const typeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category');
        const methodSelect = document.getElementById('method');
        const invGroupSelect = document.getElementById('investmentGroup');
        const incomeSourceSelect = document.getElementById('incomeSource');
        
        // 1. Populate Category Select
        const allCategories = settings.categories.filter(c => c !== 'Credit Card Payment');
        categorySelect.innerHTML = allCategories.map(c => `<option value="${c}">${c}</option>`).join('');
        
        // 2. Populate Method Select
        methodSelect.innerHTML = Object.entries(settings.methods).map(([key, name]) => 
            `<option value="${key}">${name}</option>`
        ).join('');
        
        // 3. Populate Investment Group Select
        invGroupSelect.innerHTML = '<option value="">Select Group</option>' + 
            Object.keys(MAJOR_BUCKETS).map(g => `<option value="${g}">${g}</option>`).join('');
            
        // 4. Populate Income Source Select
        incomeSourceSelect.innerHTML = '<option value="">Select Source</option>' + 
            settings.incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');

        // 5. Initial form setup (to handle visibility)
        handleTypeChange();
        handleCategoryChange();
        
        // 6. Set current date for date input
        document.getElementById('date').value = new Date().toISOString().slice(0, 10);
    }

    function handleTypeChange() {
        const type = document.getElementById('type').value;
        const categoryContainer = document.getElementById('categoryContainer');
        const methodContainer = document.getElementById('methodContainer');
        const invGroupContainer = document.getElementById('investmentGroupContainer');
        const invSubContainer = document.getElementById('investmentSubContainer');
        const incomeSourceContainer = document.getElementById('incomeSourceContainer');
        const categorySelect = document.getElementById('category');
        const methodSelect = document.getElementById('method');
        
        // Reset visibility
        categoryContainer.classList.remove('hidden');
        methodContainer.classList.remove('hidden');
        invGroupContainer.classList.add('hidden');
        invSubContainer.classList.add('hidden');
        incomeSourceContainer.classList.add('hidden');

        // Set category dropdown options based on type
        const allCategories = settings.categories;
        
        if (type === 'income') {
            categorySelect.innerHTML = settings.incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');
            incomeSourceContainer.classList.add('hidden'); // Redundant with category, so hide
            categoryContainer.querySelector('label').textContent = 'Source';
        } else if (type === 'credit_card_payment') {
            // The category is fixed as 'Credit Card Payment'
            categorySelect.innerHTML = `<option value="Credit Card Payment">Credit Card Payment</option>`;
            categoryContainer.querySelector('label').textContent = 'Category';
            
            // The method is fixed as 'Credit Card' and the account being paid *from* is selected here.
            methodSelect.innerHTML = Object.entries(settings.methods)
                .filter(([key, name]) => key !== 'credit_card') // Cannot pay CC bill with the CC itself
                .map(([key, name]) => `<option value="${key}">${name}</option>`).join('');
            methodContainer.querySelector('label').textContent = 'Paid From Account';
        } else if (type === 'opening_balance') {
            // Opening balance usually goes into an account
            categorySelect.innerHTML = `<option value="Opening Balance">Opening Balance</option>`;
            categoryContainer.querySelector('label').textContent = 'Type/Source';
        } else { // expense
            categorySelect.innerHTML = allCategories.filter(c => c !== 'Credit Card Payment' && c !== 'Opening Balance').map(c => `<option value="${c}">${c}</option>`).join('');
            categoryContainer.querySelector('label').textContent = 'Category';
            methodContainer.querySelector('label').textContent = 'Method / Account';
            
            // Restore full methods list
            methodSelect.innerHTML = Object.entries(settings.methods).map(([key, name]) => 
                `<option value="${key}">${name}</option>`
            ).join('');
        }
        
        // Trigger category change to handle Investments visibility
        handleCategoryChange(); 
    }
    
    function handleCategoryChange() {
        const type = document.getElementById('type').value;
        const category = document.getElementById('category').value;
        const invGroupContainer = document.getElementById('investmentGroupContainer');
        const invSubContainer = document.getElementById('investmentSubContainer');
        
        if (type === 'expense' && category === 'Investments') {
            invGroupContainer.classList.remove('hidden');
            invSubContainer.classList.remove('hidden');
        } else {
            invGroupContainer.classList.add('hidden');
            invSubContainer.classList.add('hidden');
        }
    }
    
    // Add event listeners for form controls
    document.getElementById('type').addEventListener('change', handleTypeChange);
    document.getElementById('category').addEventListener('change', handleCategoryChange);
    
    // ---------- CRUD Operations ----------
    
    document.getElementById('transactionForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('resetFormBtn').addEventListener('click', resetForm);
    document.getElementById('filterText').addEventListener('input', renderFullDataList);
    document.getElementById('filterType').addEventListener('change', renderFullDataList);

    function handleFormSubmit(e) {
        e.preventDefault();
        
        const type = document.getElementById('type').value;
        const amount = Number(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        const description = document.getElementById('description').value.trim();
        let category = document.getElementById('category').value;
        let method = document.getElementById('method').value;
        
        let investmentGroup = document.getElementById('investmentGroup').value;
        let investmentSub = document.getElementById('investmentSub').value.trim();
        let incomeSource = '';
        
        if (amount <= 0) {
            alert('Amount must be positive.');
            return;
        }

        // Handle specific type requirements
        if (type === 'income') {
             incomeSource = category;
             category = 'Income'; // Standardize category for income type
        }
        
        if (type === 'opening_balance') {
             category = 'Opening Balance'; // Standardize
        }
        
        if (type === 'credit_card_payment') {
             category = 'Credit Card Payment';
             // 'method' here is the account paid *from*, which is correct.
        }

        if (category !== 'Investments') {
            investmentGroup = '';
            investmentSub = '';
        } else if (category === 'Investments' && !investmentGroup) {
            alert('Please select an Investment Group for this investment.');
            return;
        }

        const newEntry = {
            id: editId || uid(),
            date: date,
            type: type,
            amount: amount,
            description: description,
            category: category,
            method: method,
            incomeSource: incomeSource,
            investmentGroup: investmentGroup,
            investmentSub: investmentSub
        };

        if (editId) {
            const index = data.findIndex(d => d.id === editId);
            if (index !== -1) {
                data[index] = newEntry;
            }
            editId = null;
        } else {
            data.push(newEntry);
        }

        saveAll();
        resetForm();
        renderAll(); // Re-render everything after data change
    }

    function resetForm() {
        document.getElementById('formTitle').textContent = 'Add New Transaction';
        document.getElementById('saveEntryBtn').textContent = 'Save Entry';
        document.getElementById('transactionForm').reset();
        document.getElementById('date').value = new Date().toISOString().slice(0, 10);
        editId = null;
        setupEntryDropdowns(); // Re-run to reset dropdowns and visibility
    }

    function loadEdit(id) {
        const entry = data.find(d => d.id === id);
        if (!entry) return;
        
        editId = id;
        
        // Populate fields
        document.getElementById('type').value = entry.type;
        document.getElementById('amount').value = entry.amount;
        document.getElementById('date').value = entry.date;
        document.getElementById('description').value = entry.description;
        
        // This is crucial: run type change *before* setting category/method
        handleTypeChange();
        
        // Set dropdowns (category and method might change based on type/content)
        // For income, the category *is* the income source
        const finalCategory = (entry.type === 'income') ? entry.incomeSource : entry.category;
        document.getElementById('category').value = finalCategory;
        
        document.getElementById('method').value = entry.method;
        
        // Handle Investment fields if present
        if (entry.investmentGroup) {
            document.getElementById('investmentGroup').value = entry.investmentGroup;
            document.getElementById('investmentSub').value = entry.investmentSub || '';
        } else {
             // Ensure investment fields are hidden if not an investment entry
             document.getElementById('investmentGroupContainer').classList.add('hidden');
             document.getElementById('investmentSubContainer').classList.add('hidden');
        }

        // Update form state
        document.getElementById('formTitle').textContent = `Editing Transaction: ${entry.id.substring(0, 5)}`;
        document.getElementById('saveEntryBtn').textContent = 'Update Entry';
        
        // Scroll to form
        document.getElementById('dataEntry').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this transaction?')) return;
        
        data = data.filter(d => d.id !== id);
        
        if (editId === id) resetForm(); // Clear form if the deleted item was being edited
        
        saveAll();
        renderAll();
    }
    
    function renderFullDataList() {
        const listBody = document.querySelector('#dataList tbody');
        const filterText = document.getElementById('filterText').value.toLowerCase();
        const filterType = document.getElementById('filterType').value;
        
        const filteredData = data.filter(d => {
            const matchesText = d.description.toLowerCase().includes(filterText) || 
                                d.category.toLowerCase().includes(filterText);
            const matchesType = !filterType || d.type === filterType;
            return matchesText && matchesType;
        });

        listBody.innerHTML = filteredData.map(d => {
            const isExpense = d.type === 'expense' || d.type === 'credit_card_payment';
            const badgeClass = 
                d.type === 'income' ? 'badge-income' :
                d.type === 'expense' && d.category === 'Investments' ? 'badge-inv' :
                d.type === 'credit_card_payment' ? 'badge-cc' :
                d.type === 'opening_balance' ? 'badge-opening' :
                'badge-expense';
            
            const amountCell = `<td style="text-align:right; font-weight:600; color:${isExpense ? 'var(--danger)' : 'var(--success)'}">${isExpense ? '-' : '+'}${fmt(d.amount)}</td>`;
            
            return `
                <tr>
                    <td>${d.date}</td>
                    <td><span class="badge ${badgeClass}">${d.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></td>
                    <td>${d.description}</td>
                    <td>${d.category}${d.investmentSub ? ` <small>(${d.investmentSub})</small>` : ''}</td>
                    <td>${settings.methods[d.method] || d.method}</td>
                    ${amountCell}
                    <td>
                        <button onclick="loadEdit('${d.id}')" class="btn-outline" style="padding:4px 8px; font-size:11px;">Edit</button>
                        <button onclick="deleteEntry('${d.id}')" class="btn-danger" style="padding:4px 8px; font-size:11px;">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('dataListFooter').style.display = filteredData.length === 0 ? 'flex' : 'none';
    }

    function renderKPIs() {

    function calculateKPIs() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        
        // 1. Calculate Account Balances and Net Worth components
        const balances = data.reduce((acc, curr) => {
            const amount = Number(curr.amount);
            
            // Standard Cash/Bank Account: Income/Opening Balance adds, Expense subtracts
            if (curr.type === 'income' || curr.type === 'opening_balance') {
                acc.accounts[curr.method] = (acc.accounts[curr.method] || 0) + amount;
            } else if (curr.type === 'expense' && curr.method !== 'credit_card') {
                acc.accounts[curr.method] = (acc.accounts[curr.method] || 0) - amount;
            }
            
            // Investment: Investment transactions subtract from the method account, but don't affect other accounts.
            if (curr.type === 'expense' && curr.category === 'Investments') {
                acc.totalInvested += amount;
                acc.investmentEntries.push(curr);
            }
            
            // Credit Card: CC payments transfer money *from* an account, so they are ignored here.
            // CC expenses add to the CC liability.
            if (curr.method === 'credit_card' && curr.type === 'expense') {
                acc.ccDue += amount;
            }
            
            // Credit Card Payment: This is the transfer of funds *to* the CC.
            // It reduces the CC liability. The deduction from the *from* account is handled above.
            if (curr.type === 'credit_card_payment') {
                 acc.ccDue -= amount;
            }
            
            return acc;
        }, {
            accounts: Object.keys(settings.methods).reduce((acc, key) => ({ ...acc, [key]: 0 }), {}),
            ccDue: 0,
            totalInvested: 0,
            investmentEntries: []
        });
        
        // Remove credit_card from standard accounts list for cash KPI
        const cashAccounts = Object.entries(balances.accounts).filter(([key]) => key !== 'credit_card');
        const totalCash = cashAccounts.reduce((sum, [, amount]) => sum + amount, 0);

        // 2. Calculate Month-specific Income/Expense
        const monthlyData = data.filter(d => d.date >= startOfMonth);
        const currentMonthIncome = sum(monthlyData.filter(d => d.type === 'income'));
        const currentMonthExpense = sum(monthlyData.filter(d => d.type === 'expense' && d.category !== 'Investments'));
        
        // 3. Calculate Investment Value (Placeholder for external update)
        // Since we don't have real-time market data to calculate current value,
        // we'll assume a dummy return rate or rely on future external injection.
        // For now, let's assume a 15% annualised growth for simplicity in a self-contained file.
        const assumedAnnualReturnRate = 0.15;
        const totalInvestmentValue = balances.investmentEntries.reduce((value, entry) => {
            const entryDate = new Date(entry.date);
            const daysHeld = (now - entryDate) / (1000 * 60 * 60 * 24);
            const yearsHeld = daysHeld / 365.25;
            
            // Simple power calculation for compounding value
            const futureValue = entry.amount * Math.pow(1 + assumedAnnualReturnRate, yearsHeld);
            return value + futureValue;
        }, 0);
        
        const totalInvested = balances.totalInvested;
        const investmentReturn = totalInvestmentValue - totalInvested;
        const investmentReturnPct = totalInvested > 0 ? (investmentReturn / totalInvested) * 100 : 0;
        
        // 4. Calculate Net Worth
        // Net Worth = Total Cash + Total Investment Value - CC Due
        const netWorth = totalCash + totalInvestmentValue - balances.ccDue;
        
        // 5. Calculate Net Worth Trend (using last month's net worth as comparison)
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()).toISOString().split('T')[0];
        
        const lastMonthData = data.filter(d => d.date < lastMonth);
        const lastMonthBalances = lastMonthData.reduce((acc, curr) => {
             const amount = Number(curr.amount);
             const type = curr.type;
             const method = curr.method;
             const category = curr.category;
             
             if (type === 'income' || type === 'opening_balance') { acc.cash += amount; }
             if (type === 'expense' && method !== 'credit_card') { acc.cash -= amount; }
             if (type === 'expense' && category === 'Investments') { acc.invested += amount; }
             if (method === 'credit_card' && type === 'expense') { acc.ccDue += amount; }
             if (type === 'credit_card_payment') { acc.ccDue -= amount; }
             
             return acc;
        }, { cash: 0, invested: 0, ccDue: 0 });
        
        const lastMonthInvestmentValue = lastMonthBalances.invested * Math.pow(1 + assumedAnnualReturnRate, 1/12); // Simple projection for the month
        const lastMonthNetWorth = lastMonthBalances.cash + lastMonthInvestmentValue - lastMonthBalances.ccDue;
        
        const netWorthChange = netWorth - lastMonthNetWorth;
        
        return {
            netWorth,
            netWorthChange,
            currentMonthIncome,
            currentMonthExpense,
            ccDue: balances.ccDue,
            totalCash,
            cashAccounts,
            investmentEntries: balances.investmentEntries,
            totalInvested,
            totalInvestmentValue,
            investmentReturn,
            investmentReturnPct
        };
    }
    
    let kpis = {}; // Store results globally for use in other charts

    function renderKPIs() {
        kpis = calculateKPIs();
        
        // 1. Net Worth Card
        document.getElementById('netWorthValue').textContent = fmt(kpis.netWorth);
        document.getElementById('netWorthTrendIcon').innerHTML = kpis.netWorthChange >= 0 ? 
            '<span class="trend-up">▲</span>' : 
            '<span class="trend-down">▼</span>';
        document.getElementById('netWorthTrendText').textContent = 
            `${fmt(kpis.netWorthChange)} (${pct(kpis.netWorthChange / (kpis.netWorth - kpis.netWorthChange) * 100)} ) vs Last Month`;

        // 2. Income Card
        document.getElementById('incomeValue').textContent = fmt(kpis.currentMonthIncome);
        // Trend calculation for Income/Expense is complex without prior month data - using dummy status for now
        document.getElementById('incomeTrendIcon').innerHTML = '<span class="trend-up">▲</span>';
        document.getElementById('incomeTrendText').textContent = `On Track`;

        // 3. Expense Card
        document.getElementById('expenseValue').textContent = fmt(kpis.currentMonthExpense);
        document.getElementById('expenseTrendIcon').innerHTML = '<span class="trend-down">▼</span>';
        document.getElementById('expenseTrendText').textContent = `In Budget`;

        // 4. Credit Card Card
        document.getElementById('ccDueValue').textContent = fmt(kpis.ccDue);
        const limit = Number(settings.ccLimit) || DEFAULT_CC_LIMIT;
        const usagePct = limit > 0 ? (kpis.ccDue / limit) * 100 : 0;
        const fill = document.getElementById('ccSliderFill');
        fill.style.width = `${Math.min(usagePct, 100)}%`;
        
        document.getElementById('ccLimitLabels').innerHTML = `<span>${pct(usagePct)}</span><span>${fmt(kpis.ccDue)} / ${fmt(limit)}</span>`;
        
        const ccCard = document.getElementById('ccCard');
        ccCard.classList.remove('cc-alert-high');
        if (usagePct > 70) {
            ccCard.classList.add('cc-alert-high');
        }

        // 5. Investment Return Card
        document.getElementById('invTotalReturn').textContent = fmt(kpis.investmentReturn);
        document.getElementById('invTotalInvested').textContent = `(Invested: ${fmt(kpis.totalInvested)})`;
        
        const invPctElement = document.getElementById('invReturnPct');
        invPctElement.textContent = pct(kpis.investmentReturnPct);
        invPctElement.className = 'kpi-change-text ' + 
            (kpis.investmentReturnPct > 0 ? 'kpi-positive' : kpis.investmentReturnPct < 0 ? 'kpi-negative' : 'kpi-neutral');

        // 6. Account Balances
        renderAccountBalances(kpis.cashAccounts);
    }
    
    function renderAccountBalances(cashAccounts) {
        document.getElementById('totalCashValue').textContent = fmt(kpis.totalCash);
        const listContainer = document.getElementById('accountList');
        
        // Filter out zero/negative non-CC accounts and sort by descending balance
        const sortedAccounts = cashAccounts
            .filter(([, amount]) => amount !== 0)
            .sort((a, b) => b[1] - a[1]); 

        // Add Credit Card Due as a liability (negative balance)
        if (kpis.ccDue > 0) {
            sortedAccounts.push(['credit_card', -kpis.ccDue]);
        }
        
        listContainer.innerHTML = sortedAccounts.map(([key, amount]) => {
            const name = settings.methods[key] || key;
            const displayAmount = fmt(amount);
            const color = amount >= 0 ? 'var(--text-main)' : 'var(--danger)';
            const icon = key === 'credit_card' ? 
                '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--danger)"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
            
            return `
                <div>
                    <span>${icon} ${name}${key === 'credit_card' ? ' (Liability)' : ''}</span>
                    <span style="color:${color}">${displayAmount}</span>
                </div>
            `;
        }).join('');
        
        if (sortedAccounts.length === 0) {
            listContainer.innerHTML = '<div><span>No active accounts found.</span></div>';
        }
    }
    
    // ---------- CHART FUNCTIONS ----------
    
    function renderNetWorthChart(txData, canvasId) {
        if (netWorthChartInstance) netWorthChartInstance.destroy();
        
        const now = new Date();
        const startOfData = txData.length > 0 ? new Date(Math.min(...txData.map(d => new Date(d.date)))) : now;
        
        let currentDate = new Date(startOfData.getFullYear(), startOfData.getMonth(), 1);
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0); // End of current month
        
        const monthlyNetWorth = [];
        let runningNetWorth = 0;
        
        // Calculate the initial net worth (before the first date of data)
        const initialBalance = txData.filter(d => new Date(d.date) < startOfData).reduce((sum, d) => {
            let amount = Number(d.amount);
            if (d.type === 'income' || d.type === 'opening_balance') {
                return sum + amount;
            } else if (d.type === 'expense') {
                return sum - amount;
            }
            return sum;
        }, 0);
        runningNetWorth = initialBalance;
        
        const sortedData = txData.sort((a, b) => new Date(a.date) - new Date(b.date));
        let dataIndex = 0;

        while (currentDate <= endOfMonth) {
            const monthLabel = currentDate.toLocaleString('default', { month: 'short', year: '2-digit' });
            const monthEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            // Apply all transactions that happened within this month
            while (dataIndex < sortedData.length && new Date(sortedData[dataIndex].date) <= monthEnd) {
                const d = sortedData[dataIndex];
                let effectiveAmount = Number(d.amount);
                
                if (d.type === 'income' || d.type === 'opening_balance' || (d.type === 'expense' && d.category === 'Investments')) {
                    // For NW: Income adds. Investment expense is a change of asset form, but since we assume 
                    // an asset value increase in the KPI calculation, the *cash* change is included here.
                    // This is a simplification. A perfect NW chart would track the market value of the investment,
                    // which is not possible here. We'll simply track cash flow + investment expense as if it were cash.
                    // The actual `kpis.netWorth` uses an estimated value, which is why we must adjust this logic.
                    
                    // Net Worth = Cash + Investment Value. 
                    // Investment tx: Cash down, Inv Value up -> Net change is 0.
                    // Income/Opening: Cash up -> Net change is +Amount.
                    // Expense (non-inv): Cash down -> Net change is -Amount.
                    // CC Payment: Cash down from account, CC Liability down. -> Net change is 0.
                    
                    // We must calculate the Net Worth change precisely based on cash flow *only*, 
                    // and then add the *estimated* Investment Value gain *at the end of the month*.
                    
                    if (d.type === 'income' || d.type === 'opening_balance') {
                        runningNetWorth += effectiveAmount;
                    } else if (d.type === 'expense' && d.category !== 'Investments' && d.method !== 'credit_card') {
                        runningNetWorth -= effectiveAmount;
                    } else if (d.type === 'expense' && d.method === 'credit_card') {
                        runningNetWorth -= effectiveAmount; // Expense adds to CC Liability (negative cash)
                    } else if (d.type === 'credit_card_payment') {
                        // Payment from a cash account to CC liability. Cash down, Liability down. No NW change.
                    } else if (d.type === 'expense' && d.category === 'Investments') {
                        // Cash down, Investment Asset up. No NW change.
                    }

                }
                dataIndex++;
            }
            
            // Add estimated investment growth for the month (simplified 1.2% per month)
            const investmentGrowthRate = 0.012; // ~15% / 12 months
            const totalInvAtMonthStart = kpis.investmentEntries.filter(d => new Date(d.date) <= currentDate).reduce((sum, d) => sum + Number(d.amount), 0);
            const investmentGain = totalInvAtMonthStart * investmentGrowthRate;
            runningNetWorth += investmentGain;

            monthlyNetWorth.push({
                month: monthLabel,
                value: runningNetWorth
            });

            // Move to the next month
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        
        const labels = monthlyNetWorth.map(m => m.month);
        const values = monthlyNetWorth.map(m => m.value);

        const ctx = document.getElementById(canvasId).getContext('2d');
        netWorthChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Net Worth (Est.)',
                    data: values,
                    borderColor: 'var(--primary)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: false, ticks: { callback: function(value) { return fmt(value); } } }
                }
            }
        });
    }

    function renderIncomeExpenseChart() {
        if (incomeExpenseChartInstance) incomeExpenseChartInstance.destroy();
        
        const monthlyNetFlow = kpis.currentMonthIncome - kpis.currentMonthExpense;
        const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
        
        incomeExpenseChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expense', 'Net Flow'],
                datasets: [{
                    label: 'Amount (₹)',
                    data: [kpis.currentMonthIncome, kpis.currentMonthExpense, monthlyNetFlow],
                    backgroundColor: [
                        'var(--success)',
                        'var(--danger)',
                        monthlyNetFlow >= 0 ? 'var(--primary)' : 'var(--danger)'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: function(value) { return fmt(value); } } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // ---------- INVESTMENT TRACKING LOGIC ----------

    // Simple CAGR approximation
    function calculateCAGR(entries, totalValue) {
        if (entries.length === 0 || totalValue <= 0) return 0;
        
        const now = new Date();
        
        // Sum of (Investment * TimeFactor) weighted average invested amount
        const weightedInvested = entries.reduce((acc, entry) => {
            const entryDate = new Date(entry.date);
            const daysHeld = (now - entryDate) / (1000 * 60 * 60 * 24);
            const yearsHeld = daysHeld / 365.25;
            
            // We use the full amount invested, but the time factor is the key.
            return acc + (entry.amount * yearsHeld);
        }, 0);
        
        const totalInvested = kpis.totalInvested;
        
        if (weightedInvested === 0) return 0;
        
        // This is a highly simplified estimate for an XIRR-like CAGR:
        // (Total Value / Total Invested) ^ (Total Invested / Weighted Investment) - 1
        const averageHoldingPeriod = totalInvested / entries.length > 0 ? weightedInvested / totalInvested : 1;
        
        if (totalInvested === 0 || totalValue === 0) return 0;

        const cagr = Math.pow(totalValue / totalInvested, 1 / Math.max(0.01, averageHoldingPeriod)) - 1;
        
        return isNaN(cagr) ? 0 : cagr * 100; // Return as percentage
    }
    
    // XIRR is too complex for a pure self-contained file without external libraries or iterative solver.
    // We will use the simplified CAGR for both CAGR and XIRR display for consistency in this environment.
    function calculateXIRR(entries, totalValue) {
        // Placeholder: Use CAGR function as a substitute due to complexity of XIRR in vanilla JS
        return calculateCAGR(entries, totalValue);
    }
    
    // Generates investment KPIs for the tracker section based on date range
    function calculateInvestmentKPIs() {
        const range = document.getElementById('invDateRange').value;
        const startDate = getDateRangeStart(range);
        const now = new Date();
        
        const filteredEntries = kpis.investmentEntries.filter(d => new Date(d.date) >= startDate);
        
        const totalInvested = sum(filteredEntries);
        
        // Investment Value: Apply simplified 15% annualised return to get current value
        const totalValue = filteredEntries.reduce((value, entry) => {
            const entryDate = new Date(entry.date);
            const daysHeld = (now - entryDate) / (1000 * 60 * 60 * 24);
            const yearsHeld = daysHeld / 365.25;
            const futureValue = entry.amount * Math.pow(1 + 0.15, yearsHeld);
            return value + futureValue;
        }, 0);
        
        const absoluteGain = totalValue - totalInvested;
        
        const cagr = calculateCAGR(filteredEntries, totalValue);
        const xirr = calculateXIRR(filteredEntries, totalValue);
        
        const lumpsumCount = filteredEntries.filter(e => e.description.toLowerCase().includes('lumpsum')).length;
        const sipCount = filteredEntries.length - lumpsumCount; // Simplified: anything not 'lumpsum' is 'regular'
        
        // Trend: Simple check - if the total value is higher than the invested amount, the trend is positive.
        const trendIcon = absoluteGain >= 0 ? '<span class="trend-up">▲</span>' : '<span class="trend-down">▼</span>';
        const trendText = absoluteGain >= 0 ? 
            `${pct(absoluteGain / totalValue * 100)} Return` : 
            `${pct(absoluteGain / totalInvested * 100)} Loss`;
        
        return {
            totalInvested, totalValue, absoluteGain, cagr, xirr, lumpsumCount, sipCount, trendIcon, trendText, filteredEntries
        };
    }

    function renderInvestmentKPICharts() {
        const invKPIs = calculateInvestmentKPIs();
        
        // 1. Render KPIs
        document.getElementById('invTotalInvestedKPI').textContent = fmt(invKPIs.totalInvested);
        document.getElementById('invCurrentValue').textContent = fmt(invKPIs.totalValue);
        document.getElementById('invAbsoluteGain').textContent = fmt(invKPIs.absoluteGain);
        document.getElementById('invLumpsumCount').textContent = `${invKPIs.lumpsumCount} Lumpsums`;
        document.getElementById('invSIPCount').textContent = `${invKPIs.sipCount} Regular/SIPs`;
        
        document.getElementById('invValTrendIcon').innerHTML = invKPIs.trendIcon;
        document.getElementById('invValTrendText').textContent = invKPIs.trendText;
        
        document.getElementById('invCAGR').textContent = `${pct(invKPIs.cagr)} CAGR`;
        document.getElementById('invXIRR').textContent = `${pct(invKPIs.xirr)} XIRR`;
        
        // 2. Render Breakdown Panel
        renderInvestmentBreakdown(invKPIs.filteredEntries);
        
        // 3. Render Annual Return Chart (Simplified: Display CAGR in a bar)
        if (annualReturnChartInstance) annualReturnChartInstance.destroy();
        const ctxAnn = document.getElementById('annualReturnChart').getContext('2d');
        const cagrDisplay = invKPIs.cagr;
        annualReturnChartInstance = new Chart(ctxAnn, {
            type: 'bar',
            data: {
                labels: ['CAGR (Annualized)'],
                datasets: [{
                    label: 'Return %',
                    data: [cagrDisplay],
                    backgroundColor: cagrDisplay >= 0 ? 'var(--success)' : 'var(--danger)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: cagrDisplay >= 0, title: { display: true, text: 'Percentage (%)' } },
                    x: { grid: { display: false } }
                }
            }
        });
        
        // 4. Render Investment Growth Chart
        renderInvestmentGrowthChart(invKPIs.filteredEntries, 'invGrowthChart');
    }
    
    function renderInvestmentBreakdown(entries) {
        const invBreakdownContent = document.getElementById('invBreakdownContent');
        const viewMode = document.getElementById('invViewMode').value;
        const bucketFilter = document.getElementById('invBucketFilter').value;
        
        // Roll up data
        let treeMapData = [];
        let quickSubsHTML = '';

        if (viewMode === 'groups') {
             const grouped = rollupInvestmentGroups(entries);
             treeMapData = grouped.map(g => ({
                 value: g.amount,
                 key: g.group,
                 color: getColorPalette(Object.keys(MAJOR_BUCKETS).length).find((_, i) => Object.keys(MAJOR_BUCKETS)[i] === g.group) || 'var(--primary)'
             })).filter(d => !bucketFilter || MAJOR_BUCKETS[d.key] === bucketFilter);
             
             // Quick subs are the list of groups
             quickSubsHTML = `
                <div class="quick-sub-card col-span-1">
                    <div class="quick-sub-header">
                        <span class="quick-sub-title">${bucketFilter || 'All'} Groups</span>
                        <span class="total-badge">${fmt(treeMapData.reduce((sum, d) => sum + d.value, 0))}</span>
                    </div>
                    <div class="sub-dropdown-container">
                        ${treeMapData.map(d => `<div class="sub-dropdown-item"><span>${d.key}</span><span>${fmt(d.value)}</span></div>`).join('')}
                    </div>
                </div>
             `;
             
        } else if (viewMode === 'subcats') {
            const allSubcategories = entries.reduce((set, e) => {
                if(e.investmentSub) set.add(e.investmentSub);
                return set;
            }, new Set());

            const grouped = rollupInvestmentSubcategories(entries, bucketFilter);
            
            // Map the subcategories to colors, maybe by group or just sequentially
            treeMapData = grouped.map(g => ({
                value: g.amount,
                key: g.sub,
                color: getColorPalette(allSubcategories.size)[Array.from(allSubcategories).indexOf(g.sub)] || 'var(--primary)'
            }));
            
            // Quick subs are the list of subcategories
            quickSubsHTML = `
                <div class="quick-sub-card col-span-1">
                    <div class="quick-sub-header">
                        <span class="quick-sub-title">Subcategories ${bucketFilter ? `in ${bucketFilter}` : ''}</span>
                        <span class="total-badge">${fmt(treeMapData.reduce((sum, d) => sum + d.value, 0))}</span>
                    </div>
                    <div class="sub-dropdown-container">
                        ${grouped.map(d => `<div class="sub-dropdown-item"><span>${d.sub}</span><span>${fmt(d.amount)}</span></div>`).join('')}
                    </div>
                </div>
             `;
        }
        
        // Render the Grid
        invBreakdownContent.innerHTML = `
            <div class="card col-span-1" style="min-height: 350px;">
                <div class="card-header"><span class="card-title">${viewMode === 'groups' ? 'Group Breakdown' : 'Subcategory Breakdown'} (Invested Amount)</span></div>
                <div class="card-body" style="flex:1;">
                    <canvas id="invTreeMapChart"></canvas>
                </div>
            </div>
            <div id="invQuickSubs" class="col-span-1" style="display:grid; grid-template-columns:1fr; gap:16px;">
                ${quickSubsHTML}
            </div>
        `;

        // Render Tree Map Chart (Requires chartjs-chart-treemap.min.js)
        renderTreeMapChart(treeMapData, 'invTreeMapChart');
    }

    function renderTreeMapChart(data, canvasId) {
        if (Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
        
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'treemap',
            data: {
                datasets: [{
                    tree: data,
                    key: 'value',
                    groups: ['key'],
                    spacing: 4,
                    fontColor: 'white',
                    backgroundColor: context => context.raw.color,
                    labels: {
                        display: true,
                        formatter: context => [context.raw.key, fmt(context.raw.value)],
                        font: { size: 14, weight: 'bold' }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                tooltips: {
                    callbacks: {
                        label: (context) => [context.dataset.labels.formatter(context).join(' - ')],
                    }
                }
            }
        });
    }

    // Helper: Rollup investment entries by major group
    function rollupInvestmentGroups(entries) {
        const byGroup = entries.reduce((acc, curr) => {
            const group = curr.investmentGroup || 'Other';
            acc[group] = (acc[group] || 0) + Number(curr.amount);
            return acc;
        }, {});
        return Object.entries(byGroup).map(([group, amount]) => ({ group, amount })).sort((a,b) => b.amount - a.amount);
    }

    // Helper: Rollup investment entries by subcategory, optionally filtering by bucket
    function rollupInvestmentSubcategories(entries, selectedBucket) {
        const filtered = entries.filter(e => !selectedBucket || MAJOR_BUCKETS[e.investmentGroup] === selectedBucket);
        const bySub = filtered.reduce((acc, curr) => {
            const sub = curr.investmentSub || 'General';
            acc[sub] = (acc[sub] || 0) + Number(curr.amount);
            return acc;
        }, {});
        return Object.entries(bySub).map(([sub, amount]) => ({ sub, amount })).sort((a,b) => b.amount - a.amount);
    }
    
    function renderInvestmentGrowthChart(entries, canvasId) {
        if (invGrowthChartInstance) invGrowthChartInstance.destroy();
        
        const dataMap = entries.reduce((acc, curr) => {
            if (!curr.investmentGroup) return acc;
            const monthKey = curr.date.substring(0, 7);
            
            acc[monthKey] = acc[monthKey] || {};
            acc[monthKey][curr.investmentGroup] = (acc[monthKey][curr.investmentGroup] || 0) + Number(curr.amount);
            return acc;
        }, {});
        
        const uniqueGroups = Array.from(new Set(entries.map(e => e.investmentGroup).filter(g => g)));
        const sortedMonths = Object.keys(dataMap).sort();
        
        // Calculate cumulative totals per group
        let cumulativeData = {};
        let cumulativeGroupValues = uniqueGroups.reduce((acc, g) => ({ ...acc, [g]: 0 }), {});
        
        const colors = getColorPalette(uniqueGroups.length);
        const datasets = uniqueGroups.map((group, index) => ({
            label: group,
            data: [],
            backgroundColor: colors[index],
            borderColor: colors[index],
            fill: false,
            tension: 0.3
        }));

        sortedMonths.forEach(month => {
            uniqueGroups.forEach((group, index) => {
                const amount = dataMap[month][group] || 0;
                cumulativeGroupValues[group] += amount;
                
                // Add estimated monthly growth (1.2%) to prior value before adding new investment
                const prevValue = datasets[index].data.length > 0 ? datasets[index].data[datasets[index].data.length - 1] : 0;
                let estimatedGrowth = prevValue * 0.012; // Simplified
                
                datasets[index].data.push(prevValue + estimatedGrowth + amount);
            });
        });
        
        const ctx = document.getElementById(canvasId).getContext('2d');
        invGrowthChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedMonths.map(m => new Date(m).toLocaleString('default', { month: 'short', year: '2-digit' })),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                stacked: true,
                plugins: {
                    title: { display: false },
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: function(value) { return fmt(value); } }, stacked: true },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // ---------- ADVANCED ANALYTICS (MODAL) ----------

    // Reusable function to filter data for analytics charts
    function getFilteredAnalyticsData() {
        const range = document.getElementById('anlDateRange').value;
        const categoryFilter = document.getElementById('anlCategory').value;
        const invGroupFilter = document.getElementById('anlInvGroup').value;
        const invSubFilter = document.getElementById('anlInvSub').value;
        
        const startDate = getDateRangeStart(range);
        
        return data.filter(d => {
            const dateMatch = new Date(d.date) >= startDate;
            const categoryMatch = !categoryFilter || d.category === categoryFilter;
            const invGroupMatch = !invGroupFilter || d.investmentGroup === invGroupFilter;
            const invSubMatch = !invSubFilter || d.investmentSub === invSubFilter;
            
            return dateMatch && categoryMatch && invGroupMatch && invSubMatch;
        });
    }

    function renderAdvancedAnalyticsCharts() {
        const filteredData = getFilteredAnalyticsData();
        
        // Chart 1: Net Worth Trend (Uses the same logic as the dashboard NW chart, but with filtered data)
        // Note: The filter can make the NW calculation inaccurate unless filters are only for Investment.
        // For simplicity, we'll re-run the dashboard NW chart with the entire dataset and just change the filter label.
        // A truly filtered NW chart would require re-calculating the starting NW for the filter criteria.
        // **Compromise:** Run the main NW chart again, but with the entire data for correct NW values.
        // If the user filters, the title changes to reflect the filter, but the chart is always ALL TIME NW.
        // For actual filtering, we'll use a simpler chart like Expense/Income flow.
        
        // Chart 1: Net Worth Trend (Re-use Dashboard logic)
        renderNetWorthChart(data, 'chartNetWorthModal'); // Uses ALL data for NW integrity

        // Chart 2: Expense Flow Over Time (Monthly)
        renderExpenseFlowChart(filteredData, 'chartExpenseFlowModal');

        // Chart 3: Investment Types Distribution (Pie Chart)
        renderInvTypesPieChart(filteredData, 'chartInvTypesModal');
        
        // Chart 4: Investment Cumulative Growth (Filtered)
        renderInvestmentGrowthChart(filteredData.filter(d => d.type === 'expense' && d.category === 'Investments'), 'chartInvGrowthModal');
    }
    
    function renderExpenseFlowChart(txData, canvasId) {
        if (Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
        
        const expenseData = txData.filter(d => d.type === 'expense' && d.category !== 'Investments');
        const monthlyExpense = expenseData.reduce((acc, curr) => {
            const monthKey = curr.date.substring(0, 7);
            acc[monthKey] = (acc[monthKey] || 0) + Number(curr.amount);
            return acc;
        }, {});
        
        const sortedMonths = Object.keys(monthlyExpense).sort();
        const labels = sortedMonths.map(m => new Date(m).toLocaleString('default', { month: 'short', year: '2-digit' }));
        const values = sortedMonths.map(m => monthlyExpense[m]);

        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Expense',
                    data: values,
                    backgroundColor: 'var(--danger)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: function(value) { return fmt(value); } } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderInvTypesPieChart(txData, canvasId) {
        if (Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
        
        const invData = txData.filter(d => d.type === 'expense' && d.category === 'Investments');
        const invGroups = rollupInvestmentGroups(invData);
        
        const labels = invGroups.map(g => g.group);
        const values = invGroups.map(g => g.amount);
        const colors = getColorPalette(labels.length);

        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { callbacks: { label: ({ label, raw }) => `${label}: ${fmt(raw)} (${pct(raw / sum(values) * 100)})` } }
                }
            }
        });
    }

    // ---------- SETTINGS MANAGEMENT ----------

    function renderSettingLists() {
        // User Name
        document.getElementById('currentUser').textContent = settings.userName || 'Guest';
        document.getElementById('userNameInput').value = settings.userName || '';
        document.getElementById('profileNameDisplay').textContent = settings.userName;

        // CC Limit
        document.getElementById('ccLimitInput').value = settings.ccLimit;

        // Methods List
        const methodList = document.getElementById('methodList');
        methodList.innerHTML = Object.entries(settings.methods).map(([key, name]) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid #f1f5f9; font-size:13px;">
                <span>${name}</span>
                ${['bank_ac', 'credit_card'].includes(key) ? '<span style="color:var(--text-muted); font-size:10px;">(Default)</span>' : 
                `<button onclick="removeMethod('${key}')" class="btn-danger" style="padding:2px 6px; font-size:10px;">Remove</button>`}
            </div>
        `).join('');

        // Category List
        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = settings.categories.map(c => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid #f1f5f9; font-size:13px;">
                <span>${c}</span>
                ${BUILTIN_CATEGORIES.includes(c) ? '<span style="color:var(--text-muted); font-size:10px;">(Built-in)</span>' : 
                `<button onclick="removeCategory('${c}')" class="btn-danger" style="padding:2px 6px; font-size:10px;">Remove</button>`}
            </div>
        `).join('');
        
        // Income Sources List
        const incomeList = document.getElementById('incomeList');
        incomeList.innerHTML = settings.incomeSources.map(s => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid #f1f5f9; font-size:13px;">
                <span>${s}</span>
                ${['Salary'].includes(s) ? '<span style="color:var(--text-muted); font-size:10px;">(Default)</span>' : 
                `<button onclick="removeIncomeSource('${s}')" class="btn-danger" style="padding:2px 6px; font-size:10px;">Remove</button>`}
            </div>
        `).join('');

        // Market List (Ticker)
        const marketList = document.getElementById('marketList');
        marketList.innerHTML = settings.trackedMarkets.map(m => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid #f1f5f9; font-size:13px;">
                <span>${m.name} (${m.yahooTicker})</span>
                <button onclick="removeMarket('${m.yahooTicker}')" class="btn-danger" style="padding:2px 6px; font-size:10px;">Remove</button>
            </div>
        `).join('');
        
        setupEntryDropdowns(); // Re-populate data entry dropdowns with updated settings
    }
    
    // --- Settings handlers ---
    document.getElementById('saveUserNameBtn').addEventListener('click', () => {
        const newName = document.getElementById('userNameInput').value.trim();
        if (newName) {
            settings.userName = newName;
            saveAll();
            renderSettingLists();
        }
    });

    document.getElementById('saveCCLimitBtn').addEventListener('click', () => {
        const newLimit = Number(document.getElementById('ccLimitInput').value);
        if (newLimit > 0) {
            settings.ccLimit = newLimit;
            saveAll();
            renderSettingLists();
            renderKPIs();
        } else {
            alert('Please enter a positive number for the credit card limit.');
        }
    });

    document.getElementById('addMethodBtn').addEventListener('click', () => {
        const name = document.getElementById('newMethodName').value.trim();
        if (name) {
            const key = toKey(name);
            settings.methods[key] = name;
            document.getElementById('newMethodName').value = '';
            saveAll();
            renderSettingLists();
        }
    });

    function removeMethod(key) {
        if (confirm(`Are you sure you want to remove the method "${settings.methods[key]}"? Transactions using this method will retain the old key.`)) {
            delete settings.methods[key];
            saveAll();
            renderSettingLists();
        }
    }

    document.getElementById('addCategoryBtn').addEventListener('click', () => {
        const name = document.getElementById('newCategoryName').value.trim();
        if (name && !settings.categories.includes(name)) {
            settings.categories.push(name);
            document.getElementById('newCategoryName').value = '';
            saveAll();
            renderSettingLists();
        }
    });

    function removeCategory(name) {
        if (BUILTIN_CATEGORIES.includes(name)) {
            alert('This is a built-in category and cannot be removed.');
            return;
        }
        if (confirm(`Are you sure you want to remove the category "${name}"? Transactions using this category will be orphaned.`)) {
            settings.categories = settings.categories.filter(c => c !== name);
            saveAll();
            renderSettingLists();
        }
    }
    
    document.getElementById('addIncomeBtn').addEventListener('click', () => {
        const name = document.getElementById('newIncomeName').value.trim();
        if (name && !settings.incomeSources.includes(name)) {
            settings.incomeSources.push(name);
            document.getElementById('newIncomeName').value = '';
            saveAll();
            renderSettingLists();
        }
    });
    
    function removeIncomeSource(name) {
        if (['Salary'].includes(name)) {
            alert('This is a default income source and cannot be removed.');
            return;
        }
        if (confirm(`Are you sure you want to remove the income source "${name}"? Transactions using this source will be orphaned.`)) {
            settings.incomeSources = settings.incomeSources.filter(s => s !== name);
            saveAll();
            renderSettingLists();
        }
    }

    // --- Data Management Handlers ---

    document.getElementById('exportDataBtn').addEventListener('click', exportData);
    document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
    document.getElementById('importFileInput').addEventListener('change', importData);
    document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
    document.getElementById('factoryResetBtn').addEventListener('click', factoryReset);

    function loadSampleData() {
        if (!confirm('This will OVERWRITE your current data with sample entries. Continue?')) return;
        
        // Define some sample data
        const sampleData = [
            { id: uid(), date: '2024-01-01', type: 'opening_balance', amount: 500000, description: 'Initial Savings Deposit', category: 'Opening Balance', method: 'bank_ac' },
            { id: uid(), date: '2024-01-05', type: 'expense', amount: 50000, description: 'Rent Payment', category: 'Rent', method: 'bank_ac' },
            { id: uid(), date: '2024-01-10', type: 'income', amount: 150000, description: 'January Salary', category: 'Income', method: 'bank_ac', incomeSource: 'Salary' },
            { id: uid(), date: '2024-01-15', type: 'expense', amount: 5000, description: 'Groceries', category: 'Food', method: 'upi' },
            { id: uid(), date: '2024-02-01', type: 'expense', amount: 10000, description: 'SIP - ELSS', category: 'Investments', method: 'bank_ac', investmentGroup: 'Equity', investmentSub: 'Mutual Funds' },
            { id: uid(), date: '2024-02-05', type: 'expense', amount: 500, description: 'Coffee', category: 'Food', method: 'credit_card' },
            { id: uid(), date: '2024-02-15', type: 'expense', amount: 20000, description: 'Lumpsum Purchase - Tech Stock', category: 'Investments', method: 'bank_ac', investmentGroup: 'Equity', investmentSub: 'Stocks' },
            { id: uid(), date: '2024-03-01', type: 'credit_card_payment', amount: 500, description: 'CC Bill Payment', category: 'Credit Card Payment', method: 'bank_ac' },
            { id: uid(), date: '2024-03-10', type: 'income', amount: 25000, description: 'Freelance Project', category: 'Income', method: 'bank_ac', incomeSource: 'Freelance' }
        ];

        data = sampleData;
        
        // Reset settings to default with some custom methods/categories
        settings = { 
            ...DEFAULT_SETTINGS, 
            userName: 'Sample User',
            ccLimit: 250000,
            methods: { ...DEFAULT_METHODS, 'crypto': 'Crypto Exchange' },
            categories: [...DEFAULT_EXPENSE_CATEGORIES, 'Hobbies', 'Gifts'],
            incomeSources: [...DEFAULT_SETTINGS.incomeSources, 'Rental']
        };

        saveAll();
        renderAll();
        alert('Sample data loaded successfully!');
    }

    function exportData() {
        const profileData = { data, settings, timestamp: new Date().toISOString() };
        const dataStr = JSON.stringify(profileData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `moneymirror_backup_${currentProfile}_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        if (!confirm('Importing data will OVERWRITE your current profile data and settings. Continue?')) return;
        
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                
                if (imported.data && Array.isArray(imported.data)) {
                    data = imported.data;
                } else {
                    alert('Import failed: Data structure missing or incorrect.');
                    return;
                }
                
                if (imported.settings && typeof imported.settings === 'object') {
                    settings = { ...DEFAULT_SETTINGS, ...imported.settings };
                }
                
                // Final cleanup and save
                saveAll();
                renderAll();
                alert('Data imported successfully!');
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: Invalid JSON file.');
            }
        };
        reader.readAsText(file);
    }

    function factoryReset() {
        if (!confirm('DANGER! This will permanently ERASE ALL your transaction data and reset settings. Continue?')) return;
        if (!confirm('LAST WARNING! Are you absolutely sure? This action is irreversible.')) return;

        data = [];
        settings = { ...DEFAULT_SETTINGS };
        localStorage.removeItem(getTxKey());
        localStorage.removeItem(getSettingsKey());
        
        if (currentProfile && currentProfile !== 'Guest') {
            // Can't delete the Firestore document easily, but we can save empty data
            saveToFirestore(); 
        }

        renderAll();
        alert('Factory reset complete. All local data cleared.');
    }
    
    // ---------- MARKET TICKER LOGIC ----------
    
    function renderMarketTicker() {
        const ticker = document.getElementById('marketTicker');
        const markets = settings.trackedMarkets;
        
        const content = markets.map(m => {
            const isPositive = m.change >= 0;
            const changeClass = isPositive ? 'positive' : 'negative';
            const changeIcon = isPositive ? '▲' : '▼';
            
            return `
                <div class="ticker-item">
                    <span style="font-weight:600;">${m.name}</span>
                    <span style="margin-left:8px; font-weight:700;">${m.price.toLocaleString('en-IN')}</span>
                    <span class="${changeClass}" style="margin-left:8px;">${changeIcon} ${m.change}%</span>
                </div>
            `;
        }).join('');
        
        // Duplicate content to create the continuous scrolling effect
        ticker.innerHTML = content + content; 
    }
    
    document.getElementById('addMarketBtn').addEventListener('click', () => {
        const symbol = document.getElementById('newMarketSymbol').value.toUpperCase().trim();
        if (!symbol) return;
        
        if (settings.trackedMarkets.some(m => m.yahooTicker === symbol)) {
            alert('This market is already being tracked.');
            return;
        }

        // Add a placeholder entry
        const newMarket = {
            symbol: symbol,
            yahooTicker: symbol,
            name: symbol,
            price: 0.00,
            change: 0.00
        };
        
        settings.trackedMarkets.push(newMarket);
        document.getElementById('newMarketSymbol').value = '';
        saveAll();
        renderSettingLists();
        // Trigger a fetch to get the real data for the new symbol
        fetchRealMarketData();
    });
    
    document.getElementById('addSidebarIndexBtn').addEventListener('click', () => {
        const select = document.getElementById('sidebarIndexSelect');
        const selected = select.value;
        if (!selected) return;
        
        const [yahooTicker, name] = selected.split('|');
        
        if (settings.trackedMarkets.some(m => m.yahooTicker === yahooTicker)) {
            alert(`${name} is already being tracked.`);
            return;
        }
        
        const newMarket = { symbol: yahooTicker.replace('^', ''), yahooTicker, name, price: 0.00, change: 0.00 };
        settings.trackedMarkets.push(newMarket);
        select.value = '';
        saveAll();
        renderSettingLists();
        fetchRealMarketData();
    });

    function removeMarket(yahooTicker) {
        if (confirm('Are you sure you want to stop tracking this market?')) {
            settings.trackedMarkets = settings.trackedMarkets.filter(m => m.yahooTicker !== yahooTicker);
            saveAll();
            renderSettingLists();
            renderMarketTicker();
        }
    }
    
    // Proxy URL for Yahoo Finance API to bypass CORS (REPLACE WITH YOUR OWN CORS PROXY)
    // IMPORTANT: This service often breaks or requires a custom setup. 
    // If live prices don't work, this is the first place to check.
    const YAHOO_FINANCE_PROXY = "https://finance-api.vercel.app/api/v6/finance/quote?symbols=";

    // Utility function for exponential backoff retry (for API stability)
    async function exponentialBackoffFetch(url, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (i === maxRetries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, 2 ** i * 1000));
            }
        }
    }
    
    async function fetchRealMarketData() {
        if (settings.trackedMarkets.length === 0) {
            renderMarketTicker();
            return;
        }

        const symbols = settings.trackedMarkets.map(m => m.yahooTicker).join(',');
        const proxyUrl = `${YAHOO_FINANCE_PROXY}${symbols}`;

        // Fetch data for all tracked symbols concurrently
        const updatedMarkets = await Promise.all(settings.trackedMarkets.map(async (market) => {
            const yahooTicker = market.yahooTicker;
            try {
                // Use a separate fetch for each symbol to handle individual failures better
                const singleSymbolUrl = `${YAHOO_FINANCE_PROXY}${yahooTicker}`;
                const response = await exponentialBackoffFetch(singleSymbolUrl);
                const data = await response.json();
                const result = data.quoteResponse.result?.[0]; // Check for correct Yahoo response structure

                if (result) {
                    const price = result.regularMarketPrice;
                    const prevClose = result.regularMarketPreviousClose;
                    let change = 0;
                    if (prevClose && price && price !== prevClose) {
                        change = ((price - prevClose) / prevClose) * 100;
                    }
                    
                    return {
                        ...market,
                        name: result.longName || market.name,
                        price: Number((price || 0).toFixed(2)),
                        change: Number((change || 0).toFixed(2))
                    };
                } else {
                    console.warn(`[Ticker] No market data found for ${market.symbol} (${yahooTicker}) in API response.`);
                }
            } catch (error) {
                console.error(`[Ticker] CRITICAL FETCH FAIL for ${market.symbol} (${yahooTicker}):`, error.message);
            }

            return market;
        }));

        settings.trackedMarkets = updatedMarkets;
        renderMarketTicker();
    }

    let tickerInterval = null;
    function startTickerRealtimeLoop() {
        if (tickerInterval) clearInterval(tickerInterval);
        // Initial fetch, then repeat every 60 seconds
        fetchRealMarketData();
        tickerInterval = setInterval(fetchRealMarketData, 60000); 
    }

    // ---------- EVENT LISTENERS & SETUP ----------
    
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
            
            this.classList.add('active');
            const targetSectionId = this.getAttribute('data-section');
            document.getElementById(targetSectionId).classList.remove('hidden');
            
            // Close mobile menu on click
            document.getElementById('sidebar').classList.remove('mobile-open');

            // Trigger re-render of relevant content
            if (targetSectionId === 'dataEntry') renderFullDataList();
            if (targetSectionId === 'dashboard') renderKPIs();
            if (targetSectionId === 'investmentTracker') renderInvestmentKPICharts();
            if (targetSectionId === 'advancedAnalytics') {
                // Ensure initial analytics filters are set up
                setupAnalyticsFilters();
                renderAdvancedAnalyticsCharts();
            }
        });
    });

    // Mobile menu toggle
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('mobile-open');
    });

    // Investment Tracker Filters/Toggle
    document.getElementById('invDateRange').addEventListener('change', renderInvestmentKPICharts);
    document.getElementById('invViewMode').addEventListener('change', renderInvestmentKPICharts);
    document.getElementById('invBucketFilter').addEventListener('change', renderInvestmentKPICharts);
    document.getElementById('toggleInvBreakdown').addEventListener('click', () => {
        document.getElementById('invBreakdownPanel').classList.toggle('hidden');
        document.getElementById('toggleInvBreakdown').textContent = document.getElementById('invBreakdownPanel').classList.contains('hidden') ? 'View Breakdown' : 'Close';
    });

    // Analytics Filters
    function setupAnalyticsFilters() {
        const allCategories = Array.from(new Set(data.map(d => d.category))).filter(c => c && c !== 'Opening Balance');
        const catSelect = document.getElementById('anlCategory');
        catSelect.innerHTML = '<option value="">All Categories</option>' + 
            allCategories.map(c => `<option value="${c}">${c}</option>`).join('');

        const allGroups = Array.from(new Set(data.map(d => d.investmentGroup))).filter(g => g);
        const groupSelect = document.getElementById('anlInvGroup');
        groupSelect.innerHTML = '<option value="">All Inv. Groups</option>' + 
            allGroups.map(g => `<option value="${g}">${g}</option>`).join('');
            
        const allSubs = Array.from(new Set(data.map(d => d.investmentSub))).filter(s => s);
        const subSelect = document.getElementById('anlInvSub');
        subSelect.innerHTML = '<option value="">All Inv. Subs</option>' + 
            allSubs.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    document.getElementById('anlDateRange').addEventListener('change', renderAdvancedAnalyticsCharts);
    document.getElementById('anlCategory').addEventListener('change', renderAdvancedAnalyticsCharts);
    document.getElementById('anlInvGroup').addEventListener('change', renderAdvancedAnalyticsCharts);
    document.getElementById('anlInvSub').addEventListener('change', renderAdvancedAnalyticsCharts);
    
    // Initial setup calls
    document.addEventListener('DOMContentLoaded', () => {
        loadData(); // This calls loadProfileData which calls renderAll
        setupEntryDropdowns();
        setupAnalyticsFilters();
    });

    // ---------- EXPOSED GLOBALS (For onclick in HTML) ----------
    // Must be exposed since the code is self-contained HTML
    window.loadEdit = loadEdit;
    window.deleteEntry = deleteEntry;
    window.removeMethod = removeMethod;
    window.removeCategory = removeCategory;
    window.removeIncomeSource = removeIncomeSource;
    window.removeMarket = removeMarket;
    window.renderInvestmentKPICharts = renderInvestmentKPICharts;
    window.signInWithGoogle = signInWithGoogle;
    window.startGuestMode = startGuestMode;
    
    // --------------- CALCULATOR WIDGET LOGIC ---------------
    const calculator = document.getElementById('calculator');
    const calcToggle = document.getElementById('calc-toggle');
    const calcScreen = document.querySelector('.calc-screen');
    const calcButtons = document.querySelectorAll('.calc-buttons button');
    
    let expression = "";
    let isToggled = false;
    
    // Toggle visibility
    calcToggle.addEventListener('click', () => {
        isToggled = !isToggled;
        calculator.style.display = isToggled ? 'flex' : 'none';
        calcToggle.textContent = isToggled ? 'Hide Calculator' : 'Show Calculator';
    });

    document.getElementById('calc-close').addEventListener('click', () => {
        isToggled = false;
        calculator.style.display = 'none';
        calcToggle.textContent = 'Show Calculator';
    });
    
    // Button click logic
    calcButtons.forEach(button => {
        button.addEventListener('click', () => {
            const value = button.textContent.trim();

            if (value === 'C') {
                expression = "";
            } else if (value === '=') {
                try {
                    // Use new Function for safe evaluation (avoiding eval())
                    // Fix common issues before eval (e.g., 'x' to '*')
                    expression = expression.replace(/x/g, '*').replace(/%/g, '/100');
                    const result = new Function('return ' + expression)();
                    expression = result.toString();
                } catch (e) {
                    expression = "Error";
                }
            } else if (value === '←') {
                expression = expression.slice(0, -1);
            } else {
                if (expression === 'Error') expression = '';
                expression += value;
            }

            calcScreen.textContent = expression || "0";
            
            // If the user entered a number and presses a new number, replace the result
            if (value !== '=' && expression !== "Error" && /^\-?\d+(\.\d+)?$/.test(expression)) {
                // If it's a number, don't clear the screen yet
            }
        });
    });

    // Make calculator draggable
    let isDragging = false;
    let offsetX, offsetY;
    const calcHeader = document.querySelector('.calc-header');

    calcHeader.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.clientX - calculator.getBoundingClientRect().left;
        offsetY = e.clientY - calculator.getBoundingClientRect().top;
        calculator.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        calculator.style.left = (e.clientX - offsetX) + 'px';
        calculator.style.top = (e.clientY - offsetY) + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            calculator.style.cursor = 'grab';
        }
    });

    // Set initial position (hidden by default in CSS)
    calculator.style.left = 'unset'; 
    calculator.style.top = 'unset'; 
    
    // Initial state check for calculator
    if (!isToggled) calculator.style.display = 'none';
    // --------------- CALCULATOR WIDGET LOGIC END ---------------

  </script>
</body>
</html>
