<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — v5.0.2 (Auth + Stable UI + Investment breakdown)</title>

  <!-- Fonts + Charts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase compat (same as original v5.0.2) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6; --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.25s; justify-content: space-between; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px); pointer-events: none; }

    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    #authGate {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      color: white;
      text-align: center;
      padding: 0 24px;
    }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); }

    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; }
    .input-group-med { width: 25%; }
    .input-group-large { width: 45%; }

    .kpi-card { padding: 20px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    .cc-alert-high { background: #fee2e2 !important; border-color: var(--danger) !important; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted); }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600; color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1200px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
    .modal-pad { padding: 24px; }
    .modal-small { width: 400px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Calculator */
    #calculator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      height: 480px;
      z-index: 3000;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #f8fafc;
      border: 1px solid var(--border);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close-btn { background: transparent; border: none; color: #ef4444; font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    #calc-display { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    #calc-preview { background: #0b1323; color: #9fb3c8; text-align: right; font-size: 14px; padding: 6px 15px; font-family: monospace; height: 28px; border-top: 1px solid rgba(255,255,255,0.06); }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #calc-buttons button:hover { background: #f1f5f9; }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .calc-clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .calc-zero { grid-column: span 2; }
    .calc-equals { grid-row: span 2; background: var(--primary) !important; color: white !important; }

    /* Investment KPI breakdown grid and quick subcategories */
    .kpi-breakdown-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: white; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center; }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: 34px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 10px; width: 280px; box-shadow: 0 12px 24px rgba(0,0,0,0.15); z-index: 10; }
    .dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; border-radius: 8px; font-size: 12px; }
    .dropdown-item:hover { background: #f8fafc; }

    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }
    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; }
      aside .brand { margin-bottom: 0; }
      #mobileMenuBtn { display: block; }
      aside nav, .sidebar-footer { display: none; }
      aside.mobile-open nav {
        display: block;
        position: absolute;
        top: 60px; left: 0; right: 0;
        background: var(--sidebar-bg);
        padding: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 501;
      }
      aside.mobile-open .sidebar-footer {
        display: block;
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 501;
      }
      .dashboard-grid { grid-template-columns: 1fr; gap: 16px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr; }
      #calculator { top: 70px; left: 50%; transform: translateX(-50%); width: 90%; height: 480px; bottom: auto; right: auto; }
      .input-group-small, .input-group-med, .input-group-large, .full-width { width: 100% !important; }
    }
  </style>
</head>
<body>

<!-- Auth Gate -->
<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror — Personal Finance Dashboard</p>
  <p class="line line-3">by Rehan Hamdulay</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
</div>

<aside id="mainSidebar">
  <div style="width:100%">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
        MoneyMirror <span>v5.0</span>
      </div>
      <button id="mobileMenuBtn">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active" id="navDashboard">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>
      </div>
      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
      </div>
    </nav>
  </div>

  <div class="sidebar-footer">
    <div class="sys-stat">
      <span>Current profile</span>
      <span class="sys-val" id="profileNameDisplay">--</span>
    </div>
    <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.2 • Auth restored + Investment breakdown</div>
  </div>
</aside>

<main>
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
      <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
    </div>
    <div class="flex-row">
      <button class="btn-outline" id="sampleBtn">Load sample</button>
      <button class="btn-primary" id="importDataBtn">Import data (CSV/JSON)</button>
      <button class="btn-outline" id="exportBtn">Export CSV</button>
      <div id="calc-toggle" title="Toggle calculator" class="btn-primary" style="padding:8px 12px;">Calculator</div>
    </div>
  </div>

  <!-- KPI row -->
  <div class="dashboard-grid">
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--success)">Monthly income</div>
      <div class="kpi-value" id="kpiIncome">₹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--danger)">Monthly expenses</div>
      <div class="kpi-value" id="kpiExpense">₹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    <div class="card kpi-card col-span-1" id="ccCard" style="border-color:var(--warning); background:#fffbeb">
      <div class="card-title" id="ccTitle" style="color:var(--warning)">Credit card due</div>
      <div class="kpi-value" id="kpiCCDue">₹0</div>
      <div class="kpi-sub" style="color:#000; font-weight:700; margin-top: 6px; position:relative;">
        <span id="ccPaymentDate">Next Payment: 10th of December</span>
        <span style="font-weight:700; margin-left:10px;">Limit: <span id="ccLimitDisplay">₹2,00,000</span></span>
        <div id="ccAlert" class="hidden" style="position:absolute; right:0; top:0; color:var(--danger)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        </div>
      </div>
    </div>
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--primary)">Net liquidity</div>
      <div class="kpi-value" id="kpiNet">₹0</div>
      <div class="kpi-sub">Total available cash</div>
      <div class="account-list" id="netLiquidityBreakdown"></div>
    </div>

    <!-- KPI: Total Investment Value with breakdown charts and subcategories -->
    <div class="card kpi-card col-span-4" style="background:#e0f2fe; border-color:#075985;">
      <div class="card-header" style="padding:16px 20px 0 20px;">
        <div class="card-title" style="color:#075985">Total investment value (historical cost)</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px; font-size:12px;">View breakdown</button>
          <button id="viewCategoriesBtn" class="btn-outline" style="padding:6px 10px; font-size:12px;">View subcategories</button>
        </div>
      </div>
      <div class="card-body" style="padding-top:6px;">
        <div class="kpi-value" id="kpiInvest">₹0</div>
        <div class="kpi-sub" id="momInvest" style="color:#075985">Historical cost total</div>

        <!-- Breakdown panel -->
        <div id="invBreakdownPanel" class="hidden" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
          <div class="card" style="border-color:#93c5fd; margin-bottom:12px;">
            <div class="card-header">
              <div class="card-title">Filters</div>
              <div class="flex-row" style="gap:10px; flex-wrap:wrap;">
                <div style="min-width:220px;">
                  <label>Major bucket</label>
                  <select id="invBucketFilter"></select>
                </div>
                <div style="min-width:220px;">
                  <label>View mode</label>
                  <select id="invViewMode">
                    <option value="top4">Top 4 buckets</option>
                    <option value="subcats">Subcategories of selected bucket</option>
                  </select>
                </div>
                <div style="min-width:220px;">
                  <label>Date range</label>
                  <select id="invDateRange">
                    <option value="6">Last 6 months</option>
                    <option value="12">Last 12 months</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="kpi-breakdown-grid">
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invBarTitle">Investment by major bucket</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownBar"></canvas>
              </div>
            </div>
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invPieTitle">Share by bucket</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownPie"></canvas>
              </div>
            </div>
          </div>

          <!-- Quick subcategories with buttons -->
          <div style="margin-top:14px;">
            <div class="card-title" style="font-size:13px; color:#075985;">Bucket subcategories quick view</div>
            <div id="invQuickSubs" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main charts row -->
  <div class="dashboard-grid">
    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Cash flow & investments</div>
        <select id="mainChartFilter">
          <option value="6">Last 6 months</option>
          <option value="12">Last 12 months</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:320px; width:100%; position:relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card col-span-2">
      <div class="card-header" style="gap:12px;">
        <div class="card-title">Wallet breakdown and expense analysis</div>
        <div class="flex-row" style="gap:8px;">
          <select id="walletMode">
            <option value="wallet">Wallet breakdown (Liquid & Savings)</option>
            <option value="expenses">Expense distribution (Top 10)</option>
          </select>
          <select id="walletCategoryFilter" class="hidden">
            <option value="">All categories</option>
          </select>
        </div>
      </div>
      <div class="card-body" style="display:flex; flex-direction:row; align-items:center; gap:20px; flex:1">
        <div style="height:280px; width:50%; max-width: 320px; position:relative;">
          <canvas id="donutChart"></canvas>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
          <div id="walletLegend" style="font-size:12px; color:var(--text-muted);"></div>
          <div id="walletInfo" style="font-size:12px; color:var(--text-muted);"></div>
          <button id="resetExpenseDrilldown" class="btn-outline hidden" style="padding:6px; font-size:12px">View all categories</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add entry + recent transactions -->
  <div class="dashboard-grid">
    <div class="card action-card col-span-4" id="addEntryCard">
      <div class="action-header">
        <div class="card-title">Add new entry</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </div>
      <div class="action-body">
        <div class="input-group-small">
          <label>Type</label>
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="opening_balance">Opening Balance</option>
          </select>
        </div>
        <div class="input-group-small">
          <label>Amount (₹)</label>
          <input id="amount" type="number" placeholder="0.00" style="font-weight:700; font-size:16px" step="any" />
        </div>
        <div class="input-group-small">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div class="input-group-large">
          <label>Description</label>
          <input id="desc" placeholder="What is this for?" style="flex:1" />
        </div>

        <div id="dynamicFieldsContainer" class="full-width" style="border-top:1px solid var(--border); padding-top:15px">
          <div id="regularFields" style="display:flex; gap:20px; flex-wrap:wrap">
            <div id="categoryContainer" class="input-group-small">
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div class="input-group-small">
              <label>Method</label>
              <select id="method"></select>
            </div>
            <div id="incomeSourceRow" class="hidden input-group-small">
              <label>Source</label>
              <select id="incomeSource"></select>
            </div>

            <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="input-group-small">
                <label>Investment category</label>
                <select id="invGroup"></select>
              </div>
              <div class="input-group-small">
                <label>Investment sub-type</label>
                <select id="invSub"></select>
              </div>
            </div>

            <div id="insuranceRow" class="hidden input-group-med">
              <label>Insurance details</label>
              <div class="flex-row">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>

          <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-small">
              <label>Asset type</label>
              <select id="openingType">
                <option value="Cash">Cash (Liquid)</option>
                <option value="Investment">Investment Asset</option>
              </select>
            </div>
            <div class="input-group-small hidden" id="openingGroupContainer">
              <label id="openingGroupLabel">Asset category</label>
              <select id="openingGroup"></select>
            </div>
            <div class="input-group-small hidden" id="openingSubContainer">
              <label id="openingSubLabel">Account / Asset sub-type</label>
              <select id="openingSub"></select>
            </div>
          </div>
        </div>

        <div style="width:100%; display:flex; gap:10px; margin-top:10px">
          <button class="btn-primary" id="addBtn">Add entry</button>
          <button class="btn-primary hidden" id="saveBtn">Save changes</button>
          <button class="btn-outline hidden" id="cancelBtn">Cancel edit</button>
        </div>
      </div>
    </div>

    <div class="card col-span-4">
      <div class="card-header">
        <div class="card-title">Recent transactions</div>
        <div class="flex-row">
            <select id="entryLimit">
                <option value="10">Last 10</option>
                <option value="25">Last 25</option>
                <option value="50">Last 50</option>
                <option value="all">All</option>
            </select>
        </div>
      </div>
      <div class="card-body table-container">
        <table id="recentTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Description</th>
              <th>Category</th>
              <th>Method</th>
              <th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Settings modal -->
<div id="settingsModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Settings & Configuration</div>
      <button class="btn-outline" id="closeSettings" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Payment methods</label>
        <div id="methodEditor" style="border:1px solid var(--border); border-radius:8px; padding:10px;"></div>
        <div class="flex-row" style="margin-top:10px">
          <input id="newMethod" placeholder="New method (e.g. SBI UPI)" />
          <button class="btn-primary" id="addMethod">Add</button>
        </div>
      </div>
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Income sources</label>
        <div class="flex-row">
          <input id="newIncome" placeholder="New source name" />
          <button class="btn-primary" id="addIncomeBtn">Add</button>
        </div>
        <div id="incomeList" style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap"></div>
      </div>
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Credit card limit</label>
        <div class="flex-row">
          <input id="ccLimitInput" type="number" placeholder="Set limit (e.g. 200000)" />
          <button class="btn-primary" id="saveCCLimit">Save limit</button>
        </div>
      </div>
      <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px">
        <label style="color:var(--danger)">Danger zone</label>
        <div class="flex-row">
          <button class="btn-danger" id="resetBtn">Factory reset profile</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Analytics modal -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Advanced financial analytics</div>
      <button class="btn-outline" id="closeAnalytics" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad" id="analyticsContent">
      <div id="analyticsFilters">
        <div class="filter-group">
          <h3 style="margin-top:0; font-size:16px;">Filter data</h3>
          <div style="display:flex; gap:20px; flex-wrap:wrap">
            <div style="flex:1">
              <label>Date range</label>
              <select id="dateFilter">
                <option value="6">Last 6 months</option>
                <option value="12">Last 12 months</option>
                <option value="all">All time</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Chart type</label>
              <select id="chartType">
                <option value="line">Line chart</option>
                <option value="bar">Bar chart</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <h3 style="margin-top:30px; font-size:18px;">Cumulative net worth</h3>
      <div class="card" style="margin-bottom:20px">
        <div class="card-body" style="padding-top:20px;">
          <div style="height:350px; width:100%; position:relative">
            <canvas id="chartNetWorth"></canvas>
          </div>
        </div>
      </div>

      <h3 style="margin-top:10px; font-size:18px;">Investment analysis</h3>
      <div class="card" style="margin-bottom:20px">
        <div class="card-body" style="padding-top:20px;">
          <div style="display:grid; gap:16px; grid-template-columns:1fr 1fr;">
            <div style="height:280px; position:relative;">
              <canvas id="chartInvTypesModal"></canvas>
            </div>
            <div style="height:280px; position:relative;">
              <canvas id="chartInvGrowthModal"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Import modal -->
<div id="importModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Import data</div>
      <button class="btn-outline" id="closeImport" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <h4 style="margin-top:0;">Import from CSV/JSON</h4>
      <p style="font-size:13px; color:var(--text-muted);">
        CSV columns: type, amount, date, desc, category, method. Optional: income_source, investment_group, investment_sub, insurance_type, insurance_for.
      </p>
      <input type="file" id="importFile" accept=".csv,.json" style="width:100%; margin:10px 0 20px 0;" />
      <button class="btn-primary full-width" id="processImportBtn">Process file</button>
    </div>
  </div>
</div>

<!-- Calculator -->
<div id="calculator">
  <div id="calc-header">
    <span>Calculator</span>
    <button id="calc-close-btn">×</button>
  </div>
  <div id="calc-display">0</div>
  <div id="calc-preview">Enter an expression…</div>
  <div id="calc-buttons">
    <button class="calc-clear">AC</button>
    <button class="calc-clear">±</button>
    <button class="calc-clear">%</button>
    <button class="calc-operator">/</button>
    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button class="calc-operator">*</button>
    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button class="calc-operator">-</button>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="calc-operator">+</button>
    <button class="calc-zero">0</button>
    <button>.</button>
    <button class="calc-equals">=</button>
  </div>
</div>

<script>
  // Firebase config (as-is from original)
  const firebaseConfig = {
    apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
    authDomain: "moneymirror-22543.firebaseapp.com",
    projectId: "moneymirror-22543",
    storageBucket: "moneymirror-22543.firebasestorage.app",
    messagingSenderId: "61775081584",
    appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
    measurementId: "G-8RPXH1VEFG"
  };

  let db = null;
  let auth = null;
  let USE_FIRESTORE = false;
  const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';
  let currentProfile = null;

  try {
    const app = firebase.initializeApp(firebaseConfig);
    db = app.firestore();
    auth = app.auth();
    USE_FIRESTORE = true;
  } catch (e) {
    USE_FIRESTORE = false;
  }

  // Root cause that previously blocked clicks:
  // - main was blurred and pointer-events disabled until auth state set
  // Fix:
  // - onAuthStateChanged toggles gate and main filter/pointer-events appropriately
  // - local fallback allows sample/import/export pre-auth if needed (optional)
  function enableAppUI(profileName) {
    document.getElementById('authGate').style.display = 'none';
    const mainEl = document.querySelector('main');
    mainEl.style.filter = 'none';
    mainEl.style.pointerEvents = 'auto';
    document.getElementById('logoutBtn').style.display = 'block';
    document.getElementById('profileNameDisplay').textContent = profileName || 'User';
  }

  function disableAppUI() {
    document.getElementById('authGate').style.display = 'flex';
    const mainEl = document.querySelector('main');
    mainEl.style.filter = 'blur(5px)';
    mainEl.style.pointerEvents = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('profileNameDisplay').textContent = '--';
  }

  async function signInWithGoogle() {
    if (!auth) { alert('Auth not initialized. Please refresh.'); return; }
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      onUserSignedIn(user);
    } catch (err) {
      console.error('Login failed:', err);
      alert('Sign-in popup blocked. Allow popups and try again.');
    }
  }

  function onUserSignedIn(user) {
    currentProfile = user.displayName || user.email || 'User';
    localStorage.setItem('mm_last_profile', currentProfile);
    enableAppUI(currentProfile);
    loadProfileData();
  }

  function signOutUser() {
    if (!auth) return;
    auth.signOut().then(() => {
      currentProfile = null;
      disableAppUI();
      // Clear charts to avoid tooltips lingering
      teardownCharts();
    });
  }

  // Global state
  const DEFAULT_CC_LIMIT = 200000;
  const CANONICAL_METHODS = {
    'cash': 'Cash',
    'salary_acct': 'Bank Account (Salary)',
    'savings_acct': 'Bank Account (Savings)',
    'credit_card': 'Credit Card',
    'digital_wallet': 'Digital Wallet'
  };
  const BASE_CATS = ['Food', 'Rent', 'Utilities', 'Shopping', 'Entertainment', 'Travel', 'Health', 'Investments', 'Insurance', 'Credit Card Payment', 'Misc'];

  const INVESTMENT_STRUCTURE = {
      'Equity (Stocks)': {
          'India - Large Cap/Mid Cap/Small Cap': 'Equity (Stocks)',
          'India - Index Stocks/Preferred Stock': 'Equity (Stocks)',
          'India - Derivatives (Options/Futures)': 'Equity (Stocks)',
          'US - Stocks': 'Equity (Stocks)',
          'International - Other': 'Equity (Stocks)',
      },
      'Mutual Funds': {
          'Equity MF - Large Cap/Mid Cap/Small Cap': 'Mutual Funds',
          'Equity MF - Multi-cap': 'Mutual Funds',
          'Equity MF - ELSS (Tax Saving)': 'Mutual Funds',
          'Debt MF - Overnight/Liquid/Ultra Short Term': 'Mutual Funds',
          'Debt MF - Corporate/Dynamic Bond': 'Mutual Funds',
          'Hybrid/Balanced MF': 'Mutual Funds',
          'International/Global Index MF': 'Mutual Funds',
          'Gold/Sectoral/Thematic MF': 'Mutual Funds',
      },
      'ETFs': {
          'Equity ETF': 'ETFs',
          'Debt ETF': 'ETFs',
          'Gold ETF': 'ETFs',
          'Index ETF': 'ETFs',
          'Thematic ETF': 'ETFs',
      },
      'Bonds & Debt Instruments': {
          'Government Bonds': 'Bonds & Debt Instruments',
          'Corporate Bonds': 'Bonds & Debt Instruments',
          'Treasury Bills': 'Bonds & Debt Instruments',
          'Tax-Free Bonds': 'Bonds & Debt Instruments',
          'Sovereign Gold Bonds (SGB)': 'Bonds & Debt Instruments',
      },
      'Commodities': {
          'Gold (Physical/Digital)': 'Commodities',
          'Silver': 'Commodities',
          'Crude Oil/Natural Gas': 'Commodities',
          'Other Metals (Copper/Nickel)': 'Commodities',
      },
      'Crypto & Digital Assets': {
          'Bitcoin (BTC)': 'Crypto & Digital Assets',
          'Ethereum (ETH)': 'Crypto & Digital Assets',
          'Stablecoins': 'Crypto & Digital Assets',
          'Altcoins': 'Crypto & Digital Assets',
          'NFTs / Web3 Assets': 'Crypto & Digital Assets',
      },
      'Real Estate': {
          'Residential Property': 'Real Estate',
          'Commercial Property': 'Real Estate',
          'Land': 'Real Estate',
          'REITs (Real Estate Investment Trusts)': 'Real Estate',
      },
      'Fixed Income / Savings Schemes': {
          'FD (Fixed Deposit)': 'Fixed Income / Savings Schemes',
          'RD (Recurring Deposit)': 'Fixed Income / Savings Schemes',
          'PPF': 'Fixed Income / Savings Schemes',
          'NSC/KVP/Postal MIS': 'Fixed Income / Savings Schemes',
          'High-Interest Savings Account': 'Fixed Income / Savings Schemes',
      },
      'Retirement Funds': {
          'NPS Tier 1/Tier 2': 'Retirement Funds',
          'EPF (Employees’ Provident Fund)': 'Retirement Funds',
          'IRA/401k (USA users)': 'Retirement Funds',
          'Other Pension Schemes': 'Retirement Funds',
      },
      'Other Investments': {
          'Angel Investing / Startup Equity': 'Other Investments',
          'Peer-to-Peer Lending': 'Other Investments',
          'Private Funds / AIFs': 'Other Investments',
          'Alternative Assets': 'Other Investments',
      }
  };

  const MAJOR_BUCKETS = {
    'Equity (Stocks)': 'Equity',
    'Mutual Funds': 'Mutual Funds',
    'ETFs': 'ETFs',
    'Bonds & Debt Instruments': 'Debt',
    'Fixed Income / Savings Schemes': 'Debt',
    'Retirement Funds': 'Retirement',
    'Real Estate': 'Real Estate',
    'Commodities': 'Commodities',
    'Crypto & Digital Assets': 'Crypto',
    'Other Investments': 'Other'
  };

  let data = [];
  let methodNames = {...CANONICAL_METHODS};
  let incomeSources = ['Salary', 'Freelance', 'Interest'];
  let settings = { ccLimit: DEFAULT_CC_LIMIT };
  let editId = null;

  const $ = id => document.getElementById(id);
  const formEls = {
    type: $('type'), amount: $('amount'), date: $('date'), desc: $('desc'),
    category: $('category'), method: $('method'), incomeSource: $('incomeSource'),
    invGroup: $('invGroup'), invSub: $('invSub'),
    openingType: $('openingType'), openingGroup: $('openingGroup'), openingSub: $('openingSub'),
    openingSubLabel: $('openingSubLabel'),
    insType: $('insType'), insFor: $('insFor'),
    addBtn: $('addBtn'), saveBtn: $('saveBtn'), cancelBtn: $('cancelBtn'),
    categoryContainer: $('categoryContainer'), incomeRow: $('incomeSourceRow'),
    invRow: $('investmentRow'), insRow: $('insuranceRow'),
    openingBalanceRow: $('openingBalanceRow'), regularFieldsDiv: $('regularFields'),
  };

  // Charts references
  let chartMain = null, donutChart = null, chartNetWorth = null, chartInvTypesModal = null, chartInvGrowthModal = null;
  let invBreakdownBarChart = null, invBreakdownPieChart = null;

  function teardownCharts() {
    [chartMain, donutChart, chartNetWorth, chartInvTypesModal, chartInvGrowthModal, invBreakdownBarChart, invBreakdownPieChart]
      .forEach(ch => { try { ch && ch.destroy(); } catch(e){} });
    chartMain = donutChart = chartNetWorth = chartInvTypesModal = chartInvGrowthModal = invBreakdownBarChart = invBreakdownPieChart = null;
  }

  // Persistence bound to profile
  function key(k){ return `mm_${k}_${(currentProfile||'local').toLowerCase().replace(/[^a-z0-9]+/g,'_')}`; }
  function saveLocal(){
    localStorage.setItem(key('data'), JSON.stringify(data));
    localStorage.setItem(key('methods'), JSON.stringify(methodNames));
    localStorage.setItem(key('income'), JSON.stringify(incomeSources));
    localStorage.setItem(key('settings'), JSON.stringify(settings));
  }
  function restoreLocal(){
    methodNames = JSON.parse(localStorage.getItem(key('methods'))) || {...CANONICAL_METHODS};
    incomeSources = JSON.parse(localStorage.getItem(key('income'))) || ['Salary', 'Freelance', 'Interest'];
    data = (JSON.parse(localStorage.getItem(key('data'))) || []).map(d => ({
      id: d.id, type: d.type || 'expense', amount: Number(d.amount)||0, date: d.date || new Date().toISOString().slice(0,10),
      desc: d.desc || '', category: d.category || 'Misc', method: d.method || 'cash',
      incomeSource: d.incomeSource || '', investmentGroup: d.investmentGroup || '', investmentSub: d.investmentSub || '',
      insuranceType: d.insuranceType || '', insuranceFor: d.insuranceFor || '',
    }));
    settings = JSON.parse(localStorage.getItem(key('settings'))) || { ccLimit: DEFAULT_CC_LIMIT };
  }

  async function loadProfileData() {
    restoreLocal();
    if (USE_FIRESTORE && db && currentProfile) {
      try {
        const docSnap = await db.collection(FIRESTORE_COLLECTION_NAME).doc(key('doc')).get();
        if (docSnap.exists) {
          const server = docSnap.data();
          data = server.data || data;
          methodNames = server.methodNames || methodNames;
          incomeSources = server.incomeSources || incomeSources;
          settings = server.settings || settings;
        }
      } catch (e) {
        console.warn('Firestore read error, using local:', e);
      }
    }
    renderAll();
  }

  function saveAll() {
    saveLocal();
    if (USE_FIRESTORE && db && currentProfile) {
      db.collection(FIRESTORE_COLLECTION_NAME).doc(key('doc')).set({
        data, methodNames, incomeSources, settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(err => console.warn('Firestore write error:', err));
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Date header
    const d = new Date();
    $('currentDate').innerText = d.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    if (formEls.date) formEls.date.value = new Date().toISOString().slice(0,10);

    // Wire auth buttons
    $('loginBtn').addEventListener('click', signInWithGoogle);
    $('logoutBtn').addEventListener('click', signOutUser);

    // Auth gate toggle
    if (auth) {
      auth.onAuthStateChanged(user => {
        if (user) onUserSignedIn(user);
        else disableAppUI();
      });
    } else {
      // Fallback: allow local usage without auth (optional)
      enableAppUI('Local');
      loadProfileData();
    }

    // Mobile menu
    $('mobileMenuBtn').addEventListener('click', () => {
      $('mainSidebar').classList.toggle('mobile-open');
    });
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => $('mainSidebar').classList.remove('mobile-open'));
    });

    // Nav actions
    $('navSettings').addEventListener('click', () => $('settingsModal').classList.add('open'));
    $('closeSettings').addEventListener('click', () => $('settingsModal').classList.remove('open'));
    $('navAnalytics').addEventListener('click', () => {
      $('analyticsModal').classList.add('open');
      renderAdvancedCharts();
      renderInvestmentAnalytics();
    });
    $('closeAnalytics').addEventListener('click', () => $('analyticsModal').classList.remove('open'));

    // Import modal
    $('importDataBtn').addEventListener('click', () => $('importModal').classList.add('open'));
    $('closeImport').addEventListener('click', () => $('importModal').classList.remove('open'));

    // App buttons
    $('sampleBtn').addEventListener('click', loadSampleData);
    $('exportBtn').addEventListener('click', () => convertToCSV(data));
    $('processImportBtn').addEventListener('click', processImportedData);

    // Calculator
    $('calc-toggle').addEventListener('click', () => { const c = $('calculator'); c.style.display = c.style.display==='none' ? 'flex' : 'none'; });
    $('calc-close-btn').addEventListener('click', () => $('calculator').style.display = 'none');
    document.querySelectorAll('#calc-buttons button').forEach(btn => btn.addEventListener('click', handleCalculatorInput));
    dragElement($('calculator'));

    // Entry form buttons
    formEls.addBtn.addEventListener('click', () => submitForm());
    formEls.saveBtn.addEventListener('click', () => { const e = data.find(t => t.id === editId); if (e) submitForm(e); });
    formEls.cancelBtn.addEventListener('click', cancelEdit);

    // Dropdown listeners
    $('mainChartFilter').addEventListener('change', renderCharts);
    $('walletMode').addEventListener('change', renderWalletUnified);
    $('walletCategoryFilter').addEventListener('change', renderWalletUnified);
    $('entryLimit').addEventListener('change', renderRecentEntries);
    $('invBucketFilter').addEventListener('change', renderInvestmentKPICharts);
    $('invViewMode').addEventListener('change', renderInvestmentKPICharts);
    $('invDateRange').addEventListener('change', renderInvestmentKPICharts);

    // Settings listeners
    $('addMethod').addEventListener('click', addMethod);
    $('addIncomeBtn').addEventListener('click', addIncome);
    $('saveCCLimit').addEventListener('click', saveCCLimit);

    // Form dynamic setup
    setupDropdowns();
    setupInvestmentFilters();
  });

  function renderAll(){
    data.sort((a,b)=> new Date(b.date) - new Date(a.date));
    renderKPIs();
    renderCharts();
    renderWalletUnified();
    renderRecentEntries();
    renderSettings();
    renderInvestmentKPICharts();
  }

  function setupDropdowns(){
    formEls.method.innerHTML = Object.keys(methodNames).filter(k => k!=='credit_card').map(k => `<option value="${k}">${methodNames[k]}</option>`).join('');
    formEls.incomeSource.innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');
    formEls.category.innerHTML = BASE_CATS.map(c => `<option value="${c}">${c}</option>`).join('');
    formEls.type.onchange = updateFormFields;
    formEls.category.onchange = updateFormFields;
    formEls.openingType.onchange = updateFormFields;
    formEls.invGroup.onchange = () => updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
    formEls.openingGroup.onchange = () => updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub);
    populateInvestmentGroupDropdowns();
    updateFormFields();
  }

  function populateInvestmentGroupDropdowns(){
    const opts = Object.keys(INVESTMENT_STRUCTURE).map(group => `<option value="${group}">${group}</option>`).join('');
    formEls.invGroup.innerHTML = '<option value="">Select Category</option>' + opts;
    formEls.openingGroup.innerHTML = '<option value="">Select Category</option>' + opts;
  }

  function updateInvestmentSubDropdown(groupEl, subEl, initial=null){
    const grp = groupEl.value;
    let html = '<option value="">Select Sub-Type</option>';
    if (grp && INVESTMENT_STRUCTURE[grp]) {
      const subs = Object.keys(INVESTMENT_STRUCTURE[grp]);
      html += subs.map(s => `<option value="${s}" ${initial===s?'selected':''}>${s}</option>`).join('');
    }
    subEl.innerHTML = html;
  }

  function updateFormFields(edit=null){
    const t = formEls.type.value;
    const cat = formEls.category.value;
    const ob = formEls.openingType.value;

    formEls.regularFieldsDiv.classList.remove('hidden');
    formEls.openingBalanceRow.classList.add('hidden');
    formEls.incomeRow.classList.add('hidden');
    formEls.invRow.classList.add('hidden');
    formEls.insRow.classList.add('hidden');
    formEls.categoryContainer.classList.remove('hidden');
    $('openingGroupContainer').classList.add('hidden');
    $('openingSubContainer').classList.add('hidden');

    populateInvestmentGroupDropdowns();

    if (t==='opening_balance'){
      formEls.openingBalanceRow.classList.remove('hidden');
      formEls.regularFieldsDiv.classList.add('hidden');

      if (ob==='Investment'){
        $('openingGroupContainer').classList.remove('hidden');
        $('openingSubContainer').classList.remove('hidden');
        $('openingGroupLabel').textContent = 'Investment Category';
        $('openingSubLabel').textContent = 'Investment Sub-Type';
        if (edit){ formEls.openingGroup.value = edit.investmentGroup || ''; updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub, edit.investmentSub); }
        else { updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub); }
      } else {
        $('openingSubContainer').classList.remove('hidden');
        $('openingGroupLabel').textContent = 'Account Group';
        $('openingSubLabel').textContent = 'Cash Account';
        formEls.openingGroup.innerHTML = `<option value="Cash">Cash</option>`;
        formEls.openingSub.innerHTML = `<option value="">Select Account</option>` + Object.keys(methodNames).filter(k => k!=='credit_card').map(k => `<option value="${k}" ${edit && edit.method===k ? 'selected':''}>${methodNames[k]}</option>`).join('');
      }
    } else if (t==='income'){
      formEls.incomeRow.classList.remove('hidden');
      formEls.categoryContainer.classList.add('hidden');
    } else if (t==='expense'){
      if (cat==='Investments'){
        formEls.invRow.classList.remove('hidden');
        if (edit){ formEls.invGroup.value = edit.investmentGroup || ''; updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, edit.investmentSub); }
        else { updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub); }
      } else if (cat==='Insurance'){
        formEls.insRow.classList.remove('hidden');
      }
    }
  }

  function uid(){ return 'id' + Date.now() + Math.random().toString(16).slice(2); }
  function fmt(n){ return (n||0).toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
  function pct(n){ return (n||0).toFixed(1) + '%'; }
  function getNextPaymentMonth(){
    const today = new Date(); const paymentDay=10;
    const dt = new Date(today.getFullYear(), today.getMonth(), paymentDay);
    if (today.getDate()>paymentDay) dt.setMonth(dt.getMonth()+1);
    return dt.toLocaleDateString('en-IN',{month:'long'});
  }

  function submitForm(e=null){
    if (!currentProfile) { alert('Please sign in to add entries.'); return; }

    const type = formEls.type.value;
    const amount = Number(formEls.amount.value);
    const date = formEls.date.value;
    const desc = formEls.desc.value;
    const method = formEls.method.value;

    if (!amount || amount<=0) return alert('Enter a valid amount.');
    if (!date) return alert('Select a date.');
    if (!desc) return alert('Enter a description.');

    const entry = {
      id: e ? e.id : uid(), type, amount, date, desc,
      category: '', method: method, incomeSource: '',
      investmentGroup: '', investmentSub: '', insuranceType: '', insuranceFor: ''
    };

    if (type==='income'){
      entry.incomeSource = formEls.incomeSource.value || '';
      entry.category = 'N/A';
    } else if (type==='opening_balance'){
      if (formEls.openingType.value==='Cash'){
        entry.method = formEls.openingSub.value || method;
        entry.investmentGroup = 'Cash';
        entry.investmentSub = formEls.openingSub.value || '';
      } else {
        entry.method = '';
        entry.investmentGroup = formEls.openingGroup.value || '';
        entry.investmentSub = formEls.openingSub.value || '';
      }
      entry.category = 'N/A';
    } else { // expense
      entry.category = formEls.category.value || 'Misc';
      if (entry.category==='Investments'){
        entry.investmentGroup = formEls.invGroup.value || '';
        entry.investmentSub = formEls.invSub.value || '';
      } else if (entry.category==='Insurance'){
        entry.insuranceType = formEls.insType.value || 'General';
        entry.insuranceFor = formEls.insFor.value || 'Self';
      }
      if (entry.category==='Credit Card Payment'){ entry.method = 'credit_card_payment'; }
    }

    if (editId){ data = data.map(t => t.id===editId ? entry : t); editId=null; formEls.addBtn.classList.remove('hidden'); formEls.saveBtn.classList.add('hidden'); formEls.cancelBtn.classList.add('hidden'); }
    else { data.push(entry); }

    saveAll();
    renderAll();
    clearForm();
  }

  function loadEdit(id){
    const e = data.find(t => t.id===id); if (!e) return;
    editId = id;
    formEls.type.value = e.type; formEls.amount.value = e.amount; formEls.date.value = e.date; formEls.desc.value = e.desc;
    formEls.category.value = e.category || 'Food'; formEls.method.value = e.method || 'cash';
    formEls.incomeSource.value = e.incomeSource || ''; formEls.insType.value = e.insuranceType || ''; formEls.insFor.value = e.insuranceFor || '';
    if (e.type==='opening_balance'){ formEls.openingType.value = e.investmentGroup && e.investmentGroup!=='Cash' ? 'Investment' : 'Cash'; }
    updateFormFields(e);
    if (e.type==='opening_balance'){
      if (formEls.openingType.value==='Investment'){
        formEls.openingGroup.value = e.investmentGroup || ''; updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub, e.investmentSub);
      } else { formEls.openingSub.value = e.method || ''; }
    } else if (e.type==='expense' && e.category==='Investments'){
      formEls.invGroup.value = e.investmentGroup || ''; updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, e.investmentSub);
    }
    formEls.addBtn.classList.add('hidden'); formEls.saveBtn.classList.remove('hidden'); formEls.cancelBtn.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function cancelEdit(){ editId=null; formEls.addBtn.classList.remove('hidden'); formEls.saveBtn.classList.add('hidden'); formEls.cancelBtn.classList.add('hidden'); clearForm(); }

  function clearForm(){
    formEls.amount.value=''; formEls.desc.value=''; formEls.date.value=new Date().toISOString().slice(0,10);
    formEls.type.value='expense'; formEls.category.value='Food'; formEls.method.value='cash';
    formEls.incomeSource.value=''; formEls.invGroup.value=''; formEls.invSub.value='';
    formEls.openingType.value='Cash'; formEls.openingGroup.value=''; formEls.openingSub.value='';
    formEls.insType.value=''; formEls.insFor.value=''; updateFormFields();
  }

  function deleteEntry(id){ if (!confirm('Delete this entry?')) return; data = data.filter(t => t.id!==id); saveAll(); renderAll(); }

  function renderKPIs(){
    const now = new Date(); const M = now.getMonth(), Y = now.getFullYear();
    const prevM = M===0 ? 11 : M-1, prevY = M===0 ? Y-1 : Y;
    const isMonth = (d,m,y)=>{ const dt=new Date(d); return dt.getMonth()===m && dt.getFullYear()===y; };
    const sum = arr => arr.reduce((a,c)=> a + Number(c.amount||0), 0);

    const ops = data.filter(d => d.type!=='opening_balance');
    const cur = ops.filter(d => isMonth(d.date,M,Y));
    const prev = ops.filter(d => isMonth(d.date,prevM,prevY));

    const inc = sum(cur.filter(d=>d.type==='income'));
    const exp = sum(cur.filter(d=>d.type==='expense'));
    const prevInc = sum(prev.filter(d=>d.type==='income'));
    const prevExp = sum(prev.filter(d=>d.type==='expense'));

    const invAll = data.filter(d => (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
    const totalInv = sum(invAll);

    const momInc = (inc/(prevInc||1)-1)*100;
    const momExp = (exp/(prevExp||1)-1)*100;

    $('momIncome').className = momInc>=0 ? 'trend-up' : 'trend-down';
    $('momIncome').innerHTML = `${momInc>=0?'▲':'▼'} ${pct(Math.abs(momInc))} vs Last Month`;

    $('momExpense').className = momExp<=0 ? 'trend-up' : 'trend-down';
    $('momExpense').innerHTML = `${momExp<=0?'▲':'▼'} ${pct(Math.abs(momExp))} vs Last Month`;

    const ccOpen = sum(data.filter(d => d.type==='opening_balance' && d.method==='credit_card'));
    const ccExp = sum(data.filter(d => d.type==='expense' && d.method==='credit_card'));
    const ccPay = sum(data.filter(d => d.type==='expense' && d.category==='Credit Card Payment'));
    const ccDue = ccOpen + ccExp - ccPay;
    const isHigh = settings.ccLimit ? (ccDue/settings.ccLimit > 0.8) : false;
    $('ccCard').classList.toggle('cc-alert-high', isHigh);
    $('ccTitle').style.color = isHigh ? 'var(--danger)' : 'var(--warning)';
    $('ccAlert').classList.toggle('hidden', !isHigh);

    $('kpiIncome').innerText = fmt(inc);
    $('kpiExpense').innerText = fmt(exp);
    $('kpiNet').innerText = fmt(inc - exp);
    $('kpiInvest').innerText = fmt(totalInv);
    $('kpiCCDue').innerText = fmt(ccDue);
    $('ccLimitDisplay').innerText = fmt(settings.ccLimit);
    $('ccPaymentDate').innerText = `Next Payment: 10th of ${getNextPaymentMonth()}`;

    // Net liquidity breakdown
    const container = $('netLiquidityBreakdown');
    const liquid = data.filter(d => (d.type==='opening_balance' && d.investmentGroup==='Cash') || d.type==='income' || (d.type==='expense' && d.category!=='Investments'));
    const balances = liquid.reduce((acc,c)=>{
      const k = c.method || 'cash';
      const amt = (c.type==='expense' && c.category!=='Credit Card Payment') ? -Number(c.amount) : Number(c.amount);
      acc[k] = (acc[k]||0) + amt; return acc;
    },{});
    const keys = new Set([...Object.keys(methodNames), ...Object.keys(balances)].filter(k => k!=='credit_card_payment'));
    container.innerHTML = '';
    keys.forEach(k => {
      if (k==='credit_card' || !k) return;
      const name = methodNames[k] || k;
      const bal = balances[k] || 0;
      container.innerHTML += `<div><span>${name}</span><span>${fmt(bal)}</span></div>`;
    });
  }
</script>

<script>
  // Colors
  function getColorPalette(n){
    const vars = ['--c1','--c2','--c3','--c4','--c5','--c6','--c7','--c8','--c9','--c10','--c11','--c12'].map(v => getComputedStyle(document.documentElement).getPropertyValue(v).trim() || '#3b82f6');
    return Array.from({length:n},(_,i)=> vars[i%vars.length]);
  }

  // Charts: monthly
  function prepareMonthlyData(range){
    const monthly={};
    const dates = data.map(d=>d.date);
    if (dates.length===0) return { labels:[], income:[], expense:[], investment:[] };
    const start = range==='all' ? new Date(Math.min(...dates.map(d=>new Date(d)))) : new Date();
    if (range!=='all') start.setMonth(start.getMonth()-Number(range));
    start.setDate(1);
    let cur = new Date(start.getFullYear(), start.getMonth(), 1);
    const today = new Date();
    while (cur <= today){
      const key = `${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`;
      monthly[key] = { income:0, expense:0, investment:0, label: cur.toLocaleDateString('en-IN',{month:'short', year:'2-digit'}) };
      cur.setMonth(cur.getMonth()+1);
    }
    data.forEach(d=>{
      const dt = new Date(d.date);
      const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      if (!monthly[key]) return;
      const amt = Number(d.amount);
      if (d.type==='income') monthly[key].income += amt;
      else if (d.type==='expense'){
        if (d.category==='Investments') monthly[key].investment += amt;
        else monthly[key].expense += amt;
      }
    });
    const keys = Object.keys(monthly).sort();
    return {
      labels: keys.map(k => monthly[k].label),
      income: keys.map(k => monthly[k].income),
      expense: keys.map(k => monthly[k].expense),
      investment: keys.map(k => monthly[k].investment),
    };
  }

  function renderCharts(){
    const range = $('mainChartFilter').value;
    const { labels, income, expense, investment } = prepareMonthlyData(range==='all' ? 'all' : Number(range));
    const net = income.map((v,i)=> v - expense[i]);
    if (chartMain) chartMain.destroy();
    chartMain = new Chart($('mainChart').getContext('2d'), {
      data: {
        labels,
        datasets: [
          { type:'bar', label:'Income', data: income, backgroundColor:'rgba(16,185,129,0.85)', stack:'flow' },
          { type:'bar', label:'Expense', data: expense.map(e=>-e), backgroundColor:'rgba(239,68,68,0.85)', stack:'flow' },
          { type:'bar', label:'Investment', data: investment.map(i=>-i), backgroundColor:'rgba(14,165,233,0.85)', stack:'flow' },
          { type:'line', label:'Net Income', data: net, borderColor:'#111827', tension:0.3, pointRadius:3, fill:false }
        ]
      },
      options: {
        maintainAspectRatio:false, responsive:true, interaction:{mode:'index',intersect:false},
        scales:{ x:{ stacked:true }, y:{ stacked:true, ticks:{ callback:v=> fmt(Math.abs(v)).replace('₹','₹ ') } } },
        plugins:{ legend:{ position:'top' }, tooltip:{ callbacks:{ label:c=> (c.dataset.label+': '+fmt(Math.abs(c.parsed.y))) } } }
      }
    });
  }

  // Wallet unified
  function setupWalletFilters(){
    const sel = $('walletCategoryFilter');
    sel.innerHTML = '<option value="">All categories</option>' + BASE_CATS.filter(c=> !['Investments','Credit Card Payment'].includes(c)).map(c=> `<option value="${c}">${c}</option>`).join('');
  }

  function renderWalletUnified(){
    const mode = $('walletMode').value;
    const cat = $('walletCategoryFilter').value;
    const legend = $('walletLegend'), info = $('walletInfo');
    const colors = getColorPalette(12);

    if (mode==='wallet'){
      $('walletCategoryFilter').classList.add('hidden');
      $('resetExpenseDrilldown').classList.add('hidden');

      const liquid = data.filter(d => (d.type==='opening_balance' && d.investmentGroup==='Cash') || d.type==='income' || (d.type==='expense' && d.category!=='Investments'));
      const balances = liquid.reduce((acc,c)=>{
        const k = c.method || 'cash'; if (k==='credit_card_payment') return acc;
        const amt = (c.type==='expense' && c.category!=='Credit Card Payment') ? -Number(c.amount) : Number(c.amount);
        acc[k] = (acc[k]||0) + amt; return acc;
      },{});
      const list = Object.entries(balances).filter(([k,v])=> v>0 && k!=='credit_card').map(([k,v])=> ({label: methodNames[k]||k, balance:v})).sort((a,b)=> b.balance-a.balance);

      if (donutChart) donutChart.destroy();
      donutChart = new Chart($('donutChart').getContext('2d'), {
        type:'doughnut',
        data:{ labels: list.map(x=>x.label), datasets:[{ data: list.map(x=>x.balance), backgroundColor:getColorPalette(list.length), hoverOffset:4 }] },
        options:{ maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c=> {
          const total = c.dataset.data.reduce((a,b)=>a+b,0);
          return `${c.label}: ${fmt(c.parsed)} (${total?((c.parsed/total)*100).toFixed(1):'0.0'}%)`;
        }}}}}
      });

      legend.innerHTML = list.map((b,i)=> `<div style="display:flex;justify-content:space-between;"><div style="display:flex;align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:${colors[i]};margin-right:10px;"></span>${b.label}</div><span style="font-weight:600;color:var(--text-main);">${fmt(b.balance)}</span></div>`).join('') || '<div style="text-align:center; padding-top:20px;">No liquid accounts found.</div>';
      info.innerText = 'Liquid balances by account (positive only).';
    } else {
      $('walletCategoryFilter').classList.remove('hidden');
      const filtered = data.filter(d => d.type==='expense' && d.category!=='Investments' && d.category!=='Credit Card Payment' && (cat ? d.category===cat : true));
      const map = filtered.reduce((acc,c)=>{ const key = cat ? c.desc.substring(0,30) : c.category; acc[key]=(acc[key]||0)+Number(c.amount); return acc; },{});
      const top = Object.entries(map).sort(([,a],[,b])=> b-a).slice(0,10);
      const labels = top.map(([k])=>k), amounts = top.map(([,v])=>v);

      if (donutChart) donutChart.destroy();
      donutChart = new Chart($('donutChart').getContext('2d'), {
        type:'doughnut',
        data:{ labels, datasets:[{ data: amounts, backgroundColor: getColorPalette(labels.length), hoverOffset:4 }] },
        options:{
          maintainAspectRatio:false,
          plugins:{ legend:{ position:'right', labels:{ boxWidth:10 } }, tooltip:{ callbacks:{ label:c=>{
            const total = amounts.reduce((a,b)=>a+b,0);
            return `${c.label}: ${fmt(c.parsed)} (${total?((c.parsed/total)*100).toFixed(1):'0.0'}%)`;
          }}}},
          onClick: (e,els) => {
            if (els && els.length && !cat){
              const idx = els[0].index; const clicked = labels[idx];
              $('walletCategoryFilter').value = clicked;
              renderWalletUnified();
              $('resetExpenseDrilldown').classList.remove('hidden');
            }
          }
        }
      });

      legend.innerHTML = labels.map((lbl,i)=> `<div style="display:flex;justify-content:space-between;"><div style="display:flex;align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:${colors[i]};margin-right:10px;"></span>${lbl}</div><span style="font-weight:600;color:var(--text-main);">${fmt(amounts[i])}</span></div>`).join('') || '<div style="text-align:center; padding-top:20px;">No expenses in range.</div>';
      info.innerText = cat ? `${cat} breakdown (Top 10 by description)` : 'All expenses (Top 10 categories)';
    }
  }

  function resetExpenseDrilldown(){ $('walletCategoryFilter').value=''; $('resetExpenseDrilldown').classList.add('hidden'); renderWalletUnified(); }

  // Investment filters and charts
  function setupInvestmentFilters(){
    const bucketSel = $('invBucketFilter');
    const buckets = Array.from(new Set(Object.values(MAJOR_BUCKETS)));
    bucketSel.innerHTML = '<option value="">Select bucket</option>' + buckets.map(b => `<option value="${b}">${b}</option>`).join('');
    // Panel toggles
    $('toggleInvBreakdown').addEventListener('click', () => $('invBreakdownPanel').classList.toggle('hidden'));
    $('viewCategoriesBtn').addEventListener('click', () => {
      $('invBreakdownPanel').classList.remove('hidden');
      $('invViewMode').value = 'subcats';
      if (!$('invBucketFilter').value) $('invBucketFilter').value = buckets[0] || '';
      renderInvestmentKPICharts();
    });
  }

  function applyDateRangeToInvestments(entries, range){
    if (!range || range==='all') return entries;
    const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth()-Number(range));
    return entries.filter(e => new Date(e.date) >= cutoff);
  }

  function rollupMajorBuckets(entries){
    const agg = entries.reduce((acc,c)=>{
      const group = c.investmentGroup || 'Uncategorized';
      const bucket = MAJOR_BUCKETS[group] || 'Other';
      acc[bucket] = (acc[bucket]||0) + Number(c.amount); return acc;
    },{});
    const items = Object.entries(agg).map(([bucket,amount])=> ({bucket,amount})).sort((a,b)=> b.amount-a.amount);
    return items;
  }

  function rollupSubcategories(entries, bucket){
    const groups = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g]===bucket);
    const filtered = entries.filter(e => groups.includes(e.investmentGroup));
    const agg = filtered.reduce((acc,c)=>{ const sub = c.investmentSub || 'General'; acc[sub]=(acc[sub]||0)+Number(c.amount); return acc; },{});
    const items = Object.entries(agg).map(([sub,amount])=> ({sub,amount})).sort((a,b)=> b.amount-a.amount);
    return items;
  }

  function renderQuickSubDropdowns(entries){
    const container = $('invQuickSubs'); if (!container) return;
    const order = ['Equity','Debt','ETFs','Mutual Funds','Retirement','Real Estate','Commodities','Crypto','Other'];
    const totals = Object.fromEntries(rollupMajorBuckets(entries).map(i => [i.bucket, i.amount]));
    const html = order.filter(b => (totals[b]||0)>0).map(bucket => {
      const groups = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g]===bucket);
      const subsSet = new Set(); groups.forEach(g => Object.keys(INVESTMENT_STRUCTURE[g]||{}).forEach(s => subsSet.add(s)));
      const subs = Array.from(subsSet);
      const subVals = subs.map(sub => {
        const amt = entries.filter(d => groups.includes(d.investmentGroup) && d.investmentSub===sub).reduce((a,c)=> a+Number(c.amount), 0);
        return { sub, amount: amt };
      }).filter(x=>x.amount>0).sort((a,b)=> b.amount-a.amount);

      const menu = subVals.length ? subVals.map(x=> `<div class="dropdown-item"><span>${x.sub}</span><strong>${fmt(x.amount)}</strong></div>`).join('') : `<div class="dropdown-item"><span>No data</span><strong>—</strong></div>`;

      return `
        <div class="quick-sub-card">
          <div class="quick-sub-header">
            <div class="quick-sub-title">${bucket}</div>
            <span class="total-badge">${fmt(totals[bucket]||0)}</span>
          </div>
          <div class="dropdown" style="margin-top:8px;">
            <button class="btn-outline" style="padding:6px 10px; font-size:12px;" onclick="toggleQuickMenu(this)">View subcategories</button>
            <div class="dropdown-menu hidden" onclick="event.stopPropagation()">
              ${menu}
            </div>
          </div>
        </div>
      `;
    }).join('');
    container.innerHTML = html;

    document.addEventListener('click', () => {
      document.querySelectorAll('#invQuickSubs .dropdown-menu').forEach(m => m.classList.add('hidden'));
    });
  }

  function toggleQuickMenu(btn){
    const menu = btn.parentElement.querySelector('.dropdown-menu');
    document.querySelectorAll('#invQuickSubs .dropdown-menu').forEach(m => { if (m!==menu) m.classList.add('hidden'); });
    menu.classList.toggle('hidden');
  }

  function renderInvestmentKPICharts(){
    const raw = data.filter(d => (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
    const range = $('invDateRange').value || 'all';
    const view = $('invViewMode').value || 'top4';
    const selected = $('invBucketFilter').value || '';
    const entries = applyDateRangeToInvestments(raw, range);

    let labels=[], values=[];
    const colors = getColorPalette(10);

    if (view==='subcats' && selected){
      const items = rollupSubcategories(entries, selected);
      labels = items.map(i=>i.sub); values = items.map(i=>i.amount);
      $('invBarTitle').innerText = `Subcategory amounts (${selected})`;
      $('invPieTitle').innerText = `Share by subcategory (${selected})`;
    } else {
      const items = rollupMajorBuckets(entries).slice(0,4);
      labels = items.map(i=>i.bucket); values = items.map(i=>i.amount);
      $('invBarTitle').innerText = 'Investment by major bucket (Top 4)';
      $('invPieTitle').innerText = 'Share by bucket (Top 4)';
    }

    if (invBreakdownBarChart) invBreakdownBarChart.destroy();
    invBreakdownBarChart = new Chart($('invBreakdownBar').getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Historical cost', data: values, backgroundColor: colors.map(c=> c+'cc'), borderColor: colors, borderWidth:1.5, borderRadius:6 }] },
      options:{ maintainAspectRatio:false, responsive:true, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:c=> `${c.label}: ${fmt(c.parsed.y)}` } } }, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=> fmt(v).replace('₹','₹ ') }, grid:{color:'#eef2ff'} }, x:{ grid:{ display:false } } } }
    });

    if (invBreakdownPieChart) invBreakdownPieChart.destroy();
    invBreakdownPieChart = new Chart($('invBreakdownPie').getContext('2d'), {
      type:'doughnut',
      data:{ labels, datasets:[{ data: values, backgroundColor: colors, hoverOffset:6, borderColor:'#fff', borderWidth:2 }] },
      options:{
        maintainAspectRatio:false,
        plugins:{ legend:{ position:'right', labels:{ boxWidth:10 } }, tooltip:{ callbacks:{ label:c=> {
          const total = values.reduce((a,b)=>a+b,0); const share = total? ((c.parsed/total)*100).toFixed(1) : '0.0';
          return `${c.label}: ${fmt(c.parsed)} (${share}%)`;
        }}}},
        cutout:'60%',
        onClick: (evt, els) => {
          if (!els || !els.length) return;
          const idx = els[0].index; const bucket = labels[idx];
          $('invViewMode').value = 'subcats'; $('invBucketFilter').value = bucket;
          renderInvestmentKPICharts();
        }
      }
    });

    renderQuickSubDropdowns(entries);
  }

  // Recent entries
  function getBadge(entry){
    if (entry.type==='income') return `<span class="badge badge-income">Income</span>`;
    if (entry.type==='opening_balance') return `<span class="badge badge-opening">${entry.investmentGroup && entry.investmentGroup!=='Cash' ? 'Asset (Inv)' : 'O.Balance'}</span>`;
    if (entry.type==='expense'){
      if (entry.category==='Investments') return `<span class="badge badge-inv">Investment</span>`;
      if (entry.category==='Insurance') return `<span class="badge badge-ins">Insurance</span>`;
      if (entry.category==='Credit Card Payment') return `<span class="badge badge-cc">CC Pay</span>`;
      return `<span class="badge badge-expense">Expense</span>`;
    }
    return `<span class="badge">—</span>`;
  }

  function renderRecentEntries(){
    const tbody = $('recentTable').querySelector('tbody');
    const limit = $('entryLimit').value==='all' ? data.length : Number($('entryLimit').value);
    const recent = data.slice(0, limit);
    tbody.innerHTML = recent.map(e => {
      const amt = e.type==='income' || e.type==='opening_balance' ? `<span style="color:var(--success)">+${fmt(e.amount)}</span>` : `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;
      const methodDisplay =
        (e.type==='opening_balance' && e.investmentGroup!=='Cash') ? (e.investmentSub || e.investmentGroup) :
        (e.type==='expense' && e.category==='Investments') ? (e.investmentSub || e.investmentGroup) :
        (e.method==='credit_card_payment') ? 'N/A (Transfer)' : (methodNames[e.method] || e.method || '--');

      const categoryDisplay =
        e.category==='Investments' ? (e.investmentSub || e.investmentGroup) :
        e.category==='Insurance' ? `${e.insuranceType} (${e.insuranceFor})` :
        e.type==='expense' ? e.category : '--';

      return `
        <tr>
          <td>${getBadge(e)}</td>
          <td>${e.date}</td>
          <td style="font-weight:600; text-align:right">${amt}</td>
          <td>${e.desc}</td>
          <td>${categoryDisplay}</td>
          <td>${methodDisplay}</td>
          <td class="flex-row">
            <button onclick="loadEdit('${e.id}')" style="background:none;border:none;color:var(--primary);cursor:pointer;padding:4px" title="Edit">✎</button>
            <button onclick="deleteEntry('${e.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:4px" title="Delete">×</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // Advanced analytics
  function renderAdvancedCharts(){
    const range = $('dateFilter').value, type = $('chartType').value;
    const { labels, income, expense } = prepareMonthlyData(range==='all' ? 'all' : Number(range));
    const sum = arr => arr.reduce((a,b)=> a + Number(b||0), 0);

    let initialNet = sum(data.filter(d=> d.type==='opening_balance').map(d=> d.amount));
    let netNow = initialNet;
    const netSeries = labels.map((_,i)=> { const change = (income[i]||0) - (expense[i]||0); netNow += change; return netNow; });

    if (chartNetWorth) chartNetWorth.destroy();
    chartNetWorth = new Chart($('chartNetWorth').getContext('2d'), {
      type: type,
      data:{ labels, datasets:[{ label:'Cumulative Net Worth', data: netSeries, backgroundColor:'rgba(59,130,246,0.6)', borderColor:'rgba(59,130,246,1)', borderWidth:2, fill: type==='line' ? 'start' : false, tension:0.3 }] },
      options:{ maintainAspectRatio:false, responsive:true, scales:{ y:{ beginAtZero:false, ticks:{ callback:v=> fmt(v).replace('₹','₹ ') } } }, plugins:{ tooltip:{ callbacks:{ label:c=> (c.dataset.label+': '+fmt(c.parsed.y)) } } } }
    });

    renderInvestmentAnalytics();
  }

  function renderInvestmentAnalytics(){
    const invs = data.filter(d => (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
    const byType = invs.reduce((acc,c)=> { const k=c.investmentGroup||'Uncategorized'; acc[k]=(acc[k]||0)+Number(c.amount); return acc; },{});
    const labels = Object.keys(byType).sort((a,b)=> byType[b]-byType[a]);
    const values = labels.map(l=> byType[l]);
    const pts = invs.map(i=> ({ date:new Date(i.date), amount:Number(i.amount) })).sort((a,b)=> a.date-b.date);
    let cum=0; const gLabels = pts.map(p=> p.date.toLocaleDateString('en-IN',{month:'short', year:'2-digit'})); const gVals = pts.map(p=> { cum += p.amount; return cum; });
    const colors = getColorPalette(labels.length);

    if (chartInvTypesModal) chartInvTypesModal.destroy();
    const ctxTypes = $('chartInvTypesModal')?.getContext('2d');
    if (ctxTypes){
      chartInvTypesModal = new Chart(ctxTypes, { type:'bar', data:{ labels, datasets:[{ label:'Investment by type (historical cost)', data: values, backgroundColor: colors.map(c=> c+'cc'), borderColor: colors, borderWidth:1.5, borderRadius:6 }] }, options:{ maintainAspectRatio:false, responsive:true, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c=> `${c.label}: ${fmt(c.parsed.y)}` } } }, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=> fmt(v).replace('₹','₹ ') } } } } });
    }

    if (chartInvGrowthModal) chartInvGrowthModal.destroy();
    const ctxGrowth = $('chartInvGrowthModal')?.getContext('2d');
    if (ctxGrowth){
      chartInvGrowthModal = new Chart(ctxGrowth, { type:'line', data:{ labels: gLabels, datasets:[{ label:'Cumulative invested (historical cost)', data: gVals, borderColor:'#2980b9', tension:0.3, borderWidth:2, pointRadius:0 }] }, options:{ maintainAspectRatio:false, responsive:true, plugins:{ legend:{ position:'top' }, tooltip:{ callbacks:{ label:c=> `${c.dataset.label}: ${fmt(c.parsed.y)}` } } }, scales:{ y:{ beginAtZero:false, ticks:{ callback:v=> fmt(v).replace('₹','₹ ') } } } } });
    }
  }

  // Settings
  function renderSettings(){
    const methodContainer = $('methodEditor');
    methodContainer.innerHTML = Object.entries(methodNames).map(([key,name])=> `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
        <input type="text" value="${name}" data-key="${key}" onchange="updateMethodName(this)" style="flex:1;margin-right:10px;" />
        <button class="btn-danger" style="padding:5px 10px; font-size:11px" onclick="deleteMethod('${key}')">Remove</button>
      </div>
    `).join('');
    const incomeContainer = $('incomeList');
    incomeContainer.innerHTML = incomeSources.map(s=> `
      <span style="border:1px solid var(--border); padding:4px 8px; border-radius:4px; font-size:12px; display:inline-flex; align-items:center; background:#f8fafc">
        ${s}
        <button style="background:none;border:none;color:var(--danger);margin-left:5px;padding:0;line-height:1;cursor:pointer;" onclick="deleteIncome('${s}')">×</button>
      </span>
    `).join('');
    $('ccLimitInput').value = settings.ccLimit;
    setupWalletFilters();
  }

  function updateMethodName(el){ const key=el.dataset.key; const val=el.value.trim(); if (key && val){ methodNames[key]=val; saveAll(); renderAll(); } }
  function deleteMethod(key){ if (!confirm(`Remove method "${methodNames[key]}"?`)) return; delete methodNames[key]; saveAll(); renderAll(); }
  function addMethod(){ const name = $('newMethod').value.trim(); if (!name) return; const k = name.toLowerCase().replace(/[^a-z0-9]+/g,'_'); if (methodNames[k]) return alert('Method exists.'); methodNames[k]=name; $('newMethod').value=''; saveAll(); renderAll(); }
  function deleteIncome(src){ if (!confirm(`Remove income source "${src}"?`)) return; incomeSources = incomeSources.filter(s=> s!==src); saveAll(); renderAll(); }
  function addIncome(){ const s = $('newIncome').value.trim(); if (!s) return; if (incomeSources.includes(s)) return alert('Income source exists.'); incomeSources.push(s); $('newIncome').value=''; saveAll(); renderAll(); }
  function saveCCLimit(){ const v = Number($('ccLimitInput').value); if (!v || v<=0) return alert('Enter valid limit'); settings.ccLimit=v; saveAll(); renderKPIs(); alert('Credit Card Limit saved.'); }

  // Import/Export
  function convertToCSV(rows){
    const headers = ['id','type','amount','date','desc','category','method','incomeSource','investmentGroup','investmentSub','insuranceType','insuranceFor'];
    const lines = rows.map(obj => headers.map(h => {
      const v = obj[h] ?? ''; return (typeof v === 'string' && v.includes(',')) ? `"${v.replace(/"/g,'""')}"` : v;
    }).join(','));
    const csv = [headers.join(','), ...lines].join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'MoneyMirror_Export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function processImportedData(){
    const file = $('importFile').files[0]; if (!file) return alert('Select a file.');
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result; let imported = [];
      if (file.name.endsWith('.json')){ try { imported = JSON.parse(text); } catch(err){ return alert('Invalid JSON'); } }
      else if (file.name.endsWith('.csv')){ imported = parseCSV(text); }
      else return alert('Unsupported file type.');
      let count=0;
      imported.forEach(item=>{
        const entry = {
          id: uid(),
          type: (item.type || 'expense').toLowerCase().trim(),
          amount: Number(item.amount), date: item.date || new Date().toISOString().slice(0,10),
          desc: item.desc || item.description || '',
          category: item.category || 'Misc',
          method: item.method ? item.method.toLowerCase().replace(/[^a-z0-9]+/g,'_') : 'cash',
          incomeSource: item.income_source || item.incomeSource || '',
          investmentGroup: item.investment_group || item.investmentGroup || '',
          investmentSub: item.investment_sub || item.investmentSub || '',
          insuranceType: item.insurance_type || item.insuranceType || '',
          insuranceFor: item.insurance_for || item.insuranceFor || '',
        };
        if (entry.amount>0 && entry.desc){ data.push(entry); count++; }
      });
      saveAll(); renderAll(); $('importModal').classList.remove('open'); alert(`Imported ${count} entries.`);
    };
    reader.readAsText(file);
  }

  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l=> l.trim().length>0);
    if (lines.length<2) return [];
    const headers = lines[0].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h => h.replace(/"/g,'').trim().toLowerCase());
    const out=[];
    for (let i=1;i<lines.length;i++){
      const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); if (!cols || cols.length!==headers.length) continue;
      const obj={}; headers.forEach((h,idx)=> { obj[h] = (cols[idx]||'').replace(/^"|"$/g,'').replace(/""/g,'"'); }); out.push(obj);
    }
    return out;
  }

  // Sample data (requires sign-in)
  function loadSampleData(){
    if (!currentProfile) { alert('Please sign in first to load sample data.'); return; }
    if (!confirm('This will overwrite your current profile data. Continue?')) return;

    function rand(min,max){ return Math.floor(Math.random()*(max-min+1)+min); }
    function pick(arr){ return arr[rand(0,arr.length-1)]; }
    function dateAgoMonths(mMin, mMax){
      const today = new Date(); const m = rand(mMin,mMax);
      const d = new Date(today); d.setMonth(today.getMonth()-m);
      const maxDay = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
      d.setDate(rand(1,maxDay));
      return d.toISOString().slice(0,10);
    }

    data = [];
    methodNames = {...CANONICAL_METHODS};
    incomeSources = ['Salary (Primary)','Freelance Income','Investment Income'];
    settings.ccLimit = 200000;

    // Opening balances (Cash)
    data.push({id:uid(), type:'opening_balance', amount:50000, date:dateAgoMonths(6,6), desc:'Initial Salary Account', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:20000, date:dateAgoMonths(5,6), desc:'Initial Savings', investmentGroup:'Cash', investmentSub:'Bank Account (Savings)', method:'savings_acct', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:5000, date:dateAgoMonths(5,6), desc:'Initial Physical Cash', investmentGroup:'Cash', investmentSub:'Cash', method:'cash', category:'N/A'});

    // Opening balances (Investments)
    data.push({id:uid(), type:'opening_balance', amount:35000, date:dateAgoMonths(6,6), desc:'Opening — Equity MF (Large Cap)', investmentGroup:'Mutual Funds', investmentSub:'Equity MF - Large Cap/Mid Cap/Small Cap', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:18000, date:dateAgoMonths(6,6), desc:'Opening — NPS Tier 1', investmentGroup:'Retirement Funds', investmentSub:'NPS Tier 1/Tier 2', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:12000, date:dateAgoMonths(6,6), desc:'Opening — Gold ETF', investmentGroup:'ETFs', investmentSub:'Gold ETF', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:25000, date:dateAgoMonths(6,6), desc:'Opening — Corporate Bonds', investmentGroup:'Bonds & Debt Instruments', investmentSub:'Corporate Bonds', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:8000, date:dateAgoMonths(6,6), desc:'Opening — Bitcoin (BTC)', investmentGroup:'Crypto & Digital Assets', investmentSub:'Bitcoin (BTC)', method:'', category:'N/A'});

    // Monthly incomes (last 6 months)
    for (let m=6; m>=0; m--){
      const salaryDate = dateAgoMonths(m,m);
      data.push({id:uid(), type:'income', amount:120000, date:salaryDate, desc:`Salary credit (${salaryDate})`, category:'N/A', method:'salary_acct', incomeSource:'Salary (Primary)'});
      if (Math.random()>0.6){
        const freeDate = dateAgoMonths(m,m);
        data.push({id:uid(), type:'income', amount:rand(8000,18000), date:freeDate, desc:`Freelance (${freeDate})`, category:'N/A', method:'salary_acct', incomeSource:'Freelance Income'});
      }
    }

    // Typical expenses & investments
    const expCats = ['Food','Rent','Utilities','Shopping','Entertainment','Travel','Health','Misc'];
    const methodsPool = ['salary_acct','savings_acct','cash','digital_wallet','credit_card'];

    for (let i=0;i<90;i++){
      const dt = dateAgoMonths(rand(0,6), rand(0,6));
      const cat = pick(expCats); const amt = rand(300,9000); const method = pick(methodsPool);
      data.push({ id:uid(), type:'expense', amount:amt, date:dt, desc:`${cat} expense`, category:cat, method });
      if (Math.random()>0.75){
        const group = pick(Object.keys(INVESTMENT_STRUCTURE)); const sub = pick(Object.keys(INVESTMENT_STRUCTURE[group]));
        data.push({ id:uid(), type:'expense', amount:rand(2000,15000), date:dt, desc:`Investment — ${sub}`, category:'Investments', method:pick(['salary_acct','savings_acct']), investmentGroup:group, investmentSub:sub });
      }
      if (Math.random()>0.85){
        data.push({ id:uid(), type:'expense', amount:rand(1500,6000), date:dt, desc:'Insurance premium', category:'Insurance', method:pick(['salary_acct','savings_acct']), insuranceType:pick(['Health','Life']), insuranceFor:pick(['Self','Family']) });
      }
    }

    // Credit card usage and payments
    for (let i=0;i<20;i++){
      const dt = dateAgoMonths(rand(0,6), rand(0,6));
      data.push({ id:uid(), type:'expense', amount:rand(500,12000), date:dt, desc:'Credit card spend', category:'Shopping', method:'credit_card' });
      if (Math.random()>0.7){
        data.push({ id:uid(), type:'expense', amount:rand(3000,20000), date:dt, desc:'Credit card payment', category:'Credit Card Payment', method:'credit_card_payment' });
      }
    }

    // One-off investments
    [{ group:'Real Estate', sub:'REITs (Real Estate Investment Trusts)', amount:40000 },
     { group:'Mutual Funds', sub:'Equity MF - ELSS (Tax Saving)', amount:25000 },
     { group:'Fixed Income / Savings Schemes', sub:'FD (Fixed Deposit)', amount:60000 }].forEach(item=>{
      const dt = dateAgoMonths(rand(1,5), rand(1,5));
      data.push({ id:uid(), type:'expense', amount:item.amount, date:dt, desc:`One-off Investment — ${item.sub}`, category:'Investments', method:pick(['salary_acct','savings_acct']), investmentGroup:item.group, investmentSub:item.sub });
    });

    saveAll(); renderAll(); $('importModal').classList.remove('open'); alert('Sample data loaded.');
  }

  // Calculator
  function handleCalculatorInput(e){
    const key = e.target.innerText;
    const display = $('calc-display'); const preview = $('calc-preview');
    if (key==='AC'){ display.textContent='0'; preview.textContent='Enter an expression…'; return; }
    if (key==='±' || key==='%') return;
    if (key==='='){
      try {
        const expr = display.textContent.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
        const res = Function('"use strict";return ('+expr+')')();
        display.textContent = String(res); preview.textContent = fmt(Number(res));
      } catch { preview.textContent = 'Invalid expression'; }
      return;
    }
    const mapped = key==='×' ? '*' : key==='÷' ? '/' : key==='−' ? '-' : key;
    display.textContent = display.textContent==='0' ? mapped : display.textContent + mapped;
    try {
      const expr = display.textContent.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
      const res = Function('"use strict";return ('+expr+')')();
      preview.textContent = fmt(Number(res));
    } catch { preview.textContent = ''; }
  }

  function dragElement(el){
    if (!el) return; const header = $('calc-header'); let p1=0,p2=0,p3=0,p4=0;
    header.onmousedown = startDrag;
    function startDrag(e){ e.preventDefault(); p3=e.clientX; p4=e.clientY; document.onmouseup=stopDrag; document.onmousemove=doDrag; }
    function doDrag(e){ e.preventDefault(); p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; el.style.top=(el.offsetTop - p2)+'px'; el.style.left=(el.offsetLeft - p1)+'px'; }
    function stopDrag(){ document.onmouseup=null; document.onmousemove=null; }
  }

  // Expose inline functions
  window.loadEdit = loadEdit;
  window.deleteEntry = deleteEntry;
  window.toggleQuickMenu = toggleQuickMenu;
</script>
</body>
</html>
