<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MoneyMirror â€” v5.0.9 (Fixed Stable)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase Compat Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;

      /* 3D KPI theme accents */
      --kpi-elev-shadow: 0 12px 24px rgba(2, 6, 23, 0.16), 0 6px 12px rgba(2, 6, 23, 0.08);
      --kpi-inner-shadow: inset 0 1px 0 rgba(255,255,255,0.85);
      --kpi-border: rgba(148, 163, 184, 0.45);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* LAYOUT */
    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.3s; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px); transition: filter 0.3s; }

    /* BRAND & NAV */
    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }

    /* NEW: Quick index add in sidebar */
    .nav-helper { padding: 8px 10px; border-radius: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); margin-top: 8px; }
    .nav-helper label { display:block; font-size:10px; color:#93a4b8; margin-bottom:6px; text-transform: uppercase; letter-spacing:0.5px; }
    /* OVERRIDE: Sidebar dropdown readability â€” black text, white background */
    .nav-helper select { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(0,0,0,0.15); background:#fff; color:#000; font-size:12px; }
    .nav-helper button { width:100%; margin-top:8px; padding:8px 10px; border-radius:6px; border:none; font-size:12px; font-weight:600; background:var(--primary); color:white; cursor:pointer; }

    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    /* AUTH GATE (FIXED) */
    #authGate {
      position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999;
      display: none; /* Hidden by default */
      flex-direction: column; justify-content: center; align-items: center;
      gap: 10px; color: white; text-align: center; padding: 0 24px;
    }
    #authGate.show {
      display: flex; /* Only shows when .show class is present */
    }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    /* UI ELEMENTS */
    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    /* Base card */
    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; flex-wrap: wrap; gap: 10px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); white-space: nowrap; }

    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; min-width: 120px; flex-grow: 1; }
    .input-group-med { width: 25%; min-width: 180px; flex-grow: 1; }
    .input-group-large { width: 45%; min-width: 250px; flex-grow: 1; }

    /* KPI cards â€” 3D styling */
    .kpi-card {
      padding: 20px;
      border: 1px solid var(--kpi-border);
      box-shadow: var(--kpi-elev-shadow);
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      position: relative;
      isolation: isolate;
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      box-shadow: var(--kpi-inner-shadow);
      pointer-events: none;
    }
    /* Accent borders by semantic type */
    .kpi-income { border-left: 6px solid var(--success); }
    .kpi-expense { border-left: 6px solid var(--danger); }
    .kpi-cc { border-left: 6px solid var(--warning); }
    .kpi-net { border-left: 6px solid var(--primary); }
    .kpi-invest { border-left: 6px solid #075985; }

    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    .cc-alert-high { background: #fee2e2 !important; border-color: var(--danger) !important; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; white-space: nowrap; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted); }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600; color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1400px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 95vh; display:flex; flex-direction:column; overflow: hidden; }
    .modal-pad { padding: 24px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-small { width: 90%; max-width: 400px; height: auto; max-height: 90vh; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Calculator */
    #calculator { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 480px; max-height: 80vh; z-index: 3000; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #f8fafc; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close-btn { background: transparent; border: none; color: #ef4444; font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    #calc-display { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    #calc-preview { background: #0b1323; color: #9fb3c8; text-align: right; font-size: 14px; padding: 6px 15px; font-family: monospace; height: 28px; border-top: 1px solid rgba(255,255,255,0.06); }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; touch-action: manipulation; }
    #calc-buttons button:hover { background: #f1f5f9; }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .calc-clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .calc-zero { grid-column: span 2; }
    .calc-equals { grid-row: span 2; background: var(--primary) !important; color: white !important; }
    #calc-toggle { margin-left: 10px; padding: 8px 12px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; }

    /* Breakdown Grid */
    .kpi-breakdown-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: white; display:flex; flex-direction:column; justify-content:space-between; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }

    /* Dropdowns */
    .sub-dropdown-container { position: relative; }
    .sub-dropdown-menu { position: absolute; top: 36px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px 0; width: 100%; min-width: 240px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50; display: none; max-height: 300px; overflow-y: auto; }
    .sub-dropdown-menu.show { display: block; }
    .sub-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; font-size: 12px; color: var(--text-main); border-bottom: 1px solid #f1f5f9; }
    .sub-dropdown-item:last-child { border-bottom: none; }

    .multiselect-container { position: relative; }
    .multiselect-dropdown { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 220px; padding: 10px; z-index: 60; display: none; }
    .multiselect-dropdown.show { display: block; }
    .ms-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; cursor: pointer; }
    .ms-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }

    /* Analytics Filters */
    .analytics-filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }

    .market-ticker-strip {
      background-color: #1e293b;
      color: #f1f5f9;
      padding: 10px 0; /* Ensures consistent vertical spacing */
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      display: flex;
      align-items: center;
    }

    .ticker-wrap {
      display: flex;
      width: max-content;
      animation: marquee 30s linear infinite;
      padding-left: 100%;
    }
    .ticker-item {
      display: inline-block;
      padding: 0 20px;
      white-space: nowrap;
      font-size: 0.9em;
      font-weight: 500;
    }
    .ticker-item .symbol { font-weight: 700; margin-right: 5px; }
    .ticker-item .change-up { color: #10b981; }
    .ticker-item .change-down { color: #ef4444; }
    @keyframes marquee {
      0% { transform: translate(0, 0); }
      100% { transform: translate(-100%, 0); }
    }

    /* NEW: Clock micro-style */
    #currentClock { color: #0f172a; font-weight: 600; font-variant-numeric: tabular-nums; }

    /* MEDIA QUERIES */
    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-1 { grid-column: span 1; }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }

    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; height: 60px; }
      aside .brand { margin-bottom: 0; }
      aside nav, .sidebar-footer { display: none; }
      #mobileMenuBtn { display: block; }
      aside.mobile-open nav { display: block; position: absolute; top: 60px; left: 0; right: 0; background: var(--sidebar-bg); padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 501; height: calc(100vh - 60px); overflow-y: auto; }
      aside.mobile-open .sidebar-footer { display: block; position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 501; }
      main { padding: 15px; gap: 15px; }
      .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer { width: 100% !important; min-width: 100%; }
      .action-body { gap: 12px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr; }
      #invQuickSubs { grid-template-columns: 1fr !important; }
      .card-header { align-items: flex-start; }
      #calculator { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; bottom: auto; right: auto; }
      .analytics-filter-grid { grid-template-columns: 1fr; gap: 10px; }
      .flex-row input, .flex-row select, .flex-row button { flex-grow: 1; width: 100%; max-width: none !important; }
      .modal-content { width: 100%; height: 100%; border-radius: 0; max-width: none; }
      .modal-small { height: auto; min-height: 50vh; border-radius: 12px; }
    }

    /* NEW: Market modal select polish + ensure black text for dropdowns */
    #majorIndexSelect, #commodityCountrySelect, #sidebarIndexSelect {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: #000;
    }
    #applyCommodityFilter { padding: 8px 12px; font-size: 12px; }
  </style>
</head>
  <body>

<!-- FIXED: Removed initial "show" to prevent flicker -->
<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror â€” Personal Finance Dashboard</p>
  <p class="line line-3">by Rehan Hamdulay</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
  <button id="guestBtn" class="btn-outline" style="padding:12px 24px; font-size:14px; background:transparent; color:white; border-color:white; margin-top:10px;">Continue as Guest (Offline)</button>
</div>

<aside id="mainSidebar">
  <div style="width:100%">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
        MoneyMirror <span>v5.0.9</span>
      </div>
      <button id="mobileMenuBtn">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>
        <!-- Market ticker modal trigger -->
        <a href="#marketSettingsModal" class="nav-item openModal" data-modal-id="marketSettingsModal" style="text-decoration:none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"></path><path d="M19 9l-5 5-4-4-3 3"></path></svg>
          <span>Market ticker</span>
        </a>
        <!-- NEW: Quick add major index directly from sidebar -->
        <div class="nav-helper">
          <label>Quick add index</label>
          <select id="sidebarIndexSelect">
            <option value="">Choose...</option>
            <option value="NIFTY_50|Nifty 50">NIFTY 50 (India)</option>
            <option value="SENSEX|Sensex">SENSEX (India)</option>
            <option value="NASDAQ|Nasdaq">NASDAQ (US)</option>
            <option value="DJI|Dow Jones">Dow Jones (US)</option>
            <option value="SPX|S&P 500">S&P 500 (US)</option>
            <option value="FTSE_100|FTSE 100">FTSE 100 (UK)</option>
            <option value="DAX|DAX">DAX (Germany)</option>
            <option value="CAC_40|CAC 40">CAC 40 (France)</option>
            <option value="NIKKEI_225|Nikkei 225">Nikkei 225 (Japan)</option>
            <option value="HSI|Hang Seng">Hang Seng (Hong Kong)</option>
          </select>
          <button id="sidebarAddIndexBtn">Add to ticker</button>
        </div>
      </div>
      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
      </div>
    </nav>
  </div>

  <div class="sidebar-footer">
    <div class="sys-stat">
      <span>Current profile</span>
      <span class="sys-val" id="profileNameDisplay">--</span>
    </div>
    <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.9 â€¢ Settings & Table Fixed</div>
  </div>
</aside>

<main>
  <!-- Market ticker strip -->
  <div id="stockTickerContainer" class="market-ticker-strip">
    <div id="tickerWrap" class="ticker-wrap"></div>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
      <div style="font-size:13px; color:var(--text-muted); margin-top:4px; display:flex; gap:8px; align-items:center;">
        <span id="currentDate"></span>
        <!-- NEW: Live clock -->
        <span id="currentClock"></span>
      </div>
    </div>
    <div class="flex-row">
      <button class="btn-outline" id="sampleBtn">Load sample</button>
      <button class="btn-primary" id="importDataBtn">Import data</button>
      <button class="btn-outline" id="exportBtn">Export CSV</button>
      <div id="calc-toggle" title="Toggle calculator">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="14" x2="12.01" y2="14"></line><line x1="8" y1="10" x2="8.01" y2="10"></line><line x1="16" y1="10" x2="16.01" y2="10"></line></svg>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card kpi-card kpi-income col-span-1">
      <div class="card-title" style="color:var(--success)">Monthly income</div>
      <div class="kpi-value" id="kpiIncome">â‚¹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    <div class="card kpi-card kpi-expense col-span-1">
      <div class="card-title" style="color:var(--danger)">Monthly expenses</div>
      <div class="kpi-value" id="kpiExpense">â‚¹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    <div class="card kpi-card kpi-cc col-span-1" id="ccCard" style="background:linear-gradient(180deg,#fff7ed 0%,#fffbeb 100%);">
      <div class="card-title" id="ccTitle" style="color:var(--warning)">Credit card due</div>
      <div class="kpi-value" id="kpiCCDue">â‚¹0</div>
      <div class="kpi-sub" style="color:#000; font-weight:700; margin-top: 6px; position:relative;">
        <span id="ccPaymentDate">Next: 10th Dec</span>
        <span style="font-weight:700; margin-left:10px;">Limit: <span id="ccLimitDisplay">â‚¹2L</span></span>
        <div id="ccAlert" class="hidden" style="position:absolute; right:0; top:0; color:var(--danger)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        </div>
      </div>
    </div>

    <div class="card kpi-card kpi-net col-span-1">
      <div class="card-title" style="color:var(--primary)">Net liquidity</div>
      <div class="kpi-value" id="kpiNet">â‚¹0</div>
      <div class="kpi-sub">Total available cash</div>
      <div class="account-list" id="netLiquidityBreakdown"></div>
    </div>

    <div class="card kpi-card kpi-invest col-span-4" style="background:#e0f2fe; border-color:#075985;">
      <div class="card-header" style="padding:16px 20px 0 20px;">
        <div class="card-title" style="color:#075985">Total investment value</div>
        <div style="display:flex;gap:8px;align-items:center; flex-wrap:wrap;">
          <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px; font-size:12px;">View breakdown</button>
          <button id="viewCategoriesBtn" class="btn-outline" style="padding:6px 10px; font-size:12px;">View subcategories</button>
        </div>
      </div>
      <div class="card-body" style="padding-top:6px;">
        <div class="kpi-value" id="kpiInvest">â‚¹0</div>
        <div class="kpi-sub" id="momInvest" style="color:#075985">Historical cost total</div>

        <div id="invBreakdownPanel" class="hidden" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
          <div class="card" style="border-color:#93c5fd; margin-bottom:12px;">
            <div class="card-header">
              <div class="card-title">Filters</div>
              <div class="flex-row" style="gap:10px; width:100%;">
                <div class="input-group-med">
                  <label>Major bucket</label>
                  <select id="invBucketFilter"></select>
                </div>
                <div class="input-group-med">
                  <label>View mode</label>
                  <select id="invViewMode">
                    <option value="top4">Top 4 buckets</option>
                    <option value="subcats">Subcategories</option>
                  </select>
                </div>
                <div class="input-group-med">
                  <label>Date range</label>
                  <select id="invDateRange">
                    <option value="6">Last 6 months</option>
                    <option value="12">Last 12 months</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="kpi-breakdown-grid">
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invBarTitle">Major buckets</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownBar"></canvas>
              </div>
            </div>
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invPieTitle">Share</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownPie"></canvas>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="card-title" style="font-size:13px; color:#075985; margin-bottom:10px;">Bucket subcategories quick view</div>
            <div id="invQuickSubs" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Cash flow & investments</div>
        <select id="mainChartFilter" onchange="renderCharts()" style="max-width:120px;">
          <option value="6">Last 6m</option>
          <option value="12">Last 12m</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:320px; width:100%; position:relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card col-span-2">
      <div class="card-header" style="gap:12px;">
        <div class="card-title">Wallet & Expenses</div>
        <div class="flex-row" style="gap:8px; width:100%;">
          <select id="walletMode" onchange="renderWalletUnified()" style="flex:1;">
            <option value="wallet">Wallet breakdown</option>
            <option value="expenses">Expense distribution</option>
          </select>

          <div id="expenseFilterContainer" class="multiselect-container hidden" style="flex:1;">
              <button class="btn-outline" style="font-size:12px; padding:10px; width:100%;" id="expenseFilterBtn">Select Categories ðŸŸ°</button>
              <div class="multiselect-dropdown" id="expenseMultiselectDropdown">
                  <div id="expenseCheckboxes" style="max-height:200px; overflow-y:auto;"></div>
                  <div class="ms-actions">
                      <button class="btn-outline" style="padding:4px 8px; font-size:11px" id="msClear">Clear</button>
                      <button class="btn-primary" style="padding:4px 8px; font-size:11px" id="msApply">Apply</button>
                  </div>
              </div>
          </div>

        </div>
      </div>
      <div class="card-body" style="display:flex; flex-direction:column; gap:20px; flex:1">
        <div style="height:280px; width:100%; position:relative;">
          <canvas id="donutChart"></canvas>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
          <div id="walletLegend" style="font-size:12px; color:var(--text-muted);"></div>
          <div id="walletInfo" style="font-size:12px; color:var(--text-muted);"></div>
          <button id="resetExpenseDrilldown" class="btn-outline hidden" style="padding:6px; font-size:12px" onclick="resetExpenseDrilldown()">View all categories</button>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card action-card col-span-4" id="addEntryCard">
      <div class="action-header">
        <div class="card-title">Add new entry</div>
      </div>
      <div class="action-body">
        <div class="input-group-small">
          <label>Type</label>
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="opening_balance">Opening Balance</option>
          </select>
        </div>
        <div class="input-group-small">
          <label>Amount (â‚¹)</label>
          <input id="amount" type="number" placeholder="0.00" style="font-weight:700; font-size:16px" step="any" />
        </div>
        <div class="input-group-small">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div class="input-group-large">
          <label>Description</label>
          <input id="desc" placeholder="What is this for?" />
        </div>
      
        <div id="dynamicFieldsContainer" class="full-width" style="border-top:1px solid var(--border); padding-top:15px">
          <div id="regularFields" style="display:flex; gap:20px; flex-wrap:wrap">
            <div id="categoryContainer" class="input-group-small">
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div class="input-group-small">
              <label>Method</label>
              <select id="method"></select>
            </div>
            <div id="incomeSourceRow" class="hidden input-group-small">
              <label>Source</label>
              <select id="incomeSource"></select>
            </div>

            <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="input-group-small">
                <label>Investment category</label>
                <select id="invGroup"></select>
              </div>
              <div class="input-group-small">
                <label>Investment sub-type</label>
                <select id="invSub"></select>
              </div>
            </div>

            <div id="insuranceRow" class="hidden input-group-med">
              <label>Insurance details</label>
              <div class="flex-row">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>

          <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-small">
              <label>Asset type</label>
              <select id="openingType">
                <option value="Cash">Cash (Liquid)</option>
                <option value="Investment">Investment Asset</option>
              </select>
            </div>
            <div class="input-group-small hidden" id="openingGroupContainer">
              <label id="openingGroupLabel">Asset category</label>
              <select id="openingGroup"></select>
            </div>
            <div class="input-group-small hidden" id="openingSubContainer">
              <label id="openingSubLabel">Account / Asset sub-type</label>
              <select id="openingSub"></select>
            </div>
          </div>
        </div>

        <div style="width:100%; display:flex; gap:10px; margin-top:10px">
          <button class="btn-primary" id="addBtn" style="flex:1">Add entry</button>
          <button class="btn-primary hidden" id="saveBtn" style="flex:1">Save changes</button>
          <button class="btn-outline hidden" id="cancelBtn" style="flex:1">Cancel</button>
        </div>
      </div>
    </div>

    <div class="card col-span-4">
      <div class="card-header" style="flex-direction:column; align-items:flex-start; gap:15px;">
        <div class="card-title">Recent transactions</div>
        <div class="flex-row" style="gap:10px; width:100%;">
             <input type="text" id="recentSearch" placeholder="Search..." style="padding:8px; flex:1;" onkeyup="renderRecentEntries()" />
             
             <select id="recentSort" onchange="renderRecentEntries()" style="flex:1;">
                 <option value="dateDesc">Newest</option>
                 <option value="dateAsc">Oldest</option>
                 <option value="amtDesc">Amt High</option>
                 <option value="amtAsc">Amt Low</option>
             </select>

             <select id="recentCategory" onchange="renderRecentEntries()" style="flex:1;">
                 <option value="">All Cats</option>
             </select>

             <select id="entryLimit" onchange="renderRecentEntries()" style="width:60px; flex:0;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="all">All</option>
            </select>
        </div>
      </div>
      <div class="card-body table-container">
        <table id="recentTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Description</th>
              <th>Category</th>
              <th>Method</th>
              <th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<div id="settingsModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Settings & Configuration</div>
      <button class="btn-outline" id="closeSettings" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Payment methods</label>
        <div id="methodEditor" style="border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
        <div class="flex-row">
          <input id="newMethod" placeholder="New method (e.g. SBI UPI)" />
          <button class="btn-primary" id="addMethod">Add</button>
        </div>
      </div>
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Income sources</label>
        <div class="flex-row" style="margin-bottom:10px;">
          <input id="newIncome" placeholder="New source name" />
           <button class="btn-primary" id="addIncomeBtn">Add</button>
        </div>
        <div id="incomeList" style="display:flex; gap:6px; flex-wrap:wrap"></div>
      </div>
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Credit card limit</label>
        <div class="flex-row">
          <input id="ccLimitInput" type="number" placeholder="Set limit (e.g. 200000)" />
          <button class="btn-primary" id="saveCCLimit">Save limit</button>
        </div>
      </div>
      <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px">
        <label style="color:var(--danger)">Danger zone</label>
        <div class="flex-row">
          <button class="btn-danger" id="resetBtn" style="width:100%">Factory reset profile</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Advanced financial analytics</div>
      <button class="btn-outline" id="closeAnalytics" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad" id="analyticsContent">
      <div id="analyticsFilters">
        <div class="filter-group">
          <h3 style="margin-top:0; font-size:16px;">Deep Dive Filters</h3>
          <div class="analytics-filter-grid">
            <div>
              <label>Date range</label>
              <select id="dateFilter" onchange="renderAdvancedCharts()">
                <option value="6">Last 6 months</option>
                <option value="12">Last 12 months</option>
                <option value="all">All time</option>
              </select>
            </div>
            <div>
              <label>Investment Group</label>
              <select id="anlInvGroup" onchange="updateAnlSubDropdown(); renderAdvancedCharts()"></select>
            </div>
            <div>
              <label>Investment Sub-type</label>
              <select id="anlInvSub" onchange="renderAdvancedCharts()"><option value="">All Types</option></select>
            </div>
            <div>
              <label>Chart type</label>
              <select id="chartType" onchange="renderAdvancedCharts()">
                <option value="line">Line chart</option>
                <option value="bar">Bar chart</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:20px; height:100%;">
          <div class="card" style="flex: 0 0 auto;">
            <div class="card-header"><div class="card-title">Cumulative Growth</div></div>
            <div class="card-body" style="padding-top:10px;">
              <div style="height:260px; width:100%; position:relative">
                <canvas id="chartNetWorth"></canvas>
              </div>
            </div>
          </div>

          <div class="dashboard-grid" style="flex:1;">
             <div class="card col-span-2">
                <div class="card-header"><div class="card-title">Distribution</div></div>
                <div class="card-body" style="padding-top:10px;">
                    <div style="height:100%; min-height:250px; position:relative;">
                        <canvas id="chartInvTypesModal"></canvas>
                    </div>
                </div>
             </div>
             <div class="card col-span-2">
                <div class="card-header"><div class="card-title">Growth Trend</div></div>
                <div class="card-body" style="padding-top:10px;">
                    <div style="height:100%; min-height:250px; position:relative;">
                        <canvas id="chartInvGrowthModal"></canvas>
                    </div>
                </div>
             </div>
          </div>
      </div>

    </div>
  </div>
</div>

<div id="importModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Import data</div>
      <button class="btn-outline" id="closeImport" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <h4 style="margin-top:0;">Import from CSV/JSON</h4>
      <p style="font-size:13px; color:var(--text-muted);">
        CSV columns: type, amount, date, desc, category, method. Optional: income_source, investment_group, investment_sub, insurance_type, insurance_for.
      </p>
      <input type="file" id="importFile" accept=".csv,.json" style="width:100%; margin:10px 0 20px 0;" />
      <button class="btn-primary full-width" id="processImportBtn">Process file</button>
    </div>
  </div>
</div>

<!-- Market ticker settings modal -->
<div id="marketSettingsModal" class="modal">
  <div class="modal-content">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Market Ticker Configuration</div>
      <button class="btn-outline closeModal" data-modal-id="marketSettingsModal" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <p style="font-size:13px; color:var(--text-muted);">
        Customize the stocks and commodities shown in the live ticker. Note: For real-time data, integrate a free API key
        into <code>fetchMarketData</code> (e.g., Alpha Vantage or FMP).
      </p>

      <div style="margin-bottom:16px">
        <label>Currently Tracked Markets</label>
        <ul id="marketList" class="list-unstyled" style="list-style:none; padding-left:0; display:flex; flex-direction:column; gap:8px;"></ul>
      </div>

      <!-- Predefined index selector -->
      <h3 style="margin:8px 0;">Add Major Index</h3>
      <form id="addMarketForm" class="full-width" style="display:flex; flex-direction:column; gap:10px;">
        <div class="form-row" style="display:flex; gap:10px; flex-wrap:wrap;">
          <div class="form-group" style="flex:1; min-width:220px;">
            <label for="majorIndexSelect">Select index:</label>
            <select id="majorIndexSelect" required>
              <option value="">Choose...</option>
              <!-- India -->
              <option value="NIFTY_50|Nifty 50">NIFTY 50 (India)</option>
              <option value="SENSEX|Sensex">SENSEX (India)</option>
              <!-- US -->
              <option value="NASDAQ|Nasdaq">NASDAQ (US)</option>
              <option value="DJI|Dow Jones">Dow Jones (US)</option>
              <option value="SPX|S&P 500">S&P 500 (US)</option>
              <!-- Europe -->
              <option value="FTSE_100|FTSE 100">FTSE 100 (UK)</option>
              <option value="DAX|DAX">DAX (Germany)</option>
              <option value="CAC_40|CAC 40">CAC 40 (France)</option>
              <!-- Asia -->
              <option value="NIKKEI_225|Nikkei 225">Nikkei 225 (Japan)</option>
              <option value="HSI|Hang Seng">Hang Seng (Hong Kong)</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn-primary">Add Index</button>
      </form>

      <!-- Commodity country filter -->
      <div style="margin-top:20px;">
        <h3 style="margin:8px 0;">Commodity region filter</h3>
        <div class="form-row" style="display:flex; gap:10px; flex-wrap:wrap;">
          <div class="form-group" style="flex:1; min-width:220px;">
            <label for="commodityCountrySelect">Country/Region for Gold/Silver:</label>
            <select id="commodityCountrySelect">
              <option value="">Global default</option>
              <option value="IN">India (INR)</option>
              <option value="US">United States (USD)</option>
              <option value="GB">United Kingdom (GBP)</option>
              <option value="EU">Eurozone (EUR)</option>
              <option value="AE">United Arab Emirates (AED)</option>
            </select>
            <small style="display:block; color:var(--text-muted); margin-top:6px;">
              This filters commodity symbols in the ticker (e.g., Gold, Silver) to the selected regionâ€™s typical currency mapping.
            </small>
          </div>
        </div>
        <div style="margin-top:10px;">
          <button id="applyCommodityFilter" class="btn-outline">Apply filter</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="calculator" style="display:none;">
  <div id="calc-header">
    <span>Calculator</span>
    <button id="calc-close-btn">Ã—</button>
  </div>
  <div id="calc-display">0</div>
  <div id="calc-preview">Enter an expressionâ€¦</div>
  <div id="calc-buttons">
    <button class="calc-clear">AC</button>
    <button class="calc-clear">Â±</button>
    <button class="calc-clear">% </button>
    <button class="calc-operator">/</button>
    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button class="calc-operator">*</button>
    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button class="calc-operator">-</button>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="calc-operator">+</button>
    <button class="calc-zero">0</button>
    <button>.</button>
    <button class="calc-equals">=</button>
  </div>
</div>
<script>
  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
    authDomain: "moneymirror-22543.firebaseapp.com",
    projectId: "moneymirror-22543",
    storageBucket: "moneymirror-22543.firebasestorage.app",
    messagingSenderId: "61775081584",
    appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
    measurementId: "G-8RPXH1VEFG"
  };
  const FIRESTORE_COLLECTION_NAME = 'moneymirror_v5_profile';

  let db = null;
  let auth = null;
  let USE_FIRESTORE = false;
  let currentProfile = null;

  // ---------- AUTH & BOOT ----------
  function showAuthGate() {
    const gate = document.getElementById('authGate');
    gate.classList.add('show');
    document.querySelector('main').style.filter = 'blur(5px)';
  }
  function hideAuthGate() {
    const gate = document.getElementById('authGate');
    gate.classList.remove('show');
    document.querySelector('main').style.filter = 'none';
  }

  try {
    if (typeof firebase !== 'undefined') {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
    }
  } catch (e) {
    console.warn("Firebase init failed. Using local-only mode.");
  }

  async function signInWithGoogle() {
    if (!auth) return alert('Auth not available. Use Guest Mode.');
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      onUserSignedIn(result.user);
    } catch (err) {
      console.error("Login failed:", err);
      alert('Sign-in failed. Try Guest Mode.');
    }
  }

  function startGuestMode() {
    currentProfile = 'Guest';
    localStorage.setItem('mm_last_profile', currentProfile);
    document.getElementById('profileNameDisplay').textContent = 'Guest (Offline)';
    hideAuthGate();
    document.getElementById('logoutBtn').style.display = 'block';
    loadProfileData();
  }

  function onUserSignedIn(user) {
    currentProfile = user.displayName || user.email || 'User';
    localStorage.setItem('mm_last_profile', currentProfile);
    document.getElementById('profileNameDisplay').textContent = currentProfile;
    hideAuthGate();
    document.getElementById('logoutBtn').style.display = 'block';
    loadProfileData();
  }

  function signOutUser() {
    if (auth) {
      auth.signOut().then(resetToAuthGate);
    } else {
      resetToAuthGate();
    }
  }

  function resetToAuthGate() {
    currentProfile = null;
    document.getElementById('profileNameDisplay').textContent = '--';
    document.getElementById('logoutBtn').style.display = 'none';
    showAuthGate();
  }

  // ---------- DOM READY ----------
  document.addEventListener('DOMContentLoaded', () => {
    // Login buttons
    document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
    document.getElementById('guestBtn').addEventListener('click', startGuestMode);
    document.getElementById('logoutBtn').addEventListener('click', signOutUser);

    // Date & clock
    const d = new Date();
    const currentDateEl = document.getElementById('currentDate');
    if (currentDateEl) currentDateEl.innerText = d.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const today = new Date().toISOString().slice(0,10);
    const dateEl = document.getElementById('date');
    if (dateEl) dateEl.value = today;
    const clockEl = document.getElementById('currentClock');
    function renderClock() {
      const now = new Date();
      clockEl.textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }
    if (clockEl) {
      renderClock();
      setInterval(renderClock, 1000);
    }

    // Mobile sidebar toggle
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('mainSidebar');
    if (mobileBtn && sidebar) {
      mobileBtn.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => sidebar.classList.remove('mobile-open'));
      });
    }

    // Modals
    document.getElementById('navSettings').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.add('open');
    });
    document.getElementById('closeSettings').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.remove('open');
    });
    document.getElementById('navAnalytics').addEventListener('click', () => {
      document.getElementById('analyticsModal').classList.add('open');
      populateAnalyticsDropdowns();
      renderAdvancedCharts();
    });
    document.getElementById('closeAnalytics').addEventListener('click', () => {
      document.getElementById('analyticsModal').classList.remove('open');
    });
    document.getElementById('importDataBtn').addEventListener('click', () => {
      document.getElementById('importModal').classList.add('open');
    });
    document.getElementById('closeImport').addEventListener('click', () => {
      document.getElementById('importModal').classList.remove('open');
    });
    document.querySelectorAll('.openModal').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        const id = e.currentTarget.dataset.modalId;
        const modal = document.getElementById(id);
        if (modal) {
          modal.classList.add('open');
          if (id === 'marketSettingsModal') renderMarketList();
        }
      });
    });
    document.querySelectorAll('.closeModal').forEach(el => {
      el.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.modalId;
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('open');
      });
    });

    // Calculator
    document.getElementById('calc-toggle').addEventListener('click', () => {
      const calc = document.getElementById('calculator');
      calc.style.display = calc.style.display === 'none' ? 'flex' : 'none';
    });
    document.getElementById('calc-close-btn').addEventListener('click', (e) => {
      document.getElementById('calculator').style.display = 'none';
      e.stopPropagation();
    });
    document.querySelectorAll('#calc-buttons button').forEach(button => {
      button.addEventListener('click', handleCalculatorInput);
    });
    dragElement(document.getElementById("calculator"));

    // Data actions
    document.getElementById('sampleBtn').addEventListener('click', loadSampleData);
    document.getElementById('exportBtn').addEventListener('click', () => convertToCSV(data));
    document.getElementById('processImportBtn').addEventListener('click', processImportedData);
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (confirm('WARNING: This will erase ALL your data. Are you sure?')) {
        localStorage.clear();
        data = [];
        methodNames = {...CANONICAL_METHODS};
        incomeSources = ['Salary', 'Freelance', 'Interest'];
        settings = { ...DEFAULT_SETTINGS };
        saveAll();
        window.location.reload();
      }
    });

    // Market settings listeners
    const addMarketFormEl = document.getElementById('addMarketForm');
    const majorIndexSelect = document.getElementById('majorIndexSelect');
    const commodityCountrySelect = document.getElementById('commodityCountrySelect');
    const applyCommodityFilterBtn = document.getElementById('applyCommodityFilter');
    if (addMarketFormEl && majorIndexSelect) {
      addMarketFormEl.addEventListener('submit', (e) => {
        e.preventDefault();
        const val = majorIndexSelect.value;
        if (!val) return;
        const [symbol, name] = val.split('|');
        addIndexToSettings(symbol, name);
        majorIndexSelect.value = '';
        renderMarketList();
        renderMarketTicker();
      });
    }
    if (applyCommodityFilterBtn && commodityCountrySelect) {
      applyCommodityFilterBtn.addEventListener('click', (e) => {
        e.preventDefault();
        settings.commodityCountry = commodityCountrySelect.value || '';
        remapCommoditySymbolsByCountry();
        saveAll();
        renderMarketList();
        renderMarketTicker();
      });
    }
    const sidebarIdxSelect = document.getElementById('sidebarIndexSelect');
    const sidebarAddIndexBtn = document.getElementById('sidebarAddIndexBtn');
    if (sidebarIdxSelect && sidebarAddIndexBtn) {
      sidebarAddIndexBtn.addEventListener('click', () => {
        const val = sidebarIdxSelect.value;
        if (!val) return;
        const [symbol, name] = val.split('|');
        addIndexToSettings(symbol, name);
        sidebarIdxSelect.value = '';
        renderMarketList();
        renderMarketTicker();
      });
    }

    // Auth state -> avoid flicker and avoid early render
    const lastProfile = localStorage.getItem('mm_last_profile');
    if (auth) {
      auth.onAuthStateChanged(user => {
        if (user) {
          onUserSignedIn(user);      // loadProfileData() -> render after data
        } else if (lastProfile === 'Guest') {
          startGuestMode();          // loadProfileData() -> render after data
        } else {
          showAuthGate();            // only show gate when unauthenticated and no guest
        }
      });
    } else {
      if (lastProfile === 'Guest') {
        startGuestMode();
      } else {
        showAuthGate();
      }
    }

    // INIT UI scaffolding that doesn't depend on data
    setupExpenseMultiSelect();
    setupInvestmentFilters();

    // IMPORTANT: No early renderAll(); Defer rendering until loadProfileData() completes.
    // Also no early startTickerRealtimeLoop(); it will start after loadProfileData().
  });

  // ---------- STATE ----------
  const DEFAULT_CC_LIMIT = 200000;
  const CANONICAL_METHODS = {
    'cash': 'Cash',
    'salary_acct': 'Bank Account (Salary)',
    'savings_acct': 'Bank Account (Savings)',
    'credit_card': 'Credit Card',
    'digital_wallet': 'Digital Wallet'
  };
  const BASE_CATS = ['Food', 'Rent', 'Utilities', 'Shopping', 'Entertainment', 'Travel', 'Health', 'Investments', 'Insurance', 'Credit Card Payment', 'Misc'];

  const DEFAULT_SETTINGS = {
    ccLimit: DEFAULT_CC_LIMIT,
    commodityCountry: '',
    api: { provider: 'none', key: '' },
    trackedMarkets: [
      { symbol: 'SENSEX', name: 'Sensex', price: 72000.00, change: 0.85 },
      { symbol: 'NASDAQ', name: 'Nasdaq', price: 16000.00, change: -1.23 },
      { symbol: 'XAUUSD', name: 'Gold/USD', price: 2350.00, change: 0.15 },
      { symbol: 'XAGUSD', name: 'Silver/USD', price: 28.50, change: -0.55 },
      { symbol: 'BTCUSD', name: 'Bitcoin', price: 68000.00, change: 2.10 }
    ]
  };

  const INVESTMENT_STRUCTURE = {
    'Equity (Stocks)': {
      'India - Large Cap/Mid Cap/Small Cap': 'Equity (Stocks)',
      'India - Index Stocks/Preferred Stock': 'Equity (Stocks)',
      'India - Derivatives (Options/Futures)': 'Equity (Stocks)',
      'US - Stocks': 'Equity (Stocks)',
      'International - Other': 'Equity (Stocks)',
    },
    'Mutual Funds': {
      'Equity MF - Large Cap/Mid Cap/Small Cap': 'Mutual Funds',
      'Equity MF - Multi-cap': 'Mutual Funds',
      'Equity MF - ELSS (Tax Saving)': 'Mutual Funds',
      'Debt MF - Overnight/Liquid/Ultra Short Term': 'Mutual Funds',
      'Debt MF - Corporate/Dynamic Bond': 'Mutual Funds',
      'Hybrid/Balanced MF': 'Mutual Funds',
      'International/Global Index MF': 'Mutual Funds',
      'Gold/Sectoral/Thematic MF': 'Mutual Funds',
    },
    'ETFs': {
      'Equity ETF': 'ETFs',
      'Debt ETF': 'ETFs',
      'Gold ETF': 'ETFs',
      'Index ETF': 'ETFs',
      'Thematic ETF': 'ETFs',
    },
    'Bonds & Debt Instruments': {
      'Government Bonds': 'Bonds & Debt Instruments',
      'Corporate Bonds': 'Bonds & Debt Instruments',
      'Treasury Bills': 'Bonds & Debt Instruments',
      'Tax-Free Bonds': 'Bonds & Debt Instruments',
      'Sovereign Gold Bonds (SGB)': 'Bonds & Debt Instruments',
    },
    'Commodities': {
      'Gold (Physical/Digital)': 'Commodities',
      'Silver': 'Commodities',
      'Crude Oil/Natural Gas': 'Commodities',
      'Other Metals (Copper/Nickel)': 'Commodities',
    },
    'Crypto & Digital Assets': {
      'Bitcoin (BTC)': 'Crypto & Digital Assets',
      'Ethereum (ETH)': 'Crypto & Digital Assets',
      'Stablecoins': 'Crypto & Digital Assets',
      'Altcoins': 'Crypto & Digital Assets',
      'NFTs / Web3 Assets': 'Crypto & Digital Assets',
    },
    'Real Estate': {
      'Residential Property': 'Real Estate',
      'Commercial Property': 'Real Estate',
      'Land': 'Real Estate',
      'REITs (Real Estate Investment Trusts)': 'Real Estate',
    },
    'Fixed Income / Savings Schemes': {
      'FD (Fixed Deposit)': 'Fixed Income / Savings Schemes',
      'RD (Recurring Deposit)': 'Fixed Income / Savings Schemes',
      'PPF': 'Fixed Income / Savings Schemes',
      'NSC/KVP/Postal MIS': 'Fixed Income / Savings Schemes',
      'High-Interest Savings Account': 'Fixed Income / Savings Schemes',
    },
    'Retirement Funds': {
      'NPS Tier 1/Tier 2': 'Retirement Funds',
      'EPF (Employeesâ€™ Provident Fund)': 'Retirement Funds',
      'IRA/401k (USA users)': 'Retirement Funds',
      'Other Pension Schemes': 'Retirement Funds',
    },
    'Other Investments': {
      'Angel Investing / Startup Equity': 'Other Investments',
      'Peer-to-Peer Lending': 'Other Investments',
      'Private Funds / AIFs': 'Other Investments',
      'Alternative Assets': 'Other Investments',
    }
  };
  const MAJOR_BUCKETS = {
    'Equity (Stocks)': 'Equity',
    'Mutual Funds': 'Mutual Funds',
    'ETFs': 'ETFs',
    'Bonds & Debt Instruments': 'Debt',
    'Fixed Income / Savings Schemes': 'Debt',
    'Retirement Funds': 'Retirement',
    'Real Estate': 'Real Estate',
    'Commodities': 'Commodities',
    'Crypto & Digital Assets': 'Crypto',
    'Other Investments': 'Other'
  };

  let data = [];
  let methodNames = {...CANONICAL_METHODS};
  let incomeSources = ['Salary', 'Freelance', 'Interest'];
  let settings = { ...DEFAULT_SETTINGS };
  let editId = null;
  let selectedExpenseCategories = [];

  // ---------- PERSISTENCE ----------
  function getTxKey() { return currentProfile ? `mm_data_${currentProfile}` : 'mm_data_default'; }
  function getMethodKey() { return currentProfile ? `mm_methods_${currentProfile}` : 'mm_methods_default'; }
  function getIncomeKey() { return currentProfile ? `mm_income_${currentProfile}` : 'mm_income_default'; }
  function getSettingsKey() { return currentProfile ? `mm_settings_${currentProfile}` : 'mm_settings_default'; }
  function toKey(name) { return String(name || '').toLowerCase().replace(/[^a-z0-9]+/g, '_'); }

  function saveLocal() {
    localStorage.setItem(getTxKey(), JSON.stringify(data));
    localStorage.setItem(getMethodKey(), JSON.stringify(methodNames));
    localStorage.setItem(getIncomeKey(), JSON.stringify(incomeSources));
    localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
  }

  function saveAll() {
    if (!currentProfile || !USE_FIRESTORE || !db) {
      saveLocal();
      return;
    }
    const docRef = db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile));
    docRef.set({
      data, methodNames, incomeSources, settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).catch((error) => {
      console.error("Firestore write error:", error);
      saveLocal();
    });
  }

  function loadLocal() {
    methodNames = JSON.parse(localStorage.getItem(getMethodKey())) || {...CANONICAL_METHODS};
    incomeSources = JSON.parse(localStorage.getItem(getIncomeKey())) || ['Salary', 'Freelance', 'Interest'];
    data = JSON.parse(localStorage.getItem(getTxKey())) || [];
    const storedSettings = JSON.parse(localStorage.getItem(getSettingsKey()));
    if (storedSettings) {
      settings = { ...DEFAULT_SETTINGS, ...storedSettings };
      if (!settings.trackedMarkets) settings.trackedMarkets = DEFAULT_SETTINGS.trackedMarkets.slice();
      if (!settings.api) settings.api = { provider: 'none', key: '' };
    }
    // normalize data
    data = data.map(d => ({
      id: d.id || uid(),
      type: d.type || 'expense',
      amount: Number(d.amount) || 0,
      date: d.date || new Date().toISOString().slice(0,10),
      desc: d.desc || '',
      category: d.category || (d.type === 'income' ? 'N/A' : 'Misc'),
      method: d.method || (d.type === 'income' ? 'salary_acct' : 'cash'),
      incomeSource: d.incomeSource || '',
      investmentGroup: d.investmentGroup || '',
      investmentSub: d.investmentSub || '',
      insuranceType: d.insuranceType || '',
      insuranceFor: d.insuranceFor || '',
    }));
  }

  async function loadProfileData() {
    // Load cached first
    loadLocal();

    // Optimistically render tickers from cached prices immediately
    renderMarketTicker();

    // Then, merge from Firestore if available
    if (USE_FIRESTORE && db && currentProfile) {
      try {
        const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).get();
        if (doc.exists) {
          const server = doc.data();
          data = server.data || data;
          methodNames = server.methodNames || methodNames;
          incomeSources = server.incomeSources || incomeSources;
          settings = { ...DEFAULT_SETTINGS, ...(server.settings || {}) };
        }
      } catch (e) {
        console.error("Firestore read error:", e);
      }
    }

    // Now render everything once (no double-render)
    renderAll();

    // Start ticker loop after initial render, with bootstrap cadence
    startTickerRealtimeLoop();
  }

  // ---------- RENDER ----------
  function renderAll() {
    data.sort((a,b) => new Date(b.date) - new Date(a.date));
    setupDropdowns();
    renderKPIs();
    renderCharts();
    renderRecentEntries();
    renderSettings();
    remapCommoditySymbolsByCountry();
    renderMarketTicker();
  }

  function setupDropdowns() {
    // Methods
    formEls.method.innerHTML = Object.keys(methodNames)
      .filter(key => key !== 'credit_card')
      .map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');
    // Income sources
    formEls.incomeSource.innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');
    // Categories
    formEls.category.innerHTML = BASE_CATS.map(c => `<option value="${c}">${c}</option>`).join('');
    // Recent filter
    const recentCat = document.getElementById('recentCategory');
    if (recentCat) {
      const allCats = Array.from(new Set([...BASE_CATS, 'Income', 'Opening Balance']));
      recentCat.innerHTML = '<option value="">All Cats</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    // Listeners
    formEls.type.onchange = updateTransactionFormFields;
    formEls.category.onchange = updateTransactionFormFields;
    formEls.openingType.onchange = updateTransactionFormFields;
    formEls.invGroup.onchange = () => updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
    formEls.openingGroup.onchange = () => updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub);

    populateInvestmentGroupDropdowns();
    updateTransactionFormFields();
  }

  const formEls = {
    type: document.getElementById('type'),
    amount: document.getElementById('amount'),
    date: document.getElementById('date'),
    desc: document.getElementById('desc'),
    category: document.getElementById('category'),
    method: document.getElementById('method'),
    incomeSource: document.getElementById('incomeSource'),
    invGroup: document.getElementById('invGroup'),
    invSub: document.getElementById('invSub'),
    openingType: document.getElementById('openingType'),
    openingGroup: document.getElementById('openingGroup'),
    openingSub: document.getElementById('openingSub'),
    openingSubLabel: document.getElementById('openingSubLabel'),
    addBtn: document.getElementById('addBtn'),
    saveBtn: document.getElementById('saveBtn'),
    cancelBtn: document.getElementById('cancelBtn'),
    categoryContainer: document.getElementById('categoryContainer'),
    incomeRow: document.getElementById('incomeSourceRow'),
    invRow: document.getElementById('investmentRow'),
    insRow: document.getElementById('insuranceRow'),
    openingBalanceRow: document.getElementById('openingBalanceRow'),
    regularFieldsDiv: document.getElementById('regularFields'),
  };

  function populateInvestmentGroupDropdowns() {
    const options = Object.keys(INVESTMENT_STRUCTURE).map(group => `<option value="${group}">${group}</option>`).join('');
    formEls.invGroup.innerHTML = '<option value="">Select Category</option>' + options;
    formEls.openingGroup.innerHTML = '<option value="">Select Category</option>' + options;
  }
  function updateInvestmentSubDropdown(groupEl, subEl, initialValue = null) {
    const selectedGroup = groupEl.value;
    let optionsHtml = '<option value="">Select Sub-Type</option>';
    if (selectedGroup && INVESTMENT_STRUCTURE[selectedGroup]) {
      const subTypes = Object.keys(INVESTMENT_STRUCTURE[selectedGroup]);
      optionsHtml += subTypes.map(sub => `<option value="${sub}" ${initialValue === sub ? 'selected' : ''}>${sub}</option>`).join('');
    }
    subEl.innerHTML = optionsHtml;
  }
  function updateTransactionFormFields(editEntry = null){
    const entryType = formEls.type.value;
    const cat = formEls.category.value;
    const openingType = formEls.openingType.value;

    formEls.regularFieldsDiv.classList.remove('hidden');
    formEls.openingBalanceRow.classList.add('hidden');
    formEls.incomeRow.classList.add('hidden');
    formEls.invRow.classList.add('hidden');
    formEls.insRow.classList.add('hidden');
    formEls.categoryContainer.classList.remove('hidden');

    document.getElementById('openingGroupContainer').classList.add('hidden');
    document.getElementById('openingSubContainer').classList.add('hidden');

    if(entryType === 'opening_balance'){
      formEls.openingBalanceRow.classList.remove('hidden');
      formEls.regularFieldsDiv.classList.add('hidden');
      if (openingType === 'Investment') {
        document.getElementById('openingGroupContainer').classList.remove('hidden');
        document.getElementById('openingSubContainer').classList.remove('hidden');
        formEls.openingGroupLabel.textContent = 'Investment Category';
        document.getElementById('openingSubLabel').textContent = 'Investment Sub-Type';
        if (editEntry) {
          formEls.openingGroup.value = editEntry.investmentGroup || '';
          updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub, editEntry.investmentSub);
        } else {
          updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub);
        }
      } else {
        document.getElementById('openingSubContainer').classList.remove('hidden');
        formEls.openingGroupLabel.textContent = 'Account Group';
        document.getElementById('openingSubLabel').textContent = 'Cash Account';
        formEls.openingGroup.innerHTML = `<option value="Cash">Cash</option>`;
        formEls.openingSub.innerHTML = `<option value="">Select Account</option>` +
          Object.keys(methodNames).filter(key => key !== 'credit_card').map(key =>
            `<option value="${key}" ${editEntry && editEntry.method === key ? 'selected' : ''}>${methodNames[key]}</option>`
          ).join('');
      }
    } else if (entryType === 'income') {
      formEls.incomeRow.classList.remove('hidden');
      formEls.categoryContainer.classList.add('hidden');
    } else if (entryType === 'expense') {
      if(cat === 'Investments') {
        formEls.invRow.classList.remove('hidden');
        if (editEntry) {
          formEls.invGroup.value = editEntry.investmentGroup || '';
          updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, editEntry.investmentSub);
        } else {
          updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
        }
      } else if(cat === 'Insurance') {
        formEls.insRow.classList.remove('hidden');
      }
    }
  }

  // ---------- CRUD ----------
  function uid() { return 'id' + Date.now() + Math.random().toString(16).slice(2); }
  function requireSignedIn() { return true; }

  function submitForm(e, isImportOrEdit=false){
    const type = formEls.type.value;
    const amount = Number(formEls.amount.value);
    const date = formEls.date.value;
    const desc = formEls.desc.value;
    const method = formEls.method.value;

    if(amount <= 0 || isNaN(amount)) return alert('Enter a valid amount.');
    if(!date) return alert('Select a date.');
    if(!desc) return alert('Enter a description.');

    const entry = { id: e ? e.id : uid(), type, amount, date, desc, category: '', method: method, incomeSource: '', investmentGroup: '', investmentSub: '', insuranceType: '', insuranceFor: '' };
    if(type === 'income') {
      entry.incomeSource = formEls.incomeSource.value || (e ? e.incomeSource : '');
      entry.category = 'N/A';
      entry.investmentGroup = entry.investmentSub = '';
    } else if(type === 'opening_balance') {
      const obType = formEls.openingType.value;
      if (obType === 'Cash') {
        entry.method = formEls.openingSub.value || (e ? e.method : '');
        entry.investmentGroup = 'Cash';
        entry.investmentSub = formEls.openingSub.value || (e ? e.investmentSub : '');
        if(!entry.method && !isImportOrEdit) return alert('Select a cash account.');
      } else {
        entry.method = '';
        entry.investmentGroup = formEls.openingGroup.value || (e ? e.investmentGroup : '');
        entry.investmentSub = formEls.openingSub.value || (e ? e.investmentSub : '');
        if(!entry.investmentGroup && !isImportOrEdit) return alert('Select Investment Category.');
        if(!entry.investmentSub && !isImportOrEdit) return alert('Select Investment Sub-Type.');
      }
      entry.category = 'N/A';
    } else if(type === 'expense') {
      entry.category = formEls.category.value || (e ? e.category : '');
      if(!entry.category && !isImportOrEdit) return alert('Select a Category.');
      if(!entry.method && !isImportOrEdit && entry.category !== 'Credit Card Payment') return alert('Select a Payment Method.');
      if(entry.category === 'Investments') {
        entry.investmentGroup = formEls.invGroup.value || (e ? e.investmentGroup : '');
        entry.investmentSub = formEls.invSub.value || (e ? e.investmentSub : '');
        if(!entry.investmentGroup && !isImportOrEdit) return alert('Select Investment Category.');
        if(!entry.investmentSub && !isImportOrEdit) return alert('Select Investment Sub-Type.');
        entry.insuranceType = entry.insuranceFor = '';
      } else if(entry.category === 'Insurance') {
        entry.insuranceType = formEls.insType.value || (e ? e.insuranceType : 'General');
        entry.insuranceFor = formEls.insFor.value || (e ? e.insuranceFor : 'Self');
      } else if (entry.category === 'Credit Card Payment') {
        entry.method = 'credit_card_payment';
      } else {
        entry.investmentGroup = entry.investmentSub = '';
        entry.insuranceType = entry.insuranceFor = '';
      }
    }

    if (editId) {
      data = data.map(t => t.id === editId ? entry : t);
      editId = null;
      formEls.addBtn.classList.remove('hidden');
      formEls.saveBtn.classList.add('hidden');
      formEls.cancelBtn.classList.add('hidden');
    } else {
      data.unshift(entry);
    }

    saveAll();
    renderAll();
    if (!isImportOrEdit) clearForm();
  }

  formEls.addBtn.addEventListener('click', () => submitForm());
  formEls.saveBtn.addEventListener('click', () => {
    const entryToEdit = data.find(t => t.id === editId);
    if (entryToEdit) submitForm(entryToEdit);
  });
  formEls.cancelBtn.addEventListener('click', () => {
    editId = null;
    formEls.addBtn.classList.remove('hidden');
    formEls.saveBtn.classList.add('hidden');
    formEls.cancelBtn.classList.add('hidden');
    clearForm();
  });

  function loadEdit(id) {
    const e = data.find(t => t.id === id);
    if (!e) return;
    editId = id;

    formEls.type.value = e.type;
    formEls.amount.value = e.amount;
    formEls.date.value = e.date;
    formEls.desc.value = e.desc;
    formEls.category.value = e.category || 'Food';
    formEls.method.value = e.method || 'cash';
    formEls.incomeSource.value = e.incomeSource || '';
    formEls.insType.value = e.insuranceType || '';
    formEls.insFor.value = e.insuranceFor || '';

    if (e.type === 'opening_balance') {
      if (e.investmentGroup && e.investmentGroup !== 'Cash') {
        formEls.openingType.value = 'Investment';
      } else {
        formEls.openingType.value = 'Cash';
      }
    }

    updateTransactionFormFields(e);

    if (e.type === 'opening_balance') {
      if (formEls.openingType.value === 'Investment') {
        formEls.openingGroup.value = e.investmentGroup || '';
        updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub, e.investmentSub);
      } else {
        formEls.openingSub.value = e.method || '';
      }
    } else if (e.type === 'expense' && e.category === 'Investments') {
      formEls.invGroup.value = e.investmentGroup || '';
      updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, e.investmentSub);
    }

    formEls.addBtn.classList.add('hidden');
    formEls.saveBtn.classList.remove('hidden');
    formEls.cancelBtn.classList.remove('hidden');
  }

  function deleteEntry(id) {
    if (confirm('Delete this transaction?')) {
      data = data.filter(t => t.id !== id);
      saveAll();
      renderAll();
    }
  }

  function clearForm(){
    formEls.amount.value='';
    formEls.desc.value='';
    formEls.date.value=new Date().toISOString().slice(0,10);
    formEls.type.value='expense';
    formEls.category.value='Food';
    formEls.method.value='cash';
    formEls.incomeSource.value='';
    formEls.invGroup.value='';
    formEls.invSub.value='';
    formEls.openingType.value='Cash';
    formEls.openingGroup.value='';
    formEls.openingSub.value='';
    formEls.insType.value='';
    formEls.insFor.value='';
    updateTransactionFormFields();
  }

  // ---------- KPIs ----------
  function fmt(n) { return (n || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
  function pct(n) { return (n || 0).toFixed(1) + '%'; }
  function getNextPaymentDate() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const paymentDay = 10;
    let paymentDate = new Date(currentYear, currentMonth, paymentDay);
    if (today.getDate() > paymentDay) paymentDate.setMonth(currentMonth + 1);
    return paymentDate.toLocaleDateString('en-IN', {month:'short', day:'numeric'});
  }

  function renderKPIs(){
    const curMonth = new Date().getMonth();
    const curYear = new Date().getFullYear();
    const prevMonth = curMonth === 0 ? 11 : curMonth - 1;
    const prevYear = curMonth === 0 ? curYear - 1 : curYear;
    const operationalData = data.filter(d => d.type !== 'opening_balance');
    const filterMonth = (d, m, y) => { const dt = new Date(d); return dt.getMonth()===m && dt.getFullYear()===y; };
    const sum = (arr) => arr.reduce((acc,curr) => acc + Number(curr.amount), 0);

    const curData = operationalData.filter(d => filterMonth(d.date, curMonth, curYear));
    const prevData = operationalData.filter(d => filterMonth(d.date, prevMonth, prevYear));

    const inc = sum(curData.filter(d=>d.type==='income'));
    const exp = sum(curData.filter(d=>d.type==='expense'));
    const prevInc = sum(prevData.filter(d=>d.type==='income'));
    const prevExp = sum(prevData.filter(d=>d.type==='expense'));

    const allInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
    const totalInvested = sum(allInvestments);

    const momInc = (inc / (prevInc || 1) - 1) * 100;
    const momExp = (exp / (prevExp || 1) - 1) * 100;

    const momIncEl = document.getElementById('momIncome');
    momIncEl.className = momInc >= 0 ? 'trend-up' : 'trend-down';
    momIncEl.innerHTML = `${momInc >= 0 ? 'â–²' : 'â–¼'} ${pct(Math.abs(momInc))} vs Last`;

    const momExpEl = document.getElementById('momExpense');
    momExpEl.className = momExp <= 0 ? 'trend-up' : 'trend-down';
    momExpEl.innerHTML = `${momExp <= 0 ? 'â–²' : 'â–¼'} ${pct(Math.abs(momExp))} vs Last`;

    // Credit card logic
    const ccOpen = sum(data.filter(d => d.type === 'opening_balance' && d.method === 'credit_card'));
    const ccExp = sum(data.filter(d => d.type === 'expense' && d.method === 'credit_card'));
    const ccPay = sum(data.filter(d => d.type === 'expense' && d.category === 'Credit Card Payment'));
    const creditCardDue = ccOpen + ccExp - ccPay;
    const ccLimit = settings.ccLimit;
    const ccCard = document.getElementById('ccCard');
    const isHigh = ccLimit ? (creditCardDue / ccLimit > 0.8) : false;
    ccCard.classList.toggle('cc-alert-high', isHigh);
    document.getElementById('ccTitle').style.color = isHigh ? 'var(--danger)' : 'var(--warning)';
    document.getElementById('ccAlert').classList.toggle('hidden', !isHigh);

    document.getElementById('kpiIncome').innerText = fmt(inc);
    document.getElementById('kpiExpense').innerText = fmt(exp);
    document.getElementById('kpiNet').innerText = fmt(inc - exp);
    document.getElementById('kpiInvest').innerText = fmt(totalInvested);
    document.getElementById('kpiCCDue').innerText = fmt(creditCardDue);
    document.getElementById('ccLimitDisplay').innerText = fmt(ccLimit);
    document.getElementById('ccPaymentDate').innerText = `Next: ${getNextPaymentDate()}`;

    // Net liquidity breakdown
    const breakdownContainer = document.getElementById('netLiquidityBreakdown');
    let breakdownHtml = '';
    const liquidMethods = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'income') || (d.type === 'expense' && d.category !== 'Investments'));
    const methodBalances = liquidMethods.reduce((acc, curr) => {
      const key = curr.method || 'cash';
      const isExpense = curr.type === 'expense' && curr.category !== 'Credit Card Payment';
      const amount = isExpense ? -Number(curr.amount) : Number(curr.amount);
      acc[key] = (acc[key] || 0) + amount;
      return acc;
    }, {});
    const allMethodKeys = new Set([...Object.keys(methodNames), ...Object.keys(methodBalances)].filter(key => key !== 'credit_card_payment'));
    allMethodKeys.forEach(key => {
      if(key === 'credit_card' || !key) return;
      const name = methodNames[key] || key;
      const balance = methodBalances[key] || 0;
      if(balance !== 0 || CANONICAL_METHODS[key]) {
        breakdownHtml += `<div><span>${name}</span><span>${fmt(balance)}</span></div>`;
      }
    });
    breakdownContainer.innerHTML = breakdownHtml;

    renderInvestmentKPICharts();
  }

  // ---------- INVESTMENT KPI CHARTS ----------
  function getColorPalette(count) {
    const colorsVars = ['--c1','--c2','--c3','--c4','--c5','--c6','--c7','--c8','--c9','--c10','--c11','--c12']
      .map(v => getComputedStyle(document.documentElement).getPropertyValue(v).trim() || '#3b82f6');
    return Array.from({length: count}, (_, i) => colorsVars[i % colorsVars.length]);
  }
  function applyDateRangeToInvestments(entries, range) {
    if(!range || range === 'all') return entries;
    const cutoff = new Date();
    cutoff.setMonth(cutoff.getMonth() - Number(range));
    return entries.filter(e => new Date(e.date) >= cutoff);
  }
  function rollupMajorBuckets(entries) {
    const byBucket = entries.reduce((acc, curr) => {
      const group = curr.investmentGroup || 'Uncategorized';
      const bucket = MAJOR_BUCKETS[group] || 'Other';
      acc[bucket] = (acc[bucket] || 0) + Number(curr.amount);
      return acc;
    }, {});
    const items = Object.entries(byBucket).map(([bucket, amount]) => ({ bucket, amount }));
    items.sort((a,b) => b.amount - a.amount);
    return items;
  }
  function rollupSubcategories(entries, selectedBucket) {
    const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g] === selectedBucket);
    const filtered = entries.filter(e => groupsInBucket.includes(e.investmentGroup));
    const bySub = filtered.reduce((acc, curr) => {
      const sub = curr.investmentSub || 'General';
      acc[sub] = (acc[sub] || 0) + Number(curr.amount);
      return acc;
    }, {});
    const items = Object.entries(bySub).map(([sub, amount]) => ({ sub, amount })).sort((a,b) => b.amount - a.amount);
    return items;
  }
  function setupInvestmentFilters() {
    const bucketSelect = document.getElementById('invBucketFilter');
    const uniqueBuckets = Array.from(new Set(Object.values(MAJOR_BUCKETS)));
    bucketSelect.innerHTML = '<option value="">Select bucket</option>' + uniqueBuckets.map(b => `<option value="${b}">${b}</option>`).join('');
    document.getElementById('invViewMode').addEventListener('change', renderInvestmentKPICharts);
    bucketSelect.addEventListener('change', renderInvestmentKPICharts);
    document.getElementById('invDateRange').addEventListener('change', renderInvestmentKPICharts);
    const toggleBtn = document.getElementById('toggleInvBreakdown');
    const panel = document.getElementById('invBreakdownPanel');
    if (toggleBtn && panel) toggleBtn.onclick = () => panel.classList.toggle('hidden');
    const viewCatsBtn = document.getElementById('viewCategoriesBtn');
    if (viewCatsBtn) {
      viewCatsBtn.onclick = () => {
        panel.classList.remove('hidden');
        document.getElementById('invViewMode').value = 'subcats';
        if (!bucketSelect.value) bucketSelect.value = uniqueBuckets[0] || '';
        renderInvestmentKPICharts();
      };
    }
  }
  let invBreakdownBarChart = null;
  let invBreakdownPieChart = null;
  function renderQuickSubDropdowns(entries){
    const container = document.getElementById('invQuickSubs');
    if(!container) return;
    const order = ['Equity','Debt','ETFs','Mutual Funds','Retirement','Real Estate','Commodities','Crypto','Other'];
    const items = rollupMajorBuckets(entries);
    const totals = Object.fromEntries(items.map(i => [i.bucket, i.amount]));
    const blocks = order.filter(b => Object.keys(totals).includes(b)).map(bucket => {
      const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g] === bucket);
      const subsSet = new Set();
      groupsInBucket.forEach(g => Object.keys(INVESTMENT_STRUCTURE[g] || {}).forEach(s => subsSet.add(s)));
      const subs = Array.from(subsSet);
      const subValues = subs.map(sub => {
        const sumAmt = entries.filter(d =>
          (((d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'))) &&
          groupsInBucket.includes(d.investmentGroup) && d.investmentSub === sub
        ).reduce((acc,c) => acc + Number(c.amount), 0);
        return {sub, amount: sumAmt};
      }).filter(x => x.amount > 0).sort((a,b) => b.amount - a.amount);
      const dropdownHtml = subValues.length ? subValues.map(x => `
        <div class="sub-dropdown-item">
            <span>${x.sub}</span>
            <strong style="color:var(--primary-dark)">${fmt(x.amount)}</strong>
        </div>
      `).join('') : `<div class="sub-dropdown-item" style="color:#aaa;">No data</div>`;
      return `
        <div class="quick-sub-card">
          <div class="quick-sub-header">
            <div class="quick-sub-title">${bucket}</div>
            <span class="total-badge">${fmt(totals[bucket] || 0)}</span>
          </div>
          <div class="sub-dropdown-container">
            <button class="btn-outline" style="padding:6px 10px; font-size:12px; width:100%; text-align:left;"
                    onclick="toggleSubMenu(this)">View subcategories â–¾</button>
            <div class="sub-dropdown-menu">
              ${dropdownHtml}
            </div>
          </div>
        </div>
      `;
    }).join('');
    container.innerHTML = blocks;
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.sub-dropdown-container')) {
        document.querySelectorAll('.sub-dropdown-menu').forEach(m => m.classList.remove('show'));
      }
    });
  }
  function toggleSubMenu(btn) {
    const currentMenu = btn.parentElement.querySelector('.sub-dropdown-menu');
    document.querySelectorAll('.sub-dropdown-menu').forEach(m => { if (m !== currentMenu) m.classList.remove('show'); });
    currentMenu.classList.toggle('show');
  }
  function renderInvestmentKPICharts() {
    if (typeof Chart === 'undefined') return;
    const rawInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
    const range = document.getElementById('invDateRange')?.value || 'all';
    const viewMode = document.getElementById('invViewMode')?.value || 'top4';
    const selectedBucket = document.getElementById('invBucketFilter')?.value || '';
    const entries = applyDateRangeToInvestments(rawInvestments, range);
    let labels = [], values = [];
    const colors = getColorPalette(10);
    if(viewMode === 'subcats' && selectedBucket) {
      const items = rollupSubcategories(entries, selectedBucket);
      labels = items.map(i => i.sub);
      values = items.map(i => i.amount);
      document.getElementById('invBarTitle').innerText = `Subcategory amounts (${selectedBucket})`;
      document.getElementById('invPieTitle').innerText = `Share by subcategory (${selectedBucket})`;
    } else {
      const items = rollupMajorBuckets(entries);
      const top4 = items.slice(0, 4);
      labels = top4.map(i => i.bucket);
      values = top4.map(i => i.amount);
      document.getElementById('invBarTitle').innerText = 'Investment by major bucket (Top 4)';
      document.getElementById('invPieTitle').innerText = 'Share by bucket (Top 4)';
    }
    if (invBreakdownBarChart) invBreakdownBarChart.destroy();
    const barCtx = document.getElementById('invBreakdownBar');
    if (barCtx) {
      invBreakdownBarChart = new Chart(barCtx.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Historical cost', data: values, backgroundColor: colors.map(c => c+'cc'), borderColor: colors, borderWidth: 1.5, borderRadius: 6 }] },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c)=>`${c.label}: ${fmt(c.parsed.y)}` } } },
          scales: { y: { beginAtZero: true, ticks: { callback: (v)=>fmt(v).replace('â‚¹','â‚¹ ') }, grid:{color:'#eef2ff'} }, x:{grid:{display:false}} }
        }
      });
    }
    if (invBreakdownPieChart) invBreakdownPieChart.destroy();
    const pieCtx = document.getElementById('invBreakdownPie');
    if (pieCtx) {
      invBreakdownPieChart = new Chart(pieCtx.getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, hoverOffset: 6, borderColor:'#ffffff', borderWidth:2 }] },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { boxWidth: 10 } },
            tooltip: { callbacks: { label: (c)=> {
              const total = values.reduce((a,b)=>a+b,0);
              const share = total ? ((c.parsed/total)*100).toFixed(1) : '0.0';
              return `${c.label}: ${fmt(c.parsed)} (${share}%)`;
            }}}
          },
          cutout: '60%',
          onClick: (evt, els) => {
            if (!els || !els.length) return;
            const idx = els[0].index;
            const bucket = labels[idx];
            document.getElementById('invViewMode').value = 'subcats';
            document.getElementById('invBucketFilter').value = bucket;
            renderInvestmentKPICharts();
          }
        }
      });
    }
    renderQuickSubDropdowns(entries);
  }

  // ---------- CHARTS ----------
  function prepareMonthlyData(range, filteredData = data) {
    const monthlyData = {};
    const dates = filteredData.map(d => new Date(d.date));
    if (dates.length === 0) return { labels: [], income: [], expense: [], investment: [] };
    const start = range === 'all' ? new Date(Math.min(...dates)) : new Date();
    if (range !== 'all') start.setMonth(start.getMonth() - Number(range));
    start.setDate(1);
    let currentDate = new Date(start.getFullYear(), start.getMonth(), 1);
    const today = new Date();
    while (currentDate <= today) {
      const key = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
      monthlyData[key] = { income: 0, expense: 0, investment: 0, month: currentDate.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }) };
      currentDate.setMonth(currentDate.getMonth() + 1);
    }
    filteredData.forEach(d => {
      const date = new Date(d.date);
      const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
      if (monthlyData[key]) {
        const amount = Number(d.amount);
        if (d.type === 'income') monthlyData[key].income += amount;
        else if (d.type === 'expense') {
          if (d.category === 'Investments') monthlyData[key].investment += amount;
          else monthlyData[key].expense += amount;
        }
      }
    });
    const keys = Object.keys(monthlyData).sort();
    return {
      labels: keys.map(k => monthlyData[k].month),
      income: keys.map(k => monthlyData[k].income),
      expense: keys.map(k => monthlyData[k].expense),
      investment: keys.map(k => monthlyData[k].investment)
    };
  }

  let chartMain = null;
  let donutChart = null;
  function renderCharts() {
    if (typeof Chart === 'undefined') return;
    const range = document.getElementById('mainChartFilter').value;
    const { labels, income, expense, investment } = prepareMonthlyData(range === 'all' ? 'all' : Number(range), data);
    const netIncomeSeries = income.map((v, i) => v - expense[i]);
    if (chartMain) chartMain.destroy();
    const ctxMain = document.getElementById('mainChart').getContext('2d');
    chartMain = new Chart(ctxMain, {
      data: {
        labels: labels,
        datasets: [
          { type: 'bar', label: 'Income', data: income, backgroundColor: 'rgba(16, 185, 129, 0.8)', stack: 'flow' },
          { type: 'bar', label: 'Expense', data: expense.map(e => -e), backgroundColor: 'rgba(239, 68, 68, 0.8)', stack: 'flow' },
          { type: 'bar', label: 'Investment', data: investment.map(i => -i), backgroundColor: 'rgba(14, 165, 233, 0.8)', stack: 'flow' },
          { type: 'line', label: 'Net Income', data: netIncomeSeries, borderColor: '#000000', tension: 0.3, pointRadius: 3, fill: false }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { stacked: true },
          y: { stacked: true, ticks: { callback: function(value) { return fmt(Math.abs(value)).replace('â‚¹', 'â‚¹ '); } } }
        },
        plugins: {
          tooltip: { callbacks: { label: function(context) {
            let label = context.dataset.label || '';
            if (label) label += ': ';
            if (context.parsed.y !== null) label += fmt(Math.abs(context.parsed.y));
            return label;
          }}},
          legend: { position: 'top' }
        }
      }
    });
    renderWalletUnified();
  }

  // ---------- WALLET / EXPENSE ----------
  function setupExpenseMultiSelect() {
    const container = document.getElementById('expenseFilterContainer');
    const btn = document.getElementById('expenseFilterBtn');
    const dropdown = document.getElementById('expenseMultiselectDropdown');
    const list = document.getElementById('expenseCheckboxes');
    const clearBtn = document.getElementById('msClear');
    const applyBtn = document.getElementById('msApply');

    const categories = BASE_CATS.filter(c => !['Investments','Credit Card Payment'].includes(c));
    list.innerHTML = categories.map(cat => `
      <div class="ms-item">
        <input type="checkbox" id="chk_${cat}" value="${cat}" class="expense-chk">
        <label for="chk_${cat}" style="cursor:pointer; margin:0; font-weight:400; text-transform:none; color:#333;">${cat}</label>
      </div>
    `).join('');

    btn.onclick = (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); };
    dropdown.onclick = (e) => e.stopPropagation();
    document.addEventListener('click', (e) => { if (!container.contains(e.target)) dropdown.classList.remove('show'); });

    applyBtn.onclick = () => {
      const checkboxes = document.querySelectorAll('.expense-chk');
      selectedExpenseCategories = [];
      checkboxes.forEach(chk => { if (chk.checked) selectedExpenseCategories.push(chk.value); });
      dropdown.classList.remove('show');
      btn.textContent = selectedExpenseCategories.length > 0 ? `${selectedExpenseCategories.length} selected â–¾` : 'Select Categories â–¾';
      renderWalletUnified();
      document.getElementById('resetExpenseDrilldown').classList.remove('hidden');
    };
    clearBtn.onclick = () => {
      document.querySelectorAll('.expense-chk').forEach(chk => chk.checked = false);
      selectedExpenseCategories = [];
      dropdown.classList.remove('show');
      btn.textContent = 'Select Categories â–¾';
      renderWalletUnified();
      document.getElementById('resetExpenseDrilldown').classList.add('hidden');
    };
  }

  function renderWalletUnified() {
    if (typeof Chart === 'undefined') return;
    const mode = document.getElementById('walletMode').value;
    const legendEl = document.getElementById('walletLegend');
    const infoEl = document.getElementById('walletInfo');
    const colors = getColorPalette(12);

    if (mode === 'wallet') {
      document.getElementById('expenseFilterContainer').classList.add('hidden');
      document.getElementById('resetExpenseDrilldown').classList.add('hidden');
      const liquidMethods = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup === 'Cash') || (d.type === 'income') || (d.type === 'expense' && d.category !== 'Investments'));
      const methodBalances = liquidMethods.reduce((acc, curr) => {
        const key = curr.method || 'cash';
        if (key === 'credit_card_payment') return acc;
        const isExpense = curr.type === 'expense' && curr.category !== 'Credit Card Payment';
        const amount = isExpense ? -Number(curr.amount) : Number(curr.amount);
        acc[key] = (acc[key] || 0) + amount;
        return acc;
      }, {});
      const positiveBalances = Object.entries(methodBalances)
        .filter(([key, balance]) => balance > 0 && key !== 'credit_card')
        .map(([key, balance]) => ({ label: methodNames[key] || key, balance }));
      positiveBalances.sort((a,b) => b.balance - a.balance);
      if (donutChart) donutChart.destroy();
      const ctxDonut = document.getElementById('donutChart').getContext('2d');
      donutChart = new Chart(ctxDonut, {
        type: 'doughnut',
        data: {
          labels: positiveBalances.map(b => b.label),
          datasets: [{ data: positiveBalances.map(b => b.balance), backgroundColor: getColorPalette(positiveBalances.length), hoverOffset: 4 }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
      legendEl.innerHTML = positiveBalances.map((b, i) => `
        <div style="display:flex; justify-content:space-between;">
          <div style="display:flex; align-items:center;">
            <span style="width:10px; height:10px; border-radius:50%; background:${colors[i]}; margin-right:10px;"></span>
            ${b.label}
          </div>
          <span style="font-weight:600; color:var(--text-main);">${fmt(b.balance)}</span>
        </div>
      `).join('') || '<div style="text-align:center; padding-top:20px;">No liquid cash accounts with a positive balance.</div>';
      infoEl.innerText = 'Liquid balances by account (positive only).';
    } else {
      document.getElementById('expenseFilterContainer').classList.remove('hidden');
      const filteredData = data.filter(d => {
        if (d.type !== 'expense' || d.category === 'Investments' || d.category === 'Credit Card Payment') return false;
        if (selectedExpenseCategories.length > 0 && !selectedExpenseCategories.includes(d.category)) return false;
        return true;
      });
      const title = selectedExpenseCategories.length > 0 ? `Selected Categories Breakdown` : 'All expenses (Top 10 categories)';
      const expenseMap = filteredData.reduce((acc, curr) => {
        const key = selectedExpenseCategories.length === 1 ? curr.desc.substring(0, 30) : curr.category;
        acc[key] = (acc[key] || 0) + Number(curr.amount);
        return acc;
      }, {});
      const sortedExpenses = Object.entries(expenseMap).sort(([, a], [, b]) => b - a).slice(0, 10);
      const labels = sortedExpenses.map(([key]) => key);
      const amounts = sortedExpenses.map(([, amount]) => amount);
      if (donutChart) donutChart.destroy();
      const ctxExpense = document.getElementById('donutChart').getContext('2d');
      donutChart = new Chart(ctxExpense, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: amounts, backgroundColor: getColorPalette(labels.length), hoverOffset: 4 }] },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
      });
      legendEl.innerHTML = labels.map((lbl, i) => `
        <div style="display:flex; justify-content:space-between;">
          <div style="display:flex; align-items:center;">
            <span style="width:10px; height:10px; border-radius:50%; background:${colors[i]}; margin-right:10px;"></span>
            ${lbl}
          </div>
          <span style="font-weight:600; color:var(--text-main);">${fmt(amounts[i])}</span>
        </div>
      `).join('') || '<div style="text-align:center; padding-top:20px;">No expenses found.</div>';
      infoEl.innerText = title;
    }
  }
  function resetExpenseDrilldown() {
    selectedExpenseCategories = [];
    document.querySelectorAll('.expense-chk').forEach(c => c.checked = false);
    document.getElementById('expenseFilterBtn').textContent = 'Select Categories â–¾';
    document.getElementById('resetExpenseDrilldown').classList.add('hidden');
    renderWalletUnified();
  }

  // ---------- ADVANCED ANALYTICS ----------
  function populateAnalyticsDropdowns() {
    const groupSelect = document.getElementById('anlInvGroup');
    const options = Object.keys(INVESTMENT_STRUCTURE).map(group => `<option value="${group}">${group}</option>`).join('');
    groupSelect.innerHTML = '<option value="">All Groups</option>' + options;
  }
  function updateAnlSubDropdown() {
    const group = document.getElementById('anlInvGroup').value;
    const subSelect = document.getElementById('anlInvSub');
    let options = '<option value="">All Types</option>';
    if(group && INVESTMENT_STRUCTURE[group]) {
      options += Object.keys(INVESTMENT_STRUCTURE[group]).map(sub => `<option value="${sub}">${sub}</option>`).join('');
    }
    subSelect.innerHTML = options;
  }
  let chartNetWorth = null;
  let chartInvTypesModal = null;
  let chartInvGrowthModal = null;
  function renderAdvancedCharts() {
    if (typeof Chart === 'undefined') return;
    const range = document.getElementById('dateFilter').value;
    const chartType = document.getElementById('chartType').value;
    const invGroup = document.getElementById('anlInvGroup').value;
    const invSub = document.getElementById('anlInvSub').value;
    let relevantData = data;
    if (invGroup || invSub) {
      relevantData = data.filter(d => {
        if (invGroup && d.investmentGroup !== invGroup) return false;
        if (invSub && d.investmentSub !== invSub) return false;
        const isInv = (d.type === 'opening_balance' && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments');
        return isInv;
      });
    }
    const { labels, income, expense, investment } = prepareMonthlyData(range === 'all' ? 'all' : Number(range), relevantData);
    const sumAmt = (arr) => arr.reduce((a,b)=>a+Number(b.amount||0),0);
    let initialValue = sumAmt(relevantData.filter(d => d.type === 'opening_balance' && (invGroup ? d.investmentGroup === invGroup : true)));
    let currentValue = initialValue;
    const valueData = labels.map((label, idx) => {
      if(invGroup || invSub) {
        currentValue += (investment[idx] || 0);
      } else {
        const monthIncome = income[idx] || 0;
        const monthExpense = expense[idx] || 0;
        currentValue += (monthIncome - monthExpense);
      }
      return currentValue;
    });
    if (chartNetWorth) chartNetWorth.destroy();
    const ctxNetWorth = document.getElementById('chartNetWorth').getContext('2d');
    chartNetWorth = new Chart(ctxNetWorth, {
      type: chartType,
      data: { labels, datasets: [{ label: (invGroup || invSub) ? 'Cumulative Value (Filtered)' : 'Cumulative Net Worth', data: valueData, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2, fill: chartType === 'line' ? 'start' : false, tension: 0.3 }] },
      options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: false, ticks: { callback: (v)=>fmt(v).replace('â‚¹','â‚¹ ') } } } }
    });
    renderInvestmentAnalytics('modal', relevantData);
  }
  function renderInvestmentAnalytics(scope, dataset) {
    if (typeof Chart === 'undefined') return;
    const invs = dataset.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments' ));
    const byType = invs.reduce((acc,curr) => {
      const key = curr.investmentSub || curr.investmentGroup || 'Uncategorized';
      acc[key] = (acc[key] || 0) + Number(curr.amount);
      return acc;
    }, {});
    const labels = Object.keys(byType).sort((a,b) => byType[b]-byType[a]);
    const values = labels.map(l => byType[l]);
    const points = invs.map(i => ({ date: new Date(i.date), amount: Number(i.amount) })).sort((a,b)=>a.date-b.date);
    let cumulative = 0;
    const growthLabels = points.map(p => p.date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }));
    const growthValues = points.map(p => { cumulative += p.amount; return cumulative; });
    const colors = getColorPalette(labels.length);
    const ctxTypes = document.getElementById('chartInvTypesModal')?.getContext('2d');
    if (ctxTypes) {
      if (chartInvTypesModal) chartInvTypesModal.destroy();
      chartInvTypesModal = new Chart(ctxTypes, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth:1 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position:'right', labels:{boxWidth:10} } }, cutout: '60%' } });
    }
    const ctxGrowth = document.getElementById('chartInvGrowthModal')?.getContext('2d');
    if (ctxGrowth) {
      if (chartInvGrowthModal) chartInvGrowthModal.destroy();
      chartInvGrowthModal = new Chart(ctxGrowth, { type: 'line', data: { labels: growthLabels, datasets: [{ label: 'Invested Amount', data: growthValues, borderColor: '#10b981', tension: 0.3, borderWidth:2, pointRadius:0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display:false } }, scales: { y: { beginAtZero: false, ticks: { callback: (v)=>fmt(v).replace('â‚¹','') } }, x:{ display:false } } } });
    }
  }

  // ---------- SETTINGS ----------
  function renderSettings() {
    const methodContainer = document.getElementById('methodEditor');
    methodContainer.innerHTML = Object.entries(methodNames).map(([key, name]) => `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding:8px; background:#f8fafc; border:1px solid var(--border); border-radius:6px;">
        <input type="text" value="${name}" data-key="${key}" onchange="updateMethodName(this)" style="flex:1; margin-right:10px; border:none; background:transparent; font-weight:500;" />
        <button class="btn-danger" style="padding:4px 8px; font-size:11px" onclick="deleteMethod('${key}')">Remove</button>
      </div>
    `).join('');
    const incomeContainer = document.getElementById('incomeList');
    incomeContainer.innerHTML = incomeSources.map(source => `
      <span style="border:1px solid var(--border); padding:6px 10px; border-radius:6px; font-size:12px; display:inline-flex; align-items:center; background:#f8fafc; margin-bottom:4px;">
        ${source}
        <button style="background:none; border:none; color:var(--danger); margin-left:8px; padding:0; line-height:1; cursor:pointer; font-weight:bold;" onclick="deleteIncome('${source}')">Ã—</button>
      </span>
    `).join('');
    document.getElementById('ccLimitInput').value = settings.ccLimit;
  }
  document.getElementById('addMethod').addEventListener('click', addMethod);
  document.getElementById('addIncomeBtn').addEventListener('click', addIncome);
  document.getElementById('saveCCLimit').addEventListener('click', () => {
    const limit = Number(document.getElementById('ccLimitInput').value);
    if (limit > 0) {
      settings.ccLimit = limit;
      saveAll();
      renderKPIs();
      alert('Credit Card Limit saved.');
    } else {
      alert('Please enter a valid credit card limit.');
    }
  });
  function updateMethodName(el) {
    const key = el.dataset.key;
    const newName = el.value.trim();
    if (newName && key) {
      methodNames[key] = newName;
      saveAll();
      renderAll();
    }
  }
  function deleteMethod(key) {
    if (confirm(`Remove "${methodNames[key]}"?`)) {
      delete methodNames[key];
      saveAll();
      renderAll();
    }
  }
  function addMethod() {
    const input = document.getElementById('newMethod');
    const name = input.value.trim();
    if (name) {
      const key = toKey(name);
      if (!methodNames[key]) {
        methodNames[key] = name;
        input.value = '';
        saveAll();
        renderAll();
      } else {
        alert('Method already exists.');
      }
    }
  }
  function deleteIncome(source) {
    if (confirm(`Remove income source "${source}"?`)) {
      incomeSources = incomeSources.filter(s => s !== source);
      saveAll();
      renderAll();
    }
  }
  function addIncome() {
    const input = document.getElementById('newIncome');
    const source = input.value.trim();
    if (source && !incomeSources.includes(source)) {
      incomeSources.push(source);
      input.value = '';
      saveAll();
      renderAll();
    } else if (source) {
      alert('Income source already exists.');
    }
  }

  // ---------- CSV/JSON IMPORT ----------
  function convertToCSV(data) {
    const headers = ['id', 'type', 'amount', 'date', 'desc', 'category', 'method', 'incomeSource', 'investmentGroup', 'investmentSub', 'insuranceType', 'insuranceFor'];
    const rows = data.map(obj => headers.map(header => {
      let value = obj[header] ?? '';
      if (typeof value === 'string' && value.includes(',')) {
        return `"${value.replace(/"/g, '""')}"`;
      }
      return value;
    }).join(','));
    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'MoneyMirror_Export.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
  function processImportedData() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    if (!file) return alert('Please select a file.');
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      let importedData = [];
      try {
        if (file.name.toLowerCase().endsWith('.json')) {
          importedData = JSON.parse(content);
        } else if (file.name.toLowerCase().endsWith('.csv')) {
          importedData = parseCSV(content);
        } else {
          return alert('Unsupported file type. Use CSV or JSON.');
        }
      } catch (err) {
        return alert('Failed to parse file: ' + err.message);
      }
      if (!Array.isArray(importedData) || importedData.length === 0) return alert('No valid data found.');
      let newEntries = 0;
      importedData.forEach(item => {
        const type = String(item.type || '').toLowerCase();
        const validType = ['income','expense','opening_balance'].includes(type) ? type : 'expense';
        const amt = Number(item.amount);
        const desc = item.desc || item.description || '';
        if (!amt || amt <= 0 || !desc) return;
        const entry = {
          id: item.id || uid(),
          type: validType,
          amount: amt,
          date: item.date || new Date().toISOString().slice(0, 10),
          desc,
          category: item.category || (validType === 'income' ? 'N/A' : 'Misc'),
          method: item.method ? toKey(item.method) : (validType === 'income' ? 'salary_acct' : 'cash'),
          incomeSource: item.incomeSource || item.income_source || '',
          investmentGroup: item.investmentGroup || item.investment_group || '',
          investmentSub: item.investmentSub || item.investment_sub || '',
          insuranceType: item.insuranceType || item.insurance_type || '',
          insuranceFor: item.insuranceFor || item.insurance_for || '',
        };
        data.push(entry);
        newEntries++;
      });
      saveAll();
      renderAll();
      document.getElementById('importModal').classList.remove('open');
      alert(`Imported ${newEntries} entries.`);
    };
    reader.readAsText(file);
  }
  function parseCSV(csvText) {
    const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) return [];
    const headerLine = lines[0];
    const headers = headerLine.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h => h.replace(/"/g, '').trim());
    const lowerHeaders = headers.map(h => h.toLowerCase());
    const dataRows = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
      if (!values) continue;
      const entry = {};
      for (let j = 0; j < lowerHeaders.length; j++) {
        const raw = values[j] || '';
        const value = raw.replace(/^"|"$/g, '').replace(/""/g, '"');
        entry[lowerHeaders[j]] = value;
      }
      dataRows.push({
        id: entry.id,
        type: entry.type,
        amount: entry.amount,
        date: entry.date,
        desc: entry.desc || entry.description,
        category: entry.category,
        method: entry.method,
        incomeSource: entry.incomesource || entry.income_source,
        investmentGroup: entry.investmentgroup || entry.investment_group,
        investmentSub: entry.investmentsub || entry.investment_sub,
        insuranceType: entry.insurancetype || entry.insurance_type,
        insuranceFor: entry.insurancefor || entry.insurance_for,
      });
    }
    return dataRows;
  }

  // ---------- RECENT ENTRIES ----------
  function getBadge(entry) {
    if (entry.type === 'income') return '<span class="badge badge-income">Income</span>';
    if (entry.type === 'opening_balance') return '<span class="badge badge-opening">Opening</span>';
    if (entry.category === 'Investments') return '<span class="badge badge-inv">Invest</span>';
    if (entry.category === 'Insurance') return '<span class="badge badge-ins">Insure</span>';
    if (entry.category === 'Credit Card Payment') return '<span class="badge badge-cc">CC Pay</span>';
    return '<span class="badge badge-expense">Expense</span>';
  }
  function renderRecentEntries() {
    try {
      const tbody = document.querySelector('#recentTable tbody');
      if (!tbody) return;
      const searchEl = document.getElementById('recentSearch');
      const sortEl = document.getElementById('recentSort');
      const catEl = document.getElementById('recentCategory');
      const limitEl = document.getElementById('entryLimit');
      const searchText = (searchEl ? searchEl.value.toLowerCase() : '').trim();
      const sortMode = sortEl ? sortEl.value : 'dateDesc';
      const categoryFilter = catEl ? catEl.value : '';
      const limit = limitEl && limitEl.value !== 'all' ? Number(limitEl.value) : data.length;

      let filtered = data.filter(e => {
        const desc = (e.desc || '').toLowerCase();
        const cat = (e.category || '').toLowerCase();
        const amt = String(e.amount || 0);
        const matchesSearch = !searchText || desc.includes(searchText) || cat.includes(searchText) || amt.includes(searchText);
        const matchesCat = categoryFilter ? e.category === categoryFilter : true;
        return matchesSearch && matchesCat;
      });

      filtered.sort((a, b) => {
        const dateA = new Date(a.date || 0);
        const dateB = new Date(b.date || 0);
        if (sortMode === 'dateDesc') return dateB - dateA;
        if (sortMode === 'dateAsc') return dateA - dateB;
        if (sortMode === 'amtDesc') return b.amount - a.amount;
        if (sortMode === 'amtAsc') return a.amount - b.amount;
        return 0;
      });

      const slice = filtered.slice(0, limit);
      if (slice.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--text-muted);">No transactions found.</td></tr>';
        return;
      }
      tbody.innerHTML = slice.map(e => {
        const amountDisplay = e.type === 'income' || e.type === 'opening_balance'
          ? `<span style="color:var(--success)">+${fmt(e.amount)}</span>`
          : `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;
        let methodDisplay = '';
        if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
          methodDisplay = e.investmentSub || e.investmentGroup;
        } else if (e.type === 'expense' && e.category === 'Investments') {
          methodDisplay = e.investmentSub || e.investmentGroup;
        } else if (e.method === 'credit_card_payment') {
          methodDisplay = 'N/A (Transfer)';
        } else {
          methodDisplay = methodNames[e.method] || e.method || '--';
        }
        let categoryDisplay = e.category === 'Investments' ? e.investmentSub :
                              e.category === 'Insurance' ? `${e.insuranceType} (${e.insuranceFor})` :
                              e.type === 'expense' ? e.category : '--';
        return `
          <tr>
            <td>${getBadge(e)}</td>
            <td>${e.date}</td>
            <td style="font-weight:600; text-align:right">${amountDisplay}</td>
            <td>${e.desc}</td>
            <td>${categoryDisplay}</td>
            <td>${methodDisplay}</td>
            <td class="flex-row">
              <button onclick="loadEdit('${e.id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:4px" title="Edit">âœŽ</button>
              <button onclick="deleteEntry('${e.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:4px" title="Delete">Ã—</button>
            </td>
          </tr>
        `;
      }).join('');
    } catch (err) {
      console.error("Error rendering table:", err);
    }
  }

  // ---------- SAMPLE DATA ----------
  function loadSampleData() {
    if (!confirm("Overwrite existing data with sample?")) return;
    function randBetween(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
    function pick(arr) { return arr[randBetween(0, arr.length - 1)]; }
    function dateInLastMonths(mMin, mMax) {
      const today = new Date();
      const monthDiff = randBetween(mMin, mMax);
      const targetDate = new Date(today);
      targetDate.setMonth(today.getMonth() - monthDiff);
      const maxDays = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
      targetDate.setDate(randBetween(1, maxDays));
      return targetDate.toISOString().slice(0,10);
    }
    data = [];
    methodNames = {...CANONICAL_METHODS};
    incomeSources = ['Salary (Primary)', 'Freelance Income', 'Investment Income'];
    settings = { ...settings, ccLimit: 200000, commodityCountry: settings.commodityCountry || '', trackedMarkets: settings.trackedMarkets || DEFAULT_SETTINGS.trackedMarkets.slice() };

    // Opening cash balances
    data.push({id:uid(), type:'opening_balance', amount: 50000, date: dateInLastMonths(6,6), desc:'Initial Salary Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount: 20000, date: dateInLastMonths(5,6), desc:'Initial Savings Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Savings)', method:'savings_acct', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount: 5000, date: dateInLastMonths(5,6), desc:'Initial Physical Cash', investmentGroup:'Cash', investmentSub:'Cash', method:'cash', category:'N/A'});
    // Opening investments
    data.push({id:uid(), type:'opening_balance', amount: 35000, date: dateInLastMonths(6,6), desc:'Opening â€” Equity MF (Large Cap)', investmentGroup:'Mutual Funds', investmentSub:'Equity MF - Large Cap/Mid Cap/Small Cap', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount: 18000, date: dateInLastMonths(6,6), desc:'Opening â€” NPS Tier 1', investmentGroup:'Retirement Funds', investmentSub:'NPS Tier 1/Tier 2', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount: 12000, date: dateInLastMonths(6,6), desc:'Opening â€” Gold ETF', investmentGroup:'ETFs', investmentSub:'Gold ETF', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount: 25000, date: dateInLastMonths(6,6), desc:'Opening â€” Corporate Bonds', investmentGroup:'Bonds & Debt Instruments', investmentSub:'Corporate Bonds', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount: 8000, date: dateInLastMonths(6,6), desc:'Opening â€” Bitcoin (BTC)', investmentGroup:'Crypto & Digital Assets', investmentSub:'Bitcoin (BTC)', method:'', category:'N/A'});

    // Monthly incomes
    for (let m = 6; m >= 0; m--) {
      const salaryDate = dateInLastMonths(m,m);
      data.push({id:uid(), type:'income', amount: 120000, date: salaryDate, desc:`Salary credit (${salaryDate})`, category:'N/A', method:'salary_acct', incomeSource:'Salary (Primary)'});
      if (Math.random() > 0.6) {
        const freeDate = dateInLastMonths(m,m);
        data.push({id:uid(), type:'income', amount: randBetween(8000, 18000), date: freeDate, desc:`Freelance project (${freeDate})`, category:'N/A', method:'salary_acct', incomeSource:'Freelance Income'});
      }
    }
    const expenseCategories = ['Food','Rent','Utilities','Shopping','Entertainment','Travel','Health','Misc'];
    const methodsPool = ['salary_acct','savings_acct','cash','digital_wallet','credit_card'];
    for (let i = 0; i < 90; i++) {
      const dt = dateInLastMonths(randBetween(0, 6), randBetween(0, 6));
      const cat = pick(expenseCategories);
      const amt = randBetween(300, 9000);
      const method = pick(methodsPool);
      data.push({ id: uid(), type: 'expense', amount: amt, date: dt, desc: `${cat} expense`, category: cat, method });
      if (Math.random() > 0.75) {
        const invGroup = pick(Object.keys(INVESTMENT_STRUCTURE));
        const invSub = pick(Object.keys(INVESTMENT_STRUCTURE[invGroup]));
        data.push({ id: uid(), type: 'expense', amount: randBetween(2000, 15000), date: dt, desc: `Investment â€” ${invSub}`, category: 'Investments', method: pick(['salary_acct','savings_acct']), investmentGroup: invGroup, investmentSub: invSub });
      }
      if (Math.random() > 0.85) {
        data.push({ id: uid(), type: 'expense', amount: randBetween(1500, 6000), date: dt, desc: 'Insurance premium', category: 'Insurance', method: pick(['salary_acct','savings_acct']), insuranceType: pick(['Health','Life']), insuranceFor: pick(['Self','Family']) });
      }
    }
    for (let i = 0; i < 20; i++) {
      const dt = dateInLastMonths(randBetween(0, 6), randBetween(0, 6));
      data.push({ id: uid(), type: 'expense', amount: randBetween(500, 12000), date: dt, desc: 'Credit card spend', category: 'Shopping', method: 'credit_card' });
      if (Math.random() > 0.7) {
        data.push({ id: uid(), type: 'expense', amount: randBetween(3000, 20000), date: dt, desc: 'Credit card payment', category: 'Credit Card Payment', method: 'credit_card_payment' });
      }
    }
    [
      { group: 'Real Estate', sub: 'REITs (Real Estate Investment Trusts)', amount: 40000 },
      { group: 'Mutual Funds', sub: 'Equity MF - ELSS (Tax Saving)', amount: 25000 },
      { group: 'Fixed Income / Savings Schemes', sub: 'FD (Fixed Deposit)', amount: 60000 },
    ].forEach(item => {
      const dt = dateInLastMonths(1,5);
      data.push({ id: uid(), type: 'expense', amount: item.amount, date: dt, desc: `One-off Investment â€” ${item.sub}`, category: 'Investments', method: 'savings_acct', investmentGroup: item.group, investmentSub: item.sub });
    });

    saveAll();
    renderAll();
    alert('Sample data loaded.');
  }

  // ---------- CALCULATOR ----------
  function handleCalculatorInput(e) {
    const key = e.target.innerText;
    const display = document.getElementById('calc-display');
    const preview = document.getElementById('calc-preview');
    if (!display) return;
    if (key === 'AC') { display.textContent = '0'; preview.textContent = 'Enter an expressionâ€¦'; return; }
    if (key === 'Â±' || key === '%') return;
    if (key === '=') {
      try {
        const expr = display.textContent.replace(/\Ã—/g,'*').replace(/\Ã·/g,'/').replace(/-/g,'-');
        const result = Function('"use strict";return ('+expr+')')();
        display.textContent = String(result);
        preview.textContent = fmt(Number(result));
      } catch (err) { preview.textContent = 'Invalid expression'; }
      return;
    }
    const mapped = key === 'Ã—' ? '*' : key === 'Ã·' ? '/' : key === '-' ? '-' : key;
    display.textContent = display.textContent === '0' ? mapped : display.textContent + mapped;
    try {
      const expr = display.textContent.replace(/\Ã—/g,'*').replace(/\Ã·/g,'/').replace(/-/g,'-');
      const result = Function('"use strict";return ('+expr+')')();
      preview.textContent = fmt(Number(result));
    } catch (err) { preview.textContent = ''; }
  }
  function dragElement(elmnt) {
    if (!elmnt) return;
    const header = document.getElementById('calc-header');
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    header.onmousedown = dragMouseDown;
    header.ontouchstart = dragTouchStart;
    function dragMouseDown(e) {
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
    function dragTouchStart(e) {
      const touch = e.touches[0];
      pos3 = touch.clientX;
      pos4 = touch.clientY;
      document.ontouchend = closeDragElement;
      document.ontouchmove = elementTouchDrag;
    }
    function elementTouchDrag(e) {
      e.preventDefault();
      const touch = e.touches[0];
      pos1 = pos3 - touch.clientX;
      pos2 = pos4 - touch.clientY;
      pos3 = touch.clientX;
      pos4 = touch.clientY;
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
  }

  // ---------- MARKET TICKER ----------
  function addIndexToSettings(symbol, name) {
    const exists = settings.trackedMarkets.some(m => m.symbol === symbol);
    if (!exists) {
      settings.trackedMarkets.push({ symbol, name, price: 0, change: 0 });
      saveAll();
    }
  }
  function remapCommoditySymbolsByCountry() {
    const country = settings.commodityCountry || '';
    const map = {
      '':   { gold: 'XAUUSD', silver: 'XAGUSD', goldName: 'Gold/USD', silverName: 'Silver/USD' },
      'IN': { gold: 'XAUINR', silver: 'XAGINR', goldName: 'Gold/INR', silverName: 'Silver/INR' },
      'US': { gold: 'XAUUSD', silver: 'XAGUSD', goldName: 'Gold/USD', silverName: 'Silver/USD' },
      'GB': { gold: 'XAUGBP', silver: 'XAGGBP', goldName: 'Gold/GBP', silverName: 'Silver/GBP' },
      'EU': { gold: 'XAUEUR', silver: 'XAGEUR', goldName: 'Gold/EUR', silverName: 'Silver/EUR' },
      'AE': { gold: 'XAUAED', silver: 'XAGAED', goldName: 'Gold/AED', silverName: 'Silver/AED' }
    };
    const target = map[country] || map[''];
    settings.trackedMarkets = settings.trackedMarkets.map(m => {
      if (m.symbol.startsWith('XAU')) return { ...m, symbol: target.gold, name: target.goldName };
      if (m.symbol.startsWith('XAG')) return { ...m, symbol: target.silver, name: target.silverName };
      return m;
    });
    saveAll();
  }
  function renderMarketList() {
    const ul = document.getElementById('marketList');
    if (!ul) return;
    const items = settings.trackedMarkets.map((m, idx) => `
      <li style="display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border); border-radius:8px; padding:8px;">
        <div style="display:flex; gap:8px; align-items:center;">
          <strong>${m.name}</strong>
          <span style="color:#64748b">(${m.symbol})</span>
          <span style="font-weight:600; color:${(m.change||0)>=0?'#10b981':'#ef4444'}">${(m.change || 0).toFixed(2)}%</span>
        </div>
        <button class="btn-outline" style="padding:4px 8px; font-size:11px" onclick="removeMarket(${idx})">Remove</button>
      </li>
    `).join('');
    ul.innerHTML = items || '<li style="color:#64748b">No markets tracked yet.</li>';
  }
  function removeMarket(index) {
    settings.trackedMarkets.splice(index, 1);
    saveAll();
    renderMarketList();
    renderMarketTicker();
  }
  function renderMarketTicker() {
    const wrap = document.getElementById('tickerWrap');
    if (!wrap) return;
    const items = settings.trackedMarkets.map(m => {
      const price = (m.price || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const change = Number(m.change || 0);
      const changeClass = change >= 0 ? 'change-up' : 'change-down';
      const changeText = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
      return `
        <div class="ticker-item">
          <span class="symbol">${m.symbol}</span>
          <span>${price}</span>
          <span class="${changeClass}" style="margin-left:6px;">${changeText}</span>
        </div>
      `;
    }).join('');
    wrap.innerHTML = items || '<div class="ticker-item">No markets tracked</div>';
  }

  // Real-time data mapping
  const YAHOO_SYMBOL_MAP = {
    'NIFTY_50': '^NSEI',
    'SENSEX': '^BSESN',
    'NASDAQ': '^IXIC',
    'DJI': '^DJI',
    'SPX': '^GSPC',
    'FTSE_100': '^FTSE',
    'DAX': '^GDAXI',
    'CAC_40': '^FCHI',
    'NIKKEI_225': '^N225',
    'HSI': '^HSI',
    // Commodities via futures
    'XAUUSD': 'GC=F',
    'XAGUSD': 'SI=F',
    'XAUINR': 'GC=F',
    'XAGINR': 'SI=F',
    // Crypto
    'BTCUSD': 'BTC-USD'
  };

  // Exponential backoff fetch helper
  function exponentialBackoffFetch(url, maxRetries = 3, delay = 1000) {
    return new Promise((resolve, reject) => {
      const attemptFetch = async (attempt) => {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          resolve(response);
        } catch (error) {
          if (attempt < maxRetries) {
            setTimeout(() => attemptFetch(attempt + 1), delay);
            delay *= 2;
          } else {
            reject(new Error(`Failed after ${maxRetries} attempts: ${error.message}`));
          }
        }
      };
      attemptFetch(0);
    });
  }

  async function fetchRealMarketData() {
    if (!settings.trackedMarkets || settings.trackedMarkets.length === 0) return;

    const updatedMarkets = await Promise.all(settings.trackedMarkets.map(async (market) => {
      const yahooTicker = YAHOO_SYMBOL_MAP[market.symbol] || market.symbol;
      if (!yahooTicker) {
        console.warn(`[Ticker] Skipping unknown symbol: ${market.symbol}`);
        return market;
      }
      try {
        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?interval=1d&range=1d`;
        const proxyUrl = `https://api.allorigins.win/raw?url=` + encodeURIComponent(targetUrl);
        const response = await exponentialBackoffFetch(proxyUrl);
        const data = await response.json();
        const result = data.chart?.result?.[0];
        if (result && result.meta) {
          const price = result.meta.regularMarketPrice;
          const prevClose = result.meta.chartPreviousClose;
          let change = 0;
          if (prevClose && price !== prevClose) {
            change = ((price - prevClose) / prevClose) * 100;
          }
          const updated = {
            ...market,
            price: Number((price || 0).toFixed(2)),
            change: Number((change || 0).toFixed(2))
          };
          return updated;
        } else {
          console.warn(`[Ticker] No market data for ${market.symbol} (${yahooTicker}).`);
        }
      } catch (error) {
        console.error(`[Ticker] Fetch fail for ${market.symbol} (${yahooTicker}):`, error.message);
      }
      return market;
    }));

    settings.trackedMarkets = updatedMarkets;
    renderMarketTicker();
    saveAll(); // persist latest prices for optimistic render on next load
  }

  // Bootstrap loop: immediate + quick retries + settle
  let tickerInterval = null;
  function startTickerRealtimeLoop() {
    if (tickerInterval) clearInterval(tickerInterval);

    // Immediate fetch
    fetchRealMarketData();
    // Quick retries to reduce stale feel post-login
    setTimeout(fetchRealMarketData, 5000);
    setTimeout(fetchRealMarketData, 15000);

    // Settle into 60s cadence
    tickerInterval = setInterval(fetchRealMarketData, 60000);
  }

  // ---------- EXPOSED ----------
  window.loadEdit = loadEdit;
  window.deleteEntry = deleteEntry;
  window.toggleSubMenu = toggleSubMenu;
  window.resetExpenseDrilldown = resetExpenseDrilldown;
  window.removeMarket = removeMarket;
</script>
</body>
</html>
