<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — Dashboard v4.5 (Complex Analytics & Layout Fix)</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444; /* Alert color */
      --border: #cbd5e1;
      --warning: #f97316; /* For Credit Card */
      --opening-balance: #6b21a8; /* Purple for OB */
      --income: #10b981;
      --expense: #ef4444;
      --investment: #14b8a6; /* Teal for Investment inflow/outflow */
      --insurance: #84cc16; /* Lime for Insurance */
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
      font-size: 14px;
    }
    
    /* Global classes */
    .p-4 { padding: 1rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .text-sm { font-size: 0.875rem; }
    .font-semibold { font-weight: 600; }
    .rounded-lg { border-radius: 0.5rem; }
    .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    .flex { display: flex; }
    .justify-between { justify-content: space-between; }
    .items-center { align-items: center; }
    .grid { display: grid; }
    .hidden { display: none !important; }
    .w-full { width: 100%; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-4 { margin-top: 1rem; }

    /* Layout */
    #sidebar {
      width: 250px;
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      flex-shrink: 0;
      transition: transform 0.3s ease;
      z-index: 20;
    }
    #main-content {
      flex-grow: 1;
      transition: filter 0.3s ease;
      padding: 1rem;
    }
    #main-content.blurred {
      filter: blur(4px);
      pointer-events: none;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    /* Sidebar */
    .sidebar-logo {
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .nav-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .nav-item.active {
      color: var(--sidebar-active);
      background-color: rgba(56, 189, 248, 0.1);
      border-left: 4px solid var(--sidebar-active);
    }
    .nav-item i {
      margin-right: 0.75rem;
      font-size: 1.1rem;
    }
    
    /* Cards */
    .card {
      background-color: var(--card-bg);
      padding: 1rem;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .card.kpi {
      grid-column: span 1;
    }
    .card.kpi h4 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .card.kpi .value {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .card.kpi.net-worth {
      background-color: var(--primary);
      color: white;
    }
    .card.kpi.net-worth h4 {
      color: rgba(255, 255, 255, 0.7);
    }

    /* KPI Alert Styles */
    .kpi-net-worth .value { color: var(--success); }
    .kpi-net-worth .value.negative { color: var(--danger); }
    .kpi-expense .value { color: var(--danger); }
    .kpi-income .value { color: var(--success); }
    .kpi-cc-due .value { color: var(--warning); }
    .kpi-cc-due.cc-alert-high { 
      background-color: var(--danger); 
      color: white;
      padding: 0.5rem;
      border-radius: 0.25rem;
    }
    
    /* Charts */
    .chart-container {
      grid-column: span 3;
      height: 350px;
    }
    #wallet-breakdown-card {
      grid-column: span 1;
      height: 350px;
    }
    .chart-box {
      position: relative;
      height: 100%;
      width: 100%;
    }

    /* Transaction Form */
    #transaction-form-container {
      grid-column: span 4;
      margin-top: 1rem;
    }
    #transaction-form-container h3 {
      margin-top: 0;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .form-group input, .form-group select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.25rem;
    }
    .form-actions {
      grid-column: span 4;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      border: none;
    }
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    .btn-secondary {
      background-color: var(--bg-color);
      color: var(--text-main);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background-color: var(--border);
    }
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    /* Data Table */
    #transaction-table-card {
      grid-column: span 4;
      overflow-x: auto;
    }
    #transaction-table-card h3 {
      margin-top: 0;
      margin-bottom: 1rem;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    .data-table th {
      background-color: var(--bg-color);
      font-weight: 600;
      color: var(--text-main);
      font-size: 0.875rem;
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }

    /* List Items in Settings */
    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px dashed var(--border);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 30;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Calculator */
    #calculator {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      width: 280px;
      background-color: var(--card-bg);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border-radius: 0.5rem;
      padding: 0.5rem;
      z-index: 10;
    }
    #calc-screen {
      width: 100%;
      padding: 0.5rem;
      font-size: 2rem;
      text-align: right;
      border: 1px solid var(--border);
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
      background-color: var(--bg-color);
      color: var(--text-main);
    }
    #calc-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    #calculator button {
      padding: 0.75rem;
      font-size: 1.25rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      transition: background-color 0.1s;
      background-color: var(--bg-color);
      color: var(--text-main);
    }
    #calculator button:hover {
      background-color: var(--border);
    }
    #calculator .calc-operator, #calculator .calc-equals {
      background-color: var(--primary);
      color: white;
    }
    #calculator .calc-operator:hover, #calculator .calc-equals:hover {
      background-color: var(--primary-dark);
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
      }
      .card.kpi {
        grid-column: span 1;
      }
      .chart-container {
        grid-column: span 2;
        height: 300px;
      }
      #wallet-breakdown-card {
        grid-column: span 2;
        height: 300px;
      }
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .form-actions {
        grid-column: span 2;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        height: auto;
        transform: translateY(-100%);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 20;
      }
      #sidebar.open {
        transform: translateY(0);
      }
      #main-content {
        padding-top: 5rem; /* Space for hidden header/toggle */
      }
      .header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: white;
        padding: 0.5rem 1rem;
        z-index: 15;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .grid-container {
        grid-template-columns: 1fr;
      }
      .card.kpi, .chart-container, #wallet-breakdown-card, #transaction-form-container, #transaction-table-card {
        grid-column: span 1;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .form-actions {
        grid-column: span 1;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

  <div id="profileModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>Welcome to MoneyMirror v4.5</h2>
      <p>Please select an existing profile or create a new one to continue.</p>
      <div class="form-group">
        <label for="profile-select">Select Profile</label>
        <select id="profile-select" class="w-full">
          </select>
      </div>
      <div class="form-group mt-4">
        <label for="new-profile-name">New Profile Name</label>
        <input type="text" id="new-profile-name" placeholder="Enter new profile name" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="btn btn-secondary" onclick="loadSampleDataAndInit()">Load Sample Data</button>
        <button class="btn btn-primary" onclick="handleProfileSelection()">Load/Create Profile</button>
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div class="sidebar-logo">MoneyMirror</div>
    <nav class="py-4">
      <div class="nav-item active" data-view="dashboard">
        <i class="fas fa-home"></i> Dashboard
      </div>
      <div class="nav-item" data-view="transactions">
        <i class="fas fa-exchange-alt"></i> Transactions
      </div>
      <div class="nav-item" data-view="analytics">
        <i class="fas fa-chart-line"></i> Advanced Analytics
      </div>
      <div class="nav-item" data-view="settings">
        <i class="fas fa-cogs"></i> Settings
      </div>
    </nav>
  </div>

  <div id="main-content" class="blurred">
    <div class="header">
      <h2 id="current-profile-name"></h2>
      <button class="btn btn-secondary" id="calc-toggle">
        <i class="fas fa-calculator"></i>
      </button>
    </div>

    <div id="view-dashboard" class="grid-container">
      
      <div class="card kpi net-worth" id="kpi-net-worth">
        <h4>NET WORTH</h4>
        <div class="value">₹0</div>
        <p class="text-sm font-semibold text-white mt-1">Cash + Assets - Liabilities</p>
      </div>
      <div class="card kpi kpi-income" id="kpi-income">
        <h4>MONTHLY INCOME</h4>
        <div class="value">₹0</div>
        <p class="text-sm text-muted mt-1">All Inflow (Excl. OB)</p>
      </div>
      <div class="card kpi kpi-expense" id="kpi-expense">
        <h4>MONTHLY EXPENSE</h4>
        <div class="value">₹0</div>
        <p class="text-sm text-muted mt-1">All Outflow (Excl. Inv.)</p>
      </div>
      <div class="card kpi kpi-cc-due" id="kpi-cc-due">
        <h4>CREDIT CARD DUE</h4>
        <div class="value">₹0</div>
        <p class="text-sm text-muted mt-1" id="cc-limit-text">Limit: ₹13,000</p>
      </div>
      
      <div class="card chart-container">
        <h3>Cash Flow & Investments (Last 6 Months)</h3>
        <div class="chart-box">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
      
      <div class="card" id="wallet-breakdown-card">
        <h3>Wallet Breakdown (Liquid Cash)</h3>
        <div class="chart-box">
          <canvas id="walletChart"></canvas>
        </div>
      </div>

    </div>
    
    <div id="view-transactions" class="grid-container hidden">
      
      <div class="card" id="transaction-form-container">
        <h3>Add New Transaction</h3>
        <form id="transaction-entry-form">
          <div class="form-grid">
            
            <div class="form-group">
              <label for="type">Type</label>
              <select id="type" required>
                <option value="expense">Expense</option>
                <option value="income">Income</option>
                <option value="investment">Investment</option>
                <option value="insurance">Insurance</option>
                <option value="opening_balance">Opening Balance</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="amount">Amount (₹)</label>
              <input type="number" id="amount" step="0.01" required min="0.01" />
            </div>
            
            <div class="form-group">
              <label for="date">Date</label>
              <input type="date" id="date" required />
            </div>
            
            <div class="form-group">
              <label for="method">Payment Method</label>
              <select id="method" required>
                </select>
            </div>

            <div class="form-group" id="category-group">
              <label for="category">Category</label>
              <select id="category" required>
                </select>
            </div>

            <div class="form-group hidden" id="investment-group-group">
              <label for="investmentGroup">Group</label>
              <select id="investmentGroup">
                <option value="stocks">Stocks</option>
                <option value="mf">Mutual Funds</option>
                <option value="gold">Gold</option>
              </select>
            </div>

            <div class="form-group hidden" id="investment-sub-group">
              <label for="investmentSub">Sub-Group</label>
              <input type="text" id="investmentSub" placeholder="e.g. Reliance" />
            </div>

            <div class="form-group hidden" id="insurance-type-group">
              <label for="insuranceType">Insurance Type</label>
              <select id="insuranceType">
                <option value="health">Health</option>
                <option value="life">Life</option>
                <option value="vehicle">Vehicle</option>
              </select>
            </div>

            <div class="form-group hidden" id="insurance-for-group">
              <label for="insuranceFor">Insured For</label>
              <input type="text" id="insuranceFor" placeholder="e.g. Self/Car" />
            </div>
            
            <div class="form-group">
              <label for="description">Description</label>
              <input type="text" id="description" placeholder="e.g. Dinner with friends" required />
            </div>
            
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Transaction</button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('transaction-entry-form').reset();">Clear Form</button>
          </div>
        </form>
      </div>

      <div class="card" id="transaction-table-card">
        <h3>Recent Transactions</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Amount (₹)</th>
              <th>Method</th>
              <th>Category/Group</th>
              <th>Description</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="transaction-list">
            </tbody>
        </table>
      </div>

    </div>

    <div id="view-analytics" class="grid-container hidden">
      <div class="card chart-container" style="grid-column: span 4;">
        <h3>Cumulative Net Worth (Historical Cost)</h3>
        <div class="chart-box">
          <canvas id="cumulativeNetWorthChart"></canvas>
        </div>
      </div>
      <div class="card chart-container" style="grid-column: span 4;">
        <h3>Yearly Category Breakdown (Expenses) - Click to drilldown</h3>
        <div class="chart-box">
          <canvas id="yearlyCategoryChart"></canvas>
        </div>
      </div>
    </div>
    
    <div id="view-settings" class="grid-container hidden">
      <div class="card" style="grid-column: span 2;">
        <h3>Profile Management</h3>
        <button class="btn btn-secondary mt-2 w-full" onclick="showProfileModal()">Change Profile</button>
        <button class="btn btn-danger mt-2 w-full" onclick="confirmDeleteProfile()">Delete Current Profile</button>
      </div>
      <div class="card" style="grid-column: span 2;">
        <h3>Data Management</h3>
        <input type="file" id="import-file" accept=".json, .csv" class="mt-2 w-full"/>
        <select id="import-mode" class="mt-2 p-2 w-full">
          <option value="replace">Replace All Data</option>
          <option value="append">Append to Existing Data</option>
        </select>
        <button class="btn btn-primary mt-2 w-full" onclick="handleImport()">Import Data</button>
        <button class="btn btn-secondary mt-2 w-full" onclick="exportData('json')">Export Data (JSON)</button>
        <button class="btn btn-secondary mt-2 w-full" onclick="exportData('csv')">Export Data (CSV)</button>
      </div>
      
      <div class="card" style="grid-column: span 4;">
        <h3>Configuration</h3>
        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
          <div class="form-group">
            <label for="cc-limit">Credit Card Limit (₹)</label>
            <input type="number" id="cc-limit" step="1000" min="1000" />
          </div>
          <div class="form-group">
            <label for="default-currency">Default Currency Symbol</label>
            <input type="text" id="default-currency" value="₹" maxlength="3" />
          </div>
        </div>
        <button class="btn btn-primary mt-2 w-full" onclick="saveConfiguration()">Save Config</button>
      </div>

      <div class="card" style="grid-column: span 2;">
        <h3>Payment Methods</h3>
        <div id="payment-method-list">
          </div>
        <div class="flex mt-2 gap-2">
            <input type="text" id="new-method-name" placeholder="Method Name" class="p-2 flex-grow"/>
            <select id="new-method-type" class="p-2">
                <option value="liquid">Liquid</option>
                <option value="credit">Credit</option>
            </select>
            <button class="btn btn-primary" onclick="addMethod()">Add</button>
        </div>
      </div>

      <div class="card" style="grid-column: span 2;">
        <h3>Expense/Income Categories</h3>
        <div id="category-list">
          </div>
        <div class="flex mt-2 gap-2">
            <input type="text" id="new-category-name" placeholder="Category Name" class="p-2 flex-grow"/>
            <button class="btn btn-primary" onclick="addCategory()">Add</button>
        </div>
      </div>

    </div>

  </div>

  <div id="calculator" class="hidden">
    <input type="text" id="calc-screen" value="0" readonly />
    <div id="calc-buttons">
      <button class="calc-clear">AC</button>
      <button>←</button>
      <button class="calc-operator">÷</button>
      <button class="calc-operator">×</button>

      <button>7</button>
      <button>8</button>
      <button>9</button>
      <button class="calc-operator">-</button>

      <button>4</button>
      <button>5</button>
      <button>6</button>
      <button class="calc-operator">+</button>

      <button style="grid-column: span 2;">0</button>
      <button>.</button>
      <button class="calc-equals">=</button>
    </div>
  </div>


  <script>
    // --- GLOBAL STATE & CONFIGURATION ---
    const CONFIG_KEY = 'mm_v4_config';
    const PROFILE_KEY = 'mm_v4_profiles';

    let currentProfile = null;
    let data = {
      transactions: [],
      methods: [],
      categories: [],
      config: {
        ccLimit: 13000,
        currencySymbol: '₹'
      }
    };
    let charts = {};
    let currentView = 'dashboard';
    const views = ['dashboard', 'transactions', 'analytics', 'settings'];

    // --- UTILITY FUNCTIONS ---

    function getColorPalette(count) {
        const colors = [
            '#3b82f6', // primary blue
            '#ef4444', // danger red
            '#10b981', // success green
            '#f97316', // warning orange
            '#6b21a8', // purple
            '#0ea5e9', // light blue
            '#f59e0b', // amber
            '#84cc16', // lime
            '#14b8a6', // teal
            '#d946ef'  // fuchsia
        ];
        return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
    }

    function formatCurrency(amount) {
      if (amount === undefined || amount === null) return `${data.config.currencySymbol}0`;
      return `${data.config.currencySymbol}${Math.round(amount).toLocaleString('en-IN')}`;
    }

    function generateUniqueId() {
        return 'id_' + Math.random().toString(36).substring(2, 9);
    }

    function saveState() {
      if (currentProfile) {
        let profiles = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
        profiles[currentProfile] = data;
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profiles));
      }
      localStorage.setItem(CONFIG_KEY, JSON.stringify(data.config));
    }

    function loadState(profileName) {
      const config = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
      data.config = { ...data.config, ...config };
      
      const profiles = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
      if (profiles[profileName]) {
        data = profiles[profileName];
        currentProfile = profileName;
        return true;
      }
      return false;
    }

    function initializeProfiles() {
      const profiles = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
      const select = document.getElementById('profile-select');
      select.innerHTML = '';
      let hasProfiles = false;
      for (const name in profiles) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
        hasProfiles = true;
      }
      if (!hasProfiles) {
         select.innerHTML = '<option value="" disabled selected>No profiles found</option>';
      } else {
         // Add a placeholder option if profiles exist but none are selected
         const placeholder = document.createElement('option');
         placeholder.value = '';
         placeholder.textContent = '-- Select an existing profile --';
         placeholder.disabled = true;
         placeholder.selected = true;
         select.prepend(placeholder);
      }

      // Check for a 'last_used' profile
      const lastProfile = localStorage.getItem('mm_v4_last_profile');
      if (lastProfile && profiles[lastProfile]) {
        select.value = lastProfile;
        handleProfileSelection(lastProfile);
      } else {
        showProfileModal();
      }
    }

    function showProfileModal() {
      document.getElementById('profileModal').classList.remove('hidden');
      document.getElementById('main-content').classList.add('blurred');
      initializeProfiles();
    }

    function hideProfileModal() {
      document.getElementById('profileModal').classList.add('hidden');
      document.getElementById('main-content').classList.remove('blurred');
    }

    function handleProfileSelection(profileNameFromLoad) {
      const select = document.getElementById('profile-select');
      const newNameInput = document.getElementById('new-profile-name');
      
      let profileName = profileNameFromLoad || select.value;
      const newProfileName = newNameInput.value.trim();

      if (newProfileName) {
        profileName = newProfileName;
        // Create new profile with default data
        data = getDefaultData(); 
      } else if (!profileName) {
        alert("Please select or enter a profile name.");
        return;
      }

      if (loadState(profileName)) {
        // Loaded existing profile
      } else if (newProfileName) {
        // Created new profile (data is already default)
      } else {
        alert("Profile not found. Please create a new one or select an existing one.");
        return;
      }

      currentProfile = profileName;
      localStorage.setItem('mm_v4_last_profile', currentProfile);
      
      initApplication();
      hideProfileModal();
    }

    function confirmDeleteProfile() {
        if (!currentProfile) {
            alert("No profile is currently loaded.");
            return;
        }
        if (confirm(`Are you sure you want to delete the profile "${currentProfile}" and ALL its data? This action is permanent.`)) {
            let profiles = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
            delete profiles[currentProfile];
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profiles));
            localStorage.removeItem('mm_v4_last_profile');

            currentProfile = null;
            data = getDefaultData(); // Reset data to defaults
            alert(`Profile "${currentProfile}" deleted.`);
            showProfileModal();
        }
    }

    function getDefaultData() {
        return {
          transactions: [],
          methods: [
            { id: generateUniqueId(), name: 'Bank A (Checking)', type: 'liquid', balance: 0 },
            { id: generateUniqueId(), name: 'Bank B (Savings)', type: 'liquid', balance: 0 },
            { id: generateUniqueId(), name: 'Physical Cash', type: 'liquid', balance: 0 },
            { id: generateUniqueId(), name: 'Credit Card', type: 'credit', balance: 0 },
          ],
          categories: [
            'Groceries', 'Rent/EMI', 'Transportation', 'Utilities', 'Entertainment', 'Healthcare', 'Salary', 'Freelance', 'Other Income', 'CC Payment'
          ],
          config: data.config // Keep the current config
        };
    }
    
    function loadSampleDataAndInit() {
      data = getDefaultData();
      data.transactions = [
        { id: Date.now() - 100000, type: 'opening_balance', amount: 50000, date: '2024-01-01', method: data.methods[0].id, category: 'Opening Balance', description: 'Initial balance', timestamp: Date.now() - 100000 },
        { id: Date.now() - 90000, type: 'income', amount: 80000, date: '2024-05-01', method: data.methods[0].id, category: 'Salary', description: 'May Salary', timestamp: Date.now() - 90000 },
        { id: Date.now() - 80000, type: 'expense', amount: 15000, date: '2024-05-05', method: data.methods[0].id, category: 'Rent/EMI', description: 'Rent Payment', timestamp: Date.now() - 80000 },
        { id: Date.now() - 70000, type: 'expense', amount: 500, date: '2024-05-10', method: data.methods[2].id, category: 'Transportation', description: 'Bus Fare', timestamp: Date.now() - 70000 },
        { id: Date.now() - 60000, type: 'expense', amount: 3000, date: '2024-05-15', method: data.methods[3].id, category: 'Groceries', description: 'Supermarket shopping', timestamp: Date.now() - 60000 },
        { id: Date.now() - 50000, type: 'expense', amount: 10000, date: '2024-05-20', method: data.methods[0].id, category: 'CC Payment', description: 'Credit Card Bill Payment', timestamp: Date.now() - 50000, isCCPayment: true },
        { id: Date.now() - 40000, type: 'investment', amount: 5000, date: '2024-06-01', method: data.methods[0].id, investmentGroup: 'mf', investmentSub: 'Axis Bluechip', description: 'SIP June', timestamp: Date.now() - 40000 },
        { id: Date.now() - 30000, type: 'expense', amount: 8000, date: '2024-06-05', method: data.methods[3].id, category: 'Entertainment', description: 'Concert Tickets', timestamp: Date.now() - 30000 },
      ];
      currentProfile = 'SampleDataProfile';
      localStorage.setItem('mm_v4_last_profile', currentProfile);
      saveState(); // Save the sample data
      initApplication();
      hideProfileModal();
    }

    // --- CALCULATION LOGIC ---

    function calculateKPIs() {
      let netWorth = 0;
      let monthlyIncome = 0;
      let monthlyExpense = 0;
      let creditCardDue = 0;
      
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      // Reset liquid method balances for recalculation
      data.methods.forEach(m => {
        if (m.type === 'liquid') {
            m.balance = 0;
        }
        // Only reset the CC debt tracker for the KPI
        if (m.type === 'credit' && m.name.toLowerCase().includes('credit card')) {
            creditCardDue = 0;
        }
      });
      
      // 1. Calculate Balances and Net Worth
      data.transactions
        .sort((a, b) => a.timestamp - b.timestamp) // Process chronologically for running balance
        .forEach(t => {
          const sign = ['income', 'opening_balance'].includes(t.type) ? 1 : -1;
          const isExpense = t.type === 'expense';
          const isInvestment = t.type === 'investment';
          const isInsurance = t.type === 'insurance';

          // Net Worth calculation (Historical Cost Basis)
          // Add income, opening balance; Subtract all expenses, investments, insurance
          if (sign === 1) {
            netWorth += t.amount;
          } else if (isExpense || isInvestment || isInsurance) {
            netWorth -= t.amount;
          }

          // Balance Calculation & CC Due Tracking
          const method = data.methods.find(m => m.id === t.method);
          if (method) {
            if (method.type === 'liquid') {
              method.balance += t.amount * sign;
            } else if (method.type === 'credit' && method.name.toLowerCase().includes('credit card')) {
              if (isExpense && !t.isCCPayment) {
                // Expense on CC increases CC Due
                creditCardDue += t.amount;
              } else if (isExpense && t.isCCPayment) {
                // CC Payment decreases CC Due
                creditCardDue -= t.amount;
              }
            }
          }
        });

      // 2. Calculate Monthly KPIs (Current Month only)
      data.transactions.filter(t => {
          const tDate = new Date(t.date);
          return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
      }).forEach(t => {
          if (t.type === 'income') {
              monthlyIncome += t.amount;
          } else if (t.type === 'expense' && t.category !== 'CC Payment') {
              monthlyExpense += t.amount;
          }
      });
      
      // 3. Update UI
      const netWorthElement = document.querySelector('#kpi-net-worth .value');
      netWorthElement.textContent = formatCurrency(netWorth);
      netWorthElement.classList.toggle('negative', netWorth < 0);
      
      document.querySelector('#kpi-income .value').textContent = formatCurrency(monthlyIncome);
      document.querySelector('#kpi-expense .value').textContent = formatCurrency(monthlyExpense);
      
      const ccDueElement = document.querySelector('#kpi-cc-due');
      const ccDueValueElement = ccDueElement.querySelector('.value');
      ccDueValueElement.textContent = formatCurrency(creditCardDue);

      // CC Limit Alert
      ccDueElement.classList.remove('cc-alert-high');
      ccDueElement.querySelector('h4').textContent = 'CREDIT CARD DUE';
      if (creditCardDue > data.config.ccLimit) {
          ccDueElement.classList.add('cc-alert-high');
          ccDueElement.querySelector('h4').textContent = 'CC LIMIT EXCEEDED!';
      }
      document.getElementById('cc-limit-text').textContent = `Limit: ${formatCurrency(data.config.ccLimit)}`;

      saveState(); // Save balances back to methods
      renderCharts(); // Render primary dashboard charts
    }

    // --- CHARTING LOGIC ---

    function calculateMonthlyData(transactions, filterDuration = 6) {
      const monthlyData = {};
      const today = new Date();
      let currentDate = new Date(today.getFullYear(), today.getMonth() - filterDuration + 1, 1);
      
      while (currentDate <= today) {
        const monthYearKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        const monthName = currentDate.toLocaleString('default', { month: 'short' });
        const year = currentDate.getFullYear().toString().slice(-2);
        const label = `${monthName} '${year}`;
        
        monthlyData[monthYearKey] = {
          label: label,
          income: 0,
          expense: 0,
          investment: 0
        };

        currentDate.setMonth(currentDate.getMonth() + 1);
      }

      transactions.forEach(t => {
        const tDate = new Date(t.date);
        const monthYearKey = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;
        
        if (monthlyData[monthYearKey]) {
          if (t.type === 'income' || t.type === 'opening_balance') {
            monthlyData[monthYearKey].income += t.amount;
          } else if (t.type === 'expense' || t.type === 'insurance') {
            monthlyData[monthYearKey].expense += t.amount;
          } else if (t.type === 'investment') {
            monthlyData[monthYearKey].investment += t.amount;
          }
        }
      });
      
      const labels = Object.values(monthlyData).map(d => d.label);
      const incomeData = Object.values(monthlyData).map(d => d.income);
      const expenseData = Object.values(monthlyData).map(d => d.expense);
      const investmentData = Object.values(monthlyData).map(d => d.investment);

      return { labels, incomeData, expenseData, investmentData };
    }

    function calculateNetLiquidity(transactions) {
      // Use method balance data saved by calculateKPIs
      const liquidMethods = data.methods.filter(m => m.type === 'liquid');
      
      const labels = [];
      const dataPoints = [];
      
      liquidMethods.forEach(m => {
          if (m.balance !== 0) {
              labels.push(m.name);
              dataPoints.push(Math.round(m.balance));
          }
      });

      return { labels, data: dataPoints };
    }
    
    // --- Dashboard Charts (Monthly Flow and Wallet) ---
    function renderCharts() {
      // 1. Monthly Bar Chart (Cash Flow & Investments)
      const monthlyData = calculateMonthlyData(data.transactions, 6);
      const monthlyChartCtx = document.getElementById('monthlyChart').getContext('2d');
      if (charts.monthlyChart) charts.monthlyChart.destroy();
      charts.monthlyChart = new Chart(monthlyChartCtx, {
        type: 'bar',
        data: {
          labels: monthlyData.labels,
          datasets: [
            {
              label: 'Income',
              data: monthlyData.incomeData,
              backgroundColor: '#10b981', // FIX: Used hex color
            },
            {
              label: 'Expense & Insurance',
              data: monthlyData.expenseData,
              backgroundColor: '#ef4444', // FIX: Used hex color
            },
            {
              label: 'Investment',
              data: monthlyData.investmentData,
              backgroundColor: '#14b8a6', // FIX: Used hex color
            },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: { beginAtZero: true }
          }
        }
      });
      
      // 2. Wallet Breakdown Pie Chart (Liquid Cash)
      const liquidData = calculateNetLiquidity(data.transactions);
      const walletChartCtx = document.getElementById('walletChart').getContext('2d');
      if (charts.walletChart) charts.walletChart.destroy();

      charts.walletChart = new Chart(walletChartCtx, {
        type: 'doughnut',
        data: {
          labels: liquidData.labels,
          datasets: [{
            data: liquidData.data,
            backgroundColor: getColorPalette(liquidData.labels.length),
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
    }

    // --- Advanced Analytics Charts ---

    function calculateCumulativeNetWorth(transactions) {
        transactions.sort((a, b) => new Date(a.date) - new Date(b.date) || a.timestamp - b.timestamp);
        let cumulativeNetWorth = 0;
        const netWorthHistory = [];
        const labels = [];
        
        transactions.forEach(t => {
            const sign = ['income', 'opening_balance'].includes(t.type) ? 1 : -1;
            const isExpense = t.type === 'expense';
            const isInvestment = t.type === 'investment';
            const isInsurance = t.type === 'insurance';

            if (sign === 1) {
                cumulativeNetWorth += t.amount;
            } else if (isExpense || isInvestment || isInsurance) {
                cumulativeNetWorth -= t.amount;
            }

            // Only plot points where the value changes or at the end of a date
            if (labels.length === 0 || labels[labels.length - 1] !== t.date) {
                labels.push(t.date);
                netWorthHistory.push(cumulativeNetWorth);
            } else {
                netWorthHistory[netWorthHistory.length - 1] = cumulativeNetWorth;
            }
        });

        return { labels, data: netWorthHistory };
    }

    function calculateYearlyCategoryData(transactions) {
        const yearlyData = {};
        const expenseTransactions = transactions.filter(t => t.type === 'expense' && t.category !== 'CC Payment');
        
        expenseTransactions.forEach(t => {
            const year = new Date(t.date).getFullYear();
            if (!yearlyData[year]) yearlyData[year] = {};
            
            const category = t.category;
            yearlyData[year][category] = (yearlyData[year][category] || 0) + t.amount;
        });
        
        return yearlyData;
    }

    function renderYearlyCategoryChart(yearlyData) {
        const currentYear = new Date().getFullYear();
        const yearData = yearlyData[currentYear] || {};
        
        const labels = Object.keys(yearData);
        const dataPoints = Object.values(yearData);
        
        const yearlyCtx = document.getElementById('yearlyCategoryChart').getContext('2d');
        if (charts.yearlyCategoryChart) charts.yearlyCategoryChart.destroy();
        
        charts.yearlyCategoryChart = new Chart(yearlyCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: dataPoints,
                    backgroundColor: getColorPalette(labels.length),
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: `Yearly Expense Breakdown (${currentYear})` }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const category = labels[index];
                        alert(`Drilldown: Showing all transactions for ${category} in ${currentYear}`);
                        // In a production app, this would filter the transaction table
                        switchView('transactions'); 
                    }
                }
            }
        });
    }

    function renderAdvancedCharts() {
        if (currentView !== 'analytics') return;
        
        // 1. Cumulative Net Worth (Historical Cost)
        const cumulativeData = calculateCumulativeNetWorth(data.transactions);
        const cumulativeCtx = document.getElementById('cumulativeNetWorthChart').getContext('2d');
        if (charts.cumulativeNetWorthChart) charts.cumulativeNetWorthChart.destroy();
        charts.cumulativeNetWorthChart = new Chart(cumulativeCtx, {
            type: 'line',
            data: {
                labels: cumulativeData.labels,
                datasets: [{
                    label: 'Net Worth',
                    data: cumulativeData.data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'day', tooltipFormat: 'MMM D, YYYY' },
                        title: { display: true, text: 'Date' }
                    },
                    y: { 
                        beginAtZero: false,
                        title: { display: true, text: 'Net Worth' } 
                    }
                }
            }
        });

        // 2. Yearly Category Breakdown (Expense Drilldown)
        const yearlyData = calculateYearlyCategoryData(data.transactions);
        renderYearlyCategoryChart(yearlyData);
    }

    // --- TRANSACTION & FORM HANDLING ---
    
    function populateFormOptions() {
      // 1. Payment Methods
      const methodSelect = document.getElementById('method');
      methodSelect.innerHTML = '';
      data.methods.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = m.name;
        methodSelect.appendChild(option);
      });
      
      // 2. Categories
      const categorySelect = document.getElementById('category');
      categorySelect.innerHTML = '';
      data.categories.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        categorySelect.appendChild(option);
      });
      
      // Set today's date
      document.getElementById('date').valueAsDate = new Date();
    }
    
    function handleTypeChange() {
      const type = document.getElementById('type').value;
      
      // Hide all dynamic groups
      document.getElementById('category-group').classList.add('hidden');
      document.getElementById('investment-group-group').classList.add('hidden');
      document.getElementById('investment-sub-group').classList.add('hidden');
      document.getElementById('insurance-type-group').classList.add('hidden');
      document.getElementById('insurance-for-group').classList.add('hidden');
      
      // Show required groups
      if (type === 'expense' || type === 'income') {
        document.getElementById('category-group').classList.remove('hidden');
      } else if (type === 'investment') {
        document.getElementById('investment-group-group').classList.remove('hidden');
        document.getElementById('investment-sub-group').classList.remove('hidden');
      } else if (type === 'insurance') {
        document.getElementById('insurance-type-group').classList.remove('hidden');
        document.getElementById('insurance-for-group').classList.remove('hidden');
      }
      
      // Opening Balance is simple, only needs amount, date, method, description
      if (type === 'opening_balance') {
        // Ensure a liquid method is selected by default
        const liquidMethod = data.methods.find(m => m.type === 'liquid');
        if (liquidMethod) {
            document.getElementById('method').value = liquidMethod.id;
        }
      }
    }

    document.getElementById('type').addEventListener('change', handleTypeChange);
    
    document.getElementById('transaction-entry-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const type = document.getElementById('type').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const date = document.getElementById('date').value;
      const method = document.getElementById('method').value;
      const description = document.getElementById('description').value;

      if (amount <= 0 || isNaN(amount)) {
          alert("Amount must be a number greater than zero.");
          return;
      }
      
      const newTransaction = {
        id: Date.now(),
        type,
        amount,
        date,
        method,
        description,
        timestamp: Date.now()
      };
      
      if (type === 'expense' || type === 'income') {
        const category = document.getElementById('category').value;
        if (!category) { alert("Please select a category."); return; }
        newTransaction.category = category;
        if (category === 'CC Payment') {
            newTransaction.isCCPayment = true;
        }
      } else if (type === 'investment') {
        newTransaction.investmentGroup = document.getElementById('investmentGroup').value;
        newTransaction.investmentSub = document.getElementById('investmentSub').value;
      } else if (type === 'insurance') {
        newTransaction.insuranceType = document.getElementById('insuranceType').value;
        newTransaction.insuranceFor = document.getElementById('insuranceFor').value;
      } else if (type === 'opening_balance') {
        newTransaction.category = 'Opening Balance';
      }

      data.transactions.push(newTransaction);
      
      // Reset the form and re-render everything
      document.getElementById('transaction-entry-form').reset();
      handleTypeChange(); // Reset dynamic fields
      updateDashboard();
      
      // Switch back to the transactions view to see the new entry
      switchView('transactions');
    });

    function renderTransactionTable() {
      const tableBody = document.getElementById('transaction-list');
      tableBody.innerHTML = '';
      
      // Sort by date, then timestamp (newest first)
      const sortedTransactions = data.transactions.sort((a, b) => 
          new Date(b.date) - new Date(a.date) || b.timestamp - a.timestamp
      ).slice(0, 50); // Show only the last 50 transactions

      if (sortedTransactions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No transactions recorded.</td></tr>';
        return;
      }
      
      sortedTransactions.forEach(t => {
        const row = tableBody.insertRow();
        
        let categoryOrGroup = t.category || t.investmentGroup || t.insuranceType || 'N/A';
        if (t.investmentSub) categoryOrGroup += ` (${t.investmentSub})`;
        if (t.insuranceFor) categoryOrGroup += ` (${t.insuranceFor})`;
        
        const method = data.methods.find(m => m.id === t.method)?.name || 'N/A';
        
        row.innerHTML = `
          <td>${t.date}</td>
          <td><span class="text-sm font-semibold" style="color: var(--${t.type.toLowerCase().replace('_', '-')})">${t.type.toUpperCase().replace('_', ' ')}</span></td>
          <td>${formatCurrency(t.amount)}</td>
          <td>${method}</td>
          <td>${categoryOrGroup}</td>
          <td>${t.description}</td>
          <td><button class="btn btn-secondary text-sm" onclick="deleteTransaction(${t.id})">Delete</button></td>
        `;
      });
    }

    function deleteTransaction(id) {
      if (confirm("Are you sure you want to delete this transaction? This action cannot be undone.")) {
        data.transactions = data.transactions.filter(t => t.id !== id);
        updateDashboard();
        renderTransactionTable();
      }
    }
    
    // --- VIEW MANAGEMENT ---
    
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.getAttribute('data-view');
        switchView(view);
      });
    });

    function switchView(viewName) {
      currentView = viewName;
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.getAttribute('data-view') === viewName);
      });
      views.forEach(view => {
        document.getElementById(`view-${view}`).classList.toggle('hidden', view !== viewName);
      });
      
      if (viewName === 'transactions') {
        renderTransactionTable();
        handleTypeChange(); // Ensure form groups are correct on switch
      } else if (viewName === 'analytics') {
        renderAdvancedCharts();
      } else if (viewName === 'settings') {
        renderSettingsData();
      }
    }
    
    // --- SETTINGS & CONFIGURATION ---

    function saveConfiguration() {
      const ccLimit = parseFloat(document.getElementById('cc-limit').value);
      const currencySymbol = document.getElementById('default-currency').value;

      if (isNaN(ccLimit) || ccLimit < 1000) {
        alert("Credit Card Limit must be a valid number greater than or equal to 1000.");
        return;
      }
      
      data.config.ccLimit = ccLimit;
      data.config.currencySymbol = currencySymbol;
      
      saveState();
      updateDashboard();
      alert("Configuration saved successfully!");
    }

    function renderConfiguration() {
      document.getElementById('cc-limit').value = data.config.ccLimit;
      document.getElementById('default-currency').value = data.config.currencySymbol;
    }

    function renderSettingsData() {
        renderConfiguration();
        
        // 1. Render Payment Methods
        const methodList = document.getElementById('payment-method-list');
        methodList.innerHTML = '';
        data.methods.forEach(m => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <span>${m.name} (${m.type.charAt(0).toUpperCase() + m.type.slice(1)})</span>
                <button class="btn btn-danger btn-sm" onclick="deleteMethod('${m.id}')">Delete</button>
            `;
            methodList.appendChild(div);
        });

        // 2. Render Categories
        const categoryList = document.getElementById('category-list');
        categoryList.innerHTML = '';
        data.categories.forEach(c => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <span>${c}</span>
                <button class="btn btn-danger btn-sm" onclick="deleteCategory('${c}')">Delete</button>
            `;
            categoryList.appendChild(div);
        });

        // Re-populate form options just in case
        populateFormOptions();
    }

    function addMethod() {
        const name = document.getElementById('new-method-name').value.trim();
        const type = document.getElementById('new-method-type').value;

        if (!name) {
            alert("Method name cannot be empty.");
            return;
        }

        if (data.methods.some(m => m.name.toLowerCase() === name.toLowerCase())) {
            alert("A method with this name already exists.");
            return;
        }

        data.methods.push({
            id: generateUniqueId(),
            name: name,
            type: type,
            balance: 0 // Will be recalculated from transactions
        });

        document.getElementById('new-method-name').value = '';
        updateDashboard();
        renderSettingsData();
    }

    function deleteMethod(id) {
        const method = data.methods.find(m => m.id === id);
        if (!method) return;

        if (confirm(`Are you sure you want to delete the method "${method.name}"? This will move all its transactions to the first available liquid method.`)) {
            // Reassign transactions to a default method before deleting
            const defaultMethod = data.methods.find(m => m.type === 'liquid' && m.id !== id);
            
            if (defaultMethod) {
                data.transactions.forEach(t => {
                    if (t.method === id) {
                        t.method = defaultMethod.id;
                    }
                });
            } else {
                alert("Cannot delete the last available method.");
                return;
            }

            data.methods = data.methods.filter(m => m.id !== id);
            updateDashboard();
            renderSettingsData();
        }
    }

    function addCategory() {
        const name = document.getElementById('new-category-name').value.trim();

        if (!name) {
            alert("Category name cannot be empty.");
            return;
        }

        if (data.categories.some(c => c.toLowerCase() === name.toLowerCase())) {
            alert("A category with this name already exists.");
            return;
        }

        data.categories.push(name);

        document.getElementById('new-category-name').value = '';
        updateDashboard();
        renderSettingsData();
    }

    function deleteCategory(name) {
        if (confirm(`Are you sure you want to delete the category "${name}"? This will remove it from future selections, but existing transactions will retain it.`)) {
            data.categories = data.categories.filter(c => c !== name);
            updateDashboard();
            renderSettingsData();
        }
    }

    // --- DATA IMPORT/EXPORT ---
    
    function handleImport() {
      const fileInput = document.getElementById('import-file');
      const importMode = document.getElementById('import-mode').value;
      const file = fileInput.files[0];
      
      if (!file) { alert("Please select a file to import."); return; }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const content = event.target.result;
          let importedData;
          
          if (file.name.endsWith('.json')) {
            importedData = JSON.parse(content);
          } else if (file.name.endsWith('.csv')) {
             // CSV only imports transactions, must map back to current data structure
             importedData = { transactions: parseCSV(content) };
          } else {
            alert("Unsupported file type. Please use JSON or CSV.");
            return;
          }

          if (importMode === 'replace') {
            // Replace everything except config
            data.transactions = importedData.transactions || [];
            data.methods = importedData.methods || getDefaultData().methods;
            data.categories = importedData.categories || getDefaultData().categories;
            alert(`Successfully replaced data with ${data.transactions.length} transactions.`);
          } else {
            // Simple append - assumes no conflict checking
            data.transactions = data.transactions.concat(importedData.transactions || []);
            alert(`Successfully appended ${importedData.transactions.length || 0} transactions.`);
          }
          
          updateDashboard();
          fileInput.value = ''; // Clear file input
        } catch (error) {
          alert("Error processing file. Please ensure it is a valid MoneyMirror export format.");
          console.error(error);
        }
      };
      
      reader.readAsText(file);
    }
    
    function exportData(format) {
      const exportData = {
        profileName: currentProfile,
        timestamp: Date.now(),
        config: data.config,
        methods: data.methods,
        categories: data.categories,
        transactions: data.transactions
      };
      
      let content;
      let mimeType;
      let extension;
      
      if (format === 'json') {
        content = JSON.stringify(exportData, null, 2);
        mimeType = 'application/json';
        extension = 'json';
      } else if (format === 'csv') {
        content = generateCSV(exportData.transactions);
        mimeType = 'text/csv';
        extension = 'csv';
      } else {
        return;
      }

      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `MoneyMirror_Export_${currentProfile}_${new Date().toISOString().slice(0, 10)}.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Placeholder CSV utility (needs full implementation for robust use)
    function generateCSV(transactions) {
        const headers = ["id", "type", "amount", "date", "method", "category", "description", "investmentGroup", "investmentSub", "insuranceType", "insuranceFor", "isCCPayment", "timestamp"];
        const csvRows = [];
        csvRows.push(headers.join(','));

        for (const t of transactions) {
            const values = headers.map(header => {
                let value = t[header] !== undefined ? t[header] : '';
                if (typeof value === 'string' && value.includes(',')) {
                    value = `"${value}"`;
                }
                return value;
            });
            csvRows.push(values.join(','));
        }

        return csvRows.join('\n');
    }

    function parseCSV(csvText) {
        // Simple CSV parser for transactions (in a real app, this would be more complex)
        const lines = csvText.split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) return [];
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const transactions = [];

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const t = {};
            headers.forEach((header, index) => {
                let value = values[index] ? values[index].trim().replace(/"/g, '') : undefined;
                if (['amount', 'timestamp', 'id'].includes(header)) {
                    value = parseFloat(value) || 0;
                } else if (value === 'true') {
                    value = true;
                } else if (value === 'false') {
                    value = false;
                }
                if (value !== undefined) {
                    t[header] = value;
                }
            });
            // Ensure mandatory fields for a transaction
            if (t.type && t.amount > 0 && t.date) {
                transactions.push(t);
            }
        }
        return transactions;
    }
    
    // --- INITIALIZATION ---
    
    function updateDashboard() {
      // Re-run all primary display functions
      document.getElementById('current-profile-name').textContent = `Profile: ${currentProfile}`;
      populateFormOptions();
      calculateKPIs();
      renderConfiguration();
      renderTransactionTable();
      // Note: Charts and Settings data are rendered on view switch/explicit call
      saveState();
    }
    
    function initApplication() {
      // Set view to default
      switchView('dashboard');
      
      // Update all data-dependent parts
      updateDashboard();
      
      // Hide the modal and show main content
      hideProfileModal();
      
      // Initialize calculator for correct starting state
      calcClear();
    }
    
    // --- CALCULATOR LOGIC (PRESERVED & FIXED) ---
    
    let calcDisplay = '0';
    let firstOperand = null;
    let operator = null;
    let waitingForSecondOperand = false;

    function calcUpdateDisplay() {
        const display = document.getElementById('calc-screen');
        if (display) {
            display.value = calcDisplay;
        }
    }

    function calcClear() {
        calcDisplay = '0';
        firstOperand = null;
        operator = null;
        waitingForSecondOperand = false;
        calcUpdateDisplay();
    }

    function calcAppend(digit) {
        if (digit === '.') {
            if (calcDisplay.includes('.')) return;
            if (waitingForSecondOperand) {
                calcDisplay = '0.';
                waitingForSecondOperand = false;
            } else {
                calcDisplay = calcDisplay + '.';
            }
        } else {
            if (waitingForSecondOperand) {
                calcDisplay = digit;
                waitingForSecondOperand = false;
            } else {
                calcDisplay = calcDisplay === '0' ? digit : calcDisplay + digit;
            }
        }
        calcUpdateDisplay();
    }

    function calcHandleOperator(nextOperator) {
        const inputValue = parseFloat(calcDisplay);

        if (operator && waitingForSecondOperand) {
            operator = nextOperator;
            return;
        }

        if (firstOperand === null) {
            firstOperand = inputValue;
        } else if (operator) {
            const result = calcPerformCalculation[operator](firstOperand, inputValue);
            calcDisplay = String(result);
            firstOperand = result;
        }

        waitingForSecondOperand = true;
        operator = nextOperator;
        calcUpdateDisplay();
    }

    function calcCalculate() {
      if (operator) {
        // Calculate the result using the stored operator, first operand, and current display value
        const secondOperand = parseFloat(calcDisplay);
        const result = calcPerformCalculation[operator](firstOperand, secondOperand);
        
        calcDisplay = String(result);
        firstOperand = result;
        operator = null; // Clear the operator after equals
        waitingForSecondOperand = true; // Ready for a new calculation
      }
      calcUpdateDisplay();
    }

    function calcBackspace() {
        if (waitingForSecondOperand) return;
        calcDisplay = calcDisplay.length > 1 ? calcDisplay.slice(0, -1) : '0';
        calcUpdateDisplay();
    }

    const calcPerformCalculation = {
      '/': (first, second) => first / second,
      '*': (first, second) => first * second,
      '+': (first, second) => first + second,
      '-': (first, second) => first - second,
    };

    document.getElementById('calc-buttons').addEventListener('click', (event) => {
        if (!event.target.matches('button')) return;

        const target = event.target;
        if (target.classList.contains('calc-operator')) {
            calcHandleOperator(target.textContent === '÷' ? '/' : target.textContent === '×' ? '*' : target.textContent);
            return;
        }
        if (target.classList.contains('calc-equals')) {
            calcCalculate();
            return;
        }
        if (target.classList.contains('calc-clear')) {
            calcClear();
            return;
        }
        if (target.textContent === '←') {
            calcBackspace();
            return;
        }
        if (target.textContent === '.') {
            calcAppend('.');
            return;
        }

        // Handle number input (0-9)
        if (!isNaN(parseInt(target.textContent))) {
            calcAppend(target.textContent);
            return;
        }
    });

    // Toggle visibility on click
    const calculator = document.getElementById('calculator');
    document.getElementById('calc-toggle').onclick = () => {
        calculator.classList.toggle('hidden');
        if (!calculator.classList.contains('hidden')) {
            // Ensure display is correct when opening
            calcUpdateDisplay();
        }
    };
    
    // --- STARTUP ---
    window.onload = initializeProfiles;
  </script>
</body>
</html>
