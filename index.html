<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — v5.0.2 Copilot (Full build: visual polish + synced filters + mobile fixes)</title>

  <!-- Fonts and Charts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase (Compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
    };
    let db=null, auth=null, USE_FIRESTORE=false, currentProfile=null;
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';
    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore(); auth = app.auth(); USE_FIRESTORE = true;
    } catch(e) { console.warn('Firebase init failed, using local only'); }

    async function signInWithGoogle() {
      if(!auth) return alert('Auth not initialized. Please refresh.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try { const res = await auth.signInWithPopup(provider); onUserSignedIn(res.user); }
      catch(err){ alert('Sign-in popup blocked. Allow popups and try again.'); }
    }
    function onUserSignedIn(user){
      currentProfile = user.displayName || user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      document.getElementById('profileNameDisplay').textContent = currentProfile;
      document.getElementById('authGate').style.display='none';
      document.querySelector('main').style.filter='none';
      document.getElementById('logoutBtn').style.display='block';
      loadProfileData();
    }
    function signOutUser(){
      if(!auth) return;
      auth.signOut().then(()=>{
        currentProfile=null;
        document.getElementById('profileNameDisplay').textContent='--';
        document.getElementById('logoutBtn').style.display='none';
        document.getElementById('authGate').style.display='flex';
        document.querySelector('main').style.filter='blur(5px)';
      });
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
      document.getElementById('logoutBtn').addEventListener('click', signOutUser);
      if(auth){
        auth.onAuthStateChanged(user=>{ if(user) onUserSignedIn(user); else { document.getElementById('authGate').style.display='flex'; document.querySelector('main').style.filter='blur(5px)'; } });
      }
    });
  </script>

  <style>
    :root{
      --sidebar-bg:#0f172a; --sidebar-text:#94a3b8; --sidebar-active:#38bdf8;
      --bg-color:#f1f5f9; --card-bg:#ffffff; --text-main:#0f172a; --text-muted:#64748b;
      --primary:#2563eb; --primary-2:#1d4ed8; --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
      --border:#e2e8f0;
      /* Pro palette for charts */
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6; --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
      --kpi-glow: 0 10px 25px rgba(29,78,216,0.15);
    }

    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;margin:0;background:var(--bg-color);color:var(--text-main);height:100vh;display:flex;overflow:hidden}
    aside{width:260px;background:var(--sidebar-bg);color:white;display:flex;flex-direction:column;padding:24px 16px;justify-content:space-between;flex-shrink:0}
    main{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:24px;position:relative;filter:blur(5px)}

    .brand{font-size:20px;font-weight:800;margin-bottom:30px;display:flex;align-items:center;gap:10px;padding-left:10px}
    .brand span{color:var(--sidebar-active)}
    .nav-group{margin-bottom:24px}
    .nav-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#475569;font-weight:700;margin-bottom:8px;padding-left:10px}
    .nav-item{padding:10px 12px;border-radius:8px;color:var(--sidebar-text);cursor:pointer;transition:.2s;display:flex;align-items:center;gap:12px;font-size:14px;font-weight:600;margin-bottom:2px}
    .nav-item:hover{background:rgba(255,255,255,0.06);color:white}
    .nav-item.active{background:rgba(56,189,248,0.12);color:var(--sidebar-active)}
    .sidebar-footer{background:rgba(255,255,255,0.06);padding:15px;border-radius:10px;border:1px solid rgba(255,255,255,0.08)}

    #authGate{position:fixed;inset:0;background:linear-gradient(135deg,#0f172a,#2563eb);z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:6px;color:white;text-align:center;padding:0 24px}
    #authGate .line-1{font-size:22px;font-weight:700} #authGate .line-2{font-size:20px;font-weight:800}
    #authGate .line-3{font-family:'Merriweather',serif;font-style:italic;font-size:18px;margin:6px 0 14px}

    button{padding:10px 16px;border-radius:10px;border:1px solid transparent;font-weight:700;font-size:13px;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--primary);color:white;box-shadow:0 8px 20px rgba(37,99,235,0.25)}
    .btn-primary:hover{background:var(--primary-2)}
    .btn-outline{background:white;border:1px solid var(--border);color:var(--text-main)}
    .btn-outline:hover{background:#f8fafc;border-color:#cbd5e1}
    .btn-danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    .dashboard-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
    .col-span-1{grid-column:span 1} .col-span-2{grid-column:span 2} .col-span-3{grid-column:span 3} .col-span-4{grid-column:span 4}

    /* Pro 3D KPI cards */
    .card{background:var(--card-bg);border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 2px 6px rgba(15,23,42,0.06)}
    .kpi-card{padding:20px;background:linear-gradient(180deg,#ffffff, #f8fafc);border:1px solid #e6edf6;box-shadow:0 12px 30px rgba(2,25,66,0.08), inset 0 1px 0 rgba(255,255,255,0.6)}
    .kpi-title{font-size:12px;letter-spacing:.6px;text-transform:uppercase;color:#475569;font-weight:800}
    .kpi-value{font-size:30px;font-weight:800;margin-top:6px;letter-spacing:-0.5px}
    .kpi-sub{font-size:12px;color:#334155;margin-top:8px;display:flex;align-items:center;gap:6px;font-weight:700}
    .kpi-card.emphasis{box-shadow:var(--kpi-glow)}
    .strong-black{color:#0f172a;font-weight:800}

    .card-header{display:flex;justify-content:space-between;align-items:center;padding:18px 18px 10px 18px}
    .card-body{padding:0 18px 18px 18px}
    .card-title{font-size:15px;font-weight:800;color:#0f172a}

    label{font-size:11px;font-weight:800;text-transform:uppercase;color:#64748b;margin-bottom:6px;display:block;letter-spacing:.5px}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:#f8fafc;outline:none;transition:border .2s}
    input:focus,select:focus{border-color:var(--primary);background:white;box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
    .flex-row{display:flex;gap:10px;align-items:center}
    .hidden{display:none !important}

    .badge{padding:4px 8px;border-radius:20px;font-size:11px;font-weight:700;display:inline-block}
    .badge-income{background:#dcfce7;color:#166534}
    .badge-expense{background:#fee2e2;color:#991b1b}
    .badge-inv{background:#e0f2fe;color:#075985}
    .badge-ins{background:#f3e8ff;color:#6b21a8}
    .badge-opening{background:#efe6ff;color:#6b21a8}
    .badge-cc{background:#fef3c7;color:#b45309}

    .account-list{font-size:12px;margin-top:12px;border-top:1px solid var(--border);padding-top:10px;display:flex;flex-direction:column;gap:6px;color:#475569}
    .account-list div{display:flex;justify-content:space-between}
    .account-list span:last-child{font-weight:800;color:#0f172a}

    /* KPI breakdown charts layout */
    .kpi-breakdown-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:stretch}

    /* Wallet layout */
    .wallet-layout{display:flex;flex-direction:row;align-items:center;gap:20px}
    .wallet-chart{height:300px;width:50%;max-width:360px;position:relative}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:2000;display:none;justify-content:center;align-items:center;backdrop-filter:blur(2px)}
    .modal.open{display:flex;animation:fadeIn .2s ease-out}
    .modal-content{background:white;width:95%;max-width:1200px;border-radius:16px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-height:90vh;overflow-y:auto}
    .modal-pad{padding:24px} .modal-small{width:420px}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* Mobile fixes: prevent truncation/squeeze */
    @media(max-width: 1024px){ .dashboard-grid{grid-template-columns:repeat(2,1fr)} .col-span-2,.col-span-3,.col-span-4{grid-column:span 2}}
    @media(max-width: 768px){
      body{flex-direction:column;height:auto;overflow:auto}
      aside{width:100%;padding:15px;flex-direction:row;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:500}
      .dashboard-grid{grid-template-columns:1fr;gap:16px}
      .kpi-breakdown-grid{grid-template-columns:1fr}
      .wallet-layout{flex-direction:column}
      .wallet-chart{width:100%;max-width:100%;height:300px}
    }

    /* Quick subs (ordered groups) */
    .quick-sub-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:white}
    .quick-sub-header{display:flex;justify-content:space-between;align-items:center}
    .quick-sub-title{font-weight:800}
    .total-badge{background:#f1f5f9;border:1px solid #e2e8f0;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:800;color:#0f172a}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;top:34px;left:0;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;width:280px;box-shadow:0 12px 24px rgba(0,0,0,0.15);z-index:10}
    .dropdown-item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px;font-size:12px}
    .dropdown-item:hover{background:#f8fafc}
  </style>
</head>
<body>

<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror — Personal Finance</p>
  <p class="line line-3">by Rehan Hamdulay</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px;font-size:16px;">Sign in with Google</button>
</div>

<aside id="mainSidebar">
  <div>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
      MoneyMirror <span>v5.0</span>
    </div>
    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>
      </div>
      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%;display:none;">Logout</button></div>
      </div>
    </nav>
  </div>
  <div class="sidebar-footer">
    <div class="flex-row" style="justify-content:space-between;font-size:11px;color:var(--sidebar-text)">
      <span>Current profile</span><span id="profileNameDisplay" style="color:white;font-weight:800">--</span>
    </div>
    <div style="font-size:10px;color:var(--sidebar-text);margin-top:6px">v5.0.2 • Visual polish + synced filters + mobile fixes</div>
  </div>
</aside>

<main>
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
    <div>
      <h1 style="margin:0;font-size:24px;font-weight:800">Financial overview</h1>
      <div id="currentDate" style="font-size:13px;color:var(--text-muted);margin-top:4px"></div>
    </div>
    <div class="flex-row">
      <button class="btn-outline" id="sampleBtn">Load sample</button>
      <button class="btn-primary" id="importDataBtn">Import data (CSV/JSON)</button>
      <button class="btn-outline" id="exportBtn">Export CSV</button>
      <button class="btn-outline" id="calc-toggle">Calculator</button>
    </div>
  </div>

  <!-- KPI row -->
  <div class="dashboard-grid">
    <div class="card kpi-card emphasis col-span-1">
      <div class="kpi-title">Monthly income</div>
      <div class="kpi-value strong-black" id="kpiIncome">₹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    <div class="card kpi-card emphasis col-span-1">
      <div class="kpi-title">Monthly expenses</div>
      <div class="kpi-value strong-black" id="kpiExpense">₹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    <div class="card kpi-card emphasis col-span-1" id="ccCard" style="border:1px solid #fde68a;background:linear-gradient(180deg,#fff7ed,#fffbeb)">
      <div class="kpi-title">Credit card due</div>
      <div class="kpi-value strong-black" id="kpiCCDue">₹0</div>
      <div class="kpi-sub strong-black" style="margin-top:6px;">
        <span id="ccPaymentDate">Next Payment: 10th of December</span>
        <span style="margin-left:10px;">Limit: <span id="ccLimitDisplay">₹2,00,000</span></span>
      </div>
    </div>
    <div class="card kpi-card emphasis col-span-1">
      <div class="kpi-title">Net liquidity</div>
      <div class="kpi-value strong-black" id="kpiNet">₹0</div>
      <div class="kpi-sub">Total available cash</div>
      <div class="account-list" id="netLiquidityBreakdown"></div>
    </div>

    <!-- KPI: Total Investment Value with pro charts and synced filters -->
    <div class="card kpi-card emphasis col-span-4" style="background:linear-gradient(180deg,#eef2ff,#f8fafc);border:1px solid #c7d2fe;">
      <div class="card-header" style="padding-top:8px;">
        <div class="card-title">Total investment value (historical cost)</div>
        <div class="flex-row" style="gap:8px;">
          <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px;font-size:12px;">View breakdown</button>
        </div>
      </div>
      <div class="card-body" style="padding-top:6px;">
        <div class="kpi-value strong-black" id="kpiInvest">₹0</div>
        <div class="kpi-sub" id="momInvest" style="color:#1e3a8a"></div>

        <div id="invBreakdownPanel" class="hidden" style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
          <!-- Filters -->
          <div class="card" style="border:1px solid #c7d2fe;margin-bottom:12px;border-radius:12px;">
            <div class="card-header">
              <div class="card-title">Filters</div>
              <div class="flex-row" style="gap:10px;flex-wrap:wrap;">
                <div style="min-width:220px;">
                  <label>Major bucket</label>
                  <select id="invBucketFilter"></select>
                </div>
                <div style="min-width:220px;">
                  <label>View mode</label>
                  <select id="invViewMode">
                    <option value="top4">Top 4 buckets</option>
                    <option value="subcats">Subcategories of selected bucket</option>
                  </select>
                </div>
                <div style="min-width:220px;">
                  <label>Date range</label>
                  <select id="invDateRange">
                    <option value="6">Last 6 months</option>
                    <option value="12">Last 12 months</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="kpi-breakdown-grid">
            <div class="card" style="border:1px solid #c7d2fe;">
              <div class="card-header"><div class="card-title" id="invBarTitle">Investment by major bucket</div></div>
              <div class="card-body" style="height:340px">
                <canvas id="invBreakdownBar"></canvas>
              </div>
            </div>
            <div class="card" style="border:1px solid #c7d2fe;">
              <div class="card-header"><div class="card-title" id="invPieTitle">Share by bucket</div></div>
              <div class="card-body" style="height:340px">
                <canvas id="invBreakdownPie"></canvas>
              </div>
            </div>
          </div>

          <!-- Ordered bucket subcategories quick view -->
          <div style="margin-top:14px;">
            <div class="card-title" style="font-size:13px;color:#1e3a8a;">Bucket subcategories quick view</div>
            <div id="invQuickSubs" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cash flow + Wallet -->
  <div class="dashboard-grid">
    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Cash flow & investments</div>
        <select id="mainChartFilter" onchange="renderCharts()">
          <option value="6">Last 6 months</option>
          <option value="12">Last 12 months</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:340px;width:100%;position:relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card col-span-2">
      <div class="card-header" style="gap:12px;">
        <div class="card-title">Wallet breakdown and expense analysis</div>
        <div class="flex-row" style="gap:12px;flex-wrap:wrap;">
          <select id="walletMode" onchange="renderWalletUnified()">
            <option value="wallet">Wallet breakdown (Liquid & Savings)</option>
            <option value="expenses">Expense distribution (Top 10)</option>
          </select>
          <div id="walletChecklistContainer" class="hidden dropdown">
            <button class="btn-outline" id="toggleChecklist" style="padding:6px 10px;font-size:12px;">Filter categories</button>
            <div id="walletCategoryChecklist" class="dropdown-menu hidden" onclick="event.stopPropagation()">
              <!-- checkboxes injected by JS -->
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <button class="btn-outline" id="applyChecklist" style="padding:6px 10px;font-size:12px;">Apply</button>
                <button class="btn-outline" id="clearChecklist" style="padding:6px 10px;font-size:12px;">Clear</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body wallet-layout">
        <div class="wallet-chart">
          <canvas id="donutChart"></canvas>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;gap:10px;">
          <div id="walletLegend" style="font-size:12px;color:var(--text-muted);"></div>
          <div id="walletInfo" style="font-size:12px;color:var(--text-muted);"></div>
          <button id="resetExpenseDrilldown" class="btn-outline hidden" style="padding:6px;font-size:12px" onclick="resetExpenseDrilldown()">Clear filters</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add entry + recent -->
  <div class="dashboard-grid">
    <div class="card col-span-4" style="border:1px solid #dbeafe">
      <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);border-radius:16px 16px 0 0;">
        <div class="card-title" style="color:white">Add new entry</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </div>
      <div class="card-body" style="padding-top:16px;display:flex;flex-wrap:wrap;gap:20px">
        <div style="width:15%">
          <label>Type</label>
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="opening_balance">Opening Balance</option>
          </select>
        </div>
        <div style="width:15%">
          <label>Amount (₹)</label>
          <input id="amount" type="number" placeholder="0.00" style="font-weight:800;font-size:16px" step="any" />
        </div>
        <div style="width:15%">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div style="width:45%">
          <label>Description</label>
          <input id="desc" placeholder="What is this for?" />
        </div>

        <div id="dynamicFieldsContainer" class="col-span-4" style="width:100%;border-top:1px solid var(--border);padding-top:15px">
          <div id="regularFields" style="display:flex;gap:20px;flex-wrap:wrap">
            <div id="categoryContainer" style="width:15%">
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div style="width:15%">
              <label>Method</label>
              <select id="method"></select>
            </div>
            <div id="incomeSourceRow" class="hidden" style="width:15%">
              <label>Source</label>
              <select id="incomeSource"></select>
            </div>

            <div id="investmentRow" class="hidden" style="display:flex;gap:20px;flex-wrap:wrap;width:100%">
              <div style="width:20%">
                <label>Investment category</label>
                <select id="invGroup"></select>
              </div>
              <div style="width:20%">
                <label>Investment sub-type</label>
                <select id="invSub"></select>
              </div>
            </div>

            <div id="insuranceRow" class="hidden" style="width:25%">
              <label>Insurance details</label>
              <div class="flex-row">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>

          <div id="openingBalanceRow" class="hidden" style="display:flex;gap:20px;flex-wrap:wrap;width:100%">
            <div style="width:20%">
              <label>Asset type</label>
              <select id="openingType">
                <option value="Cash">Cash (Liquid)</option>
                <option value="Investment">Investment Asset</option>
              </select>
            </div>
            <div class="hidden" id="openingGroupContainer" style="width:20%">
              <label id="openingGroupLabel">Asset category</label>
              <select id="openingGroup"></select>
            </div>
            <div class="hidden" id="openingSubContainer" style="width:20%">
              <label id="openingSubLabel">Account / Asset sub-type</label>
              <select id="openingSub"></select>
            </div>
          </div>
        </div>

        <div style="width:100%;display:flex;gap:10px;margin-top:10px">
          <button class="btn-primary" id="addBtn">Add entry</button>
          <button class="btn-primary hidden" id="saveBtn">Save changes</button>
          <button class="btn-outline hidden" id="cancelBtn">Cancel edit</button>
        </div>
      </div>
    </div>

    <div class="card col-span-4">
      <div class="card-header">
        <div class="card-title">Recent transactions</div>
        <div class="flex-row">
          <select id="entryLimit" onchange="renderRecentEntries()">
            <option value="10">Last 10</option>
            <option value="25">Last 25</option>
            <option value="50">Last 50</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>
      <div class="card-body" style="overflow-x:auto">
        <table id="recentTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Type</th><th>Date</th><th>Amount</th><th>Description</th><th>Category</th><th>Method</th><th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Settings -->
<div id="settingsModal" class="modal">
  <div class="modal-content modal-small">
    <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);border-radius:16px 16px 0 0">
      <div class="card-title" style="color:white">Settings & Configuration</div>
      <button class="btn-outline" id="closeSettings" style="background:transparent;color:white;border-color:white;padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <div style="margin-bottom:20px">
        <label>Payment methods</label>
        <div id="methodEditor" style="border:1px solid var(--border);border-radius:12px;padding:10px;"></div>
        <div class="flex-row" style="margin-top:10px">
          <input id="newMethod" placeholder="New method (e.g. SBI UPI)" />
          <button class="btn-primary" id="addMethod">Add</button>
        </div>
      </div>
      <div style="margin-bottom:20px">
        <label>Income sources</label>
        <div class="flex-row">
          <input id="newIncome" placeholder="New source name" />
          <button class="btn-primary" id="addIncomeBtn">Add</button>
        </div>
        <div id="incomeList" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap"></div>
      </div>
      <div style="margin-bottom:20px">
        <label>Credit card limit</label>
        <div class="flex-row">
          <input id="ccLimitInput" type="number" placeholder="Set limit (e.g. 200000)" />
          <button class="btn-primary" id="saveCCLimit">Save limit</button>
        </div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:15px;margin-top:15px">
        <label style="color:var(--danger)">Danger zone</label>
        <div class="flex-row">
          <button class="btn-danger" id="resetBtn">Factory reset profile</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Analytics modal -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);border-radius:16px 16px 0 0">
      <div class="card-title" style="color:white">Advanced financial analytics</div>
      <button class="btn-outline" id="closeAnalytics" style="background:transparent;color:white;border-color:white;padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad" id="analyticsContent">
      <!-- Filters -->
      <div class="card" style="margin-bottom:16px;border:1px solid #dbeafe;border-radius:12px">
        <div class="card-header">
          <div class="card-title">Filters</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="min-width:180px">
              <label>Date range</label>
              <select id="dateFilter" onchange="renderAdvancedCharts()">
                <option value="6">Last 6 months</option>
                <option value="12">Last 12 months</option>
                <option value="all">All time</option>
              </select>
            </div>
            <div style="min-width:180px">
              <label>Chart type</label>
              <select id="chartType" onchange="renderAdvancedCharts()">
                <option value="line">Line chart</option>
                <option value="bar">Bar chart</option>
              </select>
            </div>
            <div style="min-width:220px">
              <label>Major bucket</label>
              <select id="analyticsBucket" onchange="renderAdvancedCharts()">
                <option value="">All</option>
                <option value="Equity">Equity</option>
                <option value="Debt">Debt</option>
                <option value="ETFs">ETFs</option>
                <option value="Mutual Funds">Mutual Funds</option>
                <option value="Retirement">Retirement</option>
                <option value="Real Estate">Real Estate</option>
                <option value="Commodities">Commodities</option>
                <option value="Crypto">Crypto</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <h3 style="margin:10px 0 0;font-size:18px;">Cumulative net worth</h3>
      <div class="card" style="margin-bottom:16px">
        <div class="card-body" style="padding-top:14px">
          <div style="height:360px;width:100%;position:relative">
            <canvas id="chartNetWorth"></canvas>
          </div>
        </div>
      </div>

      <h3 style="margin:10px 0 0;font-size:18px;">Investment analysis</h3>
      <div class="card">
        <div class="card-body" style="padding-top:14px">
          <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr;">
            <div style="height:300px;position:relative;">
              <canvas id="chartInvTypesModal"></canvas>
            </div>
            <div style="height:300px;position:relative;">
              <canvas id="chartInvGrowthModal"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Import modal -->
<div id="importModal" class="modal">
  <div class="modal-content modal-small">
    <div class="card-header" style="background:linear-gradient(180deg,#2563eb,#1d4ed8);border-radius:16px 16px 0 0">
      <div class="card-title" style="color:white">Import data</div>
      <button class="btn-outline" id="closeImport" style="background:transparent;color:white;border-color:white;padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <h4 style="margin-top:0">Import from CSV/JSON</h4>
      <p style="font-size:13px;color:var(--text-muted)">CSV columns: type, amount, date, desc, category, method. Optional: income_source, investment_group, investment_sub, insurance_type, insurance_for.</p>
      <input type="file" id="importFile" accept=".csv,.json" style="width:100%;margin:10px 0 20px 0" />
      <button class="btn-primary" id="processImportBtn" style="width:100%">Process file</button>
    </div>
  </div>
</div>

<!-- Calculator -->
<div id="calculator" class="hidden" style="position:fixed;bottom:20px;right:20px;width:300px;height:480px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.3);background:#f8fafc;border:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;z-index:3000">
  <div id="calc-header" style="background:var(--sidebar-bg);color:white;padding:10px 15px;cursor:move;display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:13px;height:40px">
    <span>Calculator</span>
    <button id="calc-close-btn" style="background:transparent;border:none;color:#ef4444;font-size:18px;font-weight:800;cursor:pointer;padding:0;line-height:1">×</button>
  </div>
  <div id="calc-display" style="background:#0b1323;color:white;text-align:right;font-size:24px;padding:10px 15px;font-family:monospace;overflow-x:auto;white-space:nowrap;height:60px">0</div>
  <div id="calc-preview" style="background:#111827;color:#9fb3c8;text-align:right;font-size:14px;padding:6px 15px;font-family:monospace;height:28px;border-top:1px solid rgba(255,255,255,0.06)">Enter an expression…</div>
  <div id="calc-buttons" style="display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(5,1fr);padding:10px;gap:8px;background:white;flex:1">
    <button class="calc-clear">AC</button><button class="calc-clear">±</button><button class="calc-clear">%</button><button class="calc-operator">/</button>
    <button>7</button><button>8</button><button>9</button><button class="calc-operator">*</button>
    <button>4</button><button>5</button><button>6</button><button class="calc-operator">-</button>
    <button>1</button><button>2</button><button>3</button><button class="calc-operator">+</button>
    <button class="calc-zero" style="grid-column:span 2">0</button><button>.</button><button class="calc-equals" style="grid-row:span 2;background:var(--primary);color:white">=</button>
  </div>
</div>

<script>
  // Constants, structures, storage
  const DEFAULT_CC_LIMIT = 200000;
  const CANONICAL_METHODS = { cash:'Cash', salary_acct:'Bank Account (Salary)', savings_acct:'Bank Account (Savings)', credit_card:'Credit Card', digital_wallet:'Digital Wallet' };
  const BASE_CATS = ['Food','Rent','Utilities','Shopping','Entertainment','Travel','Health','Investments','Insurance','Credit Card Payment','Misc'];

  const INVESTMENT_STRUCTURE = {
    'Equity (Stocks)': {
      'India - Large Cap/Mid Cap/Small Cap':'Equity (Stocks)',
      'India - Index Stocks/Preferred Stock':'Equity (Stocks)',
      'India - Derivatives (Options/Futures)':'Equity (Stocks)',
      'US - Stocks':'Equity (Stocks)','International - Other':'Equity (Stocks)',
    },
    'Mutual Funds': {
      'Equity MF - Large Cap/Mid Cap/Small Cap':'Mutual Funds','Equity MF - Multi-cap':'Mutual Funds','Equity MF - ELSS (Tax Saving)':'Mutual Funds',
      'Debt MF - Overnight/Liquid/Ultra Short Term':'Mutual Funds','Debt MF - Corporate/Dynamic Bond':'Mutual Funds','Hybrid/Balanced MF':'Mutual Funds',
      'International/Global Index MF':'Mutual Funds','Gold/Sectoral/Thematic MF':'Mutual Funds',
    },
    'ETFs': {'Equity ETF':'ETFs','Debt ETF':'ETFs','Gold ETF':'ETFs','Index ETF':'ETFs','Thematic ETF':'ETFs'},
    'Bonds & Debt Instruments': {'Government Bonds':'Bonds & Debt Instruments','Corporate Bonds':'Bonds & Debt Instruments','Treasury Bills':'Bonds & Debt Instruments','Tax-Free Bonds':'Bonds & Debt Instruments','Sovereign Gold Bonds (SGB)':'Bonds & Debt Instruments'},
    'Commodities': {'Gold (Physical/Digital)':'Commodities','Silver':'Commodities','Crude Oil/Natural Gas':'Commodities','Other Metals (Copper/Nickel)':'Commodities'},
    'Crypto & Digital Assets': {'Bitcoin (BTC)':'Crypto & Digital Assets','Ethereum (ETH)':'Crypto & Digital Assets','Stablecoins':'Crypto & Digital Assets','Altcoins':'Crypto & Digital Assets','NFTs / Web3 Assets':'Crypto & Digital Assets'},
    'Real Estate': {'Residential Property':'Real Estate','Commercial Property':'Real Estate','Land':'Real Estate','REITs (Real Estate Investment Trusts)':'Real Estate'},
    'Fixed Income / Savings Schemes': {'FD (Fixed Deposit)':'Fixed Income / Savings Schemes','RD (Recurring Deposit)':'Fixed Income / Savings Schemes','PPF':'Fixed Income / Savings Schemes','NSC/KVP/Postal MIS':'Fixed Income / Savings Schemes','High-Interest Savings Account':'Fixed Income / Savings Schemes'},
    'Retirement Funds': {'NPS Tier 1/Tier 2':'Retirement Funds','EPF (Employees’ Provident Fund)':'Retirement Funds','IRA/401k (USA users)':'Retirement Funds','Other Pension Schemes':'Retirement Funds'},
    'Other Investments': {'Angel Investing / Startup Equity':'Other Investments','Peer-to-Peer Lending':'Other Investments','Private Funds / AIFs':'Other Investments','Alternative Assets':'Other Investments'}
  };
  const MAJOR_BUCKETS = {
    'Equity (Stocks)':'Equity','Mutual Funds':'Mutual Funds','ETFs':'ETFs','Bonds & Debt Instruments':'Debt','Fixed Income / Savings Schemes':'Debt','Retirement Funds':'Retirement','Real Estate':'Real Estate','Commodities':'Commodities','Crypto & Digital Assets':'Crypto','Other Investments':'Other'
  };

  let data = [];
  let methodNames = {...CANONICAL_METHODS};
  let incomeSources = ['Salary','Freelance','Interest'];
  let settings = { ccLimit: DEFAULT_CC_LIMIT };
  let editId = null;

  let chartMain=null, donutChart=null, chartNetWorth=null, chartInvTypesModal=null, chartInvGrowthModal=null, invBreakdownBarChart=null, invBreakdownPieChart=null;

  // Init UI
  document.addEventListener('DOMContentLoaded', ()=>{
    const d = new Date();
    document.getElementById('currentDate').innerText = d.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const today = new Date().toISOString().slice(0,10);
    const dateEl = document.getElementById('date'); if(dateEl) dateEl.value = today;

    // Modals
    document.getElementById('navSettings').addEventListener('click', ()=> document.getElementById('settingsModal').classList.add('open'));
    document.getElementById('closeSettings').addEventListener('click', ()=> document.getElementById('settingsModal').classList.remove('open'));
    document.getElementById('navAnalytics').addEventListener('click', ()=>{ document.getElementById('analyticsModal').classList.add('open'); renderAdvancedCharts(); });
    document.getElementById('closeAnalytics').addEventListener('click', ()=> document.getElementById('analyticsModal').classList.remove('open'));
    document.getElementById('importDataBtn').addEventListener('click', ()=> document.getElementById('importModal').classList.add('open'));
    document.getElementById('closeImport').addEventListener('click', ()=> document.getElementById('importModal').classList.remove('open'));

    // Calculator
    document.getElementById('calc-toggle').addEventListener('click', ()=> document.getElementById('calculator').classList.toggle('hidden'));
    document.getElementById('calc-close-btn').addEventListener('click', (e)=> { document.getElementById('calculator').classList.add('hidden'); e.stopPropagation(); });
    document.querySelectorAll('#calc-buttons button').forEach(btn=> btn.addEventListener('click', handleCalculatorInput));
    dragElement(document.getElementById('calculator'));

    // Data helpers
    document.getElementById('sampleBtn').addEventListener('click', loadSampleData);
    document.getElementById('exportBtn').addEventListener('click', ()=> convertToCSV(data));
    document.getElementById('processImportBtn').addEventListener('click', processImportedData);

    // Settings actions
    document.getElementById('resetBtn')?.addEventListener('click', ()=>{
      if(confirm('WARNING: This will erase ALL your data (local and Firestore). Are you absolutely sure?')){
        localStorage.clear();
        data = []; methodNames = {...CANONICAL_METHODS}; incomeSources = ['Salary','Freelance','Interest']; settings = { ccLimit: DEFAULT_CC_LIMIT };
        saveAll(); window.location.reload();
      }
    });

    // Wallet filters UI - no premature closing
    setupWalletFilters();

    // KPI investment filters
    setupInvestmentFilters();
  });

  // Persistence
  function getTxKey(){ return currentProfile ? `mm_data_${currentProfile}` : 'mm_data_default'; }
  function getMethodKey(){ return currentProfile ? `mm_methods_${currentProfile}` : 'mm_methods_default'; }
  function getIncomeKey(){ return currentProfile ? `mm_income_${currentProfile}` : 'mm_income_default'; }
  function getSettingsKey(){ return currentProfile ? `mm_settings_${currentProfile}` : 'mm_settings_default'; }
  function toKey(name){ return (name||'').toLowerCase().replace(/[^a-z0-9]+/g,'_'); }

  function saveToLocalStorage(){
    localStorage.setItem(getTxKey(), JSON.stringify(data));
    localStorage.setItem(getMethodKey(), JSON.stringify(methodNames));
    localStorage.setItem(getIncomeKey(), JSON.stringify(incomeSources));
    localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
  }
  function saveAll(){
    if(!currentProfile){ saveToLocalStorage(); return; }
    if(USE_FIRESTORE && db){
      db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).set({
        data, methodNames, incomeSources, settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(()=> saveToLocalStorage());
    } else saveToLocalStorage();
  }
  function loadFromLocalStorage(){
    methodNames = JSON.parse(localStorage.getItem(getMethodKey())) || {...CANONICAL_METHODS};
    incomeSources = JSON.parse(localStorage.getItem(getIncomeKey())) || ['Salary','Freelance','Interest'];
    data = JSON.parse(localStorage.getItem(getTxKey())) || [];
    settings = JSON.parse(localStorage.getItem(getSettingsKey())) || { ccLimit: DEFAULT_CC_LIMIT };
    data = data.map(d=>({
      id: d.id || uid(), type: d.type || 'expense', amount: Number(d.amount)||0, date: d.date || new Date().toISOString().slice(0,10), desc: d.desc || '',
      category: d.category || 'Misc', method: d.method || 'cash', incomeSource: d.incomeSource || '', investmentGroup: d.investmentGroup || '', investmentSub: d.investmentSub || '',
      insuranceType: d.insuranceType || '', insuranceFor: d.insuranceFor || ''
    }));
  }
  async function loadProfileData(){
    loadFromLocalStorage();
    if(USE_FIRESTORE && db && currentProfile){
      try{
        const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).get();
        if(doc.exists){ const serverData=doc.data(); data=serverData.data||data; methodNames=serverData.methodNames||methodNames; incomeSources=serverData.incomeSources||incomeSources; settings=serverData.settings||settings; }
      }catch(e){}
    }
    renderAll();
  }

  // Render pipeline
  function renderAll(){
    data.sort((a,b)=> new Date(b.date) - new Date(a.date));
    setupDropdowns();
    renderKPIs();
    renderCharts();
    renderRecentEntries();
    renderSettings();
    if(document.getElementById('analyticsModal').classList.contains('open')) renderAdvancedCharts();
  }

  function setupDropdowns(){
    document.getElementById('method').innerHTML = Object.keys(methodNames).filter(k=>k!=='credit_card').map(k=>`<option value="${k}">${methodNames[k]}</option>`).join('');
    document.getElementById('incomeSource').innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s=>`<option value="${s}">${s}</option>`).join('');
    document.getElementById('category').innerHTML = BASE_CATS.map(c=>`<option value="${c}">${c}</option>`).join('');
    // Listeners
    document.getElementById('type').onchange = updateTransactionFormFields;
    document.getElementById('category').onchange = updateTransactionFormFields;
    document.getElementById('openingType').onchange = updateTransactionFormFields;
    document.getElementById('invGroup').onchange = ()=> updateInvestmentSubDropdown(document.getElementById('invGroup'), document.getElementById('invSub'));
    document.getElementById('openingGroup').onchange = ()=> updateInvestmentSubDropdown(document.getElementById('openingGroup'), document.getElementById('openingSub'));
    populateInvestmentGroupDropdowns();
    updateTransactionFormFields();
  }

  function populateInvestmentGroupDropdowns(){
    const opts = Object.keys(INVESTMENT_STRUCTURE).map(g=>`<option value="${g}">${g}</option>`).join('');
    document.getElementById('invGroup').innerHTML = '<option value="">Select Category</option>' + opts;
    document.getElementById('openingGroup').innerHTML = '<option value="">Select Category</option>' + opts;
  }
  function updateInvestmentSubDropdown(groupEl, subEl, init=null){
    const g=groupEl.value; let html='<option value="">Select Sub-Type</option>';
    if(g && INVESTMENT_STRUCTURE[g]) html += Object.keys(INVESTMENT_STRUCTURE[g]).map(s=>`<option value="${s}" ${init===s?'selected':''}>${s}</option>`).join('');
    subEl.innerHTML = html;
  }
  function updateTransactionFormFields(editEntry=null){
    const entryType = document.getElementById('type').value;
    const cat = document.getElementById('category').value;
    const openingType = document.getElementById('openingType').value;

    document.getElementById('regularFields').classList.remove('hidden');
    document.getElementById('openingBalanceRow').classList.add('hidden');
    document.getElementById('incomeSourceRow').classList.add('hidden');
    document.getElementById('investmentRow').classList.add('hidden');
    document.getElementById('insuranceRow').classList.add('hidden');
    document.getElementById('categoryContainer').classList.remove('hidden');
    document.getElementById('openingGroupContainer').classList.add('hidden');
    document.getElementById('openingSubContainer').classList.add('hidden');

    populateInvestmentGroupDropdowns();

    if(entryType==='opening_balance'){
      document.getElementById('openingBalanceRow').classList.remove('hidden');
      document.getElementById('regularFields').classList.add('hidden');
      if(openingType==='Investment'){
        document.getElementById('openingGroupContainer').classList.remove('hidden');
        document.getElementById('openingSubContainer').classList.remove('hidden');
        document.getElementById('openingGroupLabel').textContent='Investment Category';
        document.getElementById('openingSubLabel').textContent='Investment Sub-Type';
        if(editEntry){ document.getElementById('openingGroup').value=editEntry.investmentGroup||''; updateInvestmentSubDropdown(document.getElementById('openingGroup'), document.getElementById('openingSub'), editEntry.investmentSub); }
        else updateInvestmentSubDropdown(document.getElementById('openingGroup'), document.getElementById('openingSub'));
      } else {
        document.getElementById('openingSubContainer').classList.remove('hidden');
        document.getElementById('openingGroupLabel').textContent='Account Group';
        document.getElementById('openingSubLabel').textContent='Cash Account';
        document.getElementById('openingGroup').innerHTML = `<option value="Cash">Cash</option>`;
        document.getElementById('openingSub').innerHTML = `<option value="">Select Account</option>` + Object.keys(methodNames).filter(k=>k!=='credit_card').map(k=>`<option value="${k}" ${(editEntry && editEntry.method===k)?'selected':''}>${methodNames[k]}</option>`).join('');
      }
    } else if(entryType==='income'){
      document.getElementById('incomeSourceRow').classList.remove('hidden');
      document.getElementById('categoryContainer').classList.add('hidden');
    } else if(entryType==='expense'){
      if(cat==='Investments'){
        document.getElementById('investmentRow').classList.remove('hidden');
        if(editEntry){ document.getElementById('invGroup').value=editEntry.investmentGroup||''; updateInvestmentSubDropdown(document.getElementById('invGroup'), document.getElementById('invSub'), editEntry.investmentSub); }
        else updateInvestmentSubDropdown(document.getElementById('invGroup'), document.getElementById('invSub'));
      } else if(cat==='Insurance'){
        document.getElementById('insuranceRow').classList.remove('hidden');
      }
    }
  }

  // CRUD
  function uid(){ return 'id'+Date.now()+Math.random().toString(16).slice(2); }
  function requireSignedIn(){ if(!currentProfile){ alert('Please sign in to proceed.'); return false; } return true; }
  function submitForm(e,isImportOrEdit=false){
    if(!requireSignedIn()) return;
    const type = document.getElementById('type').value;
    const amount = Number(document.getElementById('amount').value);
    const date = document.getElementById('date').value;
    const desc = document.getElementById('desc').value;
    let method = document.getElementById('method').value;

    if(amount<=0 || isNaN(amount)) return alert('Please enter a valid amount.');
    if(!date) return alert('Please select a date.');
    if(!desc) return alert('Please enter a description.');

    const entry = { id: e? e.id: uid(), type, amount, date, desc, category:'', method, incomeSource:'', investmentGroup:'', investmentSub:'', insuranceType:'', insuranceFor:'' };

    if(type==='income'){
      entry.incomeSource = document.getElementById('incomeSource').value || (e? e.incomeSource:'');
      if(!entry.incomeSource && !isImportOrEdit) return alert('Please select an Income Source.');
      entry.category='N/A';
    } else if(type==='opening_balance'){
      const obType = document.getElementById('openingType').value;
      if(obType==='Cash'){
        entry.method = document.getElementById('openingSub').value || (e? e.method:'');
        entry.investmentGroup='Cash';
        entry.investmentSub = document.getElementById('openingSub').value || (e? e.investmentSub:'');
        if(!entry.method && !isImportOrEdit) return alert('Please select a cash account.');
      } else {
        entry.method='';
        entry.investmentGroup = document.getElementById('openingGroup').value || (e? e.investmentGroup:'');
        entry.investmentSub = document.getElementById('openingSub').value || (e? e.investmentSub:'');
        if(!entry.investmentGroup && !isImportOrEdit) return alert('Please select an Investment Category.');
        if(!entry.investmentSub && !isImportOrEdit) return alert('Please select an Investment Sub-Type.');
      }
      entry.category='N/A';
    } else {
      entry.category = document.getElementById('category').value || (e? e.category:'');
      if(!entry.category && !isImportOrEdit) return alert('Please select a Category.');
      if(!entry.method && !isImportOrEdit && entry.category!=='Credit Card Payment') return alert('Please select a Payment Method.');

      if(entry.category==='Investments'){
        entry.investmentGroup = document.getElementById('invGroup').value || (e? e.investmentGroup:'');
        entry.investmentSub = document.getElementById('invSub').value || (e? e.investmentSub:'');
        if(!entry.investmentGroup && !isImportOrEdit) return alert('Please select an Investment Category.');
        if(!entry.investmentSub && !isImportOrEdit) return alert('Please select an Investment Sub-Type.');
      } else if(entry.category==='Insurance'){
        entry.insuranceType = document.getElementById('insType').value || (e? e.insuranceType:'General');
        entry.insuranceFor = document.getElementById('insFor').value || (e? e.insuranceFor:'Self');
      }

      if(entry.category==='Credit Card Payment') entry.method='credit_card_payment';
    }

    if(editId){ data = data.map(t=> t.id===editId? entry: t); editId=null; document.getElementById('addBtn').classList.remove('hidden'); document.getElementById('saveBtn').classList.add('hidden'); document.getElementById('cancelBtn').classList.add('hidden'); }
    else data.push(entry);

    if(!isImportOrEdit){ saveAll(); renderAll(); clearForm(); }
  }
  document.getElementById('addBtn').addEventListener('click', ()=> submitForm());
  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const entryToEdit = data.find(t=> t.id===editId); if(entryToEdit) submitForm(entryToEdit);
  });
  document.getElementById('cancelBtn').addEventListener('click', ()=>{
    editId=null; document.getElementById('addBtn').classList.remove('hidden'); document.getElementById('saveBtn').classList.add('hidden'); document.getElementById('cancelBtn').classList.add('hidden'); clearForm();
  });

  function loadEdit(id){
    if(!requireSignedIn()) return;
    const e = data.find(t=> t.id===id); if(!e) return;
    editId = id;
    document.getElementById('type').value=e.type;
    document.getElementById('amount').value=e.amount;
    document.getElementById('date').value=e.date;
    document.getElementById('desc').value=e.desc;
    document.getElementById('category').value=e.category;
    document.getElementById('method').value=e.method;
    document.getElementById('incomeSource').value = e.incomeSource;
    document.getElementById('insType').value = e.insuranceType;
    document.getElementById('insFor').value = e.insuranceFor;

    if(e.type==='opening_balance'){
      if(e.investmentGroup && e.investmentGroup!=='Cash'){ document.getElementById('openingType').value='Investment'; }
      else { document.getElementById('openingType').value='Cash'; document.getElementById('method').value=e.method||'cash'; }
    } else if(e.type==='expense' && e.category!=='Credit Card Payment'){ document.getElementById('method').value=e.method||'cash'; }

    updateTransactionFormFields(e);

    if(e.type==='opening_balance'){
      if(document.getElementById('openingType').value==='Investment'){
        document.getElementById('openingGroup').value=e.investmentGroup||''; updateInvestmentSubDropdown(document.getElementById('openingGroup'), document.getElementById('openingSub'), e.investmentSub);
      } else document.getElementById('openingSub').value=e.method||'';
    } else if(e.type==='expense' && e.category==='Investments'){
      document.getElementById('invGroup').value=e.investmentGroup||''; updateInvestmentSubDropdown(document.getElementById('invGroup'), document.getElementById('invSub'), e.investmentSub);
    }

    document.getElementById('addBtn').classList.add('hidden');
    document.getElementById('saveBtn').classList.remove('hidden');
    document.getElementById('cancelBtn').classList.remove('hidden');
  }
  function deleteEntry(id){
    if(!requireSignedIn()) return;
    if(confirm('Delete this transaction?')){ data = data.filter(t=> t.id!==id); saveAll(); renderAll(); }
  }
  function clearForm(){
    document.getElementById('amount').value=''; document.getElementById('desc').value=''; document.getElementById('date').value=new Date().toISOString().slice(0,10);
    document.getElementById('type').value='expense'; document.getElementById('category').value='Food'; document.getElementById('method').value='cash';
    document.getElementById('incomeSource').value=''; document.getElementById('invGroup').value=''; document.getElementById('invSub').value='';
    document.getElementById('openingType').value='Cash'; document.getElementById('openingGroup').value=''; document.getElementById('openingSub').value='';
    document.getElementById('insType').value=''; document.getElementById('insFor').value='';
    updateTransactionFormFields();
  }

  // KPIs
  function fmt(n){ return (n||0).toLocaleString('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}); }
  function pct(n){ return (n||0).toFixed(1)+'%'; }
  function getNextPaymentDate(){
    const today = new Date(); const m=today.getMonth(), y=today.getFullYear(), paymentDay=10; let pay=new Date(y,m,paymentDay); if(today.getDate()>paymentDay) pay.setMonth(m+1);
    return pay.toLocaleDateString('en-IN',{month:'long'});
  }

  function renderKPIs(){
    const curMonth = new Date().getMonth(), curYear = new Date().getFullYear();
    const prevMonth = curMonth===0 ? 11 : curMonth-1, prevYear = curMonth===0 ? curYear-1 : curYear;
    const operational = data.filter(d=> d.type!=='opening_balance');
    const filterMonth = (dt,m,y)=>{ const d=new Date(dt); return d.getMonth()===m && d.getFullYear()===y; };
    const sum = arr=> arr.reduce((a,c)=> a+Number(c.amount),0);

    const curData = operational.filter(d=> filterMonth(d.date,curMonth,curYear));
    const prevData = operational.filter(d=> filterMonth(d.date,prevMonth,prevYear));

    const inc = sum(curData.filter(d=> d.type==='income'));
    const exp = sum(curData.filter(d=> d.type==='expense'));
    const prevInc = sum(prevData.filter(d=> d.type==='income'));
    const prevExp = sum(prevData.filter(d=> d.type==='expense'));

    const investments = data.filter(d=> (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
    const totalInvested = sum(investments);

    const momInc = (inc/(prevInc||1)-1)*100, momExp = (exp/(prevExp||1)-1)*100;

    document.getElementById('momIncome').innerHTML = `${momInc>=0?'▲':'▼'} ${pct(Math.abs(momInc))} vs Last Month`;
    document.getElementById('momExpense').innerHTML = `${momExp<=0?'▲':'▼'} ${pct(Math.abs(momExp))} vs Last Month`;

    const ccOpen = sum(data.filter(d=> d.type==='opening_balance' && d.method==='credit_card'));
    const ccExp = sum(data.filter(d=> d.type==='expense' && d.method==='credit_card'));
    const ccPay = sum(data.filter(d=> d.type==='expense' && d.category==='Credit Card Payment'));
    const creditCardDue = ccOpen + ccExp - ccPay;
    const ccLimit = settings.ccLimit;
    const isHigh = ccLimit ? (creditCardDue/ccLimit>0.8):false;
    document.getElementById('ccCard').style.borderColor = isHigh?'#fecaca':'#fde68a';

    document.getElementById('kpiIncome').innerText = fmt(inc);
    document.getElementById('kpiExpense').innerText = fmt(exp);
    document.getElementById('kpiNet').innerText = fmt(inc-exp);
    document.getElementById('kpiInvest').innerText = fmt(totalInvested);
    document.getElementById('kpiCCDue').innerText = fmt(creditCardDue);
    document.getElementById('ccLimitDisplay').innerText = fmt(ccLimit);
    document.getElementById('ccPaymentDate').innerText = `Next Payment: 10th of ${getNextPaymentDate()}`;

    renderNetLiquidity();
    renderInvestmentKPICharts(applyDateRangeToInvestments(investments, document.getElementById('invDateRange').value || 'all'));
  }

  function renderNetLiquidity(){
    const c = document.getElementById('netLiquidityBreakdown'); let html='';
    const liquid = data.filter(d=> (d.type==='opening_balance' && d.investmentGroup==='Cash') || (d.type==='income') || (d.type==='expense' && d.category!=='Investments'));
    const balances = liquid.reduce((acc,curr)=>{
      const key = curr.method || 'cash';
      if(key==='credit_card_payment') return acc;
      const isExp = curr.type==='expense' && curr.category!=='Credit Card Payment';
      const amt = isExp ? -Number(curr.amount): Number(curr.amount);
      acc[key] = (acc[key]||0)+amt; return acc;
    },{});
    const keys = new Set([...Object.keys(methodNames), ...Object.keys(balances)].filter(k=> k!=='credit_card_payment'));
    keys.forEach(k=>{
      if(k==='credit_card' || !k) return;
      const name = methodNames[k] || k, bal = balances[k] || 0;
      if(bal!==0 || CANONICAL_METHODS[k]) html += `<div><span>${name}</span><span>${fmt(bal)}</span></div>`;
    });
    c.innerHTML = html;
  }

  // Chart helpers
  function getColorPalette(n){
    const baseVals = ['--c1','--c2','--c3','--c4','--c5','--c6','--c7','--c8','--c9','--c10','--c11','--c12'].map(v=> getComputedStyle(document.documentElement).getPropertyValue(v).trim());
    return Array.from({length:n}, (_,i)=> baseVals[i%baseVals.length]);
  }
  function prepareMonthlyData(range){
    const monthly={}; const dates=data.map(d=> d.date);
    if(dates.length===0) return {labels:[],income:[],expense:[],investment:[]};
    const minDate = range==='all'? new Date(Math.min(...dates.map(d=> new Date(d)))) : new Date(new Date().setMonth(new Date().getMonth()-Number(range))); minDate.setDate(1);
    let cur=new Date(minDate.getFullYear(),minDate.getMonth(),1), today=new Date();
    while(cur<=today){ const k=`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`; monthly[k]={income:0,expense:0,investment:0,month:cur.toLocaleDateString('en-IN',{month:'short',year:'2-digit'})}; cur.setMonth(cur.getMonth()+1); }
    data.forEach(d=>{
      const dt = new Date(d.date), k=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      if(monthly[k]){ const a=Number(d.amount); if(d.type==='income') monthly[k].income+=a; else if(d.type==='expense'){ if(d.category==='Investments') monthly[k].investment+=a; else monthly[k].expense+=a; } }
    });
    const keys = Object.keys(monthly).sort();
    return { labels: keys.map(k=> monthly[k].month), income: keys.map(k=> monthly[k].income), expense: keys.map(k=> monthly[k].expense), investment: keys.map(k=> monthly[k].investment) };
  }
  function renderCharts(){
    const range = document.getElementById('mainChartFilter').value;
    const {labels,income,expense,investment} = prepareMonthlyData(range==='all'?'all':Number(range));
    const net = income.map((v,i)=> v - expense[i]);

    if(chartMain) chartMain.destroy();
    chartMain = new Chart(document.getElementById('mainChart').getContext('2d'), {
      data:{
        labels,
        datasets:[
          {type:'bar',label:'Income',data:income,backgroundColor:'rgba(16,185,129,0.85)',stack:'flow'},
          {type:'bar',label:'Expense',data:expense.map(e=> -e),backgroundColor:'rgba(239,68,68,0.85)',stack:'flow'},
          {type:'bar',label:'Investment',data:investment.map(i=> -i),backgroundColor:'rgba(37,99,235,0.85)',stack:'flow'},
          {type:'line',label:'Net Income',data:net,borderColor:'#0f172a',borderWidth:2,tension:0.35,pointRadius:3,fill:false}
        ]
      },
      options:{
        maintainAspectRatio:false,responsive:true,interaction:{mode:'index',intersect:false},
        scales:{ x:{stacked:true}, y:{stacked:true, ticks:{callback:(v)=> fmt(Math.abs(v)).replace('₹','₹ ')} } },
        plugins:{
          legend:{position:'top'},
          tooltip:{callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt(Math.abs(ctx.parsed.y))}` }}
        }
      }
    });

    renderWalletUnified();
  }

  // KPI Investments synced filters and visuals
  function setupInvestmentFilters(){
    const bucketSelect = document.getElementById('invBucketFilter');
    const uniqueBuckets = Array.from(new Set(Object.values(MAJOR_BUCKETS)));
    bucketSelect.innerHTML = '<option value="">Select bucket</option>' + uniqueBuckets.map(b=>`<option value="${b}">${b}</option>`).join('');
    document.getElementById('invViewMode').addEventListener('change', ()=> renderInvestmentKPICharts());
    bucketSelect.addEventListener('change', ()=> renderInvestmentKPICharts());
    document.getElementById('invDateRange').addEventListener('change', ()=> renderInvestmentKPICharts());
    document.getElementById('toggleInvBreakdown').onclick = ()=> document.getElementById('invBreakdownPanel').classList.toggle('hidden');
  }
  function applyDateRangeToInvestments(entries, range){
    if(!range || range==='all') return entries;
    const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth()-Number(range));
    return entries.filter(e=> new Date(e.date) >= cutoff);
  }
  function rollupMajorBuckets(entries){
    const byBucket = entries.reduce((acc,curr)=>{
      const group = curr.investmentGroup || 'Uncategorized';
      const bucket = MAJOR_BUCKETS[group] || 'Other';
      acc[bucket] = (acc[bucket]||0) + Number(curr.amount);
      return acc;
    },{});
    const items = Object.entries(byBucket).map(([bucket,amount])=>({bucket,amount}));
    items.sort((a,b)=> b.amount - a.amount);
    return items;
  }
  function rollupSubcategories(entries, selectedBucket){
    const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g=> MAJOR_BUCKETS[g]===selectedBucket);
    const filtered = entries.filter(e=> groupsInBucket.includes(e.investmentGroup));
    const bySub = filtered.reduce((acc,curr)=>{
      const sub = curr.investmentSub || 'General';
      acc[sub] = (acc[sub]||0) + Number(curr.amount);
      return acc;
    },{});
    const items = Object.entries(bySub).map(([sub,amount])=>({sub,amount})).sort((a,b)=> b.amount - a.amount);
    return items;
  }
  function renderInvestmentKPICharts(entriesParam=null){
    const all = entriesParam || applyDateRangeToInvestments(
      data.filter(d=> (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments')),
      document.getElementById('invDateRange').value || 'all'
    );
    const viewMode = document.getElementById('invViewMode')?.value || 'top4';
    const selectedBucket = document.getElementById('invBucketFilter')?.value || '';
    let labels=[], values=[], colors=getColorPalette(10);

    if(viewMode==='subcats' && selectedBucket){
      const items = rollupSubcategories(all, selectedBucket);
      labels = items.map(i=> i.sub); values = items.map(i=> i.amount);
      document.getElementById('invBarTitle').innerText = `Subcategory amounts (${selectedBucket})`;
      document.getElementById('invPieTitle').innerText = `Share by subcategory (${selectedBucket})`;
    } else {
      const items = rollupMajorBuckets(all); const top4=items.slice(0,4);
      labels = top4.map(i=> i.bucket); values=top4.map(i=> i.amount);
      document.getElementById('invBarTitle').innerText = 'Investment by major bucket (Top 4)';
      document.getElementById('invPieTitle').innerText = 'Share by bucket (Top 4)';
    }

    // Bar with pro styling
    if(invBreakdownBarChart) invBreakdownBarChart.destroy();
    invBreakdownBarChart = new Chart(document.getElementById('invBreakdownBar').getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Historical cost', data:values, backgroundColor: colors.map(c=> c+'cc'), borderColor: colors, borderWidth:1.5, borderRadius:6 }] },
      options:{
        maintainAspectRatio:false,responsive:true,
        plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(c)=> `${c.label}: ${fmt(c.parsed.y)}`}} },
        scales:{ y:{beginAtZero:true, grid:{color:'#eef2ff'}, ticks:{callback:(v)=> fmt(v).replace('₹','₹ ')} }, x:{grid:{display:false}} }
      }
    });

    // Donut with center text
    if(invBreakdownPieChart) invBreakdownPieChart.destroy();
    invBreakdownPieChart = new Chart(document.getElementById('invBreakdownPie').getContext('2d'), {
      type:'doughnut',
      data:{ labels, datasets:[{ data:values, backgroundColor: colors, hoverOffset:6, borderColor:'#ffffff', borderWidth:2 }] },
      options:{
        maintainAspectRatio:false,
        plugins:{
          legend:{position:'right',labels:{boxWidth:10}},
          tooltip:{callbacks:{label:(c)=>{ const total=values.reduce((a,b)=>a+b,0); const share = total? ((c.parsed/total)*100).toFixed(1):'0.0'; return `${c.label}: ${fmt(c.parsed)} (${share}%)`; }}}
        },
        cutout:'60%'
      }
    });

    renderQuickSubDropdowns(all);
  }

  // Ordered quick subs: Equity, Debt, ETFs, then others
  function renderQuickSubDropdowns(entries){
    const container = document.getElementById('invQuickSubs'); if(!container) return;
    const order = ['Equity','Debt','ETFs','Mutual Funds','Retirement','Real Estate','Commodities','Crypto','Other'];
    const items = rollupMajorBuckets(entries);
    const totals = Object.fromEntries(items.map(i=> [i.bucket, i.amount]));

    const blocks = order.filter(b=> Object.keys(totals).includes(b)).map(bucket=>{
      const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g=> MAJOR_BUCKETS[g]===bucket);
      const subsSet = new Set();
      groupsInBucket.forEach(g=> Object.keys(INVESTMENT_STRUCTURE[g]||{}).forEach(s=> subsSet.add(s)));
      const subs = Array.from(subsSet);
      const subValues = subs.map(sub=>{
        const sumAmt = entries.filter(d=>
          ((d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments')) &&
          groupsInBucket.includes(d.investmentGroup) && d.investmentSub===sub
        ).reduce((acc,c)=> acc+Number(c.amount),0);
        return {sub, amount: sumAmt};
      }).filter(x=> x.amount>0).sort((a,b)=> b.amount-a.amount);

      const dropdownHtml = subValues.length? subValues.map(x=> `<div class="dropdown-item"><span>${x.sub}</span><strong>${fmt(x.amount)}</strong></div>`).join('') : `<div class="dropdown-item"><span>No data</span><strong>—</strong></div>`;

      return `
        <div class="quick-sub-card">
          <div class="quick-sub-header">
            <div class="quick-sub-title">${bucket}</div>
            <span class="total-badge">${fmt(totals[bucket]||0)}</span>
          </div>
          <div class="dropdown" style="margin-top:8px;">
            <button class="btn-outline" style="padding:6px 10px;font-size:12px;" onclick="toggleQuickMenu(this)">View subcategories</button>
            <div class="dropdown-menu hidden" onclick="event.stopPropagation()">
              ${dropdownHtml}
            </div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = blocks;

    // Close menus on outside click
    document.addEventListener('click', ()=> {
      document.querySelectorAll('#invQuickSubs .dropdown-menu').forEach(m=> m.classList.add('hidden'));
    });
  }
  function toggleQuickMenu(btn){
    const menu = btn.parentElement.querySelector('.dropdown-menu');
    document.querySelectorAll('#invQuickSubs .dropdown-menu').forEach(m=> { if(m!==menu) m.classList.add('hidden'); });
    menu.classList.toggle('hidden');
  }

  // Recent table
  function getBadge(entry){
    if(entry.type==='income') return `<span class="badge badge-income">Income</span>`;
    if(entry.type==='opening_balance') return `<span class="badge badge-opening">${entry.investmentGroup && entry.investmentGroup!=='Cash' ? 'Asset (Inv)' : 'O.Balance'}</span>`;
    if(entry.type==='expense'){
      if(entry.category==='Investments') return `<span class="badge badge-inv">Investment</span>`;
      if(entry.category==='Insurance') return `<span class="badge badge-ins">Insurance</span>`;
      if(entry.category==='Credit Card Payment') return `<span class="badge badge-cc">CC Pay</span>`;
      return `<span class="badge badge-expense">Expense</span>`;
    }
    return `<span class="badge">—</span>`;
  }
  function renderRecentEntries(){
    const tbody = document.querySelector('#recentTable tbody');
    const limit = document.getElementById('entryLimit').value==='all'? data.length: Number(document.getElementById('entryLimit').value);
    const rows = data.slice(0,limit).map(e=>{
      const amountDisplay = (e.type==='income' || e.type==='opening_balance')? `<span style="color:var(--success);font-weight:800">+${fmt(e.amount)}</span>` : `<span style="color:var(--danger);font-weight:800">-${fmt(e.amount)}</span>`;
      let methodDisplay = '';
      if(e.type==='opening_balance' && e.investmentGroup!=='Cash') methodDisplay = e.investmentSub || e.investmentGroup;
      else if(e.type==='expense' && e.category==='Investments') methodDisplay = e.investmentSub || e.investmentGroup;
      else if(e.method==='credit_card_payment') methodDisplay = 'N/A (Transfer)';
      else methodDisplay = methodNames[e.method] || e.method || '--';

      let categoryDisplay = e.category==='Investments'? e.investmentSub :
                            e.category==='Insurance'? `${e.insuranceType} (${e.insuranceFor})` :
                            e.type==='expense'? e.category : '--';

      return `<tr>
        <td>${getBadge(e)}</td><td>${e.date}</td><td style="font-weight:800;text-align:right">${amountDisplay}</td>
        <td>${e.desc}</td><td>${categoryDisplay}</td><td>${methodDisplay}</td>
        <td class="flex-row"><button onclick="loadEdit('${e.id}')" style="background:none;border:none;color:var(--primary);cursor:pointer;padding:4px">✎</button><button onclick="deleteEntry('${e.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:4px">×</button></td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows;
  }

  // Wallet unified with improved checklist behavior
  let expenseChecklistSelection = new Set();
  function setupWalletFilters(){
    const toggle = document.getElementById('toggleChecklist');
    const menu = document.getElementById('walletCategoryChecklist');
    const container = document.getElementById('walletChecklistContainer');

    const cats = BASE_CATS.filter(c=> !['Investments','Credit Card Payment'].includes(c));
    const boxesHtml = cats.map(c=> `<label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;"><input type="checkbox" class="wallet-cat" value="${c}" /> ${c}</label>`).join('');
    menu.insertAdjacentHTML('afterbegin', boxesHtml);

    // Prevent closing when clicking inside until Apply/Clear
    toggle.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hidden'); });
    document.addEventListener('click', ()=> menu.classList.add('hidden'));

    document.getElementById('applyChecklist').addEventListener('click', (e)=>{
      e.stopPropagation();
      const checked = Array.from(document.querySelectorAll('.wallet-cat')).filter(cb=> cb.checked).map(cb=> cb.value);
      expenseChecklistSelection = new Set(checked);
      menu.classList.add('hidden');
      renderWalletUnified();
    });
    document.getElementById('clearChecklist').addEventListener('click', (e)=>{
      e.stopPropagation();
      document.querySelectorAll('.wallet-cat').forEach(cb=> cb.checked=false);
      expenseChecklistSelection.clear();
      menu.classList.add('hidden');
      renderWalletUnified();
    });

    document.getElementById('walletMode').addEventListener('change', ()=>{
      const mode = document.getElementById('walletMode').value;
      if(mode==='expenses') container.classList.remove('hidden'); else container.classList.add('hidden');
      renderWalletUnified();
    });
  }
  function renderWalletUnified(){
    const mode = document.getElementById('walletMode').value;
    const legendEl = document.getElementById('walletLegend');
    const infoEl = document.getElementById('walletInfo');
    const colors = getColorPalette(12);

    if(mode==='wallet'){
      document.getElementById('resetExpenseDrilldown').classList.add('hidden');
      const liquid = data.filter(d=> (d.type==='opening_balance' && d.investmentGroup==='Cash') || (d.type==='income') || (d.type==='expense' && d.category!=='Investments'));
      const balances = liquid.reduce((acc,curr)=>{
        const key = curr.method || 'cash';
        if(key==='credit_card_payment') return acc;
        const isExp = curr.type==='expense' && curr.category!=='Credit Card Payment';
        const amt = isExp ? -Number(curr.amount) : Number(curr.amount);
        acc[key] = (acc[key]||0)+amt; return acc;
      },{});
      const positive = Object.entries(balances).filter(([k,v])=> v>0 && k!=='credit_card').map(([k,v])=> ({label: methodNames[k]||k, balance:v})).sort((a,b)=> b.balance-a.balance);

      if(donutChart) donutChart.destroy();
      donutChart = new Chart(document.getElementById('donutChart').getContext('2d'), {
        type:'doughnut',
        data:{ labels: positive.map(b=> b.label), datasets:[{ data: positive.map(b=> b.balance), backgroundColor: getColorPalette(positive.length), hoverOffset:4 }] },
        options:{
          maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{callbacks:{ label:(ctx)=>{ const total=ctx.dataset.data.reduce((a,b)=>a+b,0); return `${ctx.label}: ${fmt(ctx.parsed)} (${total? ((ctx.parsed/total)*100).toFixed(1)+'%':'0%'})`; }}} }
        }
      });
      legendEl.innerHTML = positive.map((b,i)=> `<div style="display:flex;justify-content:space-between;"><div style="display:flex;align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:${colors[i]};margin-right:10px;"></span>${b.label}</div><span style="font-weight:800;color:#0f172a">${fmt(b.balance)}</span></div>`).join('') || '<div style="text-align:center;padding-top:20px;">No liquid cash accounts with a positive balance.</div>';
      infoEl.innerText = 'Liquid balances by account (positive only).';
    } else {
      let filtered = data.filter(d=> d.type==='expense' && d.category!=='Investments' && d.category!=='Credit Card Payment');
      if(expenseChecklistSelection.size>0){ filtered = filtered.filter(d=> expenseChecklistSelection.has(d.category)); document.getElementById('resetExpenseDrilldown').classList.remove('hidden'); }
      else document.getElementById('resetExpenseDrilldown').classList.add('hidden');

      const map = filtered.reduce((acc,c)=>{ acc[c.category]=(acc[c.category]||0)+Number(c.amount); return acc; },{});
      const sorted = Object.entries(map).sort(([,a],[,b])=> b-a).slice(0,10);
      const labels = sorted.map(([k])=> k), amounts = sorted.map(([,v])=> v);

      if(donutChart) donutChart.destroy();
      donutChart = new Chart(document.getElementById('donutChart').getContext('2d'), {
        type:'doughnut',
        data:{ labels, datasets:[{ data: amounts, backgroundColor: getColorPalette(labels.length), hoverOffset:4 }] },
        options:{
          maintainAspectRatio:false,
          plugins:{ legend:{position:'right',labels:{boxWidth:10}}, tooltip:{callbacks:{ label:(ctx)=>{ const total=amounts.reduce((a,b)=>a+b,0); return `${ctx.label}: ${fmt(ctx.parsed)} (${total? ((ctx.parsed/total)*100).toFixed(1)+'%':'0%'})`; }}} }
        }
      });

      legendEl.innerHTML = labels.map((l,i)=> `<div style="display:flex;justify-content:space-between;"><div style="display:flex;align-items:center;"><span style="width:10px;height:10px;border-radius:50%;background:${colors[i]};margin-right:10px;"></span>${l}</div><span style="font-weight:800;color:#0f172a">${fmt(amounts[i])}</span></div>`).join('') || '<div style="text-align:center;padding-top:20px;">No expenses found.</div>';
      infoEl.innerText = expenseChecklistSelection.size>0 ? 'Filtered expenses (Top 10 categories)' : 'All expenses (Top 10 categories)';
    }
  }
  function resetExpenseDrilldown(){ document.querySelectorAll('.wallet-cat').forEach(cb=> cb.checked=false); expenseChecklistSelection.clear(); renderWalletUnified(); }

  // Advanced analytics fully synced
  function renderAdvancedCharts(){
    const range = document.getElementById('dateFilter').value;
    const chartType = document.getElementById('chartType').value;
    const selectedBucket = document.getElementById('analyticsBucket').value;

    const {labels, income, expense} = prepareMonthlyData(range==='all'?'all':Number(range));
    // Net worth baseline = sum of opening balances
    const sumVals = arr=> arr.reduce((a,b)=> a + Number(b.amount||0),0);
    let baseline = sumVals(data.filter(d=> d.type==='opening_balance'));
    let netSeries = [];
    for(let i=0;i<labels.length;i++){
      const netChange = (income[i]||0) - (expense[i]||0);
      baseline += netChange;
      netSeries.push(baseline);
    }

    if(chartNetWorth) chartNetWorth.destroy();
    chartNetWorth = new Chart(document.getElementById('chartNetWorth').getContext('2d'), {
      type: chartType,
      data:{ labels, datasets:[{ label:'Cumulative Net Worth', data: netSeries, backgroundColor:'rgba(37,99,235,0.2)', borderColor:'#2563eb', borderWidth:2, tension:0.35, fill: chartType==='line' ? 'start' : false }] },
      options:{ maintainAspectRatio:false, responsive:true, scales:{ y:{ beginAtZero:false, ticks:{ callback:(v)=> fmt(v).replace('₹','₹ ') }, grid:{color:'#eef2ff'} }, x:{grid:{display:false}} },
        plugins:{ tooltip:{callbacks:{ label:(c)=> `${c.dataset.label}: ${fmt(c.parsed.y)}` }}, legend:{display:false} } }
    });

    // Investment analysis — filtered by major bucket if selected
    const investEntriesAll = data.filter(d=> (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
    const investEntriesRange = applyDateRangeToInvestments(investEntriesAll, range);
    const filteredInvest = selectedBucket ? investEntriesRange.filter(e=> MAJOR_BUCKETS[e.investmentGroup||'']===selectedBucket ) : investEntriesRange;

    const byType = filteredInvest.reduce((acc,c)=>{ const key=c.investmentGroup || 'Uncategorized'; acc[key]=(acc[key]||0)+Number(c.amount); return acc; },{});
    const typeLabels = Object.keys(byType).sort((a,b)=> byType[b]-byType[a]);
    const typeValues = typeLabels.map(l=> byType[l]);
    const colors = getColorPalette(typeLabels.length);

    if(chartInvTypesModal) chartInvTypesModal.destroy();
    chartInvTypesModal = new Chart(document.getElementById('chartInvTypesModal').getContext('2d'), {
      type:'bar',
      data:{ labels:typeLabels, datasets:[{ label:'Investment by type (historical cost)', data:typeValues, backgroundColor: colors.map(c=> c+'cc'), borderColor: colors, borderWidth:1.5, borderRadius:6 }] },
      options:{ maintainAspectRatio:false, responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{ label:(c)=> `${c.label}: ${fmt(c.parsed.y)}` }} }, scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=> fmt(v).replace('₹','₹ ') }, grid:{color:'#eef2ff'} }, x:{grid:{display:false}} } }
    });

    const pts = filteredInvest.map(i=> ({date:new Date(i.date), amount:Number(i.amount)})).sort((a,b)=> a.date-b.date);
    let cumulative=0; const growthLabels = pts.map(p=> p.date.toLocaleDateString('en-IN',{month:'short',year:'2-digit'})); const growthValues = pts.map(p=> { cumulative+=p.amount; return cumulative; });
    if(chartInvGrowthModal) chartInvGrowthModal.destroy();
    chartInvGrowthModal = new Chart(document.getElementById('chartInvGrowthModal').getContext('2d'), {
      type:'line',
      data:{ labels:growthLabels, datasets:[{ label:'Cumulative invested (historical cost)', data:growthValues, borderColor:'#1d4ed8', borderWidth:2, tension:0.35, pointRadius:0 }] },
      options:{ maintainAspectRatio:false, responsive:true, plugins:{ legend:{position:'top'}, tooltip:{callbacks:{ label:(c)=> `${c.dataset.label}: ${fmt(c.parsed.y)}` }} }, scales:{ y:{ beginAtZero:false, ticks:{ callback:(v)=> fmt(v).replace('₹','₹ ') }, grid:{color:'#eef2ff'} }, x:{grid:{display:false}} } }
    });
  }

  // Settings
  function renderSettings(){
    const m = document.getElementById('methodEditor');
    m.innerHTML = Object.entries(methodNames).map(([key,name])=> `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <input type="text" value="${name}" data-key="${key}" onchange="updateMethodName(this)" style="flex:1;margin-right:10px;padding:8px;border-radius:8px;border:1px solid #e5e7eb" />
        <button class="btn-danger" style="padding:6px 10px;font-size:11px" onclick="deleteMethod('${key}')">Remove</button>
      </div>
    `).join('');
    const i = document.getElementById('incomeList');
    i.innerHTML = incomeSources.map(source=> `<span style="border:1px solid var(--border);padding:4px 8px;border-radius:8px;font-size:12px;display:inline-flex;align-items:center;background:#f8fafc">${source}<button style="background:none;border:none;color:var(--danger);margin-left:6px;padding:0;line-height:1;cursor:pointer;" onclick="deleteIncome('${source}')">×</button></span>`).join('');
    document.getElementById('ccLimitInput').value = settings.ccLimit;
  }
  document.getElementById('addMethod').addEventListener('click', addMethod);
  document.getElementById('addIncomeBtn').addEventListener('click', addIncome);
  document.getElementById('saveCCLimit').addEventListener('click', ()=>{
    const limit = Number(document.getElementById('ccLimitInput').value);
    if(limit>0){ settings.ccLimit=limit; saveAll(); renderKPIs(); alert('Credit Card Limit saved.'); } else alert('Enter a valid credit card limit.');
  });
  function updateMethodName(el){ const key=el.dataset.key, name=el.value.trim(); if(name && key){ methodNames[key]=name; saveAll(); renderAll(); } }
  function deleteMethod(key){ if(confirm(`Remove method "${methodNames[key]}"?`)){ delete methodNames[key]; saveAll(); renderAll(); } }
  function addMethod(){ const input=document.getElementById('newMethod'); const name=input.value.trim(); if(name){ const key=toKey(name); if(!methodNames[key]){ methodNames[key]=name; input.value=''; saveAll(); renderAll(); } else alert('Method already exists.'); } }
  function deleteIncome(source){ if(confirm(`Remove income source "${source}"?`)){ incomeSources = incomeSources.filter(s=> s!==source); saveAll(); renderAll(); } }
  function addIncome(){ const input=document.getElementById('newIncome'); const source=input.value.trim(); if(source && !incomeSources.includes(source)){ incomeSources.push(source); input.value=''; saveAll(); renderAll(); } else if(source) alert('Income source already exists.'); }

  // Import/Export
  function convertToCSV(rows){
    const headers = ['id','type','amount','date','desc','category','method','income_source','investment_group','investment_sub','insurance_type','insurance_for'];
    const out = [headers.join(',')].concat(rows.map(obj=> headers.map(h=>{
      const mapKey = h.replace('_',''); let val = obj[h] ?? obj[mapKey] ?? '';
      if(typeof val==='string' && val.includes(',')) return `"${val.replace(/"/g,'""')}"`;
      return val;
    }).join(','))).join('\n');
    const blob = new Blob([out], {type:'text/csv;charset=utf-8;'}); const link=document.createElement('a');
    const url = URL.createObjectURL(blob); link.href=url; link.download='MoneyMirror_Export.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }
  function processImportedData(){
    const file = document.getElementById('importFile').files[0]; if(!file) return alert('Please select a file.');
    const reader = new FileReader();
    reader.onload = (e)=>{
      const content = e.target.result; let imported=[];
      if(file.name.endsWith('.json')){ try{ imported=JSON.parse(content); }catch(err){ return alert('Error parsing JSON: '+err.message); } }
      else if(file.name.endsWith('.csv')) imported = parseCSV(content);
      else return alert('Unsupported file type. Use CSV or JSON.');
      if(!imported || imported.length===0) return alert('No valid data found in the file.');
      let added=0;
      imported.forEach(item=>{
        const entry = { id:uid(), type:(item.type||'expense').toLowerCase().trim(), amount:Number(item.amount), date:item.date||new Date().toISOString().slice(0,10), desc:item.desc||item.description||'', category:item.category||'Misc', method:item.method? toKey(item.method):'cash', incomeSource:item.income_source||item.incomeSource||'', investmentGroup:item.investment_group||item.investmentGroup||'', investmentSub:item.investment_sub||item.investmentSub||'', insuranceType:item.insurance_type||item.insuranceType||'', insuranceFor:item.insurance_for||item.insuranceFor||'' };
        if(entry.amount>0 && entry.desc){ data.push(entry); added++; }
      });
      saveAll(); renderAll(); document.getElementById('importModal').classList.remove('open'); alert(`Successfully imported ${added} entries.`);
    };
    reader.readAsText(file);
  }
  function parseCSV(txt){
    const lines = txt.split('\n').filter(l=> l.trim()!==''); if(lines.length<2) return [];
    const headers = lines[0].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h=> h.replace(/"/g,'').toLowerCase().trim());
    const rows=[]; for(let i=1;i<lines.length;i++){
      const vals = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); if(!vals || vals.length!==headers.length) continue;
      const obj={}; for(let j=0;j<headers.length;j++){ let v = vals[j]? vals[j].replace(/^"|"$/g,'').replace(/""/g,'"') :''; obj[headers[j]] = v; } rows.push(obj);
    }
    return rows;
  }

  // Sample data
  function loadSampleData(){
    if(!confirm("This will overwrite all existing data for your current profile. Continue?")) return;
    function randBetween(min,max){ return Math.floor(Math.random()*(max-min+1)+min); }
    function pick(arr){ return arr[randBetween(0,arr.length-1)]; }
    function dateInLastMonths(r){ const today=new Date(); const m=randBetween(r[0], r[1]||r[0]); const d=new Date(today); d.setMonth(today.getMonth()-m); const max=new Date(d.getFullYear(), d.getMonth()+1,0).getDate(); d.setDate(randBetween(1,max)); return d.toISOString().slice(0,10); }

    data=[]; methodNames={...CANONICAL_METHODS}; incomeSources=['Salary (Primary)','Freelance Income','Investment Income']; settings.ccLimit=200000;

    // Opening balances
    data.push({id:uid(), type:'opening_balance', amount:60000, date:dateInLastMonths([6,6]), desc:'Initial Salary Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:20000, date:dateInLastMonths([6,6]), desc:'Initial Savings Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Savings)', method:'savings_acct', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:5000, date:dateInLastMonths([6,6]), desc:'Initial Cash Balance', investmentGroup:'Cash', investmentSub:'Cash', method:'cash', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:30000, date:dateInLastMonths([11,12]), desc:'Existing Equity Portfolio', investmentGroup:'Equity (Stocks)', investmentSub:'India - Large Cap/Mid Cap/Small Cap', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:55000, date:dateInLastMonths([11,12]), desc:'Existing Gold ETF', investmentGroup:'ETFs', investmentSub:'Gold ETF', method:'', category:'N/A'});
    data.push({id:uid(), type:'opening_balance', amount:110000, date:dateInLastMonths([12,12]), desc:'Fixed Deposit', investmentGroup:'Fixed Income / Savings Schemes', investmentSub:'FD (Fixed Deposit)', method:'', category:'N/A'});

    // Income
    for(let i=0;i<6;i++){
      data.push({
        id:uid(), type:'income', amount:randBetween(90000,180000),
        incomeSource:'Salary (Primary)', method:'salary_acct',
        date:dateInLastMonths([i+1,i+1]), desc:'Monthly Salary'
      });
    }

    // Expenses
    const expenseCats=['Rent','Food','Utilities','Shopping','Entertainment','Travel','Health','Insurance'];
    const methods=['salary_acct','savings_acct','cash','credit_card'];
    for(let i=0;i<50;i++){
      const cat=pick(expenseCats);
      const ranges={
        'Rent':[18000,40000],'Food':[800,5000],'Utilities':[800,4000],
        'Shopping':[1000,12000],'Entertainment':[500,4000],
        'Travel':[2000,25000],'Health':[800,6000],'Insurance':[1500,6000]
      };
      const amount=randBetween(ranges[cat][0], ranges[cat][1]);
      const method=pick(methods);
      let insType='',insFor='';
      if(cat==='Insurance'){ insType=pick(['Health','Life']); insFor=pick(['Self','Family']); }

      data.push({
        id:uid(), type:'expense', amount, date:dateInLastMonths([1,6]),
        desc:`Payment for ${cat}`, category:cat, method,
        incomeSource:'', investmentGroup:'', investmentSub:'',
        insuranceType:insType, insuranceFor:insFor
      });
    }

    // Investment expenses
    const invGroups = Object.keys(INVESTMENT_STRUCTURE);
    for(let i=0;i<15;i++){
      const group=pick(invGroups);
      const sub=pick(Object.keys(INVESTMENT_STRUCTURE[group]));
      const amount=randBetween(2000,15000);
      const method=pick(['salary_acct','savings_acct']);

      data.push({
        id:uid(), type:'expense', amount, date:dateInLastMonths([1,6]),
        desc:`SIP in ${sub}`, category:'Investments', method,
        incomeSource:'', investmentGroup:group, investmentSub:sub,
        insuranceType:'', insuranceFor:''
      });
    }

    // Credit card payment
    data.push({
      id:uid(), type:'expense', amount:randBetween(15000,40000),
      date:dateInLastMonths([1,2]),
      desc:'Credit Card bill payment', category:'Credit Card Payment',
      method:'salary_acct', incomeSource:'', investmentGroup:'',
      investmentSub:'', insuranceType:'', insuranceFor:''
    });

    saveAll();
    renderAll();
    alert('Sample data loaded.');
  }

  // Calculator logic
  let currentInput='0', previousInput='', operator=null, isNewInput=true;

  function updateDisplay(){
    document.getElementById('calc-display').innerText = currentInput;
    const expr = `${previousInput||''}${operator||''}${isNewInput?'':currentInput}`;
    document.getElementById('calc-preview').innerText =
      (previousInput && operator) ? expr : (currentInput!=='0' ? currentInput : 'Enter an expression…');
  }

  function handleCalculatorInput(e){
    const v = e.target.innerText;

    if(v>='0' && v<='9'){
      if(isNewInput){ currentInput=v; isNewInput=false; } else { currentInput += v; }
    } else if(v==='.') {
      if(!currentInput.includes('.')) currentInput += '.';
    } else if(v==='AC'){
      currentInput='0'; previousInput=''; operator=null; isNewInput=true;
    } else if(v==='±'){
      const n=parseFloat(currentInput); if(!isNaN(n)) currentInput=(n*-1).toString();
    } else if(v==='%'){
      const n=parseFloat(currentInput); if(!isNaN(n)) currentInput=(n/100).toString();
    } else if(['+','-','*','/'].includes(v)){
      if(previousInput && operator && !isNewInput){ calculate(); previousInput=currentInput; }
      else previousInput=currentInput;
      operator=v; isNewInput=true;
    } else if(v==='='){
      calculate(); previousInput=''; operator=null; isNewInput=true;
    }

    updateDisplay();

    // Autofill amount if empty
    const amtEl=document.getElementById('amount');
    if(amtEl && (amtEl.value==='0'||amtEl.value==='')){
      const num=parseFloat(currentInput); if(!isNaN(num)) amtEl.value=num;
    }
  }

  function calculate(){
    const cur=parseFloat(currentInput), prev=parseFloat(previousInput);
    if(isNaN(prev)||isNaN(cur)||!operator) return;
    let res=0;
    switch(operator){
      case '+': res=prev+cur; break;
      case '-': res=prev-cur; break;
      case '*': res=prev*cur; break;
      case '/':
        if(cur===0){ alert('Division by zero not allowed.'); res='Error'; }
        else res=prev/cur;
        break;
    }
    currentInput = res==='Error' ? '0' : parseFloat(res.toFixed(5)).toString();
    isNewInput=true;
  }

  // Drag behavior
  function dragElement(el){
    let pos1=0,pos2=0,pos3=0,pos4=0;
    const header=document.getElementById('calc-header');
    if(header) header.onmousedown = dragMouseDown;

    function dragMouseDown(e){
      e.preventDefault();
      pos3=e.clientX; pos4=e.clientY;
      document.onmouseup = closeDrag;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e){
      e.preventDefault();
      pos1=pos3 - e.clientX; pos2=pos4 - e.clientY;
      pos3=e.clientX; pos4=e.clientY;
      el.style.top=(el.offsetTop - pos2)+'px';
      el.style.left=(el.offsetLeft - pos1)+'px';
    }
    function closeDrag(){
      document.onmouseup=null;
      document.onmousemove=null;
    }
  }
</script>
</body>
</html>
