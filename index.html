<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — v5.2.0 (Ultimate Edition)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    /**
     * --------------------------------------------------------------------------
     * FIREBASE CONFIGURATION
     * --------------------------------------------------------------------------
     * Note: If Firebase fails to init (e.g., running locally without a server),
     * the app will automatically fall back to LocalStorage.
     */
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
    };

    let db = null;
    let auth = null;
    let USE_FIRESTORE = false;
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v5_pro'; 
    let currentProfile = null;

    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
      console.log("Firebase initialized.");
    } catch (e) {
      console.warn("Firebase init failed, utilizing LocalStorage engine:", e);
    }

    // --- AUTHENTICATION LOGIC ---
    async function signInWithGoogle() {
      if (!auth) return alert('Auth not initialized. Ensure internet connection.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        onUserSignedIn(result.user);
      } catch (err) {
        console.error("Login failed:", err);
        alert('Login failed. Check console for details.');
      }
    }

    function onUserSignedIn(user) {
      currentProfile = user.displayName || user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      
      // UI Updates
      document.getElementById('profileNameDisplay').textContent = currentProfile;
      document.getElementById('authGate').style.display = 'none';
      document.querySelector('main').style.filter = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      
      // Load Data
      loadProfileData();
    }

    function signOutUser() {
      if (!auth) return;
      auth.signOut().then(() => {
        currentProfile = null;
        document.getElementById('profileNameDisplay').textContent = '--';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('authGate').style.display = 'flex';
        document.querySelector('main').style.filter = 'blur(5px)';
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
      document.getElementById('logoutBtn').addEventListener('click', signOutUser);
      
      // Check for persisted session
      if (auth) {
        auth.onAuthStateChanged(user => {
          if (user) onUserSignedIn(user);
          else {
            document.getElementById('authGate').style.display = 'flex';
            document.querySelector('main').style.filter = 'blur(5px)';
            document.getElementById('logoutBtn').style.display = 'none';
          }
        });
      }
    });
  </script>

  <style>
    /* --------------------------------------------------------------------------
       CSS VARIABLES & RESET
       -------------------------------------------------------------------------- */
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      
      --text-main: #1e293b;
      --text-muted: #64748b;
      
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f97316;
      --border: #cbd5e1;
      
      --inv-bg: #e0f2fe;
      --inv-text: #075985;
      --opening-balance: #6b21a8;
      --cc-bg: #fffbeb;
      --cc-text: #b45309;
    }

    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      background: var(--bg-color); 
      color: var(--text-main); 
      height: 100vh; 
      display: flex; 
      overflow: hidden; 
    }

    /* --------------------------------------------------------------------------
       SIDEBAR
       -------------------------------------------------------------------------- */
    aside { 
      width: 260px; 
      background: var(--sidebar-bg); 
      display: flex; 
      flex-direction: column; 
      padding: 24px 16px; 
      color: white; 
      flex-shrink: 0; 
      transition: all 0.3s; 
      justify-content: space-between; 
      z-index: 100; 
    }
    
    main { 
      flex: 1; 
      overflow-y: auto; 
      padding: 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 24px; 
      position: relative; 
      filter: blur(5px); 
    }

    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }
    
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    /* --------------------------------------------------------------------------
       MOBILE MENU
       -------------------------------------------------------------------------- */
    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    /* --------------------------------------------------------------------------
       AUTH GATE OVERLAY
       -------------------------------------------------------------------------- */
    #authGate {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      gap: 6px; color: white; text-align: center;
      padding: 0 24px;
    }
    #authGate .line-1 { font-size: 22px; font-weight: 600; margin: 0; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; margin: 0; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    /* --------------------------------------------------------------------------
       BUTTONS & INPUTS
       -------------------------------------------------------------------------- */
    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }

    /* --------------------------------------------------------------------------
       GRID & CARDS
       -------------------------------------------------------------------------- */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); }

    /* KPI STYLES */
    .kpi-card { padding: 20px; min-height: 160px; justify-content: flex-start; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px; }
    
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    
    .breakdown-list { margin-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px; font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
    .breakdown-item { display: flex; justify-content: space-between; align-items: center; }

    /* FORM LAYOUTS */
    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; }
    .input-group-med { width: 25%; }
    .input-group-large { width: 45%; }
    .full-width { width: 100%; }
    .flex-row { display: flex; gap: 10px; align-items: center; }
    .hidden { display: none !important; }

    /* TABLES */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    /* --------------------------------------------------------------------------
       MODALS
       -------------------------------------------------------------------------- */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1200px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
    .modal-pad { padding: 24px; }
    .modal-small { width: 400px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --------------------------------------------------------------------------
       CALCULATOR WIDGET
       -------------------------------------------------------------------------- */
    #calculator {
      position: fixed; bottom: 20px; right: 20px;
      width: 280px; height: 440px;
      z-index: 3000;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #f8fafc;
      border: 1px solid var(--border);
      display: none; 
      flex-direction: column; overflow: hidden;
    }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-display { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; }
    #calc-buttons button:hover { background: #f1f5f9; }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .calc-clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .calc-equals { grid-row: span 2; background: var(--primary) !important; color: white !important; }

    /* --------------------------------------------------------------------------
       RESPONSIVE DESIGN
       -------------------------------------------------------------------------- */
    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-1 { grid-column: span 1; }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }

    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; }
      aside nav, .sidebar-footer { display: none; } 
      #mobileMenuBtn { display: block; }
      
      aside.mobile-open nav { 
        display: block; position: absolute; top: 60px; left: 0; right: 0; 
        background: var(--sidebar-bg); padding: 20px; z-index: 501;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
      }
      aside.mobile-open .sidebar-footer { display: block; position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 501; }

      .dashboard-grid { grid-template-columns: 1fr; gap: 16px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
      
      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer { width: 100% !important; }
      
      #calculator { top: 70px; left: 50%; transform: translateX(-50%); width: 90%; }
    }
  </style>
</head>
<body>

<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror – Ultimate Edition</p>
  <p class="line line-3">Personal Finance & Analytics</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
</div>

<aside id="mainSidebar">
  <div style="width:100%">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
        MoneyMirror <span>v5.2</span>
      </div>
      <button id="mobileMenuBtn">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main Menu</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced Analytics</div>
      </div>

      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
      </div>
    </nav>
  </div>

  <div class="sidebar-footer">
    <div class="sys-stat">
      <span>Profile</span>
      <span class="sys-val" id="profileNameDisplay">--</span>
    </div>
  </div>
</aside>

<main>

  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h1 style="margin:0; font-size:24px; font-weight:700">Financial Overview</h1>
      <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
    </div>
    <div class="flex-row">
      <button class="btn-outline" id="sampleBtn">Load Sample</button>
      <button class="btn-primary" id="importDataBtn">Import Data</button>
      <button class="btn-outline" id="exportBtn">Export CSV</button>
      <div id="calc-toggle" title="Calculator" style="cursor:pointer; padding:8px; background:var(--primary); color:white; border-radius:6px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="14" x2="12.01" y2="14"></line><line x1="8" y1="10" x2="8.01" y2="10"></line><line x1="16" y1="10" x2="16.01" y2="10"></line></svg>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--success)">Monthly Income</div>
      <div class="kpi-value" id="kpiIncome">₹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--danger)">Monthly Expenses</div>
      <div class="kpi-value" id="kpiExpense">₹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    
    <div class="card kpi-card col-span-1" id="ccCard" style="border-color:var(--cc-text); background:var(--cc-bg)">
      <div class="card-title" id="ccTitle" style="color:var(--cc-text)">Credit Card Due</div>
      <div class="kpi-value" id="kpiCCDue">₹0</div>
      <div class="kpi-sub" style="margin-top:6px;">
        <span id="ccPaymentDate">Next: 10th Jan</span>
        <span style="font-weight:600; margin-left:10px;">Limit: <span id="ccLimitDisplay">₹0</span></span>
      </div>
    </div>
    
    <div class="card kpi-card col-span-1" style="background:var(--inv-bg); border-color:var(--inv-text);">
      <div class="card-title" style="color:var(--inv-text)">Total Investment Value</div>
      <div class="kpi-value" id="kpiInvest">₹0</div>
      <div class="breakdown-list" id="investBreakdownList" style="color:var(--inv-text)"></div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Cash Flow & Net Income</div>
        <select id="mainChartFilter" onchange="renderCharts()">
          <option value="6">Last 6 Months</option>
          <option value="12">Last 12 Months</option>
          <option value="all">All Time</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:320px; width:100%; position:relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Distribution Analysis</div>
        <select id="pieChartFilter" onchange="renderMergedDonut()">
            <option value="wallets">Liquid Wallets (Assets)</option>
            <option value="expenses">Expense Categories</option>
            <option value="investment_alloc">Investment Allocation</option>
        </select>
      </div>
      <div class="card-body" style="display:flex; flex-direction:row; align-items:center; gap:20px; flex:1">
        <div style="height:280px; width:50%; max-width: 280px; position:relative;">
          <canvas id="donutChart"></canvas>
        </div>
        <div id="donutLegend" style="font-size:12px; color:var(--text-muted); flex:1; display:flex; flex-direction:column; gap:8px; max-height:280px; overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card action-card col-span-4" id="addEntryCard">
      <div class="action-header">
        <div class="card-title">Add New Entry</div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </div>
      <div class="action-body">
        
        <div class="input-group-small">
          <label>Type</label>
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="opening_balance">Opening Balance</option>
          </select>
        </div>
        <div class="input-group-small">
          <label>Amount (₹)</label>
          <input id="amount" type="number" placeholder="0.00" style="font-weight:700; font-size:16px" step="any" />
        </div>
        <div class="input-group-small">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div class="input-group-large">
          <label>Description</label>
          <input id="desc" placeholder="What is this for?" style="flex:1" />
        </div>
        
        <div id="dynamicFieldsContainer" class="full-width" style="border-top:1px solid var(--border); padding-top:15px; margin-top:10px;">
          
          <div id="regularFields" style="display:flex; gap:20px; flex-wrap:wrap">
            <div id="categoryContainer" class="input-group-small">
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div class="input-group-small">
              <label>Method / Account</label>
              <select id="method"></select>
            </div>
            
            <div id="incomeSourceRow" class="hidden input-group-small">
              <label>Source</label>
              <select id="incomeSource"></select>
            </div>
            
            <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="input-group-small">
                <label>Inv. Category</label>
                <select id="invGroup"></select> 
              </div>
              <div class="input-group-small">
                <label>Inv. Sub-Type</label>
                <select id="invSub"></select> 
              </div>
            </div>

            <div id="insuranceRow" class="hidden input-group-med">
              <label>Insurance Details</label>
              <div class="flex-row">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">Insured</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>
          
          <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-small"> 
              <label>Asset Type</label> 
              <select id="openingType">
                <option value="Cash">Cash (Liquid)</option>
                <option value="Investment">Investment Asset</option>
              </select> 
            </div> 
            <div class="input-group-small" id="openingGroupContainer">
              <label id="openingGroupLabel">Category</label> 
              <select id="openingGroup"></select> 
            </div>
            <div class="input-group-small" id="openingSubContainer">
              <label id="openingSubLabel">Sub-Type</label> 
              <select id="openingSub"></select> 
            </div>
          </div>
        </div>

        <div style="width:100%; display:flex; gap:10px; margin-top:10px">
          <button class="btn-primary" id="addBtn">Add Entry</button>
          <button class="btn-primary hidden" id="saveBtn">Save Changes</button>
          <button class="btn-outline hidden" id="cancelBtn">Cancel Edit</button>
        </div>
      </div>
    </div>

    <div class="card col-span-4">
      <div class="card-header">
        <div class="card-title">Recent Transactions</div>
        <select id="entryLimit" onchange="renderRecentEntries()">
            <option value="10">Last 10</option>
            <option value="25">Last 25</option>
            <option value="50">Last 50</option>
            <option value="all">All</option>
        </select>
      </div>
      <div class="card-body table-container">
        <table id="recentTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Description</th>
              <th>Category</th>
              <th>Method</th>
              <th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card col-span-4">
      <div class="card-header">
        <div class="card-title">Investment Portfolio Breakdown (Historical Cost)</div>
      </div>
      <div class="card-body table-container">
        <table id="invTable">
          <thead>
            <tr>
              <th>Investment Category</th>
              <th>Sub-Type</th>
              <th style="text-align:right">Historical Cost</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<div id="settingsModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Settings & Configuration</div>
      <button class="btn-outline" id="closeSettings" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Credit Card Limit</label>
        <div class="flex-row">
          <input id="ccLimitInput" type="number" placeholder="Set Limit (e.g. 13000)" />
          <button class="btn-primary" id="saveCCLimit">Save Limit</button>
        </div>
      </div>
      <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px">
        <label style="color:var(--danger)">Danger Zone</label>
        <div class="flex-row">
          <button class="btn-danger" id="resetBtn">Factory Reset Profile</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Advanced Financial Analytics</div>
      <button class="btn-outline" id="closeAnalytics" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad" id="analyticsContent">
      <div id="analyticsFilters" style="margin-bottom:20px;">
        <label>Date Range</label>
        <select id="dateFilter" onchange="renderAdvancedCharts()" style="max-width:200px;">
          <option value="6">Last 6 Months</option>
          <option value="12">Last 12 Months</option>
          <option value="all">All Time</option>
        </select>
      </div>
      
      <div class="dashboard-grid">
          <div class="card col-span-4">
            <div class="card-header"><div class="card-title">Cumulative Net Worth Growth</div></div>
            <div class="card-body">
              <div style="height:350px; width:100%; position:relative">
                <canvas id="chartNetWorth"></canvas>
              </div>
            </div>
          </div>
          
          <div class="card col-span-2">
            <div class="card-header"><div class="card-title">Investments by Category</div></div>
            <div class="card-body">
                <div style="height:300px; width:100%; position:relative">
                    <canvas id="chartInvBreakdown"></canvas>
                </div>
            </div>
          </div>
          <div class="card col-span-2">
            <div class="card-header"><div class="card-title">Investments by Sub-Type</div></div>
            <div class="card-body">
                <div style="height:300px; width:100%; position:relative">
                    <canvas id="chartInvSub"></canvas>
                </div>
            </div>
          </div>
      </div>
    </div>
  </div>
</div>

<div id="importModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Import Data</div>
      <button class="btn-outline" id="closeImport" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <h4 style="margin-top:0;">Import from CSV/JSON</h4>
      <input type="file" id="importFile" accept=".csv,.json" style="width:100%; margin:10px 0 20px 0;" />
      <button class="btn-primary full-width" id="processImportBtn">Process File</button>
    </div>
  </div>
</div>

<div id="calculator">
  <div id="calc-header">
    <span>Calculator</span>
    <button id="calc-close-btn" style="background:transparent; border:none; color:white; font-size:20px;">×</button>
  </div>
  <div id="calc-display">0</div>
  <div id="calc-buttons">
    <button class="calc-clear">AC</button>
    <button class="calc-clear">±</button>
    <button class="calc-clear">%</button>
    <button class="calc-operator">/</button>
    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button class="calc-operator">*</button>
    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button class="calc-operator">-</button>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="calc-operator">+</button>
    <button style="grid-column: span 2">0</button>
    <button>.</button>
    <button class="calc-equals">=</button>
  </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // UTILS & CONSTANTS
    // -------------------------------------------------------------------------
    const DEFAULT_CC_LIMIT = 13000;
    
    // Core Accounts mapping
    const CANONICAL_METHODS = {
      'cash': 'Cash',
      'salary_acct': 'Bank Account (Salary)',
      'savings_acct': 'Bank Account (Savings)',
      'credit_card': 'Credit Card',
      'digital_wallet': 'Digital Wallet'
    };
    
    // Categories
    const BASE_CATS = ['Food', 'Rent', 'Utilities', 'Shopping', 'Entertainment', 'Travel', 'Health', 'Investments', 'Insurance', 'Credit Card Payment', 'Misc'];

    // Detailed Investment Taxonomy
    const INVESTMENT_STRUCTURE = {
        'Equity (Stocks)': {
            'India - Large Cap/Mid Cap': 'Equity',
            'India - Derivatives': 'Equity',
            'US - Stocks': 'Equity',
        },
        'Mutual Funds': {
            'Equity MF - Large/Mid/Small': 'Mutual Funds',
            'Debt MF - Liquid/Bond': 'Mutual Funds',
            'ELSS (Tax Saving)': 'Mutual Funds',
        },
        'ETFs': {
            'Equity ETF': 'ETFs',
            'Gold ETF': 'ETFs',
        },
        'Bonds & Debt': {
            'SGB (Sovereign Gold Bond)': 'Bonds',
            'Corporate Bonds': 'Bonds',
            'FD (Fixed Deposit)': 'Fixed Income',
            'PPF': 'Fixed Income',
        },
        'Commodities': {
            'Gold (Physical)': 'Commodities',
            'Silver': 'Commodities',
        },
        'Crypto': {
            'Bitcoin': 'Crypto',
            'Ethereum': 'Crypto',
            'Altcoins': 'Crypto',
        },
        'Real Estate': {
            'Residential': 'Real Estate',
            'REITs': 'Real Estate',
        }
    };

    // State Variables
    let data = [];
    let methodNames = {...CANONICAL_METHODS};
    let incomeSources = ['Salary', 'Freelance', 'Interest'];
    let settings = { ccLimit: DEFAULT_CC_LIMIT };
    let editId = null;

    // Chart Instances
    let chartMain = null;
    let donutChart = null;
    let chartNetWorth = null;
    let chartInvBreakdown = null;
    let chartInvSub = null;

    // DOM Elements Cache
    const formEls = {
      type: document.getElementById('type'),
      amount: document.getElementById('amount'),
      date: document.getElementById('date'),
      desc: document.getElementById('desc'),
      category: document.getElementById('category'),
      method: document.getElementById('method'),
      incomeSource: document.getElementById('incomeSource'),
      invGroup: document.getElementById('invGroup'),
      invSub: document.getElementById('invSub'),
      openingType: document.getElementById('openingType'),
      openingGroup: document.getElementById('openingGroup'), 
      openingSub: document.getElementById('openingSub'),
      insType: document.getElementById('insType'),
      insFor: document.getElementById('insFor'),
      
      addBtn: document.getElementById('addBtn'),
      saveBtn: document.getElementById('saveBtn'),
      cancelBtn: document.getElementById('cancelBtn'),
    };

    // -------------------------------------------------------------------------
    // INITIALIZATION
    // -------------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
      // Set Default Date
      const d = new Date();
      document.getElementById('currentDate').innerText = d.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('date').value = d.toISOString().slice(0,10);
      
      // Initialize Draggable Calculator
      dragElement(document.getElementById("calculator"));

      // Event Listeners: Mobile Menu
      const mobileBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('mainSidebar');
      mobileBtn.addEventListener('click', () => sidebar.classList.toggle('mobile-open'));
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => sidebar.classList.remove('mobile-open'));
      });
      
      // Event Listeners: Modals
      document.getElementById('navSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.add('open'));
      document.getElementById('closeSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.remove('open'));
      
      document.getElementById('navAnalytics').addEventListener('click', () => {
          document.getElementById('analyticsModal').classList.add('open');
          renderAdvancedCharts();
      });
      document.getElementById('closeAnalytics').addEventListener('click', () => document.getElementById('analyticsModal').classList.remove('open'));
      
      document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importModal').classList.add('open'));
      document.getElementById('closeImport').addEventListener('click', () => document.getElementById('importModal').classList.remove('open'));
      
      // Event Listeners: Calculator
      document.getElementById('calc-toggle').addEventListener('click', () => {
          const calc = document.getElementById('calculator');
          calc.style.display = calc.style.display === 'none' ? 'flex' : 'none';
      });
      document.getElementById('calc-close-btn').addEventListener('click', () => document.getElementById('calculator').style.display = 'none');
      document.querySelectorAll('#calc-buttons button').forEach(button => button.addEventListener('click', handleCalculatorInput));
      
      // Event Listeners: Action Buttons
      document.getElementById('sampleBtn').addEventListener('click', loadSampleData);
      document.getElementById('exportBtn').addEventListener('click', () => convertToCSV(data));
      document.getElementById('processImportBtn').addEventListener('click', processImportedData);
      document.getElementById('saveCCLimit').addEventListener('click', saveCCLimit);
      document.getElementById('resetBtn').addEventListener('click', () => {
          if (confirm('WARNING: This will factory reset all data locally. Continue?')) {
              localStorage.clear();
              window.location.reload();
          }
      });
      
      // Initial Data Load
      loadProfileData();
    });

    // -------------------------------------------------------------------------
    // DATA LAYER (LocalStorage + Firestore)
    // -------------------------------------------------------------------------
    function getTxKey() { return currentProfile ? `mm_data_${currentProfile}` : 'mm_data_default'; }
    function getMethodKey() { return currentProfile ? `mm_methods_${currentProfile}` : 'mm_methods_default'; }
    function getSettingsKey() { return currentProfile ? `mm_settings_${currentProfile}` : 'mm_settings_default'; }
    function toKey(name) { return name.toLowerCase().replace(/[^a-z0-9]+/g, '_'); }

    function saveAll() {
      // 1. Save Local
      localStorage.setItem(getTxKey(), JSON.stringify(data));
      localStorage.setItem(getMethodKey(), JSON.stringify(methodNames));
      localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
      
      // 2. Save Cloud (if available)
      if (USE_FIRESTORE && db && currentProfile) {
        db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).set({
          data, methodNames, settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(e => console.error("Cloud Save Failed:", e));
      }
    }

    async function loadProfileData() {
      // 1. Load Local
      methodNames = JSON.parse(localStorage.getItem(getMethodKey())) || {...CANONICAL_METHODS};
      data = JSON.parse(localStorage.getItem(getTxKey())) || [];
      settings = JSON.parse(localStorage.getItem(getSettingsKey())) || { ccLimit: DEFAULT_CC_LIMIT };
      
      // 2. Load Cloud
      if (USE_FIRESTORE && db && currentProfile) {
        try {
          const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).get();
          if (doc.exists) {
            const serverData = doc.data();
            data = serverData.data || data;
            methodNames = serverData.methodNames || methodNames;
            settings = serverData.settings || settings;
          }
        } catch (e) { console.error("Cloud Load Failed:", e); }
      }
      
      // 3. Normalize Data types
      data = data.map(d => ({
        ...d,
        amount: Number(d.amount),
        investmentGroup: d.investmentGroup || '',
        investmentSub: d.investmentSub || ''
      }));

      renderAll();
    }

    // -------------------------------------------------------------------------
    // RENDER CONTROLLER
    // -------------------------------------------------------------------------
    function renderAll() {
      data.sort((a,b) => new Date(b.date) - new Date(a.date));
      setupDropdowns();
      updateTransactionFormFields();
      renderKPIs();
      renderCharts();
      renderRecentEntries();
      renderInvTable();
      document.getElementById('ccLimitInput').value = settings.ccLimit;
    }

    function setupDropdowns() {
      // Populate Account Methods
      formEls.method.innerHTML = Object.keys(methodNames).filter(k=>k!=='credit_card').map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');
      
      // Populate Income Sources
      formEls.incomeSource.innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');
      
      // Populate Categories
      formEls.category.innerHTML = BASE_CATS.map(c => `<option value="${c}">${c}</option>`).join('');
      
      // Populate Investment Groups
      const invOptions = '<option value="">Select Category</option>' + Object.keys(INVESTMENT_STRUCTURE).map(g => `<option value="${g}">${g}</option>`).join('');
      formEls.invGroup.innerHTML = invOptions;
      formEls.openingGroup.innerHTML = invOptions;
      
      // Add Change Listeners for Cascading Dropdowns
      formEls.type.onchange = () => updateTransactionFormFields();
      formEls.category.onchange = () => updateTransactionFormFields();
      formEls.openingType.onchange = () => updateTransactionFormFields();
      formEls.invGroup.onchange = () => updateSubDropdown(formEls.invGroup, formEls.invSub);
      formEls.openingGroup.onchange = () => updateSubDropdown(formEls.openingGroup, formEls.openingSub);
    }
    
    function updateSubDropdown(groupEl, subEl, val=null) {
        const grp = groupEl.value;
        if(grp && INVESTMENT_STRUCTURE[grp]) {
            subEl.innerHTML = '<option value="">Select Sub-Type</option>' + Object.keys(INVESTMENT_STRUCTURE[grp]).map(s => `<option value="${s}" ${val===s?'selected':''}>${s}</option>`).join('');
        } else {
            subEl.innerHTML = '<option value="">Select Sub-Type</option>';
        }
    }

    function updateTransactionFormFields(editEntry = null){
        const type = formEls.type.value;
        const cat = formEls.category.value;
        const opType = formEls.openingType.value;
        
        // Hide all dynamic rows first
        ['regularFields', 'openingBalanceRow', 'incomeSourceRow', 'investmentRow', 'insuranceRow'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('categoryContainer').classList.add('hidden');
        document.getElementById('openingGroupContainer').classList.add('hidden');
        document.getElementById('openingSubContainer').classList.add('hidden');

        if(type === 'opening_balance'){
            document.getElementById('openingBalanceRow').classList.remove('hidden');
            if(opType === 'Investment') {
                document.getElementById('openingGroupContainer').classList.remove('hidden');
                document.getElementById('openingSubContainer').classList.remove('hidden');
                document.getElementById('openingGroupLabel').textContent = 'Investment Category';
                document.getElementById('openingSubLabel').textContent = 'Sub-Type';
                if(!editEntry) updateSubDropdown(formEls.openingGroup, formEls.openingSub);
            } else {
                document.getElementById('openingSubContainer').classList.remove('hidden');
                document.getElementById('openingGroupLabel').textContent = 'Account';
                document.getElementById('openingSubLabel').textContent = 'Account Name';
                // Use Liquid methods for Cash OB
                formEls.openingGroup.innerHTML = '<option value="Cash">Cash</option>';
                formEls.openingSub.innerHTML = Object.keys(methodNames).filter(k=>k!=='credit_card').map(k=>`<option value="${k}">${methodNames[k]}</option>`).join('');
            }
        } else if (type === 'income') {
             document.getElementById('regularFields').classList.remove('hidden');
             document.getElementById('incomeSourceRow').classList.remove('hidden');
        } else if (type === 'expense') {
             document.getElementById('regularFields').classList.remove('hidden');
             document.getElementById('categoryContainer').classList.remove('hidden');
             
             if(cat === 'Investments') document.getElementById('investmentRow').classList.remove('hidden');
             else if(cat === 'Insurance') document.getElementById('insuranceRow').classList.remove('hidden');
        }
    }

    // -------------------------------------------------------------------------
    // FORM CRUD OPERATIONS
    // -------------------------------------------------------------------------
    function uid() { return 'id' + Date.now() + Math.random().toString(16).slice(2); }

    function submitForm(e) {
      if(!currentProfile) return alert('Please sign in first.');
      const type = formEls.type.value;
      const amount = Number(formEls.amount.value);
      if(amount <= 0 || isNaN(amount)) return alert('Please enter a valid positive amount.');
      
      const entry = {
          id: e ? e.id : uid(),
          type, amount, date: formEls.date.value, desc: formEls.desc.value,
          category: 'N/A', method: formEls.method.value, incomeSource: '', investmentGroup: '', investmentSub: ''
      };
      
      // Mapping Fields based on Type
      if(type === 'income') {
          entry.incomeSource = formEls.incomeSource.value;
      } else if(type === 'opening_balance') {
          if(formEls.openingType.value === 'Cash') {
              entry.investmentGroup = 'Cash';
              entry.method = formEls.openingSub.value; 
              entry.investmentSub = formEls.openingSub.value;
          } else {
              entry.method = '';
              entry.investmentGroup = formEls.openingGroup.value;
              entry.investmentSub = formEls.openingSub.value;
          }
      } else { // Expense
          entry.category = formEls.category.value;
          if(entry.category === 'Investments') {
              entry.investmentGroup = formEls.invGroup.value;
              entry.investmentSub = formEls.invSub.value;
          }
          if(entry.category === 'Credit Card Payment') {
              entry.method = 'credit_card_payment';
          }
          if(entry.category === 'Insurance') {
              entry.insuranceType = document.getElementById('insType').value;
              entry.insuranceFor = document.getElementById('insFor').value;
          }
      }

      // Add or Edit
      if(editId) {
          data = data.map(d => d.id === editId ? entry : d);
          editId = null;
      } else {
          data.push(entry);
      }
      
      clearForm();
      saveAll();
      renderAll();
    }

    formEls.addBtn.addEventListener('click', () => submitForm());
    formEls.saveBtn.addEventListener('click', () => submitForm(data.find(d=>d.id===editId)));
    formEls.cancelBtn.addEventListener('click', clearForm);

    function clearForm() {
        editId = null;
        formEls.amount.value = ''; formEls.desc.value = ''; formEls.type.value = 'expense';
        formEls.addBtn.classList.remove('hidden');
        formEls.saveBtn.classList.add('hidden');
        formEls.cancelBtn.classList.add('hidden');
        updateTransactionFormFields();
    }

    function loadEdit(id) {
        const e = data.find(d => d.id === id);
        if(!e) return;
        editId = id;
        formEls.type.value = e.type; formEls.amount.value = e.amount;
        formEls.date.value = e.date; formEls.desc.value = e.desc;
        
        // Restore dynamic state
        if(e.type === 'opening_balance') {
            formEls.openingType.value = (e.investmentGroup === 'Cash') ? 'Cash' : 'Investment';
            updateTransactionFormFields(e);
            if(e.investmentGroup === 'Cash') formEls.openingSub.value = e.investmentSub;
            else {
                formEls.openingGroup.value = e.investmentGroup;
                updateSubDropdown(formEls.openingGroup, formEls.openingSub, e.investmentSub);
            }
        } else {
            formEls.category.value = e.category || 'Food';
            formEls.method.value = e.method;
            if(e.type === 'income') formEls.incomeSource.value = e.incomeSource;
            updateTransactionFormFields(e);
            if(e.category === 'Investments') {
                formEls.invGroup.value = e.investmentGroup;
                updateSubDropdown(formEls.invGroup, formEls.invSub, e.investmentSub);
            }
        }
        
        formEls.addBtn.classList.add('hidden');
        formEls.saveBtn.classList.remove('hidden');
        formEls.cancelBtn.classList.remove('hidden');
    }

    function deleteEntry(id) {
        if(confirm('Are you sure you want to delete this entry?')) {
            data = data.filter(d => d.id !== id);
            saveAll();
            renderAll();
        }
    }

    // -------------------------------------------------------------------------
    // KPI CALCULATIONS & RENDERING
    // -------------------------------------------------------------------------
    function fmt(n) { return (n || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
    function sum(arr) { return arr.reduce((acc,curr) => acc + Number(curr.amount), 0); }

    function renderKPIs(){
      const curMonth = new Date().getMonth();
      const curYear = new Date().getFullYear();
      const prevMonth = curMonth === 0 ? 11 : curMonth - 1;
      const prevYear = curMonth === 0 ? curYear - 1 : curYear;
      
      const filterMonth = (d, m, y) => { const dt = new Date(d); return dt.getMonth()===m && dt.getFullYear()===y; };
      
      const opData = data.filter(d => d.type !== 'opening_balance');
      const curData = opData.filter(d => filterMonth(d.date, curMonth, curYear));
      const prevData = opData.filter(d => filterMonth(d.date, prevMonth, prevYear));

      const inc = sum(curData.filter(d=>d.type==='income'));
      const exp = sum(curData.filter(d=>d.type==='expense'));
      const prevInc = sum(prevData.filter(d=>d.type==='income'));
      const prevExp = sum(prevData.filter(d=>d.type==='expense'));

      // Investments: Opening Balance (Inv) + Expense (Inv)
      const invs = data.filter(d => (d.type==='opening_balance' && d.investmentGroup && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
      const totalInv = sum(invs);

      // Month over Month Logic
      const momInc = (inc / (prevInc || 1) - 1) * 100;
      const momExp = (exp / (prevExp || 1) - 1) * 100;
      
      document.getElementById('kpiIncome').innerText = fmt(inc);
      document.getElementById('kpiExpense').innerText = fmt(exp);
      document.getElementById('momIncome').innerHTML = `<span class="${momInc>=0?'trend-up':'trend-down'}">${momInc.toFixed(1)}%</span> vs Last Month`;
      document.getElementById('momExpense').innerHTML = `<span class="${momExp<=0?'trend-up':'trend-down'}">${momExp.toFixed(1)}%</span> vs Last Month`;
      
      // Credit Card Logic
      const ccOpen = sum(data.filter(d => d.type === 'opening_balance' && d.method === 'credit_card'));
      const ccExp = sum(data.filter(d => d.type === 'expense' && d.method === 'credit_card'));
      const ccPay = sum(data.filter(d => d.type === 'expense' && d.category === 'Credit Card Payment'));
      const creditCardDue = ccOpen + ccExp - ccPay;
      
      document.getElementById('kpiCCDue').innerText = fmt(creditCardDue);
      document.getElementById('ccLimitDisplay').innerText = fmt(settings.ccLimit);
      document.getElementById('ccCard').classList.toggle('trend-down', (creditCardDue/settings.ccLimit) > 0.8);

      // Investment Breakdown List
      document.getElementById('kpiInvest').innerText = fmt(totalInv);
      
      const invGroups = invs.reduce((acc, curr) => {
          const g = curr.investmentGroup || 'Other';
          acc[g] = (acc[g] || 0) + curr.amount;
          return acc;
      }, {});
      
      const sortedGroups = Object.entries(invGroups).sort((a,b) => b[1] - a[1]);
      const top3 = sortedGroups.slice(0, 3);
      const others = sortedGroups.slice(3).reduce((acc, curr) => acc + curr[1], 0);
      
      let breakdownHtml = top3.map(item => `
        <div class="breakdown-item">
            <span>${item[0]}</span>
            <span style="font-weight:600">${fmt(item[1])}</span>
        </div>
      `).join('');
      
      if(others > 0) breakdownHtml += `<div class="breakdown-item"><span style="color:var(--text-muted)">Others</span><span>${fmt(others)}</span></div>`;
      
      document.getElementById('investBreakdownList').innerHTML = breakdownHtml || '<span style="font-size:11px; color:var(--text-muted)">No active investments.</span>';
    }

    // -------------------------------------------------------------------------
    // CHART RENDERING LOGIC
    // -------------------------------------------------------------------------
    function renderCharts() {
        // --- 1. Main Mixed Chart (Net Income Line + Income/Exp Bars) ---
        const range = document.getElementById('mainChartFilter').value;
        const bucket = {};
        const today = new Date();
        let startDate = new Date();
        
        // Date Filtering Logic
        if(range !== 'all') startDate.setMonth(today.getMonth() - parseInt(range));
        else {
             const dates = data.map(d=>d.date);
             startDate = dates.length ? new Date(Math.min(...dates.map(d=>new Date(d)))) : new Date();
        }
        startDate.setDate(1);

        // Fill buckets with empty data to ensure continuity
        let ptr = new Date(startDate);
        while(ptr <= today) {
            const k = ptr.toISOString().slice(0, 7); // YYYY-MM
            bucket[k] = { inc: 0, exp: 0 };
            ptr.setMonth(ptr.getMonth() + 1);
        }

        // Aggregate Data
        data.forEach(d => {
            const k = d.date.slice(0, 7);
            if(bucket[k]) {
                if(d.type === 'income') bucket[k].inc += d.amount;
                if(d.type === 'expense') bucket[k].exp += d.amount;
            }
        });

        const labels = Object.keys(bucket).sort();
        const incData = labels.map(k => bucket[k].inc);
        const expData = labels.map(k => bucket[k].exp);
        const netData = labels.map(k => bucket[k].inc - bucket[k].exp);
        const displayLabels = labels.map(k => new Date(k+'-01').toLocaleDateString('en-IN', {month:'short', year:'2-digit'}));

        if(chartMain) chartMain.destroy();
        chartMain = new Chart(document.getElementById('mainChart'), {
            type: 'bar',
            data: {
                labels: displayLabels,
                datasets: [
                    { type: 'line', label: 'Net Income', data: netData, borderColor: '#3b82f6', tension: 0.3, borderWidth: 2, pointRadius: 3 },
                    { type: 'bar', label: 'Income', data: incData, backgroundColor: '#10b981' },
                    { type: 'bar', label: 'Expense', data: expData, backgroundColor: '#ef4444' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        
        renderMergedDonut();
    }

    // --- 2. Distribution Pie Chart ---
    function renderMergedDonut() {
        const filter = document.getElementById('pieChartFilter').value;
        let pData = {};
        let labelFn = (k) => k;
        let emptyMsg = "No data available";

        if(filter === 'wallets') {
            // Liquid Wallets: (Opening Cash + Income) - Expenses(non-inv)
            const liquid = data.filter(d => (d.type==='opening_balance' && d.investmentGroup==='Cash') || d.type==='income' || (d.type==='expense' && d.category!=='Investments'));
            pData = liquid.reduce((acc, c) => {
                const k = c.method === 'credit_card_payment' ? null : (c.method || 'cash');
                if(!k || k === 'credit_card') return acc; 
                const amt = (c.type === 'expense') ? -c.amount : c.amount;
                acc[k] = (acc[k] || 0) + amt;
                return acc;
            }, {});
            labelFn = (k) => methodNames[k] || k;
            emptyMsg = "No liquid cash balances.";

        } else if(filter === 'expenses') {
            const exps = data.filter(d => d.type==='expense' && d.category!=='Investments' && d.category!=='Credit Card Payment');
            pData = exps.reduce((acc, c) => { acc[c.category] = (acc[c.category] || 0) + c.amount; return acc; }, {});
            emptyMsg = "No expenses recorded.";

        } else if(filter === 'investment_alloc') {
            const invs = data.filter(d => (d.type==='opening_balance' && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
            pData = invs.reduce((acc, c) => { acc[c.investmentGroup] = (acc[c.investmentGroup] || 0) + c.amount; return acc; }, {});
            emptyMsg = "No investments recorded.";
        }

        const items = Object.entries(pData).filter(x => x[1] > 0).sort((a,b) => b[1] - a[1]);
        const labels = items.map(x => labelFn(x[0]));
        const values = items.map(x => x[1]);
        const colors = ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f59e0b'];

        if(donutChart) donutChart.destroy();
        donutChart = new Chart(document.getElementById('donutChart'), {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: values, backgroundColor: colors, hoverOffset: 4 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Custom Legend Generation
        const legEl = document.getElementById('donutLegend');
        if(items.length === 0) legEl.innerHTML = `<div style="text-align:center; margin-top:20px;">${emptyMsg}</div>`;
        else {
            legEl.innerHTML = items.map((x, i) => `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center;">
                        <span style="width:10px; height:10px; border-radius:50%; background:${colors[i % colors.length]}; margin-right:8px"></span>
                        ${labelFn(x[0])}
                    </div>
                    <span style="font-weight:600">${fmt(x[1])}</span>
                </div>
            `).join('');
        }
    }

    // -------------------------------------------------------------------------
    // ADVANCED ANALYTICS (Modal)
    // -------------------------------------------------------------------------
    function renderAdvancedCharts() {
        const allDates = data.map(d => d.date);
        if(allDates.length === 0) return;
        
        // 1. Cumulative Net Worth
        const startDate = new Date(Math.min(...allDates.map(d=>new Date(d))));
        const endDate = new Date();
        const dateRangeFilter = document.getElementById('dateFilter').value;
        const filterDate = new Date();
        if(dateRangeFilter !== 'all') filterDate.setMonth(endDate.getMonth() - parseInt(dateRangeFilter));
        
        const dailyChange = {};
        data.forEach(d => {
            let val = 0;
            if (d.type === 'opening_balance' || d.type === 'income') val = d.amount;
            else if (d.type === 'expense' && d.category !== 'Investments' && d.category !== 'Credit Card Payment') val = -d.amount;
            dailyChange[d.date] = (dailyChange[d.date] || 0) + val;
        });

        const nwLabels = []; const nwData = [];
        let runningTotal = 0;
        let ptr = new Date(startDate);
        while(ptr <= endDate) {
            const k = ptr.toISOString().slice(0, 10);
            if(dailyChange[k]) runningTotal += dailyChange[k];
            
            if(dateRangeFilter === 'all' || ptr >= filterDate) {
                nwLabels.push(k);
                nwData.push(runningTotal);
            }
            ptr.setDate(ptr.getDate() + 1);
        }
        
        if(chartNetWorth) chartNetWorth.destroy();
        chartNetWorth = new Chart(document.getElementById('chartNetWorth'), {
            type: 'line',
            data: {
                labels: nwLabels,
                datasets: [{ label: 'Net Worth', data: nwData, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, pointRadius: 0, borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. Investment Breakdowns (Category & Sub-Type)
        const invs = data.filter(d => (d.type==='opening_balance' && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
        
        const grpData = invs.reduce((a,c) => { a[c.investmentGroup] = (a[c.investmentGroup]||0)+c.amount; return a; }, {});
        if(chartInvBreakdown) chartInvBreakdown.destroy();
        chartInvBreakdown = new Chart(document.getElementById('chartInvBreakdown'), {
            type: 'pie',
            data: { labels: Object.keys(grpData), datasets: [{ data: Object.values(grpData), backgroundColor: ['#0ea5e9','#22c55e','#eab308','#f97316','#6366f1'] }] },
            options: { maintainAspectRatio: false }
        });
        
        const subData = invs.reduce((a,c) => { a[c.investmentSub] = (a[c.investmentSub]||0)+c.amount; return a; }, {});
        if(chartInvSub) chartInvSub.destroy();
        chartInvSub = new Chart(document.getElementById('chartInvSub'), {
            type: 'bar',
            data: { labels: Object.keys(subData), datasets: [{ label: 'Value', data: Object.values(subData), backgroundColor: '#3b82f6' }] },
            options: { maintainAspectRatio: false, indexAxis: 'y' }
        });
    }

    // -------------------------------------------------------------------------
    // CALCULATOR LOGIC
    // -------------------------------------------------------------------------
    let calcExpression = "";
    
    function handleCalculatorInput(e) {
        const val = e.target.innerText;
        
        if(val === 'AC') {
            calcExpression = "";
        } else if (val === '=') {
            try {
                // Warning: eval used for lightweight math evaluation
                const res = eval(calcExpression); 
                calcExpression = res.toString();
            } catch {
                calcExpression = "Error";
            }
        } else if (val === '±') {
            // Not implemented for string expression
        } else if (val === '%') {
             calcExpression += "/100";
        } else {
            // Accumulate input
            calcExpression += val;
        }
        
        // Visual Update
        document.getElementById('calc-display').innerText = calcExpression || "0";
        
        // Auto-fill form
        if(val === '=' && calcExpression !== "Error") {
            document.getElementById('amount').value = parseFloat(calcExpression);
        }
    }

    // -------------------------------------------------------------------------
    // HELPER TABLES
    // -------------------------------------------------------------------------
    function renderRecentEntries() {
        const limit = document.getElementById('entryLimit').value;
        const subset = limit === 'all' ? data : data.slice(0, parseInt(limit));
        
        const rows = subset.map(d => {
            let badge = '';
            if(d.type==='income') badge = 'badge-income';
            else if(d.type==='opening_balance') badge = 'badge-opening';
            else if(d.category==='Investments') badge = 'badge-inv';
            else if(d.category==='Credit Card Payment') badge = 'badge-cc';
            else badge = 'badge-expense';

            return `
              <tr>
                <td><span class="badge ${badge}">${d.type==='opening_balance'?'OB':d.type}</span></td>
                <td>${d.date}</td>
                <td style="font-weight:bold; color:${d.type==='income'||d.type==='opening_balance'?'var(--success)':'var(--danger)'}">
                  ${d.type==='expense'?'-':'+'}${fmt(d.amount)}
                </td>
                <td>${d.desc}</td>
                <td>${d.category==='Investments'?d.investmentSub:d.category}</td>
                <td>${methodNames[d.method] || d.method || '-'}</td>
                <td>
                  <button style="background:none; color:var(--primary); padding:0 5px;" onclick="loadEdit('${d.id}')">✎</button>
                  <button style="background:none; color:var(--danger); padding:0 5px;" onclick="deleteEntry('${d.id}')">×</button>
                </td>
              </tr>
            `;
        }).join('');
        document.querySelector('#recentTable tbody').innerHTML = rows;
    }

    function renderInvTable() {
         const invs = data.filter(d => (d.type==='opening_balance' && d.investmentGroup!=='Cash') || (d.type==='expense' && d.category==='Investments'));
         const grouped = invs.reduce((acc, c) => {
             const key = c.investmentGroup + '|' + c.investmentSub;
             acc[key] = (acc[key] || 0) + c.amount;
             return acc;
         }, {});
         
         const rows = Object.entries(grouped).sort((a,b) => b[1] - a[1]).map(entry => {
             const [grp, sub] = entry[0].split('|');
             return `<tr><td>${grp}</td><td>${sub}</td><td style="text-align:right; font-weight:bold">${fmt(entry[1])}</td></tr>`;
         }).join('');
         
         document.querySelector('#invTable tbody').innerHTML = rows || '<tr><td colspan="3" style="text-align:center">No active investments found.</td></tr>';
    }

    function saveCCLimit() {
        const val = document.getElementById('ccLimitInput').value;
        if(val) {
            settings.ccLimit = Number(val);
            saveAll();
            renderKPIs();
            alert('CC Limit Saved');
        }
    }

    // -------------------------------------------------------------------------
    // FILE IO & SAMPLE DATA
    // -------------------------------------------------------------------------
    function processImportedData() {
        const file = document.getElementById('importFile').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(Array.isArray(json)) {
                    data = [...data, ...json];
                    saveAll();
                    renderAll();
                    document.getElementById('importModal').classList.remove('open');
                    alert('Import Successful');
                }
            } catch(err) { alert('Invalid JSON file'); }
        };
        reader.readAsText(file);
    }
    
    function convertToCSV(objArray) {
        if(!objArray || !objArray.length) return;
        const array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
        let str = Object.keys(array[0]).join(',') + '\r\n';
        for (let i = 0; i < array.length; i++) {
            let line = '';
            for (let index in array[i]) {
                if (line != '') line += ','
                line += array[i][index];
            }
            str += line + '\r\n';
        }
        const link = document.createElement("a");
        link.setAttribute("href", "data:text/csv;charset=utf-8," + encodeURIComponent(str));
        link.setAttribute("download", "moneymirror_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function loadSampleData() {
        if(!confirm('This will overwrite current data with sample data. Continue?')) return;
        data = [];
        // Opening Balances
        data.push({id:'s1', type:'opening_balance', amount:50000, date:'2023-01-01', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct'});
        data.push({id:'s2', type:'opening_balance', amount:250000, date:'2023-01-01', investmentGroup:'Equity (Stocks)', investmentSub:'India - Large Cap/Mid Cap', method:''});
        data.push({id:'s3', type:'opening_balance', amount:100000, date:'2023-01-01', investmentGroup:'Mutual Funds', investmentSub:'Equity MF - Large/Mid/Small', method:''});
        
        // Generate 6 Months of Data
        for(let i=1; i<=6; i++) {
            const m = i.toString().padStart(2,'0');
            // Income
            data.push({id:`inc${i}`, type:'income', amount:120000, date:`2023-${m}-01`, incomeSource:'Salary', method:'salary_acct'});
            // Expenses
            data.push({id:`exp${i}a`, type:'expense', amount:25000, date:`2023-${m}-05`, category:'Rent', method:'salary_acct'});
            data.push({id:`exp${i}b`, type:'expense', amount:8000, date:`2023-${m}-10`, category:'Food', method:'credit_card'});
            data.push({id:`exp${i}c`, type:'expense', amount:5000, date:`2023-${m}-15`, category:'Utilities', method:'savings_acct'});
            // Investment SIP
            data.push({id:`inv${i}`, type:'expense', amount:20000, date:`2023-${m}-20`, category:'Investments', investmentGroup:'Mutual Funds', investmentSub:'Equity MF - Large/Mid/Small', method:'salary_acct'});
        }
        saveAll();
        renderAll();
    }
    
    // Draggable Helper Function
    function dragElement(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        document.getElementById(elmnt.id + "-header").onmousedown = dragMouseDown;
        function dragMouseDown(e) { e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
        function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }
</script>
</body>
</html>
