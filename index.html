<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyMirror Financial Dashboard v4.6</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* CSS from style.css integrated here */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --background: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border: #dee2e6;
            --sidebar-width: 280px;
            --sidebar-background: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-active: #34495e;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* ------------------ Sidebar ------------------ */
        aside {
            width: var(--sidebar-width);
            background-color: var(--sidebar-background);
            color: var(--sidebar-text);
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 1000;
        }

        .brand {
            font-size: 20px;
            font-weight: 700;
            padding: 0 20px 20px 20px;
            color: var(--primary-color);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-muted);
        }

        nav {
            flex-grow: 1;
            padding-top: 20px;
        }

        .nav-group {
            margin-bottom: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 5px 20px;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 15px;
            gap: 12px;
        }

        .nav-item:hover {
            background-color: var(--sidebar-active);
        }

        .nav-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .nav-item.active svg {
            color: white;
        }

        .nav-item svg {
            color: var(--sidebar-text);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
        }

        .sys-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sys-val {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* ------------------ Main Content ------------------ */
        main {
            margin-left: var(--sidebar-width);
            padding: 20px;
            flex-grow: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .profile-select label {
            font-weight: 600;
            margin-right: 10px;
        }

        #profileSelect {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* ------------------ Widgets & Cards ------------------ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .widget.span-2 {
            grid-column: span 2;
        }

        .widget.span-4 {
            grid-column: span 4;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .net-worth-display {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .net-worth-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .text-danger {
            color: var(--danger);
        }

        /* ------------------ Transaction Form ------------------ */
        .transaction-form .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .transaction-form input,
        .transaction-form select,
        .transaction-form button {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            flex-grow: 1;
        }

        .transaction-form button {
            cursor: pointer;
            flex-grow: 0.5;
        }
        
        /* ------------------ Buttons ------------------ */
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-danger:hover {
            background-color: #a71d2a;
        }
        
        .full-width {
            width: 100%;
        }


        /* ------------------ Transactions Table ------------------ */
        .transaction-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .transaction-table th, .transaction-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .transaction-table th {
            background-color: var(--background);
            font-weight: 600;
            color: var(--text-color);
            text-transform: uppercase;
            font-size: 12px;
        }

        .transaction-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .transaction-table .delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
        }

        /* ------------------ Modals ------------------ */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-background);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-small {
            max-width: 400px;
        }

        .action-header {
            background-color: var(--primary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-header .card-title {
            color: white;
            margin-bottom: 0;
        }

        .modal-pad {
            padding: 20px;
        }
        
        .settings-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--border);
        }
        
        .settings-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .settings-group h3 {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        #newCategoryInput {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            width: 60%;
            margin-right: 10px;
        }
        
        #categoryListDisplay span {
            display: inline-block;
            background-color: var(--background);
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px;
            font-size: 13px;
        }
        
        /* Calculator Styles */
        #calc-toggle {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            background-color: var(--background);
            transition: background-color 0.2s;
        }
        
        #calc-toggle:hover {
            background-color: var(--border);
        }
        
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .calc-btn {
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background-color: #e0e0e0;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        
        .calc-btn:hover {
            background-color: #d0d0d0;
        }
        
        .calc-btn.op-btn {
            background-color: var(--warning);
            color: white;
            font-weight: 700;
        }
        
        .calc-btn.op-btn:hover {
            background-color: #cc9c00;
        }
        
        .calc-btn.span-2 {
            grid-column: span 2;
        }
    </style>
</head>
<body>

    <aside>
        <div>
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
                MoneyMirror <span>v4.6</span>
            </div>

            <nav>
                <div class="nav-group">
                    <div class="nav-label">Core View</div>
                    <div class="nav-item active">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Dashboard
                    </div>
                    <div class="nav-item" id="navAnalytics">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8l-5 5-2.2-2.2-6.5 6.5"></path></svg>
                        Advanced Analytics
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Data Administration</div>
                    <div class="nav-item" id="navDataMgmt">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Data Management
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-label">System & User</div>
                    <div class="nav-item" id="navSwitchProfile">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        Switch Profile
                    </div>
                    <div class="nav-item" id="navSettings">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        Settings & Backup
                    </div>
                </div>
            </nav>
        </div>

        <div class="sidebar-footer">
            <div class="sys-stat">
                <span>Current Profile</span>
                <span class="sys-val" id="profileNameDisplay">--</span>
            </div>
            <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v4.6.0 • Sidebar & Data Mgmt Update</div>
        </div>
    </aside>
    <main>
        <header>
            <div class="profile-select">
                <label for="profileSelect">Profile:</label>
                <select id="profileSelect"></select>
            </div>
            <div class="flex-row">
                <button class="btn-outline" id="sampleBtn">Load Sample</button>
                <div id="calc-toggle">
                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="14" x2="12.01" y2="14"></line><line x1="8" y1="10" x2="8.01" y2="10"></line><line x1="16" y1="10" x2="16.01" y2="10"></line></svg>
                </div>
            </div>
        </header>

        <section class="dashboard-grid">
            <div class="widget card span-2">
                <div class="card-title">Net Worth Overview</div>
                <div class="net-worth-display" id="netWorthDisplay">0.00</div>
                <div class="net-worth-sub">Last updated: <span id="lastUpdated">N/A</span></div>
            </div>

            <div class="widget card">
                <div class="card-title">Total Income (YTD)</div>
                <div class="stat-value" id="totalIncome">0.00</div>
            </div>

            <div class="widget card">
                <div class="card-title">Total Expenses (YTD)</div>
                <div class="stat-value text-danger" id="totalExpenses">0.00</div>
            </div>

            <div class="widget card transaction-form span-2">
                <div class="card-title">New Transaction</div>
                <form id="transactionForm">
                    <div class="form-row">
                        <input type="text" id="description" placeholder="Description" required>
                        <select id="type" required>
                            <option value="">Type</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                        <input type="number" id="amount" placeholder="Amount" step="0.01" required>
                    </div>
                    <div class="form-row">
                        <select id="category" required>
                            <option value="">Category</option>
                        </select>
                        <input type="date" id="date" required>
                        <button type="submit" class="btn-primary">Add Transaction</button>
                    </div>
                </form>
            </div>

            <div class="widget card transaction-table span-4">
                <div class="card-title">Recent Transactions</div>
                <table id="recentTransactionsTable">
                    <thead>
                        <tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th>Amount</th><th>Action</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <div class="widget card span-2">
                <div class="card-title">Expense Distribution</div>
                <canvas id="categoryChart"></canvas>
            </div>
            
            <div class="widget card span-2">
                <div class="card-title">Net Balance History</div>
                <canvas id="balanceChart"></canvas>
            </div>

        </section>

    </main>
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="action-header">
                <div class="card-title">System Settings</div>
                <button class="btn-outline" id="closeSettings">Close</button>
            </div>
            <div class="modal-pad">
                <div class="settings-group">
                    <h3>Profile Management</h3>
                    <button class="btn-outline" id="newProfileBtn">Create New Profile</button>
                    <button class="btn-outline" id="deleteProfileBtn" style="margin-left: 10px;">Delete Current Profile</button>
                </div>
                
                <div class="settings-group">
                    <h3>Category Configuration</h3>
                    <p>Add new categories to the list:</p>
                    <input type="text" id="newCategoryInput" placeholder="New Category Name">
                    <button class="btn-primary" id="addCategoryBtn">Add Category</button>
                    <div id="categoryListDisplay" style="margin-top: 10px;"></div>
                </div>

                <div class="settings-group">
                    <h3>Data Operations (Deprecated)</h3>
                    <p style="color:var(--danger);">These functions are now moved to the **Data Management** panel in the sidebar (v4.6).</p>
                    <button class="btn-primary" id="importDataBtn" style="display:none;">Import CSV/JSON</button>
                    <button class="btn-outline" id="exportBtn" style="display:none;">Export Data (CSV)</button>
                    <button class="btn-danger" id="resetBtn" style="display:none;">Factory Reset</button>
                </div>

            </div>
        </div>
    </div>
    
    <div id="calculatorModal" class="modal">
        <div class="modal-content modal-small">
            <div class="action-header" style="border-radius:12px 12px 0 0">
                <div class="card-title" style="color:white">Financial Calculator</div>
                <button class="btn-outline" id="closeCalculator" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
            </div>
            <div class="modal-pad">
                <input type="text" id="calcDisplay" value="0" readonly style="font-size:24px; text-align:right; margin-bottom:10px;">
                <div class="calc-grid">
                    <button class="calc-btn op-btn" data-value="AC">AC</button>
                    <button class="calc-btn op-btn" data-value="P">+/-</button>
                    <button class="calc-btn op-btn" data-value="%">%</button>
                    <button class="calc-btn op-btn" data-value="/">/</button>
                    <button class="calc-btn" data-value="7">7</button>
                    <button class="calc-btn" data-value="8">8</button>
                    <button class="calc-btn" data-value="9">9</button>
                    <button class="calc-btn op-btn" data-value="*">*</button>
                    <button class="calc-btn" data-value="4">4</button>
                    <button class="calc-btn" data-value="5">5</button>
                    <button class="calc-btn" data-value="6">6</button>
                    <button class="calc-btn op-btn" data-value="-">-</button>
                    <button class="calc-btn" data-value="1">1</button>
                    <button class="calc-btn" data-value="2">2</button>
                    <button class="calc-btn" data-value="3">3</button>
                    <button class="calc-btn op-btn" data-value="+">+</button>
                    <button class="calc-btn span-2" data-value="0">0</button>
                    <button class="calc-btn" data-value=".">.</button>
                    <button class="calc-btn op-btn" data-value="=">=</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="dataMgmtModal" class="modal">
        <div class="modal-content modal-small">
            <div class="action-header" style="border-radius:12px 12px 0 0">
                <div class="card-title" style="color:white">Data Management & Backup</div>
                <button class="btn-outline" id="closeDataMgmt" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
            </div>
            
            <div class="modal-pad">
                <h3 style="margin-top:0; font-size:16px;">Import & Export</h3>
                <p style="font-size:13px; color:var(--text-muted);">Manage your transaction data by importing new records or exporting a backup.</p>
                <div class="flex-row" style="margin-top:15px; justify-content:space-between">
                    <button class="btn-primary" id="importDataBtnModal" style="width:48%;">Import CSV/JSON</button>
                    <button class="btn-outline" id="exportBtnModal" style="width:48%;">Export Data (CSV)</button>
                </div>
                
                <div style="border-top:1px solid var(--border); padding-top:20px; margin-top:20px">
                    <h3 style="margin-top:0; font-size:16px; color:var(--danger);">Danger Zone</h3>
                    <p style="font-size:13px; color:var(--text-muted);">This action cannot be reversed and will **permanently delete** all data for the current profile.</p>
                    <button class="btn-danger full-width" id="resetBtnModal">Factory Reset Profile</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript logic integrated here
        
        let profiles = JSON.parse(localStorage.getItem('profiles')) || {};
        let currentProfileName = localStorage.getItem('currentProfile') || null;
        let currentProfile = currentProfileName ? profiles[currentProfileName] : null;
        let categories = [];
        let balanceChartInstance = null;
        let categoryChartInstance = null;

        const DOM = {
            profileSelect: document.getElementById('profileSelect'),
            netWorthDisplay: document.getElementById('netWorthDisplay'),
            totalIncome: document.getElementById('totalIncome'),
            totalExpenses: document.getElementById('totalExpenses'),
            lastUpdated: document.getElementById('lastUpdated'),
            transactionForm: document.getElementById('transactionForm'),
            recentTransactionsTable: document.querySelector('#recentTransactionsTable tbody'),
            categorySelect: document.getElementById('category'),
            
            // Sidebar Navigation
            navSettings: document.getElementById('navSettings'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettings: document.getElementById('closeSettings'),
            
            // New Sidebar Item and Modal
            navDataMgmt: document.getElementById('navDataMgmt'),
            dataMgmtModal: document.getElementById('dataMgmtModal'),
            closeDataMgmt: document.getElementById('closeDataMgmt'),

            // Data Operations (Logic linked to these hidden elements)
            importDataBtn: document.getElementById('importDataBtn'),
            exportBtn: document.getElementById('exportBtn'),
            resetBtn: document.getElementById('resetBtn'),
            
            // New Modal Buttons (User interacts with these)
            importDataBtnModal: document.getElementById('importDataBtnModal'),
            exportBtnModal: document.getElementById('exportBtnModal'),
            resetBtnModal: document.getElementById('resetBtnModal'),
            
            // Settings Modal Profile/Category
            newProfileBtn: document.getElementById('newProfileBtn'),
            deleteProfileBtn: document.getElementById('deleteProfileBtn'),
            newCategoryInput: document.getElementById('newCategoryInput'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            categoryListDisplay: document.getElementById('categoryListDisplay'),
            
            // Calculator
            calcToggle: document.getElementById('calc-toggle'),
            calculatorModal: document.getElementById('calculatorModal'),
            closeCalculator: document.getElementById('closeCalculator'),
            calcDisplay: document.getElementById('calcDisplay'),
        };

        const defaultCategories = ['Salary', 'Investments', 'Groceries', 'Rent', 'Utilities', 'Entertainment'];

        // --- Core Data Functions ---
        
        function saveProfiles() {
            localStorage.setItem('profiles', JSON.stringify(profiles));
            if (currentProfileName) {
                localStorage.setItem('currentProfile', currentProfileName);
            }
        }

        function loadProfile(name) {
            currentProfileName = name;
            currentProfile = profiles[name];
            if (!currentProfile) return;
            
            categories = currentProfile.categories;

            updateDOM();
            saveProfiles();
        }

        function updateProfileData() {
            if (!currentProfile) return;

            const now = new Date();
            currentProfile.lastUpdated = now.toLocaleString();
            
            const income = currentProfile.transactions
                .filter(t => t.type === 'Income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = currentProfile.transactions
                .filter(t => t.type === 'Expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            currentProfile.netWorth = income - expenses;
            currentProfile.totalIncome = income;
            currentProfile.totalExpenses = expenses;
            
            saveProfiles();
        }

        // --- DOM Update Functions ---

        function updateDOM() {
            if (!currentProfile) {
                DOM.netWorthDisplay.textContent = 'N/A';
                DOM.totalIncome.textContent = 'N/A';
                DOM.totalExpenses.textContent = 'N/A';
                DOM.lastUpdated.textContent = 'N/A';
                DOM.profileNameDisplay.textContent = 'No Profile';
                DOM.recentTransactionsTable.innerHTML = '';
                updateCategorySelect([]);
                renderCategoryList([]);
                return;
            }

            const format = (value) => value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            DOM.netWorthDisplay.textContent = format(currentProfile.netWorth);
            DOM.totalIncome.textContent = format(currentProfile.totalIncome);
            DOM.totalExpenses.textContent = format(currentProfile.totalExpenses);
            DOM.lastUpdated.textContent = currentProfile.lastUpdated;
            DOM.profileNameDisplay.textContent = currentProfileName;
            
            renderTransactions();
            updateCategorySelect(categories);
            renderCategoryList(categories);
            renderCharts(currentProfile.transactions, currentProfile.netWorth);
        }

        function populateProfileSelect() {
            DOM.profileSelect.innerHTML = '';
            const profileNames = Object.keys(profiles);
            
            if (profileNames.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No Profiles';
                option.value = '';
                DOM.profileSelect.appendChild(option);
                return;
            }

            profileNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === currentProfileName) {
                    option.selected = true;
                }
                DOM.profileSelect.appendChild(option);
            });
        }

        function renderTransactions() {
            DOM.recentTransactionsTable.innerHTML = '';
            const recent = currentProfile.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            recent.forEach((t, index) => {
                const row = DOM.recentTransactionsTable.insertRow();
                row.insertCell().textContent = t.date;
                row.insertCell().textContent = t.description;
                row.insertCell().textContent = t.category;
                row.insertCell().textContent = t.type;
                const amountCell = row.insertCell();
                amountCell.textContent = t.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                amountCell.style.color = t.type === 'Income' ? var(--success) : var(--danger);

                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '✕';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => deleteTransaction(t.id);
                actionCell.appendChild(deleteBtn);
            });
        }
        
        function updateCategorySelect(categoryList) {
            DOM.categorySelect.innerHTML = '<option value="">Category</option>';
            categoryList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                DOM.categorySelect.appendChild(option);
            });
        }
        
        function renderCategoryList(categoryList) {
            DOM.categoryListDisplay.innerHTML = '';
            categoryList.forEach(cat => {
                const span = document.createElement('span');
                span.textContent = cat;
                DOM.categoryListDisplay.appendChild(span);
            });
        }
        
        // --- Transaction Logic ---

        function addTransaction(e) {
            e.preventDefault();
            if (!currentProfile) {
                alert('Please select or create a profile first.');
                return;
            }

            const transaction = {
                id: Date.now(),
                description: document.getElementById('description').value,
                type: document.getElementById('type').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
            };

            currentProfile.transactions.push(transaction);
            
            DOM.transactionForm.reset();
            document.getElementById('date').valueAsDate = new Date();
            
            updateProfileData();
            updateDOM();
        }

        function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            currentProfile.transactions = currentProfile.transactions.filter(t => t.id !== id);
            
            updateProfileData();
            updateDOM();
        }
        
        // --- Profile Management Logic ---
        
        function createNewProfile() {
            const name = prompt('Enter a name for the new profile:');
            if (name && name.trim() && !profiles[name]) {
                profiles[name] = {
                    transactions: [],
                    categories: [...defaultCategories],
                    netWorth: 0,
                    totalIncome: 0,
                    totalExpenses: 0,
                    lastUpdated: new Date().toLocaleString()
                };
                loadProfile(name);
                populateProfileSelect();
            } else if (name) {
                alert('Profile name is invalid or already exists.');
            }
        }

        function deleteCurrentProfile() {
            if (!currentProfileName) return;
            if (confirm(`Are you sure you want to permanently delete the profile: ${currentProfileName}?`)) {
                delete profiles[currentProfileName];
                currentProfileName = null;
                currentProfile = null;
                localStorage.removeItem('currentProfile');
                
                // Try to load the first available profile or reset
                const profileNames = Object.keys(profiles);
                if (profileNames.length > 0) {
                    loadProfile(profileNames[0]);
                }
                
                populateProfileSelect();
                updateDOM();
                alert('Profile deleted.');
            }
        }
        
        // --- Category Management Logic ---
        
        function addCategory() {
            const newCat = DOM.newCategoryInput.value.trim();
            if (newCat && !categories.includes(newCat)) {
                categories.push(newCat);
                currentProfile.categories = categories; // Update profile object
                saveProfiles();
                DOM.newCategoryInput.value = '';
                updateCategorySelect(categories);
                renderCategoryList(categories);
            } else if (newCat) {
                alert('Category already exists.');
            }
        }
        
        // --- Data Import/Export/Reset Logic (Linked to hidden buttons) ---
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv, application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const contents = e.target.result;
                    let importedTransactions;

                    try {
                        if (file.name.endsWith('.json')) {
                            importedTransactions = JSON.parse(contents);
                        } else if (file.name.endsWith('.csv')) {
                            importedTransactions = parseCSV(contents);
                        }
                        
                        if (Array.isArray(importedTransactions) && importedTransactions.every(t => t.description && t.amount)) {
                            // Assign new IDs and merge
                            const newTransactions = importedTransactions.map(t => ({
                                id: Date.now() + Math.random(),
                                description: String(t.description).trim(),
                                type: String(t.type || 'Expense').trim(),
                                amount: parseFloat(t.amount) || 0,
                                category: String(t.category || 'Uncategorized').trim(),
                                date: String(t.date || new Date().toISOString().split('T')[0]).trim(),
                            }));
                            
                            currentProfile.transactions.push(...newTransactions);
                            alert(`Successfully imported ${newTransactions.length} transactions.`);
                            updateProfileData();
                            updateDOM();
                        } else {
                            throw new Error("Invalid transaction structure.");
                        }

                    } catch (error) {
                        alert('Error processing file. Please ensure the file is valid JSON or CSV. ' + error.message);
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function parseCSV(csvText) {
            const [headerLine, ...dataLines] = csvText.split('\n').filter(line => line.trim() !== '');
            const headers = headerLine.split(',').map(h => h.trim().toLowerCase());
            
            const mapping = {
                'description': ['description', 'desc', 'details'],
                'type': ['type', 'inout'],
                'amount': ['amount', 'value'],
                'category': ['category', 'cat'],
                'date': ['date', 'trans_date']
            };

            return dataLines.map(line => {
                const values = line.split(',').map(v => v.trim());
                const transaction = {};
                headers.forEach((header, i) => {
                    for (const key in mapping) {
                        if (mapping[key].includes(header)) {
                            transaction[key] = values[i];
                            break;
                        }
                    }
                });
                return transaction;
            });
        }

        function exportData() {
            if (!currentProfile || currentProfile.transactions.length === 0) {
                alert('No data to export.');
                return;
            }
            
            const transactions = currentProfile.transactions.map(t => ({
                id: t.id,
                description: t.description,
                type: t.type,
                amount: t.amount,
                category: t.category,
                date: t.date
            }));

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "id,description,type,amount,category,date\n";

            transactions.forEach(t => {
                let row = Object.values(t).map(String).join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentProfileName}_transactions_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Data export initiated.');
        }

        function factoryReset() {
            if (!currentProfile) return;
            if (confirm(`WARNING: This will delete ALL transactions for profile ${currentProfileName}. Are you absolutely sure?`)) {
                 if (prompt('Type "RESET" to confirm permanent deletion:') === 'RESET') {
                    currentProfile.transactions = [];
                    updateProfileData();
                    updateDOM();
                    alert('Profile successfully reset.');
                } else {
                    alert('Reset cancelled.');
                }
            }
        }
        
        // --- Charting Logic ---

        function renderCharts(transactions, netWorth) {
            // 1. Category Distribution Chart (Pie/Doughnut)
            const expenseTransactions = transactions.filter(t => t.type === 'Expense');
            const categoryData = expenseTransactions.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const categoryLabels = Object.keys(categoryData);
            const categoryAmounts = Object.values(categoryData);
            
            // Re-render chart if it exists
            if (categoryChartInstance) categoryChartInstance.destroy();

            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryAmounts,
                        backgroundColor: categoryLabels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Expense Distribution' }
                    }
                }
            });
            
            // 2. Net Balance History Chart (Line)
            const sortedTransactions = transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            const dailyBalance = {};
            let currentBalance = 0;

            sortedTransactions.forEach(t => {
                currentBalance += (t.type === 'Income' ? t.amount : -t.amount);
                const dateKey = t.date;
                dailyBalance[dateKey] = currentBalance; 
            });

            const balanceLabels = Object.keys(dailyBalance);
            const balanceData = Object.values(dailyBalance);

            if (balanceChartInstance) balanceChartInstance.destroy();

            const balanceCtx = document.getElementById('balanceChart').getContext('2d');
            balanceChartInstance = new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels: balanceLabels,
                    datasets: [{
                        label: 'Net Balance',
                        data: balanceData,
                        borderColor: var(--primary-color),
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Date' }
                        },
                        y: {
                            title: { display: true, text: 'Balance (USD)' }
                        }
                    }
                }
            });
        }

        // --- Calculator Logic ---
        
        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        let waitingForSecondOperand = false;

        function updateCalcDisplay() {
            DOM.calcDisplay.value = currentInput;
        }

        function handleDigit(digit) {
            if (waitingForSecondOperand) {
                currentInput = digit;
                waitingForSecondOperand = false;
            } else {
                currentInput = currentInput === '0' ? digit : currentInput + digit;
            }
            updateCalcDisplay();
        }

        function handleDecimal() {
            if (waitingForSecondOperand) {
                currentInput = '0.';
                waitingForSecondOperand = false;
                updateCalcDisplay();
                return;
            }
            if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateCalcDisplay();
        }
        
        function handleOperator(nextOperator) {
            const inputValue = parseFloat(currentInput);

            if (nextOperator === 'AC') {
                currentInput = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                updateCalcDisplay();
                return;
            }
            
            if (nextOperator === 'P') { // Plus/Minus
                currentInput = String(inputValue * -1);
                updateCalcDisplay();
                return;
            }

            if (operator && waitingForSecondOperand) {
                operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation(operator, firstOperand, inputValue);
                currentInput = String(result);
                firstOperand = result;
            }

            waitingForSecondOperand = true;
            operator = nextOperator === '=' ? null : nextOperator;
            updateCalcDisplay();
        }

        function performCalculation(operator, op1, op2) {
            switch (operator) {
                case '+': return op1 + op2;
                case '-': return op1 - op2;
                case '*': return op1 * op2;
                case '/': return op1 / op2;
                case '%': return op1 * (op2 / 100);
                default: return op2;
            }
        }

        function attachCalculatorListeners() {
            document.querySelectorAll('.calc-btn').forEach(button => {
                button.onclick = () => {
                    const value = button.getAttribute('data-value');
                    if (['+', '-', '*', '/', '=', 'AC', 'P', '%'].includes(value)) {
                        handleOperator(value);
                    } else if (value === '.') {
                        handleDecimal();
                    } else {
                        handleDigit(value);
                    }
                };
            });
        }


        // --- Event Listeners and Initialization ---

        function init() {
            // Set today's date in the form
            document.getElementById('date').valueAsDate = new Date();

            // Load profiles and set initial state
            populateProfileSelect();
            if (currentProfileName) {
                loadProfile(currentProfileName);
            } else {
                updateDOM();
            }

            // Transaction Form
            DOM.transactionForm.addEventListener('submit', addTransaction);

            // Profile Select Change
            DOM.profileSelect.addEventListener('change', (e) => loadProfile(e.target.value));

            // Settings Modal
            DOM.navSettings.onclick = () => DOM.settingsModal.classList.add('open');
            DOM.closeSettings.onclick = () => DOM.settingsModal.classList.remove('open');
            
            // New Profile Management
            DOM.newProfileBtn.onclick = createNewProfile;
            DOM.deleteProfileBtn.onclick = deleteCurrentProfile;
            DOM.addCategoryBtn.onclick = addCategory;
            
            // Calculator Modal
            DOM.calcToggle.onclick = () => DOM.calculatorModal.classList.add('open');
            DOM.closeCalculator.onclick = () => DOM.calculatorModal.classList.remove('open');
            attachCalculatorListeners();
            
            // Data Management Modal (New)
            DOM.navDataMgmt.onclick = () => {
                if (!currentProfile) return alert('Please select a profile first to manage data.');
                DOM.dataMgmtModal.classList.add('open'); 
            };
            DOM.closeDataMgmt.onclick = () => DOM.dataMgmtModal.classList.remove('open');
            
            // Sample Data Button
            document.getElementById('sampleBtn').onclick = () => {
                if (currentProfileName && currentProfile.transactions.length > 0) {
                    if (!confirm('Loading sample data will merge it with your existing transactions. Continue?')) return;
                }
                
                const sampleData = [
                    { id: Date.now() + 1, description: 'Monthly Salary', type: 'Income', amount: 5500.00, category: 'Salary', date: '2024-10-01' },
                    { id: Date.now() + 2, description: 'Rent Payment', type: 'Expense', amount: 1500.00, category: 'Rent', date: '2024-10-01' },
                    { id: Date.now() + 3, description: 'Grocery Store', type: 'Expense', amount: 120.50, category: 'Groceries', date: '2024-10-02' },
                    { id: Date.now() + 4, description: 'Investment Dividend', type: 'Income', amount: 250.00, category: 'Investments', date: '2024-10-15' },
                    { id: Date.now() + 5, description: 'Coffee Shop', type: 'Expense', amount: 5.75, category: 'Entertainment', date: '2024-10-18' }
                ];

                if (!currentProfile) {
                    createNewProfile('Sample Profile'); // This loads the profile
                }

                currentProfile.transactions.push(...sampleData);
                updateProfileData();
                updateDOM();
                alert('Sample data loaded.');
            };

            // Linking New Modal Buttons to Old Logic
            // The old hidden buttons contain the actual file/reset logic, we just trigger them.
            DOM.importDataBtnModal.onclick = () => {
                DOM.dataMgmtModal.classList.remove('open');
                DOM.importDataBtn.click();
            };

            DOM.exportBtnModal.onclick = () => {
                DOM.dataMgmtModal.classList.remove('open');
                DOM.exportBtn.click();
            };
            
            DOM.resetBtnModal.onclick = () => {
                DOM.dataMgmtModal.classList.remove('open');
                DOM.resetBtn.click();
            };
            
            // Actual Data Logic (Attached to the hidden buttons)
            DOM.importDataBtn.onclick = importData;
            DOM.exportBtn.onclick = exportData;
            DOM.resetBtn.onclick = factoryReset;
        }

        init();
    </script>
</body>
</html>
