<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MoneyMirror — v5.0.8 (Final Stable)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* LAYOUT */
    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.3s; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px); transition: filter 0.3s; }

    /* BRAND & NAV */
    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    /* AUTH GATE */
    #authGate {
      position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
      gap: 10px; color: white; text-align: center; padding: 0 24px;
    }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    /* UI ELEMENTS */
    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; flex-wrap: wrap; gap: 10px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); white-space: nowrap; }

    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; min-width: 120px; flex-grow: 1; }
    .input-group-med { width: 25%; min-width: 180px; flex-grow: 1; }
    .input-group-large { width: 45%; min-width: 250px; flex-grow: 1; }

    .kpi-card { padding: 20px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    .cc-alert-high { background: #fee2e2 !important; border-color: var(--danger) !important; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; white-space: nowrap; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted); }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600; color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1400px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 95vh; display:flex; flex-direction:column; overflow: hidden; }
    .modal-pad { padding: 24px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-small { width: 90%; max-width: 400px; height: auto; max-height: 90vh; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Calculator */
    #calculator { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 480px; max-height: 80vh; z-index: 3000; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #f8fafc; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close-btn { background: transparent; border: none; color: #ef4444; font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    #calc-display { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    #calc-preview { background: #0b1323; color: #9fb3c8; text-align: right; font-size: 14px; padding: 6px 15px; font-family: monospace; height: 28px; border-top: 1px solid rgba(255,255,255,0.06); }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; touch-action: manipulation; }
    #calc-buttons button:hover { background: #f1f5f9; }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .calc-clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .calc-zero { grid-column: span 2; }
    .calc-equals { grid-row: span 2; background: var(--primary) !important; color: white !important; }
    #calc-toggle { margin-left: 10px; padding: 8px 12px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; }

    /* Breakdown Grid */
    .kpi-breakdown-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: white; display:flex; flex-direction:column; justify-content:space-between; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }
    
    /* Dropdowns */
    .sub-dropdown-container { position: relative; }
    .sub-dropdown-menu { position: absolute; top: 36px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px 0; width: 100%; min-width: 240px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50; display: none; max-height: 300px; overflow-y: auto; }
    .sub-dropdown-menu.show { display: block; }
    .sub-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; font-size: 12px; color: var(--text-main); border-bottom: 1px solid #f1f5f9; }
    .sub-dropdown-item:last-child { border-bottom: none; }

    .multiselect-container { position: relative; }
    .multiselect-dropdown { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 220px; padding: 10px; z-index: 60; display: none; }
    .multiselect-dropdown.show { display: block; }
    .ms-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; cursor: pointer; }
    .ms-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    
    /* Analytics Filters */
    .analytics-filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }

    /* MEDIA QUERIES */
    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-1 { grid-column: span 1; }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }

    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; height: 60px; }
      aside .brand { margin-bottom: 0; }
      aside nav, .sidebar-footer { display: none; }
      #mobileMenuBtn { display: block; }
      aside.mobile-open nav { display: block; position: absolute; top: 60px; left: 0; right: 0; background: var(--sidebar-bg); padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 501; height: calc(100vh - 60px); overflow-y: auto; }
      aside.mobile-open .sidebar-footer { display: block; position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 501; }
      main { padding: 15px; gap: 15px; }
      .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer { width: 100% !important; min-width: 100%; }
      .action-body { gap: 12px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr; }
      #invQuickSubs { grid-template-columns: 1fr !important; }
      .card-header { align-items: flex-start; }
      #calculator { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; bottom: auto; right: auto; }
      .analytics-filter-grid { grid-template-columns: 1fr; gap: 10px; }
      .flex-row input, .flex-row select, .flex-row button { flex-grow: 1; width: 100%; max-width: none !important; }
      .modal-content { width: 100%; height: 100%; border-radius: 0; max-width: none; }
      .modal-small { height: auto; min-height: 50vh; border-radius: 12px; }
    }
  </style>
</head>
<body>

<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror — Personal Finance Dashboard</p>
  <p class="line line-3">by Rehan Hamdulay</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
  <button id="guestBtn" class="btn-outline" style="padding:12px 24px; font-size:14px; background:transparent; color:white; border-color:white; margin-top:10px;">Continue as Guest (Offline)</button>
</div>

<aside id="mainSidebar">
  <div style="width:100%">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
        MoneyMirror <span>v5.0.8</span>
      </div>
      <button id="mobileMenuBtn">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>
      </div>
      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
      </div>
    </nav>
  </div>

  <div class="sidebar-footer">
    <div class="sys-stat">
      <span>Current profile</span>
      <span class="sys-val" id="profileNameDisplay">--</span>
    </div>
    <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.8 • Settings & Table Fixed</div>
  </div>
</aside>

<main>

  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
      <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
    </div>
    <div class="flex-row">
      <button class="btn-outline" id="sampleBtn">Load sample</button>
      <button class="btn-primary" id="importDataBtn">Import data</button>
      <button class="btn-outline" id="exportBtn">Export CSV</button>
      <div id="calc-toggle" title="Toggle calculator">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="14" x2="12.01" y2="14"></line><line x1="8" y1="10" x2="8.01" y2="10"></line><line x1="16" y1="10" x2="16.01" y2="10"></line></svg>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--success)">Monthly income</div>
      <div class="kpi-value" id="kpiIncome">₹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--danger)">Monthly expenses</div>
      <div class="kpi-value" id="kpiExpense">₹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    <div class="card kpi-card col-span-1" id="ccCard" style="border-color:var(--warning); background:#fffbeb">
      <div class="card-title" id="ccTitle" style="color:var(--warning)">Credit card due</div>
      <div class="kpi-value" id="kpiCCDue">₹0</div>
      <div class="kpi-sub" style="color:#000; font-weight:700; margin-top: 6px; position:relative;">
        <span id="ccPaymentDate">Next: 10th Dec</span>
        <span style="font-weight:700; margin-left:10px;">Limit: <span id="ccLimitDisplay">₹2L</span></span>
        <div id="ccAlert" class="hidden" style="position:absolute; right:0; top:0; color:var(--danger)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        </div>
      </div>
    </div>

    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--primary)">Net liquidity</div>
      <div class="kpi-value" id="kpiNet">₹0</div>
      <div class="kpi-sub">Total available cash</div>
      <div class="account-list" id="netLiquidityBreakdown"></div>
    </div>

    <div class="card kpi-card col-span-4" style="background:#e0f2fe; border-color:#075985;">
      <div class="card-header" style="padding:16px 20px 0 20px;">
        <div class="card-title" style="color:#075985">Total investment value</div>
        <div style="display:flex;gap:8px;align-items:center; flex-wrap:wrap;">
          <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px; font-size:12px;">View breakdown</button>
          <button id="viewCategoriesBtn" class="btn-outline" style="padding:6px 10px; font-size:12px;">View subcategories</button>
        </div>
      </div>
      <div class="card-body" style="padding-top:6px;">
        <div class="kpi-value" id="kpiInvest">₹0</div>
        <div class="kpi-sub" id="momInvest" style="color:#075985">Historical cost total</div>

        <div id="invBreakdownPanel" class="hidden" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
          <div class="card" style="border-color:#93c5fd; margin-bottom:12px;">
            <div class="card-header">
              <div class="card-title">Filters</div>
              <div class="flex-row" style="gap:10px; width:100%;">
                <div class="input-group-med">
                  <label>Major bucket</label>
                  <select id="invBucketFilter"></select>
                </div>
                <div class="input-group-med">
                  <label>View mode</label>
                  <select id="invViewMode">
                    <option value="top4">Top 4 buckets</option>
                    <option value="subcats">Subcategories</option>
                  </select>
                </div>
                <div class="input-group-med">
                  <label>Date range</label>
                  <select id="invDateRange">
                    <option value="6">Last 6 months</option>
                    <option value="12">Last 12 months</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="kpi-breakdown-grid">
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invBarTitle">Major buckets</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownBar"></canvas>
              </div>
            </div>
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invPieTitle">Share</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownPie"></canvas>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="card-title" style="font-size:13px; color:#075985; margin-bottom:10px;">Bucket subcategories quick view</div>
            <div id="invQuickSubs" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Cash flow & investments</div>
        <select id="mainChartFilter" onchange="renderCharts()" style="max-width:120px;">
          <option value="6">Last 6m</option>
          <option value="12">Last 12m</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:320px; width:100%; position:relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card col-span-2">
      <div class="card-header" style="gap:12px;">
        <div class="card-title">Expense Breakdown</div>
        <div class="multiselect-container">
          <button class="btn-outline" id="expenseFilterBtn">Select Categories ▾</button>
          <div id="expenseDropdown" class="multiselect-dropdown">
            <div id="expenseCheckboxes"></div>
            <div class="ms-actions">
              <button class="btn-outline" onclick="resetExpenseDrilldown()" id="resetExpenseDrilldown" style="padding:6px 10px; font-size:12px; margin-right:auto;">Reset</button>
              <button class="btn-primary" onclick="renderWalletUnified()" style="padding:6px 10px; font-size:12px;">Apply</button>
            </div>
          </div>
        </div>
        <select id="expenseChartType" onchange="renderWalletUnified()" style="max-width:120px;">
          <option value="pie">Pie Chart</option>
          <option value="bar">Bar Chart</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:320px; width:100%; position:relative; display:flex; justify-content:center; align-items:center;">
          <canvas id="expenseChart"></canvas>
          <div id="expenseChartInfo" style="font-size:14px; color:var(--text-muted); position:absolute; padding-top:20px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card action-card col-span-4" style="margin-top:0;">
    <div class="action-header">
      <div class="card-title">Add new transaction</div>
      <div style="font-size:13px; color:white;">Transaction ID: <span id="currentIdDisplay">--</span></div>
    </div>
    <div class="action-body">
      <div class="input-group-small">
        <label>Type</label>
        <select id="type">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
          <option value="opening_balance">Opening Balance (Asset)</option>
        </select>
      </div>
      <div class="input-group-small">
        <label>Amount (₹)</label>
        <input type="number" id="amount" placeholder="e.g. 5000" min="0" required />
      </div>
      <div class="input-group-small">
        <label>Date</label>
        <input type="date" id="date" required />
      </div>
      <div class="input-group-large">
        <label>Description</label>
        <input type="text" id="desc" placeholder="e.g. Monthly Rent Payment" required />
      </div>
      
      <div id="expenseFlowRow" class="full-width" style="display:flex; gap:20px; flex-wrap:wrap">
        <div id="categoryContainer" class="input-group-med">
          <label>Category</label>
          <select id="category"></select>
        </div>
        <div class="input-group-small">
          <label id="methodLabel">Payment Method</label>
          <select id="method"></select>
        </div>
        <div id="incomeSourceRow" class="hidden input-group-small">
          <label>Source</label>
          <select id="incomeSource"></select>
        </div>
        <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
          <div class="input-group-small">
            <label>Investment category</label>
            <select id="invGroup"></select>
          </div>
          <div class="input-group-small">
            <label>Investment sub-type</label>
            <select id="invSub"></select>
          </div>
        </div>
        <div id="insuranceRow" class="hidden input-group-med">
          <label>Insurance details</label>
          <div class="flex-row">
            <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
            <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
          </div>
        </div>
      </div>

      <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
        <div class="input-group-small">
          <label>Asset type</label>
          <select id="openingType">
            <option value="Cash">Cash (Liquid)</option>
            <option value="Investment">Investment Asset</option>
          </select>
        </div>
        <div class="input-group-small" id="openingSubContainer">
          <label id="openingSubLabel">Cash Account Name</label>
          <select id="openingSub"></select>
        </div>
        <div id="openingInvRow" class="hidden" style="display:flex; gap:20px; flex-wrap:wrap; flex-grow:1;">
          <div class="input-group-small">
            <label>Investment category</label>
            <select id="openingGroup"></select>
          </div>
          <div class="input-group-small">
            <label>Investment sub-type</label>
            <select id="openingInvSub"></select>
          </div>
        </div>
      </div>

      <div class="full-width flex-row" style="justify-content:flex-end;">
        <button id="cancelBtn" class="btn-outline hidden">Cancel Edit</button>
        <button id="saveBtn" class="btn-primary hidden">Save Changes</button>
        <button id="addBtn" class="btn-primary">Add Transaction</button>
      </div>
    </div>
  </div>

  <div class="card col-span-4">
    <div class="card-header">
      <div class="card-title">Recent Entries</div>
      <div class="flex-row">
        <select id="recentType" onchange="renderRecentEntries()" style="max-width:120px;">
          <option value="">All</option>
          <option value="expense">Expense</option>
          <option value="income">Income</option>
          <option value="opening_balance">Opening</option>
        </select>
        <select id="recentCategory" onchange="renderRecentEntries()" style="max-width:180px;"></select>
        <input type="text" id="recentSearch" onkeyup="renderRecentEntries()" placeholder="Search description..." style="max-width:200px;"/>
      </div>
    </div>
    <div class="card-body" style="padding:0;">
      <div class="table-container">
        <table id="recentTable">
          <thead>
            <tr>
              <th style="width:10%">Type</th>
              <th style="width:12%">Date</th>
              <th style="width:12%; text-align:right">Amount</th>
              <th style="width:30%">Description</th>
              <th style="width:15%">Category/Asset</th>
              <th style="width:13%">Method</th>
              <th style="width:8%">Actions</th>
            </tr>
          </thead>
          <tbody id="recentEntries">
            <tr><td colspan="7" style="text-align:center; color:var(--text-muted);">No transactions found.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<div id="settingsModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="cursor:default;">
      <div class="card-title">Settings & Backup</div>
      <button id="closeSettings" class="btn-danger" style="background:none; color:white; padding:5px; font-size:18px;">×</button>
    </div>
    <div class="modal-pad">
      <h3 style="margin-top:0;">Profile</h3>
      <div class="input-group-large" style="margin-bottom:15px;">
        <label>Current profile (Sign-in name)</label>
        <input type="text" id="currentProfileName" disabled style="background:#f1f5f9; cursor:not-allowed;">
      </div>

      <h3 style="margin-top:10px;">Configuration</h3>
      <div class="input-group-large" style="margin-bottom:15px;">
        <label>Credit Card Limit (₹)</label>
        <input type="number" id="ccLimitInput" placeholder="e.g. 200000" min="0">
        <button id="saveSettingsBtn" class="btn-primary" style="margin-top:10px; width:100%;">Save CC Limit</button>
      </div>

      <h3 style="margin-top:20px;">Payment Methods</h3>
      <div id="methodList" style="margin-bottom:10px; font-size:13px;"></div>
      <div class="flex-row" style="margin-bottom:20px;">
        <input type="text" id="newMethod" placeholder="New method name (e.g., Paytm)" style="flex-grow:1;">
        <button class="btn-primary" onclick="addMethod()">Add</button>
      </div>

      <h3 style="margin-top:20px;">Income Sources</h3>
      <div id="incomeList" style="margin-bottom:10px; font-size:13px;"></div>
      <div class="flex-row" style="margin-bottom:20px;">
        <input type="text" id="newIncome" placeholder="New income source (e.g., Stock Dividends)" style="flex-grow:1;">
        <button class="btn-primary" onclick="addIncome()">Add</button>
      </div>

      <h3 style="margin-top:20px;">Data Management</h3>
      <button class="btn-danger" id="resetBtn" style="width:100%;">Clear All Data</button>

    </div>
  </div>
</div>

<div id="importModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="cursor:default;">
      <div class="card-title">Import Data (CSV)</div>
      <button id="closeImport" class="btn-danger" style="background:none; color:white; padding:5px; font-size:18px;">×</button>
    </div>
    <div class="modal-pad">
      <p style="font-size:13px; color:var(--text-muted);">Please upload a CSV file with the following headers (case-insensitive and order doesn't matter): 
      <code style="background:#f1f5f9; padding:2px 5px; border-radius:4px; display:block; margin-top:5px; white-space:pre-wrap;">id, type, amount, date, desc, category, method, incomeSource, investmentGroup, investmentSub, insuranceType, insuranceFor</code></p>
      <input type="file" id="csvFile" accept=".csv" style="margin: 15px 0;">
      <button class="btn-primary" id="processImportBtn" style="width:100%;">Process Import</button>
    </div>
  </div>
</div>

<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <div class="action-header" style="cursor:default;">
      <div class="card-title">Advanced Investment Analytics</div>
      <button id="closeAnalytics" class="btn-danger" style="background:none; color:white; padding:5px; font-size:18px;">×</button>
    </div>
    <div class="modal-pad">
      <div class="analytics-filter-grid">
        <div class="input-group-small">
          <label>Date Range</label>
          <select id="dateFilter" onchange="renderAdvancedCharts()">
            <option value="12">Last 12 Months</option>
            <option value="24">Last 24 Months</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <div class="input-group-small">
          <label>Investment Group</label>
          <select id="anlInvGroup" onchange="updateAnlSubDropdown(); renderAdvancedCharts()"></select>
        </div>
        <div class="input-group-small">
          <label>Investment Type</label>
          <select id="anlInvSub" onchange="renderAdvancedCharts()"></select>
        </div>
        <div class="input-group-small">
          <label>Chart Type</label>
          <select id="chartType" onchange="renderAdvancedCharts()">
            <option value="types">Breakdown by Type</option>
            <option value="growth">Cumulative Growth</option>
          </select>
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr; gap:20px;">
        <div class="card col-span-1" style="border-color:#93c5fd;">
          <div class="card-header"><div class="card-title" id="chartTitle">Investment Breakdown by Type</div></div>
          <div class="card-body">
            <div style="height:400px; width:100%; position:relative">
              <canvas id="chartInvTypesModal"></canvas>
              <canvas id="chartInvGrowthModal" class="hidden"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="calculator" style="display:none;">
  <div id="calc-header">
    <span>Calculator</span>
    <button id="calc-close-btn">×</button>
  </div>
  <div id="calc-preview">Enter expression</div>
  <div id="calc-display">0</div>
  <div id="calc-buttons">
    <button class="calc-clear">AC</button>
    <button class="calc-clear">DEL</button>
    <button class="calc-operator">%</button>
    <button class="calc-operator">÷</button>

    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button class="calc-operator">×</button>

    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button class="calc-operator">−</button>

    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="calc-operator">+</button>

    <button class="calc-zero">0</button>
    <button>.</button>
    <button class="calc-equals">=</button>
  </div>
<script>
  const DEFAULT_CC_LIMIT = 200000;
  const BASE_CATS = ['Food', 'Rent', 'Utilities', 'Shopping', 'Entertainment', 'Travel', 'Health', 'Education', 'Transport', 'Insurance', 'Investments', 'Misc'];
  const CANONICAL_METHODS = { 'salary_acct': 'Salary Account', 'savings_acct': 'Savings Account', 'cash': 'Cash', 'digital_wallet': 'Digital Wallet (e.g. UPI)', 'credit_card': 'Credit Card' };

  // Global chart instances
  let chartMain, invBreakdownBarChart, invBreakdownPieChart, expenseChart, chartInvTypesModal, chartInvGrowthModal;

  const INVESTMENT_STRUCTURE = {
    'Equity (Stocks)': {
      'Direct Stocks': 'Equity (Stocks)', 'Stock Options / RSUs': 'Equity (Stocks)', 'Portfolio Management Service (PMS)': 'Equity (Stocks)',
      'Index Funds (Equity)': 'Equity (Stocks)', 'Sectoral / Thematic Funds (Equity)': 'Equity (Stocks)',
    },
    'Mutual Funds': {
      'Equity Large Cap': 'Mutual Funds', 'Equity Mid/Small Cap': 'Mutual Funds', 'Debt/Liquid Funds': 'Mutual Funds',
      'Hybrid/Balanced Funds': 'Mutual Funds', 'ELSS (Tax Saving)': 'Mutual Funds',
    },
    'ETFs': {
      'Equity ETFs': 'ETFs', 'Gold/Silver ETFs': 'ETFs', 'Debt ETFs': 'ETFs',
    },
    'Bonds & Debt Instruments': {
      'Government Bonds': 'Bonds & Debt Instruments', 'Corporate Bonds': 'Bonds & Debt Instruments', 'NCDs': 'Bonds & Debt Instruments',
      'Sovereign Gold Bond (SGB)': 'Bonds & Debt Instruments',
    },
    'Commodities': {
      'Physical Gold': 'Commodities', 'Physical Silver': 'Commodities', 'Other Metals/Commodities': 'Commodities',
    },
    'Crypto & Digital Assets': {
      'Bitcoin (BTC)': 'Crypto & Digital Assets', 'Ethereum (ETH)': 'Crypto & Digital Assets', 'Stablecoins': 'Crypto & Digital Assets',
      'Altcoins': 'Crypto & Digital Assets', 'NFTs / Web3 Assets': 'Crypto & Digital Assets',
    },
    'Real Estate': {
      'Residential Property': 'Real Estate', 'Commercial Property': 'Real Estate', 'Land': 'Real Estate',
      'REITs (Real Estate Investment Trusts)': 'Real Estate',
    },
    'Fixed Income / Savings Schemes': {
      'FD (Fixed Deposit)': 'Fixed Income / Savings Schemes', 'RD (Recurring Deposit)': 'Fixed Income / Savings Schemes', 'PPF': 'Fixed Income / Savings Schemes',
      'NSC/KVP/Postal MIS': 'Fixed Income / Savings Schemes', 'High-Interest Savings Account': 'Fixed Income / Savings Schemes',
    },
    'Retirement Funds': {
      'NPS Tier 1/Tier 2': 'Retirement Funds', 'EPF (Employees’ Provident Fund)': 'Retirement Funds', 'IRA/401k (USA users)': 'Retirement Funds',
      'Other Pension Schemes': 'Retirement Funds',
    },
    'Other Investments': {
      'Angel Investing / Startup Equity': 'Other Investments', 'Peer-to-Peer Lending': 'Other Investments', 'Private Funds / AIFs': 'Other Investments',
      'Alternative Assets': 'Other Investments',
    }
  };

  const MAJOR_BUCKETS = {
    'Equity (Stocks)': 'Equity', 'Mutual Funds': 'Mutual Funds', 'ETFs': 'ETFs',
    'Bonds & Debt Instruments': 'Debt', 'Fixed Income / Savings Schemes': 'Debt',
    'Retirement Funds': 'Retirement', 'Real Estate': 'Real Estate', 'Commodities': 'Commodities',
    'Crypto & Digital Assets': 'Crypto', 'Other Investments': 'Other'
  };

  let data = [];
  let methodNames = { ...CANONICAL_METHODS };
  let incomeSources = ['Salary', 'Freelance', 'Interest'];
  let settings = { ccLimit: DEFAULT_CC_LIMIT };
  let editId = null;
  let currentProfile = null;
  let selectedExpenseCategories = [];

  const formEls = {
    type: document.getElementById('type'),
    amount: document.getElementById('amount'),
    date: document.getElementById('date'),
    desc: document.getElementById('desc'),
    category: document.getElementById('category'),
    method: document.getElementById('method'),
    incomeSource: document.getElementById('incomeSource'),
    invGroup: document.getElementById('invGroup'),
    invSub: document.getElementById('invSub'),
    insType: document.getElementById('insType'),
    insFor: document.getElementById('insFor'),
    openingType: document.getElementById('openingType'),
    openingSub: document.getElementById('openingSub'),
    openingGroup: document.getElementById('openingGroup'),
    openingInvSub: document.getElementById('openingInvSub'),
    addBtn: document.getElementById('addBtn'),
    saveBtn: document.getElementById('saveBtn'),
    cancelBtn: document.getElementById('cancelBtn'),
    currentIdDisplay: document.getElementById('currentIdDisplay')
  };

  // --- Utility Functions ---
  const fmt = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(n);
  const toKey = (s) => s.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/(^_|_$)/g, '');
  const uid = () => 'id' + Date.now() + Math.random().toString(16).slice(2);
  const dateInLastMonths = ([min, max]) => {
    const d = new Date();
    d.setMonth(d.getMonth() - Math.floor(Math.random() * (max - min + 1)) + min);
    return d.toISOString().split('T')[0];
  };
  const randBetween = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

  // --- Persistence ---
  function getTxKey() { return currentProfile ? `mm_data_${currentProfile}` : 'mm_data_default'; }
  function getMethodKey() { return currentProfile ? `mm_methods_${currentProfile}` : 'mm_methods_default'; }
  function getIncomeKey() { return currentProfile ? `mm_income_${currentProfile}` : 'mm_income_default'; }
  function getSettingsKey() { return currentProfile ? `mm_settings_${currentProfile}` : 'mm_settings_default'; }

  function saveAll() {
    if (currentProfile) {
      if (typeof firebase !== 'undefined' && firebase.firestore) {
        const db = firebase.firestore();
        db.collection('users').doc(currentProfile).set({
          data, methodNames, incomeSources, settings, lastUpdate: new Date()
        }).catch(e => console.error("Error writing to Firestore:", e));
      }
    } else {
      localStorage.setItem(getTxKey(), JSON.stringify(data));
      localStorage.setItem(getMethodKey(), JSON.stringify(methodNames));
      localStorage.setItem(getIncomeKey(), JSON.stringify(incomeSources));
      localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
    }
  }

  function loadAll() {
    // Load local storage first
    data = JSON.parse(localStorage.getItem(getTxKey()) || '[]');
    methodNames = JSON.parse(localStorage.getItem(getMethodKey()) || JSON.stringify(CANONICAL_METHODS));
    incomeSources = JSON.parse(localStorage.getItem(getIncomeKey()) || '["Salary", "Freelance", "Interest"]');
    settings = JSON.parse(localStorage.getItem(getSettingsKey()) || `{"ccLimit": ${DEFAULT_CC_LIMIT}}`);

    if (currentProfile) {
      document.getElementById('profileNameDisplay').innerText = currentProfile.slice(0, 4) + '...';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('guestBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      document.querySelector('main').style.filter = 'none'; // Unblur main content
      document.getElementById('authGate').style.display = 'none';

      // Load from Firestore
      if (typeof firebase !== 'undefined' && firebase.firestore) {
        const db = firebase.firestore();
        db.collection('users').doc(currentProfile).get().then(doc => {
          if (doc.exists) {
            const firestoreData = doc.data();
            data = firestoreData.data || data;
            methodNames = firestoreData.methodNames || methodNames;
            incomeSources = firestoreData.incomeSources || incomeSources;
            settings = firestoreData.settings || settings;
          }
        }).catch(e => console.error("Firestore read error, using local data:", e));
      }
    } else {
      document.getElementById('profileNameDisplay').innerText = 'Guest (Offline)';
    }

    renderAll();
  }

  // --- RENDER & SETUP ---
  function renderAll() {
    data.sort((a, b) => new Date(b.date) - new Date(a.date));
    setupDropdowns();
    renderKPIs();
    renderCharts();
    renderRecentEntries();
    renderSettings();
  }

  function setupDropdowns() {
    // Methods
    formEls.method.innerHTML = Object.keys(methodNames)
      .filter(key => key !== 'credit_card_payment')
      .map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');

    // Income sources
    formEls.incomeSource.innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');

    // Categories
    formEls.category.innerHTML = BASE_CATS.map(c => `<option value="${c}">${c}</option>`).join('');

    // Recent Table Filter
    const recentCat = document.getElementById('recentCategory');
    if (recentCat) {
      const allCats = Array.from(new Set([...BASE_CATS, 'Income', 'Opening Balance']));
      recentCat.innerHTML = '<option value="">All Cats</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    // Listeners
    formEls.type.onchange = updateTransactionFormFields;
    formEls.category.onchange = updateTransactionFormFields;
    formEls.openingType.onchange = updateTransactionFormFields;
    formEls.invGroup.onchange = () => updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
    formEls.openingGroup.onchange = () => updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingInvSub);

    // Populate groups
    populateInvestmentGroupDropdowns();
    updateTransactionFormFields();
  }

  function populateInvestmentGroupDropdowns() {
    const options = Object.keys(INVESTMENT_STRUCTURE).map(group => `<option value="${group}">${group}</option>`).join('');
    formEls.invGroup.innerHTML = '<option value="">Select Category</option>' + options;
    formEls.openingGroup.innerHTML = '<option value="">Select Category</option>' + options;

    // Populate cash accounts for opening balance
    const cashAccounts = Object.keys(methodNames)
      .filter(key => key !== 'credit_card' && key !== 'credit_card_payment')
      .map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');
    formEls.openingSub.innerHTML = cashAccounts;
  }

  function updateInvestmentSubDropdown(groupSelect, subSelect) {
    const group = groupSelect.value;
    let options = '<option value="">Select Type</option>';
    if (group && INVESTMENT_STRUCTURE[group]) {
      options += Object.keys(INVESTMENT_STRUCTURE[group]).map(sub => `<option value="${sub}">${sub}</option>`).join('');
    }
    subSelect.innerHTML = options;
  }

  function updateTransactionFormFields() {
    const type = formEls.type.value;
    const category = formEls.category.value;
    const obType = formEls.openingType.value;

    document.getElementById('expenseFlowRow').classList.add('hidden');
    document.getElementById('openingBalanceRow').classList.add('hidden');
    document.getElementById('incomeSourceRow').classList.add('hidden');
    document.getElementById('investmentRow').classList.add('hidden');
    document.getElementById('insuranceRow').classList.add('hidden');

    // Reset non-common fields
    formEls.incomeSource.value = '';
    formEls.invGroup.value = formEls.invSub.innerHTML = '';
    formEls.insType.value = formEls.insFor.value = '';

    if (type === 'expense') {
      document.getElementById('expenseFlowRow').classList.remove('hidden');
      document.getElementById('methodLabel').textContent = 'Payment Method';
      formEls.method.disabled = false;
      document.getElementById('categoryContainer').classList.remove('hidden');

      if (category === 'Investments') {
        document.getElementById('investmentRow').classList.remove('hidden');
      } else if (category === 'Insurance') {
        document.getElementById('insuranceRow').classList.remove('hidden');
      } else if (category === 'Credit Card Payment') {
        // Special case: CC Payment is a transfer, not a method-linked expense
        formEls.method.value = 'salary_acct';
        formEls.method.disabled = true;
        document.getElementById('methodLabel').textContent = 'Source Account';
      }

    } else if (type === 'income') {
      document.getElementById('expenseFlowRow').classList.remove('hidden');
      document.getElementById('incomeSourceRow').classList.remove('hidden');
      document.getElementById('categoryContainer').classList.add('hidden');
      document.getElementById('methodLabel').textContent = 'Deposit Account';
      formEls.method.disabled = false;

    } else if (type === 'opening_balance') {
      document.getElementById('openingBalanceRow').classList.remove('hidden');
      document.getElementById('openingInvRow').classList.add('hidden');
      document.getElementById('openingSubContainer').classList.remove('hidden');

      if (obType === 'Cash') {
        document.getElementById('openingSubLabel').textContent = 'Cash Account Name';
        // Populate cash accounts again
        populateInvestmentGroupDropdowns();
      } else if (obType === 'Investment') {
        document.getElementById('openingSubContainer').classList.add('hidden');
        document.getElementById('openingInvRow').classList.remove('hidden');
        formEls.openingGroup.value = '';
        formEls.openingInvSub.innerHTML = '';
      }
    }
    formEls.currentIdDisplay.textContent = editId || '--';
    if (editId) {
      formEls.addBtn.classList.add('hidden');
      formEls.saveBtn.classList.remove('hidden');
      formEls.cancelBtn.classList.remove('hidden');
    } else {
      formEls.addBtn.classList.remove('hidden');
      formEls.saveBtn.classList.add('hidden');
      formEls.cancelBtn.classList.add('hidden');
    }
  }

  function clearForm() {
    formEls.type.value = 'expense';
    formEls.amount.value = '';
    formEls.date.value = new Date().toISOString().split('T')[0];
    formEls.desc.value = '';
    formEls.category.value = BASE_CATS[0];
    formEls.method.value = Object.keys(methodNames).filter(key => key !== 'credit_card')[0] || '';
    formEls.incomeSource.value = '';
    formEls.openingType.value = 'Cash';
    formEls.currentIdDisplay.textContent = '--';
    editId = null;
    updateTransactionFormFields(); // Reset visibility/dropdowns
  }

  // --- Transaction Handlers ---
  function requireSignedIn() {
    if (!currentProfile) {
      alert('Please sign in to proceed.');
      return false;
    }
    return true;
  }

  function submitForm(e, isImportOrEdit = false) {
    if (!requireSignedIn() && !isImportOrEdit) return; // Allow import/edit in guest mode initially, but warn later

    const type = formEls.type.value;
    const amount = Number(formEls.amount.value);
    const date = formEls.date.value;
    const desc = formEls.desc.value;
    const method = formEls.method.value;

    if (amount <= 0 || isNaN(amount)) return alert('Please enter a valid amount.');
    if (!date) return alert('Please select a date.');
    if (!desc) return alert('Please enter a description.');

    const entry = {
      id: e ? e.id : uid(),
      type, amount, date, desc,
      category: '', method: method, incomeSource: '',
      investmentGroup: '', investmentSub: '',
      insuranceType: '', insuranceFor: ''
    };

    if (type === 'income') {
      entry.incomeSource = formEls.incomeSource.value || (e ? e.incomeSource : '');
      if (!entry.incomeSource && !isImportOrEdit) return alert('Please select an Income Source.');
      entry.category = 'N/A';
      entry.investmentGroup = entry.investmentSub = '';
    } else if (type === 'opening_balance') {
      const obType = formEls.openingType.value;
      entry.category = 'Opening Balance';

      if (obType === 'Cash') {
        entry.method = formEls.openingSub.value || (e ? e.method : '');
        entry.investmentGroup = 'Cash';
        entry.investmentSub = methodNames[entry.method] || (e ? e.investmentSub : '');
        if (!entry.method && !isImportOrEdit) return alert('Please select a cash account.');
      } else if (obType === 'Investment') {
        entry.investmentGroup = formEls.openingGroup.value || (e ? e.investmentGroup : '');
        entry.investmentSub = formEls.openingInvSub.value || (e ? e.investmentSub : '');
        entry.method = 'N/A';
        if (!entry.investmentGroup && !isImportOrEdit) return alert('Please select an Investment Group.');
        if (!entry.investmentSub && !isImportOrEdit) return alert('Please select an Investment Sub-type.');
      }
    } else if (type === 'expense') {
      entry.category = formEls.category.value || (e ? e.category : '');
      if (!entry.category && !isImportOrEdit) return alert('Please select a Category.');

      if (entry.category === 'Investments') {
        entry.investmentGroup = formEls.invGroup.value || (e ? e.investmentGroup : '');
        entry.investmentSub = formEls.invSub.value || (e ? e.investmentSub : '');
        if (!entry.investmentGroup && !isImportOrEdit) return alert('Please select an Investment Group.');
        if (!entry.investmentSub && !isImportOrEdit) return alert('Please select an Investment Sub-type.');
        entry.method = 'N/A'; // Investment is a category, not tied to a single liquid method
      } else if (entry.category === 'Insurance') {
        entry.insuranceType = formEls.insType.value || (e ? e.insuranceType : '');
        entry.insuranceFor = formEls.insFor.value || (e ? e.insuranceFor : '');
        if (!entry.insuranceType && !isImportOrEdit) return alert('Please select Insurance Type.');
        if (!entry.insuranceFor && !isImportOrEdit) return alert('Please select Insured For.');
      } else if (entry.category === 'Credit Card Payment') {
        entry.method = formEls.method.value || (e ? e.method : ''); // Source account for payment
      }
    }

    // Clean up empty strings for consistency
    Object.keys(entry).forEach(key => { if (entry[key] === '') entry[key] = null; });

    if (editId) {
      data = data.map(t => t.id === editId ? entry : t);
      editId = null;
      formEls.addBtn.classList.remove('hidden');
      formEls.saveBtn.classList.add('hidden');
      formEls.cancelBtn.classList.add('hidden');
    } else {
      data.push(entry);
    }

    if (!isImportOrEdit) {
      saveAll();
      renderAll();
      clearForm();
    }
  }

  formEls.addBtn.addEventListener('click', () => submitForm());
  formEls.saveBtn.addEventListener('click', () => {
    const entryToEdit = data.find(t => t.id === editId);
    if (entryToEdit) submitForm(entryToEdit);
  });
  formEls.cancelBtn.addEventListener('click', () => {
    editId = null;
    formEls.addBtn.classList.remove('hidden');
    formEls.saveBtn.classList.add('hidden');
    formEls.cancelBtn.classList.add('hidden');
    clearForm();
  });

  function loadEdit(id) {
    if (!requireSignedIn()) return;
    const e = data.find(t => t.id === id);
    if (!e) return;

    editId = id;

    // Set common fields
    formEls.type.value = e.type;
    formEls.amount.value = e.amount;
    formEls.date.value = e.date;
    formEls.desc.value = e.desc;
    formEls.currentIdDisplay.textContent = e.id;

    // Reset dropdowns and update fields to correct visibility for initial setup
    updateTransactionFormFields();

    // Set non-common fields based on type
    if (e.type === 'income') {
      formEls.incomeSource.value = e.incomeSource;
      formEls.method.value = e.method;
    } else if (e.type === 'expense') {
      formEls.category.value = e.category || 'Food'; // Default to Food if missing
      formEls.method.value = e.method || '';

      // Re-run field update based on category to set visibility for sub-fields
      updateTransactionFormFields();

      if (e.category === 'Investments') {
        formEls.invGroup.value = e.investmentGroup;
        updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub); // Populate sub-dropdown
        formEls.invSub.value = e.investmentSub;
      } else if (e.category === 'Insurance') {
        formEls.insType.value = e.insuranceType;
        formEls.insFor.value = e.insuranceFor;
      }
    } else if (e.type === 'opening_balance') {
      if (e.investmentGroup && e.investmentGroup !== 'Cash') {
        formEls.openingType.value = 'Investment';
        updateTransactionFormFields();
        formEls.openingGroup.value = e.investmentGroup;
        updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingInvSub); // Populate sub-dropdown
        formEls.openingInvSub.value = e.investmentSub;
      } else {
        formEls.openingType.value = 'Cash';
        updateTransactionFormFields();
        formEls.openingSub.value = e.method;
      }
    }
  }

  function deleteEntry(id) {
    if (!requireSignedIn()) return;
    if (confirm('Are you sure you want to delete this transaction?')) {
      data = data.filter(t => t.id !== id);
      saveAll();
      renderAll();
      if (editId === id) clearForm();
    }
  }

  // --- KPI RENDER ---
  function renderKPIs() {
    const curDate = new Date();
    const curMonth = curDate.getMonth();
    const curYear = curDate.getFullYear();
    const prevMonth = curMonth === 0 ? 11 : curMonth - 1;
    const prevYear = curMonth === 0 ? curYear - 1 : curYear;

    const operationalData = data.filter(d => d.type !== 'opening_balance');

    const filterMonth = (d, m, y) => {
      const dt = new Date(d);
      return dt.getMonth() === m && dt.getFullYear() === y;
    };

    const sum = (arr) => arr.reduce((acc, curr) => acc + Number(curr.amount), 0);

    const curData = operationalData.filter(d => filterMonth(d.date, curMonth, curYear));
    const prevData = operationalData.filter(d => filterMonth(d.date, prevMonth, prevYear));

    const inc = sum(curData.filter(d => d.type === 'income'));
    const exp = sum(curData.filter(d => d.type === 'expense' && d.category !== 'Investments'));
    const inv = sum(curData.filter(d => d.type === 'expense' && d.category === 'Investments'));

    const prevInc = sum(prevData.filter(d => d.type === 'income'));
    const prevExp = sum(prevData.filter(d => d.type === 'expense' && d.category !== 'Investments'));

    // Monthly KPIs
    document.getElementById('kpiIncome').innerText = fmt(inc);
    document.getElementById('kpiExpense').innerText = fmt(exp + inv);

    const momInc = (inc / (prevInc || 1) - 1) * 100;
    const momExp = ((exp + inv) / (prevExp || 1) - 1) * 100;

    const momIncEl = document.getElementById('momIncome');
    momIncEl.className = momInc >= 0 ? 'trend-up' : 'trend-down';
    momIncEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${momInc >= 0 ? '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>' : '<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline>'}</svg> ${Math.abs(momInc).toFixed(1)}% vs Last Month`;

    const momExpEl = document.getElementById('momExpense');
    momExpEl.className = momExp < 0 ? 'trend-up' : 'trend-down';
    momExpEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${momExp < 0 ? '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>' : '<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline>'}</svg> ${Math.abs(momExp).toFixed(1)}% vs Last Month`;

    // Credit Card KPI
    const ccData = data.filter(d => d.method === 'credit_card' || d.category === 'Credit Card Payment');
    const ccDue = ccData.reduce((acc, curr) => {
      let amount = Number(curr.amount);
      if (curr.type === 'expense' && curr.category !== 'Credit Card Payment') {
        return acc + amount;
      }
      if (curr.category === 'Credit Card Payment') {
        return acc - amount;
      }
      return acc;
    }, 0);

    const ccLimit = settings.ccLimit || DEFAULT_CC_LIMIT;
    const ccLimitDisplay = document.getElementById('ccLimitDisplay');
    ccLimitDisplay.innerText = fmt(ccLimit);
    document.getElementById('kpiCCDue').innerText = fmt(ccDue);
    const ccCard = document.getElementById('ccCard');
    const ccAlert = document.getElementById('ccAlert');
    ccCard.classList.remove('cc-alert-high');
    ccAlert.classList.add('hidden');
    if (ccDue > ccLimit * 0.8) {
      ccCard.classList.add('cc-alert-high');
      ccAlert.classList.remove('hidden');
    }

    // Investment KPI
    const allInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
    const totalInvested = sum(allInvestments);
    document.getElementById('kpiInvest').innerText = fmt(totalInvested);

    const prevAllInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'))
      .filter(d => new Date(d.date) <= new Date(prevYear, prevMonth + 1, 0));
    const prevTotalInvested = sum(prevAllInvestments);

    const momInvest = (totalInvested / (prevTotalInvested || 1) - 1) * 100;

    const momInvestEl = document.getElementById('momInvest');
    momInvestEl.style.color = momInvest >= 0 ? 'var(--primary-dark)' : 'var(--danger)';
    momInvestEl.innerHTML = `${momInvest >= 0 ? '<span style="color:var(--success)">+</span>' : '<span style="color:var(--danger)">-</span>'} ${Math.abs(momInvest).toFixed(1)}% vs Last Month Total (${fmt(prevTotalInvested)})`;

    // Net Liquidity
    const liquidMethods = data.filter(d => d.type !== 'opening_balance' && d.category !== 'Investments');
    const netLiquidity = liquidMethods.reduce((acc, curr) => {
      let amount = Number(curr.amount);
      if (curr.type === 'income' || curr.method === 'credit_card_payment') {
        return acc + amount;
      }
      if (curr.type === 'expense' && curr.category !== 'Credit Card Payment') {
        return acc - amount;
      }
      // CC expenses are tracked via due, not net liquidity
      return acc;
    }, 0);

    // Add opening cash balances
    const openingCash = data.filter(d => d.type === 'opening_balance' && d.investmentGroup === 'Cash')
      .reduce((acc, curr) => acc + Number(curr.amount), 0);

    const totalNet = netLiquidity + openingCash;
    document.getElementById('kpiNet').innerText = fmt(totalNet);

    // Net Liquidity Breakdown
    const breakdownContainer = document.getElementById('netLiquidityBreakdown');
    let breakdownHtml = '';
    const liquidTransactions = data.filter(d => (d.type === 'income' || d.type === 'opening_balance' || d.category !== 'Investments') && d.category !== 'Credit Card Payment');

    const methodBalances = liquidTransactions.reduce((acc, curr) => {
      let key = curr.method || 'cash';
      if (curr.type === 'opening_balance' && curr.investmentGroup === 'Cash') {
        key = curr.method; // Use method for opening cash
      } else if (curr.type === 'opening_balance' && curr.investmentGroup !== 'Cash') {
        return acc; // Skip investment opening balance
      } else if (curr.type === 'income') {
        // Income adds to the method/account used
        acc[key] = (acc[key] || 0) + Number(curr.amount);
        return acc;
      } else if (curr.type === 'expense') {
        const isExpense = curr.category !== 'Credit Card Payment';
        const amount = isExpense ? -Number(curr.amount) : Number(curr.amount);
        acc[key] = (acc[key] || 0) + amount;
        return acc;
      }
      return acc;
    }, {});

    const allMethodKeys = new Set([...Object.keys(methodNames), ...Object.keys(methodBalances)].filter(key => key !== 'credit_card' && key !== 'credit_card_payment'));
    allMethodKeys.forEach(key => {
      if (!key) return; // Skip null/undefined keys

      const name = methodNames[key] || key;
      const balance = methodBalances[key] || 0;

      // Only display methods that have transactions or are one of the canonical methods (excluding CC)
      if (balance !== 0 || CANONICAL_METHODS[key]) {
        breakdownHtml += `<div><span>${name}</span><span>${fmt(balance)}</span></div>`;
      }
    });

    breakdownContainer.innerHTML = breakdownHtml;

    renderInvestmentKPICharts();
  }

  // --- Investment breakdown helpers and rendering ---
  function getColorPalette(count) {
    const colorsVars = ['--c1', '--c2', '--c3', '--c4', '--c5', '--c6', '--c7', '--c8', '--c9', '--c10', '--c11', '--c12']
      .map(v => getComputedStyle(document.documentElement).getPropertyValue(v).trim() || '#3b82f6');
    return Array.from({ length: count }, (_, i) => colorsVars[i % colorsVars.length]);
  }

  function applyDateRangeToInvestments(entries, range) {
    if (!range || range === 'all') return entries;
    const cutoff = new Date();
    cutoff.setMonth(cutoff.getMonth() - Number(range));
    return entries.filter(e => new Date(e.date) >= cutoff);
  }

  function rollupMajorBuckets(entries) {
    const byBucket = entries.reduce((acc, curr) => {
      const group = curr.investmentGroup;
      const bucket = MAJOR_BUCKETS[group] || 'Other';
      acc[bucket] = (acc[bucket] || 0) + Number(curr.amount);
      return acc;
    }, {});
    return Object.entries(byBucket)
      .map(([bucket, amount]) => ({ bucket, amount }))
      .filter(x => x.amount > 0)
      .sort((a, b) => b.amount - a.amount);
  }

  function rollupSubCategories(entries) {
    const bySub = entries.reduce((acc, curr) => {
      const sub = curr.investmentSub || curr.investmentGroup || 'Other';
      acc[sub] = (acc[sub] || 0) + Number(curr.amount);
      return acc;
    }, {});
    return Object.entries(bySub)
      .map(([sub, amount]) => ({ sub, amount }))
      .filter(x => x.amount > 0)
      .sort((a, b) => b.amount - a.amount);
  }

  function renderInvestmentKPICharts() {
    if (typeof Chart === 'undefined') return;

    const investments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));

    // Populate Major Bucket filter for breakdown panel
    const bucketOptions = rollupMajorBuckets(investments).map(i => `<option value="${i.bucket}">${i.bucket}</option>`).join('');
    document.getElementById('invBucketFilter').innerHTML = '<option value="">All Buckets</option>' + bucketOptions;

    const toggleBtn = document.getElementById('toggleInvBreakdown');
    const panel = document.getElementById('invBreakdownPanel');
    toggleBtn.textContent = panel.classList.contains('hidden') ? 'View breakdown' : 'Hide breakdown';
    toggleBtn.onclick = () => {
      panel.classList.toggle('hidden');
      toggleBtn.textContent = panel.classList.contains('hidden') ? 'View breakdown' : 'Hide breakdown';
      if (!panel.classList.contains('hidden')) {
        renderInvestmentKPICharts(); // Re-render when visible
      }
    };

    if (panel.classList.contains('hidden')) {
      return;
    }

    const range = document.getElementById('invDateRange').value;
    const viewMode = document.getElementById('invViewMode').value;
    const bucketFilter = document.getElementById('invBucketFilter').value;

    let filteredEntries = applyDateRangeToInvestments(investments, range);

    let items, title;

    if (viewMode === 'top4' || !bucketFilter) {
      // Group by Major Bucket
      items = rollupMajorBuckets(filteredEntries);
      title = `Major buckets (${items.length})`;
      if (bucketFilter) {
        // If a bucket is selected, filter and switch to subcats implicitly for the chart view.
        // This is a forced drill-down.
        filteredEntries = filteredEntries.filter(e => MAJOR_BUCKETS[e.investmentGroup] === bucketFilter);
        items = rollupSubCategories(filteredEntries);
        title = `${bucketFilter} Subcategories (${items.length})`;
      } else {
        items = items.slice(0, 4); // Show top 4 for top4 view
      }

    } else if (viewMode === 'subcats' && bucketFilter) {
      // Group by Subcategory within the selected bucket
      filteredEntries = filteredEntries.filter(e => MAJOR_BUCKETS[e.investmentGroup] === bucketFilter);
      items = rollupSubCategories(filteredEntries);
      title = `${bucketFilter} Subcategories (${items.length})`;
    } else {
      // Default to all subcategories if viewMode is 'subcats' but no filter selected (or if top4 is still selected but filter is cleared)
      items = rollupSubCategories(filteredEntries);
      title = `All Subcategories (${items.length})`;
    }

    document.getElementById('invBarTitle').textContent = title;
    document.getElementById('invPieTitle').textContent = 'Share';

    const labels = items.map(i => i.bucket || i.sub);
    const values = items.map(i => i.amount);
    const colors = getColorPalette(labels.length);

    if (invBreakdownBarChart) invBreakdownBarChart.destroy();
    const barCtx = document.getElementById('invBreakdownBar');
    if (barCtx) {
      invBreakdownBarChart = new Chart(barCtx.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (c) => `${c.label}: ${fmt(c.parsed.x)}`
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { callback: (v) => fmt(v).replace('₹', '₹ ') },
              grid: { color: '#eef2ff' }
            },
            y: { grid: { display: false } }
          }
        }
      });
    }

    if (invBreakdownPieChart) invBreakdownPieChart.destroy();
    const pieCtx = document.getElementById('invBreakdownPie');
    if (pieCtx) {
      invBreakdownPieChart = new Chart(pieCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            hoverOffset: 6,
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { boxWidth: 10 } },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const total = values.reduce((a, b) => a + b, 0);
                  const share = total ? ((c.parsed / total) * 100).toFixed(1) : '0.0';
                  return `${c.label}: ${fmt(c.parsed)} (${share}%)`;
                }
              }
            },
          },
          cutout: '60%',
          onClick: (evt, els) => {
            if (!els || !els.length) return;
            const idx = els[0].index;
            const bucket = labels[idx];
            document.getElementById('invViewMode').value = 'subcats';
            document.getElementById('invBucketFilter').value = bucket;
            renderInvestmentKPICharts();
          }
        }
      });
    }

    renderQuickSubDropdowns(investments.filter(e => MAJOR_BUCKETS[e.investmentGroup]));
  }

  function renderQuickSubDropdowns(entries) {
    const quickSubsContainer = document.getElementById('invQuickSubs');
    quickSubsContainer.innerHTML = '';

    const order = ['Equity', 'Mutual Funds', 'Debt', 'Retirement', 'Real Estate', 'Commodities', 'Crypto', 'Other'];
    const items = rollupMajorBuckets(entries);
    const totals = Object.fromEntries(items.map(i => [i.bucket, i.amount]));

    const blocks = order.filter(b => Object.keys(totals).includes(b)).map(bucket => {
      const groupsInBucket = Object.keys(MAJOR_BUCKETS).filter(g => MAJOR_BUCKETS[g] === bucket);
      const subValues = rollupSubCategories(entries.filter(d => groupsInBucket.includes(d.investmentGroup)));

      const dropdownHtml = subValues.length ? subValues.map(x => `
        <div class="sub-dropdown-item">
          <span>${x.sub}</span>
          <strong style="color:var(--primary-dark)">${fmt(x.amount)}</strong>
        </div>
      `).join('') : `<div class="sub-dropdown-item" style="color:#aaa;">No data</div>`;

      return `
        <div class="quick-sub-card">
          <div class="quick-sub-header">
            <div class="quick-sub-title">${bucket}</div>
            <span class="total-badge">${fmt(totals[bucket] || 0)}</span>
          </div>
          <div class="sub-dropdown-container">
            <button class="btn-outline" style="width:100%; padding:6px; font-size:12px;" onclick="this.nextElementSibling.classList.toggle('show')">
              View sub-types ▾
            </button>
            <div class="sub-dropdown-menu">
              ${dropdownHtml}
            </div>
          </div>
        </div>
      `;
    });

    quickSubsContainer.innerHTML = blocks.join('');

    // Close dropdowns if clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.sub-dropdown-container')) {
        document.querySelectorAll('.sub-dropdown-menu').forEach(d => d.classList.remove('show'));
      }
    });
  }

  // --- CHART FUNCTIONS ---
  function prepareMonthlyData(range, filteredData = data) {
    const today = new Date();
    let numMonths = Number(range);
    if (range === 'all') {
      const firstDate = filteredData.length > 0 ? new Date(filteredData[filteredData.length - 1].date) : today;
      // Calculate total months since first transaction or max of 3 years
      const diffMonths = (today.getFullYear() - firstDate.getFullYear()) * 12 + (today.getMonth() - firstDate.getMonth());
      numMonths = Math.min(diffMonths + 1, 36); // Max 3 years for 'all' to prevent massive chart
    }

    const monthlyData = {};
    const labels = [];

    for (let i = numMonths - 1; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const monthKey = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
      labels.push(d.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }));
      monthlyData[monthKey] = { income: 0, expense: 0, investment: 0 };
    }

    filteredData.forEach(entry => {
      const date = new Date(entry.date);
      const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
      if (monthlyData[monthKey]) {
        if (entry.type === 'income') {
          monthlyData[monthKey].income += Number(entry.amount);
        } else if (entry.type === 'expense') {
          if (entry.category === 'Investments') {
            monthlyData[monthKey].investment += Number(entry.amount);
          } else {
            monthlyData[monthKey].expense += Number(entry.amount);
          }
        }
      }
    });

    const income = Object.values(monthlyData).map(m => m.income);
    const expense = Object.values(monthlyData).map(m => m.expense);
    const investment = Object.values(monthlyData).map(m => m.investment);
    const netIncomeSeries = income.map((inc, i) => inc - expense[i] - investment[i]);

    return { labels, income, expense, investment, netIncomeSeries };
  }

  function renderCharts() {
    if (typeof Chart === 'undefined') return;
    const range = document.getElementById('mainChartFilter').value;
    const { labels, income, expense, investment, netIncomeSeries } = prepareMonthlyData(range);

    if (chartMain) chartMain.destroy();
    const ctxMain = document.getElementById('mainChart').getContext('2d');
    chartMain = new Chart(ctxMain, {
      data: {
        labels: labels,
        datasets: [
          { type: 'bar', label: 'Income', data: income, backgroundColor: 'rgba(16, 185, 129, 0.8)', stack: 'flow' },
          { type: 'bar', label: 'Expense', data: expense.map(e => -e), backgroundColor: 'rgba(239, 68, 68, 0.8)', stack: 'flow' },
          { type: 'bar', label: 'Investment', data: investment.map(i => -i), backgroundColor: 'rgba(14, 165, 233, 0.8)', stack: 'flow' },
          {
            type: 'line', label: 'Net Income', data: netIncomeSeries, borderColor: '#000000',
            backgroundColor: 'rgba(0, 0, 0, 0)', yAxisID: 'y1', tension: 0.4, borderWidth: 3
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${fmt(Math.abs(c.parsed.y))}`
            }
          }
        },
        scales: {
          x: { stacked: true },
          y: {
            stacked: true, beginAtZero: false, position: 'left',
            ticks: { callback: (v) => fmt(v).replace('₹', '₹ ') },
            grid: { color: '#eef2ff' }
          },
          y1: {
            position: 'right', grid: { drawOnChartArea: false },
            ticks: { callback: (v) => fmt(v).replace('₹', '₹ ') }
          }
        }
      }
    });

    renderWalletUnified();
  }

  function renderWalletUnified() {
    if (typeof Chart === 'undefined') return;

    const allExpenses = data.filter(d => d.type === 'expense' && d.category !== 'Investments' && d.category !== 'Credit Card Payment');
    const categoryCounts = allExpenses.reduce((acc, curr) => {
      acc[curr.category] = (acc[curr.category] || 0) + Number(curr.amount);
      return acc;
    }, {});

    const chartType = document.getElementById('expenseChartType').value;
    const infoEl = document.getElementById('expenseChartInfo');
    const categories = Object.keys(categoryCounts).sort((a, b) => categoryCounts[b] - categoryCounts[a]);

    // Populate Category Filter Dropdown
    const checkboxes = categories.map(c => {
      const isChecked = selectedExpenseCategories.length === 0 || selectedExpenseCategories.includes(c);
      return `<div class="ms-item"><input type="checkbox" class="expense-chk" value="${c}" ${isChecked ? 'checked' : ''} onclick="updateExpenseCategorySelection(this)"><span>${c} (${fmt(categoryCounts[c])})</span></div>`;
    }).join('');
    document.getElementById('expenseCheckboxes').innerHTML = checkboxes;

    // Filter categories based on selection
    const filteredCategories = selectedExpenseCategories.length > 0 ? categories.filter(c => selectedExpenseCategories.includes(c)) : categories;
    const filteredValues = filteredCategories.map(c => categoryCounts[c]);

    // Handle empty data for chart
    if (filteredValues.length === 0) {
      if (expenseChart) expenseChart.destroy();
      infoEl.textContent = 'No expenses found in selected categories.';
      return;
    } else {
      infoEl.textContent = '';
    }

    // Update filter button text
    if (selectedExpenseCategories.length === 0 || selectedExpenseCategories.length === categories.length) {
      document.getElementById('expenseFilterBtn').textContent = 'All Categories ▾';
      document.getElementById('resetExpenseDrilldown').classList.add('hidden');
    } else {
      document.getElementById('expenseFilterBtn').textContent = `${selectedExpenseCategories.length} Categories ▾`;
      document.getElementById('resetExpenseDrilldown').classList.remove('hidden');
    }

    const colors = getColorPalette(filteredCategories.length);

    if (expenseChart) expenseChart.destroy();
    const ctx = document.getElementById('expenseChart').getContext('2d');

    if (chartType === 'pie') {
      expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: filteredCategories,
          datasets: [{
            data: filteredValues, backgroundColor: colors, hoverOffset: 6, borderColor: '#ffffff', borderWidth: 2
          }]
        },
        options: {
          maintainAspectRatio: false, responsive: true, cutout: '60%',
          plugins: {
            legend: { position: 'right', labels: { boxWidth: 10 } },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const total = filteredValues.reduce((a, b) => a + b, 0);
                  const share = total ? ((c.parsed / total) * 100).toFixed(1) : '0.0';
                  return `${c.label}: ${fmt(c.parsed)} (${share}%)`;
                }
              }
            }
          }
        }
      });
    } else if (chartType === 'bar') {
      expenseChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: filteredCategories,
          datasets: [{
            data: filteredValues, backgroundColor: colors,
          }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c) => `${c.label}: ${fmt(c.parsed.x)}` } }
          },
          scales: {
            x: {
              beginAtZero: true, ticks: { callback: (v) => fmt(v).replace('₹', '₹ ') }, grid: { color: '#eef2ff' }
            },
            y: { grid: { display: false } }
          }
        }
      });
    }
  }

  function updateExpenseCategorySelection(checkbox) {
    const category = checkbox.value;
    if (checkbox.checked) {
      if (!selectedExpenseCategories.includes(category)) {
        selectedExpenseCategories.push(category);
      }
    } else {
      selectedExpenseCategories = selectedExpenseCategories.filter(c => c !== category);
    }
  }

  function resetExpenseDrilldown() {
    selectedExpenseCategories = [];
    document.querySelectorAll('.expense-chk').forEach(c => c.checked = true);
    document.getElementById('expenseFilterBtn').textContent = 'All Categories ▾';
    document.getElementById('resetExpenseDrilldown').classList.add('hidden');
    renderWalletUnified();
  }

  // --- ADVANCED ANALYTICS WITH SYNCED FILTERS ---
  function populateAnalyticsDropdowns() {
    const groupSelect = document.getElementById('anlInvGroup');
    const options = Object.keys(INVESTMENT_STRUCTURE).map(group => `<option value="${group}">${group}</option>`).join('');
    groupSelect.innerHTML = '<option value="">All Groups</option>' + options;
  }

  function updateAnlSubDropdown() {
    const group = document.getElementById('anlInvGroup').value;
    const subSelect = document.getElementById('anlInvSub');
    let options = '<option value="">All Types</option>';
    if (group && INVESTMENT_STRUCTURE[group]) {
      options += Object.keys(INVESTMENT_STRUCTURE[group]).map(sub => `<option value="${sub}">${sub}</option>`).join('');
    }
    subSelect.innerHTML = options;
  }

  function renderAdvancedCharts() {
    if (typeof Chart === 'undefined') return;

    const range = document.getElementById('dateFilter').value;
    const chartType = document.getElementById('chartType').value;
    const invGroup = document.getElementById('anlInvGroup').value;
    const invSub = document.getElementById('anlInvSub').value;
    const chartTitleEl = document.getElementById('chartTitle');
    const chartTypesCanvas = document.getElementById('chartInvTypesModal');
    const chartGrowthCanvas = document.getElementById('chartInvGrowthModal');

    let relevantData = applyDateRangeToInvestments(data, range);

    if (invGroup || invSub) {
      relevantData = relevantData.filter(d => {
        const isInv = (d.type === 'opening_balance' && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments');
        if (!isInv) return false;
        if (invGroup && d.investmentGroup !== invGroup) return false;
        if (invSub && d.investmentSub !== invSub) return false;
        return true;
      });
    } else {
      relevantData = relevantData.filter(d => (d.type === 'opening_balance' && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments'));
    }

    const invs = relevantData.filter(d => (d.type === 'opening_balance' && d.investmentGroup !== 'Cash') || (d.category === 'Investments'));

    if (chartType === 'types') {
      chartGrowthCanvas.classList.add('hidden');
      chartTypesCanvas.classList.remove('hidden');
      chartTitleEl.textContent = 'Investment Breakdown by Type';

      const byType = invs.reduce((acc, curr) => {
        const key = curr.investmentSub || curr.investmentGroup || 'Uncategorized';
        acc[key] = (acc[key] || 0) + Number(curr.amount);
        return acc;
      }, {});
      const labels = Object.keys(byType).sort((a, b) => byType[b] - byType[a]);
      const values = labels.map(l => byType[l]);
      const colors = getColorPalette(labels.length);

      const ctxTypes = chartTypesCanvas?.getContext('2d');
      if (ctxTypes) {
        if (chartInvTypesModal) chartInvTypesModal.destroy();
        chartInvTypesModal = new Chart(ctxTypes, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: values, backgroundColor: colors, borderWidth: 1
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 10 } },
              tooltip: {
                callbacks: {
                  label: (c) => {
                    const total = values.reduce((a, b) => a + b, 0);
                    const share = total ? ((c.parsed / total) * 100).toFixed(1) : '0.0';
                    return `${c.label}: ${fmt(c.parsed)} (${share}%)`;
                  }
                }
              },
            },
            cutout: '60%'
          }
        });
      }

    } else if (chartType === 'growth') {
      chartTypesCanvas.classList.add('hidden');
      chartGrowthCanvas.classList.remove('hidden');
      chartTitleEl.textContent = 'Cumulative Investment Growth Over Time';

      const points = invs.map(i => ({ date: new Date(i.date), amount: Number(i.amount) })).sort((a, b) => a.date - b.date);

      let cumulative = 0;
      const growthLabels = points.map(p => p.date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }));
      const growthValues = points.map(p => { cumulative += p.amount; return cumulative; });

      const ctxGrowth = chartInvGrowthModal?.getContext('2d');
      if (ctxGrowth) {
        if (chartInvGrowthModal) chartInvGrowthModal.destroy();
        chartInvGrowthModal = new Chart(ctxGrowth, {
          type: 'line',
          data: {
            labels: growthLabels,
            datasets: [{
              label: 'Invested Amount',
              data: growthValues,
              borderColor: 'var(--primary)',
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              fill: true,
              tension: 0.4,
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { callback: (v) => fmt(v).replace('₹', '₹ ') },
                grid: { color: '#eef2ff' }
              },
              x: { grid: { display: false } }
            }
          }
        });
      }
    }
  }

  // --- SETTINGS FUNCTIONS ---
  function renderSettings() {
    document.getElementById('currentProfileName').value = currentProfile || 'Guest (Offline)';
    document.getElementById('ccLimitInput').value = settings.ccLimit || DEFAULT_CC_LIMIT;

    // Render Methods
    const methodList = document.getElementById('methodList');
    methodList.innerHTML = Object.entries(methodNames)
      .filter(([key]) => key !== 'credit_card_payment')
      .map(([key, name]) => `
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding:8px 0;">
          <span>${name}</span>
          ${CANONICAL_METHODS[key] ? '<span style="color:var(--text-muted); font-size:11px;">(System)</span>' :
        `<button onclick="deleteMethod('${key}')" class="btn-danger" style="padding:4px 8px; font-size:11px;">Remove</button>`}
        </div>
      `).join('');

    // Render Income Sources
    const incomeList = document.getElementById('incomeList');
    incomeList.innerHTML = incomeSources.map(source => `
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding:8px 0;">
          <span>${source}</span>
          <button onclick="deleteIncome('${source}')" class="btn-danger" style="padding:4px 8px; font-size:11px;">Remove</button>
        </div>
      `).join('');
  }

  document.getElementById('saveSettingsBtn').addEventListener('click', () => {
    const limit = Number(document.getElementById('ccLimitInput').value);
    if (limit >= 0 && !isNaN(limit)) {
      settings.ccLimit = limit;
      saveAll();
      renderKPIs();
      alert('Settings saved!');
    } else {
      alert('Please enter a valid Credit Card Limit.');
    }
  });

  function deleteMethod(key) {
    if (confirm(`Remove method "${methodNames[key]}"?`)) {
      delete methodNames[key];
      saveAll();
      renderAll();
    }
  }

  function addMethod() {
    const input = document.getElementById('newMethod');
    const name = input.value.trim();
    if (name) {
      const key = toKey(name);
      if (!methodNames[key]) {
        methodNames[key] = name;
        input.value = '';
        saveAll();
        renderAll();
      } else {
        alert('Method already exists.');
      }
    }
  }

  function deleteIncome(source) {
    if (confirm(`Remove income source "${source}"?`)) {
      incomeSources = incomeSources.filter(s => s !== source);
      saveAll();
      renderAll();
    }
  }

  function addIncome() {
    const input = document.getElementById('newIncome');
    const source = input.value.trim();
    if (source && !incomeSources.includes(source)) {
      incomeSources.push(source);
      input.value = '';
      saveAll();
      renderAll();
    } else if (source) {
      alert('Income source already exists.');
    }
  }

  function convertToCSV(data) {
    const headers = ['id', 'type', 'amount', 'date', 'desc', 'category', 'method', 'incomeSource', 'investmentGroup', 'investmentSub', 'insuranceType', 'insuranceFor'];
    const rows = data.map(obj => headers.map(header => {
      let value = obj[header] ?? '';
      if (typeof value === 'string' && value.includes(',')) {
        return `"${value.replace(/"/g, '""')}"`;
      }
      return value;
    }).join(','));

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');

    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `MoneyMirror_Export_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert('Your browser does not support CSV export.');
    }
  }

  // --- IMPORT FUNCTIONS ---
  function processImportedData() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    if (!file) return alert('Please select a CSV file.');

    const reader = new FileReader();
    reader.onload = function (e) {
      const csvText = e.target.result;
      const parsedData = parseCSV(csvText);

      let newEntries = 0;
      parsedData.forEach(entry => {
        // Basic validation and type coercion
        if (entry.type && entry.amount && entry.date) {
          entry.amount = Number(entry.amount);
          // Apply submitForm logic for clean data entry
          submitForm(entry, true);
          newEntries++;
        }
      });

      saveAll();
      renderAll();
      document.getElementById('importModal').classList.remove('open');
      alert(`Successfully imported ${newEntries} new entries.`);
    };
    reader.readAsText(file);
  }

  function parseCSV(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim() !== '');
    if (lines.length < 2) return [];

    // Improved regex to handle commas inside quoted fields
    const headerLine = lines[0];
    const headers = headerLine.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h => h.replace(/"/g, '').toLowerCase().trim());
    
    const dataRows = [];
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
        if (!values || values.length !== headers.length) continue;
        
        const entry = {};
        for (let j = 0; j < headers.length; j++) {
            let value = values[j] ? values[j].replace(/^"|"$/g, '').replace(/""/g, '"') : '';
            entry[headers[j]] = value;
        }
        dataRows.push(entry);
    }
    return dataRows;
}
  // --- ADDED MISSING HELPER FUNCTION ---
function getBadge(entry) {
    if (entry.type === 'income') return '<span class="badge badge-income">Income</span>';
    if (entry.type === 'opening_balance') return '<span class="badge badge-opening">Opening</span>';
    if (entry.category === 'Investments') return '<span class="badge badge-inv">Invest</span>';
    if (entry.category === 'Insurance') return '<span class="badge badge-ins">Insure</span>';
    if (entry.category === 'Credit Card Payment') return '<span class="badge badge-cc">CC Pay</span>';
    return '<span class="badge badge-expense">Expense</span>';
}

// --- FIXED RECENT ENTRIES RENDER ---
function renderRecentEntries() {
    try {
        const tableBody = document.getElementById('recentEntries');
        const filterType = document.getElementById('recentType').value;
        const filterCat = document.getElementById('recentCategory').value;
        const searchVal = document.getElementById('recentSearch').value.toLowerCase();

        let filteredData = data.filter(e => {
            if (filterType && e.type !== filterType) return false;
            if (filterCat && e.category !== filterCat) return false;
            if (searchVal && !e.desc.toLowerCase().includes(searchVal)) return false;
            return true;
        });

        if (filteredData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:20px 0;">No transactions match the current filters.</td></tr>';
            return;
        }

        tableBody.innerHTML = filteredData.map(e => {
            const amountDisplay = e.type === 'income' || e.type === 'opening_balance' ? `<span style="color:var(--success)">+${fmt(e.amount)}</span>` : `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;

            let methodDisplay = '';
            if (e.type === 'opening_balance' && e.investmentGroup && e.investmentGroup !== 'Cash') {
                methodDisplay = e.investmentSub || e.investmentGroup;
            } else if (e.type === 'expense' && e.category === 'Investments') {
                methodDisplay = e.investmentSub || e.investmentGroup;
            } else if (e.category === 'Credit Card Payment') {
                methodDisplay = `${methodNames[e.method] || e.method || '--'} → CC`;
            } else {
                methodDisplay = methodNames[e.method] || e.method || '--';
            }

            let categoryDisplay = e.category === 'Investments' ? e.investmentSub :
                e.category === 'Insurance' ? `${e.insuranceType} (${e.insuranceFor})` :
                e.type === 'expense' ? e.category : e.type === 'income' ? e.incomeSource : '--';
                
            return `
                <tr>
                    <td>${getBadge(e)}</td>
                    <td>${e.date}</td>
                    <td style="font-weight:600; text-align:right">${amountDisplay}</td>
                    <td>${e.desc}</td>
                    <td>${categoryDisplay}</td>
                    <td>${methodDisplay}</td>
                    <td class="flex-row">
                        <button onclick="loadEdit('${e.id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:4px" title="Edit">✎</button>
                        <button onclick="deleteEntry('${e.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:4px" title="Delete">×</button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (err) {
        console.error("Error rendering table:", err);
    }
}

// Sample Data
function loadSampleData() {
    if (!confirm("Overwrite data with sample?")) return;

    data = [];
    methodNames = { ...CANONICAL_METHODS };
    methodNames['salary_acct'] = 'Salary Account (HDFC)';
    methodNames['savings_acct'] = 'Savings Account (SBI)';
    methodNames['digital_wallet'] = 'Google Pay';
    incomeSources = ['Salary (Primary)', 'Freelance Income', 'Interest'];
    settings = { ccLimit: 200000 };

    // Opening Balances (Current)
    data.push({ id: uid(), type: 'opening_balance', amount: 80000, date: dateInLastMonths([0, 0]), desc: 'Opening — HDFC Cash', investmentGroup: 'Cash', investmentSub: 'Salary Account (HDFC)', method: 'salary_acct', category: 'N/A' });
    data.push({ id: uid(), type: 'opening_balance', amount: 45000, date: dateInLastMonths([0, 0]), desc: 'Opening — SBI Cash', investmentGroup: 'Cash', investmentSub: 'Savings Account (SBI)', method: 'savings_acct', category: 'N/A' });
    data.push({ id: uid(), type: 'opening_balance', amount: 15000, date: dateInLastMonths([0, 0]), desc: 'Opening — Physical Cash', investmentGroup: 'Cash', investmentSub: 'Cash', method: 'cash', category: 'N/A' });
    data.push({ id: uid(), type: 'opening_balance', amount: 150000, date: dateInLastMonths([10, 10]), desc: 'Opening — Direct Stocks', investmentGroup: 'Equity (Stocks)', investmentSub: 'Direct Stocks', method: '', category: 'N/A' });
    data.push({ id: uid(), type: 'opening_balance', amount: 95000, date: dateInLastMonths([15, 15]), desc: 'Opening — Mutual Fund', investmentGroup: 'Mutual Funds', investmentSub: 'Equity Large Cap', method: '', category: 'N/A' });
    data.push({ id: uid(), type: 'opening_balance', amount: 40000, date: dateInLastMonths([5, 5]), desc: 'Opening — Gold Bond', investmentGroup: 'Bonds & Debt Instruments', investmentSub: 'Sovereign Gold Bond (SGB)', method: '', category: 'N/A' });
    data.push({ id: uid(), type: 'opening_balance', amount: 100000, date: dateInLastMonths([1, 1]), desc: 'Opening — Bitcoin (BTC)', investmentGroup: 'Crypto & Digital Assets', investmentSub: 'Bitcoin (BTC)', method: '', category: 'N/A' });

    // Income
    for (let m = 6; m >= 0; m--) {
        const salaryDate = dateInLastMonths([m, m]);
        data.push({ id: uid(), type: 'income', amount: 120000, date: salaryDate, desc: `Salary credit (${salaryDate})`, category: 'N/A', method: 'salary_acct', incomeSource: 'Salary (Primary)' });
        if (Math.random() > 0.6) {
            const freeDate = dateInLastMonths([m, m]);
            data.push({ id: uid(), type: 'income', amount: randBetween(8000, 18000), date: freeDate, desc: `Freelance project (${freeDate})`, category: 'N/A', method: 'salary_acct', incomeSource: 'Freelance Income' });
        }
    }

    // Expenses and Investments
    const expenseCategories = ['Food', 'Rent', 'Utilities', 'Shopping', 'Entertainment', 'Travel', 'Health', 'Education', 'Transport', 'Misc'];
    const methodsPool = ['salary_acct', 'savings_acct', 'cash', 'digital_wallet', 'credit_card'];

    for (let i = 0; i < 90; i++) {
        const dt = dateInLastMonths([randBetween(0, 6), randBetween(0, 6)]);
        const cat = pick(expenseCategories);
        const amt = randBetween(300, 9000);
        const method = pick(methodsPool);

        const baseEntry = { id: uid(), type: 'expense', amount: amt, date: dt, desc: `${cat} expense`, category: cat, method: method, incomeSource: '' };

        if (cat === 'Rent') {
            data.push({ ...baseEntry, amount: 25000, desc: 'Monthly Rent Payment', method: 'salary_acct' });
        } else if (cat === 'Utilities') {
            data.push({ ...baseEntry, amount: randBetween(2000, 6000), desc: 'Electricity/Internet Bill', method: pick(['digital_wallet', 'salary_acct']) });
        } else {
            data.push(baseEntry);
        }
    }

    // Credit Card payments
    for (let m = 6; m >= 0; m--) {
        const payDate = dateInLastMonths([m, m]);
        data.push({ id: uid(), type: 'expense', amount: randBetween(15000, 45000), date: payDate, desc: `Monthly CC Bill Payment`, category: 'Credit Card Payment', method: 'salary_acct', incomeSource: '' });
    }

    // New Investments
    for (let i = 0; i < 20; i++) {
        const dt = dateInLastMonths([randBetween(0, 6), randBetween(0, 6)]);
        data.push({ id: uid(), type: 'expense', amount: randBetween(5000, 15000), date: dt, desc: `SIP: Equity Fund`, category: 'Investments', method: 'N/A', incomeSource: '', investmentGroup: 'Mutual Funds', investmentSub: 'Equity Large Cap' });
    }
    for (let i = 0; i < 5; i++) {
        const dt = dateInLastMonths([randBetween(0, 6), randBetween(0, 6)]);
        data.push({ id: uid(), type: 'expense', amount: randBetween(20000, 40000), date: dt, desc: `Lumpsum: New Stock Purchase`, category: 'Investments', method: 'N/A', incomeSource: '', investmentGroup: 'Equity (Stocks)', investmentSub: 'Direct Stocks' });
    }

    saveAll();
    renderAll();
    alert('Sample data loaded! Please remember to sign in to save this data persistently.');
}

// --- CALCULATOR LOGIC (UPDATED) ---

// **This function has been updated to prevent consecutive operators,**
// **handle the leading '0' more cleanly, and limit the length of the result.**
function handleCalculatorInput(e) {
    const key = e.target.textContent.trim();
    const display = document.getElementById('calc-display');
    const preview = document.getElementById('calc-preview');
    let displayText = display.textContent;
    const isNum = !isNaN(key) || key === '.';

    if (key === 'AC' || key === 'C') {
        display.textContent = '0';
        preview.textContent = 'Enter expression';
        return;
    }

    if (key === 'DEL') {
        display.textContent = displayText.slice(0, -1) || '0';
        return;
    }

    if (key === '±' || key === '%') return;

    if (key === '=') {
        try {
            const expr = displayText.replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-');
            // Basic check to avoid evaluating expressions ending in an operator
            if (['*', '/', '+', '-'].includes(expr.slice(-1))) {
                preview.textContent = 'Invalid expression';
                return;
            }
            let result = Function('"use strict";return (' + expr + ')')();
            // Round to a reasonable number of decimal places for long results
            if (String(result).includes('.') && String(result).length > 15) {
                result = result.toFixed(10);
            }
            display.textContent = String(result);
            preview.textContent = fmt(Number(result));
        } catch (err) {
            preview.textContent = 'Invalid expression';
        }
        return;
    }

    const mapped = key === '×' ? '*' : key === '÷' ? '/' : key === '−' ? '-' : key;
    const isOperator = ['+', '*', '/', '-'].includes(mapped);

    // Prevent consecutive operators, replacing the last one
    const lastChar = displayText.slice(-1);
    const lastIsOperator = ['*', '/', '+', '-', '×', '÷', '−'].includes(lastChar);

    if (isOperator && lastIsOperator) {
        // Replace the last operator with the new one
        displayText = displayText.slice(0, -1) + mapped;
    } else if (displayText === '0' && isNum && mapped !== '.') {
        // Replace initial '0' with the first digit
        displayText = mapped;
    } else if (displayText === '0' && mapped === '.') {
        // Allow typing '0.'
        displayText += mapped;
    } else {
        // Append all other characters
        displayText += mapped;
    }

    // Limit display length to prevent overflow
    if (displayText.length > 25) {
        display.textContent = displayText.slice(0, 25);
        preview.textContent = 'Limit reached';
        return;
    }

    display.textContent = displayText;

    if (!isOperator && displayText.length > 1 && displayText !== '0') {
        preview.textContent = 'Expression Preview';
    }
}


// --- INITIALIZATION ---

  // Dragging logic for calculator
  function dragElement(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    document.getElementById('calc-header').onmousedown = dragMouseDown;
    document.getElementById('calc-header').ontouchstart = dragTouchStart;

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }

    function dragTouchStart(e) {
        const touch = e.touches[0];
        pos3 = touch.clientX;
        pos4 = touch.clientY;
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementTouchDrag;
    }

    function elementTouchDrag(e) {
        e.preventDefault();
        const touch = e.touches[0];
        pos1 = pos3 - touch.clientX;
        pos2 = pos4 - touch.clientY;
        pos3 = touch.clientX;
        pos4 = touch.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const d = new Date();
    document.getElementById('currentDate').innerText = d.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('date').value = d.toISOString().split('T')[0];
    clearForm();

    // Firebase Auth
    if (typeof firebase !== 'undefined' && firebase.auth) {
      document.getElementById('loginBtn').addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider)
          .then((result) => {
            currentProfile = result.user.uid;
            loadAll();
          })
          .catch((error) => {
            console.error("Auth error:", error);
            alert("Sign in failed. Check console for details.");
          });
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        firebase.auth().signOut().then(() => {
          currentProfile = null;
          window.location.reload();
        });
      });

      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          currentProfile = user.uid;
          loadAll();
        }
      });
    }

    // Guest Mode
    document.getElementById('guestBtn').addEventListener('click', () => {
      currentProfile = null;
      document.querySelector('main').style.filter = 'none';
      document.getElementById('authGate').style.display = 'none';
      loadAll();
    });


    // Sidebar & Modals
    const sidebar = document.getElementById('mainSidebar');
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
      sidebar.classList.toggle('mobile-open');
    });
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => sidebar.classList.remove('mobile-open'));
    });

    document.getElementById('navSettings').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.add('open');
    });
    document.getElementById('closeSettings').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.remove('open');
    });

    document.getElementById('navAnalytics').addEventListener('click', () => {
      document.getElementById('analyticsModal').classList.add('open');
      populateAnalyticsDropdowns();
      renderAdvancedCharts();
    });
    document.getElementById('closeAnalytics').addEventListener('click', () => {
      document.getElementById('analyticsModal').classList.remove('open');
    });

    document.getElementById('importDataBtn').addEventListener('click', () => {
      document.getElementById('importModal').classList.add('open');
    });
    document.getElementById('closeImport').addEventListener('click', () => {
      document.getElementById('importModal').classList.remove('open');
    });


    // Calculator functions
    dragElement(document.getElementById('calculator'));
    document.getElementById('calc-toggle').addEventListener('click', () => {
      const calc = document.getElementById('calculator');
      calc.style.display = calc.style.display === 'none' ? 'flex' : 'none';
    });
    document.getElementById('calc-close-btn').addEventListener('click', (e) => {
      document.getElementById('calculator').style.display = 'none';
      e.stopPropagation();
    });

    // Other Buttons
    document.getElementById('sampleBtn').addEventListener('click', loadSampleData);
    document.getElementById('exportBtn').addEventListener('click', () => convertToCSV(data));
    document.getElementById('processImportBtn').addEventListener('click', processImportedData);
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (confirm('WARNING: This will erase ALL your data (local and Firestore). Are you absolutely sure?')) {
        localStorage.clear();
        data = [];
        methodNames = { ...CANONICAL_METHODS };
        incomeSources = ['Salary', 'Freelance', 'Interest'];
        settings = { ccLimit: DEFAULT_CC_LIMIT };
        saveAll();
        window.location.reload();
      }
    });

    // Calculator buttons
    document.querySelectorAll('#calc-buttons button').forEach(button => {
      button.addEventListener('click', handleCalculatorInput);
    });

    // Expense Filter Dropdown Toggle
    document.getElementById('expenseFilterBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('expenseDropdown').classList.toggle('show');
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.multiselect-container')) {
        document.getElementById('expenseDropdown')?.classList.remove('show');
      }
    });

    // Initial check for signed-in state or display auth gate
    if (!currentProfile) {
        const body = document.querySelector('body');
        if (body.contains(document.getElementById('authGate'))) {
            document.querySelector('main').style.filter = 'blur(5px)';
            document.getElementById('authGate').style.display = 'flex';
        } else {
            // Fallback for non-auth environments
            loadAll();
        }
    }
  });
</script>
</body>
</html>
  
</div>
