<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MoneyMirror — v5.0.8 (Final Stable)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* LAYOUT */
    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.3s; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px); transition: filter 0.3s; }

    /* BRAND & NAV */
    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    /* AUTH GATE */
    #authGate {
      position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
      gap: 10px; color: white; text-align: center; padding: 0 24px;
    }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    /* UI ELEMENTS */
    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; flex-wrap: wrap; gap: 10px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); white-space: nowrap; }

    .action-card { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white; }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; }

    .input-group-small { width: 15%; min-width: 120px; flex-grow: 1; }
    .input-group-med { width: 25%; min-width: 180px; flex-grow: 1; }
    .input-group-large { width: 45%; min-width: 250px; flex-grow: 1; }

    .kpi-card { padding: 20px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }
    .cc-alert-high { background: #fee2e2 !important; border-color: var(--danger) !important; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; white-space: nowrap; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted); }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600; color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { background: white; width: 95%; max-width: 1400px; padding: 0; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 95vh; display:flex; flex-direction:column; overflow: hidden; }
    .modal-pad { padding: 24px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-small { width: 90%; max-width: 400px; height: auto; max-height: 90vh; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Calculator */
    #calculator { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 480px; max-height: 80vh; z-index: 3000; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #f8fafc; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close-btn { background: transparent; border: none; color: #ef4444; font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    #calc-display { background: var(--sidebar-bg); color: white; text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px; }
    #calc-preview { background: #0b1323; color: #9fb3c8; text-align: right; font-size: 14px; padding: 6px 15px; font-family: monospace; height: 28px; border-top: 1px solid rgba(255,255,255,0.06); }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%; font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; touch-action: manipulation; }
    #calc-buttons button:hover { background: #f1f5f9; }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important; }
    .calc-clear { background: #fef2f2 !important; color: var(--danger) !important; }
    .calc-zero { grid-column: span 2; }
    .calc-equals { grid-row: span 2; background: var(--primary) !important; color: white !important; }
    #calc-toggle { margin-left: 10px; padding: 8px 12px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; }

    /* Breakdown Grid */
    .kpi-breakdown-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: white; display:flex; flex-direction:column; justify-content:space-between; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }
    
    /* Dropdowns */
    .sub-dropdown-container { position: relative; }
    .sub-dropdown-menu { position: absolute; top: 36px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px 0; width: 100%; min-width: 240px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50; display: none; max-height: 300px; overflow-y: auto; }
    .sub-dropdown-menu.show { display: block; }
    .sub-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; font-size: 12px; color: var(--text-main); border-bottom: 1px solid #f1f5f9; }
    .sub-dropdown-item:last-child { border-bottom: none; }

    .multiselect-container { position: relative; }
    .multiselect-dropdown { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 220px; padding: 10px; z-index: 60; display: none; }
    .multiselect-dropdown.show { display: block; }
    .ms-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; cursor: pointer; }
    .ms-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    
    /* Analytics Filters */
    .analytics-filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }

    /* MEDIA QUERIES */
    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-1 { grid-column: span 1; }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }

    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; height: 60px; }
      aside .brand { margin-bottom: 0; }
      aside nav, .sidebar-footer { display: none; }
      #mobileMenuBtn { display: block; }
      aside.mobile-open nav { display: block; position: absolute; top: 60px; left: 0; right: 0; background: var(--sidebar-bg); padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 501; height: calc(100vh - 60px); overflow-y: auto; }
      aside.mobile-open .sidebar-footer { display: block; position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 501; }
      main { padding: 15px; gap: 15px; }
      .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer { width: 100% !important; min-width: 100%; }
      .action-body { gap: 12px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr; }
      #invQuickSubs { grid-template-columns: 1fr !important; }
      .card-header { align-items: flex-start; }
      #calculator { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; bottom: auto; right: auto; }
      .analytics-filter-grid { grid-template-columns: 1fr; gap: 10px; }
      .flex-row input, .flex-row select, .flex-row button { flex-grow: 1; width: 100%; max-width: none !important; }
      .modal-content { width: 100%; height: 100%; border-radius: 0; max-width: none; }
      .modal-small { height: auto; min-height: 50vh; border-radius: 12px; }
    }
  </style>
</head>
<body>

<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror — Personal Finance Dashboard</p>
  <p class="line line-3">by Rehan Hamdulay</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
  <button id="guestBtn" class="btn-outline" style="padding:12px 24px; font-size:14px; background:transparent; color:white; border-color:white; margin-top:10px;">Continue as Guest (Offline)</button>
</div>

<aside id="mainSidebar">
  <div style="width:100%">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
        MoneyMirror <span>v5.0.8</span>
      </div>
      <button id="mobileMenuBtn">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>
      </div>
      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
      </div>
    </nav>
  </div>

  <div class="sidebar-footer">
    <div class="sys-stat">
      <span>Current profile</span>
      <span class="sys-val" id="profileNameDisplay">--</span>
    </div>
    <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.8 • Settings & Table Fixed</div>
  </div>
</aside>

<main>

  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
      <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
    </div>
    <div class="flex-row">
      <button class="btn-outline" id="sampleBtn">Load sample</button>
      <button class="btn-primary" id="importDataBtn">Import data</button>
      <button class="btn-outline" id="exportBtn">Export CSV</button>
      <div id="calc-toggle" title="Toggle calculator">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="14" x2="12.01" y2="14"></line><line x1="8" y1="10" x2="8.01" y2="10"></line><line x1="16" y1="10" x2="16.01" y2="10"></line></svg>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--success)">Monthly income</div>
      <div class="kpi-value" id="kpiIncome">₹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--danger)">Monthly expenses</div>
      <div class="kpi-value" id="kpiExpense">₹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    <div class="card kpi-card col-span-1" id="ccCard" style="border-color:var(--warning); background:#fffbeb">
      <div class="card-title" id="ccTitle" style="color:var(--warning)">Credit card due</div>
      <div class="kpi-value" id="kpiCCDue">₹0</div>
      <div class="kpi-sub" style="color:#000; font-weight:700; margin-top: 6px; position:relative;">
        <span id="ccPaymentDate">Next: 10th Dec</span>
        <span style="font-weight:700; margin-left:10px;">Limit: <span id="ccLimitDisplay">₹2L</span></span>
        <div id="ccAlert" class="hidden" style="position:absolute; right:0; top:0; color:var(--danger)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        </div>
      </div>
    </div>

    <div class="card kpi-card col-span-1">
      <div class="card-title" style="color:var(--primary)">Net liquidity</div>
      <div class="kpi-value" id="kpiNet">₹0</div>
      <div class="kpi-sub">Total available cash</div>
      <div class="account-list" id="netLiquidityBreakdown"></div>
    </div>

    <div class="card kpi-card col-span-4" style="background:#e0f2fe; border-color:#075985;">
      <div class="card-header" style="padding:16px 20px 0 20px;">
        <div class="card-title" style="color:#075985">Total investment value</div>
        <div style="display:flex;gap:8px;align-items:center; flex-wrap:wrap;">
          <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px; font-size:12px;">View breakdown</button>
          <button id="viewCategoriesBtn" class="btn-outline" style="padding:6px 10px; font-size:12px;">View subcategories</button>
        </div>
      </div>
      <div class="card-body" style="padding-top:6px;">
        <div class="kpi-value" id="kpiInvest">₹0</div>
        <div class="kpi-sub" id="momInvest" style="color:#075985">Historical cost total</div>

        <div id="invBreakdownPanel" class="hidden" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
          <div class="card" style="border-color:#93c5fd; margin-bottom:12px;">
            <div class="card-header">
              <div class="card-title">Filters</div>
              <div class="flex-row" style="gap:10px; width:100%;">
                <div class="input-group-med">
                  <label>Major bucket</label>
                  <select id="invBucketFilter"></select>
                </div>
                <div class="input-group-med">
                  <label>View mode</label>
                  <select id="invViewMode">
                    <option value="top4">Top 4 buckets</option>
                    <option value="subcats">Subcategories</option>
                  </select>
                </div>
                <div class="input-group-med">
                  <label>Date range</label>
                  <select id="invDateRange">
                    <option value="6">Last 6 months</option>
                    <option value="12">Last 12 months</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="kpi-breakdown-grid">
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invBarTitle">Major buckets</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownBar"></canvas>
              </div>
            </div>
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invPieTitle">Share</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownPie"></canvas>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="card-title" style="font-size:13px; color:#075985; margin-bottom:10px;">Bucket subcategories quick view</div>
            <div id="invQuickSubs" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card col-span-2">
      <div class="card-header">
        <div class="card-title">Cash flow & investments</div>
        <select id="mainChartFilter" onchange="renderCharts()" style="max-width:120px;">
          <option value="6">Last 6m</option>
          <option value="12">Last 12m</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="card-body">
        <div style="height:320px; width:100%; position:relative">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card col-span-2">
      <div class="card-header" style="gap:12px;">
        <div class="card-title">Wallet & Expenses</div>
        <div class="flex-row" style="gap:8px; width:100%;">
          <select id="walletMode" onchange="renderWalletUnified()" style="flex:1;">
            <option value="wallet">Wallet breakdown</option>
            <option value="expenses">Expense distribution</option>
          </select>
          
          <div id="expenseFilterContainer" class="multiselect-container hidden" style="flex:1;">
              <button class="btn-outline" style="font-size:12px; padding:10px; width:100%;" id="expenseFilterBtn">Select Categories ▾</button>
              <div class="multiselect-dropdown" id="expenseMultiselectDropdown">
                  <div id="expenseCheckboxes" style="max-height:200px; overflow-y:auto;"></div>
                  <div class="ms-actions">
                      <button class="btn-outline" style="padding:4px 8px; font-size:11px;" id="msClear">Clear</button>
                      <button class="btn-primary" style="padding:4px 8px; font-size:11px;" id="msApply">Apply</button>
                  </div>
              </div>
          </div>

        </div>
      </div>
      <div class="card-body" style="display:flex; flex-direction:column; gap:20px; flex:1">
        <div style="height:280px; width:100%; position:relative;">
          <canvas id="donutChart"></canvas>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
          <div id="walletLegend" style="font-size:12px; color:var(--text-muted);"></div>
          <div id="walletInfo" style="font-size:12px; color:var(--text-muted);"></div>
          <button id="resetExpenseDrilldown" class="btn-outline hidden" style="padding:6px; font-size:12px" onclick="resetExpenseDrilldown()">View all categories</button>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card action-card col-span-4" id="addEntryCard">
      <div class="action-header">
        <div class="card-title">Add new entry</div>
      </div>
      <div class="action-body">
        <div class="input-group-small">
          <label>Type</label>
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="opening_balance">Opening Balance</option>
          </select>
        </div>
        <div class="input-group-small">
          <label>Amount (₹)</label>
          <input id="amount" type="number" placeholder="0.00" style="font-weight:700; font-size:16px" step="any" />
        </div>
        <div class="input-group-small">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div class="input-group-large">
          <label>Description</label>
          <input id="desc" placeholder="What is this for?" />
        </div>
      
        <div id="dynamicFieldsContainer" class="full-width" style="border-top:1px solid var(--border); padding-top:15px">
          <div id="regularFields" style="display:flex; gap:20px; flex-wrap:wrap">
            <div id="categoryContainer" class="input-group-small">
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div class="input-group-small">
              <label>Method</label>
              <select id="method"></select>
            </div>
            <div id="incomeSourceRow" class="hidden input-group-small">
              <label>Source</label>
              <select id="incomeSource"></select>
            </div>

            <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="input-group-small">
                <label>Investment category</label>
                <select id="invGroup"></select>
              </div>
              <div class="input-group-small">
                <label>Investment sub-type</label>
                <select id="invSub"></select>
              </div>
            </div>

            <div id="insuranceRow" class="hidden input-group-med">
              <label>Insurance details</label>
              <div class="flex-row">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>

          <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-small">
              <label>Asset type</label>
              <select id="openingType">
                <option value="Cash">Cash (Liquid)</option>
                <option value="Investment">Investment Asset</option>
              </select>
            </div>
            <div class="input-group-small hidden" id="openingGroupContainer">
              <label id="openingGroupLabel">Asset category</label>
              <select id="openingGroup"></select>
            </div>
            <div class="input-group-small hidden" id="openingSubContainer">
              <label id="openingSubLabel">Account / Asset sub-type</label>
              <select id="openingSub"></select>
            </div>
          </div>
        </div>

        <div style="width:100%; display:flex; gap:10px; margin-top:10px">
          <button class="btn-primary" id="addBtn" style="flex:1">Add entry</button>
          <button class="btn-primary hidden" id="saveBtn" style="flex:1">Save changes</button>
          <button class="btn-outline hidden" id="cancelBtn" style="flex:1">Cancel</button>
        </div>
      </div>
    </div>

    <div class="card col-span-4">
      <div class="card-header" style="flex-direction:column; align-items:flex-start; gap:15px;">
        <div class="card-title">Recent transactions</div>
        <div class="flex-row" style="gap:10px; width:100%;">
             <input type="text" id="recentSearch" placeholder="Search..." style="padding:8px; flex:1;" onkeyup="renderRecentEntries()" />
             
             <select id="recentSort" onchange="renderRecentEntries()" style="flex:1;">
                 <option value="dateDesc">Newest</option>
                 <option value="dateAsc">Oldest</option>
                 <option value="amtDesc">Amt High</option>
                 <option value="amtAsc">Amt Low</option>
             </select>

             <select id="recentCategory" onchange="renderRecentEntries()" style="flex:1;">
                 <option value="">All Cats</option>
             </select>

             <select id="entryLimit" onchange="renderRecentEntries()" style="width:60px; flex:0;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="all">All</option>
            </select>
        </div>
      </div>
      <div class="card-body table-container">
        <table id="recentTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Description</th>
              <th>Category</th>
              <th>Method</th>
              <th style="width:100px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<div id="settingsModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Settings & Configuration</div>
      <button class="btn-outline" id="closeSettings" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Payment methods</label>
        <div id="methodEditor" style="border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
        <div class="flex-row">
          <input id="newMethod" placeholder="New method (e.g. SBI UPI)" />
          <button class="btn-primary" id="addMethod">Add</button>
        </div>
      </div>
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Income sources</label>
        <div class="flex-row" style="margin-bottom:10px;">
          <input id="newIncome" placeholder="New source name" />
           <button class="btn-primary" id="addIncomeBtn">Add</button>
        </div>
        <div id="incomeList" style="display:flex; gap:6px; flex-wrap:wrap"></div>
      </div>
      <div style="margin-bottom:20px">
        <label style="margin-bottom:8px">Credit card limit</label>
        <div class="flex-row">
          <input id="ccLimitInput" type="number" placeholder="Set limit (e.g. 200000)" />
          <button class="btn-primary" id="saveCCLimit">Save limit</button>
        </div>
      </div>
      <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px">
        <label style="color:var(--danger)">Danger zone</label>
        <div class="flex-row">
          <button class="btn-danger" id="resetBtn" style="width:100%">Factory reset profile</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Advanced financial analytics</div>
      <button class="btn-outline" id="closeAnalytics" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad" id="analyticsContent">
      <div id="analyticsFilters">
        <div class="filter-group">
          <h3 style="margin-top:0; font-size:16px;">Deep Dive Filters</h3>
          <div class="analytics-filter-grid">
            <div>
              <label>Date range</label>
              <select id="dateFilter" onchange="renderAdvancedCharts()">
                <option value="6">Last 6 months</option>
                <option value="12">Last 12 months</option>
                <option value="all">All time</option>
              </select>
            </div>
            <div>
              <label>Investment Group</label>
              <select id="anlInvGroup" onchange="updateAnlSubDropdown(); renderAdvancedCharts()"></select>
            </div>
            <div>
              <label>Investment Sub-type</label>
              <select id="anlInvSub" onchange="renderAdvancedCharts()"><option value="">All Types</option></select>
            </div>
            <div>
              <label>Chart type</label>
              <select id="chartType" onchange="renderAdvancedCharts()">
                <option value="line">Line chart</option>
                <option value="bar">Bar chart</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:20px; height:100%;">
          <div class="card" style="flex: 0 0 auto;">
            <div class="card-header"><div class="card-title">Cumulative Growth</div></div>
            <div class="card-body" style="padding-top:10px;">
              <div style="height:260px; width:100%; position:relative">
                <canvas id="chartNetWorth"></canvas>
              </div>
            </div>
          </div>

          <div class="dashboard-grid" style="flex:1;">
             <div class="card col-span-2">
                <div class="card-header"><div class="card-title">Distribution</div></div>
                <div class="card-body" style="padding-top:10px;">
                    <div style="height:100%; min-height:250px; position:relative;">
                        <canvas id="chartInvTypesModal"></canvas>
                    </div>
                </div>
             </div>
             <div class="card col-span-2">
                <div class="card-header"><div class="card-title">Growth Trend</div></div>
                <div class="card-body" style="padding-top:10px;">
                    <div style="height:100%; min-height:250px; position:relative;">
                        <canvas id="chartInvGrowthModal"></canvas>
                    </div>
                </div>
             </div>
          </div>
      </div>

    </div>
  </div>
</div>

<div id="importModal" class="modal">
  <div class="modal-content modal-small">
    <div class="action-header" style="border-radius:12px 12px 0 0">
      <div class="card-title" style="color:white">Import data</div>
      <button class="btn-outline" id="closeImport" style="background:transparent; color:white; border-color:white; padding:4px 10px">Close</button>
    </div>
    <div class="modal-pad">
      <h4 style="margin-top:0;">Import from CSV/JSON</h4>
      <p style="font-size:13px; color:var(--text-muted);">
        CSV columns: type, amount, date, desc, category, method. Optional: income_source, investment_group, investment_sub, insurance_type, insurance_for.
      </p>
      <input type="file" id="importFile" accept=".csv,.json" style="width:100%; margin:10px 0 20px 0;" />
      <button class="btn-primary full-width" id="processImportBtn">Process file</button>
    </div>
  </div>
</div>

<div id="calculator" style="display:none;">
  <div id="calc-header">
    <span>Calculator</span>
    <button id="calc-close-btn">×</button>
  </div>
  <div id="calc-display">0</div>
  <div id="calc-preview">Enter an expression…</div>
  <div id="calc-buttons">
    <button class="calc-clear">AC</button>
    <button class="calc-clear">±</button>
    <button class="calc-clear">%</button>
    <button class="calc-operator">/</button>
    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button class="calc-operator">*</button>
    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button class="calc-operator">-</button>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="calc-operator">+</button>
    <button class="calc-zero">0</button>
    <button>.</button>
    <button class="calc-equals">=</button>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
    };

    let db = null;
    let auth = null;
    let USE_FIRESTORE = false;
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';
    let currentProfile = null;

    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
      console.log("Firebase initialized.");
    } catch (e) {
      console.warn("Firebase init failed, falling back to LocalStorage:", e);
    }

    async function signInWithGoogle() {
      if (!auth) return alert('Auth not initialized. Please refresh.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        onUserSignedIn(user);
      } catch (err) {
        console.error("Login failed:", err);
        alert('Sign-in popup blocked. Allow popups and try again.');
      }
    }

    function onUserSignedIn(user) {
      currentProfile = user.displayName || user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      document.getElementById('profileNameDisplay').textContent = currentProfile;
      document.getElementById('authGate').style.display = 'none';
      document.querySelector('main').style.filter = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      loadProfileData();
    }

    function signOutUser() {
      if (!auth) return;
      auth.signOut().then(() => {
        currentProfile = null;
        document.getElementById('profileNameDisplay').textContent = '--';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('authGate').style.display = 'flex';
        document.querySelector('main').style.filter = 'blur(5px)';
      });
    }

    // --- Data structures (from original code) ---
    const CANONICAL_METHODS = { 'cash': 'Cash/Wallet', 'bank': 'Bank Account (Primary)', 'salary_acct': 'Bank Account (Salary)', 'credit_card': 'Credit Card', 'e_wallet': 'E-Wallet/UPI', 'investment_acct': 'Investment Account (Broker)', 'misc': 'Miscellaneous' };
    const BASE_CATS = ['Groceries', 'Food & Dining', 'Rent/Mortgage', 'Utilities', 'Transport', 'Investments', 'Insurance', 'Personal Care', 'Entertainment', 'Shopping', 'Health', 'Education', 'Miscellaneous'];

    // Detailed Investment Structure (Category -> Sub-type)
    const INVESTMENT_STRUCTURE = {
      'Mutual Funds': {
        'Index Funds': 'Mutual Funds', 'Equity Funds (Large Cap)': 'Mutual Funds', 'Equity Funds (Mid/Small Cap)': 'Mutual Funds', 'Debt Funds': 'Mutual Funds', 'Hybrid Funds': 'Mutual Funds', 'ELSS (Tax Saver)': 'Mutual Funds',
      },
      'Equity (Stocks)': {
        'Large Cap Stocks': 'Equity (Stocks)', 'Small/Mid Cap Stocks': 'Equity (Stocks)', 'International Stocks': 'Equity (Stocks)', 'Penny Stocks/Speculative': 'Equity (Stocks)', 'Direct Company IPOs': 'Equity (Stocks)',
      },
      'ETFs': {
        'Nifty/Sensex ETFs': 'ETFs', 'Sectoral/Thematic ETFs': 'ETFs', 'International ETFs': 'ETFs',
      },
      'Bonds & Debt Instruments': {
        'Corporate Bonds': 'Bonds & Debt Instruments', 'Treasury Bills': 'Bonds & Debt Instruments', 'Tax-Free Bonds': 'Bonds & Debt Instruments', 'Sovereign Gold Bonds (SGB)': 'Bonds & Debt Instruments',
      },
      'Commodities': {
        'Gold (Physical/Digital)': 'Commodities', 'Silver': 'Commodities', 'Crude Oil/Natural Gas': 'Commodities', 'Other Metals (Copper/Nickel)': 'Commodities',
      },
      'Crypto & Digital Assets': {
        'Bitcoin (BTC)': 'Crypto & Digital Assets', 'Ethereum (ETH)': 'Crypto & Digital Assets', 'Stablecoins': 'Crypto & Digital Assets', 'Altcoins': 'Crypto & Digital Assets', 'NFTs / Web3 Assets': 'Crypto & Digital Assets',
      },
      'Real Estate': {
        'Residential Property': 'Real Estate', 'Commercial Property': 'Real Estate', 'Land': 'Real Estate', 'REITs (Real Estate Investment Trusts)': 'Real Estate',
      },
      'Fixed Income / Savings Schemes': {
        'FD (Fixed Deposit)': 'Fixed Income / Savings Schemes', 'RD (Recurring Deposit)': 'Fixed Income / Savings Schemes', 'PPF': 'Fixed Income / Savings Schemes', 'NSC/KVP/Postal MIS': 'Fixed Income / Savings Schemes', 'High-Interest Savings Account': 'Fixed Income / Savings Schemes',
      },
      'Retirement Funds': {
        'NPS Tier 1/Tier 2': 'Retirement Funds', 'EPF (Employees’ Provident Fund)': 'Retirement Funds', 'IRA/401k (USA users)': 'Retirement Funds', 'Other Pension Schemes': 'Retirement Funds',
      },
      'Other Investments': {
        'Angel Investing / Startup Equity': 'Other Investments', 'Peer-to-Peer Lending': 'Other Investments', 'Private Funds / AIFs': 'Other Investments', 'Alternative Assets': 'Other Investments',
      }
    };
    // Major buckets mapping for KPI breakdown (rollup)
    const MAJOR_BUCKETS = {
      'Equity (Stocks)': 'Equity', 'Mutual Funds': 'Mutual Funds', 'ETFs': 'ETFs',
      'Bonds & Debt Instruments': 'Debt', 'Fixed Income / Savings Schemes': 'Debt',
      'Retirement Funds': 'Retirement', 'Real Estate': 'Real Estate',
      'Commodities': 'Commodities', 'Crypto & Digital Assets': 'Crypto',
      'Other Investments': 'Other'
    };
    let data = [];
    let methodNames = { ...CANONICAL_METHODS
    };
    let incomeSources = ['Salary', 'Freelance', 'Interest'];
    let settings = {
      ccLimit: 100000,
      ccPaymentDay: 10,
      ccAlertThreshold: 0.8
    };
    let editId = null;
    let invBreakdownBarChart, invBreakdownPieChart, mainChart, chartWallet, chartNetWorth, chartInvTypesModal, chartInvGrowthModal;

    // Elements cache
    const formEls = {};

    // --- NEW INVESTMENT FEATURE HELPER FUNCTIONS (MISSING DEFINITIONS ADDED HERE) ---

    // [FIX 1: Define the missing helper functions]
    function updateInvestmentSubDropdown(groupEl, subEl, selectedSub = '') {
      const group = groupEl.value;
      const subcategories = INVESTMENT_STRUCTURE[group] || {};

      subEl.innerHTML = '<option value="">Select Sub-type (Optional)</option>' +
          Object.keys(subcategories).map(sub =>
              `<option value="${sub}">${sub}</option>`
          ).join('');
      subEl.value = selectedSub;

      // Handle the opening balance form, which also uses these dropdowns
      const openingSubContainer = document.getElementById('openingSubContainer');
      if (openingSubContainer) {
          if (group) {
              openingSubContainer.classList.remove('hidden');
          } else {
              openingSubContainer.classList.add('hidden');
          }
      }
    }

    function updateInvGroupDropdown() {
      // Listener called when invGroup changes, updates invSub dropdown
      updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
    }

    // --- UTILITIES ---

    function fmt(value, currency = true) {
      if (isNaN(value)) return value;
      return (currency ? '₹' : '') + Number(value).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function toKey(s) {
      return s.toLowerCase().replace(/[^a-z0-9]/g, '_');
    }

    function updateMethodName(input) {
      const key = input.dataset.key;
      const newName = input.value.trim();
      if (newName && key) {
        methodNames[key] = newName;
        saveAll(false);
        renderAll();
      }
    }

    function removeMethod(key) {
      if (key === 'cash' || key === 'bank') return alert('Cannot remove essential methods.');
      if (confirm(`Are you sure you want to remove method: ${methodNames[key]}?`)) {
        delete methodNames[key];
        saveAll(false);
        renderAll();
      }
    }

    function addMethod() {
      const newMethod = prompt('Enter new payment method name:');
      if (newMethod) {
        const key = toKey(newMethod);
        if (methodNames[key]) return alert('Method already exists.');
        methodNames[key] = newMethod;
        saveAll(false);
        renderAll();
      }
    }

    function addIncomeSource() {
      const newSource = prompt('Enter new income source name:');
      if (newSource) {
        if (incomeSources.includes(newSource)) return alert('Source already exists.');
        incomeSources.push(newSource);
        saveAll(false);
        renderAll();
      }
    }

    function removeIncomeSource(source) {
      if (confirm(`Are you sure you want to remove income source: ${source}?`)) {
        incomeSources = incomeSources.filter(s => s !== source);
        saveAll(false);
        renderAll();
      }
    }

    function updateCCSettings() {
      const limit = Number(document.getElementById('ccLimit').value);
      const day = Number(document.getElementById('ccPaymentDay').value);
      const threshold = Number(document.getElementById('ccThreshold').value) / 100;
      if (limit > 0) settings.ccLimit = limit;
      if (day > 0 && day <= 31) settings.ccPaymentDay = day;
      if (threshold >= 0 && threshold <= 1) settings.ccAlertThreshold = threshold;
      saveAll(false);
      renderAll();
    }


    // --- DATA HANDLING ---

    function loadFromLocalStorage() {
      const localData = localStorage.getItem('mm_data');
      const localMethods = localStorage.getItem('mm_methods');
      const localSources = localStorage.getItem('mm_sources');
      const localSettings = localStorage.getItem('mm_settings');

      if (localData) data = JSON.parse(localData).map(d => ({
        id: d.id,
        type: d.type,
        amount: Number(d.amount),
        date: d.date,
        desc: d.desc,
        category: d.category || '',
        method: d.method || 'cash',
        incomeSource: d.incomeSource || '',
        investmentGroup: d.investmentGroup || '',
        investmentSub: d.investmentSub || '',
        insuranceType: d.insuranceType || '',
        insuranceFor: d.insuranceFor || '',
      }));
      if (localMethods) methodNames = JSON.parse(localMethods);
      if (localSources) incomeSources = JSON.parse(localSources);
      if (localSettings) settings = { ...settings,
        ...JSON.parse(localSettings)
      };
    }

    function saveAll(full = true) {
      if (!currentProfile) {
        console.warn("User not signed in, saving to LocalStorage only.");
      }
      localStorage.setItem('mm_data', JSON.stringify(data));
      localStorage.setItem('mm_methods', JSON.stringify(methodNames));
      localStorage.setItem('mm_sources', JSON.stringify(incomeSources));
      localStorage.setItem('mm_settings', JSON.stringify(settings));

      if (USE_FIRESTORE && db && currentProfile && full) {
        const payload = {
          data: data,
          methodNames: methodNames,
          incomeSources: incomeSources,
          settings: settings,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).set(payload)
          .then(() => console.log("Firestore sync complete."))
          .catch(e => console.error("Firestore write error:", e));
      }
    }

    async function loadProfileData() {
      loadFromLocalStorage();
      if (USE_FIRESTORE && db && currentProfile) {
        try {
          const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).get();
          if (doc.exists) {
            const serverData = doc.data();
            data = serverData.data || data;
            methodNames = serverData.methodNames || methodNames;
            incomeSources = serverData.incomeSources || incomeSources;
            settings = serverData.settings || settings;
          }
        } catch (e) {
          console.error("Firestore read error, using local data:", e);
        }
      }
      renderAll();
    }

    // --- RENDER & SETUP ---

    function renderAll() {
      data.sort((a, b) => new Date(b.date) - new Date(a.date));
      setupDropdowns();
      renderKPIs();
      renderCharts();
      // This is the function that was previously skipped due to the crash
      renderRecentEntries(); 
      renderSettings();
    }

    function setupDropdowns() {
      // Methods
      formEls.method.innerHTML = Object.keys(methodNames)
        .filter(key => key !== 'credit_card')
        .map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');

      // Income sources
      formEls.incomeSource.innerHTML = '<option value="">Select Source</option>' + incomeSources.map(s => `<option value="${s}">${s}</option>`).join('');

      // Categories
      formEls.category.innerHTML = BASE_CATS.map(c => `<option value="${c}">${c}</option>`).join('');

      // [FIX 2: Populate the Investment Group dropdown]
      // Investment Groups
      formEls.invGroup.innerHTML = '<option value="">Select Category</option>' +
        Object.keys(INVESTMENT_STRUCTURE).map(group =>
          `<option value="${group}">${group}</option>`
        ).join('');

      // Listeners
      formEls.type.onchange = updateTransactionFormFields;
      formEls.category.onchange = updateTransactionFormFields;
      formEls.openingType.onchange = updateTransactionFormFields;
      // [FIX 3: Attach listener to the DEFINED function]
      formEls.invGroup.onchange = updateInvGroupDropdown; 
    }

    function getBadge(e) {
      if (e.type === 'income') return `<span class="badge badge-income">Income: ${e.incomeSource || 'Misc'}</span>`;
      if (e.type === 'expense' && e.category === 'Investments') return `<span class="badge badge-inv">Investment</span>`;
      if (e.type === 'expense' && e.category === 'Insurance') return `<span class="badge badge-ins">Insurance</span>`;
      if (e.type === 'expense' && e.category === 'Credit Card Payment') return `<span class="badge badge-cc">CC Payment</span>`;
      if (e.type === 'opening_balance') return `<span class="badge badge-opening">Opening Balance</span>`;
      return `<span class="badge badge-expense">Expense</span>`;
    }

    function updateTransactionFormFields() {
      // Clear all extra fields
      formEls.incomeRow.classList.add('hidden');
      formEls.invRow.classList.add('hidden');
      formEls.insRow.classList.add('hidden');
      formEls.openingBalanceRow.classList.add('hidden');
      document.getElementById('categoryContainer').classList.remove('hidden');

      const type = formEls.type.value;

      if (type === 'income') {
        formEls.incomeRow.classList.remove('hidden');
        document.getElementById('categoryContainer').classList.add('hidden');
        formEls.category.value = '';
      } else if (type === 'expense') {
        const cat = formEls.category.value;

        if (cat === 'Investments') {
          formEls.invRow.classList.remove('hidden');
          updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub); // Initial sub-dropdown population
        } else if (cat === 'Insurance') {
          formEls.insRow.classList.remove('hidden');
        }
      } else if (type === 'opening_balance') {
        formEls.openingBalanceRow.classList.remove('hidden');
        document.getElementById('categoryContainer').classList.add('hidden');

        const openingType = formEls.openingType.value;
        const openingGroupContainer = document.getElementById('openingGroupContainer');
        const openingGroupLabel = document.getElementById('openingGroupLabel');

        if (openingType === 'Investment') {
          openingGroupContainer.classList.remove('hidden');
          openingGroupLabel.textContent = 'Investment Category';

          // Repopulate with investment groups
          formEls.openingGroup.innerHTML = '<option value="">Select Category</option>' +
            Object.keys(INVESTMENT_STRUCTURE).map(group =>
              `<option value="${group}">${group}</option>`
            ).join('');

          // Set up listener for opening group
          formEls.openingGroup.onchange = () => {
            updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub);
          };

          // Update initial sub dropdown
          updateInvestmentSubDropdown(formEls.openingGroup, formEls.openingSub);
        } else {
          openingGroupContainer.classList.add('hidden');
          document.getElementById('openingSubContainer').classList.add('hidden');
          formEls.openingGroup.value = '';
          formEls.openingSub.value = '';
        }
      }
    }

    // --- CRUD ---
    function uid() {
      return 'id' + Date.now() + Math.random().toString(16).slice(2);
    }

    function requireSignedIn() {
      if (!currentProfile) {
        alert('Please sign in to proceed.');
        return false;
      }
      return true;
    }

    function submitForm(e, isImportOrEdit = false) {
      if (!requireSignedIn()) return;
      const type = formEls.type.value;
      const amount = Number(formEls.amount.value);
      const date = formEls.date.value;
      const desc = formEls.desc.value;
      const method = formEls.method.value;

      if (amount <= 0 || isNaN(amount)) return alert('Please enter a valid amount.');
      if (!date) return alert('Please select a date.');
      if (!desc) return alert('Please enter a description.');

      const entry = {
        id: e ? e.id : uid(),
        type,
        amount,
        date,
        desc,
        category: '',
        method: method,
        incomeSource: '',
        investmentGroup: '',
        investmentSub: '',
        insuranceType: '',
        insuranceFor: ''
      };

      if (type === 'income') {
        entry.incomeSource = formEls.incomeSource.value || (e ? e.incomeSource : '');
        entry.category = 'N/A';
        entry.investmentGroup = entry.investmentSub = entry.insuranceType = entry.insuranceFor = '';
      } else if (type === 'expense') {
        const cat = formEls.category.value;
        if (!cat) return alert('Please select a category.');
        entry.category = cat;
        entry.incomeSource = '';

        if (cat === 'Investments') {
          entry.investmentGroup = formEls.invGroup.value || (e ? e.investmentGroup : '');
          entry.investmentSub = formEls.invSub.value || (e ? e.investmentSub : '');
          entry.insuranceType = entry.insuranceFor = '';
          if (!entry.investmentGroup) return alert('Please select an investment category.');
        } else if (cat === 'Insurance') {
          entry.insuranceType = formEls.insType.value || (e ? e.insuranceType : 'General');
          entry.insuranceFor = formEls.insFor.value || (e ? e.insuranceFor : 'Self');
          entry.investmentGroup = entry.investmentSub = '';
        } else {
          entry.insuranceType = entry.insuranceFor = '';
          entry.investmentGroup = entry.investmentSub = '';
        }

        if (entry.category === 'Credit Card Payment') {
          entry.method = 'credit_card_payment';
        }
      } else if (type === 'opening_balance') {
        entry.category = 'N/A';
        entry.incomeSource = entry.insuranceType = entry.insuranceFor = '';
        entry.method = formEls.method.value; // Use selected method for liquid cash
        entry.investmentGroup = '';

        const openingType = formEls.openingType.value;
        if (openingType === 'Investment') {
          entry.investmentGroup = formEls.openingGroup.value || (e ? e.investmentGroup : '');
          entry.investmentSub = formEls.openingSub.value || (e ? e.investmentSub : '');
          entry.method = 'investment_acct'; // Override method for investment assets
        } else { // Cash
          entry.investmentGroup = 'Cash';
          entry.investmentSub = 'Liquid Cash/Account';
        }
      }

      if (editId) {
        data = data.map(t => t.id === editId ? entry : t);
        editId = null;
        formEls.addBtn.classList.remove('hidden');
        formEls.saveBtn.classList.add('hidden');
        formEls.cancelBtn.classList.add('hidden');
      } else {
        data.push(entry);
      }

      if (!isImportOrEdit) {
        saveAll();
        renderAll(); // Will now run completely without crashing
        clearForm();
      }
    }

    function clearForm() {
      formEls.type.value = 'expense';
      formEls.amount.value = '';
      formEls.date.value = new Date().toISOString().slice(0, 10);
      formEls.desc.value = '';
      formEls.method.value = 'cash';
      formEls.category.value = 'Groceries';
      formEls.incomeSource.value = '';
      formEls.invGroup.value = '';
      formEls.invSub.value = '';
      formEls.insType.value = '';
      formEls.insFor.value = '';
      formEls.openingType.value = 'Cash';
      formEls.openingGroup.value = '';
      formEls.openingSub.value = '';
      updateTransactionFormFields();
    }

    function loadEdit(id) {
      if (!requireSignedIn()) return;
      const e = data.find(t => t.id === id);
      if (!e) return;
      editId = id;

      formEls.type.value = e.type;
      formEls.amount.value = e.amount;
      formEls.date.value = e.date;
      formEls.desc.value = e.desc;
      formEls.method.value = e.method;
      formEls.category.value = e.category || '';
      formEls.incomeSource.value = e.incomeSource || '';
      formEls.insType.value = e.insuranceType || '';
      formEls.insFor.value = e.insuranceFor || '';
      formEls.invGroup.value = e.investmentGroup || '';

      updateTransactionFormFields(); // Update form fields based on type/category

      // For Investments and Opening Balance (Investment), we need to update the sub-dropdown
      if ((e.type === 'expense' && e.category === 'Investments') ||
        (e.type === 'opening_balance' && e.investmentGroup && e.investmentGroup !== 'Cash')) {
        const groupEl = (e.type === 'expense') ? formEls.invGroup : formEls.openingGroup;
        const subEl = (e.type === 'expense') ? formEls.invSub : formEls.openingSub;

        // Manually update the dropdown options
        if (e.type === 'opening_balance') {
          formEls.openingType.value = 'Investment';
          updateTransactionFormFields(); // re-runs logic to show investment groups
        }

        updateInvestmentSubDropdown(groupEl, subEl, e.investmentSub);
      }

      formEls.addBtn.classList.add('hidden');
      formEls.saveBtn.classList.remove('hidden');
      formEls.cancelBtn.classList.remove('hidden');
      window.scrollTo(0, 0); // Scroll to top to see the form
    }

    function deleteEntry(id) {
      if (!requireSignedIn()) return;
      if (confirm('Are you sure you want to delete this entry?')) {
        data = data.filter(t => t.id !== id);
        saveAll();
        renderAll();
      }
    }


    // --- KPI & Breakdown RENDER ---

    function getNextPaymentDate() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const paymentDay = settings.ccPaymentDay;

      let paymentDate = new Date(currentYear, currentMonth, paymentDay);
      if (today.getDate() > paymentDay) paymentDate.setMonth(currentMonth + 1);
      return paymentDate.toLocaleDateString('en-IN', {
        month: 'long'
      });
    }

    function renderKPIs() {
      const curMonth = new Date().getMonth();
      const curYear = new Date().getFullYear();
      const prevMonth = curMonth === 0 ? 11 : curMonth - 1;
      const prevYear = curMonth === 0 ? curYear - 1 : curYear;

      const operationalData = data.filter(d => d.type !== 'opening_balance');
      const filterMonth = (d, m, y) => {
        const dt = new Date(d);
        return dt.getMonth() === m && dt.getFullYear() === y;
      };
      const sum = (arr) => arr.reduce((acc, curr) => acc + Number(curr.amount), 0);

      const curData = operationalData.filter(d => filterMonth(d.date, curMonth, curYear));
      const prevData = operationalData.filter(d => filterMonth(d.date, prevMonth, prevYear));

      const inc = sum(curData.filter(d => d.type === 'income'));
      const exp = sum(curData.filter(d => d.type === 'expense'));
      const prevInc = sum(prevData.filter(d => d.type === 'income'));
      const prevExp = sum(prevData.filter(d => d.type === 'expense'));

      const allInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments') || (d.type === 'income' && d.category === 'Investment Income'));
      const totalInvested = sum(allInvestments.filter(d => d.type !== 'income'));
      const creditCardDue = sum(curData.filter(d => d.method === 'credit_card_payment').map(d => -d.amount)) + // payments are negative expense
        sum(curData.filter(d => d.method === 'credit_card' && d.type === 'expense'));

      document.getElementById('kpiIncome').innerText = fmt(inc);
      document.getElementById('kpiExpense').innerText = fmt(exp);

      document.getElementById('momIncome').innerHTML = `<span class="${inc > prevInc ? 'trend-up' : 'trend-down'}">${fmt(inc - prevInc)}</span> vs last month`;
      document.getElementById('momExpense').innerHTML = `<span class="${exp < prevExp ? 'trend-up' : 'trend-down'}">${fmt(prevExp - exp)}</span> vs last month`;

      const ccLimit = settings.ccLimit;
      document.getElementById('kpiCCDue').innerText = fmt(creditCardDue);
      document.getElementById('ccLimitDisplay').innerText = fmt(ccLimit);
      document.getElementById('ccPaymentDate').innerText = `Next Payment: 10th of ${getNextPaymentDate()}`;

      const ccCard = document.getElementById('ccCard');
      const ccAlert = document.getElementById('ccAlert');
      if (creditCardDue >= ccLimit * settings.ccAlertThreshold) {
        ccCard.classList.add('cc-alert-high');
        ccAlert.classList.remove('hidden');
      } else {
        ccCard.classList.remove('cc-alert-high');
        ccAlert.classList.add('hidden');
      }

      // Investment KPI
      document.getElementById('kpiInvestment').innerText = fmt(totalInvested);
      renderInvestmentBreakdown(allInvestments);
      renderInvQuickSubs(allInvestments);

      // Net Liquidity Breakdown (accounts)
      const breakdownContainer = document.getElementById('netLiquidityBreakdown');
      let breakdownHtml = '';
      const liquidMethods = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup === 'Cash') || (d.type === 'income') || (d.type === 'expense' && d.category !== 'Investments'));
      const methodBalances = liquidMethods.reduce((acc, curr) => {
        const key = curr.method || 'cash';
        const isExpense = curr.type === 'expense' && curr.category !== 'Credit Card Payment';
        const amount = isExpense ? -Number(curr.amount) : Number(curr.amount);
        acc[key] = (acc[key] || 0) + amount;
        return acc;
      }, {});

      const netLiquidity = Object.values(methodBalances).reduce((a, b) => a + b, 0);
      document.getElementById('kpiNet').innerText = fmt(netLiquidity);

      for (const key in methodBalances) {
        if (methodNames[key] && methodNames[key] !== 'Credit Card') {
          breakdownHtml += `
            <div>
              <span>${methodNames[key]}</span>
              <span>${fmt(methodBalances[key])}</span>
            </div>
          `;
        }
      }
      breakdownContainer.innerHTML = breakdownHtml;

      // Expense Breakdown (Charts) - Not done in this version's KPI section
    }

    function renderInvestmentBreakdown(allInvestments) {
      let selectedBucket = document.getElementById('invBucketFilter')?.value || 'all';
      const viewMode = document.getElementById('invViewMode')?.value || 'top4';
      const range = document.getElementById('invDateRange')?.value || 'all';
      const curDate = new Date();

      const filteredInvestments = allInvestments.filter(d => {
        if (range === 'all') return true;
        const entryDate = new Date(d.date);
        const months = Number(range);
        const cutoffDate = new Date(curDate.getFullYear(), curDate.getMonth() - months, curDate.getDate());
        return entryDate >= cutoffDate;
      });

      const grouped = filteredInvestments.reduce((acc, curr) => {
        // Only consider non-income entries for the cost breakdown
        if (curr.type === 'income') return acc;

        const majorBucket = MAJOR_BUCKETS[curr.investmentGroup] || 'Other';

        // Filter the data based on the selected bucket (for subcategory view)
        if (viewMode === 'subcats' && selectedBucket !== 'all' && majorBucket !== selectedBucket) {
          return acc;
        }

        const label = (viewMode === 'top4' || selectedBucket === 'all') ?
          majorBucket :
          curr.investmentSub || 'Unknown Subcategory'; // Fallback for safety

        if (!acc[label]) acc[label] = 0;

        // Opening balances are positive, investment expenses are also positive cost
        const amount = Number(curr.amount);
        acc[label] += amount;

        return acc;
      }, {});

      // Update bucket filter dropdown options
      const invBuckets = [...new Set(allInvestments.map(d => MAJOR_BUCKETS[d.investmentGroup]).filter(Boolean))];
      const bucketFilterEl = document.getElementById('invBucketFilter');
      bucketFilterEl.innerHTML = '<option value="all">All buckets</option>' + invBuckets.map(b => `<option value="${b}">${b}</option>`).join('');

      // Re-validate or update selectedBucket
      if (selectedBucket === 'all' && invBuckets.length > 0) {
        selectedBucket = invBuckets[0];
      } else if (selectedBucket && !invBuckets.includes(selectedBucket)) {
        selectedBucket = 'all';
      }
      bucketFilterEl.value = selectedBucket;

      // Update titles
      const invBarTitle = document.getElementById('invBarTitle');
      const invPieTitle = document.getElementById('invPieTitle');
      if (viewMode === 'top4' || selectedBucket === 'all') {
        invBarTitle.textContent = 'Investment by major bucket';
        invPieTitle.textContent = 'Share by major bucket';
      } else {
        invBarTitle.textContent = `Cost of subcategories in: ${selectedBucket}`;
        invPieTitle.textContent = `Share of subcategories in: ${selectedBucket}`;
      }

      // Chart Data preparation
      const labels = Object.keys(grouped);
      const values = Object.values(grouped);
      const colors = labels.map((_, i) => getChartColor(i));

      // Bar chart
      if (invBreakdownBarChart) invBreakdownBarChart.destroy();
      const barCtx = document.getElementById('invBreakdownBar');
      if (barCtx) {
        invBreakdownBarChart = new Chart(barCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Historical cost',
              data: values,
              backgroundColor: colors.map(c => c + 'cc'),
              borderColor: colors,
              borderWidth: 1.5,
              borderRadius: 6
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (c) => `${c.label}: ${fmt(c.parsed.y)}`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (v) => fmt(v).replace('₹', '₹ ')
                },
                grid: {
                  color: '#eef2ff'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // Pie chart
      if (invBreakdownPieChart) invBreakdownPieChart.destroy();
      const pieCtx = document.getElementById('invBreakdownPie');
      if (pieCtx) {
        invBreakdownPieChart = new Chart(pieCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: colors,
              hoverOffset: 6,
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 10
                }
              },
              tooltip: {
                callbacks: {
                  label: (c) => {
                    const total = values.reduce((a, b) => a + b, 0);
                    return `${c.label}: ${fmt(c.parsed)} (${total ? ((c.parsed/total)*100).toFixed(1)+'%' : '0%'})`;
                  }
                }
              }
            }
          }
        });
      }
    }

    function renderInvQuickSubs(allInvestments) {
      const container = document.getElementById('invQuickSubs');
      if (!container) return; // safety check
      container.innerHTML = '';

      const quickSubCategories = allInvestments.filter(d => d.investmentSub)
        .reduce((acc, curr) => {
          const sub = curr.investmentSub;
          const type = curr.type;
          // Ensure group is correctly mapped for the display
          const group = MAJOR_BUCKETS[curr.investmentGroup] || 'Other';
          if (!acc[sub]) acc[sub] = {
            value: 0,
            group: group
          };

          // Opening balances are positive, investment expenses are also positive cost
          const amount = (type === 'expense' && curr.category === 'Investments') ? Number(curr.amount) : Number(curr.amount);
          acc[sub].value += amount;
          return acc;
        }, {});

      const sortedSubs = Object.entries(quickSubCategories).sort(([, a], [, b]) => b.value - a.value);

      let quickSubsHtml = sortedSubs.map(([sub, data]) => `
        <div class="quick-sub-card">
          <div class="quick-sub-header">
            <div class="quick-sub-title">${sub}</div>
            <span class="total-badge">${data.group}</span>
          </div>
          <div style="font-size:20px; font-weight:700; color:var(--text-main); margin-top:5px;">${fmt(data.value)}</div>
        </div>
      `).join('');

      container.innerHTML = quickSubsHtml;
    }


    // --- RECENT ENTRIES (The function that was being skipped) ---

    function renderRecentEntries() {
      const tableBody = document.getElementById('recentEntriesBody');
      const limit = Number(document.getElementById('entryLimit').value);

      const recentData = data.slice(0, limit);
      let html = '';

      if (recentData.length === 0) {
        html = '<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:40px;">No transactions found. Add one above!</td></tr>';
      } else {
        html = recentData.map(e => {
          const amountDisplay = e.type === 'income' || e.type === 'opening_balance' ?
            `<span style="color:var(--success)">+${fmt(e.amount)}</span>` :
            `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;

          let methodDisplay = '';
          if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
            methodDisplay = e.investmentSub || e.investmentGroup;
          } else if (e.type === 'expense' && e.category === 'Investments') {
            methodDisplay = e.investmentSub || e.investmentGroup;
          } else if (e.method === 'credit_card_payment') {
            methodDisplay = 'N/A (Transfer)';
          } else {
            methodDisplay = methodNames[e.method] || e.method || '--';
          }

          let categoryDisplay = e.category === 'Investments' ?
            e.investmentSub :
            e.category === 'Insurance' ?
            `${e.insuranceType} (${e.insuranceFor})` :
            e.type === 'expense' ?
            e.category :
            '--';

          return `
            <tr>
              <td>${getBadge(e)}</td>
              <td>${e.date}</td>
              <td style="font-weight:600; text-align:right">${amountDisplay}</td>
              <td>${e.desc}</td>
              <td>${categoryDisplay}</td>
              <td>${methodDisplay}</td>
              <td class="flex-row">
                <button onclick="loadEdit('${e.id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:4px" title="Edit">✎</button>
                <button onclick="deleteEntry('${e.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:4px" title="Delete">🗑</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      tableBody.innerHTML = html;
    }

    // ... (rest of the code: renderCharts, renderAdvancedCharts, renderInvestmentAnalytics, getChartColor, setupWalletFilters, renderWalletUnified, renderSettings, convertToCSV, parseCSV, processImportedData, loadSampleData, Calculator functions, dragElement, DOMContentLoaded listener) ...
    // Note: Due to space constraints, the rest of the file content is omitted but must be retained in your local copy. The critical fixes are above.

    // --- CHART UTILITIES ---

    function getChartColor(index) {
      const colors = [
        'var(--c1)', 'var(--c2)', 'var(--c3)', 'var(--c4)', 'var(--c5)', 'var(--c6)',
        'var(--c7)', 'var(--c8)', 'var(--c9)', 'var(--c10)', 'var(--c11)', 'var(--c12)'
      ];
      return colors[index % colors.length];
    }

    // --- CHART RENDER ---

    function renderCharts() {
      // Clear all existing charts to prevent memory leaks/redraw issues
      if (mainChart) mainChart.destroy();

      const range = document.getElementById('mainChartFilter')?.value || '6';
      const curDate = new Date();
      const cutoffDate = range === 'all' ? new Date(0) : new Date(curDate.getFullYear(), curDate.getMonth() - Number(range), curDate.getDate());

      const chartData = data.filter(d => new Date(d.date) >= cutoffDate && d.type !== 'opening_balance');

      const dateMap = {}; // Key: YYYY-MM, Value: { income: 0, expense: 0, investment: 0 }

      chartData.forEach(d => {
        const monthKey = d.date.slice(0, 7);
        if (!dateMap[monthKey]) dateMap[monthKey] = {
          income: 0,
          expense: 0,
          investment: 0
        };

        const amount = Number(d.amount);

        if (d.type === 'income') {
          dateMap[monthKey].income += amount;
        } else if (d.type === 'expense') {
          if (d.category === 'Investments') {
            dateMap[monthKey].investment += amount;
          } else {
            dateMap[monthKey].expense += amount;
          }
        }
      });

      // Fill in months between min and max date
      const sortedKeys = Object.keys(dateMap).sort();
      let labels = [];
      let income = [];
      let expense = [];
      let investment = [];
      let netIncomeSeries = [];

      if (sortedKeys.length > 0) {
        let currentDate = new Date(sortedKeys[0] + '-01');
        const endDate = new Date(sortedKeys[sortedKeys.length - 1] + '-01');
        endDate.setMonth(endDate.getMonth() + 1); // Go up to and include the last month

        while (currentDate < endDate) {
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, '0');
          const key = `${year}-${month}`;

          const monthData = dateMap[key] || {
            income: 0,
            expense: 0,
            investment: 0
          };
          labels.push(currentDate.toLocaleDateString('en-US', {
            month: 'short',
            year: '2-digit'
          }));
          income.push(monthData.income);
          expense.push(monthData.expense);
          investment.push(monthData.investment);
          netIncomeSeries.push(monthData.income - monthData.expense - monthData.investment);

          currentDate.setMonth(currentDate.getMonth() + 1);
        }
      }

      const ctx = document.getElementById('mainChart')?.getContext('2d');
      if (ctx) {
        mainChart = new Chart(ctx, {
          data: {
            labels: labels,
            datasets: [{
              type: 'bar',
              label: 'Income',
              data: income,
              backgroundColor: 'rgba(16, 185, 129, 0.8)',
              stack: 'flow'
            }, {
              type: 'bar',
              label: 'Expense',
              data: expense.map(e => -e),
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              stack: 'flow'
            }, {
              type: 'bar',
              label: 'Investment',
              data: investment.map(i => -i),
              backgroundColor: 'rgba(14, 165, 233, 0.8)',
              stack: 'flow'
            }, {
              type: 'line',
              label: 'Net Income',
              data: netIncomeSeries,
              borderColor: '#000000',
              tension: 0.3,
              pointRadius: 3,
              fill: false
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            interaction: {
              mode: 'index',
              intersect: false
            },
            scales: {
              x: {
                stacked: true
              },
              y: {
                stacked: true,
                ticks: {
                  callback: function(value) {
                    return fmt(Math.abs(value)).replace('₹', '₹ ');
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) label += ': ';
                    if (context.parsed.y !== null) label += fmt(Math.abs(context.parsed.y));
                    return label;
                  }
                }
              },
              legend: {
                position: 'top'
              }
            }
          }
        });
      }

      renderWalletUnified();
    }

    // --- Wallet unified (wallet + expenses) ---
    function setupWalletFilters() {
      const catSelect = document.getElementById('walletCategoryFilter');
      catSelect.innerHTML = '<option value="all">All Expense Categories</option>' + BASE_CATS.filter(c => c !== 'Investments' && c !== 'Insurance').map(c => `<option value="${c}">${c}</option>`).join('');
      renderWalletUnified();
    }

    function renderWalletUnified() {
      if (chartWallet) chartWallet.destroy();

      const filter = document.getElementById('walletCategoryFilter')?.value || 'all';

      const liquidData = data.filter(d => (d.type === 'expense' && d.category !== 'Investments' && d.category !== 'Insurance') || d.type === 'income' || (d.type === 'opening_balance' && d.investmentGroup === 'Cash'));
      const expenseData = liquidData.filter(d => d.type === 'expense' && (filter === 'all' || d.category === filter));

      const expenseGroups = expenseData.reduce((acc, curr) => {
        const key = curr.category;
        acc[key] = (acc[key] || 0) + Number(curr.amount);
        return acc;
      }, {});

      const positiveBalances = Object.entries(expenseGroups).map(([label, value]) => ({
        label,
        value
      })).filter(b => b.value > 0).sort((a, b) => b.value - a.value);

      const labels = positiveBalances.map(b => b.label);
      const values = positiveBalances.map(b => b.value);
      const colors = labels.map((_, i) => getChartColor(i));

      const ctx = document.getElementById('chartWallet');
      const legendEl = document.getElementById('walletChartLegend');

      if (ctx && legendEl) {
        chartWallet = new Chart(ctx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: colors,
              hoverOffset: 6,
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    let label = context.label || '';
                    if (label) label += ': ';
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    if (context.parsed !== null) {
                      label += fmt(context.parsed) + ` (${total ? ((context.parsed/total)*100).toFixed(1)+'%' : '0%'})`;
                    }
                    return label;
                  }
                }
              }
            }
          }
        });

        legendEl.innerHTML = positiveBalances.map((b, i) => `
          <div style="display:flex; justify-content:space-between;">
            <div style="display:flex; align-items:center;">
              <span style="width:10px; height:10px; border-radius:50%; background:${colors[i]}; margin-right:10px;"></span>
              ${b.label}
            </div>
            <span style="font-weight:600; color:var(--text-main)">${fmt(b.value)}</span>
          </div>
        `).join('');
      }
    }


    // --- ADVANCED ANALYTICS RENDER ---

    function renderAdvancedCharts() {
      const type = document.getElementById('chartType')?.value || 'line';
      const range = document.getElementById('analyticsDateRange')?.value || 'all';
      const curDate = new Date();
      const cutoffDate = range === 'all' ? new Date(0) : new Date(curDate.getFullYear(), curDate.getMonth() - Number(range), curDate.getDate());

      const chartData = data.filter(d => new Date(d.date) >= cutoffDate && d.type !== 'opening_balance');

      // 1. Net Worth Chart (Cumulative)
      const cumulativeData = {}; // Key: Date, Value: Net worth

      // Get initial net worth from opening balances
      let currentNetWorth = data.filter(d => d.type === 'opening_balance').reduce((acc, curr) => acc + Number(curr.amount), 0);

      // Sort all operational data by date
      const sortedOperationalData = data.filter(d => d.type !== 'opening_balance').sort((a, b) => new Date(a.date) - new Date(b.date));

      sortedOperationalData.forEach(d => {
        let amount = Number(d.amount);
        // Income and opening balances increase net worth. Expenses decrease it.
        if (d.type === 'expense') amount = -amount;

        currentNetWorth += amount;

        const dateKey = d.date; // Use full date for more accurate cumulative plot
        // Only record the value once per day, representing the final balance for that day
        cumulativeData[dateKey] = currentNetWorth;
      });

      const netWorthLabels = Object.keys(cumulativeData).sort();
      const netWorthValues = netWorthLabels.map(k => cumulativeData[k]);

      // Downsample for cleaner chart if many points
      let finalNetWorthLabels = netWorthLabels;
      let finalNetWorthValues = netWorthValues;
      if (netWorthLabels.length > 100) {
        finalNetWorthLabels = netWorthLabels.filter((_, i) => i % Math.ceil(netWorthLabels.length / 100) === 0 || i === netWorthLabels.length - 1);
        finalNetWorthValues = netWorthValues.filter((_, i) => i % Math.ceil(netWorthValues.length / 100) === 0 || i === netWorthValues.length - 1);
      }


      const netWorthCtx = document.getElementById('chartNetWorth')?.getContext('2d');
      if (netWorthCtx) {
        if (chartNetWorth) chartNetWorth.destroy();
        chartNetWorth = new Chart(netWorthCtx, {
          type: type,
          data: {
            labels: finalNetWorthLabels,
            datasets: [{
              label: 'Cumulative Net Worth',
              data: finalNetWorthValues,
              borderColor: 'var(--primary)',
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              fill: type === 'line' ? 'origin' : false,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: type === 'line' ? 1 : 0
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (c) => `${c.label}: ${fmt(c.parsed.y)}`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: (v) => fmt(v).replace('₹', '₹ ')
                },
                grid: {
                  color: '#eef2ff'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
    }


    function renderInvestmentAnalytics(mode = 'modal') {
      const allInvestments = data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments') || (d.type === 'income' && d.category === 'Investment Income'));

      // 1. Investment Type Breakdown (Doughnut)
      const typeGroups = allInvestments.filter(d => d.type !== 'income').reduce((acc, curr) => {
        const majorBucket = MAJOR_BUCKETS[curr.investmentGroup] || 'Other';
        acc[majorBucket] = (acc[majorBucket] || 0) + Number(curr.amount);
        return acc;
      }, {});

      const labels = Object.keys(typeGroups);
      const values = Object.values(typeGroups);
      const colors = labels.map((_, i) => getChartColor(i));

      const ctxTypes = document.getElementById('chartInvTypesModal')?.getContext('2d');
      if (ctxTypes) {
        if (chartInvTypesModal) chartInvTypesModal.destroy();
        chartInvTypesModal = new Chart(ctxTypes, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: colors,
              hoverOffset: 6,
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 10
                }
              },
              tooltip: {
                callbacks: {
                  label: (c) => {
                    const total = values.reduce((a, b) => a + b, 0);
                    return `${c.label}: ${fmt(c.parsed)} (${total ? ((c.parsed/total)*100).toFixed(1)+'%' : '0%'})`;
                  }
                }
              }
            }
          }
        });
      }


      // 2. Investment Growth (Line Chart)
      const investmentOperationalData = allInvestments.filter(d => d.type !== 'income').sort((a, b) => new Date(a.date) - new Date(b.date));
      const cumulativeInvestmentData = {};
      let currentTotalInvested = 0;

      investmentOperationalData.forEach(d => {
        currentTotalInvested += Number(d.amount);
        cumulativeInvestmentData[d.date] = currentTotalInvested;
      });

      const growthLabels = Object.keys(cumulativeInvestmentData).sort();
      const growthValues = growthLabels.map(k => cumulativeInvestmentData[k]);

      const ctxGrowth = document.getElementById('chartInvGrowthModal')?.getContext('2d');
      if (ctxGrowth) {
        if (chartInvGrowthModal) chartInvGrowthModal.destroy();
        chartInvGrowthModal = new Chart(ctxGrowth, {
          type: 'line',
          data: {
            labels: growthLabels,
            datasets: [{
              label: 'Cumulative invested (historical cost)',
              data: growthValues,
              borderColor: '#2980b9',
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 0
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (c) => `${c.dataset.label}: ${fmt(c.parsed.y)}`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: (v) => fmt(v).replace('₹', '₹ ')
                },
                grid: {
                  color: '#eef2ff'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
    }


    // --- SETTINGS ---

    function renderSettings() {
      const methodContainer = document.getElementById('methodEditor');
      methodContainer.innerHTML = Object.entries(methodNames).map(([key, name]) => `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
          <input type="text" value="${name}" data-key="${key}" onchange="updateMethodName(this)" style="flex:1; margin-right:10px;">
          ${(key !== 'cash' && key !== 'bank') ? `<button class="btn-danger" onclick="removeMethod('${key}')" style="padding:6px 12px;">Remove</button>` : ''}
        </div>
      `).join('');
      
      const incomeContainer = document.getElementById('sourceEditor');
      incomeContainer.innerHTML = incomeSources.map(source => `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
          <input type="text" value="${source}" readonly style="flex:1; margin-right:10px;">
          <button class="btn-danger" onclick="removeIncomeSource('${source}')" style="padding:6px 12px;">Remove</button>
        </div>
      `).join('');

      document.getElementById('ccLimit').value = settings.ccLimit;
      document.getElementById('ccPaymentDay').value = settings.ccPaymentDay;
      document.getElementById('ccThreshold').value = settings.ccAlertThreshold * 100;
    }


    // --- IMPORT/EXPORT ---

    function convertToCSV(data) {
      const headers = ['id', 'type', 'amount', 'date', 'desc', 'category', 'method', 'incomeSource', 'investmentGroup', 'investmentSub', 'insuranceType', 'insuranceFor'];
      const rows = data.map(obj => headers.map(header => {
        let value = obj[header] ?? '';
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }).join(','));

      const csvContent = [
        headers.join(','),
        ...rows
      ].join('\n');

      const blob = new Blob([csvContent], {
        type: 'text/csv;charset=utf-8;'
      });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'MoneyMirror_Export.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const dataRows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].match(/(?:"[^"]*"|[^,])+/g);
        if (!values) continue;

        const entry = {
          id: uid(),
          type: 'expense',
          amount: 0,
          date: new Date().toISOString().slice(0, 10),
          desc: 'Imported Entry',
          category: '',
          method: 'cash',
          incomeSource: '',
          investmentGroup: '',
          investmentSub: '',
          insuranceType: '',
          insuranceFor: ''
        };

        headers.forEach((header, index) => {
          let value = values[index] ? values[index].trim().replace(/"/g, '') : '';
          if (header === 'amount') value = Number(value);
          if (header === 'type' && value) entry.type = value;
          if (header === 'date' && value) entry.date = value;
          if (header === 'desc' && value) entry.desc = value;
          if (header === 'category' && value) entry.category = value;
          if (header === 'method' && value) entry.method = value;
          if (header === 'incomeSource' && value) entry.incomeSource = value;
          if (header === 'investmentGroup' && value) entry.investmentGroup = value;
          if (header === 'investmentSub' && value) entry.investmentSub = value;
          if (header === 'insuranceType' && value) entry.insuranceType = value;
          if (header === 'insuranceFor' && value) entry.insuranceFor = value;
        });

        if (entry.amount > 0) dataRows.push(entry);
      }
      return dataRows;
    }

    function processImportedData() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) return alert('Please select a file.');

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        let importedData = [];

        if (file.name.endsWith('.json')) {
          try {
            importedData = JSON.parse(content);
          } catch (err) {
            return alert('Error parsing JSON file: ' + err.message);
          }
        } else if (file.name.endsWith('.csv')) {
          importedData = parseCSV(content);
        } else {
          return alert('Unsupported file type. Please use CSV or JSON.');
        }

        if (importedData.length === 0) return alert('No valid data found in the file.');

        // Merge or overwrite data
        if (confirm(`Found ${importedData.length} valid entries. Do you want to overwrite all current data? (Select 'Cancel' to merge the new data with existing data)`)) {
          data = [];
        }

        importedData.forEach(entry => submitForm(entry, true));

        saveAll();
        renderAll();
        document.getElementById('importModal').classList.remove('open');
        alert(`${importedData.length} entries successfully imported and synced.`);
      };
      reader.readAsText(file);
    }


    // --- SAMPLE DATA ---

    function loadSampleData() {
      if (!confirm("This will overwrite all existing data for your current profile. Continue?")) return;

      function randBetween(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
      }

      function pick(arr) {
        return arr[randBetween(0, arr.length - 1)];
      }

      function dateInLastMonths(months) {
        const today = new Date();
        const startMonth = months[0];
        const endMonth = months.length > 1 ? months[1] : startMonth;
        const monthDiff = randBetween(startMonth, endMonth);
        const targetDate = new Date(today);
        targetDate.setMonth(today.getMonth() - monthDiff);
        const maxDays = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
        targetDate.setDate(randBetween(1, maxDays));
        return targetDate.toISOString().slice(0, 10);
      }

      data = [];
      methodNames = { ...CANONICAL_METHODS
      };
      incomeSources = ['Salary (Primary)', 'Freelance Income', 'Investment Income'];
      settings.ccLimit = 200000;

      // Opening balances (Cash)
      data.push({
        id: uid(),
        type: 'opening_balance',
        amount: 50000,
        date: dateInLastMonths([6, 6]),
        desc: 'Initial Salary Account Balance',
        investmentGroup: 'Cash',
        investmentSub: 'Bank Account (Salary)',
        method: 'salary_acct',
        category: 'N/A'
      });
      data.push({
        id: uid(),
        type: 'opening_balance',
        amount: 15000,
        date: dateInLastMonths([6, 6]),
        desc: 'Initial Wallet Balance',
        investmentGroup: 'Cash',
        investmentSub: 'E-Wallet (UPI)',
        method: 'e_wallet',
        category: 'N/A'
      });
      data.push({
        id: uid(),
        type: 'opening_balance',
        amount: 100000,
        date: dateInLastMonths([6, 6]),
        desc: 'Initial Investment Portfolio Value',
        investmentGroup: 'Mutual Funds',
        investmentSub: 'Index Funds',
        method: 'investment_acct',
        category: 'N/A'
      });

      // Income (6 months of salary + freelance)
      for (let i = 0; i < 6; i++) {
        const date = dateInLastMonths([i, i]);
        data.push({
          id: uid(),
          type: 'income',
          amount: randBetween(80000, 100000),
          date: date,
          desc: 'Monthly Salary Deposit',
          incomeSource: 'Salary (Primary)',
          method: 'salary_acct',
          category: 'N/A'
        });

        if (Math.random() > 0.5) {
          data.push({
            id: uid(),
            type: 'income',
            amount: randBetween(5000, 20000),
            date: date,
            desc: 'Freelance Project Payout',
            incomeSource: 'Freelance Income',
            method: 'bank',
            category: 'N/A'
          });
        }
      }

      // Expenses and investments
      const methodsPool = ['cash', 'bank', 'credit_card', 'e_wallet'];
      const expenseCategories = BASE_CATS.filter(c => c !== 'Investments' && c !== 'Insurance');

      for (let i = 0; i < 50; i++) {
        const dt = dateInLastMonths([0, 5]);
        const cat = pick(expenseCategories);
        const amt = randBetween(300, 9000);
        const method = pick(methodsPool);

        // Regular expenses
        data.push({
          id: uid(),
          type: 'expense',
          amount: amt,
          date: dt,
          desc: `${cat} expense`,
          category: cat,
          method
        });

        // Investment (SIP/Buy)
        if (Math.random() > 0.75) {
          const invGroup = pick(Object.keys(INVESTMENT_STRUCTURE));
          const invSub = pick(Object.keys(INVESTMENT_STRUCTURE[invGroup]));
          data.push({
            id: uid(),
            type: 'expense',
            amount: randBetween(2000, 15000),
            date: dt,
            desc: `SIP/Purchase - ${invSub}`,
            category: 'Investments',
            method: 'bank',
            investmentGroup: invGroup,
            investmentSub: invSub
          });
        }
      }

      saveAll();
      renderAll();
      alert('Sample data loaded. Enjoy exploring!');
    }

    // --- CALCULATOR ---

    // Calculator state
    let displayValue = '0';
    let prevValue = null;
    let operator = null;

    function updateDisplay(result) {
      const display = document.getElementById('calc-display');
      const preview = document.getElementById('calc-preview');
      display.textContent = displayValue;

      try {
        if (!result) return preview.textContent = '';
        const expr = result.replace(/×/g, '*').replace(/÷/g, '/');
        const calculatedResult = new Function('return ' + expr)();
        preview.textContent = '≈ ' + fmt(Number(calculatedResult));
      } catch (err) {
        preview.textContent = '';
      }
    }

    function calculate(op) {
      if (prevValue === null) {
        prevValue = parseFloat(displayValue);
        operator = op;
        displayValue = '0';
      } else if (op === '=') {
        const currentValue = parseFloat(displayValue);
        let result = 0;
        switch (operator) {
          case '+':
            result = prevValue + currentValue;
            break;
          case '-':
            result = prevValue - currentValue;
            break;
          case '×':
            result = prevValue * currentValue;
            break;
          case '÷':
            result = prevValue / currentValue;
            break;
        }
        displayValue = String(result);
        prevValue = null;
        operator = null;
      } else {
        calculate('=');
        operator = op;
        prevValue = parseFloat(displayValue);
        displayValue = '0';
      }
      updateDisplay();
    }

    function handleInput(type, value) {
      const isOperator = ['+', '-', '×', '÷'].includes(value);

      if (type === 'number') {
        if (displayValue === '0' && value !== '.') {
          displayValue = value;
        } else if (value === '.' && displayValue.includes('.')) {
          // Do nothing if decimal already exists
        } else {
          displayValue += value;
        }
      } else if (type === 'operator' && isOperator) {
        if (prevValue !== null && displayValue !== '0') {
          calculate('=');
        }
        calculate(value);
      } else if (value === 'C') {
        displayValue = '0';
        prevValue = null;
        operator = null;
      } else if (value === 'AC') {
        displayValue = '0';
        prevValue = null;
        operator = null;
      } else if (value === '%') {
        displayValue = String(parseFloat(displayValue) / 100);
      } else if (value === '+/-') {
        displayValue = String(parseFloat(displayValue) * -1);
      }

      updateDisplay(prevValue !== null ? prevValue + operator + displayValue : displayValue);
    }

    document.querySelectorAll('#calc-buttons button').forEach(button => {
      button.addEventListener('click', (e) => {
        const value = e.target.textContent.trim();
        const type = e.target.classList.contains('calc-operator') || ['C', 'AC', '+/-', '%'].includes(value) ? 'function' : 'number';
        handleInput(type, value);
      });
    });

    // Drag calc
    function dragElement(elmnt) {
      if (!elmnt) return;
      const header = document.getElementById(elmnt.id + "-header") || document.getElementById('calc-header');
      let pos1 = 0,
        pos2 = 0,
        pos3 = 0,
        pos4 = 0;
      header.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
      }

      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }


    // --- MISC ---

    document.addEventListener('DOMContentLoaded', () => {
      // Cache form elements [Initialization of formEls]
      formEls.type = document.getElementById('type');
      formEls.amount = document.getElementById('amount');
      formEls.date = document.getElementById('date');
      formEls.desc = document.getElementById('desc');
      formEls.category = document.getElementById('category');
      formEls.method = document.getElementById('method');
      formEls.incomeSource = document.getElementById('incomeSource');
      formEls.invGroup = document.getElementById('invGroup');
      formEls.invSub = document.getElementById('invSub');
      formEls.insType = document.getElementById('insType');
      formEls.insFor = document.getElementById('insFor');
      formEls.openingType = document.getElementById('openingType');
      formEls.openingGroup = document.getElementById('openingGroup');
      formEls.openingSub = document.getElementById('openingSub');
      formEls.addBtn = document.getElementById('addBtn');
      formEls.saveBtn = document.getElementById('saveBtn');
      formEls.cancelBtn = document.getElementById('cancelBtn');
      formEls.incomeRow = document.getElementById('incomeRow');
      formEls.invRow = document.getElementById('investmentRow');
      formEls.insRow = document.getElementById('insuranceRow');
      formEls.openingBalanceRow = document.getElementById('openingBalanceRow');

      // Set current date
      const d = new Date();
      document.getElementById('currentDate').innerText = d.toLocaleDateString('en-IN', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const today = new Date().toISOString().slice(0, 10);
      const dateEl = document.getElementById('date');
      if (dateEl) dateEl.value = today;

      // Make calculator draggable
      dragElement(document.getElementById("calculator"));

      // Mobile menu toggler
      const mobileBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('mainSidebar');
      mobileBtn.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => sidebar.classList.remove('mobile-open'));
      });

      // Modal listeners
      document.getElementById('navSettings').addEventListener('click', () => {
        document.getElementById('settingsModal').classList.add('open');
      });
      document.getElementById('closeSettings').addEventListener('click', () => {
        document.getElementById('settingsModal').classList.remove('open');
      });
      document.getElementById('navAnalytics').addEventListener('click', () => {
        document.getElementById('analyticsModal').classList.add('open');
        renderAdvancedCharts();
        renderInvestmentAnalytics('modal');
      });
      document.getElementById('closeAnalytics').addEventListener('click', () => {
        document.getElementById('analyticsModal').classList.remove('open');
      });
      document.getElementById('importDataBtn').addEventListener('click', () => {
        document.getElementById('importModal').classList.add('open');
      });
      document.getElementById('closeImport').addEventListener('click', () => {
        document.getElementById('importModal').classList.remove('open');
      });

      // Calculator toggle
      document.getElementById('calc-toggle').addEventListener('click', () => {
        const calc = document.getElementById('calculator');
        calc.style.display = calc.style.display === 'none' ? 'flex' : 'none';
      });
      document.getElementById('calc-close-btn').addEventListener('click', (e) => {
        document.getElementById('calculator').style.display = 'none';
        e.stopPropagation();
      });

      // Data actions
      document.getElementById('sampleBtn').addEventListener('click', loadSampleData);
      document.getElementById('exportBtn').addEventListener('click', () => convertToCSV(data));
      document.getElementById('processImportBtn').addEventListener('click', processImportedData);
      document.getElementById('resetBtn').addEventListener('click', () => {
        if (confirm('WARNING: This will erase ALL your data (local and Firestore). Are you absolutely sure?')) {
          localStorage.clear();
          data = [];
          methodNames = { ...CANONICAL_METHODS
          };
          incomeSources = ['Salary', 'Freelance', 'Interest'];
          settings = {
            ccLimit: 100000,
            ccPaymentDay: 10,
            ccAlertThreshold: 0.8
          };
          saveAll();
          renderAll();
          alert('Data reset successfully.');
        }
      });

      // Form listeners
      formEls.addBtn.addEventListener('click', () => submitForm());
      formEls.saveBtn.addEventListener('click', () => {
        const entryToEdit = data.find(t => t.id === editId);
        if (entryToEdit) submitForm(entryToEdit);
      });
      formEls.cancelBtn.addEventListener('click', () => {
        editId = null;
        formEls.addBtn.classList.remove('hidden');
        formEls.saveBtn.classList.add('hidden');
        formEls.cancelBtn.classList.add('hidden');
        clearForm();
      });

      // Chart filter listeners
      document.getElementById('toggleInvBreakdown')?.addEventListener('click', () => {
        document.getElementById('invBreakdownContainer').classList.toggle('hidden');
      });
      document.getElementById('invBucketFilter')?.addEventListener('change', () => renderInvestmentBreakdown(data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments') || (d.type === 'income' && d.category === 'Investment Income'))));
      document.getElementById('invViewMode')?.addEventListener('change', () => renderInvestmentBreakdown(data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments') || (d.type === 'income' && d.category === 'Investment Income'))));
      document.getElementById('invDateRange')?.addEventListener('change', () => renderInvestmentBreakdown(data.filter(d => (d.type === 'opening_balance' && d.investmentGroup && d.investmentGroup !== 'Cash') || (d.type === 'expense' && d.category === 'Investments') || (d.type === 'income' && d.category === 'Investment Income'))));
      document.getElementById('walletCategoryFilter')?.addEventListener('change', renderWalletUnified);
      document.getElementById('analyticsDateRange')?.addEventListener('change', renderAdvancedCharts);
      document.getElementById('chartType')?.addEventListener('change', renderAdvancedCharts);


      // Initialize default form state
      clearForm();

      if (auth) {
        auth.onAuthStateChanged(user => {
          if (user) onUserSignedIn(user);
          else {
            document.getElementById('authGate').style.display = 'flex';
            document.querySelector('main').style.filter = 'blur(5px)';
            document.getElementById('logoutBtn').style.display = 'none';
          }
        });
      } else {
        loadProfileData();
      }
    });
  </script>
