<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyMirror Financial Dashboard v5.1 (Restored & Enhanced)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Lucide Icons for aesthetic appeal -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- General Styling --- */
        :root {
            --primary-color: #3498db; /* Blue */
            --secondary-color: #2c3e50; /* Dark Blue */
            --success: #2ecc71; /* Emerald Green */
            --danger: #e74c3c; /* Alizarin Red */
            --warning: #f39c12; /* Orange */
            --background: #f4f6f9; /* Light Gray Background */
            --card-background: #ffffff;
            --text-color: #333333;
            --text-muted: #95a5a6;
            --border: #e0e0e0;
            --sidebar-width: 280px;
            --sidebar-background: #34495e;
            --sidebar-text: #ecf0f1;
            --sidebar-active: #2980b9;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        aside {
            width: var(--sidebar-width);
            background-color: var(--sidebar-background);
            color: var(--sidebar-text);
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.3);
            position: fixed;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .brand {
            font-size: 28px;
            font-weight: 800;
            padding: 20px 20px 15px 20px;
            color: var(--primary-color);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-left: 5px;
        }

        nav {
            flex-grow: 1;
            padding-top: 20px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 16px;
            font-weight: 600;
            gap: 15px;
            border-left: 5px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: var(--sidebar-active);
            border-left: 5px solid var(--primary-color);
        }
        
        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .user-id-display {
            word-break: break-all;
            margin-top: 10px;
            font-weight: 600;
            color: white;
        }

        /* --- Main Content & Header --- */
        main {
            margin-left: var(--sidebar-width);
            padding: 30px;
            flex-grow: 1;
            max-width: calc(100% - var(--sidebar-width));
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--secondary-color);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* --- Buttons --- */
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--card-background);
            color: var(--secondary-color);
            border-color: var(--border);
        }
        
        .btn-secondary:hover {
            background-color: var(--border);
        }

        /* --- KPI Cards (More Engaging) --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .widget.span-2 {
            grid-column: span 2;
        }
        
        .widget.span-4 {
            grid-column: span 4;
        }

        .kpi-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.2;
            color: var(--secondary-color);
        }
        
        .kpi-indicator {
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            margin-top: 5px;
            gap: 5px;
        }
        
        .kpi-indicator svg {
            width: 16px;
            height: 16px;
        }

        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-primary { color: var(--primary-color); }
        .text-warning { color: var(--warning); }
        
        /* Specific KPI Icons */
        .kpi-icon {
            float: right;
            color: var(--primary-color);
            opacity: 0.6;
        }
        .kpi-icon.success { color: var(--success); }
        .kpi-icon.danger { color: var(--danger); }


        /* --- Charts and Data Management --- */
        .chart-container {
            padding: 20px;
            border-radius: 15px;
            background-color: var(--card-background);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 350px; /* Fixed height for consistency */
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        /* --- Transaction Form --- */
        .section-header {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .transaction-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1.5fr 0.8fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .transaction-form input,
        .transaction-form select {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            background-color: var(--background);
            width: 100%;
            box-sizing: border-box;
        }
        
        /* --- Transactions Table --- */
        .transaction-table {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            background-color: var(--card-background);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .transaction-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .transaction-table th, .transaction-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .transaction-table th {
            background-color: var(--background);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            color: var(--secondary-color);
            position: sticky;
            top: 0;
            z-index: 500;
        }

        .transaction-table .delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            transition: opacity 0.2s;
        }
        
        /* --- Modals (Calculator & Settings) --- */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 62, 80, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-background);
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 25px;
        }

        /* --- Calculator Specific Styles --- */
        #calc-display {
            background-color: var(--secondary-color);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 32px;
            text-align: right;
            margin-bottom: 15px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-weight: 600;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .calc-btn {
            padding: 20px 10px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            background-color: var(--background);
            color: var(--secondary-color);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.1s;
        }
        
        .calc-btn:hover {
            background-color: var(--border);
        }
        
        .calc-btn.operator {
            background-color: var(--primary-color);
            color: white;
        }
        .calc-btn.operator:hover {
            background-color: #2980b9;
        }
        
        .calc-btn.clear {
            background-color: var(--danger);
            color: white;
        }
        .calc-btn.clear:hover {
            background-color: #c0392b;
        }

        /* --- Responsive Design (Mobile First) --- */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .widget.span-2, .widget.span-4 {
                grid-column: span 2;
            }
            .transaction-form .form-row {
                grid-template-columns: 1fr;
            }
            main {
                margin-left: 0;
                padding: 15px;
            }
            aside {
                display: none; /* Hide sidebar on small screens for simplicity */
            }
        }
    </style>
</head>
<body>

    <!-- Sidebar Navigation -->
    <aside>
        <div>
            <div class="brand">
                <i data-lucide="wallet-2"></i> MoneyMirror <span>v5.1</span>
            </div>
            <nav>
                <div class="nav-group">
                    <div class="nav-item active" onclick="scrollToElement('dashboard')">
                        <i data-lucide="layout-dashboard"></i> Dashboard
                    </div>
                    <div class="nav-item" onclick="scrollToElement('data-management')">
                        <i data-lucide="dollar-sign"></i> Transactions
                    </div>
                    <div class="nav-item" onclick="openModal('settingsModal')">
                        <i data-lucide="settings"></i> Settings
                    </div>
                </div>
            </nav>
        </div>
        <div class="sidebar-footer">
            <p>System Status: <span class="text-success">Connected</span></p>
            <p>Current User ID:</p>
            <p class="user-id-display" id="userIdDisplay">Authenticating...</p>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main>
        <header>
            <h1 class="page-title">Financial Overview</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" id="openCalcBtn" onclick="openModal('calculatorModal')">
                    <i data-lucide="calculator"></i> Calculator
                </button>
                <button class="btn btn-primary" id="openSettingsBtn" onclick="openModal('settingsModal')">
                    <i data-lucide="cog"></i> Configure
                </button>
            </div>
        </header>

        <!-- KPI Cards Section -->
        <section id="dashboard">
            <div class="dashboard-grid">
                
                <!-- KPI 1: Net Worth -->
                <div class="card kpi-card">
                    <div class="kpi-icon"><i data-lucide="wallet-2" width="36" height="36"></i></div>
                    <p class="kpi-title">Total Net Worth</p>
                    <p class="kpi-value text-primary" id="netWorthValue">$0.00</p>
                    <div class="kpi-indicator text-success" id="netWorthIndicator">
                        <i data-lucide="trending-up"></i> +$0.00 (0%)
                    </div>
                </div>

                <!-- KPI 2: Monthly Cash Flow -->
                <div class="card kpi-card">
                    <div class="kpi-icon success"><i data-lucide="activity" width="36" height="36"></i></div>
                    <p class="kpi-title">Monthly Cash Flow</p>
                    <p class="kpi-value text-success" id="cashFlowValue">$0.00</p>
                    <div class="kpi-indicator text-success" id="cashFlowIndicator">
                        <i data-lucide="check-circle"></i> Surplus
                    </div>
                </div>

                <!-- KPI 3: Savings Rate -->
                <div class="card kpi-card">
                    <div class="kpi-icon warning"><i data-lucide="piggy-bank" width="36" height="36"></i></div>
                    <p class="kpi-title">Target Savings Rate</p>
                    <p class="kpi-value text-warning" id="savingsRateValue">0%</p>
                    <div class="kpi-indicator text-warning" id="savingsRateIndicator">
                        <i data-lucide="percent"></i> 20% Target
                    </div>
                </div>

                <!-- KPI 4: Debt-to-Asset Ratio -->
                <div class="card kpi-card">
                    <div class="kpi-icon danger"><i data-lucide="gauge" width="36" height="36"></i></div>
                    <p class="kpi-title">Debt-to-Asset Ratio</p>
                    <p class="kpi-value text-danger" id="debtRatioValue">0%</p>
                    <div class="kpi-indicator text-danger" id="debtRatioIndicator">
                        <i data-lucide="alert-triangle"></i> Keep Low
                    </div>
                </div>
            </div>

            <!-- Graphs Side-by-Side (span-4 for the container, span-2 for each chart) -->
            <div class="dashboard-grid">
                <!-- Chart 1: Cash Flow Breakdown (Income vs Expense) -->
                <div class="widget span-2">
                    <div class="chart-container">
                        <h2 class="chart-title">Monthly Cash Flow Breakdown</h2>
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Net Worth Trend -->
                <div class="widget span-2">
                    <div class="chart-container">
                        <h2 class="chart-title">Net Worth Trend (6 Months)</h2>
                        <canvas id="netWorthChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Data Management Section (Transactions) -->
        <section id="data-management">
            <h2 class="section-header">Manage Transactions</h2>

            <!-- Transaction Input Form -->
            <div class="card mb-20">
                <form id="transactionForm">
                    <div class="transaction-form">
                        <div class="form-row">
                            <select id="type" required>
                                <option value="Income">Income</option>
                                <option value="Expense">Expense</option>
                                <option value="Asset">Asset</option>
                                <option value="Liability">Liability</option>
                            </select>
                            <input type="number" id="amount" placeholder="Amount (e.g., 1500.00)" step="0.01" required>
                            <select id="category" required>
                                <option value="" disabled selected>Select Category</option>
                                <!-- Categories populated by JS -->
                            </select>
                            <input type="text" id="description" placeholder="Description (e.g., Monthly Salary)" required>
                            <button type="submit" class="btn btn-primary"><i data-lucide="plus"></i> Add</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Transactions List Table -->
            <h3 class="section-header" style="font-size: 20px;">Recent Entries</h3>
            <div class="transaction-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList">
                        <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No transactions found.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Modal for Calculator -->
    <div id="calculatorModal" class="modal" onclick="closeModalOnOutsideClick(event, 'calculatorModal')">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <div class="modal-title"><i data-lucide="calculator"></i> Financial Calculator</div>
                <button class="modal-close" onclick="closeModal('calculatorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calc-display">0</div>
                <div class="calc-grid">
                    <button class="calc-btn clear span-2" onclick="calcClear()">AC</button>
                    <button class="calc-btn operator" onclick="calcInput('/')">/</button>
                    <button class="calc-btn operator" onclick="calcInput('*')">x</button>
                    
                    <button class="calc-btn" onclick="calcInput('7')">7</button>
                    <button class="calc-btn" onclick="calcInput('8')">8</button>
                    <button class="calc-btn" onclick="calcInput('9')">9</button>
                    <button class="calc-btn operator" onclick="calcInput('-')">-</button>
                    
                    <button class="calc-btn" onclick="calcInput('4')">4</button>
                    <button class="calc-btn" onclick="calcInput('5')">5</button>
                    <button class="calc-btn" onclick="calcInput('6')">6</button>
                    <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                    
                    <button class="calc-btn" onclick="calcInput('1')">1</button>
                    <button class="calc-btn" onclick="calcInput('2')">2</button>
                    <button class="calc-btn" onclick="calcInput('3')">3</button>
                    <button class="calc-btn span-2" onclick="calcInput('0')">0</button>
                    <button class="calc-btn" onclick="calcInput('.')">.</button>
                    <button class="calc-btn operator" onclick="calcCalculate()">=</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Settings/Configuration -->
    <div id="settingsModal" class="modal" onclick="closeModalOnOutsideClick(event, 'settingsModal')">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i data-lucide="settings"></i> System Configuration</div>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <h3>Default Categories</h3>
                    <p style="color: var(--text-muted); font-size: 14px;">Manage the categories available for transactions.</p>
                    <div id="categoryListDisplay" style="margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newCategoryInput" placeholder="Add New Category Name" style="flex-grow: 1; padding: 10px;">
                        <button class="btn btn-secondary" onclick="addCategory()" style="flex-shrink: 0;"><i data-lucide="plus"></i> Add Category</button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Data Management</h3>
                    <button class="btn btn-danger" onclick="confirmResetData()">
                        <i data-lucide="trash-2"></i> Reset ALL Financial Data
                    </button>
                    <p style="color: var(--danger); font-size: 12px; margin-top: 5px;">Warning: This action is permanent and clears all saved transactions.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase Initialization and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug'); // Enable debug logging for Firebase

        // Global Variables for Canvas Environment (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let categories = ['Salary', 'Rent', 'Food', 'Utilities', 'Investment', 'Loan'];
        let transactions = [];
        let netWorthChartInstance, cashFlowChartInstance;
        
        const DB_COLLECTION = `artifacts/${appId}/users`;
        const CONFIG_DOC = 'config';
        const TRANSACTIONS_DOC = 'transactions';

        // --- Utility Functions ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        };
        
        const formatPercent = (value) => {
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(value / 100);
        };
        
        function scrollToElement(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        // --- Modal Control ---
        window.openModal = function(id) {
            document.getElementById(id).classList.add('open');
        }

        window.closeModal = function(id) {
            document.getElementById(id).classList.remove('open');
        }
        
        window.closeModalOnOutsideClick = function(event, id) {
            const modal = document.getElementById(id);
            if (event.target === modal) {
                modal.classList.remove('open');
            }
        }
        
        window.confirmResetData = function() {
            // Using a simple custom prompt/modal substitute instead of alert/confirm
            const result = prompt("Type 'RESET' to confirm deletion of ALL financial data. This action is irreversible.");
            if (result === 'RESET') {
                resetAllData();
            } else if (result !== null) {
                console.log("Data reset cancelled or confirmation failed.");
            }
        }


        // --- Firestore Core Functions ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                document.getElementById('userIdDisplay').textContent = "ERROR: Config missing";
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Auth setup
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in anonymously if no token is available
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            userId = auth.currentUser.uid;
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }
                    if (userId) {
                        document.getElementById('userIdDisplay').textContent = userId;
                        setupRealtimeListeners(userId);
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('userIdDisplay').textContent = "ERROR: Init Failed";
            }
        }
        
        function setupRealtimeListeners(currentUserId) {
            const userConfigDocRef = doc(db, DB_COLLECTION, currentUserId, 'private', CONFIG_DOC);
            const userTransactionsDocRef = doc(db, DB_COLLECTION, currentUserId, 'private', TRANSACTIONS_DOC);

            // 1. Listen for Config changes (Categories)
            onSnapshot(userConfigDocRef, (doc) => {
                if (doc.exists() && doc.data().categories) {
                    categories = doc.data().categories;
                } else {
                    // Initialize with default categories if not present
                    setDoc(userConfigDocRef, { categories: categories }, { merge: true });
                }
                updateCategoryUI();
            }, (error) => console.error("Config Listener Error:", error));

            // 2. Listen for Transaction changes
            onSnapshot(userTransactionsDocRef, (doc) => {
                if (doc.exists() && doc.data().entries) {
                    transactions = doc.data().entries;
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                } else {
                    transactions = [];
                    // Initialize with an empty structure
                    setDoc(userTransactionsDocRef, { entries: [] }, { merge: true });
                }
                renderTransactions();
                updateKPIs();
                updateCharts();
            }, (error) => console.error("Transaction Listener Error:", error));
        }
        
        async function addTransaction(event) {
            event.preventDefault();
            if (!userId) { console.error("User not authenticated."); return; }
            
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            
            if (isNaN(amount) || amount <= 0) { console.error("Invalid amount."); return; }

            const newEntry = {
                id: crypto.randomUUID(),
                date: new Date().toISOString(),
                type,
                amount: amount * (type === 'Expense' || type === 'Liability' ? -1 : 1), // Store expenses/liabilities as negative
                category,
                description,
            };
            
            const docRef = doc(db, DB_COLLECTION, userId, 'private', TRANSACTIONS_DOC);
            
            try {
                await updateDoc(docRef, {
                    entries: arrayUnion(newEntry)
                });
                document.getElementById('transactionForm').reset();
            } catch (error) {
                console.error("Error adding transaction:", error);
            }
        }
        
        window.deleteTransaction = async function(id) {
            if (!userId) { console.error("User not authenticated."); return; }
            
            const entryToDelete = transactions.find(t => t.id === id);
            if (!entryToDelete) return;
            
            const docRef = doc(db, DB_COLLECTION, userId, 'private', TRANSACTIONS_DOC);
            
            try {
                await updateDoc(docRef, {
                    entries: arrayRemove(entryToDelete)
                });
            } catch (error) {
                console.error("Error deleting transaction:", error);
            }
        }
        
        async function resetAllData() {
            if (!userId) return;
            const docRef = doc(db, DB_COLLECTION, userId, 'private', TRANSACTIONS_DOC);
            try {
                await setDoc(docRef, { entries: [] });
                alertUser("Success: All financial data has been reset.");
                closeModal('settingsModal');
            } catch (error) {
                console.error("Error resetting data:", error);
                alertUser("Error: Could not reset data.");
            }
        }
        
        // --- Category Management ---
        function updateCategoryUI() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="" disabled selected>Select Category</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            
            const display = document.getElementById('categoryListDisplay');
            display.innerHTML = categories.map(cat => `<span>${cat}</span>`).join('');
        }

        window.addCategory = async function() {
            const input = document.getElementById('newCategoryInput');
            const newCat = input.value.trim();
            if (newCat && !categories.includes(newCat) && userId) {
                const docRef = doc(db, DB_COLLECTION, userId, 'private', CONFIG_DOC);
                try {
                    await updateDoc(docRef, {
                        categories: arrayUnion(newCat)
                    });
                    input.value = '';
                } catch (error) {
                    console.error("Error adding category:", error);
                }
            }
        }

        // --- Render Functions ---
        function renderTransactions() {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            
            if (transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">No transactions recorded yet.</td></tr>';
                return;
            }

            transactions.forEach(t => {
                const tr = document.createElement('tr');
                const sign = t.amount >= 0 ? 1 : -1;
                const formattedAmount = formatCurrency(Math.abs(t.amount));
                const amountClass = t.amount >= 0 ? 'text-success' : 'text-danger';

                tr.innerHTML = `
                    <td>${new Date(t.date).toLocaleDateString()}</td>
                    <td>${t.type}</td>
                    <td>${t.category}</td>
                    <td class="${amountClass}">${formattedAmount}</td>
                    <td>${t.description}</td>
                    <td><button class="delete-btn" onclick="deleteTransaction('${t.id}')"><i data-lucide="trash-2"></i></button></td>
                `;
                list.appendChild(tr);
            });
            // Re-render lucide icons after updating the list
            lucide.createIcons();
        }

        function updateKPIs() {
            if (transactions.length === 0) {
                // Reset all KPIs to $0.00
                document.getElementById('netWorthValue').textContent = formatCurrency(0);
                document.getElementById('cashFlowValue').textContent = formatCurrency(0);
                document.getElementById('savingsRateValue').textContent = formatPercent(0);
                document.getElementById('debtRatioValue').textContent = formatPercent(0);
                return;
            }

            // 1. Calculate Net Worth
            const assets = transactions.filter(t => t.type === 'Asset' || (t.type === 'Income' && t.category !== 'Salary')).reduce((sum, t) => sum + t.amount, 0);
            const liabilities = transactions.filter(t => t.type === 'Liability').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netWorth = assets - liabilities;
            document.getElementById('netWorthValue').textContent = formatCurrency(netWorth);
            
            // 2. Calculate Monthly Cash Flow (Last 30 Days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentTransactions = transactions.filter(t => new Date(t.date) > thirtyDaysAgo);
            
            const income = recentTransactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const expense = recentTransactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0); // already negative
            const monthlyCashFlow = income + expense;

            document.getElementById('cashFlowValue').textContent = formatCurrency(monthlyCashFlow);
            document.getElementById('cashFlowValue').className = 'kpi-value ' + (monthlyCashFlow >= 0 ? 'text-success' : 'text-danger');
            document.getElementById('cashFlowIndicator').innerHTML = monthlyCashFlow >= 0 ? 
                `<i data-lucide="check-circle"></i> Surplus` : 
                `<i data-lucide="x-circle"></i> Deficit`;
            document.getElementById('cashFlowIndicator').className = 'kpi-indicator ' + (monthlyCashFlow >= 0 ? 'text-success' : 'text-danger');
            
            // 3. Savings Rate (Assuming 'Investment' category = Savings)
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const totalSavings = transactions.filter(t => t.category === 'Investment').reduce((sum, t) => sum + t.amount, 0);

            const savingsRate = totalIncome > 0 ? (totalSavings / totalIncome) * 100 : 0;
            document.getElementById('savingsRateValue').textContent = formatPercent(savingsRate);
            
            // 4. Debt-to-Asset Ratio
            const debtRatio = assets > 0 ? (liabilities / assets) * 100 : 0;
            document.getElementById('debtRatioValue').textContent = formatPercent(debtRatio);
            document.getElementById('debtRatioValue').className = 'kpi-value ' + (debtRatio < 50 ? 'text-success' : 'text-danger');

            lucide.createIcons(); // Re-render icons for dynamic indicators
        }
        
        // --- Chart Functions ---
        function updateCharts() {
            // Data for Net Worth Trend Chart
            const netWorthHistory = calculateNetWorthOverTime();
            
            if (netWorthChartInstance) {
                netWorthChartInstance.data.labels = netWorthHistory.labels;
                netWorthChartInstance.data.datasets[0].data = netWorthHistory.data;
                netWorthChartInstance.update();
            } else {
                renderNetWorthChart(netWorthHistory);
            }

            // Data for Cash Flow Breakdown Chart (Last 30 days)
            const cashFlowData = calculateCashFlowBreakdown();
            
            if (cashFlowChartInstance) {
                cashFlowChartInstance.data.labels = cashFlowData.labels;
                cashFlowChartInstance.data.datasets[0].data = cashFlowData.incomeData;
                cashFlowChartInstance.data.datasets[1].data = cashFlowData.expenseData;
                cashFlowChartInstance.update();
            } else {
                renderCashFlowChart(cashFlowData);
            }
        }
        
        function calculateNetWorthOverTime() {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            let runningNetWorth = 0;
            const history = {}; // { YYYY-MM: netWorth }

            sortedTransactions.forEach(t => {
                runningNetWorth += t.amount;
                const dateKey = new Date(t.date).toISOString().substring(0, 7); // YYYY-MM
                history[dateKey] = runningNetWorth;
            });
            
            const labels = Object.keys(history).sort().slice(-6);
            const data = labels.map(label => history[label]);
            
            return { labels, data };
        }
        
        function calculateCashFlowBreakdown() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentTransactions = transactions.filter(t => new Date(t.date) > thirtyDaysAgo);

            const categoriesMap = {}; // { category: { income: N, expense: N } }
            
            recentTransactions.forEach(t => {
                if (!categoriesMap[t.category]) {
                    categoriesMap[t.category] = { income: 0, expense: 0 };
                }
                if (t.type === 'Income') {
                    categoriesMap[t.category].income += t.amount;
                } else if (t.type === 'Expense') {
                    categoriesMap[t.category].expense += Math.abs(t.amount); // use absolute value
                }
            });
            
            const labels = Object.keys(categoriesMap);
            const incomeData = labels.map(cat => categoriesMap[cat].income);
            const expenseData = labels.map(cat => categoriesMap[cat].expense);
            
            return { labels, incomeData, expenseData };
        }

        function renderNetWorthChart(data) {
            const ctx = document.getElementById('netWorthChart').getContext('2d');
            netWorthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Net Worth',
                        data: data.data,
                        borderColor: varColor('primary-color'),
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        tension: 0.3,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: varColor('border') } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
        
        function renderCashFlowChart(data) {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            cashFlowChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: data.incomeData,
                            backgroundColor: varColor('success'),
                        },
                        {
                            label: 'Expense',
                            data: data.expenseData,
                            backgroundColor: varColor('danger'),
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, grid: { color: varColor('border') } }
                    }
                }
            });
        }
        
        function varColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(`--${name}`).trim();
        }

        // --- Calculator Logic ---
        let currentInput = '0';
        let previousValue = null;
        let operator = null;
        let shouldResetDisplay = true;

        const display = () => document.getElementById('calc-display');

        window.calcClear = function() {
            currentInput = '0';
            previousValue = null;
            operator = null;
            shouldResetDisplay = true;
            display().textContent = currentInput;
        }

        window.calcInput = function(value) {
            if (shouldResetDisplay) {
                currentInput = (value === '.') ? '0.' : value;
                shouldResetDisplay = false;
            } else if (value === '.') {
                if (!currentInput.includes('.')) {
                    currentInput += '.';
                }
            } else {
                currentInput = currentInput === '0' ? value : currentInput + value;
            }
            display().textContent = currentInput.slice(0, 15); // limit display length
            
            if (['+', '-', '*', '/'].includes(value)) {
                operator = value;
                previousValue = parseFloat(currentInput);
                shouldResetDisplay = true;
            }
        }

        window.calcCalculate = function() {
            if (operator === null || previousValue === null) return;

            const currentValue = parseFloat(currentInput);
            let result = 0;

            switch (operator) {
                case '+':
                    result = previousValue + currentValue;
                    break;
                case '-':
                    result = previousValue - currentValue;
                    break;
                case '*':
                    result = previousValue * currentValue;
                    break;
                case '/':
                    result = previousValue / currentValue;
                    break;
            }
            
            // Limit to 4 decimal places for currency focus
            currentInput = parseFloat(result.toFixed(4)).toString(); 
            previousValue = null;
            operator = null;
            shouldResetDisplay = true;
            display().textContent = currentInput;
        }


        // --- Initialize ---
        window.onload = function() {
            initializeFirebase();
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
            // Initial render of icons
            lucide.createIcons();
        }

    </script>
</body>
</html>
              
