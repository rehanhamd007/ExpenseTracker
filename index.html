<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MoneyMirror — v5.0.8 (Final Stable)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;
      --ticker-bg: #0b1220;
      --ticker-text: #e6eef8;
      --ticker-accent: #60a5fa;
      --kpi-elev-shadow: 0 12px 24px rgba(2, 6, 23, 0.16), 0 6px 12px rgba(2, 6, 23, 0.08);
      --kpi-inner-shadow: inset 0 1px 0 rgba(255,255,255,0.85);
      --kpi-border: rgba(148, 163, 184, 0.45);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* LAYOUT */
    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px; color: white; flex-shrink: 0; transition: all 0.3s; z-index: 100; }
    main { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px); transition: filter 0.3s; }

    /* BRAND & NAV */
    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px; }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px; }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active); }
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px; }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block; }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none; }
    aside.mobile-open .icon-close { display: block; }

    /* AUTH GATE */
    #authGate {
      position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
      gap: 10px; color: white; text-align: center; padding: 0 24px;
    }
    #authGate .line { margin: 0; }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px; font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px; }

    /* UI ELEMENTS */
    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2; }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4; }

    /* Base card */
    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; flex-wrap: wrap; gap: 10px; }
    .card-body { padding: 0 20px 20px 20px; flex: 1; }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); white-space: nowrap; }

    /* KPI cards — 3D styling */
    .kpi-card {
      padding: 20px;
      border: 1px solid var(--kpi-border);
      box-shadow: var(--kpi-elev-shadow);
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      position: relative;
      isolation: isolate;
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      box-shadow: var(--kpi-inner-shadow);
      pointer-events: none;
    }
    .kpi-income { border-left: 6px solid var(--success); }
    .kpi-expense { border-left: 6px solid var(--danger); }
    .kpi-cc { border-left: 6px solid var(--warning); }
    .kpi-net { border-left: 6px solid var(--primary); }
    .kpi-invest { border-left: 6px solid #075985; }

    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600; }

    label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; font-size: 11px; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; white-space: nowrap; }
    .badge-income { background: #dcfce7; color: #166534; }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985; }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance); }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .full-width { width: 100%; }
    .hidden { display: none !important; }

    /* Market controls and ticker */
    .market-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
    }
    .market-selects {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .market-selects select {
      min-width: 160px;
      max-width: 260px;
      background: white;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      font-weight: 600;
    }
    .ticker-panel {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    .market-ticker-strip {
      background: linear-gradient(90deg, var(--ticker-bg), #071022);
      color: var(--ticker-text);
      padding: 8px 12px;
      margin-bottom: 0;
      box-shadow: 0 6px 18px rgba(2,6,23,0.18);
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ticker-clock {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      min-width:120px;
      color:var(--ticker-text);
      font-size:12px;
      line-height:1;
      gap:4px;
    }
    .ticker-clock .time {
      font-weight:700;
      font-size:14px;
      color:#ffffff;
    }
    .ticker-clock .tz {
      color:var(--ticker-accent);
      font-weight:600;
      font-size:11px;
    }
    .ticker-wrap {
      display: flex;
      width: max-content;
      animation: marquee 28s linear infinite;
      padding-left: 8px;
      gap: 8px;
      align-items:center;
    }
    .ticker-item {
      display: inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 12px;
      white-space: nowrap;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
    }
    .ticker-item .symbol { font-weight:800; color:var(--ticker-accent); }
    .ticker-item .price { color:#e6eef8; font-weight:700; }
    .ticker-item .change-up { color: #10b981; font-weight:700; }
    .ticker-item .change-down { color: #ef4444; font-weight:700; }

    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } /* duplicated content will create seamless loop */
    }

    /* small helper for mobile compact selects */
    .market-controls .compact { min-width: 120px; }

    /* MEDIA QUERIES */
    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .col-span-1 { grid-column: span 1; }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2; }
    }

    @media(max-width: 768px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 500; height: 60px; }
      aside .brand { margin-bottom: 0; }
      aside nav, .sidebar-footer { display: none; }
      #mobileMenuBtn { display: block; }
      aside.mobile-open nav { display: block; position: absolute; top: 60px; left: 0; right: 0; background: var(--sidebar-bg); padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 501; height: calc(100vh - 60px); overflow-y: auto; }
      aside.mobile-open .sidebar-footer { display: block; position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 501; }
      main { padding: 15px; gap: 15px; }
      .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer { width: 100% !important; min-width: 100%; }
      .action-body { gap: 12px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr; }
      #invQuickSubs { grid-template-columns: 1fr !important; }
      .card-header { align-items: flex-start; }
      #calculator { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; bottom: auto; right: auto; }
      .analytics-filter-grid { grid-template-columns: 1fr; gap: 10px; }
      .flex-row input, .flex-row select, .flex-row button { flex-grow: 1; width: 100%; max-width: none !important; }
      .modal-content { width: 100%; height: 100%; border-radius: 0; max-width: none; }
      .modal-small { height: auto; min-height: 50vh; border-radius: 12px; }
      .market-selects select { min-width: 120px; }
      .ticker-clock { min-width: 100px; align-items:flex-start; }
    }
  </style>
</head>

<body>

<div id="authGate">
  <p class="line line-1">Welcome to</p>
  <p class="line line-2">MoneyMirror — Personal Finance Dashboard</p>
  <p class="line line-3">by Rehan Hamdulay</p>
  <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
  <button id="guestBtn" class="btn-outline" style="padding:12px 24px; font-size:14px; background:transparent; color:white; border-color:white; margin-top:10px;">Continue as Guest (Offline)</button>
</div>

<aside id="mainSidebar">
  <div style="width:100%">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
        MoneyMirror <span>v5.0.8</span>
      </div>
      <button id="mobileMenuBtn">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <nav>
      <div class="nav-group">
        <div class="nav-label">Main menu</div>
        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" id="navAnalytics">Advanced analytics</div>

        <!-- Market Ticker trigger -->
        <a href="#marketSettingsModal" class="nav-item openModal" data-modal-id="marketSettingsModal" style="text-decoration:none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"></path><path d="M19 9l-5 5-4-4-3 3"></path></svg>
          <span>Market ticker</span>
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-label">Configuration</div>
        <div class="nav-item" id="navSettings">Settings & Backup</div>
        <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
      </div>
    </nav>
  </div>

  <div class="sidebar-footer">
    <div class="sys-stat">
      <span>Current profile</span>
      <span class="sys-val" id="profileNameDisplay">--</span>
    </div>
    <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.8 • Settings & Table Fixed</div>
  </div>
</aside>

<main>
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
      <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
    </div>

    <!-- Market controls (major markets, metal selector, country selector) -->
    <div class="market-controls" style="align-items:center;">
      <div class="market-selects" role="group" aria-label="Market selectors">
        <!-- Major world markets dropdown -->
        <div>
          <label for="marketSelectMajor" style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:700;">Major markets</label>
          <select id="marketSelectMajor" title="Select major market">
            <option value="NSEI">Nifty 50 (NSEI)</option>
            <option value="SENSEX">Sensex (BSE)</option>
            <option value="NASDAQ">NASDAQ Composite</option>
            <option value="DOWJ">Dow Jones</option>
            <option value="SPX">S&P 500</option>
            <option value="FTSE">FTSE 100</option>
            <option value="DAX">DAX</option>
            <option value="NIKKEI">Nikkei 225</option>
            <option value="HANGSENG">Hang Seng</option>
          </select>
        </div>

        <!-- Metal selector (Gold / Silver) -->
        <div>
          <label for="metalSelect" style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:700;">Metal</label>
          <select id="metalSelect" title="Select metal to track">
            <option value="XAU">Gold (XAU)</option>
            <option value="XAG">Silver (XAG)</option>
          </select>
        </div>

        <!-- Country / currency selector for metal pricing -->
        <div>
          <label for="metalCountrySelect" style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:700;">Country / Currency</label>
          <select id="metalCountrySelect" title="Select country/currency for metal price">
            <option value="INR">India (INR)</option>
            <option value="USD">United States (USD)</option>
            <option value="EUR">Eurozone (EUR)</option>
            <option value="GBP">United Kingdom (GBP)</option>
            <option value="AED">UAE (AED)</option>
            <option value="SGD">Singapore (SGD)</option>
            <option value="AUD">Australia (AUD)</option>
          </select>
        </div>
      </div>

      <!-- Action buttons -->
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="applyMarketFilters" class="btn-primary" style="padding:8px 12px; font-size:13px;">Apply</button>
        <button id="openMarketSettings" class="btn-outline openModal" data-modal-id="marketSettingsModal" style="padding:8px 12px; font-size:13px;">Configure</button>
      </div>
    </div>
  </div>

  <!-- Ticker panel: clock + revolving ticker -->
  <div class="market-ticker-strip" style="margin-top:8px;">
    <!-- Clock / snapshot timestamp -->
    <div class="ticker-clock" aria-live="polite" style="margin-right:12px;">
      <div class="time" id="tickerClockTime">--:--:--</div>
      <div class="tz" id="tickerClockTZ">Snapshot: --</div>
    </div>

    <!-- Scrolling ticker content -->
    <div id="tickerWrap" class="ticker-wrap" aria-hidden="false" role="list">
      <!-- JS will populate .ticker-item elements here; duplicated by script for seamless loop -->
    </div>
  </div>

  <!-- KPI cards and rest of dashboard follow (unchanged structure, integrated with ticker) -->
  <div class="dashboard-grid">
    <div class="card kpi-card kpi-income col-span-1">
      <div class="card-title" style="color:var(--success)">Monthly income</div>
      <div class="kpi-value" id="kpiIncome">₹0</div>
      <div class="kpi-sub" id="momIncome"></div>
    </div>
    <div class="card kpi-card kpi-expense col-span-1">
      <div class="card-title" style="color:var(--danger)">Monthly expenses</div>
      <div class="kpi-value" id="kpiExpense">₹0</div>
      <div class="kpi-sub" id="momExpense"></div>
    </div>
    <div class="card kpi-card kpi-cc col-span-1" id="ccCard" style="background:linear-gradient(180deg,#fff7ed 0%,#fffbeb 100%);">
      <div class="card-title" id="ccTitle" style="color:var(--warning)">Credit card due</div>
      <div class="kpi-value" id="kpiCCDue">₹0</div>
      <div class="kpi-sub" style="color:#000; font-weight:700; margin-top: 6px; position:relative;">
        <span id="ccPaymentDate">Next: 10th Dec</span>
        <span style="font-weight:700; margin-left:10px;">Limit: <span id="ccLimitDisplay">₹2L</span></span>
        <div id="ccAlert" class="hidden" style="position:absolute; right:0; top:0; color:var(--danger)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        </div>
      </div>
    </div>

    <div class="card kpi-card kpi-net col-span-1">
      <div class="card-title" style="color:var(--primary)">Net liquidity</div>
      <div class="kpi-value" id="kpiNet">₹0</div>
      <div class="kpi-sub">Total available cash</div>
      <div class="account-list" id="netLiquidityBreakdown"></div>
    </div>

    <div class="card kpi-card kpi-invest col-span-4" style="background:#e0f2fe; border-color:#075985;">
      <div class="card-header" style="padding:16px 20px 0 20px;">
        <div class="card-title" style="color:#075985">Total investment value</div>
        <div style="display:flex;gap:8px;align-items:center; flex-wrap:wrap;">
          <button id="toggleInvBreakdown" class="btn-outline" style="padding:6px 10px; font-size:12px;">View breakdown</button>
          <button id="viewCategoriesBtn" class="btn-outline" style="padding:6px 10px; font-size:12px;">View subcategories</button>
        </div>
      </div>
      <div class="card-body" style="padding-top:6px;">
        <div class="kpi-value" id="kpiInvest">₹0</div>
        <div class="kpi-sub" id="momInvest" style="color:#075985">Historical cost total</div>

        <div id="invBreakdownPanel" class="hidden" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
          <div class="card" style="border-color:#93c5fd; margin-bottom:12px;">
            <div class="card-header">
              <div class="card-title">Filters</div>
              <div class="flex-row" style="gap:10px; width:100%;">
                <div class="input-group-med">
                  <label>Major bucket</label>
                  <select id="invBucketFilter"></select>
                </div>
                <div class="input-group-med">
                  <label>View mode</label>
                  <select id="invViewMode">
                    <option value="top4">Top 4 buckets</option>
                    <option value="subcats">Subcategories</option>
                  </select>
                </div>
                <div class="input-group-med">
                  <label>Date range</label>
                  <select id="invDateRange">
                    <option value="6">Last 6 months</option>
                    <option value="12">Last 12 months</option>
                    <option value="all">All time</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="kpi-breakdown-grid">
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invBarTitle">Major buckets</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownBar"></canvas>
              </div>
            </div>
            <div class="card" style="border-color:#93c5fd;">
              <div class="card-header"><div class="card-title" id="invPieTitle">Share</div></div>
              <div class="card-body" style="height:300px;">
                <canvas id="invBreakdownPie"></canvas>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="card-title" style="font-size:13px; color:#075985; margin-bottom:10px;">Bucket subcategories quick view</div>
            <div id="invQuickSubs" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- The rest of the dashboard (charts, add-entry form, recent transactions, modals) continues in Part 2 -->
</main>

<!-- Market Ticker Configuration Modal (extended) -->
<div id="marketSettingsModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="action-header" style="border-radius:12px 12px 0 0; align-items:center;">
      <div class="card-title" style="color:white">Market Ticker Configuration</div>
      <button class="btn-outline closeModal" data-modal-id="marketSettingsModal" style="background:transparent; color:white; border-color:white; padding:6px 10px">Close</button>
    </div>

    <div class="modal-pad">
      <p style="font-size:13px; color:var(--text-muted); margin-top:0;">
        Choose which major markets to show, and configure gold/silver pricing by country/currency. For live prices, integrate an API key into <code>fetchMarketData</code>.
      </p>

      <!-- Tracked major markets list -->
      <div style="margin-bottom:14px;">
        <label style="font-weight:700; font-size:12px; color:var(--text-muted);">Tracked major markets</label>
        <ul id="trackedMajorMarkets" style="list-style:none; padding-left:0; margin-top:8px; display:flex; flex-direction:column; gap:8px;"></ul>
      </div>

      <!-- Tracked metals configuration -->
      <div style="margin-bottom:14px;">
        <label style="font-weight:700; font-size:12px; color:var(--text-muted);">Tracked metals</label>
        <div id="trackedMetals" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
      </div>

      <!-- Add / edit controls -->
      <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:12px;">
        <div style="flex:1; min-width:180px;">
          <label style="font-size:11px; color:var(--text-muted); font-weight:700;">Add major market (symbol)</label>
          <input id="newMajorSymbol" placeholder="e.g., NASDAQ, SENSEX" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label style="font-size:11px; color:var(--text-muted); font-weight:700;">Display name</label>
          <input id="newMajorName" placeholder="e.g., Nasdaq Composite" />
        </div>
        <div style="min-width:120px;">
          <button id="addMajorBtn" class="btn-primary" style="width:100%;">Add</button>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid var(--border); margin:12px 0;" />

      <!-- Metal / country quick add -->
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="min-width:140px;">
          <label style="font-size:11px; color:var(--text-muted); font-weight:700;">Metal</label>
          <select id="modalMetalSelect">
            <option value="XAU">Gold (XAU)</option>
            <option value="XAG">Silver (XAG)</option>
          </select>
        </div>
        <div style="min-width:160px;">
          <label style="font-size:11px; color:var(--text-muted); font-weight:700;">Country / Currency</label>
          <select id="modalMetalCountry">
            <option value="INR">India (INR)</option>
            <option value="USD">United States (USD)</option>
            <option value="EUR">Eurozone (EUR)</option>
            <option value="GBP">United Kingdom (GBP)</option>
            <option value="AED">UAE (AED)</option>
            <option value="SGD">Singapore (SGD)</option>
            <option value="AUD">Australia (AUD)</option>
          </select>
        </div>
        <div style="min-width:120px;">
          <button id="addMetalBtn" class="btn-primary" style="width:100%;">Add metal</button>
        </div>
      </div>

      <div style="margin-top:18px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="saveTickerConfig" class="btn-primary">Save</button>
        <button class="btn-outline closeModal" data-modal-id="marketSettingsModal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Calculator and other modals will be included in Part 2 along with the full script body -->
<!-- Begin initial scripts (Part 2 will continue with the rest of the JS and final integration) -->
<script>
  // Firebase Config (unchanged)
  const firebaseConfig = {
    apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
    authDomain: "moneymirror-22543.firebaseapp.com",
    projectId: "moneymirror-22543",
    storageBucket: "moneymirror-22543.firebasestorage.app",
    messagingSenderId: "61775081584",
    appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
    measurementId: "G-8RPXH1VEFG"
  };

  let db = null;
  let auth = null;
  let USE_FIRESTORE = false;
  const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';
  let currentProfile = null;

  try {
    if (typeof firebase !== 'undefined') {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
      console.log("Firebase initialized.");
    } else {
      console.warn("Firebase SDK not loaded.");
    }
  } catch (e) {
    console.warn("Firebase init failed, falling back to LocalStorage:", e);
  }

  async function signInWithGoogle() {
    if (!auth) return alert('Auth not initialized. Check internet or use Guest Mode.');
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      onUserSignedIn(user);
    } catch (err) {
      console.error("Login failed:", err);
      alert('Sign-in failed. If using a local file, try Guest Mode.');
    }
  }

  function startGuestMode() {
      currentProfile = 'Guest';
      document.getElementById('profileNameDisplay').textContent = 'Guest (Offline)';
      document.getElementById('authGate').style.display = 'none';
      document.querySelector('main').style.filter = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      loadProfileData();
  }

  function onUserSignedIn(user) {
    currentProfile = user.displayName || user.email || 'User';
    localStorage.setItem('mm_last_profile', currentProfile);
    document.getElementById('profileNameDisplay').textContent = currentProfile;
    document.getElementById('authGate').style.display = 'none';
    document.querySelector('main').style.filter = 'none';
    document.getElementById('logoutBtn').style.display = 'block';
    loadProfileData();
  }

  function signOutUser() {
    if (auth) {
      auth.signOut().then(() => {
          resetToAuthGate();
      });
    } else {
        resetToAuthGate();
    }
  }

  function resetToAuthGate() {
      currentProfile = null;
      document.getElementById('profileNameDisplay').textContent = '--';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('authGate').style.display = 'flex';
      document.querySelector('main').style.filter = 'blur(5px)';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const d = new Date();
    const currentDateEl = document.getElementById('currentDate');
    if (currentDateEl) currentDateEl.innerText = d.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const today = new Date().toISOString().slice(0,10);
    const dateEl = document.getElementById('date');
    if (dateEl) dateEl.value = today;
    // dragElement will be defined in Part 2
    try { dragElement(document.getElementById("calculator")); } catch(e){}

    const mobileBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('mainSidebar');
    if (mobileBtn && sidebar) {
      mobileBtn.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => sidebar.classList.remove('mobile-open'));
      });
    }

    document.getElementById('navSettings')?.addEventListener('click', () => {
        document.getElementById('settingsModal')?.classList.add('open');
    });
    document.getElementById('closeSettings')?.addEventListener('click', () => {
        document.getElementById('settingsModal')?.classList.remove('open');
    });
    document.getElementById('navAnalytics')?.addEventListener('click', () => {
        document.getElementById('analyticsModal')?.classList.add('open');
        try { populateAnalyticsDropdowns(); renderAdvancedCharts(); } catch(e){}
    });
    document.getElementById('closeAnalytics')?.addEventListener('click', () => {
        document.getElementById('analyticsModal')?.classList.remove('open');
    });
    document.getElementById('importDataBtn')?.addEventListener('click', () => {
        document.getElementById('importModal')?.classList.add('open');
    });
    document.getElementById('closeImport')?.addEventListener('click', () => {
        document.getElementById('importModal')?.classList.remove('open');
    });
    document.getElementById('calc-toggle')?.addEventListener('click', () => {
        const calc = document.getElementById('calculator');
        if (calc) calc.style.display = calc.style.display === 'none' ? 'flex' : 'none';
    });
    document.getElementById('calc-close-btn')?.addEventListener('click', (e) => {
        const calc = document.getElementById('calculator');
        if (calc) calc.style.display = 'none';
        e.stopPropagation();
    });
    document.getElementById('sampleBtn')?.addEventListener('click', loadSampleData);
    document.getElementById('exportBtn')?.addEventListener('click', () => convertToCSV(data));
    document.getElementById('processImportBtn')?.addEventListener('click', processImportedData);
    document.getElementById('resetBtn')?.addEventListener('click', () => {
        if (confirm('WARNING: This will erase ALL your data (local and Firestore). Are you absolutely sure?')) {
            localStorage.clear();
            data = [];
            methodNames = {...CANONICAL_METHODS};
            incomeSources = ['Salary', 'Freelance', 'Interest'];
            settings = { ccLimit: DEFAULT_CC_LIMIT, trackedMarkets: settings?.trackedMarkets || [] };
            saveAll();
            window.location.reload();
        }
    });

    // Open any generic modal by data-modal-id (includes marketSettingsModal)
    document.querySelectorAll('.openModal').forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const modalId = e.currentTarget.dataset.modalId;
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add('open');
          if (modalId === 'marketSettingsModal') {
            try { renderTrackedLists(); } catch(e){}
          }
        }
      });
    });
    document.querySelectorAll('.closeModal').forEach(button => {
      button.addEventListener('click', (e) => {
        const modalId = e.currentTarget.dataset.modalId;
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('open');
      });
    });

    if (auth) {
      auth.onAuthStateChanged(user => {
        if (user) onUserSignedIn(user);
        else {
          resetToAuthGate();
        }
      });
    }

    // Attach listener for the Add Market form (modal)
    const addMarketForm = document.getElementById('addMarketForm');
    if (addMarketForm) addMarketForm.addEventListener('submit', addMarket);

    // Header apply button for ticker
    document.getElementById('applyMarketFilters')?.addEventListener('click', () => {
      try { applyMarketFiltersFromControls(); } catch(e){ console.warn(e); }
    });

    // Initialize ticker controls population (functions defined in Part 2/3)
    try { renderTrackedLists(); populateHeaderSelectsFromSettings(); } catch(e){}

    // Initial app render (renderAll defined in Part 2)
    try { renderAll(); } catch(e) { console.warn('renderAll not ready yet'); }
  });
</script>

<body>

  <!-- AUTH GATE -->
  <div id="authGate">
    <p class="line line-1">Welcome to</p>
    <p class="line line-2">MoneyMirror — Personal Finance Dashboard</p>
    <p class="line line-3">by Rehan Hamdulay</p>
    <button id="loginBtn" class="btn-primary" style="padding:12px 24px; font-size:16px;">Sign in with Google</button>
    <button id="guestBtn" class="btn-outline" style="padding:12px 24px; font-size:14px; background:transparent; color:white; border-color:white; margin-top:10px;">Continue as Guest (Offline)</button>
  </div>

  <!-- SIDEBAR -->
  <aside id="mainSidebar">
    <div style="width:100%">
      <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
        <div class="brand">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>
          MoneyMirror <span>v5.0.8</span>
        </div>
        <button id="mobileMenuBtn">
          <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
          <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>

      <nav>
        <div class="nav-group">
          <div class="nav-label">Main menu</div>
          <div class="nav-item active">Dashboard</div>
          <div class="nav-item" id="navAnalytics">Advanced analytics</div>

          <!-- Market Ticker trigger -->
          <a href="#marketSettingsModal" class="nav-item openModal" data-modal-id="marketSettingsModal" style="text-decoration:none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"></path><path d="M19 9l-5 5-4-4-3 3"></path></svg>
            <span>Market ticker</span>
          </a>
        </div>

        <div class="nav-group">
          <div class="nav-label">Configuration</div>
          <div class="nav-item" id="navSettings">Settings & Backup</div>
          <div class="nav-item"><button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">Logout</button></div>
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      <div class="sys-stat">
        <span>Current profile</span>
        <span class="sys-val" id="profileNameDisplay">--</span>
      </div>
      <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.8 • Settings & Table Fixed</div>
    </div>
  </aside>

  <!-- MAIN: header, market controls, and ticker -->
  <main>
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <div>
        <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
        <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
      </div>

      <!-- Market controls (major markets, metal selector, country selector) -->
      <div class="market-controls" style="align-items:center;">
        <div class="market-selects" role="group" aria-label="Market selectors">
          <!-- Major world markets dropdown -->
          <div>
            <label for="marketSelectMajor" style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:700;">Major markets</label>
            <select id="marketSelectMajor" title="Select major market">
              <option value="NSEI">Nifty 50 (NSEI)</option>
              <option value="SENSEX">Sensex (BSE)</option>
              <option value="NASDAQ">NASDAQ Composite</option>
              <option value="DOWJ">Dow Jones</option>
              <option value="SPX">S&P 500</option>
              <option value="FTSE">FTSE 100</option>
              <option value="DAX">DAX</option>
              <option value="NIKKEI">Nikkei 225</option>
              <option value="HANGSENG">Hang Seng</option>
            </select>
          </div>

          <!-- Metal selector (Gold / Silver) -->
          <div>
            <label for="metalSelect" style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:700;">Metal</label>
            <select id="metalSelect" title="Select metal to track">
              <option value="XAU">Gold (XAU)</option>
              <option value="XAG">Silver (XAG)</option>
            </select>
          </div>

          <!-- Country / currency selector for metal pricing -->
          <div>
            <label for="metalCountrySelect" style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:700;">Country / Currency</label>
            <select id="metalCountrySelect" title="Select country/currency for metal price">
              <option value="INR">India (INR)</option>
              <option value="USD">United States (USD)</option>
              <option value="EUR">Eurozone (EUR)</option>
              <option value="GBP">United Kingdom (GBP)</option>
              <option value="AED">UAE (AED)</option>
              <option value="SGD">Singapore (SGD)</option>
              <option value="AUD">Australia (AUD)</option>
            </select>
          </div>
        </div>

        <!-- Action buttons -->
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="applyMarketFilters" class="btn-primary" style="padding:8px 12px; font-size:13px;">Apply</button>
          <button id="openMarketSettings" class="btn-outline openModal" data-modal-id="marketSettingsModal" style="padding:8px 12px; font-size:13px;">Configure</button>
        </div>
      </div>
    </div>

    <!-- Ticker panel: clock + revolving ticker -->
    <div class="market-ticker-strip" style="margin-top:8px;">
      <!-- Clock / snapshot timestamp -->
      <div class="ticker-clock" aria-live="polite" style="margin-right:12px;">
        <div class="time" id="tickerClockTime">--:--:--</div>
        <div class="tz" id="tickerClockTZ">Snapshot: --</div>
      </div>

      <!-- Scrolling ticker content -->
      <div id="tickerWrap" class="ticker-wrap" aria-hidden="false" role="list">
        <!-- JS will populate .ticker-item elements here; duplicated by script for seamless loop -->
      </div>
    </div>
  <!-- ADD / ENTRY CARD -->
  <div class="dashboard-grid">
    <div class="card action-card col-span-4" id="addEntryCard">
      <div class="action-header">
        <div class="card-title">Add new entry</div>
      </div>
      <div class="action-body">
        <div class="input-group-small">
          <label>Type</label>
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="opening_balance">Opening Balance</option>
          </select>
        </div>
        <div class="input-group-small">
          <label>Amount (₹)</label>
          <input id="amount" type="number" placeholder="0.00" style="font-weight:700; font-size:16px" step="any" />
        </div>
        <div class="input-group-small">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div class="input-group-large">
          <label>Description</label>
          <input id="desc" placeholder="What is this for?" />
        </div>

        <div id="dynamicFieldsContainer" class="full-width" style="border-top:1px solid var(--border); padding-top:15px">
          <div id="regularFields" style="display:flex; gap:20px; flex-wrap:wrap">
            <div id="categoryContainer" class="input-group-small">
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div class="input-group-small">
              <label>Method</label>
              <select id="method"></select>
            </div>
            <div id="incomeSourceRow" class="hidden input-group-small">
              <label>Source</label>
              <select id="incomeSource"></select>
            </div>

            <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="input-group-small">
                <label>Investment category</label>
                <select id="invGroup"></select>
              </div>
              <div class="input-group-small">
                <label>Investment sub-type</label>
                <select id="invSub"></select>
              </div>
            </div>

            <div id="insuranceRow" class="hidden input-group-med">
              <label>Insurance details</label>
              <div class="flex-row">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>

          <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-small">
              <label>Asset type</label>
              <select id="openingType">
                <option value="Cash">Cash (Liquid)</option>
                <option value="Investment">Investment Asset</option>
              </select>
            </div>
            <div class="input-group-small hidden" id="openingGroupContainer">
              <label id="openingGroupLabel">Asset category</label>
              <select id="openingGroup"></select>
            </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:12px;">
          <button id="saveEntryBtn" class="btn-primary">Save entry</button>
          <button id="clearEntryBtn" class="btn-outline">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RECENT TRANSACTIONS TABLE -->
  <div class="dashboard-grid">
    <div class="card col-span-4">
      <div class="card-header">
        <div class="card-title">Recent transactions</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="recentSearch" placeholder="Search" style="padding:8px; min-width:180px;" />
          <select id="recentSort" style="padding:8px;">
            <option value="dateDesc">Newest</option>
            <option value="dateAsc">Oldest</option>
            <option value="amtDesc">Amount (High)</option>
            <option value="amtAsc">Amount (Low)</option>
          </select>
          <select id="recentCategory" style="padding:8px;">
            <option value="">All categories</option>
          </select>
          <select id="entryLimit" style="padding:8px;">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table id="recentTable">
            <thead>
              <tr>
                <th>Type</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Category</th>
                <th>Method</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- IMPORT / EXPORT / SETTINGS MODALS -->
  <div id="importModal" class="modal">
    <div class="modal-content modal-small">
      <div class="card-header" style="background:#fff;">
        <div class="card-title">Import data (CSV)</div>
        <button id="closeImport" class="close-button">&times;</button>
      </div>
      <div class="modal-pad">
        <p style="color:var(--text-muted);">Upload a CSV with headers like: type,amount,date,desc,category,method</p>
        <input type="file" id="importFile" accept=".csv" />
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="processImportBtn" class="btn-primary">Process</button>
          <button id="closeImportBtn" class="btn-outline closeModal" data-modal-id="importModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL (placeholder, other settings exist in main app) -->
  <div id="settingsModal" class="modal">
    <div class="modal-content modal-small">
      <div class="card-header">
        <div class="card-title">Settings</div>
        <button id="closeSettings" class="close-button">&times;</button>
      </div>
      <div class="modal-pad">
        <p style="color:var(--text-muted);">General settings and backup options.</p>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="resetBtn" class="btn-danger">Reset all data</button>
          <button id="closeSettingsBtn" class="btn-outline closeModal" data-modal-id="settingsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CALCULATOR (draggable) -->
  <div id="calculator" style="display:none;">
    <div id="calc-header">Calculator <button id="calc-close-btn" style="background:transparent; border:none; color:#ff6b6b; font-weight:700;">×</button></div>
    <div id="calc-display">0</div>
    <div id="calc-preview">Enter an expression…</div>
    <div id="calc-buttons">
      <button class="calc-clear">AC</button>
      <button>±</button>
      <button>%</button>
      <button class="calc-operator">÷</button>

      <button>7</button>
      <button>8</button>
      <button>9</button>
      <button class="calc-operator">×</button>

      <button>4</button>
      <button>5</button>
      <button>6</button>
      <button class="calc-operator">−</button>

      <button>1</button>
      <button>2</button>
      <button>3</button>
      <button class="calc-operator">+</button>

      <button class="calc-zero">0</button>
      <button>.</button>
      <button class="calc-equals">=</button>
    </div>
  </div>

  <!-- END OF BODY CONTENT -->

  <!-- FULL SCRIPT: data model, helpers, renderers, ticker, integration -->
  <script>
  /*************************************************************************
   * MoneyMirror v5.0.8 — Remaining JS
   * This script contains:
   * - Data model and persistence
   * - CRUD for entries
   * - Import parsing
   * - Recent entries rendering
   * - Sample data loader
   * - Calculator handlers and draggable helper
   * - Market ticker functions (merged from Part 3)
   * - Integration glue (merged from Part 4)
   *************************************************************************/

  // ---------- Basic data model & defaults ----------
  let data = JSON.parse(localStorage.getItem('mm_data_v1') || '[]');
  let settings = JSON.parse(localStorage.getItem('mm_settings_v1') || '{}');
  settings.ccLimit = settings.ccLimit || 200000;
  settings.trackedMarkets = settings.trackedMarkets || [];
  let methodNames = {
    'cash': 'Cash',
    'salary_acct': 'Salary Account',
    'savings_acct': 'Savings Account',
    'digital_wallet': 'Digital Wallet',
    'credit_card': 'Credit Card',
    'credit_card_payment': 'Credit Card Payment'
  };
  const CANONICAL_METHODS = {...methodNames};
  let incomeSources = ['Salary (Primary)', 'Freelance Income', 'Investment Income'];

  // Utility: unique id
  function uid() {
    return 'id_' + Math.random().toString(36).slice(2, 9);
  }

  // Format currency (INR default)
  function fmt(n) {
    if (n === undefined || n === null) return '₹0';
    const num = Number(n);
    return '₹' + num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
  }

  // Save all to localStorage
  function saveAll() {
    localStorage.setItem('mm_data_v1', JSON.stringify(data));
    localStorage.setItem('mm_settings_v1', JSON.stringify(settings));
  }

  // ---------- CRUD: Add / Edit / Delete ----------
  function clearEntryForm() {
    document.getElementById('type').value = 'expense';
    document.getElementById('amount').value = '';
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
    document.getElementById('desc').value = '';
    document.getElementById('category').value = '';
    document.getElementById('method').value = '';
    document.getElementById('incomeSource').value = '';
    document.getElementById('openingType').value = 'Cash';
    document.getElementById('openingGroup') && (document.getElementById('openingGroup').value = '');
    toggleDynamicFields();
  }

  function saveEntry() {
    const type = document.getElementById('type').value;
    const amount = Number(document.getElementById('amount').value || 0);
    const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
    const desc = document.getElementById('desc').value || '';
    const category = document.getElementById('category').value || 'Misc';
    const method = document.getElementById('method').value || 'cash';
    const incomeSource = document.getElementById('incomeSource').value || '';
    const investmentGroup = document.getElementById('invGroup') ? document.getElementById('invGroup').value : '';
    const investmentSub = document.getElementById('invSub') ? document.getElementById('invSub').value : '';
    const insuranceType = document.getElementById('insType') ? document.getElementById('insType').value : '';
    const insuranceFor = document.getElementById('insFor') ? document.getElementById('insFor').value : '';
    const openingType = document.getElementById('openingType') ? document.getElementById('openingType').value : '';

    if (!amount || amount <= 0) return alert('Please enter a valid amount.');
    if (!desc) return alert('Please enter a description.');

    const entry = {
      id: uid(),
      type,
      amount,
      date,
      desc,
      category,
      method,
      incomeSource,
      investmentGroup,
      investmentSub,
      insuranceType,
      insuranceFor,
      openingType
    };
    data.push(entry);
    saveAll();
    renderAll();
    clearEntryForm();
  }

  function loadEdit(id) {
    const e = data.find(x => x.id === id);
    if (!e) return alert('Entry not found.');
    document.getElementById('type').value = e.type;
    document.getElementById('amount').value = e.amount;
    document.getElementById('date').value = e.date;
    document.getElementById('desc').value = e.desc;
    document.getElementById('category').value = e.category || '';
    document.getElementById('method').value = e.method || '';
    document.getElementById('incomeSource').value = e.incomeSource || '';
    document.getElementById('invGroup') && (document.getElementById('invGroup').value = e.investmentGroup || '');
    document.getElementById('invSub') && (document.getElementById('invSub').value = e.investmentSub || '');
    toggleDynamicFields();
    // For simplicity, editing will delete original and user can save new entry
    if (confirm('Load entry into form for editing? The original entry will be removed.')) {
      deleteEntry(id, false);
    }
  }

  function deleteEntry(id, confirmPrompt = true) {
    if (confirmPrompt && !confirm('Delete this entry?')) return;
    data = data.filter(x => x.id !== id);
    saveAll();
    renderAll();
  }

  // ---------- Import CSV ----------
  function processImportedData() {
    const fileInput = document.getElementById('importFile');
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) return alert('Please select a CSV file.');
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const importedData = parseCSV(text);
      if (!importedData || importedData.length === 0) return alert('No valid data found.');
      let newEntries = 0;
      importedData.forEach(item => {
          const entry = {
              id: uid(),
              type: item.type ? item.type.toLowerCase().trim() : 'expense',
              amount: Number(item.amount),
              date: item.date || new Date().toISOString().slice(0, 10),
              desc: item.desc || item.description || '',
              category: item.category || 'Misc',
              method: item.method ? item.method.toLowerCase().trim() : 'cash',
              incomeSource: item.income_source || item.incomeSource || '',
              investmentGroup: item.investment_group || item.investmentGroup || '',
              investmentSub: item.investment_sub || item.investmentSub || '',
              insuranceType: item.insurance_type || item.insuranceType || '',
              insuranceFor: item.insurance_for || item.insuranceFor || '',
          };
          if (entry.amount > 0 && entry.desc) {
              data.push(entry);
              newEntries++;
          }
      });
      saveAll();
      renderAll();
      document.getElementById('importModal').classList.remove('open');
      alert(`Successfully imported ${newEntries} new entries.`);
    };
    reader.readAsText(file);
  }

  function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return [];
      const headerLine = lines[0];
      const headers = headerLine.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h => h.replace(/"/g, '').toLowerCase().trim());
      const dataRows = [];
      for (let i = 1; i < lines.length; i++) {
          const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
          if (!values || values.length !== headers.length) continue;
          const entry = {};
          for (let j = 0; j < headers.length; j++) {
              let value = values[j] ? values[j].replace(/^"|"$/g, '').replace(/""/g, '"') : '';
              entry[headers[j]] = value;
          }
          dataRows.push(entry);
      }
      return dataRows;
  }

  // ---------- Helper badges ----------
  function getBadge(entry) {
    if (entry.type === 'income') return '<span class="badge badge-income">Income</span>';
    if (entry.type === 'opening_balance') return '<span class="badge badge-opening">Opening</span>';
    if (entry.category === 'Investments') return '<span class="badge badge-inv">Invest</span>';
    if (entry.category === 'Insurance') return '<span class="badge badge-ins">Insure</span>';
    if (entry.category === 'Credit Card Payment') return '<span class="badge badge-cc">CC Pay</span>';
    return '<span class="badge badge-expense">Expense</span>';
  }

  // ---------- Recent entries render ----------
  function renderRecentEntries() {
    try {
        const tbody = document.querySelector('#recentTable tbody');
        if (!tbody) return;

        const searchEl = document.getElementById('recentSearch');
        const sortEl = document.getElementById('recentSort');
        const catEl = document.getElementById('recentCategory');
        const limitEl = document.getElementById('entryLimit');

        const searchText = searchEl ? searchEl.value.toLowerCase() : '';
        const sortMode = sortEl ? sortEl.value : 'dateDesc';
        const categoryFilter = catEl ? catEl.value : '';
        const limit = limitEl && limitEl.value !== 'all' ? Number(limitEl.value) : data.length;

        let filtered = data.filter(e => {
            if (!e) return false;
            const desc = (e.desc || '').toLowerCase();
            const cat = (e.category || '').toLowerCase();
            const amt = String(e.amount || 0);

            const matchesSearch = desc.includes(searchText) || cat.includes(searchText) || amt.includes(searchText);
            const matchesCat = categoryFilter ? e.category === categoryFilter : true;

            return matchesSearch && matchesCat;
        });

        filtered.sort((a, b) => {
            const dateA = new Date(a.date || 0);
            const dateB = new Date(b.date || 0);
            if (sortMode === 'dateDesc') return dateB - dateA;
            if (sortMode === 'dateAsc') return dateA - dateB;
            if (sortMode === 'amtDesc') return b.amount - a.amount;
            if (sortMode === 'amtAsc') return a.amount - b.amount;
            return 0;
        });

        const slice = filtered.slice(0, limit);

        if (slice.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--text-muted);">No transactions found.</td></tr>';
            return;
        }

        tbody.innerHTML = slice.map(e => {
          const amountDisplay = e.type === 'income' || e.type === 'opening_balance'
            ? `<span style="color:var(--success)">+${fmt(e.amount)}</span>`
            : `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;

          let methodDisplay = '';
          if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
              methodDisplay = e.investmentSub || e.investmentGroup;
          } else if (e.type === 'expense' && e.category === 'Investments') {
              methodDisplay = e.investmentSub || e.investmentGroup;
          } else if (e.method === 'credit_card_payment') {
              methodDisplay = 'N/A (Transfer)';
          } else {
              methodDisplay = methodNames[e.method] || e.method || '--';
          }

          let categoryDisplay = e.category === 'Investments' ? e.investmentSub :
                                e.category === 'Insurance' ? `${e.insuranceType} (${e.insuranceFor})` :
                                e.type === 'expense' ? e.category : '--';
          return `
            <tr>
              <td>${getBadge(e)}</td>
              <td>${e.date}</td>
              <td style="font-weight:600; text-align:right">${amountDisplay}</td>
              <td>${e.desc}</td>
              <td>${categoryDisplay}</td>
              <td>${methodDisplay}</td>
              <td class="flex-row">
                <button onclick="loadEdit('${e.id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:4px" title="Edit">✎</button>
                <button onclick="deleteEntry('${e.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:4px" title="Delete">×</button>
              </td>
            </tr>
          `;
        }).join('');
    } catch (err) {
        console.error("Error rendering table:", err);
    }
  }

  // ---------- Sample Data ----------
  function loadSampleData() {
      if (!confirm("Overwrite data with sample?")) return;
      function randBetween(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
      function pick(arr) { return arr[randBetween(0, arr.length - 1)]; }
      function dateInLastMonths(range) {
          const today = new Date();
          const startMonth = range[0];
          const endMonth = range.length > 1 ? range[1] : startMonth;
          const monthDiff = randBetween(startMonth, endMonth);
          const targetDate = new Date(today);
          targetDate.setMonth(today.getMonth() - monthDiff);
          const maxDays = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
          targetDate.setDate(randBetween(1, maxDays));
          return targetDate.toISOString().slice(0,10);
      }
      data = [];
      methodNames = {...CANONICAL_METHODS};
      incomeSources = ['Salary (Primary)', 'Freelance Income', 'Investment Income'];
      settings.ccLimit = 200000;
      settings.trackedMarkets = settings.trackedMarkets || [
        { symbol: 'SENSEX', name: 'Sensex', price: 72000.00, change: 0.85 },
        { symbol: 'NASDAQ', name: 'Nasdaq', price: 16000.00, change: -1.23 },
        { symbol: 'XAUUSD', name: 'Gold/USD', price: 2350.00, change: 0.15 },
        { symbol: 'XAGUSD', name: 'Silver/USD', price: 28.50, change: -0.55 },
        { symbol: 'BTCUSD', name: 'Bitcoin', price: 68000.00, change: 2.10 }
      ];

      // Opening cash balances
      data.push({id:uid(), type:'opening_balance', amount: 50000, date: dateInLastMonths([6,6]), desc:'Initial Salary Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Salary)', method:'salary_acct', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 20000, date: dateInLastMonths([5,6]), desc:'Initial Savings Account Balance', investmentGroup:'Cash', investmentSub:'Bank Account (Savings)', method:'savings_acct', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 5000, date: dateInLastMonths([5,6]), desc:'Initial Physical Cash', investmentGroup:'Cash', investmentSub:'Cash', method:'cash', category:'N/A'});
      // Opening investments
      data.push({id:uid(), type:'opening_balance', amount: 35000, date: dateInLastMonths([6,6]), desc:'Opening — Equity MF (Large Cap)', investmentGroup:'Mutual Funds', investmentSub:'Equity MF - Large Cap/Mid Cap/Small Cap', method:'', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 18000, date: dateInLastMonths([6,6]), desc:'Opening — NPS Tier 1', investmentGroup:'Retirement Funds', investmentSub:'NPS Tier 1/Tier 2', method:'', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 12000, date: dateInLastMonths([6,6]), desc:'Opening — Gold ETF', investmentGroup:'ETFs', investmentSub:'Gold ETF', method:'', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 25000, date: dateInLastMonths([6,6]), desc:'Opening — Corporate Bonds', investmentGroup:'Bonds & Debt Instruments', investmentSub:'Corporate Bonds', method:'', category:'N/A'});
      data.push({id:uid(), type:'opening_balance', amount: 8000, date: dateInLastMonths([6,6]), desc:'Opening — Bitcoin (BTC)', investmentGroup:'Crypto & Digital Assets', investmentSub:'Bitcoin (BTC)', method:'', category:'N/A'});

      // Monthly incomes
      for (let m = 6; m >= 0; m--) {
        const salaryDate = dateInLastMonths([m,m]);
        data.push({id:uid(), type:'income', amount: 120000, date: salaryDate, desc:`Salary credit (${salaryDate})`, category:'N/A', method:'salary_acct', incomeSource:'Salary (Primary)'});
        if (Math.random() > 0.6) {
          const freeDate = dateInLastMonths([m,m]);
          data.push({id:uid(), type:'income', amount: randBetween(8000, 18000), date: freeDate, desc:`Freelance project (${freeDate})`, category:'N/A', method:'salary_acct', incomeSource:'Freelance Income'});
        }
      }
      const expenseCategories = ['Food','Rent','Utilities','Shopping','Entertainment','Travel','Health','Misc'];
      const methodsPool = ['salary_acct','savings_acct','cash','digital_wallet','credit_card'];
      for (let i = 0; i < 90; i++) {
        const dt = dateInLastMonths([randBetween(0, 6), randBetween(0, 6)]);
        const cat = pick(expenseCategories);
        const amt = randBetween(300, 9000);
        const method = pick(methodsPool);
        data.push({ id: uid(), type: 'expense', amount: amt, date: dt, desc: `${cat} expense`, category: cat, method });
        if (Math.random() > 0.75) {
          const invGroup = pick(Object.keys({ 'Mutual Funds':{}, 'ETFs':{}, 'Bonds & Debt Instruments':{}, 'Crypto & Digital Assets':{} }));
          const invSub = 'Sample Sub';
          data.push({ id: uid(), type: 'expense', amount: randBetween(2000, 15000), date: dt, desc: `Investment — ${invSub}`, category: 'Investments', method: pick(['salary_acct','savings_acct']), investmentGroup: invGroup, investmentSub: invSub });
        }
        if (Math.random() > 0.85) {
          data.push({ id: uid(), type: 'expense', amount: randBetween(1500, 6000), date: dt, desc: 'Insurance premium', category: 'Insurance', method: pick(['salary_acct','savings_acct']), insuranceType: pick(['Health','Life']), insuranceFor: pick(['Self','Family']) });
        }
      }
      for (let i = 0; i < 20; i++) {
        const dt = dateInLastMonths([randBetween(0, 6), randBetween(0, 6)]);
        data.push({ id: uid(), type: 'expense', amount: randBetween(500, 12000), date: dt, desc: 'Credit card spend', category: 'Shopping', method: 'credit_card' });
        if (Math.random() > 0.7) {
          data.push({ id: uid(), type: 'expense', amount: randBetween(3000, 20000), date: dt, desc: 'Credit card payment', category: 'Credit Card Payment', method: 'credit_card_payment' });
        }
      }
      [
        { group: 'Real Estate', sub: 'REITs (Real Estate Investment Trusts)', amount: 40000 },
        { group: 'Mutual Funds', sub: 'Equity MF - ELSS (Tax Saving)', amount: 25000 },
        { group: 'Fixed Income / Savings Schemes', sub: 'FD (Fixed Deposit)', amount: 60000 },
      ].forEach(item => {
        const dt = dateInLastMonths([randBetween(1,5), randBetween(1,5)]);
        data.push({ id: uid(), type: 'expense', amount: item.amount, date: dt, desc: `One-off Investment — ${item.sub}`, category: 'Investments', method: pick(['salary_acct','savings_acct']), investmentGroup: item.group, investmentSub: item.sub });
      });
      saveAll();
      renderAll();
      document.getElementById('importModal').classList.remove('open');
      alert('Sample data loaded.');
  }

  // ---------- Calculator ----------
  function handleCalculatorInput(e) {
    const key = e.target.innerText;
    const display = document.getElementById('calc-display');
    const preview = document.getElementById('calc-preview');
    if (!display) return;
    if (key === 'AC') { display.textContent = '0'; preview.textContent = 'Enter an expression…'; return; }
    if (key === '±' || key === '%') return;
    if (key === '=') {
      try {
        const expr = display.textContent.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
        const result = Function('"use strict";return ('+expr+')')();
        display.textContent = String(result);
        preview.textContent = fmt(Number(result));
      } catch (err) { preview.textContent = 'Invalid expression'; }
      return;
    }
    const mapped = key === '×' ? '*' : key === '÷' ? '/' : key === '−' ? '-' : key;
    display.textContent = display.textContent === '0' ? mapped : display.textContent + mapped;
    try {
      const expr = display.textContent.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
      const result = Function('"use strict";return ('+expr+')')();
      preview.textContent = fmt(Number(result));
    } catch (err) { preview.textContent = ''; }
  }

  // Attach calculator button handlers
  document.addEventListener('click', (e) => {
    if (!e.target) return;
    if (e.target.closest && e.target.closest('#calc-buttons') && e.target.tagName === 'BUTTON') {
      handleCalculatorInput(e);
    }
  });

  // ---------- Draggable helper ----------
  function dragElement(elmnt) {
    if (!elmnt) return;
    const header = document.getElementById(elmnt.id + "header") || document.getElementById('calc-header');
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    header.onmousedown = dragMouseDown;
    header.ontouchstart = dragTouchStart;

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }

    function dragTouchStart(e) {
        const touch = e.touches[0];
        pos3 = touch.clientX;
        pos4 = touch.clientY;
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementTouchDrag;
    }

    function elementTouchDrag(e) {
        e.preventDefault();
        const touch = e.touches[0];
        pos1 = pos3 - touch.clientX;
        pos2 = pos4 - touch.clientY;
        pos3 = touch.clientX;
        pos4 = touch.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
  }

  // ---------- Market Ticker (merged) ----------
  const TICKER_SETTINGS_KEY = 'mm_ticker_settings_v1';
  const defaultTickerSettings = {
    trackedMajorMarkets: [
      { symbol: 'NSEI', name: 'Nifty 50', enabled: true },
      { symbol: 'SENSEX', name: 'Sensex', enabled: true },
      { symbol: 'NASDAQ', name: 'NASDAQ Composite', enabled: true },
      { symbol: 'SPX', name: 'S&P 500', enabled: false },
      { symbol: 'DOWJ', name: 'Dow Jones', enabled: false },
      { symbol: 'FTSE', name: 'FTSE 100', enabled: false },
      { symbol: 'DAX', name: 'DAX', enabled: false },
      { symbol: 'NIKKEI', name: 'Nikkei 225', enabled: false },
      { symbol: 'HANGSENG', name: 'Hang Seng', enabled: false }
    ],
    trackedMetals: [
      { metal: 'XAU', currency: 'INR', enabled: true },
      { metal: 'XAG', currency: 'USD', enabled: false }
    ],
    lastSnapshot: null
  };
  let tickerSettings = (function loadTickerSettings() {
    try {
      const raw = localStorage.getItem(TICKER_SETTINGS_KEY);
      if (!raw) {
        localStorage.setItem(TICKER_SETTINGS_KEY, JSON.stringify(defaultTickerSettings));
        return JSON.parse(JSON.stringify(defaultTickerSettings));
      }
      const parsed = JSON.parse(raw);
      parsed.trackedMajorMarkets = parsed.trackedMajorMarkets || defaultTickerSettings.trackedMajorMarkets;
      parsed.trackedMetals = parsed.trackedMetals || defaultTickerSettings.trackedMetals;
      parsed.lastSnapshot = parsed.lastSnapshot || null;
      return parsed;
    } catch (e) {
      console.warn('Ticker settings load failed, using defaults', e);
      return JSON.parse(JSON.stringify(defaultTickerSettings));
    }
  })();

  function saveTickerSettings() {
    try {
      localStorage.setItem(TICKER_SETTINGS_KEY, JSON.stringify(tickerSettings));
    } catch (e) {
      console.warn('Failed to save ticker settings', e);
    }
  }

  function fetchMajorMarketPrice(market) {
    const baseMap = {
      'NSEI': 22000,
      'SENSEX': 72000,
      'NASDAQ': 16000,
      'SPX': 5200,
      'DOWJ': 36000,
      'FTSE': 7600,
      'DAX': 16000,
      'NIKKEI': 36000,
      'HANGSENG': 18000
    };
    const base = baseMap[market.symbol] || (Math.random() * 20000 + 2000);
    const volatility = base * (0.002 + Math.random() * 0.01);
    const changeAbs = (Math.random() - 0.5) * volatility;
    const price = Math.max(1, base + changeAbs);
    const changePct = ((price - base) / base) * 100;
    return {
      symbol: market.symbol,
      name: market.name,
      price: parseFloat(price.toFixed(price > 100 ? 2 : 4)),
      change: parseFloat(changePct.toFixed(2))
    };
  }

  function getSimulatedFxRate(currency) {
    const map = {
      'USD': 1,
      'INR': 83.5,
      'EUR': 0.92,
      'GBP': 0.79,
      'AED': 3.67,
      'SGD': 1.35,
      'AUD': 1.55
    };
    return map[currency] || 1;
  }

  function fetchMetalPrice(metalEntry) {
    const baseUSD = { 'XAU': 2350.00, 'XAG': 28.50 };
    const usd = baseUSD[metalEntry.metal] || 1000;
    const volatility = usd * (0.001 + Math.random() * 0.01);
    const priceUSD = Math.max(0.01, usd + (Math.random() - 0.5) * volatility);
    const fx = getSimulatedFxRate(metalEntry.currency);
    const priceLocal = priceUSD * fx;
    const changePct = ((priceLocal - priceUSD * fx * (1 + (Math.random() - 0.5) * 0.002)) / (priceUSD * fx)) * 100;
    return {
      symbol: metalEntry.metal + '/' + metalEntry.currency,
      name: (metalEntry.metal === 'XAU' ? 'Gold' : 'Silver') + ' / ' + metalEntry.currency,
      price: parseFloat(priceLocal.toFixed(metalEntry.metal === 'XAG' ? 2 : 2)),
      change: parseFloat(changePct.toFixed(2)),
      currency: metalEntry.currency
    };
  }

  function updateTickerClock(snapshotTime = null) {
    const timeEl = document.getElementById('tickerClockTime');
    const tzEl = document.getElementById('tickerClockTZ');
    const now = snapshotTime ? new Date(snapshotTime) : new Date();
    if (timeEl) {
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      timeEl.textContent = `${hh}:${mm}:${ss}`;
    }
    if (tzEl) {
      const isoDate = now.toISOString().replace('T', ' ').split('.')[0];
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
      tzEl.textContent = `Snapshot: ${isoDate} (${tz})`;
    }
    tickerSettings.lastSnapshot = (snapshotTime || new Date()).toISOString();
    saveTickerSettings();
  }

  let tickerIntervalHandle = null;
  let tickerRefreshMs = 60000;

  function renderMarketTicker() {
    const wrap = document.getElementById('tickerWrap');
    if (!wrap) return;

    const majors = (tickerSettings.trackedMajorMarkets || []).filter(m => m.enabled);
    const metals = (tickerSettings.trackedMetals || []).filter(m => m.enabled);

    const majorData = majors.map(m => fetchMajorMarketPrice(m));
    const metalData = metals.map(m => fetchMetalPrice(m));

    let html = '';
    majorData.forEach(item => {
      const sign = item.change >= 0 ? '▲' : '▼';
      const changeClass = item.change >= 0 ? 'change-up' : 'change-down';
      const priceDisplay = (item.price).toLocaleString(undefined, { minimumFractionDigits: item.price < 100 ? 2 : 0, maximumFractionDigits: 2 });
      html += `
        <div class="ticker-item" role="listitem" aria-label="${item.name} ${priceDisplay}">
          <span class="symbol">${item.name}</span>
          <span class="price">${priceDisplay}</span>
          <span class="${changeClass}">(${sign} ${Math.abs(item.change).toFixed(2)}%)</span>
        </div>
      `;
    });

    metalData.forEach(item => {
      const sign = item.change >= 0 ? '▲' : '▼';
      const changeClass = item.change >= 0 ? 'change-up' : 'change-down';
      const priceDisplay = (item.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      html += `
        <div class="ticker-item" role="listitem" aria-label="${item.name} ${priceDisplay}">
          <span class="symbol">${item.name}</span>
          <span class="price">${priceDisplay} ${item.currency}</span>
          <span class="${changeClass}">(${sign} ${Math.abs(item.change).toFixed(2)}%)</span>
        </div>
      `;
    });

    wrap.innerHTML = html + html;
    updateTickerClock(new Date());

    if (tickerIntervalHandle) clearInterval(tickerIntervalHandle);
    tickerIntervalHandle = setInterval(() => {
      renderMarketTicker();
    }, tickerRefreshMs);
  }

  function applyMarketFiltersFromControls() {
    const majorSelect = document.getElementById('marketSelectMajor');
    const metalSelect = document.getElementById('metalSelect');
    const metalCountrySelect = document.getElementById('metalCountrySelect');

    const selectedMajor = majorSelect ? majorSelect.value : null;
    if (selectedMajor) {
      tickerSettings.trackedMajorMarkets = tickerSettings.trackedMajorMarkets.map(m => {
        return { ...m, enabled: (m.symbol === selectedMajor) || m.enabled };
      });
    }

    const selectedMetal = metalSelect ? metalSelect.value : null;
    const selectedCurrency = metalCountrySelect ? metalCountrySelect.value : null;
    if (selectedMetal && selectedCurrency) {
      const exists = tickerSettings.trackedMetals.find(m => m.metal === selectedMetal && m.currency === selectedCurrency);
      if (!exists) {
        tickerSettings.trackedMetals.push({ metal: selectedMetal, currency: selectedCurrency, enabled: true });
      } else {
        tickerSettings.trackedMetals = tickerSettings.trackedMetals.map(m => {
          if (m.metal === selectedMetal && m.currency === selectedCurrency) return { ...m, enabled: true };
          return m;
        });
      }
    }

    saveTickerSettings();
    renderTrackedLists();
    renderMarketTicker();
  }

  function renderTrackedLists() {
    const majorList = document.getElementById('trackedMajorMarkets');
    if (majorList) {
      majorList.innerHTML = '';
      tickerSettings.trackedMajorMarkets.forEach((m, idx) => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '8px';
        li.style.border = '1px solid var(--border)';
        li.style.borderRadius = '8px';
        li.innerHTML = `
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="maj_chk_${idx}" ${m.enabled ? 'checked' : ''} />
            <label for="maj_chk_${idx}" style="font-weight:600;">${m.name} (${m.symbol})</label>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn-outline" data-idx="${idx}" onclick="editMajor(${idx})">Edit</button>
            <button class="btn-danger" data-idx="${idx}" onclick="deleteMajor(${idx})">Delete</button>
          </div>
        `;
        majorList.appendChild(li);
        li.querySelector(`#maj_chk_${idx}`).addEventListener('change', (e) => {
          tickerSettings.trackedMajorMarkets[idx].enabled = e.target.checked;
          saveTickerSettings();
        });
      });
    }

    const metalList = document.getElementById('trackedMetals');
    if (metalList) {
      metalList.innerHTML = '';
      tickerSettings.trackedMetals.forEach((m, idx) => {
        const card = document.createElement('div');
        card.style.display = 'flex';
        card.style.alignItems = 'center';
        card.style.justifyContent = 'space-between';
        card.style.minWidth = '220px';
        card.style.padding = '8px';
        card.style.border = '1px solid var(--border)';
        card.style.borderRadius = '8px';
        card.innerHTML = `
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="met_chk_${idx}" ${m.enabled ? 'checked' : ''} />
            <div style="font-weight:600;">${m.metal === 'XAU' ? 'Gold' : 'Silver'} / ${m.currency}</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn-outline" onclick="editMetal(${idx})">Edit</button>
            <button class="btn-danger" onclick="deleteMetal(${idx})">Delete</button>
          </div>
        `;
        metalList.appendChild(card);
        card.querySelector(`#met_chk_${idx}`).addEventListener('change', (e) => {
          tickerSettings.trackedMetals[idx].enabled = e.target.checked;
          saveTickerSettings();
        });
      });
    }
  }

  document.getElementById('addMajorBtn')?.addEventListener('click', () => {
    const sym = (document.getElementById('newMajorSymbol')?.value || '').trim().toUpperCase();
    const name = (document.getElementById('newMajorName')?.value || '').trim();
    if (!sym || !name) { alert('Please enter both symbol and display name.'); return; }
    tickerSettings.trackedMajorMarkets.push({ symbol: sym, name: name, enabled: true });
    saveTickerSettings();
    renderTrackedLists();
    document.getElementById('newMajorSymbol').value = '';
    document.getElementById('newMajorName').value = '';
  });

  function editMajor(idx) {
    const m = tickerSettings.trackedMajorMarkets[idx];
    if (!m) return;
    const newName = prompt('Edit display name for ' + m.symbol, m.name);
    if (newName !== null) {
      tickerSettings.trackedMajorMarkets[idx].name = newName.trim() || m.name;
      saveTickerSettings();
      renderTrackedLists();
    }
  }

  function deleteMajor(idx) {
    if (!tickerSettings.trackedMajorMarkets[idx]) return;
    if (!confirm(`Remove ${tickerSettings.trackedMajorMarkets[idx].name} (${tickerSettings.trackedMajorMarkets[idx].symbol}) from tracked majors?`)) return;
    tickerSettings.trackedMajorMarkets.splice(idx, 1);
    saveTickerSettings();
    renderTrackedLists();
  }

  document.getElementById('addMetalBtn')?.addEventListener('click', () => {
    const metal = (document.getElementById('modalMetalSelect')?.value || 'XAU');
    const currency = (document.getElementById('modalMetalCountry')?.value || 'USD');
    const exists = tickerSettings.trackedMetals.find(m => m.metal === metal && m.currency === currency);
    if (exists) { alert('This metal/currency pair is already tracked.'); return; }
    tickerSettings.trackedMetals.push({ metal, currency, enabled: true });
    saveTickerSettings();
    renderTrackedLists();
  });

  function editMetal(idx) {
    const m = tickerSettings.trackedMetals[idx];
    if (!m) return;
    const newCurrency = prompt('Edit currency for ' + (m.metal === 'XAU' ? 'Gold' : 'Silver'), m.currency);
    if (newCurrency !== null) {
      tickerSettings.trackedMetals[idx].currency = newCurrency.trim().toUpperCase() || m.currency;
      saveTickerSettings();
      renderTrackedLists();
    }
  }

  function deleteMetal(idx) {
    if (!tickerSettings.trackedMetals[idx]) return;
    if (!confirm(`Remove ${tickerSettings.trackedMetals[idx].metal} / ${tickerSettings.trackedMetals[idx].currency} from tracked metals?`)) return;
    tickerSettings.trackedMetals.splice(idx, 1);
    saveTickerSettings();
    renderTrackedLists();
  }

  document.getElementById('saveTickerConfig')?.addEventListener('click', () => {
    saveTickerSettings();
    renderTrackedLists();
    renderMarketTicker();
    document.querySelectorAll('.closeModal').forEach(btn => {
      const modalId = btn.dataset.modalId;
      if (modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('open');
      }
    });
  });

  document.getElementById('applyMarketFilters')?.addEventListener('click', () => {
    applyMarketFiltersFromControls();
  });

  function populateHeaderSelectsFromSettings() {
    const majorSelect = document.getElementById('marketSelectMajor');
    if (majorSelect) {
      const firstEnabled = tickerSettings.trackedMajorMarkets.find(m => m.enabled);
      if (firstEnabled) {
        const opt = Array.from(majorSelect.options).find(o => o.value === firstEnabled.symbol);
        if (opt) majorSelect.value = firstEnabled.symbol;
      }
    }
    const metalSelect = document.getElementById('metalSelect');
    const metalCountrySelect = document.getElementById('metalCountrySelect');
    if (metalSelect && metalCountrySelect) {
      const firstEnabledMetal = tickerSettings.trackedMetals.find(m => m.enabled);
      if (firstEnabledMetal) {
        metalSelect.value = firstEnabledMetal.metal || metalSelect.value;
        metalCountrySelect.value = firstEnabledMetal.currency || metalCountrySelect.value;
      }
    }
  }

  // ---------- Integration glue ----------
  (function integrateTickerWithApp() {
    try {
      if (typeof settings !== 'undefined' && settings) {
        if (settings.ticker && typeof settings.ticker === 'object') {
          if (Array.isArray(settings.ticker.trackedMajorMarkets)) {
            tickerSettings.trackedMajorMarkets = settings.ticker.trackedMajorMarkets;
          }
          if (Array.isArray(settings.ticker.trackedMetals)) {
            tickerSettings.trackedMetals = settings.ticker.trackedMetals;
          }
          if (settings.ticker.lastSnapshot) {
            tickerSettings.lastSnapshot = settings.ticker.lastSnapshot;
          }
          saveTickerSettings();
        } else {
          settings.ticker = settings.ticker || {};
          settings.ticker.trackedMajorMarkets = settings.ticker.trackedMajorMarkets || tickerSettings.trackedMajorMarkets;
          settings.ticker.trackedMetals = settings.ticker.trackedMetals || tickerSettings.trackedMetals;
        }
      }
    } catch (e) {
      console.warn('Ticker integration merge failed', e);
    }
  })();

  (function hookRenderAll() {
    try {
      if (typeof renderAll === 'function') {
        const originalRenderAll = renderAll;
        window.renderAll = function() {
          try { originalRenderAll(); } catch (e) { console.error('renderAll wrapper: original renderAll error', e); }
          try {
            populateHeaderSelectsFromSettings();
            renderTrackedLists();
            renderMarketTicker();
            renderRecentEntries();
          } catch (err) {
            console.warn('Ticker post-render update failed', err);
          }
        };
      }
    } catch (e) {
      console.warn('Hooking renderAll failed', e);
    }
  })();

  document.addEventListener('DOMContentLoaded', () => {
    try {
      renderTrackedLists();
      populateHeaderSelectsFromSettings();
      renderMarketTicker();
      setInterval(() => updateTickerClock(), 1000);

      const tickerWrap = document.getElementById('tickerWrap');
      if (tickerWrap) {
        tickerWrap.addEventListener('mouseenter', () => tickerWrap.style.animationPlayState = 'paused');
        tickerWrap.addEventListener('mouseleave', () => tickerWrap.style.animationPlayState = 'running');
        tickerWrap.addEventListener('focusin', () => tickerWrap.style.animationPlayState = 'paused');
        tickerWrap.addEventListener('focusout', () => tickerWrap.style.animationPlayState = 'running');
      }

      function adjustMarqueeForViewport() {
        const wrapEl = document.querySelector('.ticker-wrap');
        if (window.innerWidth <= 768) {
          if (wrapEl) wrapEl.style.animationDuration = '45s';
        } else {
          if (wrapEl) wrapEl.style.animationDuration = '28s';
        }
      }
      adjustMarqueeForViewport();
      window.addEventListener('resize', adjustMarqueeForViewport);

    } catch (e) {
      console.error('Ticker DOMContentLoaded integration error', e);
    }
  });

  // ---------- Render all (core) ----------
  function renderAll() {
    try {
      // KPIs
      const income = data.filter(d => d.type === 'income').reduce((s, x) => s + Number(x.amount || 0), 0);
      const expense = data.filter(d => d.type === 'expense').reduce((s, x) => s + Number(x.amount || 0), 0);
      const net = data.filter(d => d.type === 'opening_balance' || d.type === 'income').reduce((s, x) => s + Number(x.amount || 0), 0) - expense;
      const invest = data.filter(d => d.category === 'Investments' || d.type === 'opening_balance' && d.investmentGroup).reduce((s, x) => s + Number(x.amount || 0), 0);

      document.getElementById('kpiIncome') && (document.getElementById('kpiIncome').innerText = fmt(income));
      document.getElementById('kpiExpense') && (document.getElementById('kpiExpense').innerText = fmt(expense));
      document.getElementById('kpiNet') && (document.getElementById('kpiNet').innerText = fmt(net));
      document.getElementById('kpiInvest') && (document.getElementById('kpiInvest').innerText = fmt(invest));

      // net liquidity breakdown
      const netEl = document.getElementById('netLiquidityBreakdown');
      if (netEl) {
        const cashItems = data.filter(d => d.type === 'opening_balance' && (d.investmentGroup === 'Cash' || d.openingType === 'Cash'));
        netEl.innerHTML = cashItems.map(ci => `<div><span>${ci.desc}</span><span>${fmt(ci.amount)}</span></div>`).join('');
      }

      // categories for recent filter
      const catEl = document.getElementById('recentCategory');
      if (catEl) {
        const cats = Array.from(new Set(data.map(d => d.category).filter(Boolean)));
        catEl.innerHTML = '<option value="">All categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
      }

      renderRecentEntries();
      renderMarketTicker();
    } catch (e) {
      console.error('renderAll error', e);
    }
  }

  // ---------- UI wiring ----------
  document.getElementById('saveEntryBtn')?.addEventListener('click', saveEntry);
  document.getElementById('clearEntryBtn')?.addEventListener('click', clearEntryForm);
  document.getElementById('processImportBtn')?.addEventListener('click', processImportedData);
  document.getElementById('sampleBtn')?.addEventListener('click', loadSampleData);

  // dynamic fields toggle
  function toggleDynamicFields() {
    const type = document.getElementById('type').value;
    document.getElementById('incomeSourceRow').classList.toggle('hidden', type !== 'income');
    document.getElementById('investmentRow').classList.toggle('hidden', type !== 'expense');
    document.getElementById('insuranceRow').classList.toggle('hidden', type !== 'expense');
    document.getElementById('openingBalanceRow').classList.toggle('hidden', type !== 'opening_balance');
  }
  document.getElementById('type')?.addEventListener('change', toggleDynamicFields);

  // initialize form defaults
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date') && (document.getElementById('date').value = new Date().toISOString().slice(0,10));
    toggleDynamicFields();
    try { dragElement(document.getElementById('calculator')); } catch(e){}
  });

  // Expose functions for console debugging
  window.MoneyMirror = {
    data,
    settings,
    saveAll,
    renderAll,
    renderMarketTicker,
    getTickerSettings: () => JSON.parse(localStorage.getItem(TICKER_SETTINGS_KEY) || '{}')
  };

  // Initial render
  setTimeout(() => {
    renderAll();
  }, 200);

  </script>
