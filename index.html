<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — Clean v3</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:0;background:#f4f7fb;color:#0b1220}
    header{background:linear-gradient(90deg,#1f2b6c,#27408f);color:white;padding:12px 18px;display:flex;align-items:center;gap:12px}
    .container{max-width:1100px;margin:18px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(10,20,50,0.06)}
    .row{display:flex;gap:8px;align-items:center}
    input,select,button{padding:8px;border-radius:8px;border:1px solid #e6eef9}
    button{cursor:pointer;background:#1f2b6c;color:white;border:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:13px}
    .muted{color:#64748b;font-size:12px}
    .small{font-size:12px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(3,6,23,0.45);z-index:80}
    .modal.open{display:flex}
    .modal-card{background:white;padding:14px;border-radius:10px;width:720px;max-width:94%}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:700">MoneyMirror</div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div id="netBadge" class="muted">Net: ₹0</div>
      <button id="settingsBtn" class="small">Settings</button>
      <button id="backupBtn" class="small">Backup</button>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <div>
        <!-- Top summary -->
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small muted">Total Inflow</div>
              <div id="totalInflow" style="font-weight:800;font-size:18px">₹0</div>
            </div>
            <div>
              <div class="small muted">Total Outflow</div>
              <div id="totalOutflow" style="font-weight:800;font-size:18px">₹0</div>
            </div>
            <div>
              <div class="small muted">Net</div>
              <div id="netVal" style="font-weight:800;font-size:18px">₹0</div>
            </div>
          </div>
          <div id="momArea" class="muted small" style="margin-top:10px"></div>
        </div>

        <!-- Add entry -->
        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:700;margin-bottom:8px">Add / Edit Entry</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
            <div>
              <label class="small">Type</label><br>
              <select id="type"><option value="expense">Expense</option><option value="income">Income</option></select>
            </div>
            <div>
              <label class="small">Amount</label><br>
              <input id="amount" type="number" />
            </div>
            <div>
              <label class="small">Category</label><br>
              <select id="category"></select>
            </div>
            <div>
              <label class="small">Method</label><br>
              <select id="method"></select>
            </div>
            <div>
              <label class="small">Date</label><br>
              <input id="date" type="date" />
            </div>
            <div>
              <label class="small">Description</label><br>
              <input id="desc" />
            </div>
            <!-- Income source row -->
            <div id="incomeSourceRow" style="display:none">
              <label class="small">Income Source</label><br>
              <select id="incomeSource"></select>
            </div>
            <!-- Investment row -->
            <div id="investmentRow" style="display:none">
              <label class="small">Investment Group / Type</label><br>
              <div style="display:flex;gap:6px">
                <select id="invGroup"><option value="">Group</option><option value="MFs">MFs</option><option value="Commodities">Commodities</option><option value="Stocks">Stocks</option></select>
                <select id="invSub"><option value="">Type</option></select>
              </div>
            </div>
            <!-- Insurance row -->
            <div id="insuranceRow" style="display:none">
              <label class="small">Insurance Type / For</label><br>
              <div style="display:flex;gap:6px">
                <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
                <select id="insFor"><option value="">For</option><option value="Self">Self</option><option value="Family">Family</option></select>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="addBtn">Add</button>
            <button id="saveBtn" style="display:none;background:#059669">Save</button>
            <button id="cancelBtn" class="small" style="background:#94a3b8">Cancel</button>
            <button id="sampleBtn" class="small" style="background:#64748b">Add Sample</button>
          </div>
        </div>

        <!-- Charts -->
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="flex:1">
              <div class="small muted">Expenses by Category (6 months)</div>
              <canvas id="barChart" style="width:100%;height:220px"></canvas>
            </div>
            <div style="width:260px">
              <div class="small muted">Investments Distribution</div>
              <canvas id="invPie" style="width:100%;height:220px"></canvas>
            </div>
          </div>
        </div>

        <!-- Transactions table -->
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">Transactions</div>
          <div style="max-height:360px;overflow:auto">
            <table>
              <thead><tr><th>Type</th><th>Amt</th><th>Category</th><th>Method</th><th>Date</th><th>Desc</th><th>Act</th></tr></thead>
              <tbody id="txBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <!-- Right column: Invest summary & balances -->
        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:700">Investments Summary</div>
          <div id="invSummary" class="muted small" style="margin-top:6px"></div>
          <table style="margin-top:8px">
            <thead><tr><th>Instrument</th><th>Amt</th><th>MoM</th></tr></thead>
            <tbody id="invTable"></tbody>
          </table>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:700">Account Balances</div>
          <div id="balancesArea" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div style="font-weight:700">Quick Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportCsv">Export CSV</button>
            <button id="importJson" class="small">Import JSON</button>
            <button id="reset" class="small" style="background:#dc2626">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal"><div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Settings</div><button id="closeSettings" class="small">Close</button></div>
    <div style="margin-top:8px">
      <div style="font-weight:600;margin-bottom:6px">Payment method display names</div>
      <div id="methodEditor" style="display:grid;gap:8px"></div>
      <div style="margin-top:8px">
        <input id="newMethodId" placeholder="new method id (e.g., upi)" />
        <input id="newMethodName" placeholder="display name (PhonePe)" />
        <button id="addMethod" class="small">Add</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">Income sources</div>
      <div style="display:flex;gap:8px">
        <input id="newIncome" placeholder="source name (e.g., Freelance)" />
        <button id="addIncomeBtn" class="small">Add</button>
      </div>
      <div id="incomeList" class="muted small" style="margin-top:8px"></div>
    </div>
  </div></div>

<script>
/* ---------------------------
   Lightweight, clean data model
   --------------------------- */
const STORAGE_KEY = 'mm_v3_data';
const METHOD_KEY = 'mm_v3_methods';
const INCOME_KEY = 'mm_v3_income';

const CANONICAL_METHODS = {
  salary_acct: 'Salary Account',
  savings_acct: 'Savings Account',
  cash: 'Cash',
  savings_cash: 'Savings Cash',
  credit_card: 'Credit Card',
  amazon_wallet: 'Amazon Wallet'
};

let methodNames = JSON.parse(localStorage.getItem(METHOD_KEY) || 'null') || {
  salary_acct: 'HDFC',
  savings_acct: 'BoM',
  cash: 'Cash',
  savings_cash: 'Savings Cash',
  credit_card: 'Credit Card',
  amazon_wallet: 'Amazon Wallet'
};

let incomeSources = JSON.parse(localStorage.getItem(INCOME_KEY) || 'null') || ['Salary'];

let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || [];

/* Utility */
const uid = () => Date.now() + Math.floor(Math.random()*8999);
const fmt = n => '₹' + Number(n||0).toLocaleString('en-IN', {maximumFractionDigits:2});
const saveAll = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); localStorage.setItem(METHOD_KEY, JSON.stringify(methodNames)); localStorage.setItem(INCOME_KEY, JSON.stringify(incomeSources)); };

/* Normalize older entries: try to map their method strings to canonical id if possible */
function normalizeExistingData(){
  const reverseMap = {};
  for(const k in methodNames) reverseMap[methodNames[k]] = k;
  for(const id in CANONICAL_METHODS) reverseMap[CANONICAL_METHODS[id]] = id; // also accept default labels
  data = data.map(e => {
    if(e && e.method){
      if(CANONICAL_METHODS[e.method]) return e; // already canonical
      const maybe = reverseMap[e.method];
      if(maybe) e.method = maybe;
    }
    return e;
  });
}
normalizeExistingData();

/* DOM refs */
const totalInflowEl = document.getElementById('totalInflow');
const totalOutflowEl = document.getElementById('totalOutflow');
const netValEl = document.getElementById('netVal');
const momArea = document.getElementById('momArea');
const txBody = document.getElementById('txBody');
const balancesArea = document.getElementById('balancesArea');
const invSummary = document.getElementById('invSummary');
const invTable = document.getElementById('invTable');

const typeEl = document.getElementById('type');
const amountEl = document.getElementById('amount');
const categoryEl = document.getElementById('category');
const methodEl = document.getElementById('method');
const dateEl = document.getElementById('date');
const descEl = document.getElementById('desc');
const incomeRow = document.getElementById('incomeSourceRow');
const incomeEl = document.getElementById('incomeSource');

const invRow = document.getElementById('investmentRow');
const invGroup = document.getElementById('invGroup');
const invSub = document.getElementById('invSub');

const insRow = document.getElementById('insuranceRow');
const insType = document.getElementById('insType');
const insFor = document.getElementById('insFor');

const addBtn = document.getElementById('addBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const sampleBtn = document.getElementById('sampleBtn');

/* Charts single instances */
let barChart = null;
let invPie = null;

/* Categories list */
const BASE_CATS = ['Food','Travel','Groceries','Medicine','Shopping','Bills','Rent','Misc','Salary','Credit Card Payment','Investments','Insurance'];

/* Investments taxonomy */
const INVEST_SUB = {
  MFs: ['Equity','Bonds','Debt','Liquid'],
  Commodities: ['Silver','Gold (ETF)','Gold (Physical)'],
  Stocks: ['Stocks']
};

/* Populate selects */
function populateSelects(){
  const cats = new Set(BASE_CATS);
  data.forEach(e=> e.category && cats.add(e.category));
  categoryEl.innerHTML = Array.from(cats).map(c=>`<option value="${c}">${c}</option>`).join('');
  methodEl.innerHTML = Object.keys(CANONICAL_METHODS).map(id=>`<option value="${id}">${methodNames[id]||CANONICAL_METHODS[id]}</option>`).join('');
  incomeEl.innerHTML = incomeSources.map(s=>`<option>${s}</option>`).join('');
}
populateSelects();

/* inv sub populate */
function populateInvSub(){
  const g = invGroup.value;
  invSub.innerHTML = '<option value="">Type</option>';
  if(INVEST_SUB[g]) INVEST_SUB[g].forEach(s=> invSub.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`));
}

/* Adjust form visibility */
function adjustForm(){
  if(typeEl.value === 'income') incomeRow.style.display = 'block'; else incomeRow.style.display = 'none';
  if(categoryEl.value === 'Investments') invRow.style.display = 'block'; else invRow.style.display = 'none';
  if(categoryEl.value === 'Insurance') insRow.style.display = 'block'; else insRow.style.display = 'none';
}

/* Add entry */
let editId = null;
function addEntry(){
  const type = typeEl.value;
  const amount = Number(amountEl.value);
  const category = categoryEl.value;
  const method = methodEl.value;
  const date = dateEl.value || new Date().toISOString().slice(0,10);
  const desc = descEl.value || '';
  if(!amount || amount <= 0) return alert('Enter valid amount');
  const entry = { id: uid(), type, amount, category, method, date, desc };
  if(type === 'income') entry.incomeSource = incomeEl.value || 'Salary';
  if(category === 'Investments' && invGroup.value) { entry.investmentGroup = invGroup.value; entry.investmentSub = invSub.value || ''; }
  if(category === 'Insurance') { entry.insuranceType = insType.value || ''; entry.insuranceFor = insFor.value || ''; }
  data.push(entry);
  saveAll(); renderAll(); clearForm();
}

function clearForm(){
  amountEl.value=''; descEl.value=''; dateEl.value=''; invGroup.value=''; invSub.innerHTML='<option value="">Type</option>'; insType.value=''; insFor.value='';
}

/* Edit flow */
function openEdit(id){
  const e = data.find(x=>x.id===id); if(!e) return;
  editId = id;
  typeEl.value = e.type; amountEl.value = e.amount; categoryEl.value = e.category; methodEl.value = e.method; dateEl.value = e.date.slice(0,10); descEl.value = e.desc||'';
  if(e.incomeSource) { incomeEl.value = e.incomeSource; }
  if(e.investmentGroup){ invGroup.value = e.investmentGroup; populateInvSub(); invSub.value = e.investmentSub || ''; }
  if(e.category === 'Insurance'){ insType.value = e.insuranceType || ''; insFor.value = e.insuranceFor || ''; }
  adjustForm();
  addBtn.style.display='none'; saveBtn.style.display='inline-block';
}
function saveEdit(){
  if(!editId) return;
  const idx = data.findIndex(x=>x.id===editId); if(idx===-1) return;
  const amount = Number(amountEl.value); if(!amount || amount<=0) return alert('Enter valid amount');
  data[idx].type = typeEl.value; data[idx].amount = amount; data[idx].category = categoryEl.value; data[idx].method = methodEl.value; data[idx].date = dateEl.value || new Date().toISOString().slice(0,10); data[idx].desc = descEl.value||'';
  if(data[idx].type==='income') data[idx].incomeSource = incomeEl.value||'Salary'; else delete data[idx].incomeSource;
  if(data[idx].category==='Investments' && invGroup.value){ data[idx].investmentGroup = invGroup.value; data[idx].investmentSub = invSub.value||''; } else { delete data[idx].investmentGroup; delete data[idx].investmentSub; }
  if(data[idx].category==='Insurance'){ data[idx].insuranceType = insType.value||''; data[idx].insuranceFor = insFor.value||''; } else { delete data[idx].insuranceType; delete data[idx].insuranceFor; }
  editId = null; saveAll(); renderAll(); clearForm(); addBtn.style.display='inline-block'; saveBtn.style.display='none';
}
function deleteEntry(id){
  if(!confirm('Delete this entry?')) return;
  data = data.filter(x=>x.id!==id); saveAll(); renderAll();
}

/* Render transactions */
function renderTransactions(){
  txBody.innerHTML = data.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).map(e=>{
    const methodLabel = methodNames[e.method] || CANONICAL_METHODS[e.method] || e.method;
    const ins = e.category==='Insurance' ? `<div class="muted small">(${e.insuranceType||''} • ${e.insuranceFor||''})</div>` : '';
    const inv = e.investmentGroup ? `<div class="muted small">${e.investmentGroup} › ${e.investmentSub}</div>` : '';
    return `<tr>
      <td>${e.type}</td>
      <td style="font-weight:700">${fmt(e.amount)}</td>
      <td>${e.category}${inv}${ins}</td>
      <td>${methodLabel}</td>
      <td>${new Date(e.date).toLocaleDateString()}</td>
      <td>${e.desc||''}</td>
      <td><button onclick="openEdit(${e.id})" class="small">Edit</button> <button onclick="deleteEntry(${e.id})" class="small" style="background:#dc2626">Del</button></td>
    </tr>`;
  }).join('');
}

/* Compute balances */
function computeBalances(){
  const balances = {};
  for(const id in CANONICAL_METHODS) balances[id] = 0;
  data.forEach(e=>{
    const m = e.method || 'cash';
    if(!(m in balances)) balances[m] = 0;
    balances[m] += (e.type==='income' ? Number(e.amount) : -Number(e.amount));
  });
  return balances;
}

/* MoM stats */
function monthRange(offset){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + offset;
  const start = new Date(year, month, 1);
  const end = new Date(year, month+1, 0, 23,59,59,999);
  return {start, end};
}
function sumRange(start,end,filterFn){
  return data.filter(e=> new Date(e.date) >= start && new Date(e.date) <= end).filter(filterFn||(()=>true)).reduce((s,e)=> s + Number(e.amount), 0);
}
function computeMoM(){
  const cur = monthRange(0), prev = monthRange(-1);
  const curIn = sumRange(cur.start, cur.end, e=>e.type==='income');
  const prevIn = sumRange(prev.start, prev.end, e=>e.type==='income');
  const curOut = sumRange(cur.start, cur.end, e=>e.type==='expense');
  const prevOut = sumRange(prev.start, prev.end, e=>e.type==='expense');
  const p = (a,b)=>(b===0? (a===0?0:100) : Math.round(((a-b)/b)*10000)/100);
  return {curIn,prevIn,curOut,prevOut, inPct:p(curIn,prevIn), outPct:p(curOut,prevOut)};
}

/* Investments summary & MoM */
function investmentsSummary(){
  const invs = data.filter(e=> e.category==='Investments' && e.investmentGroup);
  const totals = {};
  invs.forEach(e=> { const k = `${e.investmentGroup} › ${e.investmentSub}`; totals[k] = (totals[k]||0)+Number(e.amount); });
  const cur = monthRange(0), prev = monthRange(-1);
  const curSum = data.filter(e=> e.category==='Investments' && new Date(e.date)>=cur.start && new Date(e.date)<=cur.end).reduce((s,e)=>s+Number(e.amount),0);
  const prevSum = data.filter(e=> e.category==='Investments' && new Date(e.date)>=prev.start && new Date(e.date)<=prev.end).reduce((s,e)=>s+Number(e.amount),0);
  const pct = prevSum===0 ? (curSum===0?0:100) : Math.round(((curSum-prevSum)/prevSum)*10000)/100;
  return {totals,curSum,prevSum,pct};
}

/* Render investments table and pie */
function renderInvestments(){
  const inv = investmentsSummary();
  invSummary.innerText = `Total invested: ${fmt(Object.values(inv.totals).reduce((s,v)=>s+v,0))} • This month: ${fmt(inv.curSum)} (${inv.pct>=0?'+':''}${inv.pct}%) vs ${fmt(inv.prevSum)}`;
  invTable.innerHTML = Object.keys(inv.totals).map(k=> {
    const amt = inv.totals[k];
    return `<tr><td>${k}</td><td>${fmt(amt)}</td><td class="small">${fmt(0)}</td></tr>`;
  }).join('');
  const labels = Object.keys(inv.totals);
  const vals = Object.values(inv.totals);
  if(invPie) invPie.destroy();
  const ctx = document.getElementById('invPie').getContext('2d');
  invPie = new Chart(ctx, { type:'pie', data:{labels, datasets:[{data:vals}] }, options:{plugins:{legend:{position:'bottom'}}} });
}

/* Render charts (bar) */
function renderCharts(){
  const months = [];
  const now = new Date();
  for(let i=5;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    months.push(d.toLocaleString('en-US',{month:'short',year:'numeric'}));
  }
  const cats = BASE_CATS.slice(0,8);
  const datasets = cats.map((cat,idx) => {
    const dataArr = months.map((m,mi)=>{
      const d = new Date(now.getFullYear(), now.getMonth()-(5-mi), 1);
      const start = new Date(d.getFullYear(), d.getMonth(), 1);
      const end = new Date(d.getFullYear(), d.getMonth()+1, 0,23,59,59,999);
      return data.filter(e=> e.category===cat && new Date(e.date)>=start && new Date(e.date)<=end).reduce((s,x)=> s + Number(x.amount || 0), 0);
    });
    return { label: cat, data: dataArr, stack:'s', backgroundColor: `hsl(${(idx*47)%360} 70% 50% / 1)` };
  });
  if(barChart) barChart.destroy();
  const ctx = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(ctx, { type:'bar', data:{labels:months, datasets}, options:{scales:{x:{stacked:true}, y:{stacked:true, ticks:{callback:v=>fmt(v)}}}, plugins:{legend:{position:'bottom'}} } });
}

/* Render balances */
function renderBalances(){
  const bal = computeBalances();
  balancesArea.innerHTML = Object.keys(bal).map(id=> `<div style="padding:6px;background:#fbfdff;border-radius:8px;margin-bottom:6px">${methodNames[id]||CANONICAL_METHODS[id]}: <strong>${fmt(bal[id])}</strong></div>`).join('');
}

/* Render summary */
function renderSummary(){
  const inflow = data.filter(e=> e.type==='income').reduce((s,e)=>s+Number(e.amount),0);
  const outflow = data.filter(e=> e.type==='expense').reduce((s,e)=>s+Number(e.amount),0);
  totalInflowEl.innerText = fmt(inflow);
  totalOutflowEl.innerText = fmt(outflow);
  netValEl.innerText = fmt(inflow - outflow);
  document.getElementById('netBadge').innerText = 'Net: ' + fmt(inflow - outflow);
  const mom = computeMoM();
  momArea.innerHTML = `This month Inflow: <strong>${fmt(mom.curIn)}</strong> (${mom.inPct>=0?'+':''}${mom.inPct}%) vs ${fmt(mom.prevIn)} — Outflow: <strong>${fmt(mom.curOut)}</strong> (${mom.outPct>=0?'+':''}${mom.outPct}%) vs ${fmt(mom.prevOut)}`;
}

/* Main render */
function renderAll(){
  populateSelects();
  renderTransactions();
  renderCharts();
  renderInvestments();
  renderSummary();
  renderBalances();
}

/* Event wiring */
addBtn.addEventListener('click', addEntry);
saveBtn.addEventListener('click', saveEdit);
cancelBtn.addEventListener('click', ()=>{ editId=null; clearForm(); addBtn.style.display='inline-block'; saveBtn.style.display='none'; });
categoryEl.addEventListener('change', adjustForm);
typeEl.addEventListener('change', adjustForm);
invGroup.addEventListener('change', populateInvSub);
sampleBtn.addEventListener('click', ()=>{
  const s = [
    {id:uid(), type:'income', amount:50000, category:'Salary', method:'salary_acct', date:new Date().toISOString().slice(0,10), desc:'Salary credit', incomeSource:'Salary'},
    {id:uid(), type:'expense', amount:4000, category:'Food', method:'cash', date:new Date().toISOString().slice(0,10), desc:'Dinner'},
    {id:uid(), type:'expense', amount:5000, category:'Investments', method:'savings_acct', date:new Date().toISOString().slice(0,10), desc:'SIP', investmentGroup:'MFs', investmentSub:'Equity'},
    {id:uid(), type:'expense', amount:1500, category:'Insurance', method:'savings_acct', date:new Date().toISOString().slice(0,10), desc:'Health premium', insuranceType:'Health', insuranceFor:'Self'}
  ];
  data = data.concat(s); saveAll(); renderAll();
});

/* Settings modal wiring */
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const methodEditor = document.getElementById('methodEditor');
const closeSettings = document.getElementById('closeSettings');
const addMethodBtn = document.getElementById('addMethod');
const newMethodId = document.getElementById('newMethodId');
const newMethodName = document.getElementById('newMethodName');
const addIncomeBtn = document.getElementById('addIncomeBtn');
const newIncome = document.getElementById('newIncome');
const incomeList = document.getElementById('incomeList');

function openSettings(){ settingsModal.classList.add('open'); renderMethodEditor(); renderIncomeList(); }
function closeSettingsModal(){ settingsModal.classList.remove('open'); }
settingsBtn.addEventListener('click', openSettings); closeSettings.addEventListener('click', closeSettingsModal);

function renderMethodEditor(){
  methodEditor.innerHTML = Object.keys(CANONICAL_METHODS).map(id=>{
    return `<div style="display:flex;gap:8px;align-items:center"><div style="width:160px">${CANONICAL_METHODS[id]}</div>
      <input data-id="${id}" class="method-input" value="${methodNames[id]||''}" />
      <button class="small" onclick="resetMethod('${id}')">Reset</button></div>`;
  }).join('');
  setTimeout(()=>{ document.querySelectorAll('.method-input').forEach(inp=>{
    inp.addEventListener('change', ()=>{ methodNames[inp.dataset.id] = inp.value || CANONICAL_METHODS[inp.dataset.id]; saveAll(); renderAll(); renderMethodEditor(); });
  }); }, 10);
}
function resetMethod(id){ methodNames[id] = CANONICAL_METHODS[id]; saveAll(); renderAll(); renderMethodEditor(); }

addMethodBtn.addEventListener('click', ()=>{
  const id = newMethodId.value.trim(); const name = newMethodName.value.trim();
  if(!id || !name) return alert('Provide id and display name');
  CANONICAL_METHODS[id] = id; methodNames[id] = name; saveAll(); renderMethodEditor(); renderAll(); newMethodId.value=''; newMethodName.value='';
});

addIncomeBtn.addEventListener('click', ()=>{
  const v = newIncome.value.trim(); if(!v) return alert('Enter name'); if(!incomeSources.includes(v)) incomeSources.push(v); saveAll(); renderIncomeList(); populateSelects(); newIncome.value='';
});
function renderIncomeList(){ incomeList.innerHTML = incomeSources.map(s=>`<div>${s}</div>`).join(''); }

/* Export / Import / Reset */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const rows = [['type','amount','category','method','date','desc','incomeSource','investmentGroup','investmentSub','insuranceType','insuranceFor']];
  data.forEach(r=> rows.push([r.type,r.amount,r.category,r.method,r.date,(r.desc||''), r.incomeSource||'', r.investmentGroup||'', r.investmentSub||'', r.insuranceType||'', r.insuranceFor||'']));
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'mm_export.csv'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('importJson').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = e=>{ const f=e.target.files[0]; const r=new FileReader(); r.onload = ()=>{ try{ const obj = JSON.parse(r.result); if(obj.data) data=obj.data; saveAll(); renderAll(); alert('Imported'); } catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); }; inp.click();
});
document.getElementById('reset').addEventListener('click', ()=>{ if(confirm('Reset ALL data?')){ data=[]; methodNames={salary_acct:'HDFC',savings_acct:'BoM',cash:'Cash',savings_cash:'Savings Cash',credit_card:'Credit Card',amazon_wallet:'Amazon Wallet'}; incomeSources=['Salary']; saveAll(); renderAll(); } });

/* Initial render */
renderAll();

</script>
</body>
</html>
