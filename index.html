<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyMirror — v5.0.3 (Investment breakdown with subcategories)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCAZvHT6dG61ISR57AJoZh8GSO7nY_mEGc",
      authDomain: "moneymirror-22543.firebaseapp.com",
      projectId: "moneymirror-22543",
      storageBucket: "moneymirror-22543.firebasestorage.app",
      messagingSenderId: "61775081584",
      appId: "1:61775081584:web:3ec184985e324cf6f1c4b5",
      measurementId: "G-8RPXH1VEFG"
 
    };

    let db = null;
    let auth = null;
    let USE_FIRESTORE = false;
    const FIRESTORE_COLLECTION_NAME = 'moneymirror_v4_transactions';
    let currentProfile = null;

    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = app.firestore();
      auth = app.auth();
      USE_FIRESTORE = true;
      console.log("Firebase initialized.");
    } catch (e) {
      console.warn("Firebase init failed, falling back to LocalStorage:", e);
    }

    async function signInWithGoogle() {
      if (!auth) return alert('Auth not initialized. Please refresh.');
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        onUserSignedIn(user);
      } catch (err) {
        console.error("Login failed:", err);
        alert('Sign-in popup blocked. Allow popups and try again.');
      }
    }

    function onUserSignedIn(user) {
      currentProfile = user.displayName ||
        user.email || 'User';
      localStorage.setItem('mm_last_profile', currentProfile);
      document.getElementById('profileNameDisplay').textContent = currentProfile;
      document.getElementById('authGate').style.display = 'none';
      document.querySelector('main').style.filter = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      loadProfileData();
    }

    function signOutUser() {
      if (!auth) return;
      auth.signOut().then(() => {
        currentProfile = null;
        document.getElementById('profileNameDisplay').textContent = '--';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('authGate').style.display = 'flex';
        document.querySelector('main').style.filter = 'blur(5px)';
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
      document.getElementById('logoutBtn').addEventListener('click', signOutUser);
      if (auth) {
        auth.onAuthStateChanged(user => {
          if (user) onUserSignedIn(user);
          else {
            document.getElementById('authGate').style.display = 'flex';
            document.querySelector('main').style.filter = 'blur(5px)';
            
            document.getElementById('logoutBtn').style.display = 'none';
          }
        });
      }
    });
  </script>

  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-active: #38bdf8;
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #cbd5e1;
      --warning: #f97316;
      --opening-balance: #6b21a8;

      /* Extended palette for charts */
      --c1:#2563eb; --c2:#10b981; --c3:#f59e0b; --c4:#ef4444; --c5:#7c3aed; --c6:#0ea5e9; --c7:#14b8a6;
      --c8:#22c55e; --c9:#eab308; --c10:#f97316; --c11:#374151; --c12:#8b5cf6;
    }

    * { box-sizing: border-box;
    }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex;
    overflow: hidden; }

    aside { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 24px 16px;
    color: white; flex-shrink: 0; transition: all 0.3s; justify-content: space-between; z-index: 100; }
    main { flex: 1;
    overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; position: relative; filter: blur(5px);
    }

    .brand { font-size: 20px; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px;
    padding-left: 10px; }
    .brand span { color: var(--sidebar-active); }
    .nav-group { margin-bottom: 24px;
    }
    .nav-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #475569; font-weight: 700; margin-bottom: 8px; padding-left: 10px;
    }
    .nav-item { padding: 10px 12px; border-radius: 6px; color: var(--sidebar-text); cursor: pointer; transition: 0.2s; display: flex;
    align-items: center; gap: 12px; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white;
    }
    .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--sidebar-active);
    }
    .sidebar-footer { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);
    }
    .sys-stat { font-size: 11px; color: var(--sidebar-text); display: flex; justify-content: space-between; margin-bottom: 4px;
    }
    .sys-val { color: white; font-weight: 600; }

    #mobileMenuBtn { display: none; background: transparent;
    border: none; color: white; cursor: pointer; font-size: 24px; padding: 5px; }
    .icon-menu { display: block;
    }
    .icon-close { display: none; }
    aside.mobile-open .icon-menu { display: none;
    }
    aside.mobile-open .icon-close { display: block; }

    #authGate {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #1e293b, #3b82f6);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      color: white;
      text-align: center;
      padding: 0 24px;
    }
    #authGate .line { margin: 0;
    }
    #authGate .line-1 { font-size: 22px; font-weight: 600; }
    #authGate .line-2 { font-size: 20px;
    font-weight: 600; }
    #authGate .line-3 { font-family: 'Merriweather', serif; font-style: italic; font-size: 18px; margin: 6px 0 14px;
    }

    button { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer;
    transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark);
    }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main);
    }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn-danger { background: #fee2e2; color: #991b1b;
    }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
    }
    .col-span-1 { grid-column: span 1; }
    .col-span-2 { grid-column: span 2;
    }
    .col-span-3 { grid-column: span 3; }
    .col-span-4 { grid-column: span 4;
    }

    .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); display: flex; flex-direction: column; overflow: hidden;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px;
    }
    .card-body { padding: 0 20px 20px 20px; flex: 1;
    }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text-main); }

    .action-card { border-color: var(--primary);
    box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15); }
    .action-header { background: var(--primary); padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center; }
    .action-header .card-title { color: white;
    }
    .action-body { padding: 20px; display: flex; flex-wrap: wrap; gap: 20px;
    }

    .input-group-small { width: 15%; }
    .input-group-med { width: 25%;
    }
    .input-group-large { width: 45%; }

    .kpi-card { padding: 20px;
    }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -0.5px;
    }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px;
    }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-down { color: var(--danger); font-weight: 600;
    }
    .cc-alert-high { background: #fee2e2 !important; border-color: var(--danger) !important; }

    label { font-size: 11px;
    font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: block; letter-spacing: 0.5px;
    }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit;
    font-size: 13px; background: #f8fafc; outline: none; transition: border 0.2s; }
    input:focus, select:focus { border-color: var(--primary); background: white;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .table-container { overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 11px;
    color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-income { background: #dcfce7; color: #166534;
    }
    .badge-expense { background: #fee2e2; color: #991b1b; }
    .badge-inv { background: #e0f2fe; color: #075985;
    }
    .badge-ins { background: #f3e8ff; color: #6b21a8; }
    .badge-opening { background: #efe6ff; color: var(--opening-balance);
    }
    .badge-cc { background: #fef3c7; color: #b45309; }

    .account-list { font-size: 11px; margin-top: 12px;
    border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 5px; color: var(--text-muted);
    }
    .account-list div { display: flex; justify-content: space-between; }
    .account-list span:last-child { font-weight: 600;
    color: var(--text-main); }

    .flex-row { display: flex; gap: 10px; align-items: center;
    }
    .full-width { width: 100%; }
    .hidden { display: none !important;
    }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center;
    backdrop-filter: blur(2px); }
    .modal.open { display: flex; animation: fadeIn 0.2s ease-out;
    }
    .modal-content { background: white; width: 95%; max-width: 1200px; padding: 0; border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
    .modal-pad { padding: 24px;
    }
    .modal-small { width: 400px; }
    @keyframes fadeIn { from { opacity: 0;
    } to { opacity: 1; } }

    /* Calculator */
    #calculator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      height: 480px;
      min-height: 480px;
      max-height: 480px;
      z-index: 3000;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: #f8fafc;
      border: 1px solid var(--border);
      display: none; /* Starts hidden */
      flex-direction: column;
      overflow: hidden;
    }
    #calc-header { background: var(--sidebar-bg); color: white; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between;
    align-items: center; font-weight: 600; font-size: 13px; height: 40px; }
    #calc-close-btn { background: transparent; border: none; color: #ef4444;
    font-size: 18px; font-weight: 700; cursor: pointer; padding: 0; line-height: 1; }
    #calc-display { background: var(--sidebar-bg); color: white;
    text-align: right; font-size: 24px; padding: 10px 15px; border-top: 1px solid rgba(255,255,255,0.1); font-family: monospace; overflow-x: auto; white-space: nowrap; height: 60px;
    }
    #calc-preview { background: #0b1323; color: #9fb3c8; text-align: right; font-size: 14px; padding: 6px 15px; font-family: monospace;
    height: 28px; border-top: 1px solid rgba(255,255,255,0.06); }
    #calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr);
    padding: 10px; gap: 8px; background: white; flex: 1; }
    #calc-buttons button { width: 100%; height: 100%;
    font-size: 18px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e2e8f0; transition: background 0.1s; cursor: pointer; display: flex;
    align-items: center; justify-content: center; }
    #calc-buttons button:hover { background: #f1f5f9;
    }
    .calc-operator { background: #e0f7fa !important; color: var(--primary) !important;
    }
    .calc-operator:hover { background: #c2e0e5 !important; }
    .calc-clear { background: #fef2f2 !important;
    color: var(--danger) !important; }
    .calc-clear:hover { background: #fde8e8 !important;
    }
    .calc-zero { grid-column: span 2; }
    .calc-equals { grid-row: span 2;
    background: var(--primary) !important; color: white !important; }
    .calc-equals:hover { background: var(--primary-dark) !important;
    }
    #calc-toggle { margin-left: 10px; padding: 8px 12px; background: var(--primary); color: white; border-radius: 8px; cursor: pointer;
    display: flex; align-items: center; }

    /* Investment KPI breakdown grid and quick subcategories */
    .kpi-breakdown-grid { display: grid;
    grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: stretch; }
    .quick-sub-card { border: 1px solid var(--border); border-radius: 12px;
    padding: 12px; background: white; }
    .quick-sub-header { display: flex; justify-content: space-between; align-items: center;
    }
    .quick-sub-title { font-weight: 700; }
    .total-badge { background: #f1f5f9; border: 1px solid #e2e8f0;
    padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; color: var(--text-main); }
    .dropdown { position: relative;
    }
    .dropdown-menu { position: absolute; top: 34px; left: 0; background: #fff; border: 1px solid var(--border); border-radius: 12px;
    padding: 10px; width: 280px; box-shadow: 0 12px 24px rgba(0,0,0,0.15); z-index: 10; }
    .dropdown-item { display: flex;
    justify-content: space-between; align-items: center; padding: 6px 8px; border-radius: 8px; font-size: 12px; }
    .dropdown-item:hover { background: #f8fafc;
    }

    @media(max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr);
    }
      .col-span-1 { grid-column: span 1;
    }
      .col-span-2, .col-span-3, .col-span-4 { grid-column: span 2;
    }
    }

    @media(max-width: 768px) {
      body { flex-direction: column;
    height: auto; overflow: auto; }
      aside { width: 100%; padding: 15px; flex-direction: row; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 500; }
      aside .brand { margin-bottom: 0;
    }
      aside nav, .sidebar-footer { display: none;
    }
      #mobileMenuBtn { display: block;
    }
      aside.mobile-open nav {
        display: block;
        position: absolute;
    top: 60px; left: 0; right: 0;
        background: var(--sidebar-bg);
        padding: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    z-index: 501;
      }
      aside.mobile-open .sidebar-footer {
        display: block;
    position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 501;
      }

      .dashboard-grid { grid-template-columns: 1fr;
    gap: 16px; }
      .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1;
    }

      .input-group-small, .input-group-med, .input-group-large, .full-width, #categoryContainer {
        width: 100% !important;
    }
      .action-body { gap: 12px; }
      .kpi-breakdown-grid { grid-template-columns: 1fr;
    }
      #calculator { top: 70px; left: 50%; transform: translateX(-50%); width: 90%; height: 480px; bottom: auto;
    right: auto; }
    }
  </style>
</head>

<body>
  <div id="authGate">
    <p class="line line-1">Welcome to MoneyMirror v5.0.3</p>
    <p class="line line-2">Your Personal Finance Dashboard</p>
    <p class="line line-3">Manage your money, investment portfolio, and debt in one place.</p>
    <button id="loginBtn" class="btn-primary" style="font-size:16px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:8px;"><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg>
      Sign in with Google to start
    </button>
  </div>
  
  <aside id="mainSidebar">
    <div style="flex:1;">
      <div class="brand">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        Money<span>Mirror</span>
        <button id="mobileMenuBtn"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-close"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> </button>
      </div>

      <nav>
        <div class="nav-group">
          <div class="nav-label">Main menu</div>
          <div class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line></svg>
            Dashboard
          </div>
          <div class="nav-item" id="navAnalytics">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M18 15V9m-4 6l4-6M10 6l4 6m-4 6l4-6"></path></svg>
            Advanced analytics
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-label">Configuration</div>
          <div class="nav-item" id="navSettings">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09z"></path></svg>
            Settings & Backup
          </div>
          <div class="nav-item">
            <button id="logoutBtn" class="btn-outline" style="width:100%; display:none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:8px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
              Logout
            </button>
          </div>
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      <div class="sys-stat">
        <span>Current profile</span>
        <span class="sys-val" id="profileNameDisplay">--</span>
      </div>
      <div style="font-size:10px; color:var(--sidebar-text); margin-top:4px">v5.0.3 • Investment subcategories breakdown</div>
    </div>
  </aside>

  <main>
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <div>
        <h1 style="margin:0; font-size:24px; font-weight:700">Financial overview</h1>
        <div style="font-size:13px; color:var(--text-muted); margin-top:4px" id="currentDate"></div>
      </div>
      <div class="flex-row">
        <button class="btn-outline" id="calc-toggle">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12" y2="18"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="10" x2="16" y2="10"></line><line x1="8" y1="10" x2="8" y2="10"></line><line x1="12" y1="10" x2="12" y2="10"></line><line x1="8" y1="6" x2="8" y2="6"></line><line x1="12" y1="6" x2="12" y2="6"></line><line x1="16" y1="6" x2="16" y2="6"></line></svg>
          Calculator
        </button>
        <button class="btn-outline" id="sampleBtn">Load sample</button>
        <button class="btn-primary" id="importDataBtn">Import data (CSV/JSON)</button>
        <button class="btn-outline" id="exportDataBtn">Export data</button>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card action-card col-span-4">
        <div class="action-header">
          <div class="card-title">Add New Transaction</div>
          <div class="flex-row" style="font-size:13px; font-weight:500; color:#fff;">
            <label for="type" style="color:white; margin:0; font-weight:500;">Type:</label>
            <select id="type" style="width:100px; padding:6px; background:white; color:var(--text-main); font-weight:600; border:none; box-shadow:none; font-size:13px;">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
              <option value="opening_balance">Opening Balance</option>
            </select>
          </div>
        </div>
        <div class="action-body">
          <div class="input-group-small">
            <label for="amount">Amount (₹)</label>
            <input type="number" id="amount" placeholder="e.g. 5000" min="0" />
          </div>
          <div class="input-group-small">
            <label for="date">Date</label>
            <input type="date" id="date" />
          </div>
          <div class="input-group-large">
            <label for="desc">Description/Notes</label>
            <input type="text" id="desc" placeholder="e.g. Monthly Rent / Salary" />
          </div>

          <div id="categoryContainer" class="input-group-med">
            <label for="category">Category</label>
            <select id="category"></select>
          </div>
          <div class="input-group-med">
            <label for="method">Payment Method / Account</label>
            <select id="method"></select>
          </div>
          <div id="incomeSourceRow" class="hidden input-group-med">
            <label for="incomeSource">Income Source</label>
            <select id="incomeSource"></select>
          </div>
          
          <div id="investmentRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-small">
              <label>Investment category</label>
              <select id="invGroup"></select>
            </div>
            <div class="input-group-small">
              <label>Investment sub-type</label>
              <select id="invSub"></select>
            </div>
          </div>

          <div id="insuranceRow" class="hidden input-group-med">
            <label>Insurance details</label>
            <div class="flex-row">
              <select id="insType"><option value="">Type</option><option value="Health">Health</option><option value="Life">Life</option></select>
              <select id="insFor"><option value="">Insured</option><option value="Self">Self</option><option value="Family">Family</option></select>
            </div>
          </div>
          
          <div id="openingBalanceRow" class="hidden full-width" style="display:flex; gap:20px; flex-wrap:wrap">
            <div class="input-group-med">
              <label>Initial amount is for:</label>
              <select id="obAccountType">
                <option value="Cash">Cash/Bank/Liquid Account</option>
                <option value="Investment">Investment Account</option>
              </select>
            </div>
            <div id="obInvestmentGroupRow" class="hidden input-group-med">
              <label>Investment Group (for non-cash OB)</label>
              <select id="obInvestmentGroup"></select>
            </div>
          </div>

          <div class="input-group-small" style="align-self: flex-end;">
            <button class="btn-primary full-width" id="addBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Add
            </button>
            <button class="btn-primary full-width hidden" id="saveBtn">Save Edit</button>
            <button class="btn-danger full-width hidden" id="cancelBtn">Cancel Edit</button>
          </div>
        </div>
      </div>

      <div class="card kpi-card col-span-1">
        <div class="card-title">Net Liquidity</div>
        <div class="kpi-value" id="kpiNetLiquidity">₹ 0.00</div>
        <div class="account-list" id="netLiquidityBreakdown"></div>
      </div>
      <div class="card kpi-card col-span-1">
        <div class="card-title">Monthly Net Flow</div>
        <div class="kpi-value trend-up" id="kpiNetFlow">₹ 0.00</div>
        <div class="kpi-sub" id="kpiNetFlowTrend"></div>
      </div>
      <div class="card kpi-card col-span-1">
        <div class="card-title">Total Invested (Historical)</div>
        <div class="kpi-value" id="kpiTotalInvested">₹ 0.00</div>
        <div class="kpi-sub">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
          <span id="kpiTotalInvestmentCount">0</span> transactions
        </div>
      </div>
      <div class="card kpi-card col-span-1" id="ccCard">
        <div class="card-title">Credit Card Due</div>
        <div class="kpi-value" id="kpiCCDue">₹ 0.00</div>
        <div class="kpi-sub">
          Limit: <span id="ccLimitDisplay">₹ 0.00</span>
          <span id="ccPaymentDate" style="margin-left:auto;"></span>
        </div>
      </div>
      
      <div class="card col-span-4" id="invBreakdownPanel">
        <div class="card-header" style="padding-bottom:10px;">
          <div class="card-title">Investment Breakdown</div>
          <button class="btn-outline" id="toggleInvBreakdownBtn" style="padding: 6px 12px; font-size: 12px;">Hide Breakdown</button>
        </div>
        <div class="card-body" style="padding-top:0;">
          <div class="flex-row" style="gap:10px; flex-wrap:wrap;">
            <div style="min-width:220px;">
              <label>Major bucket</label>
              <select id="invBucketFilter"></select>
            </div>
            <div style="min-width:220px;">
              <label>View mode</label>
              <select id="invViewMode">
                <option value="top4">Top 4 buckets</option>
                <option value="subcats">Subcategories of selected bucket</option>
              </select>
            </div>
            <div style="min-width:220px;">
              <label>Date range</label>
              <select id="invDateRange">
                <option value="6">Last 6 months</option>
                <option value="12">Last 12 months</option>
                <option value="all">All time</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="kpi-breakdown-grid" style="padding:0 20px 20px;">
          <div class="card" style="border-color:#93c5fd; box-shadow:none;">
            <div class="card-header"><div class="card-title" id="invBarTitle">Investment by major bucket</div></div>
            <div class="card-body" style="height:300px;">
              <canvas id="invBreakdownBar"></canvas>
            </div>
          </div>
          <div class="card" style="border-color:#93c5fd; box-shadow:none;">
            <div class="card-header"><div class="card-title" id="invPieTitle">Share by bucket</div></div>
            <div class="card-body" style="height:300px;">
              <canvas id="invBreakdownPie"></canvas>
            </div>
          </div>
        </div>

        <div style="margin-top:14px; padding:0 20px 20px;">
          <div class="card-title" style="font-size:13px; color:#075985;">Bucket subcategories quick view</div>
          <div id="invQuickSubs" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:10px;">
            </div>
        </div>
      </div>

      <div class="card col-span-4">
        <div class="card-header">
          <div class="card-title">Recent Transactions (Last 10)</div>
          <div class="flex-row">
            <button class="btn-outline" id="viewAllBtn" style="padding: 6px 12px; font-size: 12px;">View All</button>
            <button class="btn-outline" id="viewCategoriesBtn" style="padding: 6px 12px; font-size: 12px;">View Investment Breakdown</button>
          </div>
        </div>
        <div class="card-body" style="padding-top:0;">
          <div class="table-container">
            <table id="recentTransactionsTable">
              <thead>
                <tr>
                  <th style="width:10%;">Date</th>
                  <th style="width:5%;">Type</th>
                  <th style="width:25%;">Description</th>
                  <th style="width:20%;">Category/Sub-Type</th>
                  <th style="width:20%;">Account/Method</th>
                  <th style="width:10%; text-align:right;">Amount (₹)</th>
                  <th style="width:10%; text-align:right;">Actions</th>
                </tr>
              </thead>
              <tbody id="recentTransactionsBody">
                <tr><td colspan="7" style="text-align:center; color:var(--text-muted);">No data loaded. Sign in or load sample data.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </main>
  
  <div id="calculator">
    <div id="calc-header">
      Calculator
      <button id="calc-close-btn">&times;</button>
    </div>
    <div id="calc-preview"></div>
    <div id="calc-display">0</div>
    <div id="calc-buttons">
      <button class="calc-clear">AC</button>
      <button class="calc-clear">C</button>
      <button class="calc-operator">÷</button>
      <button>7</button>
      <button>8</button>
      <button>9</button>
      <button class="calc-operator">×</button>
      <button>4</button>
      <button>5</button>
      <button>6</button>
      <button class="calc-operator">−</button>
      <button>1</button>
      <button>2</button>
      <button>3</button>
      <button class="calc-operator">+</button>
      <button class="calc-zero">0</button>
      <button>.</button>
      <button class="calc-equals">=</button>
    </div>
  </div>

  <div id="viewAllModal" class="modal">
    <div class="modal-content modal-pad">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div class="card-title" style="font-size:18px;">All Transactions</div>
        <button class="btn-outline" id="closeViewAll">Close</button>
      </div>
      <div class="table-container">
        <table id="allTransactionsTable">
          <thead>
            <tr>
              <th style="width:10%;">Date</th>
              <th style="width:5%;">Type</th>
              <th style="width:20%;">Description</th>
              <th style="width:20%;">Category/Sub-Type</th>
              <th style="width:15%;">Account/Method</th>
              <th style="width:15%; text-align:right;">Amount (₹)</th>
              <th style="width:15%; text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="allTransactionsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="importModal" class="modal modal-small">
    <div class="modal-content modal-pad">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div class="card-title" style="font-size:18px;">Import Data</div>
        <button class="btn-outline" id="closeImport">Close</button>
      </div>
      <p style="font-size:13px; color:var(--text-muted);">Paste your data in JSON format (recommended) or CSV format. JSON data should be an array of transaction objects.</p>
      <label for="importDataArea">Data to Import (JSON/CSV)</label>
      <textarea id="importDataArea" rows="10" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; font-family:monospace; font-size:12px;"></textarea>
      <button class="btn-primary" id="processImportBtn" style="margin-top:10px; width:100%;">Process & Import</button>
    </div>
  </div>
  
  <div id="settingsModal" class="modal">
    <div class="modal-content modal-pad" style="max-width:800px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div class="card-title" style="font-size:18px;">Settings & Backup</div>
        <button class="btn-outline" id="closeSettings">Close</button>
      </div>

      <div class="dashboard-grid">
        <div class="col-span-2 card" style="box-shadow:none;">
          <div class="card-header"><div class="card-title">Income Sources & Payment Methods</div></div>
          <div class="card-body" style="padding-top:0;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <label>Income Sources</label>
                <div id="incomeSourceList" style="margin-bottom:10px;"></div>
                <input type="text" id="newIncomeSource" placeholder="New source name" />
                <button class="btn-primary" id="addIncomeSource" style="margin-top:8px; width:100%;">Add Source</button>
              </div>
              <div>
                <label>Payment Methods (Accounts)</label>
                <div id="methodList" style="margin-bottom:10px;"></div>
                <input type="text" id="newMethod" placeholder="New method name" />
                <button class="btn-primary" id="addMethod" style="margin-top:8px; width:100%;">Add Method</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-span-2 card" style="box-shadow:none;">
          <div class="card-header"><div class="card-title">System Settings</div></div>
          <div class="card-body" style="padding-top:0;">
            <div class="input-group-med" style="width:100%;">
              <label for="ccLimit">Credit Card Limit (₹)</label>
              <input type="number" id="ccLimit" />
            </div>
            <div class="input-group-med" style="width:100%; margin-top:15px;">
              <label for="ccPaymentDay">CC Bill Payment Day (e.g. 10 for 10th)</label>
              <input type="number" id="ccPaymentDay" min="1" max="31" />
            </div>
          </div>
        </div>

        <div class="col-span-4 card" style="box-shadow:none; border-color:var(--danger)">
          <div class="card-header"><div class="card-title" style="color:var(--danger);">Danger Zone: Data Management</div></div>
          <div class="card-body" style="padding-top:0;">
            <button class="btn-danger" id="clearDataBtn" style="width:100%;">Clear All Local Data</button>
            <p style="font-size:12px; color:var(--text-muted); text-align:center; margin-top:8px;">This action is permanent and will only clear data from this browser.</p>
          </div>
        </div>

      </div>

    </div>
  </div>
  
  <div id="analyticsModal" class="modal">
    <div class="modal-content modal-pad">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div class="card-title" style="font-size:18px;">Advanced Analytics: Net Flow & Investment Growth</div>
        <button class="btn-outline" id="closeAnalytics">Close</button>
      </div>
      
      <div class="dashboard-grid">
        <div class="col-span-4 card" style="border-color:#0ea5e9;">
          <div class="card-header"><div class="card-title">Monthly Net Flow (Income, Expenses, Investment)</div></div>
          <div class="card-body" style="height:350px; padding-top:0;">
            <canvas id="chartMonthlyFlowModal"></canvas>
          </div>
        </div>

        <div class="col-span-2 card" style="border-color:#10b981;">
          <div class="card-header"><div class="card-title">Expense Breakdown</div></div>
          <div class="card-body" style="height:300px; padding-top:0;">
            <canvas id="chartExpenseCategoriesModal"></canvas>
            <div id="expenseCategoryLegend" style="font-size:12px; margin-top:10px;"></div>
          </div>
        </div>
        
        <div class="col-span-2 card" style="border-color:#075985;">
          <div class="card-header"><div class="card-title">Cumulative Investment (Historical Cost)</div></div>
          <div class="card-body" style="height:300px; padding-top:0;">
            <canvas id="chartInvGrowthModal"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
    // --- DATA STRUCTURES ---
    const CATEGORIES = {
      'Investments': { type: 'expense', method: 'all', color: '#0ea5e9' },
      'Insurance': { type: 'expense', method: 'all', color: '#6b21a8' },
      'Credit Card Payment': { type: 'expense', method: 'not_cc', color: '#f59e0b' },
      'EMI Payment': { type: 'expense', method: 'all', color: '#ef4444' },
      'Groceries & Food': { type: 'expense', method: 'all', color: '#10b981' },
      'Rent & Housing': { type: 'expense', method: 'all', color: '#2563eb' },
      'Utilities (Elec, Water, Gas)': { type: 'expense', method: 'all', color: '#7c3aed' },
      'Transport (Fuel, Maint, Travel)': { type: 'expense', method: 'all', color: '#14b8a6' },
      'Entertainment & Lifestyle': { type: 'expense', method: 'all', color: '#f97316' },
      'Personal Care & Health': { type: 'expense', method: 'all', color: '#eab308' },
      'Education': { type: 'expense', method: 'all', color: '#374151' },
      'Miscellaneous': { type: 'expense', method: 'all', color: '#8b5cf6' },
    };

    const INVESTMENT_STRUCTURE = {
      'Equity': {
        'Indian Stock': { bucket: 'Equity' },
        'US Stock': { bucket: 'Equity' },
        'Small Cap': { bucket: 'Equity' },
      },
      'Debt': {
        'Fixed Deposit': { bucket: 'Debt' },
        'Bonds': { bucket: 'Debt' },
      },
      'ETFs': {
        'Index ETF': { bucket: 'ETFs' },
        'Gold ETF': { bucket: 'ETFs' },
      },
      'Mutual Funds': {
        'ELSS': { bucket: 'Mutual Funds' },
        'Index Fund': { bucket: 'Mutual Funds' },
        'Thematic Fund': { bucket: 'Mutual Funds' },
      },
      'Retirement': {
        'PPF': { bucket: 'Retirement' },
        'NPS': { bucket: 'Retirement' },
      },
      'Real Estate': {
        'REIT': { bucket: 'Real Estate' },
        'Physical Property': { bucket: 'Real Estate' },
      },
      'Commodities': {
        'Gold': { bucket: 'Commodities' },
        'Silver': { bucket: 'Commodities' },
      },
      'Crypto': {
        'Bitcoin': { bucket: 'Crypto' },
        'Ethereum': { bucket: 'Crypto' },
      },
      'Other': {
        'P2P Lending': { bucket: 'Other' },
        'Start-up Equity': { bucket: 'Other' },
      }
    };

    const MAJOR_BUCKETS = Object.values(INVESTMENT_STRUCTURE).flatMap(obj => Object.values(obj).map(sub => sub.bucket)).reduce((acc, curr) => {
      acc[curr] = curr;
      return acc;
    }, {});
    
    const INVESTMENT_GROUP_OPTIONS = Object.keys(INVESTMENT_STRUCTURE);

    // --- STATE & CACHE ---
    let data = [];
    let methodNames = { 'cash': 'Cash', 'bank_a': 'Bank A', 'bank_b': 'Bank B', 'credit_card': 'Credit Card', 'upi': 'UPI' };
    let incomeSources = { 'salary': 'Salary', 'freelance': 'Freelance', 'rental': 'Rental' };
    let settings = { ccLimit: 500000, ccPaymentDay: 10 };
    let invBreakdownBarChart = null;
    let invBreakdownPieChart = null;
    let chartMonthlyFlowModal = null;
    let chartExpenseCategoriesModal = null;
    let chartInvGrowthModal = null;
    
    const formEls = {
      type: document.getElementById('type'),
      amount: document.getElementById('amount'),
      date: document.getElementById('date'),
      desc: document.getElementById('desc'),
      category: document.getElementById('category'),
      method: document.getElementById('method'),
      incomeSource: document.getElementById('incomeSource'),
      invGroup: document.getElementById('invGroup'),
      invSub: document.getElementById('invSub'),
      insType: document.getElementById('insType'),
      insFor: document.getElementById('insFor'),
      obAccountType: document.getElementById('obAccountType'),
      obInvestmentGroup: document.getElementById('obInvestmentGroup'),
      
      incomeRow: document.getElementById('incomeSourceRow'),
      investmentRow: document.getElementById('investmentRow'),
      insuranceRow: document.getElementById('insuranceRow'),
      obRow: document.getElementById('openingBalanceRow'),
      obInvGroupRow: document.getElementById('obInvestmentGroupRow'),
      
      addBtn: document.getElementById('addBtn'),
      saveBtn: document.getElementById('saveBtn'),
      cancelBtn: document.getElementById('cancelBtn'),
    };
    let editId = null;

    // --- UTILITIES ---
    function uid() { return 'id' + Date.now() + Math.random().toString(16).slice(2); }
    function fmt(n) { return (new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(n)); }
    function toKey(s) { return s.toLowerCase().replace(/[^a-z0-9]/g, ''); }
    function requireSignedIn() {
      if (!currentProfile) {
        alert('Please sign in to proceed.');
        return false;
      }
      return true;
    }

    // --- DATA HANDLING: LOAD/SAVE/PERSISTENCE ---
    function loadFromLocalStorage() {
      try {
        const localData = localStorage.getItem('mm_v5_data');
        const localMethods = localStorage.getItem('mm_v5_methods');
        const localIncome = localStorage.getItem('mm_v5_income');
        const localSettings = localStorage.getItem('mm_v5_settings');

        if (localData) data = JSON.parse(localData);
        if (localMethods) methodNames = JSON.parse(localMethods);
        if (localIncome) incomeSources = JSON.parse(localIncome);
        if (localSettings) settings = JSON.parse(localSettings);
      } catch (e) {
        console.error("Local storage read error:", e);
      }
    }

    function saveAll(skipFirestore = false) {
      localStorage.setItem('mm_v5_data', JSON.stringify(data));
      localStorage.setItem('mm_v5_methods', JSON.stringify(methodNames));
      localStorage.setItem('mm_v5_income', JSON.stringify(incomeSources));
      localStorage.setItem('mm_v5_settings', JSON.stringify(settings));

      if (USE_FIRESTORE && db && currentProfile && !skipFirestore) {
        db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).set({
          data: data,
          methodNames: methodNames,
          incomeSources: incomeSources,
          settings: settings,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(e => console.error("Firestore write error:", e));
      }
    }

    async function loadProfileData() {
      loadFromLocalStorage();

      if (USE_FIRESTORE && db && currentProfile) {
        try {
          const doc = await db.collection(FIRESTORE_COLLECTION_NAME).doc(toKey(currentProfile)).get();
          if (doc.exists) {
            const serverData = doc.data();
            data = serverData.data || data;
            methodNames = serverData.methodNames || methodNames;
            incomeSources = serverData.incomeSources || incomeSources;
            settings = serverData.settings || settings;
          }
        } catch (e) {
          console.error("Firestore read error, using local data:", e);
        }
      }
      renderAll();
    }

    // --- FORM LOGIC ---
    function updateCategoryDropdown(entry = null) {
      const type = formEls.type.value;
      let options = '';
      
      if (type === 'opening_balance') {
        options = '<option value="Opening Balance" selected>Opening Balance</option>';
      } else if (type === 'income') {
        options = '<option value="Income" selected>Income</option>';
      } else {
        options = Object.keys(CATEGORIES)
          .filter(cat => CATEGORIES[cat].type === 'expense')
          .map(cat => `<option value="${cat}">${cat}</option>`).join('');
      }
      formEls.category.innerHTML = options;
      
      if(entry && entry.category) formEls.category.value = entry.category;
      
      updateVisibility(entry);
    }
    
    function updateInvestmentSubDropdown(groupEl, subEl, selectedSub = '') {
      const group = groupEl.value;
      const subs = INVESTMENT_STRUCTURE[group] || {};
      subEl.innerHTML = Object.keys(subs).map(sub => 
        `<option value="${sub}" ${sub === selectedSub ? 'selected' : ''}>${sub}</option>`
      ).join('');
    }

    function updateMethodDropdown(entry = null) {
      const category = formEls.category.value;
      let methodKeys = Object.keys(methodNames).filter(key => key !== 'credit_card'); // Exclude CC itself
      
      if (category === 'Credit Card Payment') {
        // Only allow non-credit card accounts for payment
        methodKeys = methodKeys.filter(key => key !== 'credit_card_payment');
      }

      formEls.method.innerHTML = methodKeys.map(key => 
        `<option value="${key}" ${entry && entry.method === key ? 'selected' : ''}>${methodNames[key]}</option>`
      ).join('');
      
      // Add credit card if it is not a payment transaction
      if (category !== 'Credit Card Payment') {
        formEls.method.innerHTML += `<option value="credit_card" ${entry && entry.method === 'credit_card' ? 'selected' : ''}>${methodNames['credit_card']}</option>`;
      }
      
      if (entry && entry.method) formEls.method.value = entry.method;
    }

    function updateVisibility(editEntry = null) {
      const type = formEls.type.value;
      const cat = formEls.category.value;

      formEls.incomeRow.classList.add('hidden');
      formEls.investmentRow.classList.add('hidden');
      formEls.insuranceRow.classList.add('hidden');
      formEls.obRow.classList.add('hidden');
      formEls.obInvGroupRow.classList.add('hidden');

      if (type === 'opening_balance') {
        formEls.obRow.classList.remove('hidden');
        if (editEntry) {
          formEls.obAccountType.value = editEntry.investmentGroup === 'Cash' ? 'Cash' : 'Investment';
          if (editEntry.investmentGroup !== 'Cash') {
            formEls.obInvGroupRow.classList.remove('hidden');
            formEls.obInvestmentGroup.value = editEntry.investmentGroup || '';
          }
        }
      } else if (type === 'income') {
        formEls.incomeRow.classList.remove('hidden');
        if (editEntry) formEls.incomeSource.value = editEntry.incomeSource || '';
      } else if (type === 'expense') {
        updateMethodDropdown(editEntry);
        
        if (cat === 'Investments') {
          formEls.investmentRow.classList.remove('hidden');
          if (editEntry) {
            formEls.invGroup.value = editEntry.investmentGroup || INVESTMENT_GROUP_OPTIONS[0];
            updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, editEntry.investmentSub);
          } else {
            formEls.invGroup.value = INVESTMENT_GROUP_OPTIONS[0];
            updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
          }
        } else if(cat === 'Insurance') {
          formEls.insuranceRow.classList.remove('hidden');
        }
      }
    }
    
    // Initial setup of dropdowns (called in renderAll)
    function setupDropdowns() {
      // Methods
      formEls.method.innerHTML = Object.keys(methodNames)
        .filter(key => key !== 'credit_card_payment') // Hide payment method itself
        .map(key => `<option value="${key}">${methodNames[key]}</option>`).join('');
      
      // Income sources
      formEls.incomeSource.innerHTML = Object.keys(incomeSources).map(key => 
        `<option value="${key}">${incomeSources[key]}</option>`
      ).join('');

      // Investment Groups (for form)
      formEls.invGroup.innerHTML = INVESTMENT_GROUP_OPTIONS.map(g => 
        `<option value="${g}">${g}</option>`
      ).join('');
      
      // Opening Balance Investment Groups
      formEls.obInvestmentGroup.innerHTML = INVESTMENT_GROUP_OPTIONS.map(g => 
        `<option value="${g}">${g}</option>`
      ).join('');

      updateCategoryDropdown();
      updateMethodDropdown();
    }

    // --- CRUD ---
    function clearForm() {
      formEls.type.value = 'expense';
      formEls.amount.value = '';
      formEls.date.value = new Date().toISOString().slice(0, 10);
      formEls.desc.value = '';
      updateCategoryDropdown(); // Resets category and method
      formEls.invGroup.value = INVESTMENT_GROUP_OPTIONS[0];
      updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub);
      formEls.insType.value = '';
      formEls.insFor.value = '';
    }

    function submitForm(e = null, isImportOrEdit = false) {
      if(!requireSignedIn()) return;

      const type = formEls.type.value;
      const amount = Number(formEls.amount.value);
      const date = formEls.date.value;
      const desc = formEls.desc.value;
      let category = formEls.category.value;
      let method = formEls.method.value;

      if(amount <= 0 || isNaN(amount)) return alert('Please enter a valid amount.');
      if(!date) return alert('Please enter a valid date.');
      
      let entry = e ? { ...e } : { id: uid(), timestamp: new Date().getTime() };
      entry.type = type;
      entry.amount = amount;
      entry.date = date;
      entry.desc = desc;
      entry.category = category;
      entry.method = method;
      entry.incomeSource = '';
      entry.investmentGroup = '';
      entry.investmentSub = '';
      entry.insuranceType = '';
      entry.insuranceFor = '';
      
      if (type === 'opening_balance') {
        entry.method = 'opening_balance';
        entry.investmentGroup = formEls.obAccountType.value === 'Cash' ? 'Cash' : formEls.obInvestmentGroup.value;
        entry.category = 'Opening Balance';
      } else if (type === 'income') {
        entry.incomeSource = formEls.incomeSource.value;
      } else if (type === 'expense') {
        if (category === 'Investments') {
          entry.investmentGroup = formEls.invGroup.value;
          entry.investmentSub = formEls.invSub.value;
        } else if (category === 'Insurance') {
          entry.insuranceType = formEls.insType.value;
          entry.insuranceFor = formEls.insFor.value;
        } else if (category === 'Credit Card Payment') {
          entry.method = 'credit_card_payment';
        }
      }

      if(editId) {
        data = data.map(t => t.id === editId ? entry : t);
        editId = null;
        formEls.addBtn.classList.remove('hidden');
        formEls.saveBtn.classList.add('hidden');
        formEls.cancelBtn.classList.add('hidden');
      } else {
        data.push(entry);
      }

      if(!isImportOrEdit) {
        saveAll();
        renderAll();
        clearForm();
      }
    }

    function editEntry(id) {
      const entry = data.find(t => t.id === id);
      if (!entry) return;

      editId = id;
      formEls.addBtn.classList.add('hidden');
      formEls.saveBtn.classList.remove('hidden');
      formEls.cancelBtn.classList.remove('hidden');

      formEls.type.value = entry.type;
      formEls.amount.value = entry.amount;
      formEls.date.value = entry.date;
      formEls.desc.value = entry.desc;
      updateCategoryDropdown(entry); // Sets category and calls updateVisibility

      // Update remaining fields (which updateVisibility relies on)
      if (entry.type === 'opening_balance') {
        formEls.obAccountType.value = entry.investmentGroup === 'Cash' ? 'Cash' : 'Investment';
        if (entry.investmentGroup !== 'Cash') {
          formEls.obInvestmentGroup.value = entry.investmentGroup;
        }
      } else if (entry.type === 'income') {
        formEls.incomeSource.value = entry.incomeSource || '';
      } else if (entry.type === 'expense') {
        if (entry.category === 'Investments') {
          formEls.invGroup.value = entry.investmentGroup || INVESTMENT_GROUP_OPTIONS[0];
          updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub, entry.investmentSub);
        } else if (entry.category === 'Insurance') {
          formEls.insType.value = entry.insuranceType || '';
          formEls.insFor.value = entry.insuranceFor || '';
        }
      }
      formEls.method.value = entry.method;
    }

    function deleteEntry(id) {
      if (!requireSignedIn()) return;
      if (confirm('Are you sure you want to delete this transaction?')) {
        data = data.filter(t => t.id !== id);
        saveAll();
        renderAll();
      }
    }

    // --- RENDER & SETUP ---
    function renderAll() {
      data.sort((a,b) => new Date(b.date) - new Date(a.date));
      setupDropdowns();
      renderKPIs();
      renderCharts();
      renderRecentEntries();
      renderSettings();
    }
    
    function getNextPaymentDate() {
      const paymentDay = settings.ccPaymentDay || 10;
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      let paymentDate = new Date(currentYear, currentMonth, paymentDay);
      if (today.getDate() > paymentDay) paymentDate.setMonth(currentMonth + 1);
      
      return paymentDate.toLocaleDateString('en-IN', {month:'long'});
    }

    function renderKPIs(){
      const curMonth = new Date().getMonth();
      const curYear = new Date().getFullYear();
      const prevMonth = curMonth === 0 ? 11 : curMonth - 1;
      const prevYear = curMonth === 0 ? curYear - 1 : curYear;
      const ccLimit = settings.ccLimit || 500000;
      
      const operationalData = data.filter(d => d.type !== 'opening_balance');
      const filterMonth = (d, m, y) => { const dt = new Date(d.date); return dt.getMonth()===m && dt.getFullYear()===y; };
      const sum = (arr) => arr.reduce((acc,curr) => acc + Number(curr.amount), 0);
      
      // Monthly Flow
      const curData = operationalData.filter(d => filterMonth(d, curMonth, curYear));
      const prevData = operationalData.filter(d => filterMonth(d, prevMonth, prevYear));
      
      const inc = sum(curData.filter(d=>d.type==='income'));
      const exp = sum(curData.filter(d=>d.type==='expense' && d.category!=='Investments'));
      const netFlow = inc - exp;
      
      const prevInc = sum(prevData.filter(d=>d.type==='income'));
      const prevExp = sum(prevData.filter(d=>d.type==='expense' && d.category!=='Investments'));
      const prevNetFlow = prevInc - prevExp;

      const flowChange = netFlow - prevNetFlow;
      const flowTrendClass = flowChange >= 0 ? 'trend-up' : 'trend-down';
      const flowTrendSymbol = flowChange >= 0 ? '▲' : '▼';
      
      document.getElementById('kpiNetFlow').innerText = fmt(netFlow);
      document.getElementById('kpiNetFlow').className = `kpi-value ${flowTrendClass}`;
      document.getElementById('kpiNetFlowTrend').innerHTML = `${flowTrendSymbol} ${fmt(Math.abs(flowChange))} vs last month`;

      // Total Invested
      const invData = data.filter(d => d.type === 'expense' && d.category === 'Investments');
      const totalInvested = sum(invData);
      document.getElementById('kpiTotalInvested').innerText = fmt(totalInvested);
      document.getElementById('kpiTotalInvestmentCount').innerText = invData.length;

      // Credit Card Due
      const ccData = operationalData.filter(d => d.method === 'credit_card');
      const ccPaymentData = operationalData.filter(d => d.method === 'credit_card_payment');
      const creditCardSpent = sum(ccData);
      const creditCardPaid = sum(ccPaymentData);
      const creditCardDue = creditCardSpent - creditCardPaid;
      
      document.getElementById('kpiCCDue').innerText = fmt(creditCardDue);
      document.getElementById('ccLimitDisplay').innerText = fmt(ccLimit);
      document.getElementById('ccPaymentDate').innerText = `Next Payment: ${settings.ccPaymentDay}th of ${getNextPaymentDate()}`;
      document.getElementById('ccCard').className = `card kpi-card col-span-1 ${creditCardDue > ccLimit * 0.75 ? 'cc-alert-high' : ''}`;

      // Net Liquidity Breakdown (accounts)
      const breakdownContainer = document.getElementById('netLiquidityBreakdown');
      
      const methodBalances = data.reduce((acc, curr) => {
          let key = curr.method || 'cash';
          let amount = Number(curr.amount);

          if (curr.type === 'opening_balance') {
              key = curr.investmentGroup === 'Cash' ? 'cash' : curr.investmentGroup;
          } else if (curr.type === 'expense') {
              if (curr.category === 'Credit Card Payment') {
                  // Expense (transfer) from an account, decreases balance
                  key = curr.method; 
                  amount = -amount;
              } else if (curr.method === 'credit_card') {
                  // Expense on CC, increases CC due (negative balance on CC account)
                  key = 'credit_card';
                  amount = -amount;
              } else {
                  // Regular expense from account
                  key = curr.method;
                  amount = -amount;
              }
          } else if (curr.type === 'income') {
              key = curr.method || 'cash';
          }
          
          if(key === 'credit_card_payment') return acc; // Ignore the CC payment method itself

          acc[key] = (acc[key] || 0) + amount;
          return acc;
      }, {});
      
      const allMethodKeys = new Set([
        ...Object.keys(methodNames), 
        ...Object.keys(methodBalances), 
        ...Object.keys(MAJOR_BUCKETS)
      ].filter(key => key !== 'credit_card_payment' && key !== 'opening_balance'));

      let breakdownHtml = '';
      let netLiquidity = 0;
      let liquidBalances = [];
      let totalInvestmentValue = 0;
      
      allMethodKeys.forEach(key => {
        const balance = methodBalances[key] || 0;
        const name = methodNames[key] || key;
        
        // This is investment property, not a liquid account
        if (INVESTMENT_GROUP_OPTIONS.includes(key) || Object.keys(MAJOR_BUCKETS).includes(key)) {
            totalInvestmentValue += balance;
            return;
        }

        // Only include liquid/bank accounts and credit card for Net Liquidity KPI
        if(key !== 'credit_card') {
          liquidBalances.push({name, balance, key});
          netLiquidity += balance;
        } else if (key === 'credit_card') {
          // CC is separate, we subtract the DUE amount from net liquidity
          liquidBalances.push({name, balance: -creditCardDue, key}); // Use Due amount
          netLiquidity += (-creditCardDue); // Subtract actual DUE
        }
      });
      
      liquidBalances.forEach(item => {
        breakdownHtml += `
          <div>
            <span>${item.name}</span>
            <span style="color:${item.balance >= 0 ? 'var(--text-main)' : 'var(--danger)'};">${fmt(Math.abs(item.balance))}</span>
          </div>
        `;
      });
      
      breakdownContainer.innerHTML = breakdownHtml;
      document.getElementById('kpiNetLiquidity').innerText = fmt(netLiquidity);
    }
    
    // Investment breakdown chart helpers
    function rollupMajorBuckets(entries) {
      const buckets = {};
      entries.forEach(e => {
        if (e.category === 'Investments') {
          const group = e.investmentGroup;
          const sub = e.investmentSub;
          const bucket = INVESTMENT_STRUCTURE[group] ? INVESTMENT_STRUCTURE[group][sub] ? INVESTMENT_STRUCTURE[group][sub].bucket : 'Other' : 'Other';
          buckets[bucket] = (buckets[bucket] || 0) + Number(e.amount);
        } else if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
          const bucket = e.investmentGroup;
          buckets[bucket] = (buckets[bucket] || 0) + Number(e.amount);
        }
      });
      return Object.keys(buckets).map(bucket => ({ bucket, amount: buckets[bucket] }));
    }

    function rollupSubcategories(entries, majorBucket) {
      const subs = {};
      entries.forEach(e => {
        if (e.category === 'Investments') {
          const group = e.investmentGroup;
          const sub = e.investmentSub;
          const currentBucket = INVESTMENT_STRUCTURE[group] ? INVESTMENT_STRUCTURE[group][sub] ? INVESTMENT_STRUCTURE[group][sub].bucket : 'Other' : 'Other';
          
          if (currentBucket === majorBucket) {
            subs[sub] = (subs[sub] || 0) + Number(e.amount);
          }
        }
      });
      return Object.keys(subs).map(sub => ({ sub, amount: subs[sub] }));
    }

    function renderInvestmentKPICharts(mode='dashboard'){
      const isModal = mode === 'modal';
      const range = document.getElementById('invDateRange').value;
      const viewMode = document.getElementById('invViewMode').value;
      const selectedBucket = document.getElementById('invBucketFilter').value;
      
      const invData = data.filter(d => (d.type === 'expense' && d.category === 'Investments') || (d.type === 'opening_balance' && d.investmentGroup !== 'Cash'));
      
      // Filter by date range
      let filteredData = invData;
      if (range !== 'all') {
        const cutoff = new Date();
        cutoff.setMonth(cutoff.getMonth() - parseInt(range));
        filteredData = invData.filter(d => new Date(d.date) >= cutoff);
      }
      
      let labels = [];
      let values = [];
      let items = [];

      if (viewMode === 'top4') {
        items = rollupMajorBuckets(filteredData);
        // Sort by amount descending and take up to 4, then merge remaining into 'Other'
        items.sort((a,b) => b.amount - a.amount);
        if (items.length > 4) {
          const otherAmount = sum(items.slice(4).map(i => i.amount));
          items = items.slice(0, 4);
          items.push({ bucket: 'Other', amount: otherAmount });
        }
        labels = items.map(i => i.bucket);
        values = items.map(i => i.amount);
        document.getElementById('invBarTitle').textContent = 'Investment by Major Bucket';
        document.getElementById('invPieTitle').textContent = 'Share by Major Bucket';
        
      } else { // subcats
        items = rollupSubcategories(filteredData, selectedBucket);
        labels = items.map(i => i.sub);
        values = items.map(i => i.amount);
        document.getElementById('invBarTitle').textContent = `${selectedBucket} Sub-type Breakdown`;
        document.getElementById('invPieTitle').textContent = `${selectedBucket} Sub-type Share`;
      }

      const colors = ['var(--c1)', 'var(--c2)', 'var(--c3)', 'var(--c4)', 'var(--c5)', 'var(--c6)', 'var(--c7)', 'var(--c8)', 'var(--c9)', 'var(--c10)'];

      // Bar chart
      const barCtx = document.getElementById(isModal ? 'chartMonthlyFlowModal' : 'invBreakdownBar');
      if (invBreakdownBarChart) invBreakdownBarChart.destroy();
      
      if (barCtx) {
        invBreakdownBarChart = new Chart(barCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Historical cost',
              data: values,
              backgroundColor: colors.map(c => c+'cc'),
              borderColor: colors,
              borderWidth: 1.5,
              borderRadius: 6
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c)=>`${c.label}: ${fmt(c.parsed.y)}` } }
            },
            scales: {
              y: { 
                beginAtZero: true, 
                ticks: { callback: (v)=>fmt(v).replace('₹','₹ ') }, 
                grid:{color:'#eef2ff'} 
              },
              x:{grid:{display:false}}
            }
          }
        });
      }

      // Pie chart
      const pieCtx = document.getElementById('invBreakdownPie');
      if (invBreakdownPieChart) invBreakdownPieChart.destroy();
      
      if (pieCtx) {
        invBreakdownPieChart = new Chart(pieCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: colors,
              hoverOffset: 8
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 15, padding: 15 } },
              tooltip: {
                callbacks: {
                  label: (c)=>{
                    const total = c.dataset.data.reduce((a,b)=>a+b,0);
                    return `${c.label}: ${fmt(c.parsed)} (${total ? ((c.parsed/total)*100).toFixed(1)+'%' : '0%'})`;
                  }
                }
              }
            }
          }
        });
      }
      
      renderQuickSubDropdowns(filteredData);
    }

    function renderQuickSubDropdowns(entries){
      const container = document.getElementById('invQuickSubs');
      if(!container) return;
      
      const order = ['Equity','Debt','ETFs','Mutual Funds','Retirement','Real Estate','Commodities','Crypto','Other'];
      const items = rollupMajorBuckets(entries);
      const totals = Object.fromEntries(items.map(i => [i.bucket, i.amount]));
      
      const blocks = order.filter(b => Object.keys(totals).includes(b)).map(bucket => {
        const groupsInBucket = Object.keys(INVESTMENT_STRUCTURE).filter(g => INVESTMENT_STRUCTURE[g][Object.keys(INVESTMENT_STRUCTURE[g])[0]]?.bucket === bucket);
        const subsMap = {};
        
        groupsInBucket.forEach(g => {
          Object.keys(INVESTMENT_STRUCTURE[g] || {}).forEach(sub => {
            const subEntries = entries.filter(e => e.investmentSub === sub);
            if(subEntries.length > 0) {
              subsMap[sub] = sum(subEntries.map(e => e.amount));
            }
          });
        });
        
        const subs = Object.keys(subsMap).map(sub => ({ sub, amount: subsMap[sub] }));

        return `
          <div class="quick-sub-card dropdown">
            <div class="quick-sub-header">
              <div class="quick-sub-title">${bucket}</div>
              <div class="total-badge">${fmt(totals[bucket])}</div>
            </div>
            <div class="dropdown-menu" style="display: none;">
              ${subs.length > 0 ? subs.map(sub => `
                <div class="dropdown-item">
                  <span>${sub}</span>
                  <span style="font-weight:600;">${fmt(sub.amount)}</span>
                </div>
              `).join('') : '<div style="font-size:12px; color:var(--text-muted); text-align:center;">No sub-investments found.</div>'}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = blocks;
      
      // Add event listeners for dropdowns
      document.querySelectorAll('.quick-sub-card').forEach(card => {
        card.addEventListener('click', (e) => {
          const menu = card.querySelector('.dropdown-menu');
          // Close all other open menus
          document.querySelectorAll('.dropdown-menu').forEach(m => {
            if (m !== menu) m.style.display = 'none';
          });
          // Toggle the clicked one
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
          e.stopPropagation();
        });
      });
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
      });
    }

    // --- RECENT TRANSACTIONS ---
    function recentEntryToHtml(e) {
      const date = new Date(e.date).toLocaleDateString('en-IN', {day:'numeric', month:'short'});
      const typeBadge = `<span class="badge badge-${e.type === 'opening_balance' ? 'opening' : e.type === 'income' ? 'income' : e.category === 'Investments' ? 'inv' : e.category === 'Insurance' ? 'ins' : 'expense'}">${e.type === 'opening_balance' ? 'OB' : e.type.slice(0,1).toUpperCase()}</span>`;
      const amountDisplay = e.type === 'income' || e.type === 'opening_balance' ? 
        `<span style="color:var(--success)">+${fmt(e.amount)}</span>` : 
        `<span style="color:var(--danger)">-${fmt(e.amount)}</span>`;
      
      let methodDisplay = '';
      if (e.type === 'opening_balance' && e.investmentGroup !== 'Cash') {
        methodDisplay = e.investmentGroup;
      } else if (e.type === 'expense' && e.category === 'Investments') {
        methodDisplay = e.investmentGroup;
      } else if (e.method === 'credit_card_payment') {
        methodDisplay = 'N/A (Transfer)';
      } else {
        methodDisplay = methodNames[e.method] || e.method || '--';
      }
      
      // FIX FOR RECENT TRANSACTIONS ERROR: Ensure correct category/sub-type is displayed
      let categoryDisplay = e.category === 'Investments' ? (e.investmentSub || e.investmentGroup || e.category) : 
                          e.category === 'Insurance' ? `${e.insuranceType} (${e.insuranceFor})` : 
                          e.type === 'income' ? (incomeSources[e.incomeSource] || 'Income') : 
                          e.type === 'opening_balance' ? 'Opening Balance' : 
                          e.category || '--';

      return `
        <tr>
          <td>${date}</td>
          <td>${typeBadge}</td>
          <td>${e.desc}</td>
          <td>${categoryDisplay}</td>
          <td>${methodDisplay}</td>
          <td style="text-align:right;">${amountDisplay}</td>
          <td style="text-align:right;">
            <button class="btn-outline" style="padding:4px 8px; font-size:11px;" onclick="editEntry('${e.id}')">Edit</button>
            <button class="btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteEntry('${e.id}')">Del</button>
          </td>
        </tr>
      `;
    }

    function renderRecentEntries(all = false) {
      const tableBody = all ? document.getElementById('allTransactionsBody') : document.getElementById('recentTransactionsBody');
      const entries = all ? data : data.slice(0, 10);
      
      if (entries.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--text-muted);">No transactions found.</td></tr>`;
        return;
      }

      tableBody.innerHTML = entries.map(recentEntryToHtml).join('');
    }

    // --- ANALYTICS ---
    function renderAdvancedCharts() {
      const allData = data;
      const months = {};
      const colors = ['var(--c1)', 'var(--c2)', 'var(--c3)', 'var(--c4)', 'var(--c5)', 'var(--c6)', 'var(--c7)', 'var(--c8)', 'var(--c9)', 'var(--c10)'];
      
      allData.forEach(d => {
        const monthKey = d.date.slice(0, 7); // YYYY-MM
        if (!months[monthKey]) months[monthKey] = { income: 0, expense: 0, investment: 0 };

        const amount = Number(d.amount);

        if (d.type === 'income') {
          months[monthKey].income += amount;
        } else if (d.type === 'expense') {
          if (d.category === 'Investments') {
            months[monthKey].investment += amount;
          } else if (d.category !== 'Credit Card Payment') {
            months[monthKey].expense += amount;
          }
        }
      });

      const sortedMonthKeys = Object.keys(months).sort();
      const labels = sortedMonthKeys.map(key => new Date(key + '-01').toLocaleDateString('en-IN', { year: '2-digit', month: 'short' }));
      const income = sortedMonthKeys.map(key => months[key].income);
      const expense = sortedMonthKeys.map(key => months[key].expense);
      const investment = sortedMonthKeys.map(key => months[key].investment);
      
      let cumulativeNetIncome = 0;
      const netIncomeSeries = sortedMonthKeys.map(key => {
        const netFlow = months[key].income - months[key].expense;
        cumulativeNetIncome += netFlow;
        return cumulativeNetIncome;
      });

      // Monthly Flow Chart
      const ctxFlow = document.getElementById('chartMonthlyFlowModal')?.getContext('2d');
      if (ctxFlow) {
        if (chartMonthlyFlowModal) chartMonthlyFlowModal.destroy();
        chartMonthlyFlowModal = new Chart(ctxFlow, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { type: 'bar', label: 'Income', data: income, backgroundColor: 'rgba(16, 185, 129, 0.8)', stack: 'flow' },
              { type: 'bar', label: 'Expense', data: expense.map(e => -e), backgroundColor: 'rgba(239, 68, 68, 0.8)', stack: 'flow' },
              { type: 'bar', label: 'Investment', data: investment.map(i => -i), backgroundColor: 'rgba(14, 165, 233, 0.8)', stack: 'flow' },
              { type: 'line', label: 'Net Income', data: netIncomeSeries, borderColor: '#000000', tension: 0.3, pointRadius: 3, fill: false }
            ]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { stacked: true },
              y: { 
                stacked: true, 
                ticks: { callback: function(value) { return fmt(Math.abs(value)).replace('₹', '₹ '); } } 
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) { 
                    let label = context.dataset.label || '';
                    if (label) label += ': ';
                    if (context.parsed.y !== null) {
                      label += fmt(Math.abs(context.parsed.y));
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      }

      // Expense Breakdown Pie Chart
      const expenseData = allData.filter(d => d.type === 'expense' && d.category !== 'Investments' && d.category !== 'Credit Card Payment');
      const categoryRollup = expenseData.reduce((acc, curr) => {
        const cat = curr.category || 'Other';
        acc[cat] = (acc[cat] || 0) + Number(curr.amount);
        return acc;
      }, {});
      
      const categoryLabels = Object.keys(categoryRollup);
      const categoryValues = Object.values(categoryRollup);
      
      const ctxExpense = document.getElementById('chartExpenseCategoriesModal')?.getContext('2d');
      if (ctxExpense) {
        if (chartExpenseCategoriesModal) chartExpenseCategoriesModal.destroy();
        chartExpenseCategoriesModal = new Chart(ctxExpense, {
          type: 'doughnut',
          data: {
            labels: categoryLabels,
            datasets: [{
              data: categoryValues,
              backgroundColor: categoryLabels.map((_, i) => colors[i % colors.length]),
              hoverOffset: 8
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context)=>{
                    const total = context.dataset.data.reduce((a,b)=>a+b,0);
                    const value = context.parsed;
                    return `${context.label}: ${fmt(value)} (${total ? ((value/total)*100).toFixed(1)+'%' : '0%'})`;
                  }
                }
              }
            }
          }
        });
        
        const legendEl = document.getElementById('expenseCategoryLegend');
        const positiveBalances = categoryLabels.map((label, i) => ({label, amount: categoryValues[i]})).filter(b => b.amount > 0).sort((a,b)=>b.amount-a.amount);
        legendEl.innerHTML = positiveBalances.map((b, i) => `
          <div style="display:flex; justify-content:space-between;">
            <div style="display:flex; align-items:center;">
              <span style="display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; background:${colors[categoryLabels.indexOf(b.label)]};"></span>
              ${b.label}
            </div>
            <span style="font-weight:600;">${fmt(b.amount)}</span>
          </div>
        `).join('');
      }
      
      // Investment Growth Chart
      renderInvestmentGrowthChart(allData);
    }
    
    function renderInvestmentGrowthChart(allData) {
      const invData = allData.filter(d => (d.type === 'expense' && d.category === 'Investments') || (d.type === 'opening_balance' && d.investmentGroup !== 'Cash'));
      invData.sort((a, b) => new Date(a.date) - new Date(b.date));

      const growthSeries = {};
      let cumulativeInvestment = 0;
      
      invData.forEach(d => {
        cumulativeInvestment += Number(d.amount);
        const dateKey = d.date; 
        growthSeries[dateKey] = cumulativeInvestment;
      });
      
      const growthLabels = Object.keys(growthSeries).map(dateStr => new Date(dateStr).toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' }));
      const growthValues = Object.values(growthSeries);
      
      const ctxGrowth = document.getElementById('chartInvGrowthModal')?.getContext('2d');
      if (ctxGrowth) {
        if (chartInvGrowthModal) chartInvGrowthModal.destroy();
        chartInvGrowthModal = new Chart(ctxGrowth, {
          type: 'line',
          data: {
            labels: growthLabels,
            datasets: [{ 
              label: 'Cumulative invested (historical cost)', 
              data: growthValues, 
              borderColor: '#2980b9', 
              tension: 0.3, 
              borderWidth:2, 
              pointRadius:0 
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              tooltip: { 
                callbacks: { 
                  label: (c)=>`${c.dataset.label}: ${fmt(c.parsed.y)}` 
                } 
              }
            },
            scales: {
              y: { 
                beginAtZero: false, 
                ticks: { callback: (v)=>fmt(v).replace('₹','₹ ') }, 
                grid:{color:'#eef2ff'} 
              },
              x:{grid:{display:false}}
            }
          }
        });
      }
    }

    // --- IMPORT/EXPORT ---
    function convertToCSV(data) {
      const headers = ['id', 'type', 'amount', 'date', 'desc', 'category', 'method', 'incomeSource', 'investmentGroup', 'investmentSub', 'insuranceType', 'insuranceFor'];
      const rows = data.map(obj => headers.map(header => {
        let value = obj[header] ?? '';
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }).join(','));
      const csvContent = [
        headers.join(','),
        ...rows
      ].join('\n');
      return csvContent;
    }

    function downloadFile(filename, content, type) {
      const element = document.createElement('a');
      element.setAttribute('href', `data:${type};charset=utf-8,` + encodeURIComponent(content));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }
    
    // --- SAMPLE DATA ---
    function generateSampleData() {
      const sampleData = [];
      const now = new Date();
      const randBetween = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);
      const pick = (arr) => arr[randBetween(0, arr.length - 1)];
      const categoriesPool = Object.keys(CATEGORIES).filter(c => c !== 'Investments' && c !== 'Insurance' && c !== 'Credit Card Payment');
      const methodsPool = ['bank_a', 'upi', 'credit_card'];
      const expenseCategories = categoriesPool.filter(c => CATEGORIES[c].type === 'expense');

      // Opening Balance
      sampleData.push({ id: uid(), type: 'opening_balance', amount: 50000, date: '2023-01-01', desc: 'Initial Bank A balance', category: 'Opening Balance', method: 'opening_balance', investmentGroup: 'Cash' });
      sampleData.push({ id: uid(), type: 'opening_balance', amount: 20000, date: '2023-01-01', desc: 'Initial Gold ETF investment', category: 'Opening Balance', method: 'opening_balance', investmentGroup: 'ETFs' });
      
      // Income
      for(let i = 0; i < 12; i++) {
        const dt = `2024-${String(i+1).padStart(2, '0')}-01`;
        sampleData.push({ id: uid(), type: 'income', amount: randBetween(60000, 80000), date: dt, desc: 'Monthly Salary', category: 'Income', method: 'bank_a', incomeSource: 'salary' });
      }

      // 30 Regular Transactions (last 3 months)
      for(let i = 0; i < 30; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - randBetween(0, 2), randBetween(1, 28));
        const dt = d.toISOString().slice(0, 10);
        
        const cat = pick(expenseCategories);
        const amt = randBetween(300, 9000);
        const method = pick(methodsPool);

        // Regular expenses
        sampleData.push({ id: uid(), type: 'expense', amount: amt, date: dt, desc: `${cat} expense`, category: cat, method });
        
        // Investment (SIP/Buy)
        if (Math.random() > 0.75) {
          const invGroup = pick(Object.keys(INVESTMENT_STRUCTURE));
          const invSub = pick(Object.keys(INVESTMENT_STRUCTURE[invGroup]));
          sampleData.push({ id: uid(), type: 'expense', amount: randBetween(2000, 15000), date: dt, desc: `Investment — ${invSub}`, category: 'Investments', method: 'bank_a', investmentGroup: invGroup, investmentSub: invSub });
        }
        
        // Insurance (Policy)
        if (Math.random() > 0.9) {
          sampleData.push({ id: uid(), type: 'expense', amount: randBetween(1000, 5000), date: dt, desc: `Health Policy Payment`, category: 'Insurance', method: 'bank_a', insuranceType: 'Health', insuranceFor: 'Family' });
        }
        
        // Credit Card Payment
        if (i % 10 === 0) {
          sampleData.push({ id: uid(), type: 'expense', amount: randBetween(10000, 30000), date: dt, desc: `CC Payment`, category: 'Credit Card Payment', method: 'bank_a' });
        }
      }

      data = sampleData;
      saveAll();
      renderAll();
    }
    
    // --- CALCULATOR LOGIC ---
    let display = document.getElementById('calc-display');
    let preview = document.getElementById('calc-preview');
    let currentExpression = '0';
    let isNewInput = true;

    function calculate() {
      try {
        // Replace symbols with JavaScript operators
        const sanitizedExpression = currentExpression
          .replace(/×/g, '*')
          .replace(/÷/g, '/')
          .replace(/−/g, '-'); 
          
        const result = new Function(`return ${sanitizedExpression}`)();

        if (isNaN(result) || !isFinite(result)) {
          display.textContent = 'Error';
          currentExpression = '0';
        } else {
          display.textContent = fmt(Number(result)).replace('₹', '');
          currentExpression = String(result);
          isNewInput = true;
        }
        preview.textContent = '';
      } catch (err) {
        display.textContent = 'Error';
        preview.textContent = 'Invalid expression';
        currentExpression = '0';
        isNewInput = true;
      }
    }

    function handleCalcButton(key) {
      if (key === '=') {
        calculate();
        return;
      } else if (key === 'AC') {
        currentExpression = '0';
        display.textContent = '0';
        preview.textContent = '';
        isNewInput = true;
        return;
      } else if (key === 'C') {
        if (isNewInput) {
          currentExpression = '0';
        } else {
          currentExpression = currentExpression.slice(0, -1) || '0';
        }
        display.textContent = currentExpression;
        preview.textContent = '';
        isNewInput = currentExpression === '0';
        return;
      }

      const isOperator = ['+', '−', '×', '÷'].includes(key);
      const lastChar = currentExpression.slice(-1);
      const lastIsOperator = ['+', '−', '×', '÷'].includes(lastChar);

      if (isNewInput && isOperator) {
        // Start a new calculation with the operator if display is not '0'
        if (display.textContent !== '0') {
          currentExpression = display.textContent.replace(/[₹,]/g, '') + key;
          isNewInput = false;
        } else {
          return; // Don't start with an operator if display is 0
        }
      } else if (isNewInput && key !== '.') {
        currentExpression = key;
        isNewInput = false;
      } else if (isOperator && lastIsOperator) {
        currentExpression = currentExpression.slice(0, -1) + key;
      } else if (key === '.' && lastChar === '.') {
        return;
      } else {
        currentExpression += key;
        isNewInput = false;
      }

      display.textContent = currentExpression;
    }
    
    // Drag calc
    function dragElement(elmnt) {
      if (!elmnt) return;
      const header = document.getElementById('calc-header');
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      
      if (header) {
        header.onmousedown = dragMouseDown;
      }

      function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
      }

      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }
    
    // --- SETTINGS RENDER ---
    function renderSettings() {
      document.getElementById('ccLimit').value = settings.ccLimit;
      document.getElementById('ccPaymentDay').value = settings.ccPaymentDay;

      const methodList = document.getElementById('methodList');
      methodList.innerHTML = Object.keys(methodNames).map(key => {
        if(key === 'credit_card_payment' || key === 'credit_card') return '';
        return `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px dashed #e2e8f0;">
            <span>${methodNames[key]}</span>
            <button class="btn-danger" style="padding:2px 6px; font-size:10px;" onclick="deleteMethod('${key}')">Remove</button>
          </div>
        `;
      }).join('');
      
      const incomeSourceList = document.getElementById('incomeSourceList');
      incomeSourceList.innerHTML = Object.keys(incomeSources).map(key => {
        return `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px dashed #e2e8f0;">
            <span>${incomeSources[key]}</span>
            <button class="btn-danger" style="padding:2px 6px; font-size:10px;" onclick="deleteIncomeSource('${key}')">Remove</button>
          </div>
        `;
      }).join('');
    }

    // --- SETTINGS CRUD ---
    function addMethod() {
      const newName = document.getElementById('newMethod').value.trim();
      if (!newName) return;
      const key = toKey(newName);
      methodNames[key] = newName;
      document.getElementById('newMethod').value = '';
      saveAll();
      renderAll();
    }
    
    function deleteMethod(key) {
      if(key === 'cash' || key === 'bank_a' || key === 'bank_b' || key === 'credit_card') {
        alert('Cannot remove default methods.');
        return;
      }
      delete methodNames[key];
      saveAll();
      renderAll();
    }

    function addIncomeSource() {
      const newName = document.getElementById('newIncomeSource').value.trim();
      if (!newName) return;
      const key = toKey(newName);
      incomeSources[key] = newName;
      document.getElementById('newIncomeSource').value = '';
      saveAll();
      renderAll();
    }
    
    function deleteIncomeSource(key) {
      if(key === 'salary' || key === 'freelance' || key === 'rental') {
        alert('Cannot remove default income sources.');
        return;
      }
      delete incomeSources[key];
      saveAll();
      renderAll();
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      document.getElementById('currentDate').innerText = d.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const today = new Date().toISOString().slice(0,10);
      const dateEl = document.getElementById('date');
      if (dateEl) dateEl.value = today;
      dragElement(document.getElementById("calculator"));

      const mobileBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('mainSidebar');
      mobileBtn.addEventListener('click', () => { sidebar.classList.toggle('mobile-open'); });
      document.querySelectorAll('.nav-item').forEach(item => { item.addEventListener('click', () => sidebar.classList.remove('mobile-open')); });
      
      // Modal Open/Close
      document.getElementById('navSettings').addEventListener('click', () => { document.getElementById('settingsModal').classList.add('open'); });
      document.getElementById('closeSettings').addEventListener('click', () => { 
        document.getElementById('settingsModal').classList.remove('open');
        renderKPIs(); // Rerender KPIs to update CC info
      });
      document.getElementById('navAnalytics').addEventListener('click', () => { 
        document.getElementById('analyticsModal').classList.add('open'); 
        renderAdvancedCharts();
      });
      document.getElementById('closeAnalytics').addEventListener('click', () => { document.getElementById('analyticsModal').classList.remove('open'); });
      document.getElementById('importDataBtn').addEventListener('click', () => { document.getElementById('importModal').classList.add('open'); });
      document.getElementById('closeImport').addEventListener('click', () => { document.getElementById('importModal').classList.remove('open'); });
      document.getElementById('viewAllBtn').addEventListener('click', () => { 
        document.getElementById('viewAllModal').classList.add('open'); 
        renderRecentEntries(true);
      });
      document.getElementById('closeViewAll').addEventListener('click', () => { document.getElementById('viewAllModal').classList.remove('open'); });
      document.getElementById('viewCategoriesBtn').addEventListener('click', () => { 
        document.getElementById('invBreakdownPanel').classList.remove('hidden'); 
        document.getElementById('invViewMode').value = 'subcats';
        document.getElementById('invBucketFilter').value = Object.keys(MAJOR_BUCKETS)[0] || '';
        renderInvestmentKPICharts();
      });
      
      // Calculator
      document.getElementById('calc-toggle').addEventListener('click', () => { 
        const calc = document.getElementById('calculator'); 
        calc.style.display = calc.style.display === 'flex' ? 'none' : 'flex'; 
      });
      document.getElementById('calc-close-btn').addEventListener('click', () => { 
        document.getElementById('calculator').style.display = 'none'; 
      });
      document.getElementById('calc-buttons').querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => handleCalcButton(e.target.textContent));
      });

      // Form Listeners
      formEls.type.addEventListener('change', () => updateCategoryDropdown());
      formEls.category.addEventListener('change', () => updateVisibility());
      formEls.obAccountType.addEventListener('change', () => {
        if(formEls.obAccountType.value === 'Investment') formEls.obInvGroupRow.classList.remove('hidden');
        else formEls.obInvGroupRow.classList.add('hidden');
      });
      formEls.invGroup.addEventListener('change', () => updateInvestmentSubDropdown(formEls.invGroup, formEls.invSub));
      formEls.addBtn.addEventListener('click', () => submitForm());
      formEls.saveBtn.addEventListener('click', () => {
        const entryToEdit = data.find(t => t.id === editId);
        if (entryToEdit) submitForm(entryToEdit);
      });
      formEls.cancelBtn.addEventListener('click', () => { 
        clearForm(); 
        editId = null; 
        formEls.addBtn.classList.remove('hidden'); 
        formEls.saveBtn.classList.add('hidden'); 
        formEls.cancelBtn.classList.add('hidden');
        updateVisibility();
      });
      
      // Settings Listeners
      document.getElementById('ccLimit').addEventListener('change', (e) => { settings.ccLimit = Number(e.target.value); saveAll(); renderKPIs(); });
      document.getElementById('ccPaymentDay').addEventListener('change', (e) => { 
        const day = Number(e.target.value);
        if (day >= 1 && day <= 31) settings.ccPaymentDay = day;
        saveAll(); 
        renderKPIs(); 
      });
      document.getElementById('addMethod').addEventListener('click', addMethod);
      document.getElementById('addIncomeSource').addEventListener('click', addIncomeSource);

      // Investment Breakdown Listeners
      document.getElementById('invBucketFilter').addEventListener('change', () => renderInvestmentKPICharts());
      document.getElementById('invViewMode').addEventListener('change', () => {
        document.getElementById('invBucketFilter').parentElement.style.display = document.getElementById('invViewMode').value === 'subcats' ? 'block' : 'none';
        renderInvestmentKPICharts();
      });
      document.getElementById('invDateRange').addEventListener('change', () => renderInvestmentKPICharts());
      document.getElementById('toggleInvBreakdownBtn').addEventListener('click', (e) => {
        const panel = document.getElementById('invBreakdownPanel');
        panel.classList.toggle('hidden');
        e.target.textContent = panel.classList.contains('hidden') ? 'Show Breakdown' : 'Hide Breakdown';
      });

      // Data Management
      document.getElementById('sampleBtn').addEventListener('click', () => {
        if (confirm('This will overwrite your current data with sample data. Continue?')) {
          generateSampleData();
        }
      });
      document.getElementById('exportDataBtn').addEventListener('click', () => {
        if (!requireSignedIn()) return;
        const filename = `moneymirror_export_${new Date().toISOString().slice(0, 10)}.json`;
        downloadFile(filename, JSON.stringify({ data, methodNames, incomeSources, settings }, null, 2), 'application/json');
      });
      document.getElementById('processImportBtn').addEventListener('click', () => {
        if (!requireSignedIn()) return;
        const dataArea = document.getElementById('importDataArea').value;
        if (!dataArea) return alert('Please paste data to import.');
        
        try {
          // Attempt JSON import first
          const imported = JSON.parse(dataArea);
          let importedData = imported.data || imported;
          
          if(!Array.isArray(importedData)) throw new Error('Invalid data format. Expected an array.');

          data = [...data, ...importedData];
          if(imported.methodNames) methodNames = imported.methodNames;
          if(imported.incomeSources) incomeSources = imported.incomeSources;
          if(imported.settings) settings = imported.settings;
          
          importedData.forEach(d => submitForm(d, true)); // Re-validate and normalize new entries
          
          saveAll();
          renderAll();
          document.getElementById('closeImport').click();
          alert(`Successfully imported ${importedData.length} transactions.`);
          
        } catch (e) {
          // Fallback for CSV import (basic)
          console.log("JSON import failed, trying basic CSV import:", e);
          const lines = dataArea.split('\n');
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          const newEntries = lines.slice(1).map(line => {
            const values = line.split(',');
            const entry = {};
            headers.forEach((h, i) => entry[h] = values[i] ? values[i].replace(/"/g, '').trim() : '');
            return {
              id: uid(),
              type: entry.type || 'expense',
              amount: Number(entry.amount) || 0,
              date: entry.date || new Date().toISOString().slice(0, 10),
              desc: entry.desc || 'Imported Transaction',
              category: entry.category || 'Miscellaneous',
              method: entry.method || 'cash',
              incomeSource: entry.incomeSource || '',
              investmentGroup: entry.investmentGroup || '',
              investmentSub: entry.investmentSub || '',
              insuranceType: entry.insuranceType || '',
              insuranceFor: entry.insuranceFor || '',
            };
          }).filter(e => e.amount > 0);
          
          data = [...data, ...newEntries];
          saveAll();
          renderAll();
          document.getElementById('closeImport').click();
          alert(`Successfully imported ${newEntries.length} transactions from CSV.`);
        }
      });

      document.getElementById('clearDataBtn').addEventListener('click', () => {
        if (confirm('DANGER ZONE: This will permanently DELETE ALL of your local transaction data, methods, and settings. Are you absolutely sure?')) {
          localStorage.removeItem('mm_v5_data');
          localStorage.removeItem('mm_v5_methods');
          localStorage.removeItem('mm_v5_income');
          localStorage.removeItem('mm_v5_settings');
          data = [];
          methodNames = { 'cash': 'Cash', 'bank_a': 'Bank A', 'bank_b': 'Bank B', 'credit_card': 'Credit Card', 'upi': 'UPI' };
          incomeSources = { 'salary': 'Salary', 'freelance': 'Freelance', 'rental': 'Rental' };
          settings = { ccLimit: 500000, ccPaymentDay: 10 };
          renderAll();
          document.getElementById('closeSettings').click();
          alert('All local data has been cleared.');
        }
      });
      
      // Load data on start (if already signed in from a previous session)
      loadProfileData();
    });
  </script>
</body>
</html>
  </div>
